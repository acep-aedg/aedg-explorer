// mapbox-gl@3.11.0 downloaded from https://ga.jspm.io/npm:mapbox-gl@3.11.0/dist/mapbox-gl.js

var F=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var Le={};(function(F,Oe){Le=Oe()})(0,(function(){var Le,Oe,Fe;function define(F,je){if(Le)if(Oe){var qe="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+Le+")(sharedChunk); ("+Oe+")(sharedChunk); self.onerror = null;";var He={};Le(He);Fe=je(He);typeof window!=="undefined"&&window&&window.URL&&window.URL.createObjectURL&&(Fe.workerUrl=window.URL.createObjectURL(new Blob([qe],{type:"text/javascript"})))}else Oe=je;else Le=je}define(["exports"],(function(Le){function e(F){return F&&F.__esModule&&Object.prototype.hasOwnProperty.call(F,"default")?F.default:F}var Oe,Fe={},je={};function s(){if(Oe)return je;Oe=1,Object.defineProperty(je,"__esModule",{value:!0}),je.setMatrixArrayType=function(F){je.ARRAY_TYPE=Le=F},je.toRadian=function(F){return F*qe},je.equals=function(Le,Oe){return Math.abs(Le-Oe)<=F*Math.max(1,Math.abs(Le),Math.abs(Oe))},je.RANDOM=je.ARRAY_TYPE=je.EPSILON=void 0;var F=1e-6;je.EPSILON=F;var Le="undefined"!=typeof Float32Array?Float32Array:Array;je.ARRAY_TYPE=Le;var Fe=Math.random;je.RANDOM=Fe;var qe=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var F=0,Le=arguments.length;Le--;)F+=arguments[Le]*arguments[Le];return Math.sqrt(F)}),je}var qe,He={};function l(){if(qe)return He;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}qe=1,Object.defineProperty(He,"__esModule",{value:!0}),He.create=function(){var Le=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Le[1]=0,Le[2]=0),Le[0]=1,Le[3]=1,Le},He.clone=function(Le){var Oe=new F.ARRAY_TYPE(4);return Oe[0]=Le[0],Oe[1]=Le[1],Oe[2]=Le[2],Oe[3]=Le[3],Oe},He.copy=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F},He.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F},He.fromValues=function(Le,Oe,Fe,je){var qe=new F.ARRAY_TYPE(4);return qe[0]=Le,qe[1]=Oe,qe[2]=Fe,qe[3]=je,qe},He.set=function(F,Le,Oe,Fe,je){return F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=je,F},He.transpose=function(F,Le){if(F===Le){var Oe=Le[1];F[1]=Le[2],F[2]=Oe}else F[0]=Le[0],F[1]=Le[2],F[2]=Le[1],F[3]=Le[3];return F},He.invert=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Oe*qe-je*Fe;return He?(F[0]=qe*(He=1/He),F[1]=-Fe*He,F[2]=-je*He,F[3]=Oe*He,F):null},He.adjoint=function(F,Le){var Oe=Le[0];return F[0]=Le[3],F[1]=-Le[1],F[2]=-Le[2],F[3]=Oe,F},He.determinant=function(F){return F[0]*F[3]-F[2]*F[1]},He.multiply=n,He.rotate=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Math.sin(Oe),jt=Math.cos(Oe);return F[0]=Fe*jt+qe*xt,F[1]=je*jt+He*xt,F[2]=Fe*-xt+qe*jt,F[3]=je*-xt+He*jt,F},He.scale=function(F,Le,Oe){var Fe=Le[1],je=Le[2],qe=Le[3],He=Oe[0],xt=Oe[1];return F[0]=Le[0]*He,F[1]=Fe*He,F[2]=je*xt,F[3]=qe*xt,F},He.fromRotation=function(F,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le);return F[0]=Fe,F[1]=Oe,F[2]=-Oe,F[3]=Fe,F},He.fromScaling=function(F,Le){return F[0]=Le[0],F[1]=0,F[2]=0,F[3]=Le[1],F},He.str=function(F){return"mat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},He.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3])},He.LDU=function(F,Le,Oe,Fe){return F[2]=Fe[2]/Fe[0],Oe[0]=Fe[0],Oe[1]=Fe[1],Oe[3]=Fe[3]-F[2]*Oe[1],[F,Le,Oe]},He.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F[2]=Le[2]+Oe[2],F[3]=Le[3]+Oe[3],F},He.subtract=i,He.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]&&F[2]===Le[2]&&F[3]===Le[3]},He.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Oe[0],jt=Oe[1],Gt=Oe[2],bi=Oe[3];return Math.abs(Fe-xt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(xt))&&Math.abs(je-jt)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(jt))&&Math.abs(qe-Gt)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Gt))&&Math.abs(He-bi)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(bi))},He.multiplyScalar=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F[2]=Le[2]*Oe,F[3]=Le[3]*Oe,F},He.multiplyScalarAndAdd=function(F,Le,Oe,Fe){return F[0]=Le[0]+Oe[0]*Fe,F[1]=Le[1]+Oe[1]*Fe,F[2]=Le[2]+Oe[2]*Fe,F[3]=Le[3]+Oe[3]*Fe,F},He.sub=He.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=r(void 0);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}(s());function r(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Le})(F)}function n(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Oe[0],jt=Oe[1],Gt=Oe[2],bi=Oe[3];return F[0]=Fe*xt+qe*jt,F[1]=je*xt+He*jt,F[2]=Fe*Gt+qe*bi,F[3]=je*Gt+He*bi,F}function i(F,Le,Oe){return F[0]=Le[0]-Oe[0],F[1]=Le[1]-Oe[1],F[2]=Le[2]-Oe[2],F[3]=Le[3]-Oe[3],F}return He.mul=n,He.sub=i,He}var xt,jt={};function h(){if(xt)return jt;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}xt=1,Object.defineProperty(jt,"__esModule",{value:!0}),jt.create=function(){var Le=new F.ARRAY_TYPE(6);return F.ARRAY_TYPE!=Float32Array&&(Le[1]=0,Le[2]=0,Le[4]=0,Le[5]=0),Le[0]=1,Le[3]=1,Le},jt.clone=function(Le){var Oe=new F.ARRAY_TYPE(6);return Oe[0]=Le[0],Oe[1]=Le[1],Oe[2]=Le[2],Oe[3]=Le[3],Oe[4]=Le[4],Oe[5]=Le[5],Oe},jt.copy=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F[4]=Le[4],F[5]=Le[5],F},jt.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F},jt.fromValues=function(Le,Oe,Fe,je,qe,He){var xt=new F.ARRAY_TYPE(6);return xt[0]=Le,xt[1]=Oe,xt[2]=Fe,xt[3]=je,xt[4]=qe,xt[5]=He,xt},jt.set=function(F,Le,Oe,Fe,je,qe,He){return F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=je,F[4]=qe,F[5]=He,F},jt.invert=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Le[4],xt=Le[5],jt=Oe*qe-Fe*je;return jt?(F[0]=qe*(jt=1/jt),F[1]=-Fe*jt,F[2]=-je*jt,F[3]=Oe*jt,F[4]=(je*xt-qe*He)*jt,F[5]=(Fe*He-Oe*xt)*jt,F):null},jt.determinant=function(F){return F[0]*F[3]-F[1]*F[2]},jt.multiply=n,jt.rotate=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Math.sin(Oe),bi=Math.cos(Oe);return F[0]=Fe*bi+qe*Gt,F[1]=je*bi+He*Gt,F[2]=Fe*-Gt+qe*bi,F[3]=je*-Gt+He*bi,F[4]=xt,F[5]=jt,F},jt.scale=function(F,Le,Oe){var Fe=Le[1],je=Le[2],qe=Le[3],He=Le[4],xt=Le[5],jt=Oe[0],Gt=Oe[1];return F[0]=Le[0]*jt,F[1]=Fe*jt,F[2]=je*Gt,F[3]=qe*Gt,F[4]=He,F[5]=xt,F},jt.translate=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Oe[0],bi=Oe[1];return F[0]=Fe,F[1]=je,F[2]=qe,F[3]=He,F[4]=Fe*Gt+qe*bi+xt,F[5]=je*Gt+He*bi+jt,F},jt.fromRotation=function(F,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le);return F[0]=Fe,F[1]=Oe,F[2]=-Oe,F[3]=Fe,F[4]=0,F[5]=0,F},jt.fromScaling=function(F,Le){return F[0]=Le[0],F[1]=0,F[2]=0,F[3]=Le[1],F[4]=0,F[5]=0,F},jt.fromTranslation=function(F,Le){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=Le[0],F[5]=Le[1],F},jt.str=function(F){return"mat2d("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+")"},jt.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],1)},jt.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F[2]=Le[2]+Oe[2],F[3]=Le[3]+Oe[3],F[4]=Le[4]+Oe[4],F[5]=Le[5]+Oe[5],F},jt.subtract=i,jt.multiplyScalar=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F[2]=Le[2]*Oe,F[3]=Le[3]*Oe,F[4]=Le[4]*Oe,F[5]=Le[5]*Oe,F},jt.multiplyScalarAndAdd=function(F,Le,Oe,Fe){return F[0]=Le[0]+Oe[0]*Fe,F[1]=Le[1]+Oe[1]*Fe,F[2]=Le[2]+Oe[2]*Fe,F[3]=Le[3]+Oe[3]*Fe,F[4]=Le[4]+Oe[4]*Fe,F[5]=Le[5]+Oe[5]*Fe,F},jt.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]&&F[2]===Le[2]&&F[3]===Le[3]&&F[4]===Le[4]&&F[5]===Le[5]},jt.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Oe[0],bi=Oe[1],wi=Oe[2],qr=Oe[3],Xn=Oe[4],Yn=Oe[5];return Math.abs(Fe-Gt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(Gt))&&Math.abs(je-bi)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(bi))&&Math.abs(qe-wi)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(wi))&&Math.abs(He-qr)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(qr))&&Math.abs(xt-Xn)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(Xn))&&Math.abs(jt-Yn)<=F.EPSILON*Math.max(1,Math.abs(jt),Math.abs(Yn))},jt.sub=jt.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=r(void 0);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}(s());function r(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Le})(F)}function n(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Oe[0],bi=Oe[1],wi=Oe[2],qr=Oe[3],Xn=Oe[4],Yn=Oe[5];return F[0]=Fe*Gt+qe*bi,F[1]=je*Gt+He*bi,F[2]=Fe*wi+qe*qr,F[3]=je*wi+He*qr,F[4]=Fe*Xn+qe*Yn+xt,F[5]=je*Xn+He*Yn+jt,F}function i(F,Le,Oe){return F[0]=Le[0]-Oe[0],F[1]=Le[1]-Oe[1],F[2]=Le[2]-Oe[2],F[3]=Le[3]-Oe[3],F[4]=Le[4]-Oe[4],F[5]=Le[5]-Oe[5],F}return jt.mul=n,jt.sub=i,jt}var Gt,bi={};function d(){if(Gt)return bi;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Gt=1,Object.defineProperty(bi,"__esModule",{value:!0}),bi.create=function(){var Le=new F.ARRAY_TYPE(9);return F.ARRAY_TYPE!=Float32Array&&(Le[1]=0,Le[2]=0,Le[3]=0,Le[5]=0,Le[6]=0,Le[7]=0),Le[0]=1,Le[4]=1,Le[8]=1,Le},bi.fromMat4=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[4],F[4]=Le[5],F[5]=Le[6],F[6]=Le[8],F[7]=Le[9],F[8]=Le[10],F},bi.clone=function(Le){var Oe=new F.ARRAY_TYPE(9);return Oe[0]=Le[0],Oe[1]=Le[1],Oe[2]=Le[2],Oe[3]=Le[3],Oe[4]=Le[4],Oe[5]=Le[5],Oe[6]=Le[6],Oe[7]=Le[7],Oe[8]=Le[8],Oe},bi.copy=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F[4]=Le[4],F[5]=Le[5],F[6]=Le[6],F[7]=Le[7],F[8]=Le[8],F},bi.fromValues=function(Le,Oe,Fe,je,qe,He,xt,jt,Gt){var bi=new F.ARRAY_TYPE(9);return bi[0]=Le,bi[1]=Oe,bi[2]=Fe,bi[3]=je,bi[4]=qe,bi[5]=He,bi[6]=xt,bi[7]=jt,bi[8]=Gt,bi},bi.set=function(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt){return F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=je,F[4]=qe,F[5]=He,F[6]=xt,F[7]=jt,F[8]=Gt,F},bi.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},bi.transpose=function(F,Le){if(F===Le){var Oe=Le[1],Fe=Le[2],je=Le[5];F[1]=Le[3],F[2]=Le[6],F[3]=Oe,F[5]=Le[7],F[6]=Fe,F[7]=je}else F[0]=Le[0],F[1]=Le[3],F[2]=Le[6],F[3]=Le[1],F[4]=Le[4],F[5]=Le[7],F[6]=Le[2],F[7]=Le[5],F[8]=Le[8];return F},bi.invert=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Le[4],xt=Le[5],jt=Le[6],Gt=Le[7],bi=Le[8],wi=bi*He-xt*Gt,qr=-bi*qe+xt*jt,Xn=Gt*qe-He*jt,Yn=Oe*wi+Fe*qr+je*Xn;return Yn?(F[0]=wi*(Yn=1/Yn),F[1]=(-bi*Fe+je*Gt)*Yn,F[2]=(xt*Fe-je*He)*Yn,F[3]=qr*Yn,F[4]=(bi*Oe-je*jt)*Yn,F[5]=(-xt*Oe+je*qe)*Yn,F[6]=Xn*Yn,F[7]=(-Gt*Oe+Fe*jt)*Yn,F[8]=(He*Oe-Fe*qe)*Yn,F):null},bi.adjoint=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Le[4],xt=Le[5],jt=Le[6],Gt=Le[7],bi=Le[8];return F[0]=He*bi-xt*Gt,F[1]=je*Gt-Fe*bi,F[2]=Fe*xt-je*He,F[3]=xt*jt-qe*bi,F[4]=Oe*bi-je*jt,F[5]=je*qe-Oe*xt,F[6]=qe*Gt-He*jt,F[7]=Fe*jt-Oe*Gt,F[8]=Oe*He-Fe*qe,F},bi.determinant=function(F){var Le=F[3],Oe=F[4],Fe=F[5],je=F[6],qe=F[7],He=F[8];return F[0]*(He*Oe-Fe*qe)+F[1]*(-He*Le+Fe*je)+F[2]*(qe*Le-Oe*je)},bi.multiply=n,bi.translate=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Le[8],qr=Oe[0],Xn=Oe[1];return F[0]=Fe,F[1]=je,F[2]=qe,F[3]=He,F[4]=xt,F[5]=jt,F[6]=qr*Fe+Xn*He+Gt,F[7]=qr*je+Xn*xt+bi,F[8]=qr*qe+Xn*jt+wi,F},bi.rotate=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Le[8],qr=Math.sin(Oe),Xn=Math.cos(Oe);return F[0]=Xn*Fe+qr*He,F[1]=Xn*je+qr*xt,F[2]=Xn*qe+qr*jt,F[3]=Xn*He-qr*Fe,F[4]=Xn*xt-qr*je,F[5]=Xn*jt-qr*qe,F[6]=Gt,F[7]=bi,F[8]=wi,F},bi.scale=function(F,Le,Oe){var Fe=Oe[0],je=Oe[1];return F[0]=Fe*Le[0],F[1]=Fe*Le[1],F[2]=Fe*Le[2],F[3]=je*Le[3],F[4]=je*Le[4],F[5]=je*Le[5],F[6]=Le[6],F[7]=Le[7],F[8]=Le[8],F},bi.fromTranslation=function(F,Le){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=Le[0],F[7]=Le[1],F[8]=1,F},bi.fromRotation=function(F,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le);return F[0]=Fe,F[1]=Oe,F[2]=0,F[3]=-Oe,F[4]=Fe,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},bi.fromScaling=function(F,Le){return F[0]=Le[0],F[1]=0,F[2]=0,F[3]=0,F[4]=Le[1],F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},bi.fromMat2d=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=0,F[3]=Le[2],F[4]=Le[3],F[5]=0,F[6]=Le[4],F[7]=Le[5],F[8]=1,F},bi.fromQuat=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Oe+Oe,xt=Fe+Fe,jt=je+je,Gt=Oe*He,bi=Fe*He,wi=Fe*xt,qr=je*He,Xn=je*xt,Yn=je*jt,yo=qe*He,bo=qe*xt,Do=qe*jt;return F[0]=1-wi-Yn,F[3]=bi-Do,F[6]=qr+bo,F[1]=bi+Do,F[4]=1-Gt-Yn,F[7]=Xn-yo,F[2]=qr-bo,F[5]=Xn+yo,F[8]=1-Gt-wi,F},bi.normalFromMat4=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Le[4],xt=Le[5],jt=Le[6],Gt=Le[7],bi=Le[8],wi=Le[9],qr=Le[10],Xn=Le[11],Yn=Le[12],yo=Le[13],bo=Le[14],Do=Le[15],Ro=Oe*xt-Fe*He,zs=Oe*jt-je*He,Zs=Oe*Gt-qe*He,na=Fe*jt-je*xt,el=Fe*Gt-qe*xt,nl=je*Gt-qe*jt,hl=bi*yo-wi*Yn,pl=bi*bo-qr*Yn,bl=bi*Do-Xn*Yn,Tl=wi*bo-qr*yo,kl=wi*Do-Xn*yo,ec=qr*Do-Xn*bo,tc=Ro*ec-zs*kl+Zs*Tl+na*bl-el*pl+nl*hl;return tc?(F[0]=(xt*ec-jt*kl+Gt*Tl)*(tc=1/tc),F[1]=(jt*bl-He*ec-Gt*pl)*tc,F[2]=(He*kl-xt*bl+Gt*hl)*tc,F[3]=(je*kl-Fe*ec-qe*Tl)*tc,F[4]=(Oe*ec-je*bl+qe*pl)*tc,F[5]=(Fe*bl-Oe*kl-qe*hl)*tc,F[6]=(yo*nl-bo*el+Do*na)*tc,F[7]=(bo*Zs-Yn*nl-Do*zs)*tc,F[8]=(Yn*el-yo*Zs+Do*Ro)*tc,F):null},bi.projection=function(F,Le,Oe){return F[0]=2/Le,F[1]=0,F[2]=0,F[3]=0,F[4]=-2/Oe,F[5]=0,F[6]=-1,F[7]=1,F[8]=1,F},bi.str=function(F){return"mat3("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+")"},bi.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8])},bi.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F[2]=Le[2]+Oe[2],F[3]=Le[3]+Oe[3],F[4]=Le[4]+Oe[4],F[5]=Le[5]+Oe[5],F[6]=Le[6]+Oe[6],F[7]=Le[7]+Oe[7],F[8]=Le[8]+Oe[8],F},bi.subtract=i,bi.multiplyScalar=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F[2]=Le[2]*Oe,F[3]=Le[3]*Oe,F[4]=Le[4]*Oe,F[5]=Le[5]*Oe,F[6]=Le[6]*Oe,F[7]=Le[7]*Oe,F[8]=Le[8]*Oe,F},bi.multiplyScalarAndAdd=function(F,Le,Oe,Fe){return F[0]=Le[0]+Oe[0]*Fe,F[1]=Le[1]+Oe[1]*Fe,F[2]=Le[2]+Oe[2]*Fe,F[3]=Le[3]+Oe[3]*Fe,F[4]=Le[4]+Oe[4]*Fe,F[5]=Le[5]+Oe[5]*Fe,F[6]=Le[6]+Oe[6]*Fe,F[7]=Le[7]+Oe[7]*Fe,F[8]=Le[8]+Oe[8]*Fe,F},bi.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]&&F[2]===Le[2]&&F[3]===Le[3]&&F[4]===Le[4]&&F[5]===Le[5]&&F[6]===Le[6]&&F[7]===Le[7]&&F[8]===Le[8]},bi.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Le[8],qr=Oe[0],Xn=Oe[1],Yn=Oe[2],yo=Oe[3],bo=Oe[4],Do=Oe[5],Ro=Oe[6],zs=Oe[7],Zs=Oe[8];return Math.abs(Fe-qr)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(qr))&&Math.abs(je-Xn)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(Xn))&&Math.abs(qe-Yn)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Yn))&&Math.abs(He-yo)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(yo))&&Math.abs(xt-bo)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(bo))&&Math.abs(jt-Do)<=F.EPSILON*Math.max(1,Math.abs(jt),Math.abs(Do))&&Math.abs(Gt-Ro)<=F.EPSILON*Math.max(1,Math.abs(Gt),Math.abs(Ro))&&Math.abs(bi-zs)<=F.EPSILON*Math.max(1,Math.abs(bi),Math.abs(zs))&&Math.abs(wi-Zs)<=F.EPSILON*Math.max(1,Math.abs(wi),Math.abs(Zs))},bi.sub=bi.mul=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=r(void 0);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}(s());function r(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Le})(F)}function n(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Le[8],qr=Oe[0],Xn=Oe[1],Yn=Oe[2],yo=Oe[3],bo=Oe[4],Do=Oe[5],Ro=Oe[6],zs=Oe[7],Zs=Oe[8];return F[0]=qr*Fe+Xn*He+Yn*Gt,F[1]=qr*je+Xn*xt+Yn*bi,F[2]=qr*qe+Xn*jt+Yn*wi,F[3]=yo*Fe+bo*He+Do*Gt,F[4]=yo*je+bo*xt+Do*bi,F[5]=yo*qe+bo*jt+Do*wi,F[6]=Ro*Fe+zs*He+Zs*Gt,F[7]=Ro*je+zs*xt+Zs*bi,F[8]=Ro*qe+zs*jt+Zs*wi,F}function i(F,Le,Oe){return F[0]=Le[0]-Oe[0],F[1]=Le[1]-Oe[1],F[2]=Le[2]-Oe[2],F[3]=Le[3]-Oe[3],F[4]=Le[4]-Oe[4],F[5]=Le[5]-Oe[5],F[6]=Le[6]-Oe[6],F[7]=Le[7]-Oe[7],F[8]=Le[8]-Oe[8],F}return bi.mul=n,bi.sub=i,bi}var wi,qr={};function g(){if(wi)return qr;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}wi=1,Object.defineProperty(qr,"__esModule",{value:!0}),qr.create=function(){var Le=new F.ARRAY_TYPE(16);return F.ARRAY_TYPE!=Float32Array&&(Le[1]=0,Le[2]=0,Le[3]=0,Le[4]=0,Le[6]=0,Le[7]=0,Le[8]=0,Le[9]=0,Le[11]=0,Le[12]=0,Le[13]=0,Le[14]=0),Le[0]=1,Le[5]=1,Le[10]=1,Le[15]=1,Le},qr.clone=function(Le){var Oe=new F.ARRAY_TYPE(16);return Oe[0]=Le[0],Oe[1]=Le[1],Oe[2]=Le[2],Oe[3]=Le[3],Oe[4]=Le[4],Oe[5]=Le[5],Oe[6]=Le[6],Oe[7]=Le[7],Oe[8]=Le[8],Oe[9]=Le[9],Oe[10]=Le[10],Oe[11]=Le[11],Oe[12]=Le[12],Oe[13]=Le[13],Oe[14]=Le[14],Oe[15]=Le[15],Oe},qr.copy=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F[4]=Le[4],F[5]=Le[5],F[6]=Le[6],F[7]=Le[7],F[8]=Le[8],F[9]=Le[9],F[10]=Le[10],F[11]=Le[11],F[12]=Le[12],F[13]=Le[13],F[14]=Le[14],F[15]=Le[15],F},qr.fromValues=function(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo){var Do=new F.ARRAY_TYPE(16);return Do[0]=Le,Do[1]=Oe,Do[2]=Fe,Do[3]=je,Do[4]=qe,Do[5]=He,Do[6]=xt,Do[7]=jt,Do[8]=Gt,Do[9]=bi,Do[10]=wi,Do[11]=qr,Do[12]=Xn,Do[13]=Yn,Do[14]=yo,Do[15]=bo,Do},qr.set=function(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo){return F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=je,F[4]=qe,F[5]=He,F[6]=xt,F[7]=jt,F[8]=Gt,F[9]=bi,F[10]=wi,F[11]=qr,F[12]=Xn,F[13]=Yn,F[14]=yo,F[15]=bo,F},qr.identity=n,qr.transpose=function(F,Le){if(F===Le){var Oe=Le[1],Fe=Le[2],je=Le[3],qe=Le[6],He=Le[7],xt=Le[11];F[1]=Le[4],F[2]=Le[8],F[3]=Le[12],F[4]=Oe,F[6]=Le[9],F[7]=Le[13],F[8]=Fe,F[9]=qe,F[11]=Le[14],F[12]=je,F[13]=He,F[14]=xt}else F[0]=Le[0],F[1]=Le[4],F[2]=Le[8],F[3]=Le[12],F[4]=Le[1],F[5]=Le[5],F[6]=Le[9],F[7]=Le[13],F[8]=Le[2],F[9]=Le[6],F[10]=Le[10],F[11]=Le[14],F[12]=Le[3],F[13]=Le[7],F[14]=Le[11],F[15]=Le[15];return F},qr.invert=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Le[4],xt=Le[5],jt=Le[6],Gt=Le[7],bi=Le[8],wi=Le[9],qr=Le[10],Xn=Le[11],Yn=Le[12],yo=Le[13],bo=Le[14],Do=Le[15],Ro=Oe*xt-Fe*He,zs=Oe*jt-je*He,Zs=Oe*Gt-qe*He,na=Fe*jt-je*xt,el=Fe*Gt-qe*xt,nl=je*Gt-qe*jt,hl=bi*yo-wi*Yn,pl=bi*bo-qr*Yn,bl=bi*Do-Xn*Yn,Tl=wi*bo-qr*yo,kl=wi*Do-Xn*yo,ec=qr*Do-Xn*bo,tc=Ro*ec-zs*kl+Zs*Tl+na*bl-el*pl+nl*hl;return tc?(F[0]=(xt*ec-jt*kl+Gt*Tl)*(tc=1/tc),F[1]=(je*kl-Fe*ec-qe*Tl)*tc,F[2]=(yo*nl-bo*el+Do*na)*tc,F[3]=(qr*el-wi*nl-Xn*na)*tc,F[4]=(jt*bl-He*ec-Gt*pl)*tc,F[5]=(Oe*ec-je*bl+qe*pl)*tc,F[6]=(bo*Zs-Yn*nl-Do*zs)*tc,F[7]=(bi*nl-qr*Zs+Xn*zs)*tc,F[8]=(He*kl-xt*bl+Gt*hl)*tc,F[9]=(Fe*bl-Oe*kl-qe*hl)*tc,F[10]=(Yn*el-yo*Zs+Do*Ro)*tc,F[11]=(wi*Zs-bi*el-Xn*Ro)*tc,F[12]=(xt*pl-He*Tl-jt*hl)*tc,F[13]=(Oe*Tl-Fe*pl+je*hl)*tc,F[14]=(yo*zs-Yn*na-bo*Ro)*tc,F[15]=(bi*na-wi*zs+qr*Ro)*tc,F):null},qr.adjoint=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Le[4],xt=Le[5],jt=Le[6],Gt=Le[7],bi=Le[8],wi=Le[9],qr=Le[10],Xn=Le[11],Yn=Le[12],yo=Le[13],bo=Le[14],Do=Le[15];return F[0]=xt*(qr*Do-Xn*bo)-wi*(jt*Do-Gt*bo)+yo*(jt*Xn-Gt*qr),F[1]=-(Fe*(qr*Do-Xn*bo)-wi*(je*Do-qe*bo)+yo*(je*Xn-qe*qr)),F[2]=Fe*(jt*Do-Gt*bo)-xt*(je*Do-qe*bo)+yo*(je*Gt-qe*jt),F[3]=-(Fe*(jt*Xn-Gt*qr)-xt*(je*Xn-qe*qr)+wi*(je*Gt-qe*jt)),F[4]=-(He*(qr*Do-Xn*bo)-bi*(jt*Do-Gt*bo)+Yn*(jt*Xn-Gt*qr)),F[5]=Oe*(qr*Do-Xn*bo)-bi*(je*Do-qe*bo)+Yn*(je*Xn-qe*qr),F[6]=-(Oe*(jt*Do-Gt*bo)-He*(je*Do-qe*bo)+Yn*(je*Gt-qe*jt)),F[7]=Oe*(jt*Xn-Gt*qr)-He*(je*Xn-qe*qr)+bi*(je*Gt-qe*jt),F[8]=He*(wi*Do-Xn*yo)-bi*(xt*Do-Gt*yo)+Yn*(xt*Xn-Gt*wi),F[9]=-(Oe*(wi*Do-Xn*yo)-bi*(Fe*Do-qe*yo)+Yn*(Fe*Xn-qe*wi)),F[10]=Oe*(xt*Do-Gt*yo)-He*(Fe*Do-qe*yo)+Yn*(Fe*Gt-qe*xt),F[11]=-(Oe*(xt*Xn-Gt*wi)-He*(Fe*Xn-qe*wi)+bi*(Fe*Gt-qe*xt)),F[12]=-(He*(wi*bo-qr*yo)-bi*(xt*bo-jt*yo)+Yn*(xt*qr-jt*wi)),F[13]=Oe*(wi*bo-qr*yo)-bi*(Fe*bo-je*yo)+Yn*(Fe*qr-je*wi),F[14]=-(Oe*(xt*bo-jt*yo)-He*(Fe*bo-je*yo)+Yn*(Fe*jt-je*xt)),F[15]=Oe*(xt*qr-jt*wi)-He*(Fe*qr-je*wi)+bi*(Fe*jt-je*xt),F},qr.determinant=function(F){var Le=F[0],Oe=F[1],Fe=F[2],je=F[3],qe=F[4],He=F[5],xt=F[6],jt=F[7],Gt=F[8],bi=F[9],wi=F[10],qr=F[11],Xn=F[12],Yn=F[13],yo=F[14],bo=F[15];return(Le*He-Oe*qe)*(wi*bo-qr*yo)-(Le*xt-Fe*qe)*(bi*bo-qr*Yn)+(Le*jt-je*qe)*(bi*yo-wi*Yn)+(Oe*xt-Fe*He)*(Gt*bo-qr*Xn)-(Oe*jt-je*He)*(Gt*yo-wi*Xn)+(Fe*jt-je*xt)*(Gt*Yn-bi*Xn)},qr.multiply=i,qr.translate=function(F,Le,Oe){var Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo=Oe[0],bo=Oe[1],Do=Oe[2];return Le===F?(F[12]=Le[0]*yo+Le[4]*bo+Le[8]*Do+Le[12],F[13]=Le[1]*yo+Le[5]*bo+Le[9]*Do+Le[13],F[14]=Le[2]*yo+Le[6]*bo+Le[10]*Do+Le[14],F[15]=Le[3]*yo+Le[7]*bo+Le[11]*Do+Le[15]):(je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Le[8],qr=Le[9],Xn=Le[10],Yn=Le[11],F[0]=Fe=Le[0],F[1]=je,F[2]=qe,F[3]=He,F[4]=xt,F[5]=jt,F[6]=Gt,F[7]=bi,F[8]=wi,F[9]=qr,F[10]=Xn,F[11]=Yn,F[12]=Fe*yo+xt*bo+wi*Do+Le[12],F[13]=je*yo+jt*bo+qr*Do+Le[13],F[14]=qe*yo+Gt*bo+Xn*Do+Le[14],F[15]=He*yo+bi*bo+Yn*Do+Le[15]),F},qr.scale=function(F,Le,Oe){var Fe=Oe[0],je=Oe[1],qe=Oe[2];return F[0]=Le[0]*Fe,F[1]=Le[1]*Fe,F[2]=Le[2]*Fe,F[3]=Le[3]*Fe,F[4]=Le[4]*je,F[5]=Le[5]*je,F[6]=Le[6]*je,F[7]=Le[7]*je,F[8]=Le[8]*qe,F[9]=Le[9]*qe,F[10]=Le[10]*qe,F[11]=Le[11]*qe,F[12]=Le[12],F[13]=Le[13],F[14]=Le[14],F[15]=Le[15],F},qr.rotate=function(Le,Oe,Fe,je){var qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl,ec=je[0],tc=je[1],ic=je[2],oc=Math.hypot(ec,tc,ic);return oc<F.EPSILON?null:(ec*=oc=1/oc,tc*=oc,ic*=oc,qe=Math.sin(Fe),He=Math.cos(Fe),Gt=Oe[1],bi=Oe[2],wi=Oe[3],Xn=Oe[5],Yn=Oe[6],yo=Oe[7],Do=Oe[9],Ro=Oe[10],zs=Oe[11],Zs=ec*ec*(xt=1-He)+He,nl=ec*tc*xt-ic*qe,hl=tc*tc*xt+He,pl=ic*tc*xt+ec*qe,bl=ec*ic*xt+tc*qe,Tl=tc*ic*xt-ec*qe,kl=ic*ic*xt+He,Le[0]=(jt=Oe[0])*Zs+(qr=Oe[4])*(na=tc*ec*xt+ic*qe)+(bo=Oe[8])*(el=ic*ec*xt-tc*qe),Le[1]=Gt*Zs+Xn*na+Do*el,Le[2]=bi*Zs+Yn*na+Ro*el,Le[3]=wi*Zs+yo*na+zs*el,Le[4]=jt*nl+qr*hl+bo*pl,Le[5]=Gt*nl+Xn*hl+Do*pl,Le[6]=bi*nl+Yn*hl+Ro*pl,Le[7]=wi*nl+yo*hl+zs*pl,Le[8]=jt*bl+qr*Tl+bo*kl,Le[9]=Gt*bl+Xn*Tl+Do*kl,Le[10]=bi*bl+Yn*Tl+Ro*kl,Le[11]=wi*bl+yo*Tl+zs*kl,Oe!==Le&&(Le[12]=Oe[12],Le[13]=Oe[13],Le[14]=Oe[14],Le[15]=Oe[15]),Le)},qr.rotateX=function(F,Le,Oe){var Fe=Math.sin(Oe),je=Math.cos(Oe),qe=Le[4],He=Le[5],xt=Le[6],jt=Le[7],Gt=Le[8],bi=Le[9],wi=Le[10],qr=Le[11];return Le!==F&&(F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F[12]=Le[12],F[13]=Le[13],F[14]=Le[14],F[15]=Le[15]),F[4]=qe*je+Gt*Fe,F[5]=He*je+bi*Fe,F[6]=xt*je+wi*Fe,F[7]=jt*je+qr*Fe,F[8]=Gt*je-qe*Fe,F[9]=bi*je-He*Fe,F[10]=wi*je-xt*Fe,F[11]=qr*je-jt*Fe,F},qr.rotateY=function(F,Le,Oe){var Fe=Math.sin(Oe),je=Math.cos(Oe),qe=Le[0],He=Le[1],xt=Le[2],jt=Le[3],Gt=Le[8],bi=Le[9],wi=Le[10],qr=Le[11];return Le!==F&&(F[4]=Le[4],F[5]=Le[5],F[6]=Le[6],F[7]=Le[7],F[12]=Le[12],F[13]=Le[13],F[14]=Le[14],F[15]=Le[15]),F[0]=qe*je-Gt*Fe,F[1]=He*je-bi*Fe,F[2]=xt*je-wi*Fe,F[3]=jt*je-qr*Fe,F[8]=qe*Fe+Gt*je,F[9]=He*Fe+bi*je,F[10]=xt*Fe+wi*je,F[11]=jt*Fe+qr*je,F},qr.rotateZ=function(F,Le,Oe){var Fe=Math.sin(Oe),je=Math.cos(Oe),qe=Le[0],He=Le[1],xt=Le[2],jt=Le[3],Gt=Le[4],bi=Le[5],wi=Le[6],qr=Le[7];return Le!==F&&(F[8]=Le[8],F[9]=Le[9],F[10]=Le[10],F[11]=Le[11],F[12]=Le[12],F[13]=Le[13],F[14]=Le[14],F[15]=Le[15]),F[0]=qe*je+Gt*Fe,F[1]=He*je+bi*Fe,F[2]=xt*je+wi*Fe,F[3]=jt*je+qr*Fe,F[4]=Gt*je-qe*Fe,F[5]=bi*je-He*Fe,F[6]=wi*je-xt*Fe,F[7]=qr*je-jt*Fe,F},qr.fromTranslation=function(F,Le){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=Le[0],F[13]=Le[1],F[14]=Le[2],F[15]=1,F},qr.fromScaling=function(F,Le){return F[0]=Le[0],F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Le[1],F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=Le[2],F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},qr.fromRotation=function(Le,Oe,Fe){var je,qe,He,xt=Fe[0],jt=Fe[1],Gt=Fe[2],bi=Math.hypot(xt,jt,Gt);return bi<F.EPSILON?null:(xt*=bi=1/bi,jt*=bi,Gt*=bi,je=Math.sin(Oe),qe=Math.cos(Oe),Le[0]=xt*xt*(He=1-qe)+qe,Le[1]=jt*xt*He+Gt*je,Le[2]=Gt*xt*He-jt*je,Le[3]=0,Le[4]=xt*jt*He-Gt*je,Le[5]=jt*jt*He+qe,Le[6]=Gt*jt*He+xt*je,Le[7]=0,Le[8]=xt*Gt*He+jt*je,Le[9]=jt*Gt*He-xt*je,Le[10]=Gt*Gt*He+qe,Le[11]=0,Le[12]=0,Le[13]=0,Le[14]=0,Le[15]=1,Le)},qr.fromXRotation=function(F,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le);return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Fe,F[6]=Oe,F[7]=0,F[8]=0,F[9]=-Oe,F[10]=Fe,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},qr.fromYRotation=function(F,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le);return F[0]=Fe,F[1]=0,F[2]=-Oe,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=Oe,F[9]=0,F[10]=Fe,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},qr.fromZRotation=function(F,Le){var Oe=Math.sin(Le),Fe=Math.cos(Le);return F[0]=Fe,F[1]=Oe,F[2]=0,F[3]=0,F[4]=-Oe,F[5]=Fe,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},qr.fromRotationTranslation=a,qr.fromQuat2=function(Le,Oe){var Fe=new F.ARRAY_TYPE(3),je=-Oe[0],qe=-Oe[1],He=-Oe[2],xt=Oe[3],jt=Oe[4],Gt=Oe[5],bi=Oe[6],wi=Oe[7],qr=je*je+qe*qe+He*He+xt*xt;return qr>0?(Fe[0]=2*(jt*xt+wi*je+Gt*He-bi*qe)/qr,Fe[1]=2*(Gt*xt+wi*qe+bi*je-jt*He)/qr,Fe[2]=2*(bi*xt+wi*He+jt*qe-Gt*je)/qr):(Fe[0]=2*(jt*xt+wi*je+Gt*He-bi*qe),Fe[1]=2*(Gt*xt+wi*qe+bi*je-jt*He),Fe[2]=2*(bi*xt+wi*He+jt*qe-Gt*je)),a(Le,Oe,Fe),Le},qr.getTranslation=function(F,Le){return F[0]=Le[12],F[1]=Le[13],F[2]=Le[14],F},qr.getScaling=o,qr.getRotation=function(Le,Oe){var Fe=new F.ARRAY_TYPE(3);o(Fe,Oe);var je=1/Fe[0],qe=1/Fe[1],He=1/Fe[2],xt=Oe[0]*je,jt=Oe[1]*qe,Gt=Oe[2]*He,bi=Oe[4]*je,wi=Oe[5]*qe,qr=Oe[6]*He,Xn=Oe[8]*je,Yn=Oe[9]*qe,yo=Oe[10]*He,bo=xt+wi+yo,Do=0;return bo>0?(Do=2*Math.sqrt(bo+1),Le[3]=.25*Do,Le[0]=(qr-Yn)/Do,Le[1]=(Xn-Gt)/Do,Le[2]=(jt-bi)/Do):xt>wi&&xt>yo?(Do=2*Math.sqrt(1+xt-wi-yo),Le[3]=(qr-Yn)/Do,Le[0]=.25*Do,Le[1]=(jt+bi)/Do,Le[2]=(Xn+Gt)/Do):wi>yo?(Do=2*Math.sqrt(1+wi-xt-yo),Le[3]=(Xn-Gt)/Do,Le[0]=(jt+bi)/Do,Le[1]=.25*Do,Le[2]=(qr+Yn)/Do):(Do=2*Math.sqrt(1+yo-xt-wi),Le[3]=(jt-bi)/Do,Le[0]=(Xn+Gt)/Do,Le[1]=(qr+Yn)/Do,Le[2]=.25*Do),Le},qr.fromRotationTranslationScale=function(F,Le,Oe,Fe){var je=Le[0],qe=Le[1],He=Le[2],xt=Le[3],jt=je+je,Gt=qe+qe,bi=He+He,wi=je*jt,qr=je*Gt,Xn=je*bi,Yn=qe*Gt,yo=qe*bi,bo=He*bi,Do=xt*jt,Ro=xt*Gt,zs=xt*bi,Zs=Fe[0],na=Fe[1],el=Fe[2];return F[0]=(1-(Yn+bo))*Zs,F[1]=(qr+zs)*Zs,F[2]=(Xn-Ro)*Zs,F[3]=0,F[4]=(qr-zs)*na,F[5]=(1-(wi+bo))*na,F[6]=(yo+Do)*na,F[7]=0,F[8]=(Xn+Ro)*el,F[9]=(yo-Do)*el,F[10]=(1-(wi+Yn))*el,F[11]=0,F[12]=Oe[0],F[13]=Oe[1],F[14]=Oe[2],F[15]=1,F},qr.fromRotationTranslationScaleOrigin=function(F,Le,Oe,Fe,je){var qe=Le[0],He=Le[1],xt=Le[2],jt=Le[3],Gt=qe+qe,bi=He+He,wi=xt+xt,qr=qe*Gt,Xn=qe*bi,Yn=qe*wi,yo=He*bi,bo=He*wi,Do=xt*wi,Ro=jt*Gt,zs=jt*bi,Zs=jt*wi,na=Fe[0],el=Fe[1],nl=Fe[2],hl=je[0],pl=je[1],bl=je[2],Tl=(1-(yo+Do))*na,kl=(Xn+Zs)*na,ec=(Yn-zs)*na,tc=(Xn-Zs)*el,ic=(1-(qr+Do))*el,oc=(bo+Ro)*el,sc=(Yn+zs)*nl,ac=(bo-Ro)*nl,mc=(1-(qr+yo))*nl;return F[0]=Tl,F[1]=kl,F[2]=ec,F[3]=0,F[4]=tc,F[5]=ic,F[6]=oc,F[7]=0,F[8]=sc,F[9]=ac,F[10]=mc,F[11]=0,F[12]=Oe[0]+hl-(Tl*hl+tc*pl+sc*bl),F[13]=Oe[1]+pl-(kl*hl+ic*pl+ac*bl),F[14]=Oe[2]+bl-(ec*hl+oc*pl+mc*bl),F[15]=1,F},qr.fromQuat=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Oe+Oe,xt=Fe+Fe,jt=je+je,Gt=Oe*He,bi=Fe*He,wi=Fe*xt,qr=je*He,Xn=je*xt,Yn=je*jt,yo=qe*He,bo=qe*xt,Do=qe*jt;return F[0]=1-wi-Yn,F[1]=bi+Do,F[2]=qr-bo,F[3]=0,F[4]=bi-Do,F[5]=1-Gt-Yn,F[6]=Xn+yo,F[7]=0,F[8]=qr+bo,F[9]=Xn-yo,F[10]=1-Gt-wi,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},qr.frustum=function(F,Le,Oe,Fe,je,qe,He){var xt=1/(Oe-Le),jt=1/(je-Fe),Gt=1/(qe-He);return F[0]=2*qe*xt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=2*qe*jt,F[6]=0,F[7]=0,F[8]=(Oe+Le)*xt,F[9]=(je+Fe)*jt,F[10]=(He+qe)*Gt,F[11]=-1,F[12]=0,F[13]=0,F[14]=He*qe*2*Gt,F[15]=0,F},qr.perspectiveNO=l,qr.perspectiveZO=function(F,Le,Oe,Fe,je){var qe,He=1/Math.tan(Le/2);return F[0]=He/Oe,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=He,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=je&&je!==1/0?(F[10]=je*(qe=1/(Fe-je)),F[14]=je*Fe*qe):(F[10]=-1,F[14]=-Fe),F},qr.perspectiveFromFieldOfView=function(F,Le,Oe,Fe){var je=Math.tan(Le.upDegrees*Math.PI/180),qe=Math.tan(Le.downDegrees*Math.PI/180),He=Math.tan(Le.leftDegrees*Math.PI/180),xt=Math.tan(Le.rightDegrees*Math.PI/180),jt=2/(He+xt),Gt=2/(je+qe);return F[0]=jt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=Gt,F[6]=0,F[7]=0,F[8]=-(He-xt)*jt*.5,F[9]=(je-qe)*Gt*.5,F[10]=Fe/(Oe-Fe),F[11]=-1,F[12]=0,F[13]=0,F[14]=Fe*Oe/(Oe-Fe),F[15]=0,F},qr.orthoNO=u,qr.orthoZO=function(F,Le,Oe,Fe,je,qe,He){var xt=1/(Le-Oe),jt=1/(Fe-je),Gt=1/(qe-He);return F[0]=-2*xt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*jt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=Gt,F[11]=0,F[12]=(Le+Oe)*xt,F[13]=(je+Fe)*jt,F[14]=qe*Gt,F[15]=1,F},qr.lookAt=function(Le,Oe,Fe,je){var qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo=Oe[0],bo=Oe[1],Do=Oe[2],Ro=je[0],zs=je[1],Zs=je[2],na=Fe[0],el=Fe[1],nl=Fe[2];return Math.abs(yo-na)<F.EPSILON&&Math.abs(bo-el)<F.EPSILON&&Math.abs(Do-nl)<F.EPSILON?n(Le):(wi=yo-na,qr=bo-el,Xn=Do-nl,qe=zs*(Xn*=Yn=1/Math.hypot(wi,qr,Xn))-Zs*(qr*=Yn),He=Zs*(wi*=Yn)-Ro*Xn,xt=Ro*qr-zs*wi,(Yn=Math.hypot(qe,He,xt))?(qe*=Yn=1/Yn,He*=Yn,xt*=Yn):(qe=0,He=0,xt=0),jt=qr*xt-Xn*He,Gt=Xn*qe-wi*xt,bi=wi*He-qr*qe,(Yn=Math.hypot(jt,Gt,bi))?(jt*=Yn=1/Yn,Gt*=Yn,bi*=Yn):(jt=0,Gt=0,bi=0),Le[0]=qe,Le[1]=jt,Le[2]=wi,Le[3]=0,Le[4]=He,Le[5]=Gt,Le[6]=qr,Le[7]=0,Le[8]=xt,Le[9]=bi,Le[10]=Xn,Le[11]=0,Le[12]=-(qe*yo+He*bo+xt*Do),Le[13]=-(jt*yo+Gt*bo+bi*Do),Le[14]=-(wi*yo+qr*bo+Xn*Do),Le[15]=1,Le)},qr.targetTo=function(F,Le,Oe,Fe){var je=Le[0],qe=Le[1],He=Le[2],xt=Fe[0],jt=Fe[1],Gt=Fe[2],bi=je-Oe[0],wi=qe-Oe[1],qr=He-Oe[2],Xn=bi*bi+wi*wi+qr*qr;Xn>0&&(bi*=Xn=1/Math.sqrt(Xn),wi*=Xn,qr*=Xn);var Yn=jt*qr-Gt*wi,yo=Gt*bi-xt*qr,bo=xt*wi-jt*bi;return(Xn=Yn*Yn+yo*yo+bo*bo)>0&&(Yn*=Xn=1/Math.sqrt(Xn),yo*=Xn,bo*=Xn),F[0]=Yn,F[1]=yo,F[2]=bo,F[3]=0,F[4]=wi*bo-qr*yo,F[5]=qr*Yn-bi*bo,F[6]=bi*yo-wi*Yn,F[7]=0,F[8]=bi,F[9]=wi,F[10]=qr,F[11]=0,F[12]=je,F[13]=qe,F[14]=He,F[15]=1,F},qr.str=function(F){return"mat4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+", "+F[9]+", "+F[10]+", "+F[11]+", "+F[12]+", "+F[13]+", "+F[14]+", "+F[15]+")"},qr.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8],F[9],F[10],F[11],F[12],F[13],F[14],F[15])},qr.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F[2]=Le[2]+Oe[2],F[3]=Le[3]+Oe[3],F[4]=Le[4]+Oe[4],F[5]=Le[5]+Oe[5],F[6]=Le[6]+Oe[6],F[7]=Le[7]+Oe[7],F[8]=Le[8]+Oe[8],F[9]=Le[9]+Oe[9],F[10]=Le[10]+Oe[10],F[11]=Le[11]+Oe[11],F[12]=Le[12]+Oe[12],F[13]=Le[13]+Oe[13],F[14]=Le[14]+Oe[14],F[15]=Le[15]+Oe[15],F},qr.subtract=c,qr.multiplyScalar=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F[2]=Le[2]*Oe,F[3]=Le[3]*Oe,F[4]=Le[4]*Oe,F[5]=Le[5]*Oe,F[6]=Le[6]*Oe,F[7]=Le[7]*Oe,F[8]=Le[8]*Oe,F[9]=Le[9]*Oe,F[10]=Le[10]*Oe,F[11]=Le[11]*Oe,F[12]=Le[12]*Oe,F[13]=Le[13]*Oe,F[14]=Le[14]*Oe,F[15]=Le[15]*Oe,F},qr.multiplyScalarAndAdd=function(F,Le,Oe,Fe){return F[0]=Le[0]+Oe[0]*Fe,F[1]=Le[1]+Oe[1]*Fe,F[2]=Le[2]+Oe[2]*Fe,F[3]=Le[3]+Oe[3]*Fe,F[4]=Le[4]+Oe[4]*Fe,F[5]=Le[5]+Oe[5]*Fe,F[6]=Le[6]+Oe[6]*Fe,F[7]=Le[7]+Oe[7]*Fe,F[8]=Le[8]+Oe[8]*Fe,F[9]=Le[9]+Oe[9]*Fe,F[10]=Le[10]+Oe[10]*Fe,F[11]=Le[11]+Oe[11]*Fe,F[12]=Le[12]+Oe[12]*Fe,F[13]=Le[13]+Oe[13]*Fe,F[14]=Le[14]+Oe[14]*Fe,F[15]=Le[15]+Oe[15]*Fe,F},qr.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]&&F[2]===Le[2]&&F[3]===Le[3]&&F[4]===Le[4]&&F[5]===Le[5]&&F[6]===Le[6]&&F[7]===Le[7]&&F[8]===Le[8]&&F[9]===Le[9]&&F[10]===Le[10]&&F[11]===Le[11]&&F[12]===Le[12]&&F[13]===Le[13]&&F[14]===Le[14]&&F[15]===Le[15]},qr.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Le[8],qr=Le[9],Xn=Le[10],Yn=Le[11],yo=Le[12],bo=Le[13],Do=Le[14],Ro=Le[15],zs=Oe[0],Zs=Oe[1],na=Oe[2],el=Oe[3],nl=Oe[4],hl=Oe[5],pl=Oe[6],bl=Oe[7],Tl=Oe[8],kl=Oe[9],ec=Oe[10],tc=Oe[11],ic=Oe[12],oc=Oe[13],sc=Oe[14],ac=Oe[15];return Math.abs(Fe-zs)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(zs))&&Math.abs(je-Zs)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(Zs))&&Math.abs(qe-na)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(na))&&Math.abs(He-el)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(el))&&Math.abs(xt-nl)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(nl))&&Math.abs(jt-hl)<=F.EPSILON*Math.max(1,Math.abs(jt),Math.abs(hl))&&Math.abs(Gt-pl)<=F.EPSILON*Math.max(1,Math.abs(Gt),Math.abs(pl))&&Math.abs(bi-bl)<=F.EPSILON*Math.max(1,Math.abs(bi),Math.abs(bl))&&Math.abs(wi-Tl)<=F.EPSILON*Math.max(1,Math.abs(wi),Math.abs(Tl))&&Math.abs(qr-kl)<=F.EPSILON*Math.max(1,Math.abs(qr),Math.abs(kl))&&Math.abs(Xn-ec)<=F.EPSILON*Math.max(1,Math.abs(Xn),Math.abs(ec))&&Math.abs(Yn-tc)<=F.EPSILON*Math.max(1,Math.abs(Yn),Math.abs(tc))&&Math.abs(yo-ic)<=F.EPSILON*Math.max(1,Math.abs(yo),Math.abs(ic))&&Math.abs(bo-oc)<=F.EPSILON*Math.max(1,Math.abs(bo),Math.abs(oc))&&Math.abs(Do-sc)<=F.EPSILON*Math.max(1,Math.abs(Do),Math.abs(sc))&&Math.abs(Ro-ac)<=F.EPSILON*Math.max(1,Math.abs(Ro),Math.abs(ac))},qr.sub=qr.mul=qr.ortho=qr.perspective=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=r(void 0);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}(s());function r(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Le})(F)}function n(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F}function i(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Le[8],qr=Le[9],Xn=Le[10],Yn=Le[11],yo=Le[12],bo=Le[13],Do=Le[14],Ro=Le[15],zs=Oe[0],Zs=Oe[1],na=Oe[2],el=Oe[3];return F[0]=zs*Fe+Zs*xt+na*wi+el*yo,F[1]=zs*je+Zs*jt+na*qr+el*bo,F[2]=zs*qe+Zs*Gt+na*Xn+el*Do,F[3]=zs*He+Zs*bi+na*Yn+el*Ro,F[4]=(zs=Oe[4])*Fe+(Zs=Oe[5])*xt+(na=Oe[6])*wi+(el=Oe[7])*yo,F[5]=zs*je+Zs*jt+na*qr+el*bo,F[6]=zs*qe+Zs*Gt+na*Xn+el*Do,F[7]=zs*He+Zs*bi+na*Yn+el*Ro,F[8]=(zs=Oe[8])*Fe+(Zs=Oe[9])*xt+(na=Oe[10])*wi+(el=Oe[11])*yo,F[9]=zs*je+Zs*jt+na*qr+el*bo,F[10]=zs*qe+Zs*Gt+na*Xn+el*Do,F[11]=zs*He+Zs*bi+na*Yn+el*Ro,F[12]=(zs=Oe[12])*Fe+(Zs=Oe[13])*xt+(na=Oe[14])*wi+(el=Oe[15])*yo,F[13]=zs*je+Zs*jt+na*qr+el*bo,F[14]=zs*qe+Zs*Gt+na*Xn+el*Do,F[15]=zs*He+Zs*bi+na*Yn+el*Ro,F}function a(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Fe+Fe,jt=je+je,Gt=qe+qe,bi=Fe*xt,wi=Fe*jt,qr=Fe*Gt,Xn=je*jt,Yn=je*Gt,yo=qe*Gt,bo=He*xt,Do=He*jt,Ro=He*Gt;return F[0]=1-(Xn+yo),F[1]=wi+Ro,F[2]=qr-Do,F[3]=0,F[4]=wi-Ro,F[5]=1-(bi+yo),F[6]=Yn+bo,F[7]=0,F[8]=qr+Do,F[9]=Yn-bo,F[10]=1-(bi+Xn),F[11]=0,F[12]=Oe[0],F[13]=Oe[1],F[14]=Oe[2],F[15]=1,F}function o(F,Le){var Oe=Le[4],Fe=Le[5],je=Le[6],qe=Le[8],He=Le[9],xt=Le[10];return F[0]=Math.hypot(Le[0],Le[1],Le[2]),F[1]=Math.hypot(Oe,Fe,je),F[2]=Math.hypot(qe,He,xt),F}function l(F,Le,Oe,Fe,je){var qe,He=1/Math.tan(Le/2);return F[0]=He/Oe,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=He,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=je&&je!==1/0?(F[10]=(je+Fe)*(qe=1/(Fe-je)),F[14]=2*je*Fe*qe):(F[10]=-1,F[14]=-2*Fe),F}function u(F,Le,Oe,Fe,je,qe,He){var xt=1/(Le-Oe),jt=1/(Fe-je),Gt=1/(qe-He);return F[0]=-2*xt,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*jt,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=2*Gt,F[11]=0,F[12]=(Le+Oe)*xt,F[13]=(je+Fe)*jt,F[14]=(He+qe)*Gt,F[15]=1,F}function c(F,Le,Oe){return F[0]=Le[0]-Oe[0],F[1]=Le[1]-Oe[1],F[2]=Le[2]-Oe[2],F[3]=Le[3]-Oe[3],F[4]=Le[4]-Oe[4],F[5]=Le[5]-Oe[5],F[6]=Le[6]-Oe[6],F[7]=Le[7]-Oe[7],F[8]=Le[8]-Oe[8],F[9]=Le[9]-Oe[9],F[10]=Le[10]-Oe[10],F[11]=Le[11]-Oe[11],F[12]=Le[12]-Oe[12],F[13]=Le[13]-Oe[13],F[14]=Le[14]-Oe[14],F[15]=Le[15]-Oe[15],F}return qr.perspective=l,qr.ortho=u,qr.mul=i,qr.sub=c,qr}var Xn,Yn={},yo={};function _(){if(Xn)return yo;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Xn=1,Object.defineProperty(yo,"__esModule",{value:!0}),yo.create=n,yo.clone=function(Le){var Oe=new F.ARRAY_TYPE(3);return Oe[0]=Le[0],Oe[1]=Le[1],Oe[2]=Le[2],Oe},yo.length=i,yo.fromValues=function(Le,Oe,Fe){var je=new F.ARRAY_TYPE(3);return je[0]=Le,je[1]=Oe,je[2]=Fe,je},yo.copy=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F},yo.set=function(F,Le,Oe,Fe){return F[0]=Le,F[1]=Oe,F[2]=Fe,F},yo.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F[2]=Le[2]+Oe[2],F},yo.subtract=a,yo.multiply=o,yo.divide=l,yo.ceil=function(F,Le){return F[0]=Math.ceil(Le[0]),F[1]=Math.ceil(Le[1]),F[2]=Math.ceil(Le[2]),F},yo.floor=function(F,Le){return F[0]=Math.floor(Le[0]),F[1]=Math.floor(Le[1]),F[2]=Math.floor(Le[2]),F},yo.min=function(F,Le,Oe){return F[0]=Math.min(Le[0],Oe[0]),F[1]=Math.min(Le[1],Oe[1]),F[2]=Math.min(Le[2],Oe[2]),F},yo.max=function(F,Le,Oe){return F[0]=Math.max(Le[0],Oe[0]),F[1]=Math.max(Le[1],Oe[1]),F[2]=Math.max(Le[2],Oe[2]),F},yo.round=function(F,Le){return F[0]=Math.round(Le[0]),F[1]=Math.round(Le[1]),F[2]=Math.round(Le[2]),F},yo.scale=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F[2]=Le[2]*Oe,F},yo.scaleAndAdd=function(F,Le,Oe,Fe){return F[0]=Le[0]+Oe[0]*Fe,F[1]=Le[1]+Oe[1]*Fe,F[2]=Le[2]+Oe[2]*Fe,F},yo.distance=u,yo.squaredDistance=c,yo.squaredLength=h,yo.negate=function(F,Le){return F[0]=-Le[0],F[1]=-Le[1],F[2]=-Le[2],F},yo.inverse=function(F,Le){return F[0]=1/Le[0],F[1]=1/Le[1],F[2]=1/Le[2],F},yo.normalize=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Oe*Oe+Fe*Fe+je*je;return qe>0&&(qe=1/Math.sqrt(qe)),F[0]=Le[0]*qe,F[1]=Le[1]*qe,F[2]=Le[2]*qe,F},yo.dot=p,yo.cross=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Oe[0],xt=Oe[1],jt=Oe[2];return F[0]=je*jt-qe*xt,F[1]=qe*He-Fe*jt,F[2]=Fe*xt-je*He,F},yo.lerp=function(F,Le,Oe,Fe){var je=Le[0],qe=Le[1],He=Le[2];return F[0]=je+Fe*(Oe[0]-je),F[1]=qe+Fe*(Oe[1]-qe),F[2]=He+Fe*(Oe[2]-He),F},yo.hermite=function(F,Le,Oe,Fe,je,qe){var He=qe*qe,xt=He*(2*qe-3)+1,jt=He*(qe-2)+qe,Gt=He*(qe-1),bi=He*(3-2*qe);return F[0]=Le[0]*xt+Oe[0]*jt+Fe[0]*Gt+je[0]*bi,F[1]=Le[1]*xt+Oe[1]*jt+Fe[1]*Gt+je[1]*bi,F[2]=Le[2]*xt+Oe[2]*jt+Fe[2]*Gt+je[2]*bi,F},yo.bezier=function(F,Le,Oe,Fe,je,qe){var He=1-qe,xt=He*He,jt=qe*qe,Gt=xt*He,bi=3*qe*xt,wi=3*jt*He,qr=jt*qe;return F[0]=Le[0]*Gt+Oe[0]*bi+Fe[0]*wi+je[0]*qr,F[1]=Le[1]*Gt+Oe[1]*bi+Fe[1]*wi+je[1]*qr,F[2]=Le[2]*Gt+Oe[2]*bi+Fe[2]*wi+je[2]*qr,F},yo.random=function(Le,Oe){Oe=Oe||1;var Fe=2*F.RANDOM()*Math.PI,je=2*F.RANDOM()-1,qe=Math.sqrt(1-je*je)*Oe;return Le[0]=Math.cos(Fe)*qe,Le[1]=Math.sin(Fe)*qe,Le[2]=je*Oe,Le},yo.transformMat4=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Oe[3]*Fe+Oe[7]*je+Oe[11]*qe+Oe[15];return F[0]=(Oe[0]*Fe+Oe[4]*je+Oe[8]*qe+Oe[12])/(He=He||1),F[1]=(Oe[1]*Fe+Oe[5]*je+Oe[9]*qe+Oe[13])/He,F[2]=(Oe[2]*Fe+Oe[6]*je+Oe[10]*qe+Oe[14])/He,F},yo.transformMat3=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2];return F[0]=Fe*Oe[0]+je*Oe[3]+qe*Oe[6],F[1]=Fe*Oe[1]+je*Oe[4]+qe*Oe[7],F[2]=Fe*Oe[2]+je*Oe[5]+qe*Oe[8],F},yo.transformQuat=function(F,Le,Oe){var Fe=Oe[0],je=Oe[1],qe=Oe[2],He=Le[0],xt=Le[1],jt=Le[2],Gt=je*jt-qe*xt,bi=qe*He-Fe*jt,wi=Fe*xt-je*He,qr=je*wi-qe*bi,Xn=qe*Gt-Fe*wi,Yn=Fe*bi-je*Gt,yo=2*Oe[3];return bi*=yo,wi*=yo,Xn*=2,Yn*=2,F[0]=He+(Gt*=yo)+(qr*=2),F[1]=xt+bi+Xn,F[2]=jt+wi+Yn,F},yo.rotateX=function(F,Le,Oe,Fe){var je=[],qe=[];return je[0]=Le[0]-Oe[0],je[1]=Le[1]-Oe[1],je[2]=Le[2]-Oe[2],qe[0]=je[0],qe[1]=je[1]*Math.cos(Fe)-je[2]*Math.sin(Fe),qe[2]=je[1]*Math.sin(Fe)+je[2]*Math.cos(Fe),F[0]=qe[0]+Oe[0],F[1]=qe[1]+Oe[1],F[2]=qe[2]+Oe[2],F},yo.rotateY=function(F,Le,Oe,Fe){var je=[],qe=[];return je[0]=Le[0]-Oe[0],je[1]=Le[1]-Oe[1],je[2]=Le[2]-Oe[2],qe[0]=je[2]*Math.sin(Fe)+je[0]*Math.cos(Fe),qe[1]=je[1],qe[2]=je[2]*Math.cos(Fe)-je[0]*Math.sin(Fe),F[0]=qe[0]+Oe[0],F[1]=qe[1]+Oe[1],F[2]=qe[2]+Oe[2],F},yo.rotateZ=function(F,Le,Oe,Fe){var je=[],qe=[];return je[0]=Le[0]-Oe[0],je[1]=Le[1]-Oe[1],je[2]=Le[2]-Oe[2],qe[0]=je[0]*Math.cos(Fe)-je[1]*Math.sin(Fe),qe[1]=je[0]*Math.sin(Fe)+je[1]*Math.cos(Fe),qe[2]=je[2],F[0]=qe[0]+Oe[0],F[1]=qe[1]+Oe[1],F[2]=qe[2]+Oe[2],F},yo.angle=function(F,Le){var Oe=F[0],Fe=F[1],je=F[2],qe=Le[0],He=Le[1],xt=Le[2],jt=Math.sqrt(Oe*Oe+Fe*Fe+je*je)*Math.sqrt(qe*qe+He*He+xt*xt),Gt=jt&&p(F,Le)/jt;return Math.acos(Math.min(Math.max(Gt,-1),1))},yo.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F},yo.str=function(F){return"vec3("+F[0]+", "+F[1]+", "+F[2]+")"},yo.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]&&F[2]===Le[2]},yo.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Oe[0],xt=Oe[1],jt=Oe[2];return Math.abs(Fe-He)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(He))&&Math.abs(je-xt)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(xt))&&Math.abs(qe-jt)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(jt))},yo.forEach=yo.sqrLen=yo.len=yo.sqrDist=yo.dist=yo.div=yo.mul=yo.sub=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=r(void 0);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}(s());function r(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Le})(F)}function n(){var Le=new F.ARRAY_TYPE(3);return F.ARRAY_TYPE!=Float32Array&&(Le[0]=0,Le[1]=0,Le[2]=0),Le}function i(F){return Math.hypot(F[0],F[1],F[2])}function a(F,Le,Oe){return F[0]=Le[0]-Oe[0],F[1]=Le[1]-Oe[1],F[2]=Le[2]-Oe[2],F}function o(F,Le,Oe){return F[0]=Le[0]*Oe[0],F[1]=Le[1]*Oe[1],F[2]=Le[2]*Oe[2],F}function l(F,Le,Oe){return F[0]=Le[0]/Oe[0],F[1]=Le[1]/Oe[1],F[2]=Le[2]/Oe[2],F}function u(F,Le){return Math.hypot(Le[0]-F[0],Le[1]-F[1],Le[2]-F[2])}function c(F,Le){var Oe=Le[0]-F[0],Fe=Le[1]-F[1],je=Le[2]-F[2];return Oe*Oe+Fe*Fe+je*je}function h(F){var Le=F[0],Oe=F[1],Fe=F[2];return Le*Le+Oe*Oe+Fe*Fe}function p(F,Le){return F[0]*Le[0]+F[1]*Le[1]+F[2]*Le[2]}yo.sub=a,yo.mul=o,yo.div=l,yo.dist=u,yo.sqrDist=c,yo.len=i,yo.sqrLen=h;var Le,Oe=(Le=n(),function(F,Oe,Fe,je,qe,He){var xt,jt;for(Oe||(Oe=3),Fe||(Fe=0),jt=je?Math.min(je*Oe+Fe,F.length):F.length,xt=Fe;xt<jt;xt+=Oe)Le[0]=F[xt],Le[1]=F[xt+1],Le[2]=F[xt+2],qe(Le,Le,He),F[xt]=Le[0],F[xt+1]=Le[1],F[xt+2]=Le[2];return F});return yo.forEach=Oe,yo}var bo,Do,Ro={};function I(){if(bo)return Ro;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}bo=1,Object.defineProperty(Ro,"__esModule",{value:!0}),Ro.create=n,Ro.clone=function(Le){var Oe=new F.ARRAY_TYPE(4);return Oe[0]=Le[0],Oe[1]=Le[1],Oe[2]=Le[2],Oe[3]=Le[3],Oe},Ro.fromValues=function(Le,Oe,Fe,je){var qe=new F.ARRAY_TYPE(4);return qe[0]=Le,qe[1]=Oe,qe[2]=Fe,qe[3]=je,qe},Ro.copy=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F},Ro.set=function(F,Le,Oe,Fe,je){return F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=je,F},Ro.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F[2]=Le[2]+Oe[2],F[3]=Le[3]+Oe[3],F},Ro.subtract=i,Ro.multiply=a,Ro.divide=o,Ro.ceil=function(F,Le){return F[0]=Math.ceil(Le[0]),F[1]=Math.ceil(Le[1]),F[2]=Math.ceil(Le[2]),F[3]=Math.ceil(Le[3]),F},Ro.floor=function(F,Le){return F[0]=Math.floor(Le[0]),F[1]=Math.floor(Le[1]),F[2]=Math.floor(Le[2]),F[3]=Math.floor(Le[3]),F},Ro.min=function(F,Le,Oe){return F[0]=Math.min(Le[0],Oe[0]),F[1]=Math.min(Le[1],Oe[1]),F[2]=Math.min(Le[2],Oe[2]),F[3]=Math.min(Le[3],Oe[3]),F},Ro.max=function(F,Le,Oe){return F[0]=Math.max(Le[0],Oe[0]),F[1]=Math.max(Le[1],Oe[1]),F[2]=Math.max(Le[2],Oe[2]),F[3]=Math.max(Le[3],Oe[3]),F},Ro.round=function(F,Le){return F[0]=Math.round(Le[0]),F[1]=Math.round(Le[1]),F[2]=Math.round(Le[2]),F[3]=Math.round(Le[3]),F},Ro.scale=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F[2]=Le[2]*Oe,F[3]=Le[3]*Oe,F},Ro.scaleAndAdd=function(F,Le,Oe,Fe){return F[0]=Le[0]+Oe[0]*Fe,F[1]=Le[1]+Oe[1]*Fe,F[2]=Le[2]+Oe[2]*Fe,F[3]=Le[3]+Oe[3]*Fe,F},Ro.distance=l,Ro.squaredDistance=u,Ro.length=c,Ro.squaredLength=h,Ro.negate=function(F,Le){return F[0]=-Le[0],F[1]=-Le[1],F[2]=-Le[2],F[3]=-Le[3],F},Ro.inverse=function(F,Le){return F[0]=1/Le[0],F[1]=1/Le[1],F[2]=1/Le[2],F[3]=1/Le[3],F},Ro.normalize=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Oe*Oe+Fe*Fe+je*je+qe*qe;return He>0&&(He=1/Math.sqrt(He)),F[0]=Oe*He,F[1]=Fe*He,F[2]=je*He,F[3]=qe*He,F},Ro.dot=function(F,Le){return F[0]*Le[0]+F[1]*Le[1]+F[2]*Le[2]+F[3]*Le[3]},Ro.cross=function(F,Le,Oe,Fe){var je=Oe[0]*Fe[1]-Oe[1]*Fe[0],qe=Oe[0]*Fe[2]-Oe[2]*Fe[0],He=Oe[0]*Fe[3]-Oe[3]*Fe[0],xt=Oe[1]*Fe[2]-Oe[2]*Fe[1],jt=Oe[1]*Fe[3]-Oe[3]*Fe[1],Gt=Oe[2]*Fe[3]-Oe[3]*Fe[2],bi=Le[0],wi=Le[1],qr=Le[2],Xn=Le[3];return F[0]=wi*Gt-qr*jt+Xn*xt,F[1]=-bi*Gt+qr*He-Xn*qe,F[2]=bi*jt-wi*He+Xn*je,F[3]=-bi*xt+wi*qe-qr*je,F},Ro.lerp=function(F,Le,Oe,Fe){var je=Le[0],qe=Le[1],He=Le[2],xt=Le[3];return F[0]=je+Fe*(Oe[0]-je),F[1]=qe+Fe*(Oe[1]-qe),F[2]=He+Fe*(Oe[2]-He),F[3]=xt+Fe*(Oe[3]-xt),F},Ro.random=function(Le,Oe){var Fe,je,qe,He,xt,jt;Oe=Oe||1;do{xt=(Fe=2*F.RANDOM()-1)*Fe+(je=2*F.RANDOM()-1)*je}while(xt>=1);do{jt=(qe=2*F.RANDOM()-1)*qe+(He=2*F.RANDOM()-1)*He}while(jt>=1);var Gt=Math.sqrt((1-xt)/jt);return Le[0]=Oe*Fe,Le[1]=Oe*je,Le[2]=Oe*qe*Gt,Le[3]=Oe*He*Gt,Le},Ro.transformMat4=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3];return F[0]=Oe[0]*Fe+Oe[4]*je+Oe[8]*qe+Oe[12]*He,F[1]=Oe[1]*Fe+Oe[5]*je+Oe[9]*qe+Oe[13]*He,F[2]=Oe[2]*Fe+Oe[6]*je+Oe[10]*qe+Oe[14]*He,F[3]=Oe[3]*Fe+Oe[7]*je+Oe[11]*qe+Oe[15]*He,F},Ro.transformQuat=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Oe[0],xt=Oe[1],jt=Oe[2],Gt=Oe[3],bi=Gt*Fe+xt*qe-jt*je,wi=Gt*je+jt*Fe-He*qe,qr=Gt*qe+He*je-xt*Fe,Xn=-He*Fe-xt*je-jt*qe;return F[0]=bi*Gt+Xn*-He+wi*-jt-qr*-xt,F[1]=wi*Gt+Xn*-xt+qr*-He-bi*-jt,F[2]=qr*Gt+Xn*-jt+bi*-xt-wi*-He,F[3]=Le[3],F},Ro.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=0,F},Ro.str=function(F){return"vec4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},Ro.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]&&F[2]===Le[2]&&F[3]===Le[3]},Ro.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Oe[0],jt=Oe[1],Gt=Oe[2],bi=Oe[3];return Math.abs(Fe-xt)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(xt))&&Math.abs(je-jt)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(jt))&&Math.abs(qe-Gt)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Gt))&&Math.abs(He-bi)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(bi))},Ro.forEach=Ro.sqrLen=Ro.len=Ro.sqrDist=Ro.dist=Ro.div=Ro.mul=Ro.sub=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=r(void 0);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}(s());function r(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Le})(F)}function n(){var Le=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Le[0]=0,Le[1]=0,Le[2]=0,Le[3]=0),Le}function i(F,Le,Oe){return F[0]=Le[0]-Oe[0],F[1]=Le[1]-Oe[1],F[2]=Le[2]-Oe[2],F[3]=Le[3]-Oe[3],F}function a(F,Le,Oe){return F[0]=Le[0]*Oe[0],F[1]=Le[1]*Oe[1],F[2]=Le[2]*Oe[2],F[3]=Le[3]*Oe[3],F}function o(F,Le,Oe){return F[0]=Le[0]/Oe[0],F[1]=Le[1]/Oe[1],F[2]=Le[2]/Oe[2],F[3]=Le[3]/Oe[3],F}function l(F,Le){return Math.hypot(Le[0]-F[0],Le[1]-F[1],Le[2]-F[2],Le[3]-F[3])}function u(F,Le){var Oe=Le[0]-F[0],Fe=Le[1]-F[1],je=Le[2]-F[2],qe=Le[3]-F[3];return Oe*Oe+Fe*Fe+je*je+qe*qe}function c(F){return Math.hypot(F[0],F[1],F[2],F[3])}function h(F){var Le=F[0],Oe=F[1],Fe=F[2],je=F[3];return Le*Le+Oe*Oe+Fe*Fe+je*je}Ro.sub=i,Ro.mul=a,Ro.div=o,Ro.dist=l,Ro.sqrDist=u,Ro.len=c,Ro.sqrLen=h;var Le,Oe=(Le=n(),function(F,Oe,Fe,je,qe,He){var xt,jt;for(Oe||(Oe=4),Fe||(Fe=0),jt=je?Math.min(je*Oe+Fe,F.length):F.length,xt=Fe;xt<jt;xt+=Oe)Le[0]=F[xt],Le[1]=F[xt+1],Le[2]=F[xt+2],Le[3]=F[xt+3],qe(Le,Le,He),F[xt]=Le[0],F[xt+1]=Le[1],F[xt+2]=Le[2],F[xt+3]=Le[3];return F});return Ro.forEach=Oe,Ro}function S(){if(Do)return Yn;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}Do=1,Object.defineProperty(Yn,"__esModule",{value:!0}),Yn.create=l,Yn.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F},Yn.setAxisAngle=u,Yn.getAxisAngle=function(Le,Oe){var Fe=2*Math.acos(Oe[3]),je=Math.sin(Fe/2);return je>F.EPSILON?(Le[0]=Oe[0]/je,Le[1]=Oe[1]/je,Le[2]=Oe[2]/je):(Le[0]=1,Le[1]=0,Le[2]=0),Fe},Yn.getAngle=function(F,Le){var Oe=qe(F,Le);return Math.acos(2*Oe*Oe-1)},Yn.multiply=c,Yn.rotateX=function(F,Le,Oe){Oe*=.5;var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Math.sin(Oe),jt=Math.cos(Oe);return F[0]=Fe*jt+He*xt,F[1]=je*jt+qe*xt,F[2]=qe*jt-je*xt,F[3]=He*jt-Fe*xt,F},Yn.rotateY=function(F,Le,Oe){Oe*=.5;var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Math.sin(Oe),jt=Math.cos(Oe);return F[0]=Fe*jt-qe*xt,F[1]=je*jt+He*xt,F[2]=qe*jt+Fe*xt,F[3]=He*jt-je*xt,F},Yn.rotateZ=function(F,Le,Oe){Oe*=.5;var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Math.sin(Oe),jt=Math.cos(Oe);return F[0]=Fe*jt+je*xt,F[1]=je*jt-Fe*xt,F[2]=qe*jt+He*xt,F[3]=He*jt-qe*xt,F},Yn.calculateW=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2];return F[0]=Oe,F[1]=Fe,F[2]=je,F[3]=Math.sqrt(Math.abs(1-Oe*Oe-Fe*Fe-je*je)),F},Yn.exp=h,Yn.ln=p,Yn.pow=function(F,Le,Oe){return p(F,Le),je(F,F,Oe),h(F,F),F},Yn.slerp=f,Yn.random=function(Le){var Oe=F.RANDOM(),Fe=F.RANDOM(),je=F.RANDOM(),qe=Math.sqrt(1-Oe),He=Math.sqrt(Oe);return Le[0]=qe*Math.sin(2*Math.PI*Fe),Le[1]=qe*Math.cos(2*Math.PI*Fe),Le[2]=He*Math.sin(2*Math.PI*je),Le[3]=He*Math.cos(2*Math.PI*je),Le},Yn.invert=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Oe*Oe+Fe*Fe+je*je+qe*qe,xt=He?1/He:0;return F[0]=-Oe*xt,F[1]=-Fe*xt,F[2]=-je*xt,F[3]=qe*xt,F},Yn.conjugate=function(F,Le){return F[0]=-Le[0],F[1]=-Le[1],F[2]=-Le[2],F[3]=Le[3],F},Yn.fromMat3=m,Yn.fromEuler=function(F,Le,Oe,Fe){var je=.5*Math.PI/180;Le*=je,Oe*=je,Fe*=je;var qe=Math.sin(Le),He=Math.cos(Le),xt=Math.sin(Oe),jt=Math.cos(Oe),Gt=Math.sin(Fe),bi=Math.cos(Fe);return F[0]=qe*jt*bi-He*xt*Gt,F[1]=He*xt*bi+qe*jt*Gt,F[2]=He*jt*Gt-qe*xt*bi,F[3]=He*jt*bi+qe*xt*Gt,F},Yn.str=function(F){return"quat("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},Yn.setAxes=Yn.sqlerp=Yn.rotationTo=Yn.equals=Yn.exactEquals=Yn.normalize=Yn.sqrLen=Yn.squaredLength=Yn.len=Yn.length=Yn.lerp=Yn.dot=Yn.scale=Yn.mul=Yn.add=Yn.set=Yn.copy=Yn.fromValues=Yn.clone=void 0;var F=o(s()),Le=o(d()),Oe=o(_()),Fe=o(I());function a(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(a=function(F){return F?Oe:Le})(F)}function o(F,Le){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Oe=a(Le);if(Oe&&Oe.has(F))return Oe.get(F);var Fe={},je=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var qe in F)if("default"!==qe&&Object.prototype.hasOwnProperty.call(F,qe)){var He=je?Object.getOwnPropertyDescriptor(F,qe):null;He&&(He.get||He.set)?Object.defineProperty(Fe,qe,He):Fe[qe]=F[qe]}return Fe.default=F,Oe&&Oe.set(F,Fe),Fe}function l(){var Le=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(Le[0]=0,Le[1]=0,Le[2]=0),Le[3]=1,Le}function u(F,Le,Oe){Oe*=.5;var Fe=Math.sin(Oe);return F[0]=Fe*Le[0],F[1]=Fe*Le[1],F[2]=Fe*Le[2],F[3]=Math.cos(Oe),F}function c(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Oe[0],jt=Oe[1],Gt=Oe[2],bi=Oe[3];return F[0]=Fe*bi+He*xt+je*Gt-qe*jt,F[1]=je*bi+He*jt+qe*xt-Fe*Gt,F[2]=qe*bi+He*Gt+Fe*jt-je*xt,F[3]=He*bi-Fe*xt-je*jt-qe*Gt,F}function h(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Math.sqrt(Oe*Oe+Fe*Fe+je*je),xt=Math.exp(qe),jt=He>0?xt*Math.sin(He)/He:0;return F[0]=Oe*jt,F[1]=Fe*jt,F[2]=je*jt,F[3]=xt*Math.cos(He),F}function p(F,Le){var Oe=Le[0],Fe=Le[1],je=Le[2],qe=Le[3],He=Math.sqrt(Oe*Oe+Fe*Fe+je*je),xt=He>0?Math.atan2(He,qe)/He:0;return F[0]=Oe*xt,F[1]=Fe*xt,F[2]=je*xt,F[3]=.5*Math.log(Oe*Oe+Fe*Fe+je*je+qe*qe),F}function f(Le,Oe,Fe,je){var qe,He,xt,jt,Gt,bi=Oe[0],wi=Oe[1],qr=Oe[2],Xn=Oe[3],Yn=Fe[0],yo=Fe[1],bo=Fe[2],Do=Fe[3];return(He=bi*Yn+wi*yo+qr*bo+Xn*Do)<0&&(He=-He,Yn=-Yn,yo=-yo,bo=-bo,Do=-Do),1-He>F.EPSILON?(qe=Math.acos(He),xt=Math.sin(qe),jt=Math.sin((1-je)*qe)/xt,Gt=Math.sin(je*qe)/xt):(jt=1-je,Gt=je),Le[0]=jt*bi+Gt*Yn,Le[1]=jt*wi+Gt*yo,Le[2]=jt*qr+Gt*bo,Le[3]=jt*Xn+Gt*Do,Le}function m(F,Le){var Oe,Fe=Le[0]+Le[4]+Le[8];if(Fe>0)Oe=Math.sqrt(Fe+1),F[3]=.5*Oe,F[0]=(Le[5]-Le[7])*(Oe=.5/Oe),F[1]=(Le[6]-Le[2])*Oe,F[2]=(Le[1]-Le[3])*Oe;else{var je=0;Le[4]>Le[0]&&(je=1),Le[8]>Le[3*je+je]&&(je=2);var qe=(je+1)%3,He=(je+2)%3;Oe=Math.sqrt(Le[3*je+je]-Le[3*qe+qe]-Le[3*He+He]+1),F[je]=.5*Oe,F[3]=(Le[3*qe+He]-Le[3*He+qe])*(Oe=.5/Oe),F[qe]=(Le[3*qe+je]+Le[3*je+qe])*Oe,F[He]=(Le[3*He+je]+Le[3*je+He])*Oe}return F}Yn.clone=Fe.clone,Yn.fromValues=Fe.fromValues,Yn.copy=Fe.copy,Yn.set=Fe.set,Yn.add=Fe.add,Yn.mul=c;var je=Fe.scale;Yn.scale=je;var qe=Fe.dot;Yn.dot=qe,Yn.lerp=Fe.lerp;var He=Fe.length;Yn.length=He,Yn.len=He;var xt=Fe.squaredLength;Yn.squaredLength=xt,Yn.sqrLen=xt;var jt=Fe.normalize;Yn.normalize=jt,Yn.exactEquals=Fe.exactEquals,Yn.equals=Fe.equals;var Gt,bi,wi,qr=(Gt=Oe.create(),bi=Oe.fromValues(1,0,0),wi=Oe.fromValues(0,1,0),function(F,Le,Fe){var je=Oe.dot(Le,Fe);return je<-.999999?(Oe.cross(Gt,bi,Le),Oe.len(Gt)<1e-6&&Oe.cross(Gt,wi,Le),Oe.normalize(Gt,Gt),u(F,Gt,Math.PI),F):je>.999999?(F[0]=0,F[1]=0,F[2]=0,F[3]=1,F):(Oe.cross(Gt,Le,Fe),F[0]=Gt[0],F[1]=Gt[1],F[2]=Gt[2],F[3]=1+je,jt(F,F))});Yn.rotationTo=qr;var Xn,yo,bo=(Xn=l(),yo=l(),function(F,Le,Oe,Fe,je,qe){return f(Xn,Le,je,qe),f(yo,Oe,Fe,qe),f(F,Xn,yo,2*qe*(1-qe)),F});Yn.sqlerp=bo;var Ro,zs=(Ro=Le.create(),function(F,Le,Oe,Fe){return Ro[0]=Oe[0],Ro[3]=Oe[1],Ro[6]=Oe[2],Ro[1]=Fe[0],Ro[4]=Fe[1],Ro[7]=Fe[2],Ro[2]=-Le[0],Ro[5]=-Le[1],Ro[8]=-Le[2],jt(F,m(F,Ro))});return Yn.setAxes=zs,Yn}var zs,Zs={};function z(){if(zs)return Zs;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}zs=1,Object.defineProperty(Zs,"__esModule",{value:!0}),Zs.create=function(){var Le=new F.ARRAY_TYPE(8);return F.ARRAY_TYPE!=Float32Array&&(Le[0]=0,Le[1]=0,Le[2]=0,Le[4]=0,Le[5]=0,Le[6]=0,Le[7]=0),Le[3]=1,Le},Zs.clone=function(Le){var Oe=new F.ARRAY_TYPE(8);return Oe[0]=Le[0],Oe[1]=Le[1],Oe[2]=Le[2],Oe[3]=Le[3],Oe[4]=Le[4],Oe[5]=Le[5],Oe[6]=Le[6],Oe[7]=Le[7],Oe},Zs.fromValues=function(Le,Oe,Fe,je,qe,He,xt,jt){var Gt=new F.ARRAY_TYPE(8);return Gt[0]=Le,Gt[1]=Oe,Gt[2]=Fe,Gt[3]=je,Gt[4]=qe,Gt[5]=He,Gt[6]=xt,Gt[7]=jt,Gt},Zs.fromRotationTranslationValues=function(Le,Oe,Fe,je,qe,He,xt){var jt=new F.ARRAY_TYPE(8);jt[0]=Le,jt[1]=Oe,jt[2]=Fe,jt[3]=je;var Gt=.5*qe,bi=.5*He,wi=.5*xt;return jt[4]=Gt*je+bi*Fe-wi*Oe,jt[5]=bi*je+wi*Le-Gt*Fe,jt[6]=wi*je+Gt*Oe-bi*Le,jt[7]=-Gt*Le-bi*Oe-wi*Fe,jt},Zs.fromRotationTranslation=o,Zs.fromTranslation=function(F,Le){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=.5*Le[0],F[5]=.5*Le[1],F[6]=.5*Le[2],F[7]=0,F},Zs.fromRotation=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},Zs.fromMat4=function(Fe,je){var qe=Le.create();Oe.getRotation(qe,je);var He=new F.ARRAY_TYPE(3);return Oe.getTranslation(He,je),o(Fe,qe,He),Fe},Zs.copy=l,Zs.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},Zs.set=function(F,Le,Oe,Fe,je,qe,He,xt,jt){return F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=je,F[4]=qe,F[5]=He,F[6]=xt,F[7]=jt,F},Zs.getDual=function(F,Le){return F[0]=Le[4],F[1]=Le[5],F[2]=Le[6],F[3]=Le[7],F},Zs.setDual=function(F,Le){return F[4]=Le[0],F[5]=Le[1],F[6]=Le[2],F[7]=Le[3],F},Zs.getTranslation=function(F,Le){var Oe=Le[4],Fe=Le[5],je=Le[6],qe=Le[7],He=-Le[0],xt=-Le[1],jt=-Le[2],Gt=Le[3];return F[0]=2*(Oe*Gt+qe*He+Fe*jt-je*xt),F[1]=2*(Fe*Gt+qe*xt+je*He-Oe*jt),F[2]=2*(je*Gt+qe*jt+Oe*xt-Fe*He),F},Zs.translate=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=.5*Oe[0],jt=.5*Oe[1],Gt=.5*Oe[2],bi=Le[4],wi=Le[5],qr=Le[6],Xn=Le[7];return F[0]=Fe,F[1]=je,F[2]=qe,F[3]=He,F[4]=He*xt+je*Gt-qe*jt+bi,F[5]=He*jt+qe*xt-Fe*Gt+wi,F[6]=He*Gt+Fe*jt-je*xt+qr,F[7]=-Fe*xt-je*jt-qe*Gt+Xn,F},Zs.rotateX=function(F,Oe,Fe){var je=-Oe[0],qe=-Oe[1],He=-Oe[2],xt=Oe[3],jt=Oe[4],Gt=Oe[5],bi=Oe[6],wi=Oe[7],qr=jt*xt+wi*je+Gt*He-bi*qe,Xn=Gt*xt+wi*qe+bi*je-jt*He,Yn=bi*xt+wi*He+jt*qe-Gt*je,yo=wi*xt-jt*je-Gt*qe-bi*He;return Le.rotateX(F,Oe,Fe),F[4]=qr*(xt=F[3])+yo*(je=F[0])+Xn*(He=F[2])-Yn*(qe=F[1]),F[5]=Xn*xt+yo*qe+Yn*je-qr*He,F[6]=Yn*xt+yo*He+qr*qe-Xn*je,F[7]=yo*xt-qr*je-Xn*qe-Yn*He,F},Zs.rotateY=function(F,Oe,Fe){var je=-Oe[0],qe=-Oe[1],He=-Oe[2],xt=Oe[3],jt=Oe[4],Gt=Oe[5],bi=Oe[6],wi=Oe[7],qr=jt*xt+wi*je+Gt*He-bi*qe,Xn=Gt*xt+wi*qe+bi*je-jt*He,Yn=bi*xt+wi*He+jt*qe-Gt*je,yo=wi*xt-jt*je-Gt*qe-bi*He;return Le.rotateY(F,Oe,Fe),F[4]=qr*(xt=F[3])+yo*(je=F[0])+Xn*(He=F[2])-Yn*(qe=F[1]),F[5]=Xn*xt+yo*qe+Yn*je-qr*He,F[6]=Yn*xt+yo*He+qr*qe-Xn*je,F[7]=yo*xt-qr*je-Xn*qe-Yn*He,F},Zs.rotateZ=function(F,Oe,Fe){var je=-Oe[0],qe=-Oe[1],He=-Oe[2],xt=Oe[3],jt=Oe[4],Gt=Oe[5],bi=Oe[6],wi=Oe[7],qr=jt*xt+wi*je+Gt*He-bi*qe,Xn=Gt*xt+wi*qe+bi*je-jt*He,Yn=bi*xt+wi*He+jt*qe-Gt*je,yo=wi*xt-jt*je-Gt*qe-bi*He;return Le.rotateZ(F,Oe,Fe),F[4]=qr*(xt=F[3])+yo*(je=F[0])+Xn*(He=F[2])-Yn*(qe=F[1]),F[5]=Xn*xt+yo*qe+Yn*je-qr*He,F[6]=Yn*xt+yo*He+qr*qe-Xn*je,F[7]=yo*xt-qr*je-Xn*qe-Yn*He,F},Zs.rotateByQuatAppend=function(F,Le,Oe){var Fe=Oe[0],je=Oe[1],qe=Oe[2],He=Oe[3],xt=Le[0],jt=Le[1],Gt=Le[2],bi=Le[3];return F[0]=xt*He+bi*Fe+jt*qe-Gt*je,F[1]=jt*He+bi*je+Gt*Fe-xt*qe,F[2]=Gt*He+bi*qe+xt*je-jt*Fe,F[3]=bi*He-xt*Fe-jt*je-Gt*qe,F[4]=(xt=Le[4])*He+(bi=Le[7])*Fe+(jt=Le[5])*qe-(Gt=Le[6])*je,F[5]=jt*He+bi*je+Gt*Fe-xt*qe,F[6]=Gt*He+bi*qe+xt*je-jt*Fe,F[7]=bi*He-xt*Fe-jt*je-Gt*qe,F},Zs.rotateByQuatPrepend=function(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Oe[0],jt=Oe[1],Gt=Oe[2],bi=Oe[3];return F[0]=Fe*bi+He*xt+je*Gt-qe*jt,F[1]=je*bi+He*jt+qe*xt-Fe*Gt,F[2]=qe*bi+He*Gt+Fe*jt-je*xt,F[3]=He*bi-Fe*xt-je*jt-qe*Gt,F[4]=Fe*(bi=Oe[7])+He*(xt=Oe[4])+je*(Gt=Oe[6])-qe*(jt=Oe[5]),F[5]=je*bi+He*jt+qe*xt-Fe*Gt,F[6]=qe*bi+He*Gt+Fe*jt-je*xt,F[7]=He*bi-Fe*xt-je*jt-qe*Gt,F},Zs.rotateAroundAxis=function(Le,Oe,Fe,je){if(Math.abs(je)<F.EPSILON)return l(Le,Oe);var qe=Math.hypot(Fe[0],Fe[1],Fe[2]);je*=.5;var He=Math.sin(je),xt=He*Fe[0]/qe,jt=He*Fe[1]/qe,Gt=He*Fe[2]/qe,bi=Math.cos(je),wi=Oe[0],qr=Oe[1],Xn=Oe[2],Yn=Oe[3];Le[0]=wi*bi+Yn*xt+qr*Gt-Xn*jt,Le[1]=qr*bi+Yn*jt+Xn*xt-wi*Gt,Le[2]=Xn*bi+Yn*Gt+wi*jt-qr*xt,Le[3]=Yn*bi-wi*xt-qr*jt-Xn*Gt;var yo=Oe[4],bo=Oe[5],Do=Oe[6],Ro=Oe[7];return Le[4]=yo*bi+Ro*xt+bo*Gt-Do*jt,Le[5]=bo*bi+Ro*jt+Do*xt-yo*Gt,Le[6]=Do*bi+Ro*Gt+yo*jt-bo*xt,Le[7]=Ro*bi-yo*xt-bo*jt-Do*Gt,Le},Zs.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F[2]=Le[2]+Oe[2],F[3]=Le[3]+Oe[3],F[4]=Le[4]+Oe[4],F[5]=Le[5]+Oe[5],F[6]=Le[6]+Oe[6],F[7]=Le[7]+Oe[7],F},Zs.multiply=u,Zs.scale=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F[2]=Le[2]*Oe,F[3]=Le[3]*Oe,F[4]=Le[4]*Oe,F[5]=Le[5]*Oe,F[6]=Le[6]*Oe,F[7]=Le[7]*Oe,F},Zs.lerp=function(F,Le,Oe,je){var qe=1-je;return Fe(Le,Oe)<0&&(je=-je),F[0]=Le[0]*qe+Oe[0]*je,F[1]=Le[1]*qe+Oe[1]*je,F[2]=Le[2]*qe+Oe[2]*je,F[3]=Le[3]*qe+Oe[3]*je,F[4]=Le[4]*qe+Oe[4]*je,F[5]=Le[5]*qe+Oe[5]*je,F[6]=Le[6]*qe+Oe[6]*je,F[7]=Le[7]*qe+Oe[7]*je,F},Zs.invert=function(F,Le){var Oe=qe(Le);return F[0]=-Le[0]/Oe,F[1]=-Le[1]/Oe,F[2]=-Le[2]/Oe,F[3]=Le[3]/Oe,F[4]=-Le[4]/Oe,F[5]=-Le[5]/Oe,F[6]=-Le[6]/Oe,F[7]=Le[7]/Oe,F},Zs.conjugate=function(F,Le){return F[0]=-Le[0],F[1]=-Le[1],F[2]=-Le[2],F[3]=Le[3],F[4]=-Le[4],F[5]=-Le[5],F[6]=-Le[6],F[7]=Le[7],F},Zs.normalize=function(F,Le){var Oe=qe(Le);if(Oe>0){Oe=Math.sqrt(Oe);var Fe=Le[0]/Oe,je=Le[1]/Oe,He=Le[2]/Oe,xt=Le[3]/Oe,jt=Le[4],Gt=Le[5],bi=Le[6],wi=Le[7],qr=Fe*jt+je*Gt+He*bi+xt*wi;F[0]=Fe,F[1]=je,F[2]=He,F[3]=xt,F[4]=(jt-Fe*qr)/Oe,F[5]=(Gt-je*qr)/Oe,F[6]=(bi-He*qr)/Oe,F[7]=(wi-xt*qr)/Oe}return F},Zs.str=function(F){return"quat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+")"},Zs.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]&&F[2]===Le[2]&&F[3]===Le[3]&&F[4]===Le[4]&&F[5]===Le[5]&&F[6]===Le[6]&&F[7]===Le[7]},Zs.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Le[4],jt=Le[5],Gt=Le[6],bi=Le[7],wi=Oe[0],qr=Oe[1],Xn=Oe[2],Yn=Oe[3],yo=Oe[4],bo=Oe[5],Do=Oe[6],Ro=Oe[7];return Math.abs(Fe-wi)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(wi))&&Math.abs(je-qr)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(qr))&&Math.abs(qe-Xn)<=F.EPSILON*Math.max(1,Math.abs(qe),Math.abs(Xn))&&Math.abs(He-Yn)<=F.EPSILON*Math.max(1,Math.abs(He),Math.abs(Yn))&&Math.abs(xt-yo)<=F.EPSILON*Math.max(1,Math.abs(xt),Math.abs(yo))&&Math.abs(jt-bo)<=F.EPSILON*Math.max(1,Math.abs(jt),Math.abs(bo))&&Math.abs(Gt-Do)<=F.EPSILON*Math.max(1,Math.abs(Gt),Math.abs(Do))&&Math.abs(bi-Ro)<=F.EPSILON*Math.max(1,Math.abs(bi),Math.abs(Ro))},Zs.sqrLen=Zs.squaredLength=Zs.len=Zs.length=Zs.dot=Zs.mul=Zs.setReal=Zs.getReal=void 0;var F=a(s()),Le=a(S()),Oe=a(g());function i(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(i=function(F){return F?Oe:Le})(F)}function a(F,Le){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Oe=i(Le);if(Oe&&Oe.has(F))return Oe.get(F);var Fe={},je=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var qe in F)if("default"!==qe&&Object.prototype.hasOwnProperty.call(F,qe)){var He=je?Object.getOwnPropertyDescriptor(F,qe):null;He&&(He.get||He.set)?Object.defineProperty(Fe,qe,He):Fe[qe]=F[qe]}return Fe.default=F,Oe&&Oe.set(F,Fe),Fe}function o(F,Le,Oe){var Fe=.5*Oe[0],je=.5*Oe[1],qe=.5*Oe[2],He=Le[0],xt=Le[1],jt=Le[2],Gt=Le[3];return F[0]=He,F[1]=xt,F[2]=jt,F[3]=Gt,F[4]=Fe*Gt+je*jt-qe*xt,F[5]=je*Gt+qe*He-Fe*jt,F[6]=qe*Gt+Fe*xt-je*He,F[7]=-Fe*He-je*xt-qe*jt,F}function l(F,Le){return F[0]=Le[0],F[1]=Le[1],F[2]=Le[2],F[3]=Le[3],F[4]=Le[4],F[5]=Le[5],F[6]=Le[6],F[7]=Le[7],F}function u(F,Le,Oe){var Fe=Le[0],je=Le[1],qe=Le[2],He=Le[3],xt=Oe[4],jt=Oe[5],Gt=Oe[6],bi=Oe[7],wi=Le[4],qr=Le[5],Xn=Le[6],Yn=Le[7],yo=Oe[0],bo=Oe[1],Do=Oe[2],Ro=Oe[3];return F[0]=Fe*Ro+He*yo+je*Do-qe*bo,F[1]=je*Ro+He*bo+qe*yo-Fe*Do,F[2]=qe*Ro+He*Do+Fe*bo-je*yo,F[3]=He*Ro-Fe*yo-je*bo-qe*Do,F[4]=Fe*bi+He*xt+je*Gt-qe*jt+wi*Ro+Yn*yo+qr*Do-Xn*bo,F[5]=je*bi+He*jt+qe*xt-Fe*Gt+qr*Ro+Yn*bo+Xn*yo-wi*Do,F[6]=qe*bi+He*Gt+Fe*jt-je*xt+Xn*Ro+Yn*Do+wi*bo-qr*yo,F[7]=He*bi-Fe*xt-je*jt-qe*Gt+Yn*Ro-wi*yo-qr*bo-Xn*Do,F}Zs.getReal=Le.copy,Zs.setReal=Le.copy,Zs.mul=u;var Fe=Le.dot;Zs.dot=Fe;var je=Le.length;Zs.length=je,Zs.len=je;var qe=Le.squaredLength;return Zs.squaredLength=qe,Zs.sqrLen=qe,Zs}var na,el,nl={};function V(){if(na)return nl;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}na=1,Object.defineProperty(nl,"__esModule",{value:!0}),nl.create=n,nl.clone=function(Le){var Oe=new F.ARRAY_TYPE(2);return Oe[0]=Le[0],Oe[1]=Le[1],Oe},nl.fromValues=function(Le,Oe){var Fe=new F.ARRAY_TYPE(2);return Fe[0]=Le,Fe[1]=Oe,Fe},nl.copy=function(F,Le){return F[0]=Le[0],F[1]=Le[1],F},nl.set=function(F,Le,Oe){return F[0]=Le,F[1]=Oe,F},nl.add=function(F,Le,Oe){return F[0]=Le[0]+Oe[0],F[1]=Le[1]+Oe[1],F},nl.subtract=i,nl.multiply=a,nl.divide=o,nl.ceil=function(F,Le){return F[0]=Math.ceil(Le[0]),F[1]=Math.ceil(Le[1]),F},nl.floor=function(F,Le){return F[0]=Math.floor(Le[0]),F[1]=Math.floor(Le[1]),F},nl.min=function(F,Le,Oe){return F[0]=Math.min(Le[0],Oe[0]),F[1]=Math.min(Le[1],Oe[1]),F},nl.max=function(F,Le,Oe){return F[0]=Math.max(Le[0],Oe[0]),F[1]=Math.max(Le[1],Oe[1]),F},nl.round=function(F,Le){return F[0]=Math.round(Le[0]),F[1]=Math.round(Le[1]),F},nl.scale=function(F,Le,Oe){return F[0]=Le[0]*Oe,F[1]=Le[1]*Oe,F},nl.scaleAndAdd=function(F,Le,Oe,Fe){return F[0]=Le[0]+Oe[0]*Fe,F[1]=Le[1]+Oe[1]*Fe,F},nl.distance=l,nl.squaredDistance=u,nl.length=c,nl.squaredLength=h,nl.negate=function(F,Le){return F[0]=-Le[0],F[1]=-Le[1],F},nl.inverse=function(F,Le){return F[0]=1/Le[0],F[1]=1/Le[1],F},nl.normalize=function(F,Le){var Oe=Le[0],Fe=Le[1],je=Oe*Oe+Fe*Fe;return je>0&&(je=1/Math.sqrt(je)),F[0]=Le[0]*je,F[1]=Le[1]*je,F},nl.dot=function(F,Le){return F[0]*Le[0]+F[1]*Le[1]},nl.cross=function(F,Le,Oe){var Fe=Le[0]*Oe[1]-Le[1]*Oe[0];return F[0]=F[1]=0,F[2]=Fe,F},nl.lerp=function(F,Le,Oe,Fe){var je=Le[0],qe=Le[1];return F[0]=je+Fe*(Oe[0]-je),F[1]=qe+Fe*(Oe[1]-qe),F},nl.random=function(Le,Oe){Oe=Oe||1;var Fe=2*F.RANDOM()*Math.PI;return Le[0]=Math.cos(Fe)*Oe,Le[1]=Math.sin(Fe)*Oe,Le},nl.transformMat2=function(F,Le,Oe){var Fe=Le[0],je=Le[1];return F[0]=Oe[0]*Fe+Oe[2]*je,F[1]=Oe[1]*Fe+Oe[3]*je,F},nl.transformMat2d=function(F,Le,Oe){var Fe=Le[0],je=Le[1];return F[0]=Oe[0]*Fe+Oe[2]*je+Oe[4],F[1]=Oe[1]*Fe+Oe[3]*je+Oe[5],F},nl.transformMat3=function(F,Le,Oe){var Fe=Le[0],je=Le[1];return F[0]=Oe[0]*Fe+Oe[3]*je+Oe[6],F[1]=Oe[1]*Fe+Oe[4]*je+Oe[7],F},nl.transformMat4=function(F,Le,Oe){var Fe=Le[0],je=Le[1];return F[0]=Oe[0]*Fe+Oe[4]*je+Oe[12],F[1]=Oe[1]*Fe+Oe[5]*je+Oe[13],F},nl.rotate=function(F,Le,Oe,Fe){var je=Le[0]-Oe[0],qe=Le[1]-Oe[1],He=Math.sin(Fe),xt=Math.cos(Fe);return F[0]=je*xt-qe*He+Oe[0],F[1]=je*He+qe*xt+Oe[1],F},nl.angle=function(F,Le){var Oe=F[0],Fe=F[1],je=Le[0],qe=Le[1],He=Math.sqrt(Oe*Oe+Fe*Fe)*Math.sqrt(je*je+qe*qe);return Math.acos(Math.min(Math.max(He&&(Oe*je+Fe*qe)/He,-1),1))},nl.zero=function(F){return F[0]=0,F[1]=0,F},nl.str=function(F){return"vec2("+F[0]+", "+F[1]+")"},nl.exactEquals=function(F,Le){return F[0]===Le[0]&&F[1]===Le[1]},nl.equals=function(Le,Oe){var Fe=Le[0],je=Le[1],qe=Oe[0],He=Oe[1];return Math.abs(Fe-qe)<=F.EPSILON*Math.max(1,Math.abs(Fe),Math.abs(qe))&&Math.abs(je-He)<=F.EPSILON*Math.max(1,Math.abs(je),Math.abs(He))},nl.forEach=nl.sqrLen=nl.sqrDist=nl.dist=nl.div=nl.mul=nl.sub=nl.len=void 0;var F=function(F){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Le=r(void 0);if(Le&&Le.has(F))return Le.get(F);var Oe={},Fe=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var je in F)if("default"!==je&&Object.prototype.hasOwnProperty.call(F,je)){var qe=Fe?Object.getOwnPropertyDescriptor(F,je):null;qe&&(qe.get||qe.set)?Object.defineProperty(Oe,je,qe):Oe[je]=F[je]}return Oe.default=F,Le&&Le.set(F,Oe),Oe}(s());function r(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(r=function(F){return F?Oe:Le})(F)}function n(){var Le=new F.ARRAY_TYPE(2);return F.ARRAY_TYPE!=Float32Array&&(Le[0]=0,Le[1]=0),Le}function i(F,Le,Oe){return F[0]=Le[0]-Oe[0],F[1]=Le[1]-Oe[1],F}function a(F,Le,Oe){return F[0]=Le[0]*Oe[0],F[1]=Le[1]*Oe[1],F}function o(F,Le,Oe){return F[0]=Le[0]/Oe[0],F[1]=Le[1]/Oe[1],F}function l(F,Le){return Math.hypot(Le[0]-F[0],Le[1]-F[1])}function u(F,Le){var Oe=Le[0]-F[0],Fe=Le[1]-F[1];return Oe*Oe+Fe*Fe}function c(F){return Math.hypot(F[0],F[1])}function h(F){var Le=F[0],Oe=F[1];return Le*Le+Oe*Oe}nl.len=c,nl.sub=i,nl.mul=a,nl.div=o,nl.dist=l,nl.sqrDist=u,nl.sqrLen=h;var Le,Oe=(Le=n(),function(F,Oe,Fe,je,qe,He){var xt,jt;for(Oe||(Oe=2),Fe||(Fe=0),jt=je?Math.min(je*Oe+Fe,F.length):F.length,xt=Fe;xt<jt;xt+=Oe)Le[0]=F[xt],Le[1]=F[xt+1],qe(Le,Le,He),F[xt]=Le[0],F[xt+1]=Le[1];return F});return nl.forEach=Oe,nl}function C(){if(el)return Fe;function t(F){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F},t(F)}el=1,Object.defineProperty(Fe,"__esModule",{value:!0}),Fe.vec4=Fe.vec3=Fe.vec2=Fe.quat2=Fe.quat=Fe.mat4=Fe.mat3=Fe.mat2d=Fe.mat2=Fe.glMatrix=void 0;var F=x(s());Fe.glMatrix=F;var Le=x(l());Fe.mat2=Le;var Oe=x(h());Fe.mat2d=Oe;var je=x(d());Fe.mat3=je;var qe=x(g());Fe.mat4=qe;var He=x(S());Fe.quat=He;var xt=x(z());Fe.quat2=xt;var jt=x(V());Fe.vec2=jt;var Gt=x(_());Fe.vec3=Gt;var bi=x(I());function y(F){if("function"!=typeof WeakMap)return null;var Le=new WeakMap,Oe=new WeakMap;return(y=function(F){return F?Oe:Le})(F)}function x(F,Le){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var Oe=y(Le);if(Oe&&Oe.has(F))return Oe.get(F);var Fe={},je=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var qe in F)if("default"!==qe&&Object.prototype.hasOwnProperty.call(F,qe)){var He=je?Object.getOwnPropertyDescriptor(F,qe):null;He&&(He.get||He.set)?Object.defineProperty(Fe,qe,He):Fe[qe]=F[qe]}return Fe.default=F,Oe&&Oe.set(F,Fe),Fe}return Fe.vec4=bi,Fe}var hl,pl,bl,Tl,kl=C(),ec=function(){if(pl)return hl;function t(Le,Oe,Fe,je){(this||F).cx=3*Le,(this||F).bx=3*(Fe-Le)-(this||F).cx,(this||F).ax=1-(this||F).cx-(this||F).bx,(this||F).cy=3*Oe,(this||F).by=3*(je-Oe)-(this||F).cy,(this||F).ay=1-(this||F).cy-(this||F).by,(this||F).p1x=Le,(this||F).p1y=Oe,(this||F).p2x=Fe,(this||F).p2y=je}return pl=1,hl=t,t.prototype={sampleCurveX:function(Le){return(((this||F).ax*Le+(this||F).bx)*Le+(this||F).cx)*Le},sampleCurveY:function(Le){return(((this||F).ay*Le+(this||F).by)*Le+(this||F).cy)*Le},sampleCurveDerivativeX:function(Le){return(3*(this||F).ax*Le+2*(this||F).bx)*Le+(this||F).cx},solveCurveX:function(F,Le){if(void 0===Le&&(Le=1e-6),F<0)return 0;if(F>1)return 1;for(var Oe=F,Fe=0;Fe<8;Fe++){var je=this.sampleCurveX(Oe)-F;if(Math.abs(je)<Le)return Oe;var qe=this.sampleCurveDerivativeX(Oe);if(Math.abs(qe)<1e-6)break;Oe-=je/qe}var He=0,xt=1;for(Oe=F,Fe=0;Fe<20&&(je=this.sampleCurveX(Oe),!(Math.abs(je-F)<Le));Fe++)F>je?He=Oe:xt=Oe,Oe=.5*(xt-He)+He;return Oe},solve:function(F,Le){return this.sampleCurveY(this.solveCurveX(F,Le))}},hl}(),tc=e(ec);function j(){if(Tl)return bl;function t(Le,Oe){(this||F).x=Le,(this||F).y=Oe}return Tl=1,bl=t,t.prototype={clone:function(){return new t((this||F).x,(this||F).y)},add:function(F){return this.clone()._add(F)},sub:function(F){return this.clone()._sub(F)},multByPoint:function(F){return this.clone()._multByPoint(F)},divByPoint:function(F){return this.clone()._divByPoint(F)},mult:function(F){return this.clone()._mult(F)},div:function(F){return this.clone()._div(F)},rotate:function(F){return this.clone()._rotate(F)},rotateAround:function(F,Le){return this.clone()._rotateAround(F,Le)},matMult:function(F){return this.clone()._matMult(F)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||F).x*(this||F).x+(this||F).y*(this||F).y)},equals:function(Le){return(this||F).x===Le.x&&(this||F).y===Le.y},dist:function(F){return Math.sqrt(this.distSqr(F))},distSqr:function(Le){var Oe=Le.x-(this||F).x,Fe=Le.y-(this||F).y;return Oe*Oe+Fe*Fe},angle:function(){return Math.atan2((this||F).y,(this||F).x)},angleTo:function(Le){return Math.atan2((this||F).y-Le.y,(this||F).x-Le.x)},angleWith:function(F){return this.angleWithSep(F.x,F.y)},angleWithSep:function(Le,Oe){return Math.atan2((this||F).x*Oe-(this||F).y*Le,(this||F).x*Le+(this||F).y*Oe)},_matMult:function(Le){var Oe=Le[2]*(this||F).x+Le[3]*(this||F).y;return(this||F).x=Le[0]*(this||F).x+Le[1]*(this||F).y,(this||F).y=Oe,this||F},_add:function(Le){return(this||F).x+=Le.x,(this||F).y+=Le.y,this||F},_sub:function(Le){return(this||F).x-=Le.x,(this||F).y-=Le.y,this||F},_mult:function(Le){return(this||F).x*=Le,(this||F).y*=Le,this||F},_div:function(Le){return(this||F).x/=Le,(this||F).y/=Le,this||F},_multByPoint:function(Le){return(this||F).x*=Le.x,(this||F).y*=Le.y,this||F},_divByPoint:function(Le){return(this||F).x/=Le.x,(this||F).y/=Le.y,this||F},_unit:function(){return this._div(this.mag()),this||F},_perp:function(){var Le=(this||F).y;return(this||F).y=(this||F).x,(this||F).x=-Le,this||F},_rotate:function(Le){var Oe=Math.cos(Le),Fe=Math.sin(Le),je=Fe*(this||F).x+Oe*(this||F).y;return(this||F).x=Oe*(this||F).x-Fe*(this||F).y,(this||F).y=je,this||F},_rotateAround:function(Le,Oe){var Fe=Math.cos(Le),je=Math.sin(Le),qe=Oe.y+je*((this||F).x-Oe.x)+Fe*((this||F).y-Oe.y);return(this||F).x=Oe.x+Fe*((this||F).x-Oe.x)-je*((this||F).y-Oe.y),(this||F).y=qe,this||F},_round:function(){return(this||F).x=Math.round((this||F).x),(this||F).y=Math.round((this||F).y),this||F}},t.convert=function(F){return F instanceof t?F:Array.isArray(F)?new t(F[0],F[1]):F},bl}var ic=e(j());function $(F,Le){if(Array.isArray(F)){if(!Array.isArray(Le)||F.length!==Le.length)return!1;for(let Oe=0;Oe<F.length;Oe++)if(!$(F[Oe],Le[Oe]))return!1;return!0}if("object"==typeof F&&null!==F&&null!==Le){if("object"!=typeof Le)return!1;if(Object.keys(F).length!==Object.keys(Le).length)return!1;for(const Oe in F)if(!$(F[Oe],Le[Oe]))return!1;return!0}return F===Le}const oc=Math.PI/180,sc=180/Math.PI;function H(F){return F*oc}function X(F){return F*sc}const ac=[[0,0],[1,0],[1,1],[0,1]];function W(F){if(F<=0)return 0;if(F>=1)return 1;const Le=F*F,Oe=Le*F;return 4*(F<.5?Oe:3*(F-Le)+Oe-.75)}function K(F,Le,Oe,Fe){const je=new tc(F,Le,Oe,Fe);return function(F){return je.solve(F)}}const mc=K(.25,.1,.25,1);function Q(F,Le,Oe){return Math.min(Oe,Math.max(Le,F))}function tt(F,Le,Oe){return(Oe=Q((Oe-F)/(Le-F),0,1))*Oe*(3-2*Oe)}function et(F,Le,Oe){const Fe=Oe-Le,je=((F-Le)%Fe+Fe)%Fe+Le;return je===Le?Oe:je}function rt(F,Le,Oe){if(!F.length)return Oe(null,[]);let Fe=F.length;const je=new Array(F.length);let qe=null;F.forEach(((F,He)=>{Le(F,((F,Le)=>{F&&(qe=F),je[He]=Le,0==--Fe&&Oe(qe,je)}))}))}function nt(F,...Le){for(const Oe of Le)for(const Le in Oe)F[Le]=Oe[Le];return F}let gc=1;function st(){return gc++}function at(F){return F<=1?1:Math.pow(2,Math.ceil(Math.log(F)/Math.LN2))}function ot(F,Le){F.forEach((F=>{Le[F]&&(Le[F]=Le[F].bind(Le))}))}function lt(Le,Oe,Fe){const je={};for(const Fe in Le)je[Fe]=Oe.call(this||F,Le[Fe],Fe,Le);return je}function ut(Le,Oe,Fe){const je={};for(const Fe in Le)Oe.call(this||F,Le[Fe],Fe,Le)&&(je[Fe]=Le[Fe]);return je}function ct(F){return Array.isArray(F)?F.map(ct):"object"==typeof F&&F?lt(F,ct):F}const yc={};function pt(F){yc[F]||("undefined"!=typeof console&&console.warn(F),yc[F]=!0)}function ft(F,Le,Oe){return(Oe.y-F.y)*(Le.x-F.x)>(Le.y-F.y)*(Oe.x-F.x)}function dt(F){let Le=0;for(let Oe,Fe,je=0,qe=F.length,He=qe-1;je<qe;He=je++)Oe=F[je],Fe=F[He],Le+=(Fe.x-Oe.x)*(Oe.y+Fe.y);return Le}function mt([F,Le,Oe]){const Fe=H(Le+90),je=H(Oe);return{x:F*Math.cos(Fe)*Math.sin(je),y:F*Math.sin(Fe)*Math.sin(je),z:F*Math.cos(je),azimuthal:Le,polar:Oe}}function yt(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function gt(F){const Le={};if(F.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((F,Oe,Fe,je)=>{const qe=Fe||je;return Le[Oe]=!qe||qe.toLowerCase(),""})),Le["max-age"]){const F=parseInt(Le["max-age"],10);isNaN(F)?delete Le["max-age"]:Le["max-age"]=F}return Le}let xc=null;function vt(F,Le){return[F[4*Le],F[4*Le+1],F[4*Le+2],F[4*Le+3]]}function bt(F,Le,Oe,Fe){for(;Le<Oe;){const je=Le+Oe>>1;F[je]<Fe?Le=je+1:Oe=je}return Le}function _t(F,Le,Oe,Fe){for(;Le<Oe;){const je=Le+Oe>>1;F[je]<=Fe?Le=je+1:Oe=je}return Le}function wt(F){return F>0?1/(1.001-F):1+F}function Mt(F){return F>0?1-1/(1.001-F):-F}const Zc={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!Zc.API_URL)return null;try{const F=new URL(Zc.API_URL);return"api.mapbox.cn"===F.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===F.hostname?"https://events.mapbox.com/events/v2":null}catch(F){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function It(F){return Zc.API_URL_REGEX.test(F)}function St(F){return Zc.API_SPRITE_REGEX.test(F)}let Wc,Kc,Jc,Qc,eh,th;function Vt(){return null==Wc&&(Wc=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),Wc}const rh={now:()=>void 0!==Qc?Qc:performance.now(),setNow(F){Qc=F},restoreNow(){Qc=void 0},frame(F){const Le=requestAnimationFrame(F);return{cancel:()=>cancelAnimationFrame(Le)}},getImageData(F,Le=0){const{width:Oe,height:Fe}=F;eh||(eh=document.createElement("canvas"));const je=eh.getContext("2d",{willReadFrequently:!0});if(!je)throw new Error("failed to create canvas 2d context");return(Oe>eh.width||Fe>eh.height)&&(eh.width=Oe,eh.height=Fe),je.clearRect(-Le,-Le,Oe+2*Le,Fe+2*Le),je.drawImage(F,0,0,Oe,Fe),je.getImageData(-Le,-Le,Oe+2*Le,Fe+2*Le)},resolveURL:F=>(Kc||(Kc=document.createElement("a")),Kc.href=F,Kc.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==Jc&&(Jc=window.matchMedia("(prefers-reduced-motion: reduce)")),Jc.matches)},hasCanvasFingerprintNoise(){if(void 0!==th)return th;if(!Vt())return th=!1,!1;const F=new OffscreenCanvas(85,1),Le=F.getContext("2d",{willReadFrequently:!0});let Oe=0;for(let Fe=0;Fe<F.width;++Fe)Le.fillStyle=`rgba(${Oe++},${Oe++},${Oe++}, 255)`,Le.fillRect(Fe,0,1,1);const Fe=Le.getImageData(0,0,F.width,F.height);Oe=0;for(let F=0;F<Fe.data.length;++F)if(F%4!=3&&Oe++!==Fe.data[F])return th=!0,!0;return th=!1,!1}};function Dt(F,Le){const Oe=F.indexOf("?");if(Oe<0)return`${F}?${new URLSearchParams(Le).toString()}`;const Fe=new URLSearchParams(F.slice(Oe));for(const F in Le)Fe.set(F,Le[F]);return`${F.slice(0,Oe)}?${Fe.toString()}`}function Rt(F,Le={persistentParams:[]}){const Oe=F.indexOf("?");if(Oe<0)return F;const Fe=new URLSearchParams,je=new URLSearchParams(F.slice(Oe));for(const F of Le.persistentParams){const Le=je.get(F);Le&&Fe.set(F,Le)}const qe=Fe.toString();return`${F.slice(0,Oe)}${qe.length>0?`?${qe}`:""}`}const oh="mapbox-tiles";let ah=500,lh=50;const hh=["language","worldview","jobid"];let ph,wh;function qt(){try{return caches}catch(F){}}function $t(){const F=qt();F&&null==ph&&(ph=F.open(oh))}let Th=1/0;const Mh={supported:!1,testSupport:function(F){!Ch&&Ih&&(zh?Jt(F):Ah=F)}};let Ah,Ih,Ch=!1,zh=!1;const Dh="undefined"!=typeof self?self:{};function Jt(F){const Le=F.createTexture();F.bindTexture(F.TEXTURE_2D,Le);try{if(F.texImage2D(F.TEXTURE_2D,0,F.RGBA,F.RGBA,F.UNSIGNED_BYTE,Ih),F.isContextLost())return;Mh.supported=!0}catch(F){}F.deleteTexture(Le),Ch=!0}Dh.document&&(Ih=Dh.document.createElement("img"),Ih.onload=function(){Ah&&Jt(Ah),Ah=null,zh=!0},Ih.onerror=function(){Ch=!0,Ah=null},Ih.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const kh={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(kh);class te extends Error{constructor(F,Le,Oe){401===Le&&It(Oe)&&(F+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(F),this.status=Le,this.url=Oe}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const Bh=yt()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href;const re=function(F,Le){if(!(/^file:/.test(Oe=F.url)||/^file:/.test(Bh())&&!/^\w+:/.test(Oe))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(F,Le){const Oe=new AbortController,Fe=new Request(F.url,{method:F.method||"GET",body:F.body,credentials:F.credentials,headers:F.headers,referrer:Bh(),referrerPolicy:F.referrerPolicy,signal:Oe.signal});let je=!1,qe=!1;const He=(xt=Fe.url).indexOf("sku=")>0&&It(xt);var xt;"json"===F.type&&Fe.headers.set("Accept","application/json");const l=(Oe,je,xt)=>{if(qe)return;if(Oe&&"SecurityError"!==Oe.message&&pt(Oe.toString()),je&&xt)return u(je);const jt=Date.now();fetch(Fe).then((Oe=>{if(Oe.ok){const F=He?Oe.clone():null;return u(Oe,F,jt)}return Le(new te(Oe.statusText,Oe.status,F.url))})).catch((Oe=>{"AbortError"!==Oe.name&&Le(new Error(`${Oe.message} ${F.url}`))}))},u=(Oe,He,xt)=>{("arrayBuffer"===F.type?Oe.arrayBuffer():"json"===F.type?Oe.json():Oe.text()).then((F=>{qe||(He&&xt&&function(F,Le,Oe){if($t(),null==ph)return;const Fe=gt(Le.headers.get("Cache-Control")||"");if(Fe["no-store"])return;const je={status:Le.status,statusText:Le.statusText,headers:new Headers};Le.headers.forEach(((F,Le)=>je.headers.set(Le,F))),Fe["max-age"]&&je.headers.set("Expires",new Date(Oe+1e3*Fe["max-age"]).toUTCString());const qe=je.headers.get("Expires");if(!qe)return;if(new Date(qe).getTime()-Oe<42e4)return;let He=Rt(F.url,{persistentParams:hh});if(206===Le.status){const Le=F.headers.get("Range");if(!Le)return;je.status=200,He=Dt(He,{range:Le})}!function(F,Le){if(void 0===wh)try{new Response(new ReadableStream),wh=!0}catch(F){wh=!1}wh?Le(F.body):F.blob().then(Le)}(Le,(F=>{const Oe=new Response(200!==(Fe=Le.status)&&404!==Fe&&[101,103,204,205,304].includes(Fe)?null:F,je);var Fe;$t(),null!=ph&&ph.then((F=>F.put(He,Oe))).catch((F=>pt(F.message)))}))}(Fe,He,xt),je=!0,Le(null,F,Oe.headers.get("Cache-Control"),Oe.headers.get("Expires")))})).catch((F=>{qe||Le(new Error(F.message))}))};return He?function(F,Le){if($t(),null==ph)return Le(null);ph.then((Oe=>{let Fe=Rt(F.url,{persistentParams:hh});const je=F.headers.get("Range");je&&(Fe=Dt(Fe,{range:je})),Oe.match(Fe).then((F=>{const je=function(F){if(!F)return!1;const Le=new Date(F.headers.get("Expires")||0),Oe=gt(F.headers.get("Cache-Control")||"");return Le>Date.now()&&!Oe["no-cache"]}(F);Oe.delete(Fe),je&&Oe.put(Fe,F.clone()),Le(null,F,je)})).catch(Le)})).catch(Le)}(Fe,l):l(null,null),{cancel:()=>{qe=!0,je||Oe.abort()}}}(F,Le);if(yt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",F,Le,void 0,!0)}var Oe;return function(F,Le){const Oe=new XMLHttpRequest;Oe.open(F.method||"GET",F.url,!0),"arrayBuffer"===F.type&&(Oe.responseType="arraybuffer");for(const Le in F.headers)Oe.setRequestHeader(Le,F.headers[Le]);return"json"===F.type&&(Oe.responseType="text",Oe.setRequestHeader("Accept","application/json")),Oe.withCredentials="include"===F.credentials,Oe.onerror=()=>{Le(new Error(Oe.statusText))},Oe.onload=()=>{if((Oe.status>=200&&Oe.status<300||0===Oe.status)&&null!==Oe.response){let Fe=Oe.response;if("json"===F.type)try{Fe=JSON.parse(Oe.response)}catch(F){return Le(F)}Le(null,Fe,Oe.getResponseHeader("Cache-Control"),Oe.getResponseHeader("Expires"))}else Le(new te(Oe.statusText,Oe.status,F.url))},Oe.send(F.body),{cancel:()=>Oe.abort()}}(F,Le)},ne=function(F,Le){return re(nt(F,{type:"arrayBuffer"}),Le)};function ie(F){const Le=document.createElement("a");return Le.href=F,Le.protocol===location.protocol&&Le.host===location.host}const Vh="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Uh,Qh;Uh=[],Qh=0;const le=function(Le,Oe){if(Mh.supported&&(Le.headers||(Le.headers={}),Le.headers.accept="image/webp,*/*"),Qh>=Zc.MAX_PARALLEL_IMAGE_REQUESTS){const Fe={requestParameters:Le,callback:Oe,cancelled:!1,cancel(){(this||F).cancelled=!0}};return Uh.push(Fe),Fe}Qh++;let Fe=!1;const n=()=>{if(!Fe)for(Fe=!0,Qh--;Uh.length&&Qh<Zc.MAX_PARALLEL_IMAGE_REQUESTS;){const F=Uh.shift(),{requestParameters:Le,callback:Oe,cancelled:Fe}=F;Fe||(F.cancel=le(Le,Oe).cancel)}},je=ne(Le,((F,Le,Fe,je)=>{n(),F?Oe(F):Le&&(self.createImageBitmap?function(F,Le){const Oe=new Blob([new Uint8Array(F)],{type:"image/png"});createImageBitmap(Oe).then((F=>{Le(null,F)})).catch((F=>{Le(new Error(`Could not load image because of ${F.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(Le,((F,Le)=>Oe(F,Le,Fe,je))):function(F,Le){const Oe=new Image;Oe.onload=()=>{Le(null,Oe),URL.revokeObjectURL(Oe.src),Oe.onload=null,requestAnimationFrame((()=>{Oe.src=Vh}))},Oe.onerror=()=>Le(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const Fe=new Blob([new Uint8Array(F)],{type:"image/png"});Oe.src=F.byteLength?URL.createObjectURL(Fe):Vh}(Le,((F,Le)=>Oe(F,Le,Fe,je))))}));return{cancel:()=>{je.cancel(),n()}}};var iu,ru,nu,su={exports:{}},au={exports:{}},hu={exports:{}},du=function(){if(nu)return su.exports;nu=1;var F=(iu||(iu=1,au.exports=function(F,Le){var Oe,Fe,je,qe,He,xt,jt,Gt;for(Fe=F.length-(Oe=3&F.length),je=Le,He=3432918353,xt=461845907,Gt=0;Gt<Fe;)jt=255&F.charCodeAt(Gt)|(255&F.charCodeAt(++Gt))<<8|(255&F.charCodeAt(++Gt))<<16|(255&F.charCodeAt(++Gt))<<24,++Gt,je=27492+(65535&(qe=5*(65535&(je=(je^=jt=(65535&(jt=(jt=(65535&jt)*He+(((jt>>>16)*He&65535)<<16)&4294967295)<<15|jt>>>17))*xt+(((jt>>>16)*xt&65535)<<16)&4294967295)<<13|je>>>19))+((5*(je>>>16)&65535)<<16)&4294967295))+((58964+(qe>>>16)&65535)<<16);switch(jt=0,Oe){case 3:jt^=(255&F.charCodeAt(Gt+2))<<16;case 2:jt^=(255&F.charCodeAt(Gt+1))<<8;case 1:je^=jt=(65535&(jt=(jt=(65535&(jt^=255&F.charCodeAt(Gt)))*He+(((jt>>>16)*He&65535)<<16)&4294967295)<<15|jt>>>17))*xt+(((jt>>>16)*xt&65535)<<16)&4294967295}return je^=F.length,je=2246822507*(65535&(je^=je>>>16))+((2246822507*(je>>>16)&65535)<<16)&4294967295,je=3266489909*(65535&(je^=je>>>13))+((3266489909*(je>>>16)&65535)<<16)&4294967295,(je^=je>>>16)>>>0}),au.exports),Le=(ru||(ru=1,hu.exports=function(F,Le){for(var Oe,Fe=F.length,je=Le^Fe,qe=0;Fe>=4;)Oe=1540483477*(65535&(Oe=255&F.charCodeAt(qe)|(255&F.charCodeAt(++qe))<<8|(255&F.charCodeAt(++qe))<<16|(255&F.charCodeAt(++qe))<<24))+((1540483477*(Oe>>>16)&65535)<<16),je=1540483477*(65535&je)+((1540483477*(je>>>16)&65535)<<16)^(Oe=1540483477*(65535&(Oe^=Oe>>>24))+((1540483477*(Oe>>>16)&65535)<<16)),Fe-=4,++qe;switch(Fe){case 3:je^=(255&F.charCodeAt(qe+2))<<16;case 2:je^=(255&F.charCodeAt(qe+1))<<8;case 1:je=1540483477*(65535&(je^=255&F.charCodeAt(qe)))+((1540483477*(je>>>16)&65535)<<16)}return je=1540483477*(65535&(je^=je>>>13))+((1540483477*(je>>>16)&65535)<<16),(je^=je>>>15)>>>0}),hu.exports);return su.exports=F,su.exports.murmur3=F,su.exports.murmur2=Le,su.exports}(),pu=e(du);class ge{constructor(F,...Le){nt(this,Le[0]||{}),this.type=F}}class xe extends ge{constructor(F,Le={}){super("error",nt({error:F},Le))}}function ve(F,Le,Oe){Oe[F]&&-1!==Oe[F].indexOf(Le)||(Oe[F]=Oe[F]||[],Oe[F].push(Le))}function be(F,Le,Oe){if(Oe&&Oe[F]){const Fe=Oe[F].indexOf(Le);-1!==Fe&&Oe[F].splice(Fe,1)}}class _e{on(F,Le){return this._listeners=this._listeners||{},ve(F,Le,this._listeners),this}off(F,Le){return be(F,Le,this._listeners),be(F,Le,this._oneTimeListeners),this}once(F,Le){return Le?(this._oneTimeListeners=this._oneTimeListeners||{},ve(F,Le,this._oneTimeListeners),this):new Promise((Le=>{this.once(F,Le)}))}fire(F,Le){const Oe="string"==typeof F?new ge(F,Le):F,Fe=Oe.type;if(this.listens(Fe)){Oe.target=this;const F=this._listeners&&this._listeners[Fe]?this._listeners[Fe].slice():[];for(const Le of F)Le.call(this,Oe);const Le=this._oneTimeListeners&&this._oneTimeListeners[Fe]?this._oneTimeListeners[Fe].slice():[];for(const F of Le)be(Fe,F,this._oneTimeListeners),F.call(this,Oe);const je=this._eventedParent;je&&(nt(Oe,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),je.fire(Oe))}else Oe instanceof xe&&console.error(Oe.error);return this}listens(F){return!!(this._listeners&&this._listeners[F]&&this._listeners[F].length>0||this._oneTimeListeners&&this._oneTimeListeners[F]&&this._oneTimeListeners[F].length>0||this._eventedParent&&this._eventedParent.listens(F))}setEventedParent(F,Le){return this._eventedParent=F,this._eventedParentData=Le,this}}class we{constructor(F){"string"==typeof F?this.name=F:(this.name=F.name,this.iconsetId=F.iconsetId)}static from(F){return new we(F)}static toString(F){return F.iconsetId?`${F.name}${F.iconsetId}`:F.name}static parse(F){const[Le,Oe]=F.split("");return new we({name:Le,iconsetId:Oe})}static isEqual(F,Le){return F.name===Le.name&&F.iconsetId===Le.iconsetId}toString(){return we.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var fu,mu={},Su=function(){if(fu)return mu;fu=1;var F={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(F){return(F=Math.round(F))<0?0:F>255?255:F}function r(F){return e("%"===F[F.length-1]?parseFloat(F)/100*255:parseInt(F))}function n(F){return(Le="%"===F[F.length-1]?parseFloat(F)/100:parseFloat(F))<0?0:Le>1?1:Le;var Le}function i(F,Le,Oe){return Oe<0?Oe+=1:Oe>1&&(Oe-=1),6*Oe<1?F+(Le-F)*Oe*6:2*Oe<1?Le:3*Oe<2?F+(Le-F)*(2/3-Oe)*6:F}try{mu.parseCSSColor=function(Le){var Oe,Fe=Le.replace(/ /g,"").toLowerCase();if(Fe in F)return F[Fe].slice();if("#"===Fe[0])return 4===Fe.length?(Oe=parseInt(Fe.substr(1),16))>=0&&Oe<=4095?[(3840&Oe)>>4|(3840&Oe)>>8,240&Oe|(240&Oe)>>4,15&Oe|(15&Oe)<<4,1]:null:7===Fe.length&&(Oe=parseInt(Fe.substr(1),16))>=0&&Oe<=16777215?[(16711680&Oe)>>16,(65280&Oe)>>8,255&Oe,1]:null;var je=Fe.indexOf("("),qe=Fe.indexOf(")");if(-1!==je&&qe+1===Fe.length){var He=Fe.substr(0,je),xt=Fe.substr(je+1,qe-(je+1)).split(","),jt=1;switch(He){case"rgba":if(4!==xt.length)return null;jt=n(xt.pop());case"rgb":return 3!==xt.length?null:[r(xt[0]),r(xt[1]),r(xt[2]),jt];case"hsla":if(4!==xt.length)return null;jt=n(xt.pop());case"hsl":if(3!==xt.length)return null;var Gt=(parseFloat(xt[0])%360+360)%360/360,bi=n(xt[1]),wi=n(xt[2]),qr=wi<=.5?wi*(bi+1):wi+bi-wi*bi,Xn=2*wi-qr;return[e(255*i(Xn,qr,Gt+1/3)),e(255*i(Xn,qr,Gt)),e(255*i(Xn,qr,Gt-1/3)),jt];default:return null}}return null}}catch(F){}return mu}();class Se{constructor(F,Le,Oe,Fe=1){this.r=F,this.g=Le,this.b=Oe,this.a=Fe}static parse(F){if(!F)return;if(F instanceof Se)return F;if("string"!=typeof F)return;const Le=Su.parseCSSColor(F);return Le?new Se(Le[0]/255*Le[3],Le[1]/255*Le[3],Le[2]/255*Le[3],Le[3]):void 0}toStringPremultipliedAlpha(){const[F,Le,Oe,Fe]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(F)},${Math.round(Le)},${Math.round(Oe)},${Fe})`}toString(){const[F,Le,Oe,Fe]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*F)},${Math.round(255*Le)},${Math.round(255*Oe)},${Fe})`}toRenderColor(F){const{r:Le,g:Oe,b:Fe,a:je}=this;return new Pe(F,Le,Oe,Fe,je)}clone(){return new Se(this.r,this.g,this.b,this.a)}}class Pe{constructor(F,Le,Oe,Fe,je){if(F){const qe=F.image.height,He=qe*qe;Le=0===je?0:Le/je*(qe-1),Oe=0===je?0:Oe/je*(qe-1),Fe=0===je?0:Fe/je*(qe-1);const xt=Math.floor(Le),jt=Math.floor(Oe),Gt=Math.floor(Fe),bi=Math.ceil(Le),wi=Math.ceil(Oe),qr=Math.ceil(Fe),Xn=Le-xt,Yn=Oe-jt,yo=Fe-Gt,bo=F.image.data,Do=4*(xt+jt*He+Gt*qe),Ro=4*(xt+jt*He+qr*qe),zs=4*(xt+wi*He+Gt*qe),Zs=4*(xt+wi*He+qr*qe),na=4*(bi+jt*He+Gt*qe),el=4*(bi+jt*He+qr*qe),nl=4*(bi+wi*He+Gt*qe),hl=4*(bi+wi*He+qr*qe);if(Do<0||hl>=bo.length)throw new Error("out of range");this.r=Ee(Ee(Ee(bo[Do],bo[Ro],yo),Ee(bo[zs],bo[Zs],yo),Yn),Ee(Ee(bo[na],bo[el],yo),Ee(bo[nl],bo[hl],yo),Yn),Xn)/255*je,this.g=Ee(Ee(Ee(bo[Do+1],bo[Ro+1],yo),Ee(bo[zs+1],bo[Zs+1],yo),Yn),Ee(Ee(bo[na+1],bo[el+1],yo),Ee(bo[nl+1],bo[hl+1],yo),Yn),Xn)/255*je,this.b=Ee(Ee(Ee(bo[Do+2],bo[Ro+2],yo),Ee(bo[zs+2],bo[Zs+2],yo),Yn),Ee(Ee(bo[na+2],bo[el+2],yo),Ee(bo[nl+2],bo[hl+2],yo),Yn),Xn)/255*je,this.a=je}else this.r=Le,this.g=Oe,this.b=Fe,this.a=je}toArray(){const{r:F,g:Le,b:Oe,a:Fe}=this;return 0===Fe?[0,0,0,0]:[255*F/Fe,255*Le/Fe,255*Oe/Fe,Fe]}toHslaArray(){if(0===this.a)return[0,0,0,0];const{r:F,g:Le,b:Oe,a:Fe}=this,je=Math.min(Math.max(F/Fe,0),1),qe=Math.min(Math.max(Le/Fe,0),1),He=Math.min(Math.max(Oe/Fe,0),1),xt=Math.min(je,qe,He),jt=Math.max(je,qe,He),Gt=(xt+jt)/2;if(xt===jt)return[0,0,100*Gt,Fe];const bi=jt-xt,wi=Gt>.5?bi/(2-jt-xt):bi/(jt+xt);let qr=0;return jt===je?qr=(qe-He)/bi+(qe<He?6:0):jt===qe?qr=(He-je)/bi+2:jt===He&&(qr=(je-qe)/bi+4),qr*=60,[Math.min(Math.max(qr,0),360),Math.min(Math.max(100*wi,0),100),Math.min(Math.max(100*Gt,0),100),Fe]}toArray01(){const{r:F,g:Le,b:Oe,a:Fe}=this;return 0===Fe?[0,0,0,0]:[F/Fe,Le/Fe,Oe/Fe,Fe]}toArray01Scaled(F){const{r:Le,g:Oe,b:Fe,a:je}=this;return 0===je?[0,0,0]:[Le/je*F,Oe/je*F,Fe/je*F]}toArray01PremultipliedAlpha(){const{r:F,g:Le,b:Oe,a:Fe}=this;return[F,Le,Oe,Fe]}toArray01Linear(){const{r:F,g:Le,b:Oe,a:Fe}=this;return 0===Fe?[0,0,0,0]:[Math.pow(F/Fe,2.2),Math.pow(Le/Fe,2.2),Math.pow(Oe/Fe,2.2),Fe]}}function Ee(F,Le,Oe){return F*(1-Oe)+Le*Oe}function ze(F,Le,Oe){return F.map(((F,Fe)=>Ee(F,Le[Fe],Oe)))}function ke(F){return F*F*F*F*F}Se.black=new Se(0,0,0,1),Se.white=new Se(1,1,1,1),Se.transparent=new Se(0,0,0,0),Se.red=new Se(1,0,0,1),Se.blue=new Se(0,0,1,1);var Fu=Object.freeze({__proto__:null,array:ze,color:function(F,Le,Oe){return new Se(Ee(F.r,Le.r,Oe),Ee(F.g,Le.g,Oe),Ee(F.b,Le.b,Oe),Ee(F.a,Le.a,Oe))},easeIn:ke,number:Ee});function Be(F,...Le){for(const Oe of Le)for(const Le in Oe)F[Le]=Oe[Le];return F}class Ve extends Error{constructor(F,Le){super(Le),this.message=Le,this.key=F}}class Ce{constructor(F,Le=[]){this.parent=F,this.bindings={};for(const[F,Oe]of Le)this.bindings[F]=Oe}concat(F){return new Ce(this,F)}get(F){if(this.bindings[F])return this.bindings[F];if(this.parent)return this.parent.get(F);throw new Error(`${F} not found in scope.`)}has(F){return!!this.bindings[F]||!!this.parent&&this.parent.has(F)}}const Hu={kind:"null"},Zu={kind:"number"},Wu={kind:"string"},Xu={kind:"boolean"},hd={kind:"color"},md={kind:"object"},_d={kind:"value"},xd={kind:"collator"},vd={kind:"formatted"},Bd={kind:"resolvedImage"};function Ge(F,Le){return{kind:"array",itemType:F,N:Le}}function Ye(F){if("array"===F.kind){const Le=Ye(F.itemType);return"number"==typeof F.N?`array<${Le}, ${F.N}>`:"value"===F.itemType.kind?"array":`array<${Le}>`}return F.kind}const Vd=[Hu,Zu,Wu,Xu,hd,vd,md,Ge(_d),Bd];function Xe(F,Le){if("error"===Le.kind)return null;if("array"===F.kind){if("array"===Le.kind&&(0===Le.N&&"value"===Le.itemType.kind||!Xe(F.itemType,Le.itemType))&&("number"!=typeof F.N||F.N===Le.N))return null}else{if(F.kind===Le.kind)return null;if("value"===F.kind)for(const F of Vd)if(!Xe(F,Le))return null}return`Expected ${Ye(F)} but found ${Ye(Le)} instead.`}function Ze(F,Le){return Le.some((Le=>Le.kind===F.kind))}function We(F,Le){return Le.some((Le=>"null"===Le?null===F:"array"===Le?Array.isArray(F):"object"===Le?F&&!Array.isArray(F)&&"object"==typeof F:Le===typeof F))}class Ke{constructor(F,Le,Oe){this.sensitivity=F?Le?"variant":"case":Le?"accent":"base",this.locale=Oe,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(F,Le){return this.collator.compare(F,Le)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Je{constructor(F,Le,Oe,Fe,je){this.text=F.normalize?F.normalize():F,this.image=Le,this.scale=Oe,this.fontStack=Fe,this.textColor=je}}class Qe{constructor(F){this.sections=F}static fromString(F){return new Qe([new Je(F,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((F=>0!==F.text.length||!!F.image&&F.image.hasPrimary()))}static factory(F){return F instanceof Qe?F:Qe.fromString(F)}toString(){return 0===this.sections.length?"":this.sections.map((F=>F.text)).join("")}serialize(){const F=["format"];for(const Le of this.sections){if(Le.image){const Oe=Le.image.getPrimary().id.toString();F.push(["image",Oe]);continue}F.push(Le.text);const Oe={};Le.fontStack&&(Oe["text-font"]=["literal",Le.fontStack.split(",")]),Le.scale&&(Oe["font-scale"]=Le.scale),Le.textColor&&(Oe["text-color"]=["rgba"].concat(Le.textColor.toRenderColor(null).toArray())),F.push(Oe)}return F}}class tr{constructor(F,Le={}){if(this.id=we.from(F),this.options=Object.assign({},Le),Le.transform){const{a:F,b:Oe,c:Fe,d:je,e:qe,f:He}=Le.transform;this.options.transform=new DOMMatrix([F,Oe,Fe,je,qe,He])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:F,b:Le,c:Oe,d:Fe,e:je,f:qe}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:F,b:Le,c:Oe,d:Fe,e:je,f:qe}})}static parse(F){let Le,Oe,Fe,je;try{({name:Le,iconsetId:Oe,params:Fe,transform:je}=JSON.parse(F)||{})}catch(F){return null}if(!Le)return null;const{a:qe,b:He,c:xt,d:jt,e:Gt,f:bi}=je||{};return new tr({name:Le,iconsetId:Oe},{params:Fe,transform:new DOMMatrix([qe,He,xt,jt,Gt,bi])})}scaleSelf(F){return this.options.transform.scaleSelf(F),this}}class er{constructor(F,Le,Oe,Fe,je=!1){this.primaryId=we.from(F),this.primaryOptions=Le,Oe&&(this.secondaryId=we.from(Oe)),this.secondaryOptions=Fe,this.available=je}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new tr(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new tr(this.secondaryId,this.secondaryOptions):null}static from(F){return"string"==typeof F?er.build({name:F}):F}static build(F,Le,Oe,Fe){return!F||"object"==typeof F&&!("name"in F)?null:new er(F,Oe,Le,Fe)}}function rr(F,Le,Oe,Fe){return"number"==typeof F&&F>=0&&F<=255&&"number"==typeof Le&&Le>=0&&Le<=255&&"number"==typeof Oe&&Oe>=0&&Oe<=255?void 0===Fe||"number"==typeof Fe&&Fe>=0&&Fe<=1?null:`Invalid rgba value [${[F,Le,Oe,Fe].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof Fe?[F,Le,Oe,Fe]:[F,Le,Oe]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function nr(F){if(null===F)return!0;if("string"==typeof F)return!0;if("boolean"==typeof F)return!0;if("number"==typeof F)return!0;if(F instanceof Se)return!0;if(F instanceof Ke)return!0;if(F instanceof Qe)return!0;if(F instanceof er)return!0;if(Array.isArray(F)){for(const Le of F)if(!nr(Le))return!1;return!0}if("object"==typeof F){for(const Le in F)if(!nr(F[Le]))return!1;return!0}return!1}function ir(F){if(null===F)return Hu;if("string"==typeof F)return Wu;if("boolean"==typeof F)return Xu;if("number"==typeof F)return Zu;if(F instanceof Se)return hd;if(F instanceof Ke)return xd;if(F instanceof Qe)return vd;if(F instanceof er)return Bd;if(Array.isArray(F)){const Le=F.length;let Oe;for(const Le of F){const F=ir(Le);if(Oe){if(Oe===F)continue;Oe=_d;break}Oe=F}return Ge(Oe||_d,Le)}return md}function sr(F){const Le=typeof F;return null===F?"":"string"===Le||"number"===Le||"boolean"===Le?String(F):F instanceof Se?F.toStringPremultipliedAlpha():F instanceof Qe||F instanceof er?F.toString():JSON.stringify(F)}class ar{constructor(F,Le){this.type=F,this.value=Le}static parse(F,Le){if(2!==F.length)return Le.error(`'literal' expression requires exactly one argument, but found ${F.length-1} instead.`);if(!nr(F[1]))return Le.error("invalid value");const Oe=F[1];let Fe=ir(Oe);const je=Le.expectedType;return"array"!==Fe.kind||0!==Fe.N||!je||"array"!==je.kind||"number"==typeof je.N&&0!==je.N||(Fe=je),new ar(Fe,Oe)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Se?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Qe?this.value.serialize():this.value}}class or{constructor(F){this.name="ExpressionEvaluationError",this.message=F}toJSON(){return this.message}}const qd={string:Wu,number:Zu,boolean:Xu,object:md};class ur{constructor(F,Le){this.type=F,this.args=Le}static parse(F,Le){if(F.length<2)return Le.error("Expected at least one argument.");let Oe,Fe=1;const je=F[0];if("array"===je){let je,qe;if(F.length>2){const Oe=F[1];if("string"!=typeof Oe||!(Oe in qd)||"object"===Oe)return Le.error('The item type argument of "array" must be one of string, number, boolean',1);je=qd[Oe],Fe++}else je=_d;if(F.length>3){if(null!==F[2]&&("number"!=typeof F[2]||F[2]<0||F[2]!==Math.floor(F[2])))return Le.error('The length argument to "array" must be a positive integer literal',2);qe=F[2],Fe++}Oe=Ge(je,qe)}else Oe=qd[je];const qe=[];for(;Fe<F.length;Fe++){const Oe=Le.parse(F[Fe],Fe,_d);if(!Oe)return null;qe.push(Oe)}return new ur(Oe,qe)}evaluate(F){for(let Le=0;Le<this.args.length;Le++){const Oe=this.args[Le].evaluate(F);if(!Xe(this.type,ir(Oe)))return Oe;if(Le===this.args.length-1)throw new or(`The expression ${JSON.stringify(this.args[Le].serialize())} evaluated to ${Ye(ir(Oe))} but was expected to be of type ${Ye(this.type)}.`)}return null}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){const F=this.type,Le=[F.kind];if("array"===F.kind){const Oe=F.itemType;if("string"===Oe.kind||"number"===Oe.kind||"boolean"===Oe.kind){Le.push(Oe.kind);const Fe=F.N;("number"==typeof Fe||this.args.length>1)&&Le.push(Fe)}}return Le.concat(this.args.map((F=>F.serialize())))}}class cr{constructor(F){this.type=vd,this.sections=F}static parse(F,Le){if(F.length<2)return Le.error("Expected at least one argument.");const Oe=F[1];if(!Array.isArray(Oe)&&"object"==typeof Oe)return Le.error("First argument must be an image or text section.");const Fe=[];let je=!1;for(let Oe=1;Oe<=F.length-1;++Oe){const qe=F[Oe];if(je&&"object"==typeof qe&&!Array.isArray(qe)){je=!1;let F=null;if(qe["font-scale"]&&(F=Le.parseObjectValue(qe["font-scale"],Oe,"font-scale",Zu),!F))return null;let He=null;if(qe["text-font"]&&(He=Le.parseObjectValue(qe["text-font"],Oe,"text-font",Ge(Wu)),!He))return null;let xt=null;if(qe["text-color"]&&(xt=Le.parseObjectValue(qe["text-color"],Oe,"text-color",hd),!xt))return null;const jt=Fe[Fe.length-1];jt.scale=F,jt.font=He,jt.textColor=xt}else{const qe=Le.parse(F[Oe],Oe,_d);if(!qe)return null;const He=qe.type.kind;if("string"!==He&&"value"!==He&&"null"!==He&&"resolvedImage"!==He)return Le.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");je=!0,Fe.push({content:qe,scale:null,font:null,textColor:null})}}return new cr(Fe)}evaluate(F){return new Qe(this.sections.map((Le=>{const Oe=Le.content.evaluate(F);return ir(Oe)===Bd?new Je("",Oe,null,null,null):new Je(sr(Oe),null,Le.scale?Le.scale.evaluate(F):null,Le.font?Le.font.evaluate(F).join(","):null,Le.textColor?Le.textColor.evaluate(F):null)})))}eachChild(F){for(const Le of this.sections)F(Le.content),Le.scale&&F(Le.scale),Le.font&&F(Le.font),Le.textColor&&F(Le.textColor)}outputDefined(){return!1}serialize(){const F=["format"];for(const Le of this.sections){F.push(Le.content.serialize());const Oe={};Le.scale&&(Oe["font-scale"]=Le.scale.serialize()),Le.font&&(Oe["text-font"]=Le.font.serialize()),Le.textColor&&(Oe["text-color"]=Le.textColor.serialize()),F.push(Oe)}return F}}class hr{constructor(F,Le,Oe,Fe){this._imageWarnHistory={},this.type=Bd,this.namePrimary=F,this.nameSecondary=Le,Oe&&(this.paramsPrimary=Oe.params,this.iconsetIdPrimary=Oe.iconset?Oe.iconset.id:void 0),Fe&&(this.paramsSecondary=Fe.params,this.iconsetIdSecondary=Fe.iconset?Fe.iconset.id:void 0)}static parse(F,Le){if(F.length<2)return Le.error("Expected two or more arguments.");let Oe=1;const Fe=[];function i(){if(Oe<F.length){const je=Le.parse(F[Oe],Oe++,Wu);return je?(Fe.push({image:je,options:{}}),!0):(Le.error(Fe.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function s(){if(Oe<F.length){const qe=F[Oe];if(null===(je=qe)||"object"!=typeof je||Array.isArray(je))return!0;const He=qe.params,xt=qe.iconset,jt=Le.concat(Oe);if(!He&&!xt)return Oe++,!0;if(He){if("object"!=typeof He||He.constructor!==Object)return jt.error('Image options "params" should be an object'),!1;const F={},Le=jt.concat(void 0,"params");for(const Oe in He){if(!Oe)return Le.error("Image parameter name should be non-empty"),!1;const Fe=Le.concat(void 0,Oe).parse(He[Oe],void 0,hd,void 0,{typeAnnotation:"coerce"});if(!Fe)return!1;F[Oe]=Fe}Fe[Fe.length-1].options.params=F}if(xt){if("object"!=typeof xt||xt.constructor!==Object)return jt.error('Image options "iconset" should be an object'),!1;if(!xt.id)return jt.error('Image options "iconset" should have an "id" property'),!1;Fe[Fe.length-1].options.iconset=xt}return Oe++,!0}var je;return!0}for(let F=0;F<2;F++)if(!i()||!s())return;return new hr(Fe[0].image,Fe[1]?Fe[1].image:void 0,Fe[0].options,Fe[1]?Fe[1].options:void 0)}evaluateParams(F,Le){const Oe={};if(Le){for(const Fe in Le)if(Le[Fe])try{Oe[Fe]=Le[Fe].evaluate(F)}catch(F){continue}if(0!==Object.keys(Oe).length)return{params:Oe}}}evaluate(F){const Le={name:this.namePrimary.evaluate(F),iconsetId:this.iconsetIdPrimary},Oe=this.nameSecondary?{name:this.nameSecondary.evaluate(F),iconsetId:this.iconsetIdSecondary}:void 0,Fe=er.build(Le,Oe,this.paramsPrimary?this.evaluateParams(F,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(F,this.paramsSecondary):void 0);if(Fe&&F.availableImages){const Le=Fe.getPrimary().id;if(Fe.available=F.availableImages.some((F=>we.isEqual(F,Le))),Fe.available){const Le=Fe.getSecondary()?Fe.getSecondary().id:null;Le&&(Fe.available=F.availableImages.some((F=>we.isEqual(F,Le))))}}return Fe}eachChild(F){if(F(this.namePrimary),this.paramsPrimary)for(const Le in this.paramsPrimary)this.paramsPrimary[Le]&&F(this.paramsPrimary[Le]);if(this.nameSecondary&&(F(this.nameSecondary),this.paramsSecondary))for(const Le in this.paramsSecondary)this.paramsSecondary[Le]&&F(this.paramsSecondary[Le])}outputDefined(){return!1}serializeOptions(F,Le){const Oe={};if(Le&&(Oe.iconset={id:Le}),F){Oe.params={};for(const Le in F)F[Le]&&(Oe.params[Le]=F[Le].serialize())}return Object.keys(Oe).length>0?Oe:void 0}serialize(){const F=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const Le=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);Le&&F.push(Le)}if(this.nameSecondary&&(F.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const Le=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);Le&&F.push(Le)}return F}}function pr(F){return F instanceof Number?"number":F instanceof String?"string":F instanceof Boolean?"boolean":Array.isArray(F)?"array":null===F?"null":typeof F}const $d={"to-boolean":Xu,"to-color":hd,"to-number":Zu,"to-string":Wu};class dr{constructor(F,Le){this.type=F,this.args=Le}static parse(F,Le){if(F.length<2)return Le.error("Expected at least one argument.");const Oe=F[0],Fe=[];let je=Hu;if("to-array"===Oe){if(!Array.isArray(F[1]))return null;const Oe=F[1].length;if(Le.expectedType){if("array"!==Le.expectedType.kind)return Le.error(`Expected ${Le.expectedType.kind} but found array.`);je=Ge(Le.expectedType.itemType,Oe)}else{if(!(Oe>0&&nr(F[1][0])))return null;je=Ge(ir(F[1][0]),Oe)}for(let qe=0;qe<Oe;qe++){const Oe=F[1][qe];let He;if("array"===pr(Oe))He=Le.parse(Oe,void 0,je.itemType);else{const F=pr(Oe);if(F!==je.itemType.kind)return Le.error(`Expected ${je.itemType.kind} but found ${F}.`);He=Le.registry.literal.parse(["literal",void 0===Oe?null:Oe],Le)}if(!He)return null;Fe.push(He)}}else{if(("to-boolean"===Oe||"to-string"===Oe)&&2!==F.length)return Le.error("Expected one argument.");je=$d[Oe];for(let Oe=1;Oe<F.length;Oe++){const je=Le.parse(F[Oe],Oe,_d);if(!je)return null;Fe.push(je)}}return new dr(je,Fe)}evaluate(F){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(F));if("color"===this.type.kind){let Le,Oe;for(const Fe of this.args){if(Le=Fe.evaluate(F),Oe=null,Le instanceof Se)return Le;if("string"==typeof Le){const Oe=F.parseColor(Le);if(Oe)return Oe}else if(Array.isArray(Le)&&(Oe=Le.length<3||Le.length>4?`Invalid rbga value ${JSON.stringify(Le)}: expected an array containing either three or four numeric values.`:rr(Le[0],Le[1],Le[2],Le[3]),!Oe))return new Se(Le[0]/255,Le[1]/255,Le[2]/255,Le[3])}throw new or(Oe||`Could not parse color from value '${"string"==typeof Le?Le:String(JSON.stringify(Le))}'`)}if("number"===this.type.kind){let Le=null;for(const Oe of this.args){if(Le=Oe.evaluate(F),null===Le)return 0;const Fe=Number(Le);if(!isNaN(Fe))return Fe}throw new or(`Could not convert ${JSON.stringify(Le)} to number.`)}return"formatted"===this.type.kind?Qe.fromString(sr(this.args[0].evaluate(F))):"resolvedImage"===this.type.kind?er.build(sr(this.args[0].evaluate(F))):"array"===this.type.kind?this.args.map((Le=>Le.evaluate(F))):sr(this.args[0].evaluate(F))}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new cr([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new hr(this.args[0]).serialize();const F="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild((Le=>{F.push(Le.serialize())})),F}}const Qd=["Unknown","Point","LineString","Polygon"];class yr{constructor(F,Le){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=F,this.options=Le}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Qd[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(F){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const F=this.featureDistanceData.center,Le=this.featureDistanceData.scale,{x:Oe,y:Fe}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(Oe*Le-F[0])+this.featureDistanceData.bearing[1]*(Fe*Le-F[1])}return 0}parseColor(F){let Le=this._parseColorCache[F];return Le||(Le=this._parseColorCache[F]=Se.parse(F)),Le}getConfig(F){return this.options?this.options.get(F):null}}class gr{constructor(F,Le,Oe,Fe,je){this.name=F,this.type=Le,this._evaluate=Oe,this.args=Fe,this._overloadIndex=je}evaluate(F){if(!this._evaluate){const F=gr.definitions[this.name];this._evaluate=Array.isArray(F)?F[2]:F.overloads[this._overloadIndex][1]}return this._evaluate(F,this.args)}eachChild(F){this.args.forEach(F)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((F=>F.serialize())))}static parse(F,Le){const Oe=F[0],Fe=gr.definitions[Oe];if(!Fe)return Le.error(`Unknown expression "${Oe}". If you wanted a literal array, use ["literal", [...]].`,0);const je=Array.isArray(Fe)?Fe[0]:Fe.type,qe=Array.isArray(Fe)?[[Fe[1],Fe[2]]]:Fe.overloads,He=[];let xt=null,jt=-1;for(const[Fe,Gt]of qe){if(Array.isArray(Fe)&&Fe.length!==F.length-1)continue;He.push(Fe),jt++,xt=new Tp(Le.registry,Le.path,null,Le.scope,void 0,Le._scope,Le.options);const qe=[];let bi=!1;for(let Le=1;Le<F.length;Le++){const Oe=F[Le],je=Array.isArray(Fe)?Fe[Le-1]:Fe.type,He=xt.parse(Oe,1+qe.length,je);if(!He){bi=!0;break}qe.push(He)}if(!bi)if(Array.isArray(Fe)&&Fe.length!==qe.length)xt.error(`Expected ${Fe.length} arguments, but found ${qe.length} instead.`);else{for(let F=0;F<qe.length;F++){const Le=Array.isArray(Fe)?Fe[F]:Fe.type,Oe=qe[F];xt.concat(F+1).checkSubtype(Le,Oe.type)}if(0===xt.errors.length)return new gr(Oe,je,Gt,qe,jt)}}if(1===He.length)Le.errors.push(...xt.errors);else{const Oe=(He.length?He:qe.map((([F])=>F))).map(xr).join(" | "),Fe=[];for(let Oe=1;Oe<F.length;Oe++){const je=Le.parse(F[Oe],1+Fe.length);if(!je)return null;Fe.push(Ye(je.type))}Le.error(`Expected arguments of type ${Oe}, but found (${Fe.join(", ")}) instead.`)}return null}static register(F,Le){gr.definitions=Le;for(const Oe in Le)F[Oe]=gr}}function xr(F){return Array.isArray(F)?`(${F.map(Ye).join(", ")})`:`(${Ye(F.type)}...)`}class vr{constructor(F,Le,Oe){this.type=xd,this.locale=Oe,this.caseSensitive=F,this.diacriticSensitive=Le}static parse(F,Le){if(2!==F.length)return Le.error("Expected one argument.");const Oe=F[1];if("object"!=typeof Oe||Array.isArray(Oe))return Le.error("Collator options argument must be an object.");const Fe=void 0===Oe["case-sensitive"]?Le.parse(!1,1,Xu):Le.parseObjectValue(Oe["case-sensitive"],1,"case-sensitive",Xu);if(!Fe)return null;const je=void 0===Oe["diacritic-sensitive"]?Le.parse(!1,1,Xu):Le.parseObjectValue(Oe["diacritic-sensitive"],1,"diacritic-sensitive",Xu);if(!je)return null;let qe=null;return Oe.locale&&(qe=Le.parseObjectValue(Oe.locale,1,"locale",Wu),!qe)?null:new vr(Fe,je,qe)}evaluate(F){return new Ke(this.caseSensitive.evaluate(F),this.diacriticSensitive.evaluate(F),this.locale?this.locale.evaluate(F):null)}eachChild(F){F(this.caseSensitive),F(this.diacriticSensitive),this.locale&&F(this.locale)}outputDefined(){return!1}serialize(){const F={};return F["case-sensitive"]=this.caseSensitive.serialize(),F["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(F.locale=this.locale.serialize()),["collator",F]}}function br(F,Le,Oe=0,Fe=F.length-1,je=wr){for(;Fe>Oe;){if(Fe-Oe>600){const qe=Fe-Oe+1,He=Le-Oe+1,xt=Math.log(qe),jt=.5*Math.exp(2*xt/3),Gt=.5*Math.sqrt(xt*jt*(qe-jt)/qe)*(He-qe/2<0?-1:1);br(F,Le,Math.max(Oe,Math.floor(Le-He*jt/qe+Gt)),Math.min(Fe,Math.floor(Le+(qe-He)*jt/qe+Gt)),je)}const qe=F[Le];let He=Oe,xt=Fe;for(_r(F,Oe,Le),je(F[Fe],qe)>0&&_r(F,Oe,Fe);He<xt;){for(_r(F,He,xt),He++,xt--;je(F[He],qe)<0;)He++;for(;je(F[xt],qe)>0;)xt--}0===je(F[Oe],qe)?_r(F,Oe,xt):(xt++,_r(F,xt,Fe)),xt<=Le&&(Oe=xt+1),Le<=xt&&(Fe=xt-1)}}function _r(F,Le,Oe){const Fe=F[Le];F[Le]=F[Oe],F[Oe]=Fe}function wr(F,Le){return F<Le?-1:F>Le?1:0}function Mr(F){let Le=0;for(let Oe,Fe,je=0,qe=F.length,He=qe-1;je<qe;He=je++)Oe=F[je],Fe=F[He],Le+=(Fe.x-Oe.x)*(Oe.y+Fe.y);return Le}function Ar(F,Le){F[0]=Math.min(F[0],Le[0]),F[1]=Math.min(F[1],Le[1]),F[2]=Math.max(F[2],Le[0]),F[3]=Math.max(F[3],Le[1])}function Ir(F,Le){return!(F[0]<=Le[0]||F[2]>=Le[2]||F[1]<=Le[1]||F[3]>=Le[3])}function Sr(F,Le,Oe){const Fe=F[0]-Le[0],je=F[1]-Le[1],qe=F[0]-Oe[0],He=F[1]-Oe[1];return Fe*He-qe*je==0&&Fe*qe<=0&&je*He<=0}function Pr(F,Le,Oe=!1){let Fe=!1;for(let xt=0,jt=Le.length;xt<jt;xt++){const jt=Le[xt];for(let Le=0,xt=jt.length,Gt=xt-1;Le<xt;Gt=Le++){const xt=jt[Gt],bi=jt[Le];if(Sr(F,xt,bi))return Oe;(qe=xt)[1]>(je=F)[1]!=(He=bi)[1]>je[1]&&je[0]<(He[0]-qe[0])*(je[1]-qe[1])/(He[1]-qe[1])+qe[0]&&(Fe=!Fe)}}var je,qe,He;return Fe}function Er(F,Le,Oe,Fe){const je=Fe[0]-Oe[0],qe=Fe[1]-Oe[1],He=(F[0]-Oe[0])*qe-je*(F[1]-Oe[1]),xt=(Le[0]-Oe[0])*qe-je*(Le[1]-Oe[1]);return He>0&&xt<0||He<0&&xt>0}function zr(F,Le,Oe,Fe){return 0!=(je=[Fe[0]-Oe[0],Fe[1]-Oe[1]])[0]*(qe=[Le[0]-F[0],Le[1]-F[1]])[1]-je[1]*qe[0]&&!(!Er(F,Le,Oe,Fe)||!Er(Oe,Fe,F,Le));var je,qe}const ep=8192;function Tr(F,Le){const Oe=(180+F[0])/360,Fe=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F[1]*Math.PI/360)))/360,je=Math.pow(2,Le.z);return[Math.round(Oe*je*ep),Math.round(Fe*je*ep)]}function Br(F,Le){for(let Oe=0;Oe<Le.length;Oe++)if(Pr(F,Le[Oe]))return!0;return!1}function Vr(F,Le,Oe){for(const Fe of Oe)for(let Oe=0,je=Fe.length,qe=je-1;Oe<je;qe=Oe++)if(zr(F,Le,Fe[qe],Fe[Oe]))return!0;return!1}function Cr(F,Le){for(let Oe=0;Oe<F.length;++Oe)if(!Pr(F[Oe],Le))return!1;for(let Oe=0;Oe<F.length-1;++Oe)if(Vr(F[Oe],F[Oe+1],Le))return!1;return!0}function Dr(F,Le){for(let Oe=0;Oe<Le.length;Oe++)if(Cr(F,Le[Oe]))return!0;return!1}function Rr(F,Le,Oe){const Fe=[];for(let je=0;je<F.length;je++){const qe=[];for(let Fe=0;Fe<F[je].length;Fe++){const He=Tr(F[je][Fe],Oe);Ar(Le,He),qe.push(He)}Fe.push(qe)}return Fe}function Lr(F,Le,Oe){const Fe=[];for(let je=0;je<F.length;je++){const qe=Rr(F[je],Le,Oe);Fe.push(qe)}return Fe}function Fr(F,Le,Oe,Fe){if(F[0]<Oe[0]||F[0]>Oe[2]){const Le=.5*Fe;let je=F[0]-Oe[0]>Le?-Fe:Oe[0]-F[0]>Le?Fe:0;0===je&&(je=F[0]-Oe[2]>Le?-Fe:Oe[2]-F[0]>Le?Fe:0),F[0]+=je}Ar(Le,F)}function Or(F,Le,Oe,Fe){const je=Math.pow(2,Fe.z)*ep,qe=[Fe.x*ep,Fe.y*ep],He=[];if(!F)return He;for(const Fe of F)for(const F of Fe){const Fe=[F.x+qe[0],F.y+qe[1]];Fr(Fe,Le,Oe,je),He.push(Fe)}return He}function Nr(F,Le,Oe,Fe){const je=Math.pow(2,Fe.z)*ep,qe=[Fe.x*ep,Fe.y*ep],He=[];if(!F)return He;for(const Oe of F){const F=[];for(const Fe of Oe){const Oe=[Fe.x+qe[0],Fe.y+qe[1]];Ar(Le,Oe),F.push(Oe)}He.push(F)}if(Le[2]-Le[0]<=je/2){(xt=Le)[0]=xt[1]=1/0,xt[2]=xt[3]=-1/0;for(const F of He)for(const Fe of F)Fr(Fe,Le,Oe,je)}var xt;return He}class Ur{constructor(F,Le){this.type=Xu,this.geojson=F,this.geometries=Le}static parse(F,Le){if(2!==F.length)return Le.error(`'within' expression requires exactly one argument, but found ${F.length-1} instead.`);if(nr(F[1])){const Le=F[1];if("FeatureCollection"===Le.type)for(let F=0;F<Le.features.length;++F){const Oe=Le.features[F].geometry.type;if("Polygon"===Oe||"MultiPolygon"===Oe)return new Ur(Le,Le.features[F].geometry)}else if("Feature"===Le.type){const F=Le.geometry.type;if("Polygon"===F||"MultiPolygon"===F)return new Ur(Le,Le.geometry)}else if("Polygon"===Le.type||"MultiPolygon"===Le.type)return new Ur(Le,Le)}return Le.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(F){if(null!=F.geometry()&&null!=F.canonicalID()){if("Point"===F.geometryType())return function(F,Le){const Oe=[1/0,1/0,-1/0,-1/0],Fe=[1/0,1/0,-1/0,-1/0],je=F.canonicalID();if(!je)return!1;if("Polygon"===Le.type){const qe=Rr(Le.coordinates,Fe,je),He=Or(F.geometry(),Oe,Fe,je);if(!Ir(Oe,Fe))return!1;for(const F of He)if(!Pr(F,qe))return!1}if("MultiPolygon"===Le.type){const qe=Lr(Le.coordinates,Fe,je),He=Or(F.geometry(),Oe,Fe,je);if(!Ir(Oe,Fe))return!1;for(const F of He)if(!Br(F,qe))return!1}return!0}(F,this.geometries);if("LineString"===F.geometryType())return function(F,Le){const Oe=[1/0,1/0,-1/0,-1/0],Fe=[1/0,1/0,-1/0,-1/0],je=F.canonicalID();if(!je)return!1;if("Polygon"===Le.type){const qe=Rr(Le.coordinates,Fe,je),He=Nr(F.geometry(),Oe,Fe,je);if(!Ir(Oe,Fe))return!1;for(const F of He)if(!Cr(F,qe))return!1}if("MultiPolygon"===Le.type){const qe=Lr(Le.coordinates,Fe,je),He=Nr(F.geometry(),Oe,Fe,je);if(!Ir(Oe,Fe))return!1;for(const F of He)if(!Dr(F,qe))return!1}return!0}(F,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const ip={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},rp=1/298.257223563,np=rp*(2-rp),op=Math.PI/180;class Yr{static fromTile(F,Le,Oe){const Fe=Math.PI*(1-2*(F+.5)/Math.pow(2,Le)),je=Math.atan(.5*(Math.exp(Fe)-Math.exp(-Fe)))/op;return new Yr(je,Oe)}static get units(){return ip}constructor(F,Le){if(void 0===F)throw new Error("No latitude given.");if(Le&&!ip[Le])throw new Error(`Unknown unit ${Le}. Use one of: ${Object.keys(ip).join(", ")}`);const Oe=6378.137*op*(Le?ip[Le]:1),Fe=Math.cos(F*op),je=1/(1-np*(1-Fe*Fe)),qe=Math.sqrt(je);this.kx=Oe*qe*Fe,this.ky=Oe*qe*je*(1-np)}distance(F,Le){const Oe=Zr(F[0]-Le[0])*this.kx,Fe=(F[1]-Le[1])*this.ky;return Math.sqrt(Oe*Oe+Fe*Fe)}bearing(F,Le){const Oe=Zr(Le[0]-F[0])*this.kx;return Math.atan2(Oe,(Le[1]-F[1])*this.ky)/op}destination(F,Le,Oe){const Fe=Oe*op;return this.offset(F,Math.sin(Fe)*Le,Math.cos(Fe)*Le)}offset(F,Le,Oe){return[F[0]+Le/this.kx,F[1]+Oe/this.ky]}lineDistance(F){let Le=0;for(let Oe=0;Oe<F.length-1;Oe++)Le+=this.distance(F[Oe],F[Oe+1]);return Le}area(F){let Le=0;for(let Oe=0;Oe<F.length;Oe++){const Fe=F[Oe];for(let F=0,je=Fe.length,qe=je-1;F<je;qe=F++)Le+=Zr(Fe[F][0]-Fe[qe][0])*(Fe[F][1]+Fe[qe][1])*(Oe?-1:1)}return Math.abs(Le)/2*this.kx*this.ky}along(F,Le){let Oe=0;if(Le<=0)return F[0];for(let Fe=0;Fe<F.length-1;Fe++){const je=F[Fe],qe=F[Fe+1],He=this.distance(je,qe);if(Oe+=He,Oe>Le)return Xr(je,qe,(Le-(Oe-He))/He)}return F[F.length-1]}pointToSegmentDistance(F,Le,Oe){let[Fe,je]=Le,qe=Zr(Oe[0]-Fe)*this.kx,He=(Oe[1]-je)*this.ky;if(0!==qe||0!==He){const Le=(Zr(F[0]-Fe)*this.kx*qe+(F[1]-je)*this.ky*He)/(qe*qe+He*He);Le>1?(Fe=Oe[0],je=Oe[1]):Le>0&&(Fe+=qe/this.kx*Le,je+=He/this.ky*Le)}return qe=Zr(F[0]-Fe)*this.kx,He=(F[1]-je)*this.ky,Math.sqrt(qe*qe+He*He)}pointOnLine(F,Le){let Oe=1/0,Fe=F[0][0],je=F[0][1],qe=0,He=0;for(let xt=0;xt<F.length-1;xt++){let jt=F[xt][0],Gt=F[xt][1],bi=Zr(F[xt+1][0]-jt)*this.kx,wi=(F[xt+1][1]-Gt)*this.ky,qr=0;0===bi&&0===wi||(qr=(Zr(Le[0]-jt)*this.kx*bi+(Le[1]-Gt)*this.ky*wi)/(bi*bi+wi*wi),qr>1?(jt=F[xt+1][0],Gt=F[xt+1][1]):qr>0&&(jt+=bi/this.kx*qr,Gt+=wi/this.ky*qr)),bi=Zr(Le[0]-jt)*this.kx,wi=(Le[1]-Gt)*this.ky;const Xn=bi*bi+wi*wi;Xn<Oe&&(Oe=Xn,Fe=jt,je=Gt,qe=xt,He=qr)}return{point:[Fe,je],index:qe,t:Math.max(0,Math.min(1,He))}}lineSlice(F,Le,Oe){let Fe=this.pointOnLine(Oe,F),je=this.pointOnLine(Oe,Le);if(Fe.index>je.index||Fe.index===je.index&&Fe.t>je.t){const F=Fe;Fe=je,je=F}const qe=[Fe.point],He=Fe.index+1,xt=je.index;!Hr(Oe[He],qe[0])&&He<=xt&&qe.push(Oe[He]);for(let F=He+1;F<=xt;F++)qe.push(Oe[F]);return Hr(Oe[xt],je.point)||qe.push(je.point),qe}lineSliceAlong(F,Le,Oe){let Fe=0;const je=[];for(let qe=0;qe<Oe.length-1;qe++){const He=Oe[qe],xt=Oe[qe+1],jt=this.distance(He,xt);if(Fe+=jt,Fe>F&&0===je.length&&je.push(Xr(He,xt,(F-(Fe-jt))/jt)),Fe>=Le)return je.push(Xr(He,xt,(Le-(Fe-jt))/jt)),je;Fe>F&&je.push(xt)}return je}bufferPoint(F,Le){const Oe=Le/this.ky,Fe=Le/this.kx;return[F[0]-Fe,F[1]-Oe,F[0]+Fe,F[1]+Oe]}bufferBBox(F,Le){const Oe=Le/this.ky,Fe=Le/this.kx;return[F[0]-Fe,F[1]-Oe,F[2]+Fe,F[3]+Oe]}insideBBox(F,Le){return Zr(F[0]-Le[0])>=0&&Zr(F[0]-Le[2])<=0&&F[1]>=Le[1]&&F[1]<=Le[3]}}function Hr(F,Le){return F[0]===Le[0]&&F[1]===Le[1]}function Xr(F,Le,Oe){const Fe=Zr(Le[0]-F[0]);return[F[0]+Fe*Oe,F[1]+(Le[1]-F[1])*Oe]}function Zr(F){for(;F<-180;)F+=360;for(;F>180;)F-=360;return F}class Wr{constructor(F=[],Le=(F,Le)=>F<Le?-1:F>Le?1:0){if(this.data=F,this.length=this.data.length,this.compare=Le,this.length>0)for(let F=(this.length>>1)-1;F>=0;F--)this._down(F)}push(F){this.data.push(F),this._up(this.length++)}pop(){if(0===this.length)return;const F=this.data[0],Le=this.data.pop();return--this.length>0&&(this.data[0]=Le,this._down(0)),F}peek(){return this.data[0]}_up(F){const{data:Le,compare:Oe}=this,Fe=Le[F];for(;F>0;){const je=F-1>>1,qe=Le[je];if(Oe(Fe,qe)>=0)break;Le[F]=qe,F=je}Le[F]=Fe}_down(F){const{data:Le,compare:Oe}=this,Fe=this.length>>1,je=Le[F];for(;F<Fe;){let Fe=1+(F<<1);const qe=Fe+1;if(qe<this.length&&Oe(Le[qe],Le[Fe])<0&&(Fe=qe),Oe(Le[Fe],je)>=0)break;Le[F]=Le[Fe],F=Fe}Le[F]=je}}var sp=8192;function Jr(F,Le){return Le.dist-F.dist}const ap=100,yp=50;function en(F){const Le=[1/0,1/0,-1/0,-1/0];if(Le.length!==F.length)return!1;for(let Oe=0;Oe<Le.length;Oe++)if(Le[Oe]!==F[Oe])return!1;return!0}function rn(F){return F[1]-F[0]+1}function nn(F,Le){const Oe=F[1]>=F[0]&&F[1]<Le;return Oe||console.warn("Distance Expression: Index is out of range"),Oe}function sn(F,Le){if(F[0]>F[1])return[null,null];const Oe=rn(F);if(Le){if(2===Oe)return[F,null];const Le=Math.floor(Oe/2);return[[F[0],F[0]+Le],[F[0]+Le,F[1]]]}{if(1===Oe)return[F,null];const Le=Math.floor(Oe/2)-1;return[[F[0],F[0]+Le],[F[0]+Le+1,F[1]]]}}function an(F,Le){const Oe=[1/0,1/0,-1/0,-1/0];if(!nn(Le,F.length))return Oe;for(let Fe=Le[0];Fe<=Le[1];++Fe)Ar(Oe,F[Fe]);return Oe}function on(F){const Le=[1/0,1/0,-1/0,-1/0];for(let Oe=0;Oe<F.length;++Oe)for(let Fe=0;Fe<F[Oe].length;++Fe)Ar(Le,F[Oe][Fe]);return Le}function ln(F,Le,Oe){if(en(F)||en(Le))return NaN;let Fe=0,je=0;return F[2]<Le[0]&&(Fe=Le[0]-F[2]),F[0]>Le[2]&&(Fe=F[0]-Le[2]),F[1]>Le[3]&&(je=F[1]-Le[3]),F[3]<Le[1]&&(je=Le[1]-F[3]),Oe.distance([0,0],[Fe,je])}function un(F){return 360*F-180}function cn(F){return 360/Math.PI*Math.atan(Math.exp((180-360*F)*Math.PI/180))-90}function hn(F,Le){const Oe=Math.pow(2,Le.z),Fe=(F.y/sp+Le.y)/Oe;return[un((F.x/sp+Le.x)/Oe),cn(Fe)]}function pn(F,Le){const Oe=[];for(let Fe=0;Fe<F.length;++Fe)Oe.push(hn(F[Fe],Le));return Oe}function fn(F,Le,Oe){const Fe=Oe.pointOnLine(Le,F).point;return Oe.distance(F,Fe)}function dn(F,Le,Oe,Fe,je){const qe=Oe.slice(Fe[0],Fe[1]+1);let He=1/0;for(let Oe=Le[0];Oe<=Le[1];++Oe)if(0===(He=Math.min(He,fn(F[Oe],qe,je))))return 0;return He}function mn(F,Le,Oe,Fe,je){const qe=Math.min(je.pointToSegmentDistance(F,Oe,Fe),je.pointToSegmentDistance(Le,Oe,Fe)),He=Math.min(je.pointToSegmentDistance(Oe,F,Le),je.pointToSegmentDistance(Fe,F,Le));return Math.min(qe,He)}function yn(F,Le,Oe,Fe,je){if(!nn(Le,F.length)||!nn(Fe,Oe.length))return NaN;let qe=1/0;for(let He=Le[0];He<Le[1];++He)for(let Le=Fe[0];Le<Fe[1];++Le){if(zr(F[He],F[He+1],Oe[Le],Oe[Le+1]))return 0;qe=Math.min(qe,mn(F[He],F[He+1],Oe[Le],Oe[Le+1],je))}return qe}function gn(F,Le,Oe,Fe,je){if(!nn(Le,F.length)||!nn(Fe,Oe.length))return NaN;let qe=1/0;for(let He=Le[0];He<=Le[1];++He)for(let Le=Fe[0];Le<=Fe[1];++Le)if(0===(qe=Math.min(qe,je.distance(F[He],Oe[Le]))))return qe;return qe}function xn(F,Le,Oe){if(Pr(F,Le,!0))return 0;let Fe=1/0;for(const je of Le){const Le=je.length;if(Le<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(je[0]!==je[Le-1]&&0===(Fe=Math.min(Fe,Oe.pointToSegmentDistance(F,je[Le-1],je[0]))))return Fe;if(0===(Fe=Math.min(Fe,fn(F,je,Oe))))return Fe}return Fe}function vn(F,Le,Oe,Fe){if(!nn(Le,F.length))return NaN;for(let Fe=Le[0];Fe<=Le[1];++Fe)if(Pr(F[Fe],Oe,!0))return 0;let je=1/0;for(let qe=Le[0];qe<Le[1];++qe)for(const Le of Oe)for(let Oe=0,He=Le.length,xt=He-1;Oe<He;xt=Oe++){if(zr(F[qe],F[qe+1],Le[xt],Le[Oe]))return 0;je=Math.min(je,mn(F[qe],F[qe+1],Le[xt],Le[Oe],Fe))}return je}function bn(F,Le){for(const Oe of F)for(let F=0;F<=Oe.length-1;++F)if(Pr(Oe[F],Le,!0))return!0;return!1}function _n(F,Le,Oe,Fe=1/0){const je=on(F),qe=on(Le);if(Fe!==1/0&&ln(je,qe,Oe)>=Fe)return Fe;if(Ir(je,qe)){if(bn(F,Le))return 0}else if(bn(Le,F))return 0;let He=Fe;for(const Fe of F)for(let F=0,je=Fe.length,qe=je-1;F<je;qe=F++)for(const je of Le)for(let Le=0,xt=je.length,jt=xt-1;Le<xt;jt=Le++){if(zr(Fe[qe],Fe[F],je[jt],je[Le]))return 0;He=Math.min(He,mn(Fe[qe],Fe[F],je[jt],je[Le],Oe))}return He}function wn(F,Le,Oe,Fe,je,qe,He){if(null===qe||null===He)return;const xt=ln(an(Fe,qe),an(je,He),Oe);xt<Le&&F.push({dist:xt,range1:qe,range2:He})}function Mn(F,Le,Oe,Fe,je=1/0){let qe=Math.min(Fe.distance(F[0],Oe[0][0]),je);if(0===qe)return qe;const He=new Wr([{dist:0,range1:[0,F.length-1],range2:[0,0]}],Jr),xt=Le?yp:ap,jt=on(Oe);for(;He.length;){const je=He.pop();if(je.dist>=qe)continue;const Gt=je.range1;if(rn(Gt)<=xt){if(!nn(Gt,F.length))return NaN;if(Le){const Le=vn(F,Gt,Oe,Fe);if(0===(qe=Math.min(qe,Le)))return qe}else for(let Le=Gt[0];Le<=Gt[1];++Le){const je=xn(F[Le],Oe,Fe);if(0===(qe=Math.min(qe,je)))return qe}}else{const Oe=sn(Gt,Le);if(null!==Oe[0]){const Le=ln(an(F,Oe[0]),jt,Fe);Le<qe&&He.push({dist:Le,range1:Oe[0],range2:[0,0]})}if(null!==Oe[1]){const Le=ln(an(F,Oe[1]),jt,Fe);Le<qe&&He.push({dist:Le,range1:Oe[1],range2:[0,0]})}}}return qe}function An(F,Le,Oe,Fe,je,qe=1/0){let He=Math.min(qe,je.distance(F[0],Oe[0]));if(0===He)return He;const xt=new Wr([{dist:0,range1:[0,F.length-1],range2:[0,Oe.length-1]}],Jr),jt=Le?yp:ap,Gt=Fe?yp:ap;for(;xt.length;){const qe=xt.pop();if(qe.dist>=He)continue;const bi=qe.range1,wi=qe.range2;if(rn(bi)<=jt&&rn(wi)<=Gt){if(!nn(bi,F.length)||!nn(wi,Oe.length))return NaN;if(Le&&Fe?He=Math.min(He,yn(F,bi,Oe,wi,je)):Le||Fe?Le&&!Fe?He=Math.min(He,dn(Oe,wi,F,bi,je)):!Le&&Fe&&(He=Math.min(He,dn(F,bi,Oe,wi,je))):He=Math.min(He,gn(F,bi,Oe,wi,je)),0===He)return He}else{const qe=sn(bi,Le),jt=sn(wi,Fe);wn(xt,He,je,F,Oe,qe[0],jt[0]),wn(xt,He,je,F,Oe,qe[0],jt[1]),wn(xt,He,je,F,Oe,qe[1],jt[0]),wn(xt,He,je,F,Oe,qe[1],jt[1])}}return He}function In(F,Le,Oe,Fe,je=1/0){let qe=je;const He=an(F,[0,F.length-1]);for(const je of Oe)if(!(qe!==1/0&&ln(He,an(je,[0,je.length-1]),Fe)>=qe)&&(qe=Math.min(qe,An(F,Le,je,!0,Fe,qe)),0===qe))return qe;return qe}function Sn(F,Le,Oe,Fe,je=1/0){let qe=je;const He=an(F,[0,F.length-1]);for(const je of Oe){if(qe!==1/0&&ln(He,on(je),Fe)>=qe)continue;const Oe=Mn(F,Le,je,Fe,qe);if(isNaN(Oe))return Oe;if(0===(qe=Math.min(qe,Oe)))return qe}return qe}function Pn(F){return"Point"===F||"MultiPoint"===F||"LineString"===F||"MultiLineString"===F||"Polygon"===F||"MultiPolygon"===F}class En{constructor(F,Le){this.type=Zu,this.geojson=F,this.geometries=Le}static parse(F,Le){if(2!==F.length)return Le.error(`'distance' expression requires either one argument, but found ' ${F.length-1} instead.`);if(nr(F[1])){const Le=F[1];if("FeatureCollection"===Le.type){for(let F=0;F<Le.features.length;++F)if(Pn(Le.features[F].geometry.type))return new En(Le,Le.features[F].geometry)}else if("Feature"===Le.type){if(Pn(Le.geometry.type))return new En(Le,Le.geometry)}else if(Pn(Le.type))return new En(Le,Le)}return Le.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(F){const Le=F.geometry(),Oe=F.canonicalID();if(null!=Le&&null!=Oe){if("Point"===F.geometryType())return function(F,Le,Oe){const Fe=[];for(const Oe of F)for(const F of Oe)Fe.push(hn(F,Le));const je=new Yr(Fe[0][1],"meters");return"Point"===Oe.type||"MultiPoint"===Oe.type||"LineString"===Oe.type?An(Fe,!1,"Point"===Oe.type?[Oe.coordinates]:Oe.coordinates,"LineString"===Oe.type,je):"MultiLineString"===Oe.type?In(Fe,!1,Oe.coordinates,je):"Polygon"===Oe.type||"MultiPolygon"===Oe.type?Sn(Fe,!1,"Polygon"===Oe.type?[Oe.coordinates]:Oe.coordinates,je):null}(Le,Oe,this.geometries);if("LineString"===F.geometryType())return function(F,Le,Oe){const Fe=[];for(const Oe of F){const F=[];for(const Fe of Oe)F.push(hn(Fe,Le));Fe.push(F)}const je=new Yr(Fe[0][0][1],"meters");if("Point"===Oe.type||"MultiPoint"===Oe.type||"LineString"===Oe.type)return In("Point"===Oe.type?[Oe.coordinates]:Oe.coordinates,"LineString"===Oe.type,Fe,je);if("MultiLineString"===Oe.type){let F=1/0;for(let Le=0;Le<Oe.coordinates.length;Le++){const qe=In(Oe.coordinates[Le],!0,Fe,je,F);if(isNaN(qe))return qe;if(0===(F=Math.min(F,qe)))return F}return F}if("Polygon"===Oe.type||"MultiPolygon"===Oe.type){let F=1/0;for(let Le=0;Le<Fe.length;Le++){const qe=Sn(Fe[Le],!0,"Polygon"===Oe.type?[Oe.coordinates]:Oe.coordinates,je,F);if(isNaN(qe))return qe;if(0===(F=Math.min(F,qe)))return F}return F}return null}(Le,Oe,this.geometries);if("Polygon"===F.geometryType())return function(F,Le,Oe){const Fe=[];for(const Oe of function(F){const Le=F.length;if(Le<=1)return[F];const Oe=[];let Fe,je;for(let qe=0;qe<Le;qe++){const Le=Mr(F[qe]);0!==Le&&(F[qe].area=Math.abs(Le),void 0===je&&(je=Le<0),je===Le<0?(Fe&&Oe.push(Fe),Fe=[F[qe]]):Fe.push(F[qe]))}return Fe&&Oe.push(Fe),Oe}(F)){const F=[];for(let Fe=0;Fe<Oe.length;++Fe)F.push(pn(Oe[Fe],Le));Fe.push(F)}const je=new Yr(Fe[0][0][0][1],"meters");if("Point"===Oe.type||"MultiPoint"===Oe.type||"LineString"===Oe.type)return Sn("Point"===Oe.type?[Oe.coordinates]:Oe.coordinates,"LineString"===Oe.type,Fe,je);if("MultiLineString"===Oe.type){let F=1/0;for(let Le=0;Le<Oe.coordinates.length;Le++){const qe=Sn(Oe.coordinates[Le],!0,Fe,je,F);if(isNaN(qe))return qe;if(0===(F=Math.min(F,qe)))return F}return F}return"Polygon"===Oe.type||"MultiPolygon"===Oe.type?function(F,Le,Oe){let Fe=1/0;for(const je of F)for(const F of Le){const Le=_n(je,F,Oe,Fe);if(isNaN(Le))return Le;if(0===(Fe=Math.min(Fe,Le)))return Fe}return Fe}("Polygon"===Oe.type?[Oe.coordinates]:Oe.coordinates,Fe,je):null}(Le,Oe,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function zn(F,Le){switch(F){case"string":return sr(Le);case"number":return+Le;case"boolean":return!!Le;case"color":return Se.parse(Le);case"formatted":return Qe.fromString(sr(Le));case"resolvedImage":return er.build(sr(Le))}return Le}function kn(F,Le,Oe,Fe){return void 0!==Fe&&(F=Fe*Math.round(F/Fe)),void 0!==Le&&F<Le&&(F=Le),void 0!==Oe&&F>Oe&&(F=Oe),F}class Tn{constructor(F,Le,Oe){this.type=F,this.key=Le,this.scope=Oe}static parse(F,Le){let Oe=Le.expectedType;if(null==Oe&&(Oe=_d),F.length<2||F.length>3)return Le.error("Invalid number of arguments for 'config' expression.");const Fe=Le.parse(F[1],1);if(!(Fe instanceof ar))return Le.error("Key name of 'config' expression must be a string literal.");if(F.length>=3){const je=Le.parse(F[2],2);return je instanceof ar?new Tn(Oe,sr(Fe.value),sr(je.value)):Le.error("Scope of 'config' expression must be a string literal.")}return new Tn(Oe,sr(Fe.value))}evaluate(F){const Le=[this.key,this.scope,F.scope].filter(Boolean).join(""),Oe=F.getConfig(Le);if(!Oe)return null;const{type:Fe,value:je,values:qe,minValue:He,maxValue:xt,stepValue:jt}=Oe,Gt=Oe.default.evaluate(F);let bi=Gt;if(je){const Le=F.scope;F.scope=(Le||"").split("").slice(1).join(""),bi=je.evaluate(F),F.scope=Le}return Fe&&(bi=zn(Fe,bi)),void 0===bi||void 0===He&&void 0===xt&&void 0===jt||("number"==typeof bi?bi=kn(bi,He,xt,jt):Array.isArray(bi)&&(bi=bi.map((F=>"number"==typeof F?kn(F,He,xt,jt):F)))),void 0!==je&&void 0!==bi&&qe&&!qe.includes(bi)&&(bi=Gt,Fe&&(bi=zn(Fe,bi))),(Fe&&Fe!==this.type||void 0!==bi&&ir(bi)!==this.type)&&(bi=zn(this.type.kind,bi)),bi}eachChild(){}outputDefined(){return!1}serialize(){const F=["config",this.key];return this.scope&&F.concat(this.key),F}}function Bn(F){if(F instanceof gr){if("get"===F.name&&1===F.args.length)return!1;if("feature-state"===F.name)return!1;if("has"===F.name&&1===F.args.length)return!1;if("properties"===F.name||"geometry-type"===F.name||"id"===F.name)return!1;if(/^filter-/.test(F.name))return!1}if(F instanceof Ur)return!1;if(F instanceof En)return!1;let Le=!0;return F.eachChild((F=>{Le&&!Bn(F)&&(Le=!1)})),Le}function Vn(F){if(F instanceof gr&&"feature-state"===F.name)return!1;let Le=!0;return F.eachChild((F=>{Le&&!Vn(F)&&(Le=!1)})),Le}function Cn(F){if(F instanceof Tn)return new Set([F.key]);let Le=new Set;return F.eachChild((F=>{Le=new Set([...Le,...Cn(F)])})),Le}function Dn(F,Le){if(F instanceof gr&&Le.indexOf(F.name)>=0)return!1;let Oe=!0;return F.eachChild((F=>{Oe&&!Dn(F,Le)&&(Oe=!1)})),Oe}class Rn{constructor(F,Le){this.type=Le.type,this.name=F,this.boundExpression=Le}static parse(F,Le){if(2!==F.length||"string"!=typeof F[1])return Le.error("'var' expression requires exactly one string literal argument.");const Oe=F[1];return Le.scope.has(Oe)?new Rn(Oe,Le.scope.get(Oe)):Le.error(`Unknown variable "${Oe}". Make sure "${Oe}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(F){return this.boundExpression.evaluate(F)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ln{constructor(F,Le=[],Oe,Fe=new Ce,je=[],qe,He){this.registry=F,this.path=Le,this.key=Le.map((F=>"string"==typeof F?`['${F}']`:`[${F}]`)).join(""),this.scope=Fe,this.errors=je,this.expectedType=Oe,this._scope=qe,this.options=He}parse(F,Le,Oe,Fe,je={}){return Le||Oe?this.concat(Le,null,Oe,Fe)._parse(F,je):this._parse(F,je)}parseObjectValue(F,Le,Oe,Fe,je,qe={}){return this.concat(Le,Oe,Fe,je)._parse(F,qe)}_parse(F,Le){function r(F,Le,Oe){return"assert"===Oe?new ur(Le,[F]):"coerce"===Oe?new dr(Le,[F]):F}if(null!==F&&"string"!=typeof F&&"boolean"!=typeof F&&"number"!=typeof F||(F=["literal",F]),Array.isArray(F)){if(0===F.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const Oe="string"==typeof F[0]?this.registry[F[0]]:void 0;if(Oe){let Fe=Oe.parse(F,this);if(!Fe)return null;if(this.expectedType){const F=this.expectedType,Oe=Fe.type;if("string"!==F.kind&&"number"!==F.kind&&"boolean"!==F.kind&&"object"!==F.kind&&"array"!==F.kind||"value"!==Oe.kind)if("color"!==F.kind&&"formatted"!==F.kind&&"resolvedImage"!==F.kind||"value"!==Oe.kind&&"string"!==Oe.kind){if(this.checkSubtype(F,Oe))return null}else Fe=r(Fe,F,Le.typeAnnotation||"coerce");else Fe=r(Fe,F,Le.typeAnnotation||"assert")}if(!(Fe instanceof ar)&&"resolvedImage"!==Fe.type.kind&&On(Fe)){const Le=new yr(this._scope,this.options);try{Fe=new ar(Fe.type,Fe.evaluate(Le))}catch(F){return this.error(F.message),null}}return Fe}return dr.parse(["to-array",F],this)}return this.error(void 0===F?"'undefined' value invalid. Use null instead.":"object"==typeof F?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof F} instead.`)}concat(F,Le,Oe,Fe){let je="number"==typeof F?this.path.concat(F):this.path;je="string"==typeof Le?je.concat(Le):je;const qe=Fe?this.scope.concat(Fe):this.scope;return new Ln(this.registry,je,Oe||null,qe,this.errors,this._scope,this.options)}error(F,...Le){const Oe=`${this.key}${Le.map((F=>`[${F}]`)).join("")}`;this.errors.push(new Ve(Oe,F))}checkSubtype(F,Le){const Oe=Xe(F,Le);return Oe&&this.error(Oe),Oe}}var Tp=Ln;function On(F){if(F instanceof Rn)return On(F.boundExpression);if(F instanceof gr&&"error"===F.name)return!1;if(F instanceof vr)return!1;if(F instanceof Ur)return!1;if(F instanceof En)return!1;if(F instanceof Tn)return!1;const Le=F instanceof dr||F instanceof ur;let Oe=!0;return F.eachChild((F=>{Oe=Le?Oe&&On(F):Oe&&F instanceof ar})),!!Oe&&Bn(F)&&Dn(F,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Nn(F,Le){const Oe=F.length-1;let Fe,je,qe=0,He=Oe,xt=0;for(;qe<=He;)if(xt=Math.floor((qe+He)/2),Fe=F[xt],je=F[xt+1],Fe<=Le){if(xt===Oe||Le<je)return xt;qe=xt+1}else{if(!(Fe>Le))throw new or("Input is not a number.");He=xt-1}return 0}class Un{constructor(F,Le,Oe){this.type=F,this.input=Le,this.labels=[],this.outputs=[];for(const[F,Le]of Oe)this.labels.push(F),this.outputs.push(Le)}static parse(F,Le){if(F.length-1<4)return Le.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if((F.length-1)%2!=0)return Le.error("Expected an even number of arguments.");const Oe=Le.parse(F[1],1,Zu);if(!Oe)return null;const Fe=[];let je=null;Le.expectedType&&"value"!==Le.expectedType.kind&&(je=Le.expectedType);for(let Oe=1;Oe<F.length;Oe+=2){const qe=1===Oe?-1/0:F[Oe],He=F[Oe+1],xt=Oe,jt=Oe+1;if("number"!=typeof qe)return Le.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',xt);if(Fe.length&&Fe[Fe.length-1][0]>=qe)return Le.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',xt);const Gt=Le.parse(He,jt,je);if(!Gt)return null;je=je||Gt.type,Fe.push([qe,Gt])}return new Un(je,Oe,Fe)}evaluate(F){const Le=this.labels,Oe=this.outputs;if(1===Le.length)return Oe[0].evaluate(F);const Fe=this.input.evaluate(F);if(Fe<=Le[0])return Oe[0].evaluate(F);const je=Le.length;return Fe>=Le[je-1]?Oe[je-1].evaluate(F):Oe[Nn(Le,Fe)].evaluate(F)}eachChild(F){F(this.input);for(const Le of this.outputs)F(Le)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))}serialize(){const F=["step",this.input.serialize()];for(let Le=0;Le<this.labels.length;Le++)Le>0&&F.push(this.labels[Le]),F.push(this.outputs[Le].serialize());return F}}const Dp=.95047,Rp=1.08883,Lp=4/29,Op=6/29,kp=3*Op*Op,Fp=Op*Op*Op,Np=Math.PI/180,Up=180/Math.PI;function Wn(F){return F>Fp?Math.pow(F,1/3):F/kp+Lp}function Kn(F){return F>Op?F*F*F:kp*(F-Lp)}function Jn(F){return 255*(F<=.0031308?12.92*F:1.055*Math.pow(F,1/2.4)-.055)}function Qn(F){return(F/=255)<=.04045?F/12.92:Math.pow((F+.055)/1.055,2.4)}function ti(F){const Le=Qn(F.r),Oe=Qn(F.g),Fe=Qn(F.b),je=Wn((.4124564*Le+.3575761*Oe+.1804375*Fe)/Dp),qe=Wn((.2126729*Le+.7151522*Oe+.072175*Fe)/1);return{l:116*qe-16,a:500*(je-qe),b:200*(qe-Wn((.0193339*Le+.119192*Oe+.9503041*Fe)/Rp)),alpha:F.a}}function ei(F){let Le=(F.l+16)/116,Oe=isNaN(F.a)?Le:Le+F.a/500,Fe=isNaN(F.b)?Le:Le-F.b/200;return Le=1*Kn(Le),Oe=Dp*Kn(Oe),Fe=Rp*Kn(Fe),new Se(Jn(3.2404542*Oe-1.5371385*Le-.4985314*Fe),Jn(-.969266*Oe+1.8760108*Le+.041556*Fe),Jn(.0556434*Oe-.2040259*Le+1.0572252*Fe),F.alpha)}function ri(F,Le,Oe){const Fe=Le-F;return F+Oe*(Fe>180||Fe<-180?Fe-360*Math.round(Fe/360):Fe)}const Gp={forward:ti,reverse:ei,interpolate:function(F,Le,Oe){return{l:Ee(F.l,Le.l,Oe),a:Ee(F.a,Le.a,Oe),b:Ee(F.b,Le.b,Oe),alpha:Ee(F.alpha,Le.alpha,Oe)}}},qp={forward:function(F){const{l:Le,a:Oe,b:Fe}=ti(F),je=Math.atan2(Fe,Oe)*Up;return{h:je<0?je+360:je,c:Math.sqrt(Oe*Oe+Fe*Fe),l:Le,alpha:F.a}},reverse:function(F){const Le=F.h*Np,Oe=F.c;return ei({l:F.l,a:Math.cos(Le)*Oe,b:Math.sin(Le)*Oe,alpha:F.alpha})},interpolate:function(F,Le,Oe){return{h:ri(F.h,Le.h,Oe),c:Ee(F.c,Le.c,Oe),l:Ee(F.l,Le.l,Oe),alpha:Ee(F.alpha,Le.alpha,Oe)}}};var $p=Object.freeze({__proto__:null,hcl:qp,lab:Gp});class ai{constructor(F,Le,Oe,Fe,je){this.type=F,this.operator=Le,this.interpolation=Oe,this.input=Fe,this.labels=[],this.outputs=[];for(const[F,Le]of je)this.labels.push(F),this.outputs.push(Le)}static interpolationFactor(F,Le,Oe,Fe){let je=0;if("exponential"===F.name)je=oi(Le,F.base,Oe,Fe);else if("linear"===F.name)je=oi(Le,1,Oe,Fe);else if("cubic-bezier"===F.name){const qe=F.controlPoints;je=new tc(qe[0],qe[1],qe[2],qe[3]).solve(oi(Le,1,Oe,Fe))}return je}static parse(F,Le){let[Oe,Fe,je,...qe]=F;if(!Array.isArray(Fe)||0===Fe.length)return Le.error("Expected an interpolation type expression.",1);if("linear"===Fe[0])Fe={name:"linear"};else if("exponential"===Fe[0]){const F=Fe[1];if("number"!=typeof F)return Le.error("Exponential interpolation requires a numeric base.",1,1);Fe={name:"exponential",base:F}}else{if("cubic-bezier"!==Fe[0])return Le.error(`Unknown interpolation type ${String(Fe[0])}`,1,0);{const F=Fe.slice(1);if(4!==F.length||F.some((F=>"number"!=typeof F||F<0||F>1)))return Le.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);Fe={name:"cubic-bezier",controlPoints:F}}}if(F.length-1<4)return Le.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if(F.length-1>3&&(F.length-1)%2!=0)return Le.error("Expected an even number of arguments.");if(je=Le.parse(je,2,Zu),!je)return null;const He=[];let xt=null;"interpolate-hcl"===Oe||"interpolate-lab"===Oe?xt=hd:Le.expectedType&&"value"!==Le.expectedType.kind&&(xt=Le.expectedType);for(let F=0;F<qe.length;F+=2){const Oe=qe[F],Fe=qe[F+1],je=F+3,jt=F+4;if("number"!=typeof Oe)return Le.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',je);if(He.length&&He[He.length-1][0]>=Oe)return Le.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',je);const Gt=Le.parse(Fe,jt,xt);if(!Gt)return null;xt=xt||Gt.type,He.push([Oe,Gt])}return"number"===xt.kind||"color"===xt.kind||"array"===xt.kind&&"number"===xt.itemType.kind&&"number"==typeof xt.N?new ai(xt,Oe,Fe,je,He):Le.error(`Type ${Ye(xt)} is not interpolatable.`)}evaluate(F){const Le=this.labels,Oe=this.outputs;if(1===Le.length)return Oe[0].evaluate(F);const Fe=this.input.evaluate(F);if(Fe<=Le[0])return Oe[0].evaluate(F);const je=Le.length;if(Fe>=Le[je-1])return Oe[je-1].evaluate(F);const qe=Nn(Le,Fe),He=ai.interpolationFactor(this.interpolation,Fe,Le[qe],Le[qe+1]),xt=Oe[qe].evaluate(F),jt=Oe[qe+1].evaluate(F);return"interpolate"===this.operator?Fu[this.type.kind.toLowerCase()](xt,jt,He):"interpolate-hcl"===this.operator?qp.reverse(qp.interpolate(qp.forward(xt),qp.forward(jt),He)):Gp.reverse(Gp.interpolate(Gp.forward(xt),Gp.forward(jt),He))}eachChild(F){F(this.input);for(const Le of this.outputs)F(Le)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))}serialize(){let F;F="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const Le=[this.operator,F,this.input.serialize()];for(let F=0;F<this.labels.length;F++)Le.push(this.labels[F],this.outputs[F].serialize());return Le}}function oi(F,Le,Oe,Fe){const je=Fe-Oe,qe=F-Oe;return 0===je?0:1===Le?qe/je:(Math.pow(Le,qe)-1)/(Math.pow(Le,je)-1)}class li{constructor(F,Le){this.type=F,this.args=Le}static parse(F,Le){if(F.length<2)return Le.error("Expectected at least one argument.");let Oe=null;const Fe=Le.expectedType;Fe&&"value"!==Fe.kind&&(Oe=Fe);const je=[];for(const Fe of F.slice(1)){const F=Le.parse(Fe,1+je.length,Oe,void 0,{typeAnnotation:"omit"});if(!F)return null;Oe=Oe||F.type,je.push(F)}const qe=Fe&&je.some((F=>Xe(Fe,F.type)));return new li(qe?_d:Oe,je)}evaluate(F){let Le,Oe=null,Fe=0;for(const je of this.args){if(Fe++,Oe=je.evaluate(F),Oe&&Oe instanceof er&&!Oe.available&&(Le||(Le=Oe),Oe=null,Fe===this.args.length))return Le;if(null!==Oe)break}return Oe}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every((F=>F.outputDefined()))}serialize(){const F=["coalesce"];return this.eachChild((Le=>{F.push(Le.serialize())})),F}}class ui{constructor(F,Le){this.type=Le.type,this.bindings=[].concat(F),this.result=Le}evaluate(F){return this.result.evaluate(F)}eachChild(F){for(const Le of this.bindings)F(Le[1]);F(this.result)}static parse(F,Le){if(F.length<4)return Le.error(`Expected at least 3 arguments, but found ${F.length-1} instead.`);const Oe=[];for(let Fe=1;Fe<F.length-1;Fe+=2){const je=F[Fe];if("string"!=typeof je)return Le.error(`Expected string, but found ${typeof je} instead.`,Fe);if(/[^a-zA-Z0-9_]/.test(je))return Le.error("Variable names must contain only alphanumeric characters or '_'.",Fe);const qe=Le.parse(F[Fe+1],Fe+1);if(!qe)return null;Oe.push([je,qe])}const Fe=Le.parse(F[F.length-1],F.length-1,Le.expectedType,Oe);return Fe?new ui(Oe,Fe):null}outputDefined(){return this.result.outputDefined()}serialize(){const F=["let"];for(const[Le,Oe]of this.bindings)F.push(Le,Oe.serialize());return F.push(this.result.serialize()),F}}class ci{constructor(F,Le,Oe){this.type=F,this.index=Le,this.input=Oe}static parse(F,Le){if(3!==F.length)return Le.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Oe=Le.parse(F[1],1,Zu),Fe=Le.parse(F[2],2,Ge(Le.expectedType||_d));return Oe&&Fe?new ci(Fe.type.itemType,Oe,Fe):null}evaluate(F){const Le=this.index.evaluate(F),Oe=this.input.evaluate(F);if(Le<0)throw new or(`Array index out of bounds: ${Le} < 0.`);if(Le>=Oe.length)throw new or(`Array index out of bounds: ${Le} > ${Oe.length-1}.`);if(Le!==Math.floor(Le))throw new or(`Array index must be an integer, but found ${Le} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return Oe[Le]}eachChild(F){F(this.index),F(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class hi{constructor(F,Le,Oe){this.type=F,this.index=Le,this.input=Oe}static parse(F,Le){if(3!==F.length)return Le.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Oe=Le.parse(F[1],1,Zu),Fe=Le.parse(F[2],2,Ge(Le.expectedType||_d));return Oe&&Fe?new hi(Fe.type.itemType,Oe,Fe):null}evaluate(F){const Le=this.index.evaluate(F),Oe=this.input.evaluate(F);if(Le<0)throw new or(`Array index out of bounds: ${Le} < 0.`);if(Le>Oe.length-1)throw new or(`Array index out of bounds: ${Le} > ${Oe.length-1}.`);if(Le===Math.floor(Le))return Oe[Le];const Fe=Math.floor(Le),je=Math.ceil(Le),qe=Oe[Fe],He=Oe[je];if("number"!=typeof qe||"number"!=typeof He)throw new or(`Cannot interpolate between non-number values at index ${Le}.`);const xt=Le-Fe;return qe*(1-xt)+He*xt}eachChild(F){F(this.index),F(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class pi{constructor(F,Le){this.type=Xu,this.needle=F,this.haystack=Le}static parse(F,Le){if(3!==F.length)return Le.error(`Expected 2 arguments, but found ${F.length-1} instead.`);const Oe=Le.parse(F[1],1,_d),Fe=Le.parse(F[2],2,_d);return Oe&&Fe?Ze(Oe.type,[Xu,Wu,Zu,Hu,_d])?new pi(Oe,Fe):Le.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(Oe.type)} instead`):null}evaluate(F){const Le=this.needle.evaluate(F),Oe=this.haystack.evaluate(F);if(null==Oe)return!1;if(!We(Le,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(ir(Le))} instead.`);if(!We(Oe,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${Ye(ir(Oe))} instead.`);return Oe.indexOf(Le)>=0}eachChild(F){F(this.needle),F(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class fi{constructor(F,Le,Oe){this.type=Zu,this.needle=F,this.haystack=Le,this.fromIndex=Oe}static parse(F,Le){if(F.length<=2||F.length>=5)return Le.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);const Oe=Le.parse(F[1],1,_d),Fe=Le.parse(F[2],2,_d);if(!Oe||!Fe)return null;if(!Ze(Oe.type,[Xu,Wu,Zu,Hu,_d]))return Le.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(Oe.type)} instead`);if(4===F.length){const je=Le.parse(F[3],3,Zu);return je?new fi(Oe,Fe,je):null}return new fi(Oe,Fe)}evaluate(F){const Le=this.needle.evaluate(F),Oe=this.haystack.evaluate(F);if(!We(Le,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(ir(Le))} instead.`);if(!We(Oe,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${Ye(ir(Oe))} instead.`);if(this.fromIndex){const Fe=this.fromIndex.evaluate(F);return Oe.indexOf(Le,Fe)}return Oe.indexOf(Le)}eachChild(F){F(this.needle),F(this.haystack),this.fromIndex&&F(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const F=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),F]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class di{constructor(F,Le,Oe,Fe,je,qe){this.inputType=F,this.type=Le,this.input=Oe,this.cases=Fe,this.outputs=je,this.otherwise=qe}static parse(F,Le){if(F.length<5)return Le.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if(F.length%2!=1)return Le.error("Expected an even number of arguments.");let Oe,Fe;Le.expectedType&&"value"!==Le.expectedType.kind&&(Fe=Le.expectedType);const je={},qe=[];for(let He=2;He<F.length-1;He+=2){let xt=F[He];const jt=F[He+1];Array.isArray(xt)||(xt=[xt]);const Gt=Le.concat(He);if(0===xt.length)return Gt.error("Expected at least one branch label.");for(const F of xt){if("number"!=typeof F&&"string"!=typeof F)return Gt.error("Branch labels must be numbers or strings.");if("number"==typeof F&&Math.abs(F)>Number.MAX_SAFE_INTEGER)return Gt.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof F&&Math.floor(F)!==F)return Gt.error("Numeric branch labels must be integer values.");if(Oe){if(Gt.checkSubtype(Oe,ir(F)))return null}else Oe=ir(F);if(void 0!==je[String(F)])return Gt.error("Branch labels must be unique.");je[String(F)]=qe.length}const bi=Le.parse(jt,He,Fe);if(!bi)return null;Fe=Fe||bi.type,qe.push(bi)}const He=Le.parse(F[1],1,_d);if(!He)return null;const xt=Le.parse(F[F.length-1],F.length-1,Fe);return xt?"value"!==He.type.kind&&Le.concat(1).checkSubtype(Oe,He.type)?null:new di(Oe,Fe,He,je,qe,xt):null}evaluate(F){const Le=this.input.evaluate(F);return(ir(Le)===this.inputType&&this.outputs[this.cases[Le]]||this.otherwise).evaluate(F)}eachChild(F){F(this.input),this.outputs.forEach(F),F(this.otherwise)}outputDefined(){return this.outputs.every((F=>F.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const F=["match",this.input.serialize()],Le=Object.keys(this.cases).sort(),Oe=[],Fe={};for(const F of Le){const Le=Fe[this.cases[F]];void 0===Le?(Fe[this.cases[F]]=Oe.length,Oe.push([this.cases[F],[F]])):Oe[Le][1].push(F)}const i=F=>"number"===this.inputType.kind?Number(F):F;for(const[Le,Fe]of Oe)F.push(1===Fe.length?i(Fe[0]):Fe.map(i)),F.push(this.outputs[Le].serialize());return F.push(this.otherwise.serialize()),F}}class mi{constructor(F,Le,Oe){this.type=F,this.branches=Le,this.otherwise=Oe}static parse(F,Le){if(F.length<4)return Le.error(`Expected at least 3 arguments, but found only ${F.length-1}.`);if(F.length%2!=0)return Le.error("Expected an odd number of arguments.");let Oe;Le.expectedType&&"value"!==Le.expectedType.kind&&(Oe=Le.expectedType);const Fe=[];for(let je=1;je<F.length-1;je+=2){const qe=Le.parse(F[je],je,Xu);if(!qe)return null;const He=Le.parse(F[je+1],je+1,Oe);if(!He)return null;Fe.push([qe,He]),Oe=Oe||He.type}const je=Le.parse(F[F.length-1],F.length-1,Oe);return je?new mi(Oe,Fe,je):null}evaluate(F){for(const[Le,Oe]of this.branches)if(Le.evaluate(F))return Oe.evaluate(F);return this.otherwise.evaluate(F)}eachChild(F){for(const[Le,Oe]of this.branches)F(Le),F(Oe);F(this.otherwise)}outputDefined(){return this.branches.every((([F,Le])=>Le.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const F=["case"];return this.eachChild((Le=>{F.push(Le.serialize())})),F}}class yi{constructor(F,Le,Oe,Fe){this.type=F,this.input=Le,this.beginIndex=Oe,this.endIndex=Fe}static parse(F,Le){if(F.length<=2||F.length>=5)return Le.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);const Oe=Le.parse(F[1],1,_d),Fe=Le.parse(F[2],2,Zu);if(!Oe||!Fe)return null;if(!Ze(Oe.type,[Ge(_d),Wu,_d]))return Le.error(`Expected first argument to be of type array or string, but found ${Ye(Oe.type)} instead`);if(4===F.length){const je=Le.parse(F[3],3,Zu);return je?new yi(Oe.type,Oe,Fe,je):null}return new yi(Oe.type,Oe,Fe)}evaluate(F){const Le=this.input.evaluate(F),Oe=this.beginIndex.evaluate(F);if(!We(Le,["string","array"]))throw new or(`Expected first argument to be of type array or string, but found ${Ye(ir(Le))} instead.`);if(this.endIndex){const Fe=this.endIndex.evaluate(F);return Le.slice(Oe,Fe)}return Le.slice(Oe)}eachChild(F){F(this.input),F(this.beginIndex),this.endIndex&&F(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const F=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),F]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function gi(F,Le){return"=="===F||"!="===F?"boolean"===Le.kind||"string"===Le.kind||"number"===Le.kind||"null"===Le.kind||"value"===Le.kind:"string"===Le.kind||"number"===Le.kind||"value"===Le.kind}function xi(F,Le,Oe,Fe){return 0===Fe.compare(Le,Oe)}function vi(F,Le,Oe){const Fe="=="!==F&&"!="!==F;return class i{constructor(F,Le,Oe){this.type=Xu,this.lhs=F,this.rhs=Le,this.collator=Oe,this.hasUntypedArgument="value"===F.type.kind||"value"===Le.type.kind}static parse(F,Le){if(3!==F.length&&4!==F.length)return Le.error("Expected two or three arguments.");const Oe=F[0];let je=Le.parse(F[1],1,_d);if(!je)return null;if(!gi(Oe,je.type))return Le.concat(1).error(`"${Oe}" comparisons are not supported for type '${Ye(je.type)}'.`);let qe=Le.parse(F[2],2,_d);if(!qe)return null;if(!gi(Oe,qe.type))return Le.concat(2).error(`"${Oe}" comparisons are not supported for type '${Ye(qe.type)}'.`);if(je.type.kind!==qe.type.kind&&"value"!==je.type.kind&&"value"!==qe.type.kind)return Le.error(`Cannot compare types '${Ye(je.type)}' and '${Ye(qe.type)}'.`);Fe&&("value"===je.type.kind&&"value"!==qe.type.kind?je=new ur(qe.type,[je]):"value"!==je.type.kind&&"value"===qe.type.kind&&(qe=new ur(je.type,[qe])));let He=null;if(4===F.length){if("string"!==je.type.kind&&"string"!==qe.type.kind&&"value"!==je.type.kind&&"value"!==qe.type.kind)return Le.error("Cannot use collator to compare non-string types.");if(He=Le.parse(F[3],3,xd),!He)return null}return new i(je,qe,He)}evaluate(je){const qe=this.lhs.evaluate(je),He=this.rhs.evaluate(je);if(Fe&&this.hasUntypedArgument){const Le=ir(qe),Oe=ir(He);if(Le.kind!==Oe.kind||"string"!==Le.kind&&"number"!==Le.kind)throw new or(`Expected arguments for "${F}" to be (string, string) or (number, number), but found (${Le.kind}, ${Oe.kind}) instead.`)}if(this.collator&&!Fe&&this.hasUntypedArgument){const F=ir(qe),Oe=ir(He);if("string"!==F.kind||"string"!==Oe.kind)return Le(je,qe,He)}return this.collator?Oe(je,qe,He,this.collator.evaluate(je)):Le(je,qe,He)}eachChild(F){F(this.lhs),F(this.rhs),this.collator&&F(this.collator)}outputDefined(){return!0}serialize(){const Le=[F];return this.eachChild((F=>{Le.push(F.serialize())})),Le}}}const Zp=vi("==",(function(F,Le,Oe){return Le===Oe}),xi),Xp=vi("!=",(function(F,Le,Oe){return Le!==Oe}),(function(F,Le,Oe,Fe){return!xi(0,Le,Oe,Fe)})),rf=vi("<",(function(F,Le,Oe){return Le<Oe}),(function(F,Le,Oe,Fe){return Fe.compare(Le,Oe)<0})),af=vi(">",(function(F,Le,Oe){return Le>Oe}),(function(F,Le,Oe,Fe){return Fe.compare(Le,Oe)>0})),lf=vi("<=",(function(F,Le,Oe){return Le<=Oe}),(function(F,Le,Oe,Fe){return Fe.compare(Le,Oe)<=0})),cf=vi(">=",(function(F,Le,Oe){return Le>=Oe}),(function(F,Le,Oe,Fe){return Fe.compare(Le,Oe)>=0}));class Si{constructor(F,Le,Oe,Fe,je,qe){this.type=Wu,this.number=F,this.locale=Le,this.currency=Oe,this.unit=Fe,this.minFractionDigits=je,this.maxFractionDigits=qe}static parse(F,Le){if(3!==F.length)return Le.error("Expected two arguments.");const Oe=Le.parse(F[1],1,Zu);if(!Oe)return null;const Fe=F[2];if("object"!=typeof Fe||Array.isArray(Fe))return Le.error("NumberFormat options argument must be an object.");let je=null;if(Fe.locale&&(je=Le.parseObjectValue(Fe.locale,2,"locale",Wu),!je))return null;let qe=null;if(Fe.currency&&(qe=Le.parseObjectValue(Fe.currency,2,"currency",Wu),!qe))return null;let He=null;if(Fe.unit&&(He=Le.parseObjectValue(Fe.unit,2,"unit",Wu),!He))return null;let xt=null;if(Fe["min-fraction-digits"]&&(xt=Le.parseObjectValue(Fe["min-fraction-digits"],2,"min-fraction-digits",Zu),!xt))return null;let jt=null;return Fe["max-fraction-digits"]&&(jt=Le.parseObjectValue(Fe["max-fraction-digits"],2,"max-fraction-digits",Zu),!jt)?null:new Si(Oe,je,qe,He,xt,jt)}evaluate(F){return new Intl.NumberFormat(this.locale?this.locale.evaluate(F):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(F):void 0,unit:this.unit?this.unit.evaluate(F):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(F):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(F):void 0}).format(this.number.evaluate(F))}eachChild(F){F(this.number),this.locale&&F(this.locale),this.currency&&F(this.currency),this.unit&&F(this.unit),this.minFractionDigits&&F(this.minFractionDigits),this.maxFractionDigits&&F(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const F={};return this.locale&&(F.locale=this.locale.serialize()),this.currency&&(F.currency=this.currency.serialize()),this.unit&&(F.unit=this.unit.serialize()),this.minFractionDigits&&(F["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(F["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),F]}}class Pi{constructor(F){this.type=Zu,this.input=F}static parse(F,Le){if(2!==F.length)return Le.error(`Expected 1 argument, but found ${F.length-1} instead.`);const Oe=Le.parse(F[1],1);return Oe?"array"!==Oe.type.kind&&"string"!==Oe.type.kind&&"value"!==Oe.type.kind?Le.error(`Expected argument of type string or array, but found ${Ye(Oe.type)} instead.`):new Pi(Oe):null}evaluate(F){const Le=this.input.evaluate(F);if("string"==typeof Le)return Le.length;if(Array.isArray(Le))return Le.length;throw new or(`Expected value to be of type string or array, but found ${Ye(ir(Le))} instead.`)}eachChild(F){F(this.input)}outputDefined(){return!1}serialize(){const F=["length"];return this.eachChild((Le=>{F.push(Le.serialize())})),F}}function Ei(F){return function(){F=1831565813+(F|=0)|0;let Le=Math.imul(F^F>>>15,1|F);return Le=Le+Math.imul(Le^Le>>>7,61|Le)^Le,((Le^Le>>>14)>>>0)/4294967296}}const hf={"==":Zp,"!=":Xp,">":af,"<":rf,">=":cf,"<=":lf,array:ur,at:ci,"at-interpolated":hi,boolean:ur,case:mi,coalesce:li,collator:vr,format:cr,image:hr,in:pi,"index-of":fi,interpolate:ai,"interpolate-hcl":ai,"interpolate-lab":ai,length:Pi,let:ui,literal:ar,match:di,number:ur,"number-format":Si,object:ur,slice:yi,step:Un,string:ur,"to-boolean":dr,"to-color":dr,"to-number":dr,"to-string":dr,var:Rn,within:Ur,distance:En,config:Tn};function ki(F,[Le,Oe,Fe,je]){Le=Le.evaluate(F),Oe=Oe.evaluate(F),Fe=Fe.evaluate(F);const qe=je?je.evaluate(F):1,He=rr(Le,Oe,Fe,qe);if(He)throw new or(He);return new Se(Le/255*qe,Oe/255*qe,Fe/255*qe,qe)}function Ti(F,[Le,Oe,Fe,je]){Le=Le.evaluate(F),Oe=Oe.evaluate(F),Fe=Fe.evaluate(F);const qe=je?je.evaluate(F):1,He=function(F,Le,Oe,Fe){return"number"==typeof F&&F>=0&&F<=360?"number"==typeof Le&&Le>=0&&Le<=100&&"number"==typeof Oe&&Oe>=0&&Oe<=100?void 0===Fe||"number"==typeof Fe&&Fe>=0&&Fe<=1?null:`Invalid hsla value [${[F,Le,Oe,Fe].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof Fe?[F,Le,Oe,Fe]:[F,Le,Oe]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof Fe?[F,Le,Oe,Fe]:[F,Le,Oe]).join(", ")}]: 'h' must be between 0 and 360.`}(Le,Oe,Fe,qe);if(He)throw new or(He);const xt=`hsla(${Le}, ${Oe}%, ${Fe}%, ${qe})`,jt=Se.parse(xt);if(!jt)throw new or(`Failed to parse HSLA color: ${xt}`);return jt}function Bi(F,Le){return F in Le}function Vi(F,Le){const Oe=Le[F];return void 0===Oe?null:Oe}function Ci(F){return{type:F}}function Di(F){return{result:"success",value:F}}function Ri(F){return{result:"error",value:F}}function Li(F,Le){return!!F&&!!F.parameters&&F.parameters.indexOf(Le)>-1}function Fi(F){return"data-driven"===F["property-type"]}function Oi(F){return Li(F.expression,"measure-light")}function Ni(F){return Li(F.expression,"zoom")}function Ui(F){return!!F.expression&&F.expression.interpolated}function ji(F){return"object"==typeof F&&null!==F&&!Array.isArray(F)}function qi(F){return F}function $i(F,Le){const Oe="color"===Le.type,Fe=F.stops&&"object"==typeof F.stops[0][0],je=Fe||!(Fe||void 0!==F.property),qe=F.type||(Ui(Le)?"exponential":"interval");if(Oe&&((F=Be({},F)).stops&&(F.stops=F.stops.map((F=>[F[0],Se.parse(F[1])]))),F.default=Se.parse(F.default?F.default:Le.default)),F.colorSpace&&"rgb"!==F.colorSpace&&!$p[F.colorSpace])throw new Error(`Unknown color space: ${F.colorSpace}`);let He,xt,jt;if("exponential"===qe)He=Xi;else if("interval"===qe)He=Hi;else if("categorical"===qe){He=Yi,xt=Object.create(null);for(const Le of F.stops)xt[Le[0]]=Le[1];jt=typeof F.stops[0][0]}else{if("identity"!==qe)throw new Error(`Unknown function type "${qe}"`);He=Zi}if(Fe){const Oe={},Fe=[];for(let Le=0;Le<F.stops.length;Le++){const je=F.stops[Le],qe=je[0].zoom;void 0===Oe[qe]&&(Oe[qe]={zoom:qe,type:F.type,property:F.property,default:F.default,stops:[]},Fe.push(qe)),Oe[qe].stops.push([je[0].value,je[1]])}const je=[];for(const F of Fe)je.push([Oe[F].zoom,$i(Oe[F],Le)]);const qe={name:"linear"};return{kind:"composite",interpolationType:qe,interpolationFactor:ai.interpolationFactor.bind(void 0,qe),zoomStops:je.map((F=>F[0])),evaluate:({zoom:Oe},Fe)=>Xi({stops:je,base:F.base},Le,Oe).evaluate(Oe,Fe)}}if(je){const Oe="exponential"===qe?{name:"exponential",base:void 0!==F.base?F.base:1}:null;return{kind:"camera",interpolationType:Oe,interpolationFactor:ai.interpolationFactor.bind(void 0,Oe),zoomStops:F.stops.map((F=>F[0])),evaluate:({zoom:Oe})=>He(F,Le,Oe,xt,jt)}}return{kind:"source",evaluate(Oe,Fe){const je=Fe&&Fe.properties?Fe.properties[F.property]:void 0;return void 0===je?Gi(F.default,Le.default):He(F,Le,je,xt,jt)}}}function Gi(F,Le,Oe){return void 0!==F?F:void 0!==Le?Le:void 0!==Oe?Oe:void 0}function Yi(F,Le,Oe,Fe,je){return Gi(typeof Oe===je?Fe[Oe]:void 0,F.default,Le.default)}function Hi(F,Le,Oe){if("number"!==pr(Oe))return Gi(F.default,Le.default);const Fe=F.stops.length;if(1===Fe)return F.stops[0][1];if(Oe<=F.stops[0][0])return F.stops[0][1];if(Oe>=F.stops[Fe-1][0])return F.stops[Fe-1][1];const je=Nn(F.stops.map((F=>F[0])),Oe);return F.stops[je][1]}function Xi(F,Le,Oe){const Fe=void 0!==F.base?F.base:1;if("number"!==pr(Oe))return Gi(F.default,Le.default);const je=F.stops.length;if(1===je)return F.stops[0][1];if(Oe<=F.stops[0][0])return F.stops[0][1];if(Oe>=F.stops[je-1][0])return F.stops[je-1][1];const qe=Nn(F.stops.map((F=>F[0])),Oe),He=function(F,Le,Oe,Fe){const je=Fe-Oe,qe=F-Oe;return 0===je?0:1===Le?qe/je:(Math.pow(Le,qe)-1)/(Math.pow(Le,je)-1)}(Oe,Fe,F.stops[qe][0],F.stops[qe+1][0]),xt=F.stops[qe][1],jt=F.stops[qe+1][1];let Gt=Fu[Le.type]||qi;if(F.colorSpace&&"rgb"!==F.colorSpace){const Le=$p[F.colorSpace];Gt=(F,Oe)=>Le.reverse(Le.interpolate(Le.forward(F),Le.forward(Oe),He))}return"function"==typeof xt.evaluate?{evaluate(...F){const Le=xt.evaluate.apply(void 0,F),Oe=jt.evaluate.apply(void 0,F);if(void 0!==Le&&void 0!==Oe)return Gt(Le,Oe,He)}}:Gt(xt,jt,He)}function Zi(F,Le,Oe){return"color"===Le.type?Oe=Se.parse(Oe):"formatted"===Le.type?Oe=Qe.fromString(Oe.toString()):"resolvedImage"===Le.type?Oe=er.build(Oe.toString()):pr(Oe)===Le.type||"enum"===Le.type&&Le.values[Oe]||(Oe=void 0),Gi(Oe,F.default,Le.default)}gr.register(hf,{error:[{kind:"error"},[Wu],(F,[Le])=>{throw new or(Le.evaluate(F))}],typeof:[Wu,[_d],(F,[Le])=>Ye(ir(Le.evaluate(F)))],"to-rgba":[Ge(Zu,4),[hd],(F,[Le])=>Le.evaluate(F).toRenderColor(null).toArray()],"to-hsla":[Ge(Zu,4),[hd],(F,[Le])=>Le.evaluate(F).toRenderColor(null).toHslaArray()],rgb:[hd,[Zu,Zu,Zu],ki],rgba:[hd,[Zu,Zu,Zu,Zu],ki],hsl:[hd,[Zu,Zu,Zu],Ti],hsla:[hd,[Zu,Zu,Zu,Zu],Ti],has:{type:Xu,overloads:[[[Wu],(F,[Le])=>Bi(Le.evaluate(F),F.properties())],[[Wu,md],(F,[Le,Oe])=>Bi(Le.evaluate(F),Oe.evaluate(F))]]},get:{type:_d,overloads:[[[Wu],(F,[Le])=>Vi(Le.evaluate(F),F.properties())],[[Wu,md],(F,[Le,Oe])=>Vi(Le.evaluate(F),Oe.evaluate(F))]]},"feature-state":[_d,[Wu],(F,[Le])=>Vi(Le.evaluate(F),F.featureState||{})],properties:[md,[],F=>F.properties()],"geometry-type":[Wu,[],F=>F.geometryType()],id:[_d,[],F=>F.id()],zoom:[Zu,[],F=>F.globals.zoom],pitch:[Zu,[],F=>F.globals.pitch||0],"distance-from-center":[Zu,[],F=>F.distanceFromCenter()],"measure-light":[Zu,[Wu],(F,[Le])=>F.measureLight(Le.evaluate(F))],"heatmap-density":[Zu,[],F=>F.globals.heatmapDensity||0],"line-progress":[Zu,[],F=>F.globals.lineProgress||0],"raster-value":[Zu,[],F=>F.globals.rasterValue||0],"raster-particle-speed":[Zu,[],F=>F.globals.rasterParticleSpeed||0],"sky-radial-progress":[Zu,[],F=>F.globals.skyRadialProgress||0],accumulated:[_d,[],F=>void 0===F.globals.accumulated?null:F.globals.accumulated],"+":[Zu,Ci(Zu),(F,Le)=>{let Oe=0;for(const Fe of Le)Oe+=Fe.evaluate(F);return Oe}],"*":[Zu,Ci(Zu),(F,Le)=>{let Oe=1;for(const Fe of Le)Oe*=Fe.evaluate(F);return Oe}],"-":{type:Zu,overloads:[[[Zu,Zu],(F,[Le,Oe])=>Le.evaluate(F)-Oe.evaluate(F)],[[Zu],(F,[Le])=>-Le.evaluate(F)]]},"/":[Zu,[Zu,Zu],(F,[Le,Oe])=>Le.evaluate(F)/Oe.evaluate(F)],"%":[Zu,[Zu,Zu],(F,[Le,Oe])=>Le.evaluate(F)%Oe.evaluate(F)],ln2:[Zu,[],()=>Math.LN2],pi:[Zu,[],()=>Math.PI],e:[Zu,[],()=>Math.E],"^":[Zu,[Zu,Zu],(F,[Le,Oe])=>Math.pow(Le.evaluate(F),Oe.evaluate(F))],sqrt:[Zu,[Zu],(F,[Le])=>Math.sqrt(Le.evaluate(F))],log10:[Zu,[Zu],(F,[Le])=>Math.log(Le.evaluate(F))/Math.LN10],ln:[Zu,[Zu],(F,[Le])=>Math.log(Le.evaluate(F))],log2:[Zu,[Zu],(F,[Le])=>Math.log(Le.evaluate(F))/Math.LN2],sin:[Zu,[Zu],(F,[Le])=>Math.sin(Le.evaluate(F))],cos:[Zu,[Zu],(F,[Le])=>Math.cos(Le.evaluate(F))],tan:[Zu,[Zu],(F,[Le])=>Math.tan(Le.evaluate(F))],asin:[Zu,[Zu],(F,[Le])=>Math.asin(Le.evaluate(F))],acos:[Zu,[Zu],(F,[Le])=>Math.acos(Le.evaluate(F))],atan:[Zu,[Zu],(F,[Le])=>Math.atan(Le.evaluate(F))],min:[Zu,Ci(Zu),(F,Le)=>Math.min(...Le.map((Le=>Le.evaluate(F))))],max:[Zu,Ci(Zu),(F,Le)=>Math.max(...Le.map((Le=>Le.evaluate(F))))],abs:[Zu,[Zu],(F,[Le])=>Math.abs(Le.evaluate(F))],round:[Zu,[Zu],(F,[Le])=>{const Oe=Le.evaluate(F);return Oe<0?-Math.round(-Oe):Math.round(Oe)}],floor:[Zu,[Zu],(F,[Le])=>Math.floor(Le.evaluate(F))],ceil:[Zu,[Zu],(F,[Le])=>Math.ceil(Le.evaluate(F))],"filter-==":[Xu,[Wu,_d],(F,[Le,Oe])=>F.properties()[Le.value]===Oe.value],"filter-id-==":[Xu,[_d],(F,[Le])=>F.id()===Le.value],"filter-type-==":[Xu,[Wu],(F,[Le])=>F.geometryType()===Le.value],"filter-<":[Xu,[Wu,_d],(F,[Le,Oe])=>{const Fe=F.properties()[Le.value],je=Oe.value;return typeof Fe==typeof je&&Fe<je}],"filter-id-<":[Xu,[_d],(F,[Le])=>{const Oe=F.id(),Fe=Le.value;return typeof Oe==typeof Fe&&Oe<Fe}],"filter->":[Xu,[Wu,_d],(F,[Le,Oe])=>{const Fe=F.properties()[Le.value],je=Oe.value;return typeof Fe==typeof je&&Fe>je}],"filter-id->":[Xu,[_d],(F,[Le])=>{const Oe=F.id(),Fe=Le.value;return typeof Oe==typeof Fe&&Oe>Fe}],"filter-<=":[Xu,[Wu,_d],(F,[Le,Oe])=>{const Fe=F.properties()[Le.value],je=Oe.value;return typeof Fe==typeof je&&Fe<=je}],"filter-id-<=":[Xu,[_d],(F,[Le])=>{const Oe=F.id(),Fe=Le.value;return typeof Oe==typeof Fe&&Oe<=Fe}],"filter->=":[Xu,[Wu,_d],(F,[Le,Oe])=>{const Fe=F.properties()[Le.value],je=Oe.value;return typeof Fe==typeof je&&Fe>=je}],"filter-id->=":[Xu,[_d],(F,[Le])=>{const Oe=F.id(),Fe=Le.value;return typeof Oe==typeof Fe&&Oe>=Fe}],"filter-has":[Xu,[_d],(F,[Le])=>Le.value in F.properties()],"filter-has-id":[Xu,[],F=>null!==F.id()&&void 0!==F.id()],"filter-type-in":[Xu,[Ge(Wu)],(F,[Le])=>Le.value.indexOf(F.geometryType())>=0],"filter-id-in":[Xu,[Ge(_d)],(F,[Le])=>Le.value.indexOf(F.id())>=0],"filter-in-small":[Xu,[Wu,Ge(_d)],(F,[Le,Oe])=>Oe.value.indexOf(F.properties()[Le.value])>=0],"filter-in-large":[Xu,[Wu,Ge(_d)],(F,[Le,Oe])=>function(F,Le,Oe,Fe){for(;Oe<=Fe;){const je=Oe+Fe>>1;if(Le[je]===F)return!0;Le[je]>F?Fe=je-1:Oe=je+1}return!1}(F.properties()[Le.value],Oe.value,0,Oe.value.length-1)],all:{type:Xu,overloads:[[[Xu,Xu],(F,[Le,Oe])=>Le.evaluate(F)&&Oe.evaluate(F)],[Ci(Xu),(F,Le)=>{for(const Oe of Le)if(!Oe.evaluate(F))return!1;return!0}]]},any:{type:Xu,overloads:[[[Xu,Xu],(F,[Le,Oe])=>Le.evaluate(F)||Oe.evaluate(F)],[Ci(Xu),(F,Le)=>{for(const Oe of Le)if(Oe.evaluate(F))return!0;return!1}]]},"!":[Xu,[Xu],(F,[Le])=>!Le.evaluate(F)],"is-supported-script":[Xu,[Wu],(F,[Le])=>{const Oe=F.globals&&F.globals.isSupportedScript;return!Oe||Oe(Le.evaluate(F))}],upcase:[Wu,[Wu],(F,[Le])=>Le.evaluate(F).toUpperCase()],downcase:[Wu,[Wu],(F,[Le])=>Le.evaluate(F).toLowerCase()],concat:[Wu,Ci(_d),(F,Le)=>Le.map((Le=>sr(Le.evaluate(F)))).join("")],"resolved-locale":[Wu,[xd],(F,[Le])=>Le.evaluate(F).resolvedLocale()],random:[Zu,[Zu,Zu,_d],(F,Le)=>{const[Oe,Fe,je]=Le.map((Le=>Le.evaluate(F)));if(Oe>Fe)return Oe;if(Oe===Fe)return Oe;let qe;if("string"==typeof je)qe=function(F){let Le=0;if(0===F.length)return Le;for(let Oe=0;Oe<F.length;Oe++)Le=(Le<<5)-Le+F.charCodeAt(Oe),Le|=0;return Le}(je);else{if("number"!=typeof je)throw new or(`Invalid seed input: ${je}`);qe=je}return Oe+Ei(qe)()*(Fe-Oe)}]});class Wi{constructor(F,Le,Oe,Fe){this.expression=F,this._warningHistory={},this._evaluator=new yr(Oe,Fe),this._defaultValue=Le?function(F){return"color"===F.type&&(ji(F.default)||Array.isArray(F.default))?new Se(0,0,0,0):"color"===F.type?Se.parse(F.default)||null:void 0===F.default?null:F.default}(Le):null,this._enumValues=Le&&"enum"===Le.type?Le.values:null,this.configDependencies=Cn(F)}evaluateWithoutErrorHandling(F,Le,Oe,Fe,je,qe,He,xt){return this._evaluator.globals=F,this._evaluator.feature=Le,this._evaluator.featureState=Oe,this._evaluator.canonical=Fe||null,this._evaluator.availableImages=je||null,this._evaluator.formattedSection=qe,this._evaluator.featureTileCoord=He||null,this._evaluator.featureDistanceData=xt||null,this.expression.evaluate(this._evaluator)}evaluate(F,Le,Oe,Fe,je,qe,He,xt){this._evaluator.globals=F,this._evaluator.feature=Le||null,this._evaluator.featureState=Oe||null,this._evaluator.canonical=Fe||null,this._evaluator.availableImages=je||null,this._evaluator.formattedSection=qe||null,this._evaluator.featureTileCoord=He||null,this._evaluator.featureDistanceData=xt||null;try{const F=this.expression.evaluate(this._evaluator);if(null==F||"number"==typeof F&&F!=F)return this._defaultValue;if(this._enumValues&&!(F in this._enumValues))throw new or(`Expected value to be one of ${Object.keys(this._enumValues).map((F=>JSON.stringify(F))).join(", ")}, but found ${JSON.stringify(F)} instead.`);return F}catch(F){return this._warningHistory[F.message]||(this._warningHistory[F.message]=!0,"undefined"!=typeof console&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${F.message}`)),this._defaultValue}}}function Ki(F){return Array.isArray(F)&&F.length>0&&"string"==typeof F[0]&&F[0]in hf}function Ji(F,Le,Oe,Fe){const je=new Tp(hf,[],Le?function(F){const Le={color:hd,string:Wu,number:Zu,enum:Wu,boolean:Xu,formatted:vd,resolvedImage:Bd};return"array"===F.type?Ge(Le[F.value]||_d,F.length):Le[F.type]}(Le):void 0,void 0,void 0,Oe,Fe),qe=je.parse(F,void 0,void 0,void 0,Le&&"string"===Le.type?{typeAnnotation:"coerce"}:void 0);return qe?Di(new Wi(qe,Le,Oe,Fe)):Ri(je.errors)}class Qi{constructor(F,Le,Oe,Fe){this.kind=F,this._styleExpression=Le,this.isLightConstant=Oe,this.isLineProgressConstant=Fe,this.isStateDependent="constant"!==F&&!Vn(Le.expression),this.configDependencies=Cn(Le.expression)}evaluateWithoutErrorHandling(F,Le,Oe,Fe,je,qe){return this._styleExpression.evaluateWithoutErrorHandling(F,Le,Oe,Fe,je,qe)}evaluate(F,Le,Oe,Fe,je,qe){return this._styleExpression.evaluate(F,Le,Oe,Fe,je,qe)}}class ts{constructor(F,Le,Oe,Fe,je,qe){this.kind=F,this.zoomStops=Oe,this._styleExpression=Le,this.isStateDependent="camera"!==F&&!Vn(Le.expression),this.isLightConstant=je,this.isLineProgressConstant=qe,this.configDependencies=Cn(Le.expression),this.interpolationType=Fe}evaluateWithoutErrorHandling(F,Le,Oe,Fe,je,qe){return this._styleExpression.evaluateWithoutErrorHandling(F,Le,Oe,Fe,je,qe)}evaluate(F,Le,Oe,Fe,je,qe){return this._styleExpression.evaluate(F,Le,Oe,Fe,je,qe)}interpolationFactor(F,Le,Oe){return this.interpolationType?ai.interpolationFactor(this.interpolationType,F,Le,Oe):0}}function es(F,Le,Oe,Fe){if("error"===(F=Ji(F,Le,Oe,Fe)).result)return F;const je=F.value.expression,qe=Bn(je);if(!qe&&!Fi(Le))return Ri([new Ve("","data expressions not supported")]);const He=Dn(je,["zoom","pitch","distance-from-center"]);if(!He&&!Ni(Le))return Ri([new Ve("","zoom expressions not supported")]);const xt=Dn(je,["measure-light"]);if(!xt&&!Oi(Le))return Ri([new Ve("","measure-light expression not supported")]);const jt=Dn(je,["line-progress"]);if(!jt&&!function(F){return Li(F.expression,"line-progress")}(Le))return Ri([new Ve("","line-progress expression not supported")]);const Gt=Le.expression&&Le.expression.relaxZoomRestriction,bi=ns(je);return bi||He||Gt?bi instanceof Ve?Ri([bi]):bi instanceof ai&&!Ui(Le)?Ri([new Ve("",'"interpolate" expressions cannot be used with this property')]):Di(bi?new ts(qe&&jt?"camera":"composite",F.value,bi.labels,bi instanceof ai?bi.interpolation:void 0,xt,jt):new Qi(qe&&jt?"constant":"source",F.value,xt,jt)):Ri([new Ve("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class rs{constructor(F,Le){this._parameters=F,this._specification=Le,Be(this,$i(this._parameters,this._specification))}static deserialize(F){return new rs(F._parameters,F._specification)}static serialize(F){return{_parameters:F._parameters,_specification:F._specification}}}function ns(F){let Le=null;if(F instanceof ui)Le=ns(F.result);else if(F instanceof li){for(const Oe of F.args)if(Le=ns(Oe),Le)break}else(F instanceof Un||F instanceof ai)&&F.input instanceof gr&&"zoom"===F.input.name&&(Le=F);return Le instanceof Ve||F.eachChild((F=>{const Oe=ns(F);Oe instanceof Ve?Le=Oe:Le&&Oe&&Le!==Oe&&(Le=new Ve("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),Le}var uf,df,pf=function(){if(df)return uf;df=1,uf=e;var Le=3;function e(Oe,Fe,je){var qe=(this||F).cells=[];if(Oe instanceof ArrayBuffer){(this||F).arrayBuffer=Oe;var He=new Int32Array((this||F).arrayBuffer);Oe=He[0],(this||F).d=(Fe=He[1])+2*(je=He[2]);for(var xt=0;xt<(this||F).d*(this||F).d;xt++){var jt=He[Le+xt],Gt=He[Le+xt+1];qe.push(jt===Gt?null:He.subarray(jt,Gt))}var bi=He[Le+qe.length+1];(this||F).keys=He.subarray(He[Le+qe.length],bi),(this||F).bboxes=He.subarray(bi),(this||F).insert=(this||F)._insertReadonly}else{(this||F).d=Fe+2*je;for(var wi=0;wi<(this||F).d*(this||F).d;wi++)qe.push([]);(this||F).keys=[],(this||F).bboxes=[]}(this||F).n=Fe,(this||F).extent=Oe,(this||F).padding=je,(this||F).scale=Fe/Oe,(this||F).uid=0;var qr=je/Fe*Oe;(this||F).min=-qr,(this||F).max=Oe+qr}return e.prototype.insert=function(Le,Oe,Fe,je,qe){this._forEachCell(Oe,Fe,je,qe,(this||F)._insertCell,(this||F).uid++),(this||F).keys.push(Le),(this||F).bboxes.push(Oe),(this||F).bboxes.push(Fe),(this||F).bboxes.push(je),(this||F).bboxes.push(qe)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(Le,Oe,Fe,je,qe,He){(this||F).cells[qe].push(He)},e.prototype.query=function(Le,Oe,Fe,je,qe){var He=(this||F).min,xt=(this||F).max;if(Le<=He&&Oe<=He&&xt<=Fe&&xt<=je&&!qe)return Array.prototype.slice.call((this||F).keys);var jt=[];return this._forEachCell(Le,Oe,Fe,je,(this||F)._queryCell,jt,{},qe),jt},e.prototype._queryCell=function(Le,Oe,Fe,je,qe,He,xt,jt){var Gt=(this||F).cells[qe];if(null!==Gt)for(var bi=(this||F).keys,wi=(this||F).bboxes,qr=0;qr<Gt.length;qr++){var Xn=Gt[qr];if(void 0===xt[Xn]){var Yn=4*Xn;(jt?jt(wi[Yn+0],wi[Yn+1],wi[Yn+2],wi[Yn+3]):Le<=wi[Yn+2]&&Oe<=wi[Yn+3]&&Fe>=wi[Yn+0]&&je>=wi[Yn+1])?(xt[Xn]=!0,He.push(bi[Xn])):xt[Xn]=!1}}},e.prototype._forEachCell=function(Le,Oe,Fe,je,qe,He,xt,jt){for(var Gt=this._convertToCellCoord(Le),bi=this._convertToCellCoord(Oe),wi=this._convertToCellCoord(Fe),qr=this._convertToCellCoord(je),Xn=Gt;Xn<=wi;Xn++)for(var Yn=bi;Yn<=qr;Yn++){var yo=(this||F).d*Yn+Xn;if((!jt||jt(this._convertFromCellCoord(Xn),this._convertFromCellCoord(Yn),this._convertFromCellCoord(Xn+1),this._convertFromCellCoord(Yn+1)))&&qe.call(this||F,Le,Oe,Fe,je,yo,He,xt,jt))return}},e.prototype._convertFromCellCoord=function(Le){return(Le-(this||F).padding)/(this||F).scale},e.prototype._convertToCellCoord=function(Le){return Math.max(0,Math.min((this||F).d-1,Math.floor(Le*(this||F).scale)+(this||F).padding))},e.prototype.toArrayBuffer=function(){if((this||F).arrayBuffer)return(this||F).arrayBuffer;for(var Oe=(this||F).cells,Fe=Le+(this||F).cells.length+1+1,je=0,qe=0;qe<(this||F).cells.length;qe++)je+=(this||F).cells[qe].length;var He=new Int32Array(Fe+je+(this||F).keys.length+(this||F).bboxes.length);He[0]=(this||F).extent,He[1]=(this||F).n,He[2]=(this||F).padding;for(var xt=Fe,jt=0;jt<Oe.length;jt++){var Gt=Oe[jt];He[Le+jt]=xt,He.set(Gt,xt),xt+=Gt.length}return He[Le+Oe.length]=xt,He.set((this||F).keys,xt),He[Le+Oe.length+1]=xt+=(this||F).keys.length,He.set((this||F).bboxes,xt),xt+=(this||F).bboxes.length,He.buffer},uf}(),ff=e(pf);const mf={};function us(F,Le,Oe={}){Object.defineProperty(F,"_classRegistryKey",{value:Le,writable:!1}),mf[Le]={klass:F,omit:Oe.omit||[]}}us(Object,"Object"),ff.serialize=function(F,Le){const Oe=F.toArrayBuffer();return Le&&Le.add(Oe),{buffer:Oe}},ff.deserialize=function(F){return new ff(F.buffer)},Object.defineProperty(ff,"name",{value:"Grid"}),us(ff,"Grid"),"undefined"!=typeof DOMMatrix&&us(DOMMatrix,"DOMMatrix"),us(Se,"Color"),us(Error,"Error"),us(Qe,"Formatted"),us(Je,"FormattedSection"),us(te,"AJAXError"),us(er,"ResolvedImage"),us(rs,"StylePropertyFunction"),us(Wi,"StyleExpression",{omit:["_evaluator"]}),us(we,"ImageId"),us(tr,"ImageVariant"),us(ts,"ZoomDependentExpression"),us(Qi,"ZoomConstantExpression"),us(gr,"CompoundExpression",{omit:["_evaluate"]});for(const F in hf)mf[hf[F]._classRegistryKey]||us(hf[F],`Expression${F}`);function cs(F){return F&&"undefined"!=typeof ArrayBuffer&&(F instanceof ArrayBuffer||F.constructor&&"ArrayBuffer"===F.constructor.name)}function hs(F){return self.ImageBitmap&&F instanceof ImageBitmap}function ps(F,Le){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp)return F;if(cs(F)||hs(F))return Le&&Le.add(F),F;if(ArrayBuffer.isView(F))return Le&&Le.add(F.buffer),F;if(F instanceof ImageData)return Le&&Le.add(F.data.buffer),F;if(Array.isArray(F)){const Oe=[];for(const Fe of F)Oe.push(ps(Fe,Le));return Oe}if(F instanceof Map){const Le={$name:"Map",entries:[]};for(const[Oe,Fe]of F.entries())Le.entries.push(ps(Oe),ps(Fe));return Le}if(F instanceof Set){const Le={$name:"Set"};let Oe=0;for(const Fe of F.values())Le[++Oe]=ps(Fe);return Le}if(F instanceof DOMMatrix){const Le={$name:"DOMMatrix"},Oe=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const Fe of Oe)Le[Fe]=F[Fe];return Le}if("bigint"==typeof F)return{$name:"BigInt",value:F.toString()};if("object"==typeof F){const Oe=F.constructor,Fe=Oe._classRegistryKey;if(!Fe)throw new Error(`Can't serialize object of unregistered class "${Oe.name}".`);const je=Oe.serialize?Oe.serialize(F,Le):{};if(!Oe.serialize){for(const Oe in F)F.hasOwnProperty(Oe)&&(mf[Fe].omit.indexOf(Oe)>=0||(je[Oe]=ps(F[Oe],Le)));F instanceof Error&&(je.message=F.message)}if(je.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==Fe&&(je.$name=Fe),je}throw new Error("can't serialize object of type "+typeof F)}function fs(F){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp||cs(F)||hs(F)||ArrayBuffer.isView(F)||F instanceof ImageData)return F;if(Array.isArray(F))return F.map(fs);if("object"==typeof F){const Le=F.$name||"Object";if("Map"===Le){const Le=F.entries||[],Oe=new Map;for(let F=0;F<Le.length;F+=2)Oe.set(fs(Le[F]),fs(Le[F+1]));return Oe}if("Set"===Le){const Le=new Set;for(const Oe of Object.keys(F))"$name"!==Oe&&Le.add(fs(F[Oe]));return Le}if("DOMMatrix"===Le){let Le;return Le=F.is2D?[F.a,F.b,F.c,F.d,F.e,F.f]:[F.m11,F.m12,F.m13,F.m14,F.m21,F.m22,F.m23,F.m24,F.m31,F.m32,F.m33,F.m34,F.m41,F.m42,F.m43,F.m44],new DOMMatrix(Le)}if("BigInt"===Le)return BigInt(F.value);const{klass:Oe}=mf[Le];if(!Oe)throw new Error(`Can't deserialize unregistered class "${Le}".`);if(Oe.deserialize)return Oe.deserialize(F);const Fe=Object.create(Oe.prototype);for(const Le of Object.keys(F))"$name"!==Le&&(Fe[Le]=fs(F[Le]));return Fe}throw new Error("can't deserialize object of type "+typeof F)}const gf={"Latin-1 Supplement":F=>F>=128&&F<=255,Arabic:F=>F>=1536&&F<=1791,"Arabic Supplement":F=>F>=1872&&F<=1919,"Arabic Extended-A":F=>F>=2208&&F<=2303,"Hangul Jamo":F=>F>=4352&&F<=4607,"Unified Canadian Aboriginal Syllabics":F=>F>=5120&&F<=5759,Khmer:F=>F>=6016&&F<=6143,"Unified Canadian Aboriginal Syllabics Extended":F=>F>=6320&&F<=6399,"General Punctuation":F=>F>=8192&&F<=8303,"Letterlike Symbols":F=>F>=8448&&F<=8527,"Number Forms":F=>F>=8528&&F<=8591,"Miscellaneous Technical":F=>F>=8960&&F<=9215,"Control Pictures":F=>F>=9216&&F<=9279,"Optical Character Recognition":F=>F>=9280&&F<=9311,"Enclosed Alphanumerics":F=>F>=9312&&F<=9471,"Geometric Shapes":F=>F>=9632&&F<=9727,"Miscellaneous Symbols":F=>F>=9728&&F<=9983,"Miscellaneous Symbols and Arrows":F=>F>=11008&&F<=11263,"CJK Radicals Supplement":F=>F>=11904&&F<=12031,"Kangxi Radicals":F=>F>=12032&&F<=12255,"Ideographic Description Characters":F=>F>=12272&&F<=12287,"CJK Symbols and Punctuation":F=>F>=12288&&F<=12351,Hiragana:F=>F>=12352&&F<=12447,Katakana:F=>F>=12448&&F<=12543,Bopomofo:F=>F>=12544&&F<=12591,"Hangul Compatibility Jamo":F=>F>=12592&&F<=12687,Kanbun:F=>F>=12688&&F<=12703,"Bopomofo Extended":F=>F>=12704&&F<=12735,"CJK Strokes":F=>F>=12736&&F<=12783,"Katakana Phonetic Extensions":F=>F>=12784&&F<=12799,"Enclosed CJK Letters and Months":F=>F>=12800&&F<=13055,"CJK Compatibility":F=>F>=13056&&F<=13311,"CJK Unified Ideographs Extension A":F=>F>=13312&&F<=19903,"Yijing Hexagram Symbols":F=>F>=19904&&F<=19967,"CJK Unified Ideographs":F=>F>=19968&&F<=40959,"Yi Syllables":F=>F>=40960&&F<=42127,"Yi Radicals":F=>F>=42128&&F<=42191,"Hangul Jamo Extended-A":F=>F>=43360&&F<=43391,"Hangul Syllables":F=>F>=44032&&F<=55215,"Hangul Jamo Extended-B":F=>F>=55216&&F<=55295,"Private Use Area":F=>F>=57344&&F<=63743,"CJK Compatibility Ideographs":F=>F>=63744&&F<=64255,"Arabic Presentation Forms-A":F=>F>=64336&&F<=65023,"Vertical Forms":F=>F>=65040&&F<=65055,"CJK Compatibility Forms":F=>F>=65072&&F<=65103,"Small Form Variants":F=>F>=65104&&F<=65135,"Arabic Presentation Forms-B":F=>F>=65136&&F<=65279,"Halfwidth and Fullwidth Forms":F=>F>=65280&&F<=65519,Osage:F=>F>=66736&&F<=66815,"CJK Unified Ideographs Extension B":F=>F>=131072&&F<=173791};function ms(F){for(const Le of F)if(xs(Le.charCodeAt(0)))return!0;return!1}function ys(F){for(const Le of F)if(!gs(Le.charCodeAt(0)))return!1;return!0}function gs(F){return!(gf.Arabic(F)||gf["Arabic Supplement"](F)||gf["Arabic Extended-A"](F)||gf["Arabic Presentation Forms-A"](F)||gf["Arabic Presentation Forms-B"](F))}function xs(F){return!(746!==F&&747!==F&&(F<4352||!(gf["Bopomofo Extended"](F)||gf.Bopomofo(F)||gf["CJK Compatibility Forms"](F)&&!(F>=65097&&F<=65103)||gf["CJK Compatibility Ideographs"](F)||gf["CJK Compatibility"](F)||gf["CJK Radicals Supplement"](F)||gf["CJK Strokes"](F)||!(!gf["CJK Symbols and Punctuation"](F)||F>=12296&&F<=12305||F>=12308&&F<=12319||12336===F)||gf["CJK Unified Ideographs Extension A"](F)||gf["CJK Unified Ideographs"](F)||gf["Enclosed CJK Letters and Months"](F)||gf["Hangul Compatibility Jamo"](F)||gf["Hangul Jamo Extended-A"](F)||gf["Hangul Jamo Extended-B"](F)||gf["Hangul Jamo"](F)||gf["Hangul Syllables"](F)||gf.Hiragana(F)||gf["Ideographic Description Characters"](F)||gf.Kanbun(F)||gf["Kangxi Radicals"](F)||gf["Katakana Phonetic Extensions"](F)||gf.Katakana(F)&&12540!==F||!(!gf["Halfwidth and Fullwidth Forms"](F)||65288===F||65289===F||65293===F||F>=65306&&F<=65310||65339===F||65341===F||65343===F||F>=65371&&F<=65503||65507===F||F>=65512&&F<=65519)||!(!gf["Small Form Variants"](F)||F>=65112&&F<=65118||F>=65123&&F<=65126)||gf["Unified Canadian Aboriginal Syllabics"](F)||gf["Unified Canadian Aboriginal Syllabics Extended"](F)||gf["Vertical Forms"](F)||gf["Yijing Hexagram Symbols"](F)||gf["Yi Syllables"](F)||gf["Yi Radicals"](F))))}function vs(F){return!(xs(F)||function(F){return!!(gf["Latin-1 Supplement"](F)&&(167===F||169===F||174===F||177===F||188===F||189===F||190===F||215===F||247===F)||gf["General Punctuation"](F)&&(8214===F||8224===F||8225===F||8240===F||8241===F||8251===F||8252===F||8258===F||8263===F||8264===F||8265===F||8273===F)||gf["Letterlike Symbols"](F)||gf["Number Forms"](F)||gf["Miscellaneous Technical"](F)&&(F>=8960&&F<=8967||F>=8972&&F<=8991||F>=8996&&F<=9e3||9003===F||F>=9085&&F<=9114||F>=9150&&F<=9165||9167===F||F>=9169&&F<=9179||F>=9186&&F<=9215)||gf["Control Pictures"](F)&&9251!==F||gf["Optical Character Recognition"](F)||gf["Enclosed Alphanumerics"](F)||gf["Geometric Shapes"](F)||gf["Miscellaneous Symbols"](F)&&!(F>=9754&&F<=9759)||gf["Miscellaneous Symbols and Arrows"](F)&&(F>=11026&&F<=11055||F>=11088&&F<=11097||F>=11192&&F<=11243)||gf["CJK Symbols and Punctuation"](F)||gf.Katakana(F)||gf["Private Use Area"](F)||gf["CJK Compatibility Forms"](F)||gf["Small Form Variants"](F)||gf["Halfwidth and Fullwidth Forms"](F)||8734===F||8756===F||8757===F||F>=9984&&F<=10087||F>=10102&&F<=10131||65532===F||65533===F)}(F))}function bs(F){return gf.Arabic(F)||gf["Arabic Supplement"](F)||gf["Arabic Extended-A"](F)||gf["Arabic Presentation Forms-A"](F)||gf["Arabic Presentation Forms-B"](F)}function _s(F){return F>=1424&&F<=2303||gf["Arabic Presentation Forms-A"](F)||gf["Arabic Presentation Forms-B"](F)}function ws(F,Le){return!(!Le&&_s(F)||F>=2304&&F<=3583||F>=3840&&F<=4255||gf.Khmer(F))}function Ms(F){for(const Le of F)if(_s(Le.charCodeAt(0)))return!0;return!1}const yf="deferred",xf="loading",Tf="loaded";let Ef=null,Mf="unavailable",If=null;const ks=function(F){F&&"string"==typeof F&&F.indexOf("NetworkError")>-1&&(Mf="error"),Ef&&Ef(F)};function Ts(){Cf.fire(new ge("pluginStateChange",{pluginStatus:Mf,pluginURL:If}))}const Cf=new _e,Vs=function(){return Mf},Cs=function(){if(Mf!==yf||!If)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Mf=xf,Ts(),If&&ne({url:If},(F=>{F?ks(F):(Mf=Tf,Ts())}))},zf={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Mf===Tf||null!=zf.applyArabicShaping,isLoading:()=>Mf===xf,setState(F){Mf=F.pluginStatus,If=F.pluginURL},isParsed:()=>null!=zf.applyArabicShaping&&null!=zf.processBidirectionalText&&null!=zf.processStyledBidirectionalText,getPluginURL:()=>If};class Rs{constructor(F,Le){this.zoom=F,Le?(this.now=Le.now,this.fadeDuration=Le.fadeDuration,this.transition=Le.transition,this.pitch=Le.pitch,this.brightness=Le.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(F){return function(F,Le){for(const Oe of F)if(!ws(Oe.charCodeAt(0),Le))return!1;return!0}(F,zf.isLoaded())}}class Ls{constructor(F,Le,Oe,Fe){this.property=F,this.value=Le,this.expression=function(F,Le,Oe,Fe){if(ji(F))return new rs(F,Le);if(Ki(F)||Array.isArray(F)&&F.length>0){const je=es(F,Le,Oe,Fe);if("error"===je.result)throw new Error(je.value.map((F=>`${F.key}: ${F.message}`)).join(", "));return je.value}{let Oe=F;return"string"==typeof F&&"color"===Le.type&&(Oe=Se.parse(F)),{kind:"constant",configDependencies:new Set,evaluate:()=>Oe}}}(void 0===Le?F.specification.default:Le,F.specification,Oe,Fe)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(F,Le,Oe){return this.property.possiblyEvaluate(this,F,Le,Oe)}}class Fs{constructor(F,Le,Oe){this.property=F,this.value=new Ls(F,void 0,Le,Oe)}transitioned(F,Le){return new Ns(this.property,this.value,Le,nt({},F.transition,this.transition),F.now)}untransitioned(){return new Ns(this.property,this.value,null,{},0)}}class Os{constructor(F,Le,Oe){this._properties=F,this._values=Object.create(F.defaultTransitionablePropertyValues),this._scope=Le,this._options=Oe,this.configDependencies=new Set}getValue(F){return ct(this._values[F].value.value)}setValue(F,Le){this._values.hasOwnProperty(F)||(this._values[F]=new Fs(this._values[F].property,this._scope,this._options)),this._values[F].value=new Ls(this._values[F].property,null===Le?void 0:ct(Le),this._scope,this._options),this._values[F].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].value.expression.configDependencies]))}setTransitionOrValue(F,Le){Le&&(this._options=Le);const Oe=this._properties.properties;if(F)for(const Le in F){const Fe=F[Le];if(Le.endsWith("-transition")){const F=Le.slice(0,-11);Oe[F]&&this.setTransition(F,Fe)}else Oe.hasOwnProperty(Le)&&this.setValue(Le,Fe)}}getTransition(F){return ct(this._values[F].transition)}setTransition(F,Le){this._values.hasOwnProperty(F)||(this._values[F]=new Fs(this._values[F].property)),this._values[F].transition=ct(Le)||void 0}serialize(){const F={};for(const Le of Object.keys(this._values)){const Oe=this.getValue(Le);void 0!==Oe&&(F[Le]=Oe);const Fe=this.getTransition(Le);void 0!==Fe&&(F[`${Le}-transition`]=Fe)}return F}transitioned(F,Le){const Oe=new Us(this._properties);for(const Fe of Object.keys(this._values))Oe._values[Fe]=this._values[Fe].transitioned(F,Le._values[Fe]);return Oe}untransitioned(){const F=new Us(this._properties);for(const Le of Object.keys(this._values))F._values[Le]=this._values[Le].untransitioned();return F}}class Ns{constructor(F,Le,Oe,Fe,je){const qe=Fe.delay||0,He=Fe.duration||0;je=je||0,this.property=F,this.value=Le,this.begin=je+qe,this.end=this.begin+He,F.specification.transition&&(Fe.delay||Fe.duration)&&(this.prior=Oe)}possiblyEvaluate(F,Le,Oe){const Fe=F.now||0,je=this.value.possiblyEvaluate(F,Le,Oe),qe=this.prior;if(qe){if(Fe>this.end)return this.prior=null,je;if(this.value.isDataDriven())return this.prior=null,je;if(Fe<this.begin)return qe.possiblyEvaluate(F,Le,Oe);{const He=(Fe-this.begin)/(this.end-this.begin);return this.property.interpolate(qe.possiblyEvaluate(F,Le,Oe),je,W(He))}}return je}}class Us{constructor(F){this._properties=F,this._values=Object.create(F.defaultTransitioningPropertyValues)}possiblyEvaluate(F,Le,Oe){const Fe=new $s(this._properties);for(const je of Object.keys(this._values))Fe._values[je]=this._values[je].possiblyEvaluate(F,Le,Oe);return Fe}hasTransition(){for(const F of Object.keys(this._values))if(this._values[F].prior)return!0;return!1}}class js{constructor(F,Le,Oe){this._properties=F,this._values=Object.create(F.defaultPropertyValues),this._scope=Le,this._options=Oe,this.configDependencies=new Set}getValue(F){return ct(this._values[F].value)}setValue(F,Le){this._values[F]=new Ls(this._values[F].property,null===Le?void 0:ct(Le),this._scope,this._options),this._values[F].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].expression.configDependencies]))}serialize(){const F={};for(const Le of Object.keys(this._values)){const Oe=this.getValue(Le);void 0!==Oe&&(F[Le]=Oe)}return F}possiblyEvaluate(F,Le,Oe){const Fe=new $s(this._properties);for(const je of Object.keys(this._values))Fe._values[je]=this._values[je].possiblyEvaluate(F,Le,Oe);return Fe}}class qs{constructor(F,Le,Oe){this.property=F,this.value=Le,this.parameters=Oe}isConstant(){return"constant"===this.value.kind}constantOr(F){return"constant"===this.value.kind?this.value.value:F}evaluate(F,Le,Oe,Fe){return this.property.evaluate(this.value,this.parameters,F,Le,Oe,Fe)}}class $s{constructor(F){this._properties=F,this._values=Object.create(F.defaultPossiblyEvaluatedValues)}get(F){return this._values[F]}}class Gs{constructor(F){this.specification=F}possiblyEvaluate(F,Le){return F.expression.evaluate(Le)}interpolate(F,Le,Oe){const Fe=Fu[this.specification.type];return Fe?Fe(F,Le,Oe):F}}class Ys{constructor(F,Le){this.specification=F,this.overrides=Le}possiblyEvaluate(F,Le,Oe,Fe){return new qs(this,"constant"===F.expression.kind||"camera"===F.expression.kind?{kind:"constant",value:F.expression.evaluate(Le,null,{},Oe,Fe)}:F.expression,Le)}interpolate(F,Le,Oe){if("constant"!==F.value.kind||"constant"!==Le.value.kind)return F;if(void 0===F.value.value||void 0===Le.value.value)return new qs(this,{kind:"constant",value:void 0},F.parameters);const Fe=Fu[this.specification.type];return Fe?new qs(this,{kind:"constant",value:Fe(F.value.value,Le.value.value,Oe)},F.parameters):F}evaluate(F,Le,Oe,Fe,je,qe){return"constant"===F.kind?F.value:F.evaluate(Le,Oe,Fe,je,qe)}}class Hs{constructor(F){this.specification=F}possiblyEvaluate(F,Le,Oe,Fe){return!!F.expression.evaluate(Le,null,{},Oe,Fe)}interpolate(){return!1}}class Xs{constructor(F){this.properties=F,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const Le=new Rs(0,{});for(const Oe in F){const Fe=F[Oe];Fe.specification.overridable&&this.overridableProperties.push(Oe);const je=this.defaultPropertyValues[Oe]=new Ls(Fe,void 0),qe=this.defaultTransitionablePropertyValues[Oe]=new Fs(Fe);this.defaultTransitioningPropertyValues[Oe]=qe.untransitioned(),this.defaultPossiblyEvaluatedValues[Oe]=je.possiblyEvaluate(Le)}}}us(Ys,"DataDrivenProperty"),us(Gs,"DataConstantProperty"),us(Hs,"ColorRampProperty");var Df=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"iconsets":{"experimental":true,"type":"iconsets"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"required":true,"type":"enum","values":{"sprite":1}},"url":{"required":true,"type":"string"}},"iconset_source":{"type":{"required":true,"type":"enum","values":{"source":1}},"source":{"required":true,"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","experimental":true,"private":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","experimental":true,"private":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"experimental":true,"private":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function Ws(F){return F instanceof Number||F instanceof String||F instanceof Boolean?F.valueOf():F}function Ks(F){if(Array.isArray(F))return F.map(Ks);if(F instanceof Object&&!(F instanceof Number||F instanceof String||F instanceof Boolean)){const Le={};for(const Oe in F)Le[Oe]=Ks(F[Oe]);return Le}return Ws(F)}function Js(F){if(!0===F||!1===F)return!0;if(!Array.isArray(F)||0===F.length)return!1;switch(F[0]){case"has":return F.length>=2&&"$id"!==F[1]&&"$type"!==F[1];case"in":return F.length>=3&&("string"!=typeof F[1]||Array.isArray(F[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==F.length||Array.isArray(F[1])||Array.isArray(F[2]);case"any":case"all":for(const Le of F.slice(1))if(!Js(Le)&&"boolean"!=typeof Le)return!1;return!0;default:return!0}}function Qs(F,Le="",Oe=null,Fe="fill"){if(null==F)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Js(F)||(F=aa(F));const je=F;let qe=!0;try{qe=function(F){if(!ra(F))return F;let Le=Ks(F);return ea(Le),Le=ta(Le),Le}(je)}catch(F){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(je,null,2)}\n        `)}let He=null,xt=null;if("background"!==Fe&&"sky"!==Fe&&"slot"!==Fe){xt=Df[`filter_${Fe}`];const F=Ji(qe,xt,Le,Oe);if("error"===F.result)throw new Error(F.value.map((F=>`${F.key}: ${F.message}`)).join(", "));He=(Le,Oe,Fe)=>F.value.evaluate(Le,Oe,{},Fe)}let jt=null,Gt=null;if(qe!==je){const F=Ji(je,xt,Le,Oe);if("error"===F.result)throw new Error(F.value.map((F=>`${F.key}: ${F.message}`)).join(", "));jt=(Le,Oe,Fe,je,qe)=>F.value.evaluate(Le,Oe,{},Fe,void 0,void 0,je,qe),Gt=!Bn(F.value.expression)}return{filter:He,dynamicFilter:jt||void 0,needGeometry:sa(qe),needFeature:!!Gt}}function ta(F){if(!Array.isArray(F))return F;const Le=function(F){if(Of.has(F[0]))for(let Le=1;Le<F.length;Le++)if(ra(F[Le]))return!0;return F}(F);return!0===Le?Le:Le.map((F=>ta(F)))}function ea(F){let Le=!1;const Oe=[];if("case"===F[0]){for(let Fe=1;Fe<F.length-1;Fe+=2)Le=Le||ra(F[Fe]),Oe.push(F[Fe+1]);Oe.push(F[F.length-1])}else if("match"===F[0]){Le=Le||ra(F[1]);for(let Le=2;Le<F.length-1;Le+=2)Oe.push(F[Le+1]);Oe.push(F[F.length-1])}else if("step"===F[0]){Le=Le||ra(F[1]);for(let Le=1;Le<F.length-1;Le+=2)Oe.push(F[Le+1])}Le&&(F.length=0,F.push("any",...Oe));for(let Le=1;Le<F.length;Le++)ea(F[Le])}function ra(F){if(!Array.isArray(F))return!1;if("pitch"===(Le=F[0])||"distance-from-center"===Le)return!0;var Le;for(let Le=1;Le<F.length;Le++)if(ra(F[Le]))return!0;return!1}const Of=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function ia(F,Le){return F<Le?-1:F>Le?1:0}function sa(F){if(!Array.isArray(F))return!1;if("within"===F[0]||"distance"===F[0])return!0;for(let Le=1;Le<F.length;Le++)if(sa(F[Le]))return!0;return!1}function aa(F){if(!F)return!0;const Le=F[0];return F.length<=1?"any"!==Le:"=="===Le?oa(F[1],F[2],"=="):"!="===Le?ca(oa(F[1],F[2],"==")):"<"===Le||">"===Le||"<="===Le||">="===Le?oa(F[1],F[2],Le):"any"===Le?(Oe=F.slice(1),["any"].concat(Oe.map(aa))):"all"===Le?["all"].concat(F.slice(1).map(aa)):"none"===Le?["all"].concat(F.slice(1).map(aa).map(ca)):"in"===Le?la(F[1],F.slice(2)):"!in"===Le?ca(la(F[1],F.slice(2))):"has"===Le?ua(F[1]):"!has"!==Le||ca(ua(F[1]));var Oe}function oa(F,Le,Oe){switch(F){case"$type":return[`filter-type-${Oe}`,Le];case"$id":return[`filter-id-${Oe}`,Le];default:return[`filter-${Oe}`,F,Le]}}function la(F,Le){if(0===Le.length)return!1;switch(F){case"$type":return["filter-type-in",["literal",Le]];case"$id":return["filter-id-in",["literal",Le]];default:return Le.length>200&&!Le.some((F=>typeof F!=typeof Le[0]))?["filter-in-large",F,["literal",Le.sort(ia)]]:["filter-in-small",F,["literal",Le]]}}function ua(F){switch(F){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",F]}}function ca(F){return["!",F]}const kf="";function pa(F,Le){return Le?`${F}${kf}${Le}`:F}const Nf="-transition",Gf=new Set(["fill","line","background","hillshade","raster"]);class ma extends _e{constructor(F,Le,Oe,Fe,je){if(super(),this.id=F.id,this.fqid=pa(this.id,Oe),this.type=F.type,this.scope=Oe,this.lut=Fe,this.options=je,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==F.type){if(this.metadata=F.metadata,this.minzoom=F.minzoom,this.maxzoom=F.maxzoom,F.type&&"background"!==F.type&&"sky"!==F.type&&"slot"!==F.type){this.source=F.source,this.sourceLayer=F["source-layer"],this.filter=F.filter;const Le=Ji(this.filter,Df[`filter_${F.type}`]);"error"!==Le.result&&(this.configDependencies=new Set([...this.configDependencies,...Le.value.configDependencies]))}if(F.slot&&(this.slot=F.slot),Le.layout&&(this._unevaluatedLayout=new js(Le.layout,this.scope,je),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),Le.paint){this._transitionablePaint=new Os(Le.paint,this.scope,je);for(const Le in F.paint)this.setPaintProperty(Le,F.paint[Le]);for(const Le in F.layout)this.setLayoutProperty(Le,F.layout[Le]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new $s(Le.paint)}}}onAdd(F){}onRemove(F){}isDraped(F){return!this.is3D(!0)&&Gf.has(this.type)}getLayoutProperty(F){return"visibility"===F?this.visibility:this._unevaluatedLayout.getValue(F)}setLayoutProperty(F,Le){if("custom"===this.type&&"visibility"===F)return void(this.visibility=Le);const Oe=this._unevaluatedLayout;Oe._properties.properties[F]&&(Oe.setValue(F,Le),this.configDependencies=new Set([...this.configDependencies,...Oe.configDependencies]),"visibility"===F&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(F){return F.endsWith(Nf)?this._transitionablePaint.getTransition(F.slice(0,-11)):this._transitionablePaint.getValue(F)}setPaintProperty(F,Le){const Oe=this._transitionablePaint,Fe=Oe._properties.properties;if(F.endsWith(Nf)){const je=F.slice(0,-11);return Fe[je]&&Oe.setTransition(je,Le||void 0),!1}if(!Fe[F])return!1;const je=Oe._values[F],qe=je.value.isDataDriven(),He=je.value;Oe.setValue(F,Le),this.configDependencies=new Set([...this.configDependencies,...Oe.configDependencies]),this._handleSpecialPaintPropertyUpdate(F);const xt=Oe._values[F].value,jt=xt.isDataDriven(),Gt=F.endsWith("pattern")||"line-dasharray"===F;return jt||qe||Gt||this._handleOverridablePaintPropertyUpdate(F,He,xt)}_handleSpecialPaintPropertyUpdate(F){}getProgramIds(){return null}getDefaultProgramParams(F,Le,Oe){return null}_handleOverridablePaintPropertyUpdate(F,Le,Oe){return!1}isHidden(F){return!!(this.minzoom&&F<this.minzoom)||!!(this.maxzoom&&F>=this.maxzoom)||"none"===this.visibility}updateTransitions(F){this._transitioningPaint=this._transitionablePaint.transitioned(F,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(F,Le){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(F,void 0,Le)),this.paint=this._transitioningPaint.possiblyEvaluate(F,void 0,Le)}serialize(){return ut({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((F,Le)=>!(void 0===F||"layout"===Le&&!Object.keys(F).length||"paint"===Le&&!Object.keys(F).length)))}is3D(F){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const F in this.paint._values){const Le=this.paint.get(F);if(Le instanceof qs&&Fi(Le.property.specification)&&("source"===Le.value.kind||"composite"===Le.value.kind)&&Le.value.isStateDependent)return!0}return!1}compileFilter(F){this._filterCompiled||(this._featureFilter=Qs(this.filter,this.scope,F),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(F){this._stats&&("shadow"===F.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(F){}queryIntersectsFeature(F,Le,Oe,Fe,je,qe,He,xt,jt){}}const $f={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ga{constructor(F,Le){this._structArray=F,this._pos1=Le*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class xa{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(F,Le){return F._trim(),Le&&(F.isTransferred=!0,Le.add(F.arrayBuffer)),{length:F.length,arrayBuffer:F.arrayBuffer}}static deserialize(F){const Le=Object.create(this.prototype);return Le.arrayBuffer=F.arrayBuffer,Le.length=F.length,Le.capacity=F.arrayBuffer.byteLength/Le.bytesPerElement,Le._refreshViews(),Le}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(F){this.reserve(F),this.length=F}reserve(F){if(F>this.capacity){this.capacity=Math.max(F,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const Le=this.uint8;this._refreshViews(),Le&&this.uint8.set(Le)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...F){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...F){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function va(F,Le=1){let Oe=0,Fe=0;return{members:F.map((F=>{const je=$f[F.type].BYTES_PER_ELEMENT,qe=Oe=ba(Oe,Math.max(Le,je)),He=F.components||1;return Fe=Math.max(Fe,je),Oe+=je*He,{name:F.name,type:F.type,components:He,offset:qe}})),size:ba(Oe,Math.max(Fe,Le)),alignment:Le}}function ba(F,Le){return Math.ceil(F/Le)*Le}class _a extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Le)}emplace(F,Le,Oe){const Fe=2*F;return this.int16[Fe+0]=Le,this.int16[Fe+1]=Oe,F}}_a.prototype.bytesPerElement=4,us(_a,"StructArrayLayout2i4");class wa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Le,Oe)}emplace(F,Le,Oe,Fe){const je=3*F;return this.int16[je+0]=Le,this.int16[je+1]=Oe,this.int16[je+2]=Fe,F}}wa.prototype.bytesPerElement=6,us(wa,"StructArrayLayout3i6");class Ma extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Le,Oe,Fe)}emplace(F,Le,Oe,Fe,je){const qe=4*F;return this.int16[qe+0]=Le,this.int16[qe+1]=Oe,this.int16[qe+2]=Fe,this.int16[qe+3]=je,F}}Ma.prototype.bytesPerElement=8,us(Ma,"StructArrayLayout4i8");class Aa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F)}emplace(F,Le){return this.float32[1*F+0]=Le,F}}Aa.prototype.bytesPerElement=4,us(Aa,"StructArrayLayout1f4");class Ia extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Le,Oe)}emplace(F,Le,Oe,Fe){const je=4*F,qe=2*F;return this.int16[je+0]=Le,this.int16[je+1]=Oe,this.float32[qe+1]=Fe,F}}Ia.prototype.bytesPerElement=8,us(Ia,"StructArrayLayout2i1f8");class Sa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Le,Oe)}emplace(F,Le,Oe,Fe){const je=4*F;return this.int16[je+0]=Le,this.int16[je+1]=Oe,this.int16[je+2]=Fe,F}}Sa.prototype.bytesPerElement=8,us(Sa,"StructArrayLayout3i8");class Pa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Le,Oe,Fe,je)}emplace(F,Le,Oe,Fe,je,qe){const He=5*F;return this.int16[He+0]=Le,this.int16[He+1]=Oe,this.int16[He+2]=Fe,this.int16[He+3]=je,this.int16[He+4]=qe,F}}Pa.prototype.bytesPerElement=10,us(Pa,"StructArrayLayout5i10");class Ea extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He){const xt=this.length;return this.resize(xt+1),this.emplace(xt,F,Le,Oe,Fe,je,qe,He)}emplace(F,Le,Oe,Fe,je,qe,He,xt){const jt=6*F,Gt=12*F,bi=3*F;return this.int16[jt+0]=Le,this.int16[jt+1]=Oe,this.uint8[Gt+4]=Fe,this.uint8[Gt+5]=je,this.uint8[Gt+6]=qe,this.uint8[Gt+7]=He,this.float32[bi+2]=xt,F}}Ea.prototype.bytesPerElement=12,us(Ea,"StructArrayLayout2i4ub1f12");class za extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Le,Oe)}emplace(F,Le,Oe,Fe){const je=3*F;return this.float32[je+0]=Le,this.float32[je+1]=Oe,this.float32[je+2]=Fe,F}}za.prototype.bytesPerElement=12,us(za,"StructArrayLayout3f12");class ka extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Le,Oe,Fe,je)}emplace(F,Le,Oe,Fe,je,qe){const He=6*F,xt=3*F;return this.uint16[He+0]=Le,this.uint16[He+1]=Oe,this.uint16[He+2]=Fe,this.uint16[He+3]=je,this.float32[xt+2]=qe,F}}ka.prototype.bytesPerElement=12,us(ka,"StructArrayLayout4ui1f12");class Ta extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Le,Oe,Fe)}emplace(F,Le,Oe,Fe,je){const qe=4*F;return this.uint16[qe+0]=Le,this.uint16[qe+1]=Oe,this.uint16[qe+2]=Fe,this.uint16[qe+3]=je,F}}Ta.prototype.bytesPerElement=8,us(Ta,"StructArrayLayout4ui8");class Ba extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe){const He=this.length;return this.resize(He+1),this.emplace(He,F,Le,Oe,Fe,je,qe)}emplace(F,Le,Oe,Fe,je,qe,He){const xt=6*F;return this.int16[xt+0]=Le,this.int16[xt+1]=Oe,this.int16[xt+2]=Fe,this.int16[xt+3]=je,this.int16[xt+4]=qe,this.int16[xt+5]=He,F}}Ba.prototype.bytesPerElement=12,us(Ba,"StructArrayLayout6i12");class Va extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi){const qr=this.length;return this.resize(qr+1),this.emplace(qr,F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi)}emplace(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr){const Xn=12*F;return this.int16[Xn+0]=Le,this.int16[Xn+1]=Oe,this.int16[Xn+2]=Fe,this.int16[Xn+3]=je,this.uint16[Xn+4]=qe,this.uint16[Xn+5]=He,this.uint16[Xn+6]=xt,this.uint16[Xn+7]=jt,this.int16[Xn+8]=Gt,this.int16[Xn+9]=bi,this.int16[Xn+10]=wi,this.int16[Xn+11]=qr,F}}Va.prototype.bytesPerElement=24,us(Va,"StructArrayLayout4i4ui4i24");class Ca extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe){const He=this.length;return this.resize(He+1),this.emplace(He,F,Le,Oe,Fe,je,qe)}emplace(F,Le,Oe,Fe,je,qe,He){const xt=10*F,jt=5*F;return this.int16[xt+0]=Le,this.int16[xt+1]=Oe,this.int16[xt+2]=Fe,this.float32[jt+2]=je,this.float32[jt+3]=qe,this.float32[jt+4]=He,F}}Ca.prototype.bytesPerElement=20,us(Ca,"StructArrayLayout3i3f20");class Da extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Le,Oe,Fe)}emplace(F,Le,Oe,Fe,je){const qe=4*F;return this.float32[qe+0]=Le,this.float32[qe+1]=Oe,this.float32[qe+2]=Fe,this.float32[qe+3]=je,F}}Da.prototype.bytesPerElement=16,us(Da,"StructArrayLayout4f16");class Ra extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F)}emplace(F,Le){return this.uint32[1*F+0]=Le,F}}Ra.prototype.bytesPerElement=4,us(Ra,"StructArrayLayout1ul4");class La extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Le)}emplace(F,Le,Oe){const Fe=2*F;return this.uint16[Fe+0]=Le,this.uint16[Fe+1]=Oe,F}}La.prototype.bytesPerElement=4,us(La,"StructArrayLayout2ui4");class Fa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr){const Xn=this.length;return this.resize(Xn+1),this.emplace(Xn,F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr)}emplace(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn){const Yn=20*F,yo=10*F;return this.int16[Yn+0]=Le,this.int16[Yn+1]=Oe,this.int16[Yn+2]=Fe,this.int16[Yn+3]=je,this.int16[Yn+4]=qe,this.float32[yo+3]=He,this.float32[yo+4]=xt,this.float32[yo+5]=jt,this.float32[yo+6]=Gt,this.int16[Yn+14]=bi,this.uint32[yo+8]=wi,this.uint16[Yn+18]=qr,this.uint16[Yn+19]=Xn,F}}Fa.prototype.bytesPerElement=40,us(Fa,"StructArrayLayout5i4f1i1ul2ui40");class Oa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He){const xt=this.length;return this.resize(xt+1),this.emplace(xt,F,Le,Oe,Fe,je,qe,He)}emplace(F,Le,Oe,Fe,je,qe,He,xt){const jt=8*F;return this.int16[jt+0]=Le,this.int16[jt+1]=Oe,this.int16[jt+2]=Fe,this.int16[jt+4]=je,this.int16[jt+5]=qe,this.int16[jt+6]=He,this.int16[jt+7]=xt,F}}Oa.prototype.bytesPerElement=16,us(Oa,"StructArrayLayout3i2i2i16");class Na extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Le,Oe,Fe,je)}emplace(F,Le,Oe,Fe,je,qe){const He=4*F,xt=8*F;return this.float32[He+0]=Le,this.float32[He+1]=Oe,this.float32[He+2]=Fe,this.int16[xt+6]=je,this.int16[xt+7]=qe,F}}Na.prototype.bytesPerElement=16,us(Na,"StructArrayLayout2f1f2i16");class Ua extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe){const He=this.length;return this.resize(He+1),this.emplace(He,F,Le,Oe,Fe,je,qe)}emplace(F,Le,Oe,Fe,je,qe,He){const xt=20*F,jt=5*F;return this.uint8[xt+0]=Le,this.uint8[xt+1]=Oe,this.float32[jt+1]=Fe,this.float32[jt+2]=je,this.float32[jt+3]=qe,this.float32[jt+4]=He,F}}Ua.prototype.bytesPerElement=20,us(Ua,"StructArrayLayout2ub4f20");class ja extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe){const Fe=this.length;return this.resize(Fe+1),this.emplace(Fe,F,Le,Oe)}emplace(F,Le,Oe,Fe){const je=3*F;return this.uint16[je+0]=Le,this.uint16[je+1]=Oe,this.uint16[je+2]=Fe,F}}ja.prototype.bytesPerElement=6,us(ja,"StructArrayLayout3ui6");class qa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs){const na=this.length;return this.resize(na+1),this.emplace(na,F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs)}emplace(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na){const el=30*F,nl=15*F,hl=60*F;return this.int16[el+0]=Le,this.int16[el+1]=Oe,this.int16[el+2]=Fe,this.float32[nl+2]=je,this.float32[nl+3]=qe,this.uint16[el+8]=He,this.uint16[el+9]=xt,this.uint32[nl+5]=jt,this.uint32[nl+6]=Gt,this.uint32[nl+7]=bi,this.uint16[el+16]=wi,this.uint16[el+17]=qr,this.uint16[el+18]=Xn,this.float32[nl+10]=Yn,this.float32[nl+11]=yo,this.uint8[hl+48]=bo,this.uint8[hl+49]=Do,this.uint8[hl+50]=Ro,this.uint32[nl+13]=zs,this.int16[el+28]=Zs,this.uint8[hl+58]=na,F}}qa.prototype.bytesPerElement=60,us(qa,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class $a extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl,ec,tc,ic,oc){const sc=this.length;return this.resize(sc+1),this.emplace(sc,F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl,ec,tc,ic,oc)}emplace(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl,ec,tc,ic,oc,sc){const ac=20*F,mc=40*F,gc=80*F;return this.float32[ac+0]=Le,this.float32[ac+1]=Oe,this.int16[mc+4]=Fe,this.int16[mc+5]=je,this.int16[mc+6]=qe,this.int16[mc+7]=He,this.int16[mc+8]=xt,this.int16[mc+9]=jt,this.int16[mc+10]=Gt,this.int16[mc+11]=bi,this.int16[mc+12]=wi,this.uint16[mc+13]=qr,this.uint16[mc+14]=Xn,this.uint16[mc+15]=Yn,this.uint16[mc+16]=yo,this.uint16[mc+17]=bo,this.uint16[mc+18]=Do,this.uint16[mc+19]=Ro,this.uint16[mc+20]=zs,this.uint16[mc+21]=Zs,this.uint16[mc+22]=na,this.uint16[mc+23]=el,this.uint16[mc+24]=nl,this.uint16[mc+25]=hl,this.uint16[mc+26]=pl,this.uint16[mc+27]=bl,this.uint32[ac+14]=Tl,this.float32[ac+15]=kl,this.float32[ac+16]=ec,this.float32[ac+17]=tc,this.float32[ac+18]=ic,this.uint8[gc+76]=oc,this.uint16[mc+39]=sc,F}}$a.prototype.bytesPerElement=80,us($a,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Ga extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je){const qe=this.length;return this.resize(qe+1),this.emplace(qe,F,Le,Oe,Fe,je)}emplace(F,Le,Oe,Fe,je,qe){const He=5*F;return this.float32[He+0]=Le,this.float32[He+1]=Oe,this.float32[He+2]=Fe,this.float32[He+3]=je,this.float32[He+4]=qe,F}}Ga.prototype.bytesPerElement=20,us(Ga,"StructArrayLayout5f20");class Ya extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He){const xt=this.length;return this.resize(xt+1),this.emplace(xt,F,Le,Oe,Fe,je,qe,He)}emplace(F,Le,Oe,Fe,je,qe,He,xt){const jt=7*F;return this.float32[jt+0]=Le,this.float32[jt+1]=Oe,this.float32[jt+2]=Fe,this.float32[jt+3]=je,this.float32[jt+4]=qe,this.float32[jt+5]=He,this.float32[jt+6]=xt,F}}Ya.prototype.bytesPerElement=28,us(Ya,"StructArrayLayout7f28");class Ha extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi){const wi=this.length;return this.resize(wi+1),this.emplace(wi,F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi)}emplace(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi){const qr=11*F;return this.float32[qr+0]=Le,this.float32[qr+1]=Oe,this.float32[qr+2]=Fe,this.float32[qr+3]=je,this.float32[qr+4]=qe,this.float32[qr+5]=He,this.float32[qr+6]=xt,this.float32[qr+7]=jt,this.float32[qr+8]=Gt,this.float32[qr+9]=bi,this.float32[qr+10]=wi,F}}Ha.prototype.bytesPerElement=44,us(Ha,"StructArrayLayout11f44");class Xa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=this.length;return this.resize(Gt+1),this.emplace(Gt,F,Le,Oe,Fe,je,qe,He,xt,jt)}emplace(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt){const bi=9*F;return this.float32[bi+0]=Le,this.float32[bi+1]=Oe,this.float32[bi+2]=Fe,this.float32[bi+3]=je,this.float32[bi+4]=qe,this.float32[bi+5]=He,this.float32[bi+6]=xt,this.float32[bi+7]=jt,this.float32[bi+8]=Gt,F}}Xa.prototype.bytesPerElement=36,us(Xa,"StructArrayLayout9f36");class Za extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le){const Oe=this.length;return this.resize(Oe+1),this.emplace(Oe,F,Le)}emplace(F,Le,Oe){const Fe=2*F;return this.float32[Fe+0]=Le,this.float32[Fe+1]=Oe,F}}Za.prototype.bytesPerElement=8,us(Za,"StructArrayLayout2f8");class Wa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe){const je=this.length;return this.resize(je+1),this.emplace(je,F,Le,Oe,Fe)}emplace(F,Le,Oe,Fe,je){const qe=6*F;return this.uint32[3*F+0]=Le,this.uint16[qe+2]=Oe,this.uint16[qe+3]=Fe,this.uint16[qe+4]=je,F}}Wa.prototype.bytesPerElement=12,us(Wa,"StructArrayLayout1ul3ui12");class Ka extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F)}emplace(F,Le){return this.uint16[1*F+0]=Le,F}}Ka.prototype.bytesPerElement=2,us(Ka,"StructArrayLayout1ui2");class Ja extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo){const bo=this.length;return this.resize(bo+1),this.emplace(bo,F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo)}emplace(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo){const Do=16*F;return this.float32[Do+0]=Le,this.float32[Do+1]=Oe,this.float32[Do+2]=Fe,this.float32[Do+3]=je,this.float32[Do+4]=qe,this.float32[Do+5]=He,this.float32[Do+6]=xt,this.float32[Do+7]=jt,this.float32[Do+8]=Gt,this.float32[Do+9]=bi,this.float32[Do+10]=wi,this.float32[Do+11]=qr,this.float32[Do+12]=Xn,this.float32[Do+13]=Yn,this.float32[Do+14]=yo,this.float32[Do+15]=bo,F}}Ja.prototype.bytesPerElement=64,us(Ja,"StructArrayLayout16f64");class Qa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,Le,Oe,Fe,je,qe,He){const xt=this.length;return this.resize(xt+1),this.emplace(xt,F,Le,Oe,Fe,je,qe,He)}emplace(F,Le,Oe,Fe,je,qe,He,xt){const jt=10*F,Gt=5*F;return this.uint16[jt+0]=Le,this.uint16[jt+1]=Oe,this.uint16[jt+2]=Fe,this.uint16[jt+3]=je,this.float32[Gt+2]=qe,this.float32[Gt+3]=He,this.float32[Gt+4]=xt,F}}Qa.prototype.bytesPerElement=20,us(Qa,"StructArrayLayout4ui3f20");class to extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F)}emplace(F,Le){return this.int16[1*F+0]=Le,F}}to.prototype.bytesPerElement=2,us(to,"StructArrayLayout1i2");class eo extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(F){const Le=this.length;return this.resize(Le+1),this.emplace(Le,F)}emplace(F,Le){return this.uint8[1*F+0]=Le,F}}eo.prototype.bytesPerElement=1,us(eo,"StructArrayLayout1ub1");class ro extends ga{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}ro.prototype.size=40;class no extends Fa{get(F){return new ro(this,F)}}us(no,"CollisionBoxArray");class io extends ga{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(F){this._structArray.uint8[this._pos1+49]=F}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(F){this._structArray.uint8[this._pos1+50]=F}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(F){this._structArray.uint32[this._pos4+13]=F}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(F){this._structArray.uint8[this._pos1+58]=F}}io.prototype.size=60;class so extends qa{get(F){return new io(this,F)}}us(so,"PlacedSymbolArray");class ao extends ga{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(F){this._structArray.uint32[this._pos4+14]=F}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(F){this._structArray.float32[this._pos4+18]=F}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}ao.prototype.size=80;class oo extends $a{get(F){return new ao(this,F)}}us(oo,"SymbolInstanceArray");class lo extends Aa{getoffsetX(F){return this.float32[1*F+0]}}us(lo,"GlyphOffsetArray");class uo extends _a{getx(F){return this.int16[2*F+0]}gety(F){return this.int16[2*F+1]}}us(uo,"SymbolLineVertexArray");class co extends ga{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}co.prototype.size=12;class ho extends Wa{get(F){return new co(this,F)}}us(ho,"FeatureIndexArray");class po extends La{geta_centroid_pos0(F){return this.uint16[2*F+0]}geta_centroid_pos1(F){return this.uint16[2*F+1]}}us(po,"FillExtrusionCentroidArray");class fo extends ga{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}fo.prototype.size=6;class mo extends wa{get(F){return new fo(this,F)}}us(mo,"FillExtrusionWallArray");const im=va([{name:"a_pos",components:2,type:"Int16"}],4),rm=va([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class xo{constructor(F=[]){this.segments=F}_prepareSegment(F,Le,Oe,Fe){let je=this.segments[this.segments.length-1];return F>xo.MAX_VERTEX_ARRAY_LENGTH&&pt(`Max vertices per segment is ${xo.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${F}`),(!je||je.vertexLength+F>xo.MAX_VERTEX_ARRAY_LENGTH||je.sortKey!==Fe)&&(je={vertexOffset:Le,primitiveOffset:Oe,vertexLength:0,primitiveLength:0},void 0!==Fe&&(je.sortKey=Fe),this.segments.push(je)),je}prepareSegment(F,Le,Oe,Fe){return this._prepareSegment(F,Le.length,Oe.length,Fe)}get(){return this.segments}destroy(){for(const F of this.segments)for(const Le in F.vaos)F.vaos[Le].destroy()}static simpleSegment(F,Le,Oe,Fe){return new xo([{vertexOffset:F,primitiveOffset:Le,vertexLength:Oe,primitiveLength:Fe,vaos:{},sortKey:0}])}}function vo(F,Le){return 256*(F=Q(Math.floor(F),0,255))+Q(Math.floor(Le),0,255)}xo.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,us(xo,"SegmentVector");const nm=va([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),sm=va([{name:"a_dash",components:4,type:"Uint16"}]);class wo{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(F,Le,Oe,Fe){this.ids.push(Mo(F)),this.positions.push(Le,Oe,Fe)}eachPosition(F,Le){const Oe=Mo(F);let Fe=0,je=this.ids.length-1;for(;Fe<je;){const F=Fe+je>>1;this.ids[F]>=Oe?je=F:Fe=F+1}for(;this.ids[Fe]===Oe;)Le(this.positions[3*Fe],this.positions[3*Fe+1],this.positions[3*Fe+2]),Fe++}static serialize(F,Le){const Oe=new Float64Array(F.ids),Fe=new Uint32Array(F.positions);return Ao(Oe,Fe,0,Oe.length-1),Le&&(Le.add(Oe.buffer),Le.add(Fe.buffer)),{ids:Oe,positions:Fe}}static deserialize(F){const Le=new wo;let Oe;Le.ids=F.ids,Le.positions=F.positions;for(const F of Le.ids)F!==Oe&&Le.uniqueIds.push(F),Oe=F;return Le.indexed=!0,Le}}function Mo(F){const Le=+F;return!isNaN(Le)&&Number.MIN_SAFE_INTEGER<=Le&&Le<=Number.MAX_SAFE_INTEGER?Le:pu(String(F))}function Ao(F,Le,Oe,Fe){for(;Oe<Fe;){const je=F[Oe+Fe>>1];let qe=Oe-1,He=Fe+1;for(;;){do{qe++}while(F[qe]<je);do{He--}while(F[He]>je);if(qe>=He)break;Io(F,qe,He),Io(Le,3*qe,3*He),Io(Le,3*qe+1,3*He+1),Io(Le,3*qe+2,3*He+2)}He-Oe<Fe-He?(Ao(F,Le,Oe,He),Oe=He+1):(Ao(F,Le,He+1,Fe),Fe=He)}}function Io(F,Le,Oe){const Fe=F[Le];F[Le]=F[Oe],F[Oe]=Fe}us(wo,"FeaturePositionMap");class So{constructor(F){this.gl=F.gl,this.initialized=!1}fetchUniformLocation(F,Le){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(F,Le),this.initialized=!0),!!this.location}set(F,Le,Oe){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class Po extends So{constructor(F){super(F),this.current=0}set(F,Le,Oe){this.fetchUniformLocation(F,Le)&&this.current!==Oe&&(this.current=Oe,this.gl.uniform1i(this.location,Oe))}}class Eo extends So{constructor(F){super(F),this.current=0}set(F,Le,Oe){this.fetchUniformLocation(F,Le)&&this.current!==Oe&&(this.current=Oe,this.gl.uniform1f(this.location,Oe))}}class zo extends So{constructor(F){super(F),this.current=[0,0]}set(F,Le,Oe){this.fetchUniformLocation(F,Le)&&(Oe[0]===this.current[0]&&Oe[1]===this.current[1]||(this.current=Oe,this.gl.uniform2f(this.location,Oe[0],Oe[1])))}}class ko extends So{constructor(F){super(F),this.current=[0,0,0]}set(F,Le,Oe){this.fetchUniformLocation(F,Le)&&(Oe[0]===this.current[0]&&Oe[1]===this.current[1]&&Oe[2]===this.current[2]||(this.current=Oe,this.gl.uniform3f(this.location,Oe[0],Oe[1],Oe[2])))}}class To extends So{constructor(F){super(F),this.current=[0,0,0,0]}set(F,Le,Oe){this.fetchUniformLocation(F,Le)&&(Oe[0]===this.current[0]&&Oe[1]===this.current[1]&&Oe[2]===this.current[2]&&Oe[3]===this.current[3]||(this.current=Oe,this.gl.uniform4f(this.location,Oe[0],Oe[1],Oe[2],Oe[3])))}}class Bo extends So{constructor(F){super(F),this.current=Se.transparent.toRenderColor(null)}set(F,Le,Oe){this.fetchUniformLocation(F,Le)&&(Oe.r===this.current.r&&Oe.g===this.current.g&&Oe.b===this.current.b&&Oe.a===this.current.a||(this.current=Oe,this.gl.uniform4f(this.location,Oe.r,Oe.g,Oe.b,Oe.a)))}}const am=new Float32Array(16);class Co extends So{constructor(F){super(F),this.current=am}set(F,Le,Oe){if(this.fetchUniformLocation(F,Le)){if(Oe[12]!==this.current[12]||Oe[0]!==this.current[0])return this.current=Oe,void this.gl.uniformMatrix4fv(this.location,!1,Oe);for(let F=1;F<16;F++)if(Oe[F]!==this.current[F]){this.current=Oe,this.gl.uniformMatrix4fv(this.location,!1,Oe);break}}}}const um=new Float32Array(9),fm=new Float32Array(4);class Lo extends So{constructor(F){super(F),this.current=fm}set(F,Le,Oe){if(this.fetchUniformLocation(F,Le))for(let F=0;F<4;F++)if(Oe[F]!==this.current[F]){this.current=Oe,this.gl.uniformMatrix2fv(this.location,!1,Oe);break}}}function Fo(F){return[vo(255*F.r,255*F.g),vo(255*F.b,255*F.a)]}class Oo{constructor(F,Le,Oe,Fe){this.value=F,this.uniformNames=Le.map((F=>`u_${F}`)),this.type=Oe,this.context=Fe}setUniform(F,Le,Oe,Fe,je){const qe=Fe.constantOr(this.value);Le.set(F,je,qe instanceof Se?qe.toRenderColor(this.lutExpression&&"none"===this.lutExpression.value?null:this.context.lut):qe)}getBinding(F,Le){return"color"===this.type?new Bo(F):new Eo(F)}}class No{constructor(F,Le){this.uniformNames=Le.map((F=>`u_${F}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(F){this.pixelRatio=F.pixelRatio||1,this.pattern=F.tl.concat(F.br)}setUniform(F,Le,Oe,Fe,je){const qe="u_pattern"===je||"u_dash"===je?this.pattern:"u_pixel_ratio"===je?this.pixelRatio:null;qe&&Le.set(F,je,qe)}getBinding(F,Le){return"u_pattern"===Le||"u_dash"===Le?new To(F):new Eo(F)}}class Uo{constructor(F,Le,Oe,Fe){this.expression=F,this.type=Oe,this.maxValue=0,this.paintVertexAttributes=Le.map((F=>({name:`a_${F}`,type:"Float32",components:"color"===Oe?2:1,offset:0}))),this.paintVertexArray=new Fe}populatePaintArray(F,Le,Oe,Fe,je,qe,He){const xt=this.paintVertexArray.length,jt="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Rs(0,{brightness:qe}),Le,{},je,Fe,He):"constant"===this.expression.kind&&this.expression.value,Gt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:qe}),Le,{},je,Fe,He):this.lutExpression.value);this.paintVertexArray.resize(F),this._setPaintValue(xt,F,jt,Gt?null:this.context.lut)}updatePaintArray(F,Le,Oe,Fe,je,qe,He){const xt="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:He},Oe,Fe,void 0,je):"constant"===this.expression.kind&&this.expression.value,jt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:He}),Oe,Fe,void 0,je):this.lutExpression.value);this._setPaintValue(F,Le,xt,jt?null:this.context.lut)}_setPaintValue(F,Le,Oe,Fe){if("color"===this.type){const je=Fo(Oe.toRenderColor(Fe));for(let Oe=F;Oe<Le;Oe++)this.paintVertexArray.emplace(Oe,je[0],je[1])}else{for(let Fe=F;Fe<Le;Fe++)this.paintVertexArray.emplace(Fe,Oe);this.maxValue=Math.max(this.maxValue,Math.abs(Oe))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class jo{constructor(F,Le,Oe,Fe,je,qe){this.expression=F,this.uniformNames=Le.map((F=>`u_${F}_t`)),this.type=Oe,this.useIntegerZoom=Fe,this.context=je,this.maxValue=0,this.paintVertexAttributes=Le.map((F=>({name:`a_${F}`,type:"Float32",components:"color"===Oe?4:2,offset:0}))),this.paintVertexArray=new qe}populatePaintArray(F,Le,Oe,Fe,je,qe,He){const xt=this.expression.evaluate(new Rs(this.context.zoom,{brightness:qe}),Le,{},je,Fe,He),jt=this.expression.evaluate(new Rs(this.context.zoom+1,{brightness:qe}),Le,{},je,Fe,He),Gt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:qe}),Le,{},je,Fe,He):this.lutExpression.value),bi=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValue(bi,F,xt,jt,Gt?null:this.context.lut)}updatePaintArray(F,Le,Oe,Fe,je,qe,He){const xt=this.expression.evaluate({zoom:this.context.zoom,brightness:He},Oe,Fe,void 0,je),jt=this.expression.evaluate({zoom:this.context.zoom+1,brightness:He},Oe,Fe,void 0,je),Gt=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:He}),Oe,Fe,void 0,je):this.lutExpression.value);this._setPaintValue(F,Le,xt,jt,Gt?null:this.context.lut)}_setPaintValue(F,Le,Oe,Fe,je){if("color"===this.type){const Fe=Fo(Oe.toRenderColor(je)),qe=Fo(Oe.toRenderColor(je));for(let Oe=F;Oe<Le;Oe++)this.paintVertexArray.emplace(Oe,Fe[0],Fe[1],qe[0],qe[1])}else{for(let je=F;je<Le;je++)this.paintVertexArray.emplace(je,Oe,Fe);this.maxValue=Math.max(this.maxValue,Math.abs(Oe),Math.abs(Fe))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(F,Le,Oe,Fe,je){const qe=this.useIntegerZoom?Math.floor(Oe.zoom):Oe.zoom,He=Q(this.expression.interpolationFactor(qe,this.context.zoom,this.context.zoom+1),0,1);Le.set(F,je,He)}getBinding(F,Le){return new Eo(F)}}class qo{constructor(F,Le,Oe,Fe,je){this.expression=F,this.layerId=je,this.paintVertexAttributes=("array"===Oe?sm:nm).members;for(let F=0;F<Le.length;++F);this.paintVertexArray=new Fe}populatePaintArray(F,Le,Oe,Fe){const je=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValues(je,F,Le.patterns&&Le.patterns[this.layerId],Oe)}updatePaintArray(F,Le,Oe,Fe,je,qe,He){this._setPaintValues(F,Le,Oe.patterns&&Oe.patterns[this.layerId],qe)}_setPaintValues(F,Le,Oe,Fe){if(!Fe||!Oe)return;const je=Fe[Oe];if(!je)return;const{tl:qe,br:He,pixelRatio:xt}=je;for(let Oe=F;Oe<Le;Oe++)this.paintVertexArray.emplace(Oe,qe[0],qe[1],He[0],He[1],xt)}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class $o{constructor(F,Le,Oe=()=>!0){this.binders={},this._buffers=[],this.context=Le;const Fe=[];for(const je in F.paint._values){const qe=F.paint.get(je);if(je.endsWith("-use-theme"))continue;if(!Oe(je))continue;if(!(qe instanceof qs&&Fi(qe.property.specification)))continue;const He=Ho(je,F.type),xt=qe.value,jt=qe.property.specification.type,Gt=!!qe.property.useIntegerZoom,bi="line-dasharray"===je||je.endsWith("pattern"),wi=F.paint.get(`${je}-use-theme`),qr="line-dasharray"===je&&"constant"!==F.layout.get("line-cap").value.kind||wi&&"constant"!==wi.value.kind;if("constant"!==xt.kind||qr)if("source"===xt.kind||qr||bi){const Le=Wo(je,jt,"source");this.binders[je]=bi?new qo(xt,He,jt,Le,F.id):new Uo(xt,He,jt,Le),Fe.push(`/a_${je}`)}else{const F=Wo(je,jt,"composite");this.binders[je]=new jo(xt,He,jt,Gt,Le,F),Fe.push(`/z_${je}`)}else this.binders[je]=bi?new No(xt.value,He):new Oo(xt.value,He,jt,Le),Fe.push(`/u_${je}`);wi&&(this.binders[je].lutExpression=wi.value)}this.cacheKey=Fe.sort().join("")}getMaxValue(F){const Le=this.binders[F];return Le instanceof Uo||Le instanceof jo?Le.maxValue:0}populatePaintArrays(F,Le,Oe,Fe,je,qe,He){for(const xt in this.binders){const jt=this.binders[xt];jt.context=this.context,(jt instanceof Uo||jt instanceof jo||jt instanceof qo)&&jt.populatePaintArray(F,Le,Oe,Fe,je,qe,He)}}setConstantPatternPositions(F){for(const Le in this.binders){const Oe=this.binders[Le];Oe instanceof No&&Oe.setConstantPatternPositions(F)}}updatePaintArrays(F,Le,Oe,Fe,je,qe,He,xt,jt){let Gt=!1;const bi=Object.keys(F),wi=0!==bi.length&&!xt,qr=wi?bi:Le.uniqueIds;this.context.lut=je.lut;for(const xt in this.binders){const bi=this.binders[xt];if(bi.context=this.context,(bi instanceof Uo||bi instanceof jo||bi instanceof qo)&&bi.expression&&bi.expression.kind&&"constant"!==bi.expression.kind&&(!0===bi.expression.isStateDependent||!1===bi.expression.isLightConstant)){const Xn=je.paint.get(xt);bi.expression=Xn.value;for(const Oe of qr){const je=F[Oe.toString()];Le.eachPosition(Oe,((F,Le,Oe)=>{const xt=Fe.feature(F);bi.updatePaintArray(Le,Oe,xt,je,qe,He,jt)}))}if(!wi)for(const Le of Oe.uniqueIds){const je=F[Le.toString()];Oe.eachPosition(Le,((F,Le,Oe)=>{const xt=Fe.feature(F);bi.updatePaintArray(Le,Oe,xt,je,qe,He,jt)}))}Gt=!0}}return Gt}defines(){const F=[];for(const Le in this.binders){const Oe=this.binders[Le];(Oe instanceof Oo||Oe instanceof No)&&F.push(...Oe.uniformNames.map((F=>`#define HAS_UNIFORM_${F}`)))}return F}getBinderAttributes(){const F=[];for(const Le in this.binders){const Oe=this.binders[Le];if(Oe instanceof Uo||Oe instanceof jo||Oe instanceof qo)for(let Le=0;Le<Oe.paintVertexAttributes.length;Le++)F.push(Oe.paintVertexAttributes[Le].name)}return F}getBinderUniforms(){const F=[];for(const Le in this.binders){const Oe=this.binders[Le];if(Oe instanceof Oo||Oe instanceof No||Oe instanceof jo)for(const Le of Oe.uniformNames)F.push(Le)}return F}getPaintVertexBuffers(){return this._buffers}getUniforms(F){const Le=[];for(const Oe in this.binders){const Fe=this.binders[Oe];if(Fe instanceof Oo||Fe instanceof No||Fe instanceof jo)for(const je of Fe.uniformNames)Le.push({name:je,property:Oe,binding:Fe.getBinding(F,je)})}return Le}setUniforms(F,Le,Oe,Fe,je){for(const{name:Le,property:qe,binding:He}of Oe)this.binders[qe].setUniform(F,He,je,Fe.get(qe),Le)}updatePaintBuffers(){this._buffers=[];for(const F in this.binders){const Le=this.binders[F];(Le instanceof Uo||Le instanceof jo||Le instanceof qo)&&Le.paintVertexBuffer&&this._buffers.push(Le.paintVertexBuffer)}}upload(F){for(const Le in this.binders){const Oe=this.binders[Le];(Oe instanceof Uo||Oe instanceof jo||Oe instanceof qo)&&Oe.upload(F)}this.updatePaintBuffers()}destroy(){for(const F in this.binders){const Le=this.binders[F];(Le instanceof Uo||Le instanceof jo||Le instanceof qo)&&Le.destroy()}}}class Go{constructor(F,Le,Oe=()=>!0){this.programConfigurations={};for(const Fe of F)this.programConfigurations[Fe.id]=new $o(Fe,Le,Oe);this.needsUpload=!1,this._featureMap=new wo,this._featureMapWithoutIds=new wo,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(F,Le,Oe,Fe,je,qe,He,xt){for(const Oe in this.programConfigurations)this.programConfigurations[Oe].populatePaintArrays(F,Le,Fe,je,qe,He,xt);void 0!==Le.id?this._featureMap.add(Le.id,Oe,this._bufferOffset,F):(this._featureMapWithoutIds.add(this._idlessCounter,Oe,this._bufferOffset,F),this._idlessCounter+=1),this._bufferOffset=F,this.needsUpload=!0}updatePaintArrays(F,Le,Oe,Fe,je,qe,He){for(const xt of Oe)this.needsUpload=this.programConfigurations[xt.id].updatePaintArrays(F,this._featureMap,this._featureMapWithoutIds,Le,xt,Fe,je,qe,He||0)||this.needsUpload}get(F){return this.programConfigurations[F]}upload(F){if(this.needsUpload){for(const Le in this.programConfigurations)this.programConfigurations[Le].upload(F);this.needsUpload=!1}}destroy(){for(const F in this.programConfigurations)this.programConfigurations[F].destroy()}}const mm={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function Ho(F,Le){return mm[F]||[F.replace(`${Le}-`,"").replace(/-/g,"_")]}const _m={"line-pattern":{source:ka,composite:ka},"fill-pattern":{source:ka,composite:ka},"fill-extrusion-pattern":{source:ka,composite:ka},"line-dasharray":{source:Ta,composite:Ta}},bm={color:{source:Za,composite:Da},number:{source:Aa,composite:Za}};function Wo(F,Le,Oe){const Fe=_m[F];return Fe&&Fe[Oe]||bm[Le][Oe]}us(Oo,"ConstantBinder"),us(No,"PatternConstantBinder"),us(Uo,"SourceExpressionBinder"),us(qo,"PatternCompositeBinder"),us(jo,"CompositeExpressionBinder"),us($o,"ProgramConfiguration",{omit:["_buffers"]}),us(Go,"ProgramConfigurationSet");const Tm=sp/Math.PI/2,Rm=5,Lm=6,Om=16383,km=64,Fm=[km,32,16],Bm=-Tm,Nm=Tm;function sl(F,Le,Oe,Fe=Tm){return Oe=H(Oe),[F*Math.sin(Oe)*Fe,-Le*Fe,F*Math.cos(Oe)*Fe]}function al(F,Le,Oe){return sl(Math.cos(H(F)),Math.sin(H(F)),Le,Oe)}const Zm=6371008.8,Km=2*Math.PI*Zm;class ul{constructor(F,Le){if(isNaN(F)||isNaN(Le))throw new Error(`Invalid LngLat object: (${F}, ${Le})`);if(this.lng=+F,this.lat=+Le,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ul(et(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(F){const Le=Math.PI/180,Oe=this.lat*Le,Fe=F.lat*Le,je=Math.sin(Oe)*Math.sin(Fe)+Math.cos(Oe)*Math.cos(Fe)*Math.cos((F.lng-this.lng)*Le);return Zm*Math.acos(Math.min(je,1))}toBounds(F=0){const Le=360*F/40075017,Oe=Le/Math.cos(Math.PI/180*this.lat);return new cl({lng:this.lng-Oe,lat:this.lat-Le},{lng:this.lng+Oe,lat:this.lat+Le})}toEcef(F){return al(this.lat,this.lng,Tm+F*Tm/Zm)}static convert(F){if(F instanceof ul)return F;if(Array.isArray(F)&&(2===F.length||3===F.length))return new ul(Number(F[0]),Number(F[1]));if(!Array.isArray(F)&&"object"==typeof F&&null!==F)return new ul(Number("lng"in F?F.lng:F.lon),Number(F.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class cl{constructor(F,Le){if(F)if(Le)this.setSouthWest(F).setNorthEast(Le);else if(4===F.length){const Le=F;this.setSouthWest([Le[0],Le[1]]).setNorthEast([Le[2],Le[3]])}else{const Le=F;this.setSouthWest(Le[0]).setNorthEast(Le[1])}}setNorthEast(F){return this._ne=F instanceof ul?new ul(F.lng,F.lat):ul.convert(F),this}setSouthWest(F){return this._sw=F instanceof ul?new ul(F.lng,F.lat):ul.convert(F),this}extend(F){const Le=this._sw,Oe=this._ne;let Fe,je;if(F instanceof ul)Fe=F,je=F;else{if(!(F instanceof cl))return Array.isArray(F)?4===F.length||F.every(Array.isArray)?this.extend(cl.convert(F)):this.extend(ul.convert(F)):"object"==typeof F&&null!==F&&F.hasOwnProperty("lat")&&(F.hasOwnProperty("lon")||F.hasOwnProperty("lng"))?this.extend(ul.convert(F)):this;if(Fe=F._sw,je=F._ne,!Fe||!je)return this}return Le||Oe?(Le.lng=Math.min(Fe.lng,Le.lng),Le.lat=Math.min(Fe.lat,Le.lat),Oe.lng=Math.max(je.lng,Oe.lng),Oe.lat=Math.max(je.lat,Oe.lat)):(this._sw=new ul(Fe.lng,Fe.lat),this._ne=new ul(je.lng,je.lat)),this}getCenter(){return new ul((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new ul(this.getWest(),this.getNorth())}getSouthEast(){return new ul(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(F){const{lng:Le,lat:Oe}=ul.convert(F);let Fe=this._sw.lng<=Le&&Le<=this._ne.lng;return this._sw.lng>this._ne.lng&&(Fe=this._sw.lng>=Le&&Le>=this._ne.lng),this._sw.lat<=Oe&&Oe<=this._ne.lat&&Fe}static convert(F){if(F)return F instanceof cl?F:new cl(F)}}const Jm=0,Qm=25.5;function fl(F){return Km*Math.cos(F*Math.PI/180)}function dl(F){return(180+F)/360}function ml(F){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F*Math.PI/360)))/360}function yl(F,Le){return F/fl(Le)}function gl(F){return 360*F-180}function xl(F){return 360/Math.PI*Math.atan(Math.exp((180-360*F)*Math.PI/180))-90}function vl(F,Le){return F*fl(xl(Le))}const e_=85.051129;function _l(F){return Math.cos(H(Q(F,-e_,e_)))}function wl(F,Le){const Oe=Q(Le,Jm,Qm),Fe=Math.pow(2,Oe);return _l(F)*Km/(512*Fe)}function Ml(F){return 1/Math.cos(F*Math.PI/180)}function Al(F,Le=0){const Oe=Math.exp(Math.PI*(1-(F.y+Le/sp)/(1<<F.z)*2));return 80150034*Oe/(Oe*Oe+1)/sp/(1<<F.z)}class Il{constructor(F,Le,Oe=0){this.x=+F,this.y=+Le,this.z=+Oe}static fromLngLat(F,Le=0){const Oe=ul.convert(F);return new Il(dl(Oe.lng),ml(Oe.lat),yl(Le,Oe.lat))}toLngLat(){return new ul(gl(this.x),xl(this.y))}toAltitude(){return vl(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Km*Ml(xl(this.y))}}function Sl(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=(Le+Fe)/2,bi=(Oe+je)/2,wi=new ic(Gt,bi);xt(wi),function(F,Le,Oe,Fe,je,qe){const He=Oe-je,xt=Fe-qe;return Math.abs((Fe-Le)*He-(Oe-F)*xt)/Math.hypot(He,xt)}(wi.x,wi.y,qe.x,qe.y,He.x,He.y)>=jt?(Sl(F,Le,Oe,Gt,bi,qe,wi,xt,jt),Sl(F,Gt,bi,Fe,je,wi,He,xt,jt)):F.push(He)}function Pl(F,Le,Oe){let Fe=F[0],je=Fe.x,qe=Fe.y;Le(Fe);const He=[Fe];for(let xt=1;xt<F.length;xt++){const jt=F[xt],{x:Gt,y:bi}=jt;Le(jt),Sl(He,je,qe,Gt,bi,Fe,jt,Le,Oe),je=Gt,qe=bi,Fe=jt}return He}function El(F,Le,Oe,Fe){if(Fe(Le,Oe)){const je=Le.add(Oe)._mult(.5);El(F,Le,je,Fe),El(F,je,Oe,Fe)}else F.push(Oe)}function zl(F,Le){let Oe=F[0];const Fe=[Oe];for(let je=1;je<F.length;je++){const qe=F[je];El(Fe,Oe,qe,Le),Oe=qe}return Fe}const t_=Math.pow(2,14)-1,i_=-t_-1;function Bl(F,Le){const Oe=Math.round(F.x*Le),Fe=Math.round(F.y*Le);return F.x=Q(Oe,i_,t_),F.y=Q(Fe,i_,t_),(Oe<F.x||Oe>F.x+1||Fe<F.y||Fe>F.y+1)&&pt("Geometry exceeds allowed extent, reduce your vector tile buffer size"),F}function Vl(F,Le,Oe){const Fe=F.loadGeometry(),je=F.extent,qe=sp/je;if(Le&&Oe&&Oe.projection.isReprojectedInTileSpace){const qe=1<<Le.z,{scale:He,x:xt,y:jt,projection:Gt}=Oe,c=F=>{const Oe=gl((Le.x+F.x/je)/qe),Fe=xl((Le.y+F.y/je)/qe),bi=Gt.project(Oe,Fe);F.x=(bi.x*He-xt)*je,F.y=(bi.y*He-jt)*je};for(let Le=0;Le<Fe.length;Le++)if(1!==F.type)Fe[Le]=Pl(Fe[Le],c,1);else{const F=[];for(const Oe of Fe[Le])Oe.x<0||Oe.x>=je||Oe.y<0||Oe.y>=je||(c(Oe),F.push(Oe));Fe[Le]=F}}for(const F of Fe)for(const Le of F)Bl(Le,qe);return Fe}function Cl(F,Le){return{type:F.type,id:F.id,properties:F.properties,geometry:Le?Vl(F):[]}}function Dl(F,Le,Oe,Fe,je){F.emplaceBack(2*Le+(Fe+1)/2,2*Oe+(je+1)/2)}function Rl(F,Le,Oe){const Fe=16384;F.emplaceBack(Le.x,Le.y,Le.z,Oe[0]*Fe,Oe[1]*Fe,Oe[2]*Fe)}class Ll{constructor(F){this.zoom=F.zoom,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.projection=F.projection,this.layoutVertexArray=new _a,this.indexArray=new ja,this.segments=new xo,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id))}updateFootprints(F,Le){}populate(F,Le,Oe,Fe){const je=this.layers[0],qe=[];let He=null;"circle"===je.type&&(He=je.layout.get("circle-sort-key"));for(const{feature:Le,id:je,index:xt,sourceLayerIndex:jt}of F){const F=this.layers[0]._featureFilter.needGeometry,Gt=Cl(Le,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),Gt,Oe))continue;const bi=He?He.evaluate(Gt,{},Oe):void 0,wi={id:je,properties:Le.properties,type:Le.type,sourceLayerIndex:jt,index:xt,geometry:F?Gt.geometry:Vl(Le,Oe,Fe),patterns:{},sortKey:bi};qe.push(wi)}He&&qe.sort(((F,Le)=>F.sortKey-Le.sortKey));let xt=null;"globe"===Fe.projection.name&&(this.globeExtVertexArray=new Ba,xt=Fe.projection);for(const Fe of qe){const{geometry:je,index:qe,sourceLayerIndex:He}=Fe,jt=F[qe].feature;this.addFeature(Fe,je,qe,Le.availableImages,Oe,xt,Le.brightness),Le.featureIndex.insert(jt,je,qe,He,this.index)}}update(F,Le,Oe,Fe,je,qe,He){this.programConfigurations.updatePaintArrays(F,Le,je,Oe,Fe,qe,He)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,im.members),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,rm.members))),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(F,Le,Oe,Fe,je,qe,He){for(const Oe of Le)for(const Le of Oe){const Oe=Le.x,Fe=Le.y;if(Oe<0||Oe>=sp||Fe<0||Fe>=sp)continue;if(qe){const F=qe.projectTilePoint(Oe,Fe,je),Le=qe.upVector(je,Oe,Fe),He=this.globeExtVertexArray;Rl(He,F,Le),Rl(He,F,Le),Rl(He,F,Le),Rl(He,F,Le)}const He=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,F.sortKey),xt=He.vertexLength;Dl(this.layoutVertexArray,Oe,Fe,-1,-1),Dl(this.layoutVertexArray,Oe,Fe,1,-1),Dl(this.layoutVertexArray,Oe,Fe,1,1),Dl(this.layoutVertexArray,Oe,Fe,-1,1),this.indexArray.emplaceBack(xt,xt+1,xt+2),this.indexArray.emplaceBack(xt,xt+2,xt+3),He.vertexLength+=4,He.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Oe,{},Fe,je,He)}}function Fl(F,Le){for(let Oe=0;Oe<F.length;Oe++)if(Hl(Le,F[Oe]))return!0;for(let Oe=0;Oe<Le.length;Oe++)if(Hl(F,Le[Oe]))return!0;return!!jl(F,Le)}function Ol(F,Le,Oe){return!!Hl(F,Le)||!!$l(Le,F,Oe)}function Nl(F,Le){if(1===F.length)return Yl(Le,F[0]);for(let Oe=0;Oe<Le.length;Oe++){const Fe=Le[Oe];for(let Le=0;Le<Fe.length;Le++)if(Hl(F,Fe[Le]))return!0}for(let Oe=0;Oe<F.length;Oe++)if(Yl(Le,F[Oe]))return!0;for(let Oe=0;Oe<Le.length;Oe++)if(jl(F,Le[Oe]))return!0;return!1}function Ul(F,Le,Oe){if(F.length>1){if(jl(F,Le))return!0;for(let Fe=0;Fe<Le.length;Fe++)if($l(Le[Fe],F,Oe))return!0}for(let Fe=0;Fe<F.length;Fe++)if($l(F[Fe],Le,Oe))return!0;return!1}function jl(F,Le){if(0===F.length||0===Le.length)return!1;for(let Oe=0;Oe<F.length-1;Oe++){const Fe=F[Oe],je=F[Oe+1];for(let F=0;F<Le.length-1;F++)if(ql(Fe,je,Le[F],Le[F+1]))return!0}return!1}function ql(F,Le,Oe,Fe){return ft(F,Oe,Fe)!==ft(Le,Oe,Fe)&&ft(F,Le,Oe)!==ft(F,Le,Fe)}function $l(F,Le,Oe){const Fe=Oe*Oe;if(1===Le.length)return F.distSqr(Le[0])<Fe;for(let Oe=1;Oe<Le.length;Oe++)if(Gl(F,Le[Oe-1],Le[Oe])<Fe)return!0;return!1}function Gl(F,Le,Oe){const Fe=Le.distSqr(Oe);if(0===Fe)return F.distSqr(Le);const je=((F.x-Le.x)*(Oe.x-Le.x)+(F.y-Le.y)*(Oe.y-Le.y))/Fe;return F.distSqr(je<0?Le:je>1?Oe:Oe.sub(Le)._mult(je)._add(Le))}function Yl(F,Le){let Oe,Fe,je,qe=!1;for(let He=0;He<F.length;He++){Oe=F[He];for(let F=0,He=Oe.length-1;F<Oe.length;He=F++)Fe=Oe[F],je=Oe[He],Fe.y>Le.y!=je.y>Le.y&&Le.x<(je.x-Fe.x)*(Le.y-Fe.y)/(je.y-Fe.y)+Fe.x&&(qe=!qe)}return qe}function Hl(F,Le){let Oe=!1;for(let Fe=0,je=F.length-1;Fe<F.length;je=Fe++){const qe=F[Fe],He=F[je];qe.y>Le.y!=He.y>Le.y&&Le.x<(He.x-qe.x)*(Le.y-qe.y)/(He.y-qe.y)+qe.x&&(Oe=!Oe)}return Oe}function Xl(F,Le,Oe,Fe,je){for(const qe of F)if(Le<=qe.x&&Oe<=qe.y&&Fe>=qe.x&&je>=qe.y)return!0;const qe=[new ic(Le,Oe),new ic(Le,je),new ic(Fe,je),new ic(Fe,Oe)];if(F.length>2)for(const Le of qe)if(Hl(F,Le))return!0;for(let Le=0;Le<F.length-1;Le++)if(Zl(F[Le],F[Le+1],qe))return!0;return!1}function Zl(F,Le,Oe){const Fe=Oe[0],je=Oe[2];if(F.x<Fe.x&&Le.x<Fe.x||F.x>je.x&&Le.x>je.x||F.y<Fe.y&&Le.y<Fe.y||F.y>je.y&&Le.y>je.y)return!1;const qe=ft(F,Le,Oe[0]);return qe!==ft(F,Le,Oe[1])||qe!==ft(F,Le,Oe[2])||qe!==ft(F,Le,Oe[3])}function Wl(F,Le,Oe,Fe,je,qe){let He=Le.y-F.y,xt=F.x-Le.x;if(qe=qe||0){const F=He*He+xt*xt;if(0===F)return!0;const Le=Math.sqrt(F);He/=Le,xt/=Le}return!((Oe.x-F.x)*He+(Oe.y-F.y)*xt-qe<0||(Fe.x-F.x)*He+(Fe.y-F.y)*xt-qe<0||(je.x-F.x)*He+(je.y-F.y)*xt-qe<0)}function Kl(F,Le,Oe,Fe,je,qe,He){return!(Wl(F,Le,Fe,je,qe,He)||Wl(Le,Oe,Fe,je,qe,He)||Wl(Oe,F,Fe,je,qe,He)||Wl(Fe,je,F,Le,Oe,He)||Wl(je,qe,F,Le,Oe,He)||Wl(qe,Fe,F,Le,Oe,He))}function Jl(F,Le,Oe){const Fe=Le.paint.get(F).value;return"constant"===Fe.kind?Fe.value:Oe.programConfigurations.get(Le.id).getMaxValue(F)}function Ql(F){return Math.sqrt(F[0]*F[0]+F[1]*F[1])}function tu(F,Le,Oe,Fe,je){if(!Le[0]&&!Le[1])return F;const qe=ic.convert(Le)._mult(je);"viewport"===Oe&&qe._rotate(-Fe);const He=[];for(let Le=0;Le<F.length;Le++)He.push(F[Le].sub(qe));return He}function eu(F,Le,Oe,Fe){const je=ic.convert(F)._mult(Fe);return"viewport"===Le&&je._rotate(-Oe),je}let r_,n_;us(Ll,"CircleBucket",{omit:["layers"]});var o_,s_={exports:{}},a_=(o_||(o_=1,function(F,Le){!function(F){function e(F,Le,Oe){var Fe=r(256*F,256*(Le=Math.pow(2,Oe)-Le-1),Oe),je=r(256*(F+1),256*(Le+1),Oe);return Fe[0]+","+Fe[1]+","+je[0]+","+je[1]}function r(F,Le,Oe){var Fe=2*Math.PI*6378137/256/Math.pow(2,Oe);return[F*Fe-2*Math.PI*6378137/2,Le*Fe-2*Math.PI*6378137/2]}F.getURL=function(F,Le,Oe,Fe,je,qe){return qe=qe||{},F+"?"+["bbox="+e(Oe,Fe,je),"format="+(qe.format||"image/png"),"service="+(qe.service||"WMS"),"version="+(qe.version||"1.1.1"),"request="+(qe.request||"GetMap"),"srs="+(qe.srs||"EPSG:3857"),"width="+(qe.width||256),"height="+(qe.height||256),"layers="+Le].join("&")},F.getTileBBox=e,F.getMercCoords=r,Object.defineProperty(F,"__esModule",{value:!0})}(Le)}(0,s_.exports)),s_.exports);class ou{constructor(F,Le,Oe){this.z=F,this.x=Le,this.y=Oe,this.key=cu(0,F,F,Le,Oe)}equals(F){return this.z===F.z&&this.x===F.x&&this.y===F.y}url(F,Le){const Oe=a_.getTileBBox(this.x,this.y,this.z),Fe=function(F,Le,Oe){let Fe,je="";for(let qe=F;qe>0;qe--)Fe=1<<qe-1,je+=(Le&Fe?1:0)+(Oe&Fe?2:0);return je}(this.z,this.x,this.y);return F[(this.x+this.y)%F.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===Le?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",Fe).replace("{bbox-epsg-3857}",Oe)}toString(){return`${this.z}/${this.x}/${this.y}`}}class lu{constructor(F,Le){this.wrap=F,this.canonical=Le,this.key=cu(F,Le.z,Le.z,Le.x,Le.y)}}class uu{constructor(F,Le,Oe,Fe,je){this.overscaledZ=F,this.wrap=Le,this.canonical=new ou(Oe,+Fe,+je),this.key=0===Le&&F===Oe?this.canonical.key:cu(Le,F,Oe,Fe,je)}equals(F){return this.overscaledZ===F.overscaledZ&&this.wrap===F.wrap&&this.canonical.equals(F.canonical)}scaledTo(F){const Le=this.canonical.z-F;return F>this.canonical.z?new uu(F,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new uu(F,this.wrap,F,this.canonical.x>>Le,this.canonical.y>>Le)}calculateScaledKey(F,Le=!0){if(this.overscaledZ===F&&Le)return this.key;if(F>this.canonical.z)return cu(this.wrap*+Le,F,this.canonical.z,this.canonical.x,this.canonical.y);{const Oe=this.canonical.z-F;return cu(this.wrap*+Le,F,F,this.canonical.x>>Oe,this.canonical.y>>Oe)}}isChildOf(F){if(F.wrap!==this.wrap)return!1;const Le=this.canonical.z-F.canonical.z;return 0===F.overscaledZ||F.overscaledZ<this.overscaledZ&&F.canonical.z<this.canonical.z&&F.canonical.x===this.canonical.x>>Le&&F.canonical.y===this.canonical.y>>Le}children(F){if(this.overscaledZ>=F)return[new uu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const Le=this.canonical.z+1,Oe=2*this.canonical.x,Fe=2*this.canonical.y;return[new uu(Le,this.wrap,Le,Oe,Fe),new uu(Le,this.wrap,Le,Oe+1,Fe),new uu(Le,this.wrap,Le,Oe,Fe+1),new uu(Le,this.wrap,Le,Oe+1,Fe+1)]}isLessThan(F){return this.wrap<F.wrap||!(this.wrap>F.wrap)&&(this.overscaledZ<F.overscaledZ||!(this.overscaledZ>F.overscaledZ)&&(this.canonical.x<F.canonical.x||!(this.canonical.x>F.canonical.x)&&this.canonical.y<F.canonical.y))}wrapped(){return new uu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(F){return new uu(this.overscaledZ,F,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new lu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function cu(F,Le,Oe,Fe,je){const qe=1<<Math.min(Oe,22);let He=qe*(je%qe)+Fe%qe;return F&&Oe<22&&(He+=qe*qe*((F<0?-2*F-1:2*F)%(1<<2*(22-Oe)))),16*(32*He+Oe)+(Le-Oe)}const l_=[F=>{let Le=F.canonical.x-1,Oe=F.wrap;return Le<0&&(Le=(1<<F.canonical.z)-1,Oe--),new uu(F.overscaledZ,Oe,F.canonical.z,Le,F.canonical.y)},F=>{let Le=F.canonical.x+1,Oe=F.wrap;return Le===1<<F.canonical.z&&(Le=0,Oe++),new uu(F.overscaledZ,Oe,F.canonical.z,Le,F.canonical.y)},F=>new uu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,(0===F.canonical.y?1<<F.canonical.z:F.canonical.y)-1),F=>new uu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y===(1<<F.canonical.z)-1?0:F.canonical.y+1)];us(ou,"CanonicalTileID"),us(uu,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const c_=va([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:h_}=c_,u_=va([{name:"a_pos_3",components:3,type:"Int16"}]);var d_=va([{name:"a_pos",type:"Int16",components:2}]);class yu{constructor(F,Le){this.pos=F,this.dir=Le}intersectsPlane(F,Le,Oe){const Fe=kl.vec2.dot(Le,this.dir);if(Math.abs(Fe)<1e-6)return!1;const je=((F[0]-this.pos[0])*Le[0]+(F[1]-this.pos[1])*Le[1])/Fe;return Oe[0]=this.pos[0]+this.dir[0]*je,Oe[1]=this.pos[1]+this.dir[1]*je,!0}}class gu{constructor(F,Le){this.pos=F,this.dir=Le}intersectsPlane(F,Le,Oe){const Fe=kl.vec3.dot(Le,this.dir);if(Math.abs(Fe)<1e-6)return!1;const je=((F[0]-this.pos[0])*Le[0]+(F[1]-this.pos[1])*Le[1]+(F[2]-this.pos[2])*Le[2])/Fe;return Oe[0]=this.pos[0]+this.dir[0]*je,Oe[1]=this.pos[1]+this.dir[1]*je,Oe[2]=this.pos[2]+this.dir[2]*je,!0}closestPointOnSphere(F,Le,Oe){if(kl.vec3.equals(this.pos,F)||0===Le)return Oe[0]=Oe[1]=Oe[2]=0,!1;const[Fe,je,qe]=this.dir,He=this.pos[0]-F[0],xt=this.pos[1]-F[1],jt=this.pos[2]-F[2],Gt=Fe*Fe+je*je+qe*qe,bi=2*(He*Fe+xt*je+jt*qe),wi=bi*bi-4*Gt*(He*He+xt*xt+jt*jt-Le*Le);if(wi<0){const F=Math.max(-bi/2,0),Gt=He+Fe*F,wi=xt+je*F,qr=jt+qe*F,Xn=Math.hypot(Gt,wi,qr);return Oe[0]=Gt*Le/Xn,Oe[1]=wi*Le/Xn,Oe[2]=qr*Le/Xn,!1}{const F=(-bi-Math.sqrt(wi))/(2*Gt);if(F<0){const F=Math.hypot(He,xt,jt);return Oe[0]=He*Le/F,Oe[1]=xt*Le/F,Oe[2]=jt*Le/F,!1}return Oe[0]=He+Fe*F,Oe[1]=xt+je*F,Oe[2]=jt+qe*F,!0}}}class xu{constructor(F,Le,Oe,Fe,je){this.TL=F,this.TR=Le,this.BR=Oe,this.BL=Fe,this.horizon=je}static fromInvProjectionMatrix(F,Le,Oe){const Fe=[-1,1,1],je=[1,1,1],qe=[1,-1,1],He=[-1,-1,1],xt=kl.vec3.transformMat4(Fe,Fe,F),jt=kl.vec3.transformMat4(je,je,F),Gt=kl.vec3.transformMat4(qe,qe,F),bi=kl.vec3.transformMat4(He,He,F);return new xu(xt,jt,Gt,bi,Le/Oe)}}function vu(F,Le,Oe){let Fe=1/0,je=-1/0;const qe=[];for(const He of F){kl.vec3.sub(qe,He,Le);const F=kl.vec3.dot(qe,Oe);Fe=Math.min(Fe,F),je=Math.max(je,F)}return[Fe,je]}function bu(F,Le){let Oe=!0;for(let Fe=0;Fe<F.planes.length;Fe++){const je=F.planes[Fe];let qe=0;for(let F=0;F<Le.length;F++)qe+=kl.vec3.dot(je,Le[F])+je[3]>=0;if(0===qe)return 0;qe!==Le.length&&(Oe=!1)}return Oe?2:1}function _u(F,Le){for(const Oe of F.projections){const Fe=vu(Le,F.points[0],Oe.axis);if(Oe.projection[1]<Fe[0]||Oe.projection[0]>Fe[1])return 0}return 1}function wu(F,Le){let Oe=0;const Fe=[0,0,0,0];for(let je=0;je<F.length;je++)Fe[0]=F[je][0],Fe[1]=F[je][1],Fe[2]=F[je][2],Fe[3]=1,kl.vec4.dot(Fe,Le)>=0&&Oe++;return Oe}class Mu{constructor(F,Le){this.points=F||new Array(8).fill([0,0,0]),this.planes=Le||new Array(6).fill([0,0,0,0]),this.bounds=Au.fromPoints(this.points),this.projections=[],this.frustumEdges=[kl.vec3.sub([],this.points[2],this.points[3]),kl.vec3.sub([],this.points[0],this.points[3]),kl.vec3.sub([],this.points[4],this.points[0]),kl.vec3.sub([],this.points[5],this.points[1]),kl.vec3.sub([],this.points[6],this.points[2]),kl.vec3.sub([],this.points[7],this.points[3])];for(const F of this.frustumEdges){const Le=[0,-F[2],F[1]],Oe=[F[2],0,-F[0]];this.projections.push({axis:Le,projection:vu(this.points,this.points[0],Le)}),this.projections.push({axis:Oe,projection:vu(this.points,this.points[0],Oe)})}}static fromInvProjectionMatrix(F,Le,Oe,Fe){const je=Math.pow(2,Oe),qe=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((Oe=>{const qe=kl.vec4.transformMat4([],Oe,F),He=1/qe[3]/Le*je;return kl.vec4.mul(qe,qe,[He,He,Fe?1/qe[3]:He,He])})),He=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((F=>{const Le=kl.vec3.sub([],qe[F[0]],qe[F[1]]),Oe=kl.vec3.sub([],qe[F[2]],qe[F[1]]),Fe=kl.vec3.normalize([],kl.vec3.cross([],Le,Oe)),je=-kl.vec3.dot(Fe,qe[F[1]]);return Fe.concat(je)})),xt=[];for(let F=0;F<qe.length;F++)xt.push([qe[F][0],qe[F][1],qe[F][2]]);return new Mu(xt,He)}intersectsPrecise(F,Le,Oe){for(let Oe=0;Oe<Le.length;Oe++)if(!wu(F,Le[Oe]))return 0;for(let Le=0;Le<this.planes.length;Le++)if(!wu(F,this.planes[Le]))return 0;for(const Le of Oe)for(const Oe of this.frustumEdges){const Fe=kl.vec3.cross([],Le,Oe),je=kl.vec3.length(Fe);if(0===je)continue;kl.vec3.scale(Fe,Fe,1/je);const qe=vu(this.points,this.points[0],Fe),He=vu(F,this.points[0],Fe);if(qe[0]>He[1]||He[0]>qe[1])return 0}return 1}containsPoint(F){for(const Le of this.planes){const Oe=Le[3];if(kl.vec3.dot([Le[0],Le[1],Le[2]],F)+Oe<0)return!1}return!0}}class Au{static fromPoints(F){const Le=[1/0,1/0,1/0],Oe=[-1/0,-1/0,-1/0];for(const Fe of F)kl.vec3.min(Le,Le,Fe),kl.vec3.max(Oe,Oe,Fe);return new Au(Le,Oe)}static fromTileIdAndHeight(F,Le,Oe){const Fe=1<<F.canonical.z,je=F.canonical.x,qe=F.canonical.y;return new Au([je/Fe,qe/Fe,Le],[(je+1)/Fe,(qe+1)/Fe,Oe])}static applyTransform(F,Le){const Oe=F.getCorners();for(let F=0;F<Oe.length;++F)kl.vec3.transformMat4(Oe[F],Oe[F],Le);return Au.fromPoints(Oe)}static applyTransformFast(F,Le){const Oe=[Le[12],Le[13],Le[14]],Fe=[...Oe];for(let je=0;je<3;je++)for(let qe=0;qe<3;qe++){const He=Le[4*qe+je],xt=He*F.min[qe],jt=He*F.max[qe];Oe[je]+=Math.min(xt,jt),Fe[je]+=Math.max(xt,jt)}return new Au(Oe,Fe)}static projectAabbCorners(F,Le){const Oe=F.getCorners();for(let F=0;F<Oe.length;++F)kl.vec3.transformMat4(Oe[F],Oe[F],Le);return Oe}constructor(F,Le){this.min=F,this.max=Le,this.center=kl.vec3.scale([],kl.vec3.add([],this.min,this.max),.5)}quadrant(F){const Le=[F%2==0,F<2],Oe=kl.vec3.clone(this.min),Fe=kl.vec3.clone(this.max);for(let F=0;F<Le.length;F++)Oe[F]=Le[F]?this.min[F]:this.center[F],Fe[F]=Le[F]?this.center[F]:this.max[F];return Fe[2]=this.max[2],new Au(Oe,Fe)}distanceX(F){return Math.max(Math.min(this.max[0],F[0]),this.min[0])-F[0]}distanceY(F){return Math.max(Math.min(this.max[1],F[1]),this.min[1])-F[1]}distanceZ(F){return Math.max(Math.min(this.max[2],F[2]),this.min[2])-F[2]}getCorners(){const F=this.min,Le=this.max;return[[F[0],F[1],F[2]],[Le[0],F[1],F[2]],[Le[0],Le[1],F[2]],[F[0],Le[1],F[2]],[F[0],F[1],Le[2]],[Le[0],F[1],Le[2]],[Le[0],Le[1],Le[2]],[F[0],Le[1],Le[2]]]}intersects(F){return this.intersectsAabb(F.bounds)?bu(F,this.getCorners()):0}intersectsFlat(F){return this.intersectsAabb(F.bounds)?bu(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(F,Le){return Le||this.intersects(F)?_u(F,this.getCorners()):0}intersectsPreciseFlat(F,Le){return Le||this.intersectsFlat(F)?_u(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(F){for(let Le=0;Le<3;++Le)if(this.min[Le]>F.max[Le]||F.min[Le]>this.max[Le])return!1;return!0}intersectsAabbXY(F){return!(this.min[0]>F.max[0]||F.min[0]>this.max[0]||this.min[1]>F.max[1]||F.min[1]>this.max[1])}encapsulate(F){for(let Le=0;Le<3;Le++)this.min[Le]=Math.min(this.min[Le],F.min[Le]),this.max[Le]=Math.max(this.max[Le],F.max[Le])}encapsulatePoint(F){for(let Le=0;Le<3;Le++)this.min[Le]=Math.min(this.min[Le],F[Le]),this.max[Le]=Math.max(this.max[Le],F[Le])}closestPoint(F){return[Math.max(Math.min(this.max[0],F[0]),this.min[0]),Math.max(Math.min(this.max[1],F[1]),this.min[1]),Math.max(Math.min(this.max[2],F[2]),this.min[2])]}}function Iu(F){return F*Tm/Zm}us(Au,"Aabb");const p_=[new Au([Bm,Bm,Bm],[Nm,Nm,Nm]),new Au([Bm,Bm,Bm],[0,0,Nm]),new Au([0,Bm,Bm],[Nm,0,Nm]),new Au([Bm,0,Bm],[0,Nm,Nm]),new Au([0,0,Bm],[Nm,Nm,Nm])];function Pu(F,Le,Oe,Fe=!0){const je=kl.vec3.scale([],F._camera.position,F.worldSize),qe=[Le,Oe,1,1];kl.vec4.transformMat4(qe,qe,F.pixelMatrixInverse),kl.vec4.scale(qe,qe,1/qe[3]);const He=kl.vec3.sub([],qe,je),xt=kl.vec3.normalize([],He),jt=F.globeMatrix,Gt=[jt[12],jt[13],jt[14]],bi=kl.vec3.sub([],Gt,je),wi=kl.vec3.length(bi),qr=kl.vec3.normalize([],bi),Xn=F.worldSize/(2*Math.PI),Yn=kl.vec3.dot(qr,xt),yo=Math.asin(Xn/wi);if(yo<Math.acos(Yn)){if(!Fe)return null;const F=[],Le=[];kl.vec3.scale(F,xt,wi/Yn),kl.vec3.normalize(Le,kl.vec3.sub(Le,F,bi)),kl.vec3.normalize(xt,kl.vec3.add(xt,bi,kl.vec3.scale(xt,Le,Math.tan(yo)*wi)))}const bo=[];new gu(je,xt).closestPointOnSphere(Gt,Xn,bo);const Do=kl.vec3.normalize([],vt(jt,0)),Ro=kl.vec3.normalize([],vt(jt,1)),zs=kl.vec3.normalize([],vt(jt,2)),Zs=kl.vec3.dot(Do,bo),na=kl.vec3.dot(Ro,bo),el=kl.vec3.dot(zs,bo),nl=X(Math.asin(-na/Xn));let hl=X(Math.atan2(Zs,el));hl=F.center.lng+function(F,Le){const Oe=(Le-F+180)%360-180;return Oe<-180?Oe+360:Oe}(F.center.lng,hl);const pl=dl(hl),bl=Q(ml(nl),0,1);return new Il(pl,bl)}class Eu{constructor(F,Le,Oe){this.a=kl.vec3.sub([],F,Oe),this.b=kl.vec3.sub([],Le,Oe),this.center=Oe;const Fe=kl.vec3.normalize([],this.a),je=kl.vec3.normalize([],this.b);this.angle=Math.acos(kl.vec3.dot(Fe,je))}}function zu(F,Le){if(0===F.angle)return null;let Oe;return Oe=0===F.a[Le]?1/F.angle*.5*Math.PI:1/F.angle*Math.atan(F.b[Le]/F.a[Le]/Math.sin(F.angle)-1/Math.tan(F.angle)),Oe<0||Oe>1?null:function(F,Le,Oe,Fe){const je=Math.sin(Oe);return F*(Math.sin((1-Fe)*Oe)/je)+Le*(Math.sin(Fe*Oe)/je)}(F.a[Le],F.b[Le],F.angle,Q(Oe,0,1))+F.center[Le]}function ku(F){if(F.z<=1)return p_[F.z+2*F.y+F.x];const Le=Du(Cu(F));return Au.fromPoints(Le)}function Tu(F,Le,Oe){return kl.vec3.scale(F,F,1-Oe),kl.vec3.scaleAndAdd(F,F,Le,Oe)}function Bu(F,Le,Oe){for(const Fe of F)kl.vec3.transformMat4(Fe,Fe,Le),kl.vec3.scale(Fe,Fe,Oe)}function Vu(F,Le,Oe,Fe){const je=Le/F.worldSize,qe=F.globeMatrix;if(Oe.z<=1){const F=ku(Oe).getCorners();return Bu(F,qe,je),Au.fromPoints(F)}const He=Cu(Oe,Fe),xt=Du(He,Tm+Iu(F._tileCoverLift));Bu(xt,qe,je);const jt=Number.MAX_VALUE,Gt=[-jt,-jt,-jt],bi=[jt,jt,jt];if(He.contains(F.center)){for(const F of xt)kl.vec3.min(bi,bi,F),kl.vec3.max(Gt,Gt,F);Gt[2]=0;const Le=F.point,Oe=[Le.x*je,Le.y*je,0];return kl.vec3.min(bi,bi,Oe),kl.vec3.max(Gt,Gt,Oe),new Au(bi,Gt)}if(F._tileCoverLift>0){for(const F of xt)kl.vec3.min(bi,bi,F),kl.vec3.max(Gt,Gt,F);return new Au(bi,Gt)}const wi=[qe[12]*je,qe[13]*je,qe[14]*je],qr=He.getCenter(),Xn=Q(F.center.lat,-e_,e_),Yn=Q(qr.lat,-e_,e_),yo=dl(F.center.lng),bo=ml(Xn);let Do=yo-dl(qr.lng);const Ro=bo-ml(Yn);Do>.5?Do-=1:Do<-.5&&(Do+=1);let zs=0;if(Math.abs(Do)>Math.abs(Ro))zs=Do>=0?1:3;else{zs=Ro>=0?0:2;const F=[qe[4]*je,qe[5]*je,qe[6]*je],Le=-Math.sin(H(Ro>=0?He.getSouth():He.getNorth()))*Tm;kl.vec3.scaleAndAdd(wi,wi,F,Le)}const Zs=xt[zs],na=xt[(zs+1)%4],el=new Eu(Zs,na,wi),nl=[zu(el,0)||Zs[0],zu(el,1)||Zs[1],zu(el,2)||Zs[2]],hl=$u(F.zoom);if(hl>0){const Fe=function({x:F,y:Le,z:Oe},Fe,je,qe,He){const xt=1/(1<<Oe);let jt=F*xt,Gt=jt+xt,bi=Le*xt,wi=bi+xt,qr=0;const Xn=(jt+Gt)/2-qe;return Xn>.5?qr=-1:Xn<-.5&&(qr=1),jt=((jt+qr)*Fe-(qe*=Fe))*je+qe,Gt=((Gt+qr)*Fe-qe)*je+qe,bi=(bi*Fe-(He*=Fe))*je+He,wi=(wi*Fe-He)*je+He,[[jt,wi,0],[Gt,wi,0],[Gt,bi,0],[jt,bi,0]]}(Oe,Le,F._pixelsPerMercatorPixel,yo,bo);for(let F=0;F<xt.length;F++)Tu(xt[F],Fe[F],hl);const je=kl.vec3.add([],Fe[zs],Fe[(zs+1)%4]);kl.vec3.scale(je,je,.5),Tu(nl,je,hl)}for(const F of xt)kl.vec3.min(bi,bi,F),kl.vec3.max(Gt,Gt,F);return bi[2]=Math.min(Zs[2],na[2]),kl.vec3.min(bi,bi,nl),kl.vec3.max(Gt,Gt,nl),new Au(bi,Gt)}function Cu({x:F,y:Le,z:Oe},Fe=!1){const je=1/(1<<Oe),qe=new ul(gl(F*je),Le===(1<<Oe)-1&&Fe?-90:xl((Le+1)*je)),He=new ul(gl((F+1)*je),0===Le&&Fe?90:xl(Le*je));return new cl(qe,He)}function Du(F,Le=Tm){const Oe=H(F.getNorth()),Fe=H(F.getSouth()),je=Math.cos(Oe),qe=Math.cos(Fe),He=Math.sin(Oe),xt=Math.sin(Fe),jt=F.getWest(),Gt=F.getEast();return[sl(qe,xt,jt,Le),sl(qe,xt,Gt,Le),sl(je,He,Gt,Le),sl(je,He,jt,Le)]}function Ru(F,Le,Oe,Fe){const je=1<<Oe.z,qe=(F/sp+Oe.x)/je;return al(xl((Le/sp+Oe.y)/je),gl(qe),Fe)}function Lu({min:F,max:Le}){return Om/Math.max(Le[0]-F[0],Le[1]-F[1],Le[2]-F[2])}const f_=new Float64Array(16);function Ou(F){const Le=Lu(F),Oe=kl.mat4.fromScaling(f_,[Le,Le,Le]);return kl.mat4.translate(Oe,Oe,kl.vec3.negate([],F.min))}function Nu(F){const Le=kl.mat4.fromTranslation(f_,F.min),Oe=1/Lu(F);return kl.mat4.scale(Le,Le,[Oe,Oe,Oe])}function Uu(F){const Le=sp/(2*Math.PI);return F/(2*Math.PI)/Le}function ju(F,Le){return sp/(512*Math.pow(2,F))*Lu(ku(Le))}function qu(F,Le,Oe,Fe,je){const qe=Uu(Oe),He=[F,Le,-Oe/(2*Math.PI)],xt=kl.mat4.identity(new Float64Array(16));return kl.mat4.translate(xt,xt,He),kl.mat4.scale(xt,xt,[qe,qe,qe]),kl.mat4.rotateX(xt,xt,H(-je)),kl.mat4.rotateY(xt,xt,H(-Fe)),xt}function $u(F){return tt(Rm,Lm,F)}function Gu(F,Le){const Oe=al(Le.lat,Le.lng),Fe=function(F){const Le=al(F._center.lat,F._center.lng),Oe=kl.vec3.fromValues(0,1,0);let Fe=kl.vec3.cross([],Oe,Le);const je=kl.mat4.fromRotation([],-F.angle,Le);Fe=kl.vec3.transformMat4(Fe,Fe,je),kl.mat4.fromRotation(je,-F._pitch,Fe);const qe=kl.vec3.normalize([],Le);return kl.vec3.scale(qe,qe,Iu(F.cameraToCenterDistance/F.pixelsPerMeter)),kl.vec3.transformMat4(qe,qe,je),kl.vec3.add([],Le,qe)}(F),je=kl.vec3.subtract([],Fe,Oe);return kl.vec3.angle(je,Oe)}function Yu(F,Le){return Gu(F,Le)>Math.PI/2*1.01}const m_=H(85),__=Math.cos(m_),g_=Math.sin(m_),y_=kl.mat4.create(),Ku=F=>{const Le=[];return"map"===F.paint.get("circle-pitch-alignment")&&Le.push("PITCH_WITH_MAP"),"map"===F.paint.get("circle-pitch-scale")&&Le.push("SCALE_WITH_MAP"),Le};function Ju(F,Le,Oe,Fe,je,qe,He,xt,jt){if(qe&&F.queryGeometry.isAboveHorizon)return!1;qe&&(jt*=F.pixelToTileUnitsFactor);const Gt=F.tileID.canonical,bi=Oe.projection.upVectorScale(Gt,Oe.center.lat,Oe.worldSize).metersToTile;for(const wi of Le)for(const Le of wi){const wi=Le.add(xt),qr=je&&Oe.elevation?Oe.elevation.exaggeration()*je.getElevationAt(wi.x,wi.y,!0):0,Xn=Oe.projection.projectTilePoint(wi.x,wi.y,Gt);if(qr>0){const F=Oe.projection.upVector(Gt,wi.x,wi.y);Xn.x+=F[0]*bi*qr,Xn.y+=F[1]*bi*qr,Xn.z+=F[2]*bi*qr}const Yn=qe?wi:Qu(Xn.x,Xn.y,Xn.z,Fe),yo=qe?F.tilespaceRays.map((F=>rc(F,qr))):F.queryGeometry.screenGeometry,bo=kl.vec4.transformMat4([],[Xn.x,Xn.y,Xn.z,1],Fe);if(!He&&qe?jt*=bo[3]/Oe.cameraToCenterDistance:He&&!qe&&(jt*=Oe.cameraToCenterDistance/bo[3]),qe){const F=xl((Le.y/sp+Gt.y)/(1<<Gt.z));jt/=Oe.projection.pixelsPerMeter(F,1)/yl(1,F)}if(Ol(yo,Yn,jt))return!0}return!1}function Qu(F,Le,Oe,Fe){const je=kl.vec4.transformMat4([],[F,Le,Oe,1],Fe);return new ic(je[0]/je[3],je[1]/je[3])}const x_=kl.vec3.fromValues(0,0,0),v_=kl.vec3.fromValues(0,0,1);function rc(F,Le){const Oe=kl.vec3.create();return x_[2]=Le,F.intersectsPlane(x_,v_,Oe),new ic(Oe[0],Oe[1])}class nc extends Ll{}let b_,w_,T_,S_;function lc(F,{width:Le,height:Oe},Fe,je){if(je){if(je instanceof Uint8ClampedArray)je=new Uint8Array(je.buffer);else if(je.length!==Le*Oe*Fe)throw new RangeError("mismatched image size")}else je=new Uint8Array(Le*Oe*Fe);return F.width=Le,F.height=Oe,F.data=je,F}function uc(F,Le,Oe){const{width:Fe,height:je}=Le;Fe===F.width&&je===F.height||(cc(F,Le,{x:0,y:0},{x:0,y:0},{width:Math.min(F.width,Fe),height:Math.min(F.height,je)},Oe,null),F.width=Fe,F.height=je,F.data=Le.data)}function cc(F,Le,Oe,Fe,je,qe,He,xt){if(0===je.width||0===je.height)return Le;if(je.width>F.width||je.height>F.height||Oe.x>F.width-je.width||Oe.y>F.height-je.height)throw new RangeError("out of range source coordinates for image copy");if(je.width>Le.width||je.height>Le.height||Fe.x>Le.width-je.width||Fe.y>Le.height-je.height)throw new RangeError("out of range destination coordinates for image copy");const jt=F.data,Gt=Le.data,bi=4===qe&&xt;for(let xt=0;xt<je.height;xt++){const wi=((Oe.y+xt)*F.width+Oe.x)*qe,qr=((Fe.y+xt)*Le.width+Fe.x)*qe;if(bi)for(let F=0;F<je.width;F++){const Le=wi+F*qe+3,Oe=qr+F*qe;Gt[Oe+0]=255,Gt[Oe+1]=255,Gt[Oe+2]=255,Gt[Oe+3]=jt[Le]}else if(He)for(let F=0;F<je.width;F++){const Le=wi+F*qe,Oe=qr+F*qe,Fe=jt[Le+3],je=new Se(jt[Le+0]/255*Fe,jt[Le+1]/255*Fe,jt[Le+2]/255*Fe,Fe).toRenderColor(He).toArray();Gt[Oe+0]=je[0],Gt[Oe+1]=je[1],Gt[Oe+2]=je[2],Gt[Oe+3]=je[3]}else for(let F=0;F<je.width*qe;F++)Gt[qr+F]=jt[wi+F]}return Le}us(nc,"HeatmapBucket",{omit:["layers"]});class hc{constructor(F,Le){lc(this,F,1,Le)}resize(F){uc(this,new hc(F),1)}clone(){return new hc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,Le,Oe,Fe,je){cc(F,Le,Oe,Fe,je,1,null)}}class pc{constructor(F,Le){lc(this,F,4,Le)}resize(F){uc(this,new pc(F),4)}replace(F,Le){Le?this.data.set(F):this.data=F instanceof Uint8ClampedArray?new Uint8Array(F.buffer):F}clone(){return new pc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,Le,Oe,Fe,je,qe,He){cc(F,Le,Oe,Fe,je,4,qe,He)}}class fc{constructor(F,Le){this.width=F.width,this.height=F.height,this.data=Le instanceof Uint8Array?new Float32Array(Le.buffer):Le}}function dc(F){const Le={},Oe=F.resolution||256,Fe=F.clips?F.clips.length:1,je=F.image||new pc({width:Oe,height:Fe}),s=(Oe,Fe,qe)=>{Le[F.evaluationKey]=qe;const He=F.expression.evaluate(Le);He&&(je.data[Oe+Fe+0]=Math.floor(255*He.r/He.a),je.data[Oe+Fe+1]=Math.floor(255*He.g/He.a),je.data[Oe+Fe+2]=Math.floor(255*He.b/He.a),je.data[Oe+Fe+3]=Math.floor(255*He.a))};if(F.clips)for(let Le=0,je=0;Le<Fe;++Le,je+=4*Oe)for(let Fe=0,qe=0;Fe<Oe;Fe++,qe+=4){const He=Fe/(Oe-1),{start:xt,end:jt}=F.clips[Le];s(je,qe,xt*(1-He)+jt*He)}else for(let F=0,Le=0;F<Oe;F++,Le+=4)s(0,Le,F/(Oe-1));return je}us(hc,"AlphaImage"),us(pc,"RGBAImage");const E_=va([{name:"a_pos",components:2,type:"Int16"}],4),M_=va([{name:"a_road_z_offset",components:1,type:"Float32"}],4),A_=va([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),I_=va([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function vc(F,Le,Oe=2){const Fe=Le&&Le.length,je=Fe?Le[0]*Oe:F.length;let qe=bc(F,0,je,Oe,!0);const He=[];if(!qe||qe.next===qe.prev)return He;let xt,jt,Gt;if(Fe&&(qe=function(F,Le,Oe,Fe){const je=[];for(let Oe=0,qe=Le.length;Oe<qe;Oe++){const He=bc(F,Le[Oe]*Fe,Oe<qe-1?Le[Oe+1]*Fe:F.length,Fe,!1);He===He.next&&(He.steiner=!0),je.push(Tc(He))}je.sort(Pc);for(let F=0;F<je.length;F++)Oe=Ec(je[F],Oe);return Oe}(F,Le,qe,Oe)),F.length>80*Oe){xt=1/0,jt=1/0;let Le=-1/0,Fe=-1/0;for(let qe=Oe;qe<je;qe+=Oe){const Oe=F[qe],je=F[qe+1];Oe<xt&&(xt=Oe),je<jt&&(jt=je),Oe>Le&&(Le=Oe),je>Fe&&(Fe=je)}Gt=Math.max(Le-xt,Fe-jt),Gt=0!==Gt?32767/Gt:0}return wc(qe,He,Oe,xt,jt,Gt,0),He}function bc(F,Le,Oe,Fe,je){let qe;if(je===function(F,Le,Oe,Fe){let je=0;for(let qe=Le,He=Oe-Fe;qe<Oe;qe+=Fe)je+=(F[He]-F[qe])*(F[qe+1]+F[He+1]),He=qe;return je}(F,Le,Oe,Fe)>0)for(let je=Le;je<Oe;je+=Fe)qe=Uc(je/Fe|0,F[je],F[je+1],qe);else for(let je=Oe-Fe;je>=Le;je-=Fe)qe=Uc(je/Fe|0,F[je],F[je+1],qe);return qe&&Dc(qe,qe.next)&&(jc(qe),qe=qe.next),qe}function _c(F,Le){if(!F)return F;Le||(Le=F);let Oe,Fe=F;do{if(Oe=!1,Fe.steiner||!Dc(Fe,Fe.next)&&0!==Cc(Fe.prev,Fe,Fe.next))Fe=Fe.next;else{if(jc(Fe),Fe=Le=Fe.prev,Fe===Fe.next)break;Oe=!0}}while(Oe||Fe!==Le);return Le}function wc(F,Le,Oe,Fe,je,qe,He){if(!F)return;!He&&qe&&function(F,Le,Oe,Fe){let je=F;do{0===je.z&&(je.z=kc(je.x,je.y,Le,Oe,Fe)),je.prevZ=je.prev,je.nextZ=je.next,je=je.next}while(je!==F);je.prevZ.nextZ=null,je.prevZ=null,function(F){let Le,Oe=1;do{let Fe,je=F;F=null;let qe=null;for(Le=0;je;){Le++;let He=je,xt=0;for(let F=0;F<Oe&&(xt++,He=He.nextZ,He);F++);let jt=Oe;for(;xt>0||jt>0&&He;)0!==xt&&(0===jt||!He||je.z<=He.z)?(Fe=je,je=je.nextZ,xt--):(Fe=He,He=He.nextZ,jt--),qe?qe.nextZ=Fe:F=Fe,Fe.prevZ=qe,qe=Fe;je=He}qe.nextZ=null,Oe*=2}while(Le>1)}(je)}(F,Fe,je,qe);let xt=F;for(;F.prev!==F.next;){const jt=F.prev,Gt=F.next;if(qe?Ac(F,Fe,je,qe):Mc(F))Le.push(jt.i,F.i,Gt.i),jc(F),F=Gt.next,xt=Gt.next;else if((F=Gt)===xt){He?1===He?wc(F=Ic(_c(F),Le),Le,Oe,Fe,je,qe,2):2===He&&Sc(F,Le,Oe,Fe,je,qe):wc(_c(F),Le,Oe,Fe,je,qe,1);break}}}function Mc(F){const Le=F.prev,Oe=F,Fe=F.next;if(Cc(Le,Oe,Fe)>=0)return!1;const je=Le.x,qe=Oe.x,He=Fe.x,xt=Le.y,jt=Oe.y,Gt=Fe.y,bi=je<qe?je<He?je:He:qe<He?qe:He,wi=xt<jt?xt<Gt?xt:Gt:jt<Gt?jt:Gt,qr=je>qe?je>He?je:He:qe>He?qe:He,Xn=xt>jt?xt>Gt?xt:Gt:jt>Gt?jt:Gt;let Yn=Fe.next;for(;Yn!==Le;){if(Yn.x>=bi&&Yn.x<=qr&&Yn.y>=wi&&Yn.y<=Xn&&Bc(je,xt,qe,jt,He,Gt,Yn.x,Yn.y)&&Cc(Yn.prev,Yn,Yn.next)>=0)return!1;Yn=Yn.next}return!0}function Ac(F,Le,Oe,Fe){const je=F.prev,qe=F,He=F.next;if(Cc(je,qe,He)>=0)return!1;const xt=je.x,jt=qe.x,Gt=He.x,bi=je.y,wi=qe.y,qr=He.y,Xn=xt<jt?xt<Gt?xt:Gt:jt<Gt?jt:Gt,Yn=bi<wi?bi<qr?bi:qr:wi<qr?wi:qr,yo=xt>jt?xt>Gt?xt:Gt:jt>Gt?jt:Gt,bo=bi>wi?bi>qr?bi:qr:wi>qr?wi:qr,Do=kc(Xn,Yn,Le,Oe,Fe),Ro=kc(yo,bo,Le,Oe,Fe);let zs=F.prevZ,Zs=F.nextZ;for(;zs&&zs.z>=Do&&Zs&&Zs.z<=Ro;){if(zs.x>=Xn&&zs.x<=yo&&zs.y>=Yn&&zs.y<=bo&&zs!==je&&zs!==He&&Bc(xt,bi,jt,wi,Gt,qr,zs.x,zs.y)&&Cc(zs.prev,zs,zs.next)>=0)return!1;if(zs=zs.prevZ,Zs.x>=Xn&&Zs.x<=yo&&Zs.y>=Yn&&Zs.y<=bo&&Zs!==je&&Zs!==He&&Bc(xt,bi,jt,wi,Gt,qr,Zs.x,Zs.y)&&Cc(Zs.prev,Zs,Zs.next)>=0)return!1;Zs=Zs.nextZ}for(;zs&&zs.z>=Do;){if(zs.x>=Xn&&zs.x<=yo&&zs.y>=Yn&&zs.y<=bo&&zs!==je&&zs!==He&&Bc(xt,bi,jt,wi,Gt,qr,zs.x,zs.y)&&Cc(zs.prev,zs,zs.next)>=0)return!1;zs=zs.prevZ}for(;Zs&&Zs.z<=Ro;){if(Zs.x>=Xn&&Zs.x<=yo&&Zs.y>=Yn&&Zs.y<=bo&&Zs!==je&&Zs!==He&&Bc(xt,bi,jt,wi,Gt,qr,Zs.x,Zs.y)&&Cc(Zs.prev,Zs,Zs.next)>=0)return!1;Zs=Zs.nextZ}return!0}function Ic(F,Le){let Oe=F;do{const Fe=Oe.prev,je=Oe.next.next;!Dc(Fe,je)&&Rc(Fe,Oe,Oe.next,je)&&Oc(Fe,je)&&Oc(je,Fe)&&(Le.push(Fe.i,Oe.i,je.i),jc(Oe),jc(Oe.next),Oe=F=je),Oe=Oe.next}while(Oe!==F);return _c(Oe)}function Sc(F,Le,Oe,Fe,je,qe){let He=F;do{let F=He.next.next;for(;F!==He.prev;){if(He.i!==F.i&&Vc(He,F)){let xt=Nc(He,F);return He=_c(He,He.next),xt=_c(xt,xt.next),wc(He,Le,Oe,Fe,je,qe,0),void wc(xt,Le,Oe,Fe,je,qe,0)}F=F.next}He=He.next}while(He!==F)}function Pc(F,Le){return F.x-Le.x}function Ec(F,Le){const Oe=function(F,Le){let Oe=Le;const Fe=F.x,je=F.y;let qe,He=-1/0;do{if(je<=Oe.y&&je>=Oe.next.y&&Oe.next.y!==Oe.y){const F=Oe.x+(je-Oe.y)*(Oe.next.x-Oe.x)/(Oe.next.y-Oe.y);if(F<=Fe&&F>He&&(He=F,qe=Oe.x<Oe.next.x?Oe:Oe.next,F===Fe))return qe}Oe=Oe.next}while(Oe!==Le);if(!qe)return null;const xt=qe,jt=qe.x,Gt=qe.y;let bi=1/0;Oe=qe;do{if(Fe>=Oe.x&&Oe.x>=jt&&Fe!==Oe.x&&Bc(je<Gt?Fe:He,je,jt,Gt,je<Gt?He:Fe,je,Oe.x,Oe.y)){const Le=Math.abs(je-Oe.y)/(Fe-Oe.x);Oc(Oe,F)&&(Le<bi||Le===bi&&(Oe.x>qe.x||Oe.x===qe.x&&zc(qe,Oe)))&&(qe=Oe,bi=Le)}Oe=Oe.next}while(Oe!==xt);return qe}(F,Le);if(!Oe)return Le;const Fe=Nc(Oe,F);return _c(Fe,Fe.next),_c(Oe,Oe.next)}function zc(F,Le){return Cc(F.prev,F,Le.prev)<0&&Cc(Le.next,F,F.next)<0}function kc(F,Le,Oe,Fe,je){return(F=1431655765&((F=858993459&((F=252645135&((F=16711935&((F=(F-Oe)*je|0)|F<<8))|F<<4))|F<<2))|F<<1))|(Le=1431655765&((Le=858993459&((Le=252645135&((Le=16711935&((Le=(Le-Fe)*je|0)|Le<<8))|Le<<4))|Le<<2))|Le<<1))<<1}function Tc(F){let Le=F,Oe=F;do{(Le.x<Oe.x||Le.x===Oe.x&&Le.y<Oe.y)&&(Oe=Le),Le=Le.next}while(Le!==F);return Oe}function Bc(F,Le,Oe,Fe,je,qe,He,xt){return(je-He)*(Le-xt)>=(F-He)*(qe-xt)&&(F-He)*(Fe-xt)>=(Oe-He)*(Le-xt)&&(Oe-He)*(qe-xt)>=(je-He)*(Fe-xt)}function Vc(F,Le){return F.next.i!==Le.i&&F.prev.i!==Le.i&&!function(F,Le){let Oe=F;do{if(Oe.i!==F.i&&Oe.next.i!==F.i&&Oe.i!==Le.i&&Oe.next.i!==Le.i&&Rc(Oe,Oe.next,F,Le))return!0;Oe=Oe.next}while(Oe!==F);return!1}(F,Le)&&(Oc(F,Le)&&Oc(Le,F)&&function(F,Le){let Oe=F,Fe=!1;const je=(F.x+Le.x)/2,qe=(F.y+Le.y)/2;do{Oe.y>qe!=Oe.next.y>qe&&Oe.next.y!==Oe.y&&je<(Oe.next.x-Oe.x)*(qe-Oe.y)/(Oe.next.y-Oe.y)+Oe.x&&(Fe=!Fe),Oe=Oe.next}while(Oe!==F);return Fe}(F,Le)&&(Cc(F.prev,F,Le.prev)||Cc(F,Le.prev,Le))||Dc(F,Le)&&Cc(F.prev,F,F.next)>0&&Cc(Le.prev,Le,Le.next)>0)}function Cc(F,Le,Oe){return(Le.y-F.y)*(Oe.x-Le.x)-(Le.x-F.x)*(Oe.y-Le.y)}function Dc(F,Le){return F.x===Le.x&&F.y===Le.y}function Rc(F,Le,Oe,Fe){const je=Fc(Cc(F,Le,Oe)),qe=Fc(Cc(F,Le,Fe)),He=Fc(Cc(Oe,Fe,F)),xt=Fc(Cc(Oe,Fe,Le));return je!==qe&&He!==xt||!(0!==je||!Lc(F,Oe,Le))||!(0!==qe||!Lc(F,Fe,Le))||!(0!==He||!Lc(Oe,F,Fe))||!(0!==xt||!Lc(Oe,Le,Fe))}function Lc(F,Le,Oe){return Le.x<=Math.max(F.x,Oe.x)&&Le.x>=Math.min(F.x,Oe.x)&&Le.y<=Math.max(F.y,Oe.y)&&Le.y>=Math.min(F.y,Oe.y)}function Fc(F){return F>0?1:F<0?-1:0}function Oc(F,Le){return Cc(F.prev,F,F.next)<0?Cc(F,Le,F.next)>=0&&Cc(F,F.prev,Le)>=0:Cc(F,Le,F.prev)<0||Cc(F,F.next,Le)<0}function Nc(F,Le){const Oe=qc(F.i,F.x,F.y),Fe=qc(Le.i,Le.x,Le.y),je=F.next,qe=Le.prev;return F.next=Le,Le.prev=F,Oe.next=je,je.prev=Oe,Fe.next=Oe,Oe.prev=Fe,qe.next=Fe,Fe.prev=qe,Fe}function Uc(F,Le,Oe,Fe){const je=qc(F,Le,Oe);return Fe?(je.next=Fe.next,je.prev=Fe,Fe.next.prev=je,Fe.next=je):(je.prev=je,je.next=je),je}function jc(F){F.next.prev=F.prev,F.prev.next=F.next,F.prevZ&&(F.prevZ.nextZ=F.nextZ),F.nextZ&&(F.nextZ.prevZ=F.prevZ)}function qc(F,Le,Oe){return{i:F,x:Le,y:Oe,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function $c(F,Le){const Oe=F.length;if(Oe<=1)return[F];const Fe=[];let je,qe;for(let Le=0;Le<Oe;Le++){const Oe=dt(F[Le]);0!==Oe&&(F[Le].area=Math.abs(Oe),void 0===qe&&(qe=Oe<0),qe===Oe<0?(je&&Fe.push(je),je=[F[Le]]):je.push(F[Le]))}if(je&&Fe.push(je),Le>1)for(let F=0;F<Fe.length;F++)Fe[F].length<=Le||(br(Fe[F],Le,1,Fe[F].length-1,Gc),Fe[F]=Fe[F].slice(0,Le));return Fe}function Gc(F,Le){return Le.area-F.area}function Yc(F,Le,Oe=1){if(!F)return null;const Fe="string"==typeof F?er.from(F).getPrimary():F.getPrimary(),je=Fe.id.toString();return Le.has(je)||Le.set(je,[]),Fe.scaleSelf(Oe),Le.get(je).push(Fe),Fe.toString()}function Hc(F,Le,Oe,Fe){const je=Fe.patternDependencies;let qe=!1;for(const Fe of Le){const Le=Fe.paint.get(`${F}-pattern`);Le.isConstant()||(qe=!0),Yc(Le.constantOr(null),je,Oe)&&(qe=!0)}return qe}function Xc(F,Le,Oe,Fe,je,qe){const He=qe.patternDependencies;for(const xt of Le){const Le=xt.paint.get(`${F}-pattern`).value;if("constant"!==Le.kind){let F=Le.evaluate({zoom:Fe},Oe,{},qe.availableImages);F=F&&F.name?F.name:F;const jt=Yc(F,He,je);jt&&(Oe.patterns[xt.id]=jt)}}return Oe}var C_,P_,z_,D_,R_,L_,O_,k_={};function nh(){if(P_)return C_;P_=1;var Le=j();function e(Le,Oe,Fe,je,qe){(this||F).properties={},(this||F).extent=Fe,(this||F).type=0,(this||F)._pbf=Le,(this||F)._geometry=-1,(this||F)._keys=je,(this||F)._values=qe,Le.readFields(r,this||F,Oe)}function r(F,Le,Oe){1==F?Le.id=Oe.readVarint():2==F?function(F,Le){for(var Oe=F.readVarint()+F.pos;F.pos<Oe;){var Fe=Le._keys[F.readVarint()],je=Le._values[F.readVarint()];Le.properties[Fe]=je}}(Oe,Le):3==F?Le.type=Oe.readVarint():4==F&&(Le._geometry=Oe.pos)}function n(F){for(var Le,Oe,Fe=0,je=0,qe=F.length,He=qe-1;je<qe;He=je++)Fe+=((Oe=F[He]).x-(Le=F[je]).x)*(Le.y+Oe.y);return Fe}return C_=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var Oe=(this||F)._pbf;Oe.pos=(this||F)._geometry;for(var Fe,je=Oe.readVarint()+Oe.pos,qe=1,He=0,xt=0,jt=0,Gt=[];Oe.pos<je;){if(He<=0){var bi=Oe.readVarint();qe=7&bi,He=bi>>3}if(He--,1===qe||2===qe)xt+=Oe.readSVarint(),jt+=Oe.readSVarint(),1===qe&&(Fe&&Gt.push(Fe),Fe=[]),Fe.push(new Le(xt,jt));else{if(7!==qe)throw new Error("unknown command "+qe);Fe&&Fe.push(Fe[0].clone())}}return Fe&&Gt.push(Fe),Gt},e.prototype.bbox=function(){var Le=(this||F)._pbf;Le.pos=(this||F)._geometry;for(var Oe=Le.readVarint()+Le.pos,Fe=1,je=0,qe=0,He=0,xt=1/0,jt=-1/0,Gt=1/0,bi=-1/0;Le.pos<Oe;){if(je<=0){var wi=Le.readVarint();Fe=7&wi,je=wi>>3}if(je--,1===Fe||2===Fe)(qe+=Le.readSVarint())<xt&&(xt=qe),qe>jt&&(jt=qe),(He+=Le.readSVarint())<Gt&&(Gt=He),He>bi&&(bi=He);else if(7!==Fe)throw new Error("unknown command "+Fe)}return[xt,Gt,jt,bi]},e.prototype.toGeoJSON=function(Le,Oe,Fe){var je,qe,He=(this||F).extent*Math.pow(2,Fe),xt=(this||F).extent*Le,jt=(this||F).extent*Oe,Gt=this.loadGeometry(),bi=e.types[(this||F).type];function p(F){for(var Le=0;Le<F.length;Le++){var Oe=F[Le];F[Le]=[360*(Oe.x+xt)/He-180,360/Math.PI*Math.atan(Math.exp((180-360*(Oe.y+jt)/He)*Math.PI/180))-90]}}switch((this||F).type){case 1:var wi=[];for(je=0;je<Gt.length;je++)wi[je]=Gt[je][0];p(Gt=wi);break;case 2:for(je=0;je<Gt.length;je++)p(Gt[je]);break;case 3:for(Gt=function(F){var Le=F.length;if(Le<=1)return[F];for(var Oe,Fe,je=[],qe=0;qe<Le;qe++){var He=n(F[qe]);0!==He&&(void 0===Fe&&(Fe=He<0),Fe===He<0?(Oe&&je.push(Oe),Oe=[F[qe]]):Oe.push(F[qe]))}return Oe&&je.push(Oe),je}(Gt),je=0;je<Gt.length;je++)for(qe=0;qe<Gt[je].length;qe++)p(Gt[je][qe])}1===Gt.length?Gt=Gt[0]:bi="Multi"+bi;var qr={type:"Feature",geometry:{type:bi,coordinates:Gt},properties:(this||F).properties};return"id"in(this||F)&&(qr.id=(this||F).id),qr},C_}function ih(){if(D_)return z_;D_=1;var Le=nh();function e(Le,Oe){(this||F).version=1,(this||F).name=null,(this||F).extent=4096,(this||F).length=0,(this||F)._pbf=Le,(this||F)._keys=[],(this||F)._values=[],(this||F)._features=[],Le.readFields(r,this||F,Oe),(this||F).length=(this||F)._features.length}function r(F,Le,Oe){15===F?Le.version=Oe.readVarint():1===F?Le.name=Oe.readString():5===F?Le.extent=Oe.readVarint():2===F?Le._features.push(Oe.pos):3===F?Le._keys.push(Oe.readString()):4===F&&Le._values.push(function(F){for(var Le=null,Oe=F.readVarint()+F.pos;F.pos<Oe;){var Fe=F.readVarint()>>3;Le=1===Fe?F.readString():2===Fe?F.readFloat():3===Fe?F.readDouble():4===Fe?F.readVarint64():5===Fe?F.readVarint():6===Fe?F.readSVarint():7===Fe?F.readBoolean():null}return Le}(Oe))}return z_=e,e.prototype.feature=function(Oe){if(Oe<0||Oe>=(this||F)._features.length)throw new Error("feature index out of bounds");(this||F)._pbf.pos=(this||F)._features[Oe];var Fe=(this||F)._pbf.readVarint()+(this||F)._pbf.pos;return new Le((this||F)._pbf,Fe,(this||F).extent,(this||F)._keys,(this||F)._values)},z_}function sh(){return O_||(O_=1,k_.VectorTile=function(){if(L_)return R_;L_=1;var Le=ih();function e(F,Oe,Fe){if(3===F){var je=new Le(Fe,Fe.readVarint()+Fe.pos);je.length&&(Oe[je.name]=je)}}return R_=function(Le,Oe){(this||F).layers=Le.readFields(e,{},Oe)},R_}(),k_.VectorTileFeature=nh(),k_.VectorTileLayer=ih()),k_}var F_=sh();const B_="3d_elevation_id",N_="level";class uh{constructor(){this._valid=!1}reset(F){return this.feature=F,this._valid=!0,this._geometry=F.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(F,Le){return this._valid&&F(Le(this._geometry)),this}require(F,Le,Oe){return this.get(F,!0,Le,Oe)}optional(F,Le,Oe){return this.get(F,!1,Le,Oe)}success(){return this._valid}get(F,Le,Oe,Fe){const je=this.feature.properties.hasOwnProperty(F)?+this.feature.properties[F]:void 0;return this._valid&&void 0!==je?Oe(Fe?Fe(je):je):Le&&(this._valid=!1),this}}class ch{constructor(F,Le){this.featureFunc=F,this.vertexFunc=Le}parseFeature(F,Le,Oe){return this.featureFunc(F,Le,Oe)}parseVertex(F,Le,Oe){return this.vertexFunc(F,Le,Oe)}}const V_=new ch(((F,Le,Oe)=>F.reset(Le).require(B_,(F=>{Oe.id=F})).optional("fixed_height_relative",(F=>{Oe.constantHeight=F}),fh.decodeRelativeHeight).geometry((F=>{Oe.bounds=F}),fh.computeBounds).success()),((F,Le,Oe)=>F.reset(Le).require(B_,(F=>{Oe.id=F})).require("elevation_idx",(F=>{Oe.idx=F})).require("extent",(F=>{Oe.extent=F})).require("height_relative",(F=>{Oe.height=F}),fh.decodeRelativeHeight).geometry((F=>{Oe.position=F}),fh.getPoint).success())),U_=new ch(((F,Le,Oe)=>F.reset(Le).require(B_,(F=>{Oe.id=F})).optional("fixed_height",(F=>{Oe.constantHeight=F}),fh.decodeMetricHeight).geometry((F=>{Oe.bounds=F}),fh.computeBounds).success()),((F,Le,Oe)=>F.reset(Le).require(B_,(F=>{Oe.id=F})).require("elevation_idx",(F=>{Oe.idx=F})).require("extent",(F=>{Oe.extent=F})).require("height",(F=>{Oe.height=F}),fh.decodeMetricHeight).geometry((F=>{Oe.position=F}),fh.getPoint).success()));class fh{static computeBounds(F){const Le=new ic(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),Oe=new ic(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const Fe of F[0])Le.x>Fe.x&&(Le.x=Fe.x),Le.y>Fe.y&&(Le.y=Fe.y),Oe.x<Fe.x&&(Oe.x=Fe.x),Oe.y<Fe.y&&(Oe.y=Fe.y);return{min:Le,max:Oe}}static getPoint(F){return kl.vec2.fromValues(F[0][0].x,F[0][0].y)}static decodeRelativeHeight(F){return 1e-4*F*5}static decodeMetricHeight(F){return 1e-4*F}static parse(F){const Le=[],Oe=[],Fe=F.length,je=new uh;for(let He=0;He<Fe;He++){const Fe=F.feature(He),xt=Fe.properties.hasOwnProperty("version")?String(Fe.properties.version):void 0,jt=(qe=xt)?"1.0.1"===qe?U_:void 0:V_;if(void 0===jt){pt(`Unknown elevation feature version number ${xt||"(unknown)"}`);continue}const Gt=Fe.properties.hasOwnProperty("type")?Fe.properties.type:void 0;if(Gt)if("Point"===F_.VectorTileFeature.types[Fe.type]&&"curve_point"===Gt){const F={};jt.parseVertex(je,Fe,F)&&Le.push(F)}else if("Polygon"===F_.VectorTileFeature.types[Fe.type]&&"curve_meta"===Gt){const F={};jt.parseFeature(je,Fe,F)&&Oe.push(F)}}var qe;return{vertices:Le,features:Oe}}}class dh{constructor(F,Le,Oe,Fe,je,qe){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=F,this.heightRange={min:Oe,max:Oe},this.safeArea=Le,this.constantHeight=Oe,null==this.constantHeight&&(null!=this.constantHeight||0!==Fe.length)){this.vertices=Fe,this.edges=je,this.edges=this.edges.filter((F=>F.a<this.vertices.length&&F.b<this.vertices.length&&!kl.vec2.exactEquals(this.vertices[F.a].position,this.vertices[F.b].position))),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const F of this.vertices)this.vertexProps.push({dir:kl.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,F.height),this.heightRange.max=Math.max(this.heightRange.max,F.height);for(const F of this.edges){const Le=this.vertices[F.a].position,Oe=this.vertices[F.b].position,Fe=kl.vec2.subtract(kl.vec2.create(),Oe,Le),je=kl.vec2.length(Fe),qe=kl.vec2.scale(kl.vec2.create(),Fe,1/je);this.edgeProps.push({vec:Fe,dir:qe,len:je});const He=this.vertexProps[F.a].dir,xt=this.vertexProps[F.b].dir;kl.vec2.add(He,He,qe),kl.vec2.add(xt,xt,qe)}for(const F of this.vertexProps)0===F.dir[0]&&0===F.dir[1]||kl.vec2.normalize(F.dir,F.dir);this.tessellate(qe)}}pointElevation(F){if(null!=this.constantHeight)return this.constantHeight;const Le=this.getClosestEdge(F);if(null==Le)return 0;const[Oe,Fe]=Le;return((F,Le,Oe)=>(1-Oe)*F+Oe*Le)(this.vertices[this.edges[Oe].a].height,this.vertices[this.edges[Oe].b].height,Fe)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(F){if(0===this.edges.length)return;let Le=0,Oe=Number.POSITIVE_INFINITY,Fe=0;const je=kl.vec2.fromValues(F.x,F.y);for(let F=0;F<this.edges.length;F++){const qe=this.edges[F],He=this.edgeProps[F].dir,xt=new yu(je,this.edgeProps[F].dir),jt=this.vertices[qe.a].position,Gt=this.vertices[qe.b].position,bi=kl.vec2.create(),wi=kl.vec2.create(),qr=xt.intersectsPlane(jt,this.vertexProps[qe.a].dir,bi),Xn=xt.intersectsPlane(Gt,this.vertexProps[qe.b].dir,wi);if(!qr||!Xn)continue;const Yn=kl.vec2.subtract(kl.vec2.create(),wi,bi),yo=kl.vec2.subtract(kl.vec2.create(),je,bi),bo=kl.vec2.dot(Yn,Yn),Do=bo>0?kl.vec2.dot(yo,Yn)/bo:0,Ro=Q(Do,0,1),zs=Math.abs((Do-Ro)*this.edgeProps[F].len),Zs=kl.vec2.subtract(kl.vec2.create(),je,jt),na=zs+Math.abs(kl.vec2.dot(Zs,kl.vec2.fromValues(He[1],-He[0])));na<Oe&&(Le=F,Oe=na,Fe=Ro)}return[Le,Fe]}tessellate(F){for(let Le=this.edges.length-1;Le>=0;--Le){const Oe=this.edges[Le].a,Fe=this.edges[Le].b,{position:je,height:qe,extent:He}=this.vertices[Oe],{position:xt,height:jt,extent:Gt}=this.vertices[Fe],bi=this.vertexProps[Oe].dir,wi=this.vertexProps[Fe].dir,qr=kl.vec3.fromValues(je[0]/F,je[1]/F,qe),Xn=kl.vec3.fromValues(xt[0]/F,xt[1]/F,jt),Yn=kl.vec3.fromValues(bi[1],-bi[0],0);kl.vec3.scale(Yn,Yn,He);const yo=kl.vec3.fromValues(wi[1],-wi[0],0);if(kl.vec3.scale(yo,yo,Gt),this.distSqLines(kl.vec3.fromValues(qr[0]+.5*Yn[0],qr[1]+.5*Yn[1],qr[2]+.5*Yn[2]),kl.vec3.fromValues(Xn[0]-.5*yo[0],Xn[1]-.5*yo[1],Xn[2]-.5*yo[2]),kl.vec3.fromValues(qr[0]-.5*Yn[0],qr[1]-.5*Yn[1],qr[2]-.5*Yn[2]),kl.vec3.fromValues(Xn[0]+.5*yo[0],Xn[1]+.5*yo[1],Xn[2]+.5*yo[2]))<=.05*.05)continue;const bo=this.vertices.length,Do=kl.vec2.add(kl.vec2.create(),je,xt);this.vertices.push({position:kl.vec2.scale(Do,Do,.5),height:.5*(qe+jt),extent:.5*(He+Gt)});const Ro=kl.vec2.add(kl.vec2.create(),bi,wi);this.vertexProps.push({dir:kl.vec2.normalize(Ro,Ro)}),this.edges.splice(Le,1),this.edgeProps.splice(Le,1),this.edges.push({a:Oe,b:bo}),this.edges.push({a:bo,b:Fe});const zs=kl.vec2.subtract(kl.vec2.create(),this.vertices[bo].position,je),Zs=kl.vec2.length(zs),na={vec:zs,dir:kl.vec2.scale(kl.vec2.create(),zs,1/Zs),len:Zs};this.edgeProps.push(na),this.edgeProps.push(na)}}distSqLines(F,Le,Oe,Fe){const je=kl.vec3.subtract(kl.vec3.create(),Le,F),qe=kl.vec3.subtract(kl.vec3.create(),Fe,Oe),He=kl.vec3.subtract(kl.vec3.create(),F,Oe),xt=kl.vec3.dot(je,je),jt=kl.vec3.dot(je,qe),Gt=kl.vec3.dot(je,He),bi=kl.vec3.dot(qe,qe),wi=kl.vec3.dot(qe,He),qr=xt*bi-jt*jt;if(0===qr){const Le=kl.vec3.dot(He,qe)/kl.vec3.dot(qe,qe),je=kl.vec3.lerp(kl.vec3.create(),Oe,Fe,Le);return kl.vec3.squaredDistance(je,F)}const Xn=(jt*wi-Gt*bi)/qr,Yn=(xt*wi-jt*Gt)/qr,yo=kl.vec3.lerp(kl.vec3.create(),F,Le,Xn),bo=kl.vec3.lerp(kl.vec3.create(),Oe,Fe,Yn);return kl.vec3.squaredDistance(yo,bo)}}class mh{constructor(F,Le){this.zScale=1,this.xOffset=0,this.yOffset=0,F.equals(Le)||(this.zScale=Math.pow(2,Le.z-F.z),this.xOffset=(F.x*this.zScale-Le.x)*sp,this.yOffset=(F.y*this.zScale-Le.y)*sp)}constantElevation(F,Le){if(null!=F.constantHeight)return this.computeBiasedHeight(F.constantHeight,Le)}pointElevation(F,Le,Oe){const Fe=this.constantElevation(Le,Oe);return null!=Fe?Fe:(F.x=F.x*this.zScale+this.xOffset,F.y=F.y*this.zScale+this.yOffset,this.computeBiasedHeight(Le.pointElevation(F),Oe))}computeBiasedHeight(F,Le){return Le<=0?F:F+Le*tt(0,Le,F>=0?F:Math.abs(.5*F))}}us(dh,"ElevationFeature");class yh{constructor(){this.polygons=new Map}add(F,...Le){this.polygons.has(F)?this.polygons.get(F).push(...Le):this.polygons.set(F,Le)}merge(F){for(const[Le,Oe]of F.polygons)this.add(Le,...Oe)}}class gh{constructor(){this.portals=[]}static evaluate(F){if(0===F.length)return new gh;let Le=[];for(const Oe of F)Le.push(...Oe.portals);if(0===Le.length)return new gh;const r=(F,Le)=>F<=0&&Le<=0||F>=sp&&Le>=sp;for(const F of Le){const Le=F.va,Oe=F.vb;(r(Le.x,Oe.x)||r(Le.y,Oe.y))&&(F.type="border")}const Oe=Le.filter((F=>"unevaluated"!==F.type)),Fe=Le.filter((F=>"unevaluated"===F.type));if(0===Fe.length)return new gh;Fe.sort(((F,Le)=>F.hash===Le.hash?F.isTunnel===Le.isTunnel?0:F.isTunnel?-1:1:F.hash<Le.hash?1:-1)),Le=Oe.concat(Fe);let je=Oe.length,qe=je,He=je;do{if(qe++,qe===Le.length||Le[je].hash!==Le[qe].hash){if(qe-je==2){He<je&&(Le[He]=Le[je],Le[je]=null);const F=Le[He],Oe=Le[qe-1];F.type=F.isTunnel!==Oe.isTunnel?"tunnel":"polygon",F.connection={a:F.connection.a,b:Oe.connection.a},He++}je=qe}}while(je!==Le.length);return Le.splice(He),Le.sort(((F,Le)=>F.hash<Le.hash?1:-1)),{portals:Le}}}us(gh,"ElevationPortalGraph"),us(yh,"ElevationPolygons");class xh{constructor(F,Le,Oe){this.outPositions=F,this.outNormals=Le,this.outIndices=Oe,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(F,Le,Oe){let Fe=F[2];null!=Oe&&(Fe*=Oe);const je=this.getVec3Bits(F)<<96n|this.getVec3Bits(Le),qe=this.vertexLookup.get(je);if(null!=qe)return qe;const He=this.outPositions.length;this.vertexLookup.set(je,He);const xt=Math.trunc(16384*Le[0]),jt=Math.trunc(16384*Le[1]),Gt=Math.trunc(16384*Le[2]);return this.outPositions.emplaceBack(F[0],F[1],Fe),this.outNormals.emplaceBack(xt,jt,Gt),He}addVertices(F,Le,...Oe){const Fe=[];for(const je of Oe){const Oe=this.addVertex(je,F,Le);Fe.push(Oe)}return Fe}addTriangles(F,Le,Oe){if(Le&&Oe){const Fe=1===Oe.length,je=kl.vec3.fromValues(0,0,0);for(let qe=0;qe<F.length;qe+=3){const He=Le[F[qe+0]],xt=Le[F[qe+1]],jt=Le[F[qe+2]],Gt=Fe?Oe[0]:Oe[F[qe+1]],bi=Fe?Oe[0]:Oe[F[qe+2]],wi=this.addVertex(kl.vec3.fromValues(He.x,He.y,Fe?Oe[0]:Oe[F[qe+0]]),je),qr=this.addVertex(kl.vec3.fromValues(xt.x,xt.y,Gt),je),Xn=this.addVertex(kl.vec3.fromValues(jt.x,jt.y,bi),je);this.outIndices.emplaceBack(wi,qr,Xn)}}else for(let Le=0;Le<F.length;Le+=3)this.outIndices.emplaceBack(F[Le+0],F[Le+1],F[Le+2])}addQuad(F,Le){const Oe=this.addVertices(Le,void 0,...F.map((F=>kl.vec3.fromValues(F.coord.x,F.coord.y,F.height)))),[Fe,je,qe,He]=Oe;this.addTriangles([Fe,je,qe,qe,He,Fe])}getBits(F){return this.view.setFloat32(0,F),BigInt(this.view.getUint32(0))}getVec3Bits(F){return this.getBits(F[0])<<64n|this.getBits(F[1])<<32n|this.getBits(F[2])}}class vh{constructor(F){this.unevaluatedPortals=new gh,this.portalPolygons=new yh,this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Ia,this.vertexNormals=new Sa,this.indexArray=new ja,this.tileToMeters=Al(F)}addVertices(F,Le){const Oe=this.unevalVertices.length;for(let Oe=0;Oe<F.length;Oe++)this.unevalVertices.push(F[Oe]),this.unevalHeights.push(Le[Oe]);return Oe}addTriangles(F,Le,Oe){const Fe=Oe?this.unevalTunnelTriangles:this.unevalTriangles;for(const Oe of F)Fe.push(Oe+Le)}addRenderableRing(F,Le,Oe,Fe,je){const qe=[new ic(je.min.x,je.min.y),new ic(je.max.x,je.min.y),new ic(je.max.x,je.max.y),new ic(je.min.x,je.max.y)];for(let He=0;He<Oe-1;He++){const Oe=Le+He,xt=Oe+1,jt=this.unevalVertices[Oe],Gt=this.unevalVertices[xt];if(!(jt.x>=je.min.x&&jt.x<=je.max.x&&jt.y>=je.min.y&&jt.y<=je.max.y||Gt.x>=je.min.x&&Gt.x<=je.max.x&&Gt.y>=je.min.y&&Gt.y<=je.max.y||Zl(jt,Gt,qe)))continue;if(this.isOnBorder(jt.x,Gt.x)||this.isOnBorder(jt.y,Gt.y))continue;const bi=vh.computeEdgeHash(this.unevalVertices[Oe],this.unevalVertices[xt]);let wi,qr=this.vertexHashLookup.get(vh.computePosHash(jt));null!=qr?wi=qr.next:(qr=this.vertexHashLookup.get(vh.computePosHash(Gt)),wi=null!=qr?qr.prev:bi),this.unevalEdges.push({polygonIdx:F,a:Oe,b:xt,hash:bi,portalHash:wi,isTunnel:Fe,type:"unevaluated"})}}addPortalCandidates(F,Le,Oe,Fe,je){if(0===Le.length)return;this.portalPolygons.add(F,{geometry:Le,zLevel:je});const qe=Le[0];this.vertexHashLookup.clear();let He=vh.computeEdgeHash(qe[qe.length-2],qe[qe.length-1]);for(let Le=0;Le<qe.length-1;Le++){const je=qe[Le+0],xt=qe[Le+1],jt=kl.vec2.fromValues(xt.x-je.x,xt.y-je.y),Gt=kl.vec2.length(jt);if(0===Gt)continue;let bi="unevaluated";const wi=Fe.pointElevation(je),qr=Fe.pointElevation(xt);Math.abs(wi)<.01&&Math.abs(qr)<.01?bi="entrance":(this.isOnBorder(je.x,xt.x)||this.isOnBorder(je.y,xt.y))&&(bi="border");const Xn=vh.computeEdgeHash(je,xt);this.unevaluatedPortals.portals.push({connection:{a:F,b:void 0},va:je,vb:xt,vab:jt,length:Gt,hash:Xn,isTunnel:Oe,type:bi});const Yn=vh.computePosHash(je);this.vertexHashLookup.set(Yn,{prev:He,next:Xn}),He=Xn}}construct(F){if(0===this.unevalVertices.length)return;const e=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),r=F=>{F.primitiveLength=this.indexArray.length-F.primitiveOffset},Le=new xh(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(F.portals,this.unevalEdges);const Oe=e(),Fe=e(),je=e(),o=(F,Le)=>{F.sort(((F,Oe)=>F.type===Le&&Oe.type!==Le?-1:F.type!==Le&&Oe.type===Le?1:0));const Oe=F.findIndex((F=>F.type!==Le));return Oe>=0?Oe:F.length};let qe=0;this.unevalEdges.length>0&&(qe=o(this.unevalEdges,"none"),this.constructBridgeStructures(Le,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:qe},this.tileToMeters));const He=e();if(this.unevalEdges.length>0){const F=this.unevalEdges.splice(qe),Oe=o(F,"tunnel")+qe;this.unevalEdges.push(...F),this.constructTunnelStructures(Le,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:qe},{min:qe,max:Oe})}r(je),Le.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),r(He),Le.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),r(Fe),Le.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),r(Oe),this.maskSegments=xo.simpleSegment(0,He.primitiveOffset,0,He.primitiveLength),this.depthSegments=xo.simpleSegment(0,Fe.primitiveOffset,0,Fe.primitiveLength),this.renderableSegments=xo.simpleSegment(0,je.primitiveOffset,0,je.primitiveLength),this.shadowCasterSegments=xo.simpleSegment(0,Oe.primitiveOffset,0,Oe.primitiveLength)}upload(F){this.vertexBuffer||0===this.vertexPositions.length||0===this.vertexNormals.length||0===this.indexArray.length||(this.vertexBuffer=F.createVertexBuffer(this.vertexPositions,A_.members),this.vertexBufferNormal=F.createVertexBuffer(this.vertexNormals,I_.members),this.indexBuffer=F.createIndexBuffer(this.indexArray))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableSegments.destroy(),this.shadowCasterSegments.destroy())}computeVertexConnections(F,Le,Oe,Fe){const je=new Map;for(let qe=Oe;qe<Fe;qe++){const Oe=Le[qe],Fe=Oe.a,He=Oe.b;je.has(Fe)||je.set(Fe,{}),je.has(He)||je.set(He,{});const xt=je.get(Fe),jt=je.get(He);F[He]>0&&(xt.to=He),F[Fe]>0&&(jt.from=Fe)}return je}constructBridgeStructures(F,Le,Oe,Fe,je,qe){const He=this.computeVertexConnections(Oe,Fe,je.min,je.max),xt=1/qe,jt=.5*xt,u=F=>kl.vec3.fromValues(Le[F].x,Le[F].y,Oe[F]*xt),c=F=>{const Le=He.get(F),Oe=Le.from,Fe=Le.to;if(!Oe||!Fe)return;const je=u(Oe),qe=u(F),xt=u(Fe),jt=kl.vec3.fromValues(0,0,0);if(!kl.vec3.exactEquals(je,qe)){const F=kl.vec3.sub(kl.vec3.create(),qe,je);kl.vec3.add(jt,jt,kl.vec3.normalize(F,F))}if(!kl.vec3.exactEquals(xt,qe)){const F=kl.vec3.sub(kl.vec3.create(),xt,qe);kl.vec3.add(jt,jt,kl.vec3.normalize(F,F))}const Gt=kl.vec3.len(jt);return Gt>0?kl.vec3.scale(jt,jt,1/Gt):void 0};for(let He=je.min;He<je.max;He++){const je=Fe[He],Gt=this.prepareEdgePoints(Le,Oe,je,((F,Le)=>F>=Le));if(null==Gt)continue;const bi=Gt[0],wi=Gt[1],qr=kl.vec3.fromValues(bi.coord.x,bi.coord.y,xt*bi.height),Xn=kl.vec3.fromValues(wi.coord.x,wi.coord.y,xt*wi.height);if(kl.vec3.exactEquals(qr,Xn))continue;const Yn=kl.vec3.sub(kl.vec3.create(),Xn,qr);kl.vec3.normalize(Yn,Yn);const y=F=>kl.vec3.normalize(F,F),yo=c(je.a)||Yn,bo=c(je.b)||Yn,Do=y(kl.vec3.fromValues(yo[1],-yo[0],0)),Ro=y(kl.vec3.fromValues(bo[1],-bo[0],0)),zs=y(kl.vec3.cross(kl.vec3.create(),Do,yo)),Zs=y(kl.vec3.cross(kl.vec3.create(),Ro,bo)),na=kl.vec3.create(),el=[kl.vec3.add(kl.vec3.create(),qr,kl.vec3.scale(na,kl.vec3.sub(na,Do,zs),jt)),kl.vec3.add(kl.vec3.create(),qr,kl.vec3.scale(na,kl.vec3.add(na,Do,zs),jt)),kl.vec3.add(kl.vec3.create(),qr,kl.vec3.scale(na,zs,jt)),qr],nl=[kl.vec3.add(kl.vec3.create(),Xn,kl.vec3.scale(na,kl.vec3.sub(na,Ro,Zs),jt)),kl.vec3.add(kl.vec3.create(),Xn,kl.vec3.scale(na,kl.vec3.add(na,Ro,Zs),jt)),kl.vec3.add(kl.vec3.create(),Xn,kl.vec3.scale(na,Zs,jt)),Xn],[hl,pl]=F.addVertices(Do,qe,el[0],el[1]),[bl,Tl]=F.addVertices(Ro,qe,nl[0],nl[1]);F.addTriangles([hl,pl,bl,pl,Tl,bl]);const[ec,tc]=F.addVertices(zs,qe,el[1],el[2]),[ic,oc]=F.addVertices(Zs,qe,nl[1],nl[2]);F.addTriangles([ec,tc,ic,tc,oc,ic]);const[sc,ac]=F.addVertices(kl.vec3.negate(Do,Do),qe,el[2],el[3]),[mc,gc]=F.addVertices(kl.vec3.negate(Ro,Ro),qe,nl[2],nl[3]);F.addTriangles([sc,ac,mc,ac,gc,mc])}}constructTunnelStructures(F,Le,Oe,Fe,je,qe){const a=F=>kl.vec3.normalize(F,F);for(let qe=je.min;qe<je.max;qe++){const je=this.prepareEdgePoints(Le,Oe,Fe[qe],((F,Le)=>F<=Le));if(null==je)continue;const[He,xt]=je,jt=a(kl.vec3.fromValues(xt.coord.y-He.coord.y,-(xt.coord.x-He.coord.x),0));F.addQuad([He,xt,{coord:xt.coord,height:Fe[qe].isTunnel?-.1:0},{coord:He.coord,height:Fe[qe].isTunnel?-.1:0}],jt)}for(let je=qe.min;je<qe.max;je++){const qe=Fe[je],He=Le[qe.a],xt=Le[qe.b],jt=a(kl.vec3.fromValues(xt.y-He.y,-(xt.x-He.x),0));F.addQuad([{coord:xt,height:0},{coord:He,height:0},{coord:He,height:Oe[qe.a]+4},{coord:xt,height:Oe[qe.b]+4}],jt),F.addQuad([{coord:He,height:0},{coord:xt,height:0},{coord:xt,height:Oe[qe.b]+4},{coord:He,height:Oe[qe.a]+4}],jt)}}prepareEdgePoints(F,Le,Oe,Fe){const je=F[Oe.a],qe=F[Oe.b];let He=Le[Oe.a],xt=Le[Oe.b];if(!(0!==He&&Fe(He,0)||0!==xt&&Fe(xt,0)))return;const jt=je.clone(),Gt=qe.clone();if(Fe(He,0)){if(!Fe(xt,0)){const F=xt/(xt-He);Gt.x=Ee(Gt.x,jt.x,F),Gt.y=Ee(Gt.y,jt.y,F),xt=Ee(xt,He,F)}}else{const F=He/(He-xt);jt.x=Ee(jt.x,Gt.x,F),jt.y=Ee(jt.y,Gt.y,F),He=Ee(He,xt,F)}return[{coord:jt,height:He},{coord:Gt,height:xt}]}prepareEdges(F,Le){if(0===Le.length)return;Le.sort(((F,Le)=>F.hash===Le.hash?Le.polygonIdx-F.polygonIdx:Le.hash>F.hash?1:-1));let Oe=0,Fe=0,je=0,qe=Le[Oe].polygonIdx;do{Fe++,(Fe===Le.length||Le[Oe].hash!==Le[Fe].hash)&&((1==Fe-Oe||Le[Fe-1].polygonIdx!==qe)&&(je<Oe&&(Le[je]=Le[Oe],Le[Oe]=null),Le[je].type="none",je++),Oe=Fe,Oe!==Le.length&&(qe=Le[Oe].polygonIdx))}while(Oe!==Le.length);if(Le.splice(je),0!==Le.length&&0!==F.length){Le.sort(((F,Le)=>F.hash<Le.hash?1:-1));let Oe=0,Fe=0;for(;Oe!==Le.length&&Fe!==F.length;){const je=Le[Oe],qe=F[Fe];je.portalHash>qe.hash?Oe++:qe.hash>je.portalHash?Fe++:(je.type=qe.type,Oe++)}}}isOnBorder(F,Le){return F<=0&&Le<=0||F>=sp&&Le>=sp}static computeEdgeHash(F,Le){return(F.y===Le.y&&F.x>Le.x||F.y>Le.y)&&([F,Le]=[Le,F]),BigInt(vh.computePosHash(F))<<32n|BigInt(vh.computePosHash(Le))}static computePosHash(F){return((65535&F.x)<<16|65535&F.y)>>>0}}class bh{constructor(F,Le){this.layoutVertexArray=new _a,this.indexArray=new ja,this.lineIndexArray=new La,this.triangleSegments=new xo,this.lineSegments=new xo,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.uploaded=!1,Le&&(this.elevatedLayoutVertexArray=new Aa)}update(F,Le,Oe,Fe,je,qe,He){this.programConfigurations.updatePaintArrays(F,Le,je,Oe,Fe,qe,He)}isEmpty(){return 0===this.layoutVertexArray.length}needsUpload(){return this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,E_.members),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.lineIndexBuffer=F.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=F.createVertexBuffer(this.elevatedLayoutVertexArray,M_.members))),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(F,Le,Oe,Fe,je,qe){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Le,Oe,Fe,je,qe)}}class _h{constructor(F){this.zoom=F.zoom,this.pixelRatio=F.pixelRatio,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.patternFeatures=[],this.bufferData=new bh(F,!1),this.elevationBufferData=new bh(F,!0),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.projection=F.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference")}updateFootprints(F,Le){}populate(F,Le,Oe,Fe){this.hasPattern=Hc("fill",this.layers,this.pixelRatio,Le);const je=this.layers[0].layout.get("fill-sort-key"),qe=[];for(const{feature:He,id:xt,index:jt,sourceLayerIndex:Gt}of F){const F=this.layers[0]._featureFilter.needGeometry,bi=Cl(He,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),bi,Oe))continue;const wi=je?je.evaluate(bi,{},Oe,Le.availableImages):void 0,qr={id:xt,properties:He.properties,type:He.type,sourceLayerIndex:Gt,index:jt,geometry:F?bi.geometry:Vl(He,Oe,Fe),patterns:{},sortKey:wi};qe.push(qr)}je&&qe.sort(((F,Le)=>F.sortKey-Le.sortKey));for(const Fe of qe){const{geometry:je,index:qe,sourceLayerIndex:He}=Fe;if(this.hasPattern){const F=Xc("fill",this.layers,Fe,this.zoom,this.pixelRatio,Le);this.patternFeatures.push(F)}else this.addFeature(Fe,je,qe,Oe,{},Le.availableImages,Le.brightness,Le.elevationFeatures);Le.featureIndex.insert(F[qe].feature,je,qe,He,this.index)}}update(F,Le,Oe,Fe,je,qe,He){this.bufferData.update(F,Le,Oe,Fe,je,qe,He),this.elevationBufferData.update(F,Le,Oe,Fe,je,qe,He)}addFeatures(F,Le,Oe,Fe,je,qe){for(const je of this.patternFeatures)this.addFeature(je,je.geometry,je.index,Le,Oe,Fe,qe,F.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(F){this.bufferData.upload(F),this.elevationBufferData.upload(F),this.elevatedStructures&&this.elevatedStructures.upload(F)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(F,Le,Oe,Fe,je,qe=[],He,xt){const jt=$c(Le,500);"none"!==this.elevationMode?this.addElevatedRoadFeature(F,jt,Fe,Oe,xt):this.addGeometry(jt,this.bufferData),this.bufferData.populatePaintArrays(F,Oe,je,qe,Fe,He),this.elevationBufferData.populatePaintArrays(F,Oe,je,qe,Fe,He)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(F){this.elevatedStructures&&this.elevatedStructures.construct(F)}addElevatedRoadFeature(F,Le,Oe,Fe,je){const qe=new Array,He=this.getElevationFeature(F,je);if(He){qe.push({polygons:Le,elevationFeature:He,elevationTileID:Oe});for(const Le of qe)if(Le.elevationFeature){if("hd-road-base"===this.elevationMode){this.elevatedStructures||(this.elevatedStructures=new vh(Le.elevationTileID));const Oe=Le.elevationFeature.isTunnel();let Fe=0;F.properties.hasOwnProperty(N_)&&(Fe=+F.properties[N_]);for(const F of Le.polygons)this.elevatedStructures.addPortalCandidates(Le.elevationFeature.id,F,Oe,Le.elevationFeature,Fe)}const je=new mh(Oe,Le.elevationTileID);this.addElevatedGeometry(Le.polygons,je,Le.elevationFeature,"hd-road-base"===this.elevationMode?0:.05,Fe)}}else this.addGeometry(Le,this.bufferData)}addElevatedGeometry(F,Le,Oe,Fe,je){const qe={elevation:Oe,elevationSampler:Le,bias:Fe,index:je},[He,xt]=this.addGeometry(F,this.elevationBufferData,qe);null==this.elevationBufferData.heightRange?this.elevationBufferData.heightRange={min:He,max:xt}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,He),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,xt))}addGeometry(F,Le,Oe){let Fe=Number.POSITIVE_INFINITY,je=Number.NEGATIVE_INFINITY,qe=null;Oe&&(qe=Oe.elevationSampler.constantElevation(Oe.elevation,Oe.bias),null!=qe&&(Fe=qe,je=qe));const a=(F,He,xt)=>{if(null!=Oe)if(He.push(F),null!=qe)Le.elevatedLayoutVertexArray.emplaceBack(qe),xt.push(qe);else{const qe=Oe.elevationSampler.pointElevation(F,Oe.elevation,Oe.bias);Le.elevatedLayoutVertexArray.emplaceBack(qe),xt.push(qe),Fe=Math.min(Fe,qe),je=Math.max(je,qe)}};for(const Fe of F){let F=0;for(const Le of Fe)F+=Le.length;const je=Le.triangleSegments.prepareSegment(F,Le.layoutVertexArray,Le.indexArray),qe=je.vertexLength,He=[],xt=[],jt=[],Gt=[],bi=[],wi=Le.layoutVertexArray.length;for(const F of Fe){if(0===F.length)continue;F!==Fe[0]&&xt.push(He.length/2);const je=Le.lineSegments.prepareSegment(F.length,Le.layoutVertexArray,Le.lineIndexArray),qe=je.vertexLength;Oe&&bi.push(Le.layoutVertexArray.length-wi),a(F[0],jt,Gt),Le.layoutVertexArray.emplaceBack(F[0].x,F[0].y),Le.lineIndexArray.emplaceBack(qe+F.length-1,qe),He.push(F[0].x),He.push(F[0].y);for(let Oe=1;Oe<F.length;Oe++)a(F[Oe],jt,Gt),Le.layoutVertexArray.emplaceBack(F[Oe].x,F[Oe].y),Le.lineIndexArray.emplaceBack(qe+Oe-1,qe+Oe),He.push(F[Oe].x),He.push(F[Oe].y);je.vertexLength+=F.length,je.primitiveLength+=F.length}const qr=vc(He,xt);for(let F=0;F<qr.length;F+=3)Le.indexArray.emplaceBack(qe+qr[F],qe+qr[F+1],qe+qr[F+2]);if(Oe&&"hd-road-base"===this.elevationMode){const F=Oe.elevation.isTunnel(),Le=Oe.elevation.safeArea,Fe=this.elevatedStructures.addVertices(jt,Gt);this.elevatedStructures.addTriangles(qr,Fe,F);const je=bi.length;if(je>0){for(let qe=0;qe<je-1;qe++)this.elevatedStructures.addRenderableRing(Oe.index,bi[qe]+Fe,bi[qe+1]-bi[qe],F,Le);this.elevatedStructures.addRenderableRing(Oe.index,bi[je-1]+Fe,jt.length-bi[je-1],F,Le)}}je.vertexLength+=F,je.primitiveLength+=qr.length/3}return[Fe,je]}getElevationFeature(F,Le){if(!Le)return;const Oe=+F.properties[B_];return null!=Oe?Le.find((F=>F.id===Oe)):void 0}}let j_,G_,q_,H_;us(_h,"FillBucket",{omit:["layers","patternFeatures"]}),us(bh,"FillBufferData"),us(vh,"ElevatedStructures");class Sh{constructor(F,Le,Oe,Fe){if(this.triangleCount=Le.length/3,this.min=new ic(0,0),this.max=new ic(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===F.length)return;const[je,qe]=[F[0].clone(),F[0].clone()];for(let Le=1;Le<F.length;++Le){const Oe=F[Le];je.x=Math.min(je.x,Oe.x),je.y=Math.min(je.y,Oe.y),qe.x=Math.max(qe.x,Oe.x),qe.y=Math.max(qe.y,Oe.y)}if(Fe){const F=Math.ceil(Math.max(qe.x-je.x,qe.y-je.y)/Fe);Oe=Math.max(Oe,F)}if(0===Oe)return;this.min=je,this.max=qe;const He=this.max.sub(this.min);He.x=Math.max(He.x,1),He.y=Math.max(He.y,1);const xt=Math.max(He.x,He.y)/Oe;this.cellsX=Math.max(1,Math.ceil(He.x/xt)),this.cellsY=Math.max(1,Math.ceil(He.y/xt)),this.xScale=1/xt,this.yScale=1/xt;const jt=[];for(let Oe=0;Oe<this.triangleCount;Oe++){const Fe=F[Le[3*Oe+0]].sub(this.min),je=F[Le[3*Oe+1]].sub(this.min),qe=F[Le[3*Oe+2]].sub(this.min),He=Ph(Math.floor(Math.min(Fe.x,je.x,qe.x)),this.xScale,this.cellsX),Gt=Ph(Math.floor(Math.max(Fe.x,je.x,qe.x)),this.xScale,this.cellsX),bi=Ph(Math.floor(Math.min(Fe.y,je.y,qe.y)),this.yScale,this.cellsY),wi=Ph(Math.floor(Math.max(Fe.y,je.y,qe.y)),this.yScale,this.cellsY),qr=new ic(0,0),Xn=new ic(0,0),Yn=new ic(0,0),yo=new ic(0,0);for(let F=bi;F<=wi;++F){qr.y=Xn.y=F*xt,Yn.y=yo.y=(F+1)*xt;for(let Le=He;Le<=Gt;++Le)qr.x=Yn.x=Le*xt,Xn.x=yo.x=(Le+1)*xt,(Kl(Fe,je,qe,qr,Xn,yo)||Kl(Fe,je,qe,qr,yo,Yn))&&jt.push({cellIdx:F*this.cellsX+Le,triIdx:Oe})}}if(0===jt.length)return;jt.sort(((F,Le)=>F.cellIdx-Le.cellIdx||F.triIdx-Le.triIdx));let Gt=0;for(;Gt<jt.length;){const F=jt[Gt].cellIdx,Le={start:this.payload.length,len:0};for(;Gt<jt.length&&jt[Gt].cellIdx===F;)++Le.len,this.payload.push(jt[Gt++].triIdx);this.cells[F]=Le}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(F,Le){if(0===this.triangleCount||0===this.cells.length)return;if(F.x>this.max.x||this.min.x>F.x||F.y>this.max.y||this.min.y>F.y)return;const Oe=Ph(F.x-this.min.x,this.xScale,this.cellsX),Fe=Ph(F.y-this.min.y,this.yScale,this.cellsY),je=this.cells[Fe*this.cellsX+Oe];if(je){this._lazyInitLookup();for(let F=0;F<je.len;F++){const Oe=this.payload[je.start+F],Fe=Math.floor(Oe/8),qe=1<<Oe%8;if(!(this.lookup[Fe]&qe)&&(this.lookup[Fe]|=qe,Le.push(Oe),Le.length===this.triangleCount))return}}}query(F,Le,Oe){if(0===this.triangleCount||0===this.cells.length)return;if(F.x>this.max.x||this.min.x>Le.x)return;if(F.y>this.max.y||this.min.y>Le.y)return;this._lazyInitLookup();const Fe=Ph(F.x-this.min.x,this.xScale,this.cellsX),je=Ph(Le.x-this.min.x,this.xScale,this.cellsX),qe=Ph(F.y-this.min.y,this.yScale,this.cellsY),He=Ph(Le.y-this.min.y,this.yScale,this.cellsY);for(let F=qe;F<=He;F++)for(let Le=Fe;Le<=je;Le++){const Fe=this.cells[F*this.cellsX+Le];if(Fe)for(let F=0;F<Fe.len;F++){const Le=this.payload[Fe.start+F],je=Math.floor(Le/8),qe=1<<Le%8;if(!(this.lookup[je]&qe)&&(this.lookup[je]|=qe,Oe.push(Le),Oe.length===this.triangleCount))return}}}}function Ph(F,Le,Oe){return Math.max(0,Math.min(Oe-1,Math.floor(F*Le)))}us(Sh,"TriangleGridIndex");class Eh{constructor(F){this.zoom=F.zoom,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.footprints=[]}updateFootprints(F,Le){for(const Oe of this.footprints)Le.push({footprint:Oe,id:F})}populate(F,Le,Oe,Fe){const je=[];for(const{feature:Le,id:qe,index:He,sourceLayerIndex:xt}of F){const F=this.layers[0]._featureFilter.needGeometry,jt=Cl(Le,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),jt,Oe))continue;const Gt={id:qe,properties:Le.properties,type:Le.type,sourceLayerIndex:xt,index:He,geometry:F?jt.geometry:Vl(Le,Oe,Fe),patterns:{}};je.push(Gt)}for(const Fe of je){const{geometry:je,index:qe,sourceLayerIndex:He}=Fe;this.addFeature(Fe,je,qe,Oe,{},Le.availableImages,Le.brightness),Le.featureIndex.insert(F[qe].feature,je,qe,He,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(F){}update(F,Le,Oe,Fe,je,qe,He){}destroy(){}addFeature(F,Le,Oe,Fe,je,qe=[],He){for(const F of $c(Le,2)){const Le=[],Oe=[],Fe=[],je=new ic(1/0,1/0),qe=new ic(-1/0,-1/0);for(const He of F)if(0!==He.length){He!==F[0]&&Fe.push(Oe.length/2);for(let F=0;F<He.length;F++)Oe.push(He[F].x),Oe.push(He[F].y),Le.push(He[F]),je.x=Math.min(je.x,He[F].x),je.y=Math.min(je.y,He[F].y),qe.x=Math.max(qe.x,He[F].x),qe.y=Math.max(qe.y,He[F].y)}const He=vc(Oe,Fe),xt=new Sh(Le,He,8,256);this.footprints.push({vertices:Le,indices:He,grid:xt,min:je,max:qe})}}}us(Eh,"ClipBucket",{omit:["layers"]});const $_=va([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Z_=va([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),W_=va([{name:"a_centroid_pos",components:2,type:"Uint16"}]),X_=va([{name:"a_join_normal_inside",components:3,type:"Int16"}]),Y_=va([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),K_=va([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:J_}=$_;class Rh extends ic{constructor(F,Le,Oe){super(F,Le),this.z=Oe}}class Lh extends Rh{constructor(F,Le,Oe,Fe){super(F,Le,Oe),this.w=Fe}}function Fh(F,Le,Oe,Fe){const je=[],qe=0===Fe?(F,Le,Oe,Fe,je,qe)=>{F.push(new ic(qe,Oe+(qe-Le)/(Fe-Le)*(je-Oe)))}:(F,Le,Oe,Fe,je,qe)=>{F.push(new ic(Le+(qe-Oe)/(je-Oe)*(Fe-Le),qe))};for(const He of F){const F=[];for(const je of He){if(je.length<=2)continue;const He=[];for(let F=0;F<je.length-1;F++){const xt=je[F].x,jt=je[F].y,Gt=je[F+1].x,bi=je[F+1].y,wi=0===Fe?xt:jt,qr=0===Fe?Gt:bi;wi<Le?qr>Le&&qe(He,xt,jt,Gt,bi,Le):wi>Oe?qr<Oe&&qe(He,xt,jt,Gt,bi,Oe):He.push(je[F]),qr<Le&&wi>=Le&&qe(He,xt,jt,Gt,bi,Le),qr>Oe&&wi<=Oe&&qe(He,xt,jt,Gt,bi,Oe)}let xt=je[je.length-1];const jt=0===Fe?xt.x:xt.y;jt>=Le&&jt<=Oe&&He.push(xt),He.length&&(xt=He[He.length-1],He[0].x===xt.x&&He[0].y===xt.y||He.push(He[0]),F.push(He))}F.length&&je.push(F)}return je}function Oh(F,Le,Oe,Fe){const je="x"===Oe?"y":"x",qe=(Fe-F[Oe])/(Le[Oe]-F[Oe]);F[je]=F[je]+(Le[je]-F[je])*qe,F[Oe]=Fe,F.hasOwnProperty("z")&&(F.z=Ee(F.z,Le.z,qe)),F.hasOwnProperty("w")&&(F.w=Ee(F.w,Le.w,qe))}function Nh(F,Le,Oe,Fe){const je=Oe,qe=Fe;for(const Oe of["x","y"]){let Fe=F,He=Le;Fe[Oe]>=He[Oe]&&(Fe=Le,He=F),Fe[Oe]<je&&He[Oe]>je&&Oh(Fe,He,Oe,je),Fe[Oe]<qe&&He[Oe]>qe&&Oh(He,Fe,Oe,qe)}}const Q_=Number.MAX_SAFE_INTEGER;function jh(F,Le,Oe,Fe){return F.order<Le||F.order===Q_||!(F.clipMask&Oe)||function(F,Le){return 0!==Le.length&&void 0===Le.find((Le=>Le===F))}(Fe,F.clipScope)}function qh(F,Le){return F.x-Le.x||F.y-Le.y}function $h(F,Le){return 0===qh(F.min,Le.min)&&0===qh(F.max,Le.max)}function Gh(F,Le){return!(F.min.x>Le.max.x||F.max.x<Le.min.x||F.min.y>Le.max.y||F.max.y<Le.min.y)}function Yh(F,Le){if(F.length!==Le.length)return!1;for(let Oe=0;Oe<F.length;Oe++)if(F[Oe].sourceId!==Le[Oe].sourceId||!$h(F[Oe],Le[Oe])||F[Oe].order!==Le[Oe].order||F[Oe].clipMask!==Le[Oe].clipMask||!$(F[Oe].clipScope,Le[Oe].clipScope))return!1;return!0}function Hh(F,Le,Oe){const Fe=1/sp,je=1/(1<<Oe.canonical.z),qe=(Le.x*Fe+Oe.canonical.x)*je+Oe.wrap,He=(Le.y*Fe+Oe.canonical.y)*je;return{min:new ic((F.x*Fe+Oe.canonical.x)*je+Oe.wrap,(F.y*Fe+Oe.canonical.y)*je),max:new ic(qe,He)}}function Xh(F,Le,Oe){const Fe=1<<Oe.canonical.z,je=((Le.x-Oe.wrap)*Fe-Oe.canonical.x)*sp,qe=(Le.y*Fe-Oe.canonical.y)*sp;return{min:new ic(((F.x-Oe.wrap)*Fe-Oe.canonical.x)*sp,(F.y*Fe-Oe.canonical.y)*sp),max:new ic(je,qe)}}function Zh(F,Le,Oe,Fe,je,qe,He){const xt=F.indices,jt=F.vertices,Gt=[];for(let bi=Fe;bi<Fe+je;bi+=3){const Fe=Le[Oe[bi+0]+qe],je=Le[Oe[bi+1]+qe],wi=Le[Oe[bi+2]+qe],qr=Math.min(Fe.x,je.x,wi.x),Xn=Math.max(Fe.x,je.x,wi.x),Yn=Math.min(Fe.y,je.y,wi.y),yo=Math.max(Fe.y,je.y,wi.y);Gt.length=0,F.grid.query(new ic(qr,Yn),new ic(Xn,yo),Gt);for(let F=0;F<Gt.length;F++){const Le=Gt[F];if(Kl(jt[xt[3*Le+0]],jt[xt[3*Le+1]],jt[xt[3*Le+2]],Fe,je,wi,He))return!0}}return!1}function Wh(F,Le,Oe,Fe){if(!F||!Oe)return!1;let je=F.vertices;if(!Le.canonical.equals(Fe.canonical)||Le.wrap!==Fe.wrap){if(Oe.vertices.length<F.vertices.length)return Wh(Oe,Fe,F,Le);const qe=Le.canonical,He=Fe.canonical,xt=Math.pow(2,He.z-qe.z);je=F.vertices.map((F=>new ic((F.x+qe.x*sp)*xt-He.x*sp,(F.y+qe.y*sp)*xt-He.y*sp)))}return Zh(Oe,je,F.indices,0,F.indices.length,0,0)}function Kh(F,Le,Oe,Fe){const je=Math.pow(2,Fe.z-Oe.z);return new ic((F+Oe.x*sp)*je-Fe.x*sp,(Le+Oe.y*sp)*je-Fe.y*sp)}function Jh(F,Le){const Oe=[];Le.grid.queryPoint(F,Oe);const Fe=Le.indices,je=Le.vertices;for(let Le=0;Le<Oe.length;Le++){const qe=Oe[Le];if(Hl([je[Fe[3*qe+0]],je[Fe[3*qe+1]],je[Fe[3*qe+2]]],F))return!0}return!1}const eg=[new ic(0,0),new ic(sp,0),new ic(sp,sp),new ic(0,sp)];function tp(F,Le){const Oe=[];let Fe=[];if(!Le||F.length<2)return[F];if(2===F.length)return Zl(F[0],F[1],eg)?[F]:[];for(let Le=0;Le<F.length+2;Le++){const je=F[Le%F.length],qe=F[(Le+1)%F.length],He=Zl(0===Le?F[F.length-1]:F[(Le-1)%F.length],je,eg),xt=Zl(je,qe,eg),jt=He||xt;jt&&Fe.push(je),jt&&xt||Fe.length>0&&(Fe.length>1&&Oe.push(Fe),Fe=[])}return Fe.length>1&&Oe.push(Fe),Oe}const tg=F_.VectorTileFeature.types,ig=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],og=["fill-extrusion-flood-light-ground-radius"],sg=Math.pow(2,13),lg=Math.pow(2,15)-1,cg=new ic(0,1),hg=2147483648;function lp(F,Le,Oe,Fe,je,qe,He,xt){F.emplaceBack((Le<<1)+He,(Oe<<1)+qe,(Math.floor(Fe*sg)<<1)+je,Math.round(xt))}function up(F,Le,Oe){F.emplaceBack(Le.x*sp,Le.y*sp,Oe?1:0)}function cp(F,Le,Oe,Fe,je,qe){F.emplaceBack(Le.x,Le.y,(Oe.x<<1)+Fe,(Oe.y<<1)+je,qe)}function hp(F,Le,Oe){const Fe=16384;F.emplaceBack(Le.x,Le.y,Le.z,Oe[0]*Fe,Oe[1]*Fe,Oe[2]*Fe)}class pp{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class fp{constructor(){this.centroidXY=new ic(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ic(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ic(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new ic(this.max.x-this.min.x,this.max.y-this.min.y)}}class dp{constructor(){this.acc=new ic(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(F,Le){F.min.x===Number.MAX_VALUE&&(F.min.x=F.max.x=Le.x,F.min.y=F.max.y=Le.y)}appendEdge(F,Le,Oe){this.accCount++,this.acc._add(Le);let Fe=!!this.borders;Le.x<F.min.x?(F.min.x=Le.x,Fe=!0):Le.x>F.max.x&&(F.max.x=Le.x,Fe=!0),Le.y<F.min.y?(F.min.y=Le.y,Fe=!0):Le.y>F.max.y&&(F.max.y=Le.y,Fe=!0),((0===Le.x||Le.x===sp)&&Le.x===Oe.x)!=((0===Le.y||Le.y===sp)&&Le.y===Oe.y)&&this.processBorderOverlap(Le,Oe),Fe&&this.checkBorderIntersection(Le,Oe)}checkBorderIntersection(F,Le){Le.x<0!=F.x<0&&this.addBorderIntersection(0,Ee(Le.y,F.y,(0-Le.x)/(F.x-Le.x))),Le.x>sp!=F.x>sp&&this.addBorderIntersection(1,Ee(Le.y,F.y,(sp-Le.x)/(F.x-Le.x))),Le.y<0!=F.y<0&&this.addBorderIntersection(2,Ee(Le.x,F.x,(0-Le.y)/(F.y-Le.y))),Le.y>sp!=F.y>sp&&this.addBorderIntersection(3,Ee(Le.x,F.x,(sp-Le.y)/(F.y-Le.y)))}addBorderIntersection(F,Le){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const Oe=this.borders[F];Le<Oe[0]&&(Oe[0]=Le),Le>Oe[1]&&(Oe[1]=Le)}processBorderOverlap(F,Le){if(F.x===Le.x){if(F.y===Le.y)return;const Oe=0===F.x?0:1;this.addBorderIntersection(Oe,Le.y),this.addBorderIntersection(Oe,F.y)}else{const Oe=0===F.y?2:3;this.addBorderIntersection(Oe,Le.x),this.addBorderIntersection(Oe,F.x)}}centroid(){return 0===this.accCount?new ic(0,0):new ic(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((F,Le)=>F+ +(Le[0]!==Number.MAX_VALUE)),0):0}}function mp(F,Le){const Oe=F.add(Le)._unit(),Fe=Q(F.x*Oe.x+F.y*Oe.y,-1,1);var je,qe,He;return He=Math.acos(Fe),Math.min(4,Math.max(-4,Math.tan(He)))/4*lg*((je=F).x*(qe=Le).y-je.y*qe.x<0?-1:1)}const ug=[F=>F.x<0,F=>F.x>sp,F=>F.y<0,F=>F.y>sp];function gp(F,Le,Oe,Fe){const je=[4];if(0===Fe)return je;Oe._mult(Fe);const qe=F.sub(Oe),He=Le.sub(Oe),xt=[F,Le,qe,He];for(let F=0;F<4;F++)for(const Le of xt)if(ug[F](Le)){je.push(F);break}return je}class xp{constructor(F){this.vertexArray=new Pa,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut},(F=>og.includes(F))),this._segments=new xo,this.hiddenByLandmarkVertexArray=new eo,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new xo}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(F,Le,Oe,Fe=!1){const je=F.length;if(je>2){let qe=Math.max(0,this._segments.get().length-1);const He=this._segments._prepareSegment(4*je,this.vertexArray.length,2*this._segmentToGroundQuads[qe].length);let xt;qe!==this._segments.get().length-1&&(qe++,this._segmentToGroundQuads[qe]=[],this._segmentToRegionTriCounts[qe]=[0,0,0,0,0]);{const Le=F[0],Oe=F[1];xt=mp(Le.sub(F[je-1])._perp()._unit(),Oe.sub(Le)._perp()._unit())}for(let jt=0;jt<je;jt++){const Gt=jt===je-1?0:jt+1,bi=F[jt],wi=F[Gt],qr=F[Gt===je-1?0:Gt+1],Xn=wi.sub(bi)._perp()._unit(),Yn=mp(Xn,qr.sub(wi)._perp()._unit()),yo=xt,bo=Yn;if(Mp(bi,wi,Le)||Fe&&Ap(bi,Le)&&Ap(wi,Le)){xt=Yn;continue}const Do=He.vertexLength;cp(this.vertexArray,bi,wi,1,1,yo),cp(this.vertexArray,bi,wi,1,0,yo),cp(this.vertexArray,bi,wi,0,1,bo),cp(this.vertexArray,bi,wi,0,0,bo),He.vertexLength+=4;const Ro=gp(bi,wi,Xn,Oe);for(const F of Ro)this._segmentToGroundQuads[qe].push({id:Do,region:F}),this._segmentToRegionTriCounts[qe][F]+=2,He.primitiveLength+=2;xt=Yn}}}prepareBorderSegments(){if(!this.hasData())return;const F=this._segments.get(),Le=F.length;for(let F=0;F<Le;F++)this._segmentToGroundQuads[F].sort(((F,Le)=>F.region-Le.region));for(let Oe=0;Oe<Le;Oe++){const Le=this._segmentToGroundQuads[Oe],Fe=F[Oe],je=this._segmentToRegionTriCounts[Oe];je.reduce(((F,Le)=>F+Le),0);let qe=0;for(let F=0;F<=4;F++){const Le=je[F];if(0!==Le){let Oe=this.regionSegments[F];Oe||(Oe=this.regionSegments[F]=new xo);const je={vertexOffset:Fe.vertexOffset,primitiveOffset:Fe.primitiveOffset+qe,vertexLength:Fe.vertexLength,primitiveLength:Le};Oe.get().push(je)}qe+=Le}for(let F=0;F<Le.length;F++){const Oe=Le[F].id;this.indexArray.emplaceBack(Oe,Oe+1,Oe+3),this.indexArray.emplaceBack(Oe,Oe+3,Oe+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(F,Le,Oe,Fe,je,qe){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,F,Le,Oe,Fe,je,qe)}upload(F){this.hasData()&&(this.vertexBuffer=F.createVertexBuffer(this.vertexArray,Z_.members),this.indexBuffer=F.createIndexBuffer(this.indexArray))}uploadPaintProperties(F){this.hasData()&&this.programConfigurations.upload(F)}update(F,Le,Oe,Fe,je,qe,He){this.hasData()&&this.programConfigurations.updatePaintArrays(F,Le,Oe,Fe,je,qe,He)}updateHiddenByLandmark(F){if(!this.hasData())return;const Le=F.groundVertexCount+F.groundVertexArrayOffset;if(0===F.groundVertexCount)return;const Oe=F.flags&hg?1:0;for(let Fe=F.groundVertexArrayOffset;Fe<Le;++Fe)this.hiddenByLandmarkVertexArray.emplace(Fe,Oe);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(F){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=F.createVertexBuffer(this.hiddenByLandmarkVertexArray,Y_.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let F=0;F<=4;F++){const Le=this.regionSegments[F];Le&&Le.destroy()}}}}class vp{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.overscaling=F.overscaling,this.layers=F.layers,this.pixelRatio=F.pixelRatio,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=F.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ja,this.footprintVertices=new _a,this.footprintSegments=[],this.layoutVertexArray=new Ma,this.centroidVertexArray=new po,this.wallVertexArray=new mo,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut},(F=>ig.includes(F))),this.segments=new xo,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.groundEffect=new xp(F),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(F,Le){}populate(F,Le,Oe,Fe){this.features=[],this.hasPattern=Hc("fill-extrusion",this.layers,this.pixelRatio,Le),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Al(Oe),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:je,id:qe,index:He,sourceLayerIndex:xt}of F){const F=this.layers[0]._featureFilter.needGeometry,jt=Cl(je,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),jt,Oe))continue;const Gt={id:qe,sourceLayerIndex:xt,index:He,geometry:F?jt.geometry:Vl(je,Oe,Fe),properties:je.properties,type:je.type,patterns:{}},bi=this.layoutVertexArray.length,wi="Polygon"===tg[Gt.type];if(this.hasPattern)this.features.push(Xc("fill-extrusion",this.layers,Gt,this.zoom,this.pixelRatio,Le));else if(this.wallMode)for(const F of Gt.geometry)for(const je of tp(F,wi))this.addFeature(Gt,[je],He,Oe,{},Le.availableImages,Fe,Le.brightness);else this.addFeature(Gt,Gt.geometry,He,Oe,{},Le.availableImages,Fe,Le.brightness);Le.featureIndex.insert(je,Gt.geometry,He,xt,this.index,bi)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(F,Le,Oe,Fe,je,qe){for(const F of this.features){const He="Polygon"===tg[F.type],{geometry:xt}=F;if(this.wallMode)for(const jt of xt)for(const xt of tp(jt,He))this.addFeature(F,[xt],F.index,Le,Oe,Fe,je,qe);else this.addFeature(F,xt,F.index,Le,Oe,Fe,je,qe)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(F,Le,Oe,Fe,je,qe,He){this.programConfigurations.updatePaintArrays(F,Le,je,Oe,Fe,qe,He),this.groundEffect.update(F,Le,je,Oe,Fe,qe,He)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,J_),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.wallVertexBuffer=F.createVertexBuffer(this.wallVertexArray,X_.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=F.createVertexBuffer(this.layoutVertexExtArray,K_.members,!0)),this.groundEffect.upload(F)),this.groundEffect.uploadPaintProperties(F),this.programConfigurations.upload(F),this.uploaded=!0}uploadCentroid(F){this.groundEffect.uploadHiddenByLandmark(F),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=F.createVertexBuffer(this.centroidVertexArray,W_.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(F,Le,Oe,Fe,je,qe,He,xt){const jt=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(F,{})/this.tileToMeter,Gt=[new ic(0,0),new ic(sp,sp)],bi=He.projection,wi="globe"===bi.name,qr=this.wallMode||"Polygon"===tg[F.type],Xn=new dp;Xn.centroidDataIndex=this.centroidData.length;const Yn=new fp,yo=this.layers[0].paint.get("fill-extrusion-base").evaluate(F,{},Fe)<=0,bo=this.layers[0].paint.get("fill-extrusion-height").evaluate(F,{},Fe);let Do;if(Yn.height=bo,Yn.vertexArrayOffset=this.layoutVertexArray.length,Yn.groundVertexArrayOffset=this.groundEffect.vertexArray.length,wi&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ba),this.wallMode){if(wi)return void pt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==Le.length)return;Do=function(F){const Le=F[0].x===F[F.length-1].x&&F[0].y===F[F.length-1].y,Oe=function(F){let Le=0;const Oe=F.length;for(let Fe=0;Fe<Oe;Fe++)Le+=(F[(Fe+1)%Oe].x-F[Fe].x)*(F[(Fe+1)%Oe].y+F[Fe].y);return Le>=0}(F);Oe||(F=F.reverse());const Fe={geometry:[],joinNormals:[],indices:[]},je=[],qe=[],He=[];let xt=F.length;for(;xt>=2&&F[xt-1].equals(F[xt-2]);)xt--;if(xt<(Le?3:2))return Fe;let jt,Gt,bi,wi,qr,Xn=0;for(;Xn<xt-1&&F[Xn].equals(F[Xn+1]);)Xn++;Le&&(jt=F[xt-2],qr=F[Xn].sub(jt)._unit()._perp());for(let Oe=Xn;Oe<xt;Oe++){if(bi=Oe===xt-1?Le?F[Xn+1]:void 0:F[Oe+1],bi&&F[Oe].equals(bi))continue;qr&&(wi=qr),jt&&(Gt=jt),jt=F[Oe],qr=bi?bi.sub(jt)._unit()._perp():wi,wi=wi||qr;let Fe=wi.add(qr);0===Fe.x&&0===Fe.y||Fe._unit();const Yn=Fe.x*qr.x+Fe.y*qr.y,yo=0!==Yn?1/Yn:1/0,bo=wi.x*qr.y-wi.y*qr.x>0;let Do="miter";const Ro=2;"miter"===Do&&yo>Ro&&(Do="bevel"),"bevel"===Do&&(yo>100&&(Do="flipbevel"),yo<Ro&&(Do="miter"));const v=(F,Le,Oe,Fe)=>{const xt=new ic(F.x,F.y),jt=new ic(F.x,F.y);xt.x+=Le.x*Fe,xt.y+=Le.y*Fe,jt.x-=Le.x*Math.max(Oe,1),jt.y-=Le.y*Math.max(Oe,1),He.push(Le),je.push(xt),qe.push(jt)};if("miter"===Do)Fe._mult(yo),v(jt,Fe,0,0);else if("flipbevel"===Do)Fe=qr.mult(-1),v(jt,Fe,0,0),v(jt,Fe.mult(-1),0,0);else{const F=-Math.sqrt(yo*yo-1),Le=bo?F:0,Oe=bo?0:F;Gt&&v(jt,wi,Le,Oe),bi&&v(jt,qr,Le,Oe)}}Fe.geometry=[...je,...qe.reverse(),je[0]],Fe.joinNormals=[...He,...He.reverse(),He[He.length-1]];const Yn=Fe.geometry.length-1;for(let F=0;F<Yn/2;F++)if(F+1<Yn/2){let Le=F,Oe=F+1,je=Yn-1-F,qe=Yn-2-F;Le=0===Le?Yn-1:Le-1,Oe=0===Oe?Yn-1:Oe-1,je=0===je?Yn-1:je-1,qe=0===qe?Yn-1:qe-1,Fe.indices.push(je),Fe.indices.push(Oe),Fe.indices.push(Le),Fe.indices.push(je),Fe.indices.push(qe),Fe.indices.push(Oe)}return Fe}(Le[0]),Le=[Do.geometry]}const x=(F,Le)=>F<(Le.length-1)/2||F===Le.length-1,Ro=this.wallMode?[Le]:$c(Le,500);for(let F=Ro.length-1;F>=0;F--){const Le=Ro[F];(0===Le.length||(zs=Le[0]).every((F=>F.x<=0))||zs.every((F=>F.x>=sp))||zs.every((F=>F.y<=0))||zs.every((F=>F.y>=sp)))&&Ro.splice(F,1)}var zs;let Zs;if(wi)Zs=Ep(Ro,Gt,Fe);else{Zs=[];for(const F of Ro)Zs.push({polygon:F,bounds:Gt})}const na=qr?this.edgeRadius:0,el=na>0&&this.zoom<17,A=(F,Le)=>{if(0===F.length)return!1;const Oe=F[F.length-1];return Le.x===Oe.x&&Le.y===Oe.y};for(const{polygon:F,bounds:Le}of Zs){let Oe=0,je=0;for(const Le of F)qr&&!Le[0].equals(Le[Le.length-1])&&Le.push(Le[0]),je+=qr?Le.length-1:Le.length;const qe=this.segments.prepareSegment((qr?5:4)*je,this.layoutVertexArray,this.indexArray);Yn.footprintSegIdx<0&&(Yn.footprintSegIdx=this.footprintSegments.length),Yn.polygonSegIdx<0&&(Yn.polygonSegIdx=this.polygonSegments.length);const He={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},xt=new pp;if(xt.vertexOffset=this.footprintVertices.length,xt.indexOffset=3*this.footprintIndices.length,xt.ringIndices=[],qr){const je=[],He=[];Oe=qe.vertexLength;for(let Oe=0;Oe<F.length;Oe++){const Gt=F[Oe];Gt.length&&0!==Oe&&He.push(je.length/2);const qr=[];let Xn,Yn;Xn=Gt[1].sub(Gt[0])._perp()._unit(),xt.ringIndices.push(Gt.length-1);for(let F=1;F<Gt.length;F++){const Le=Gt[F],Oe=Gt[F===Gt.length-1?1:F+1],He=Le.clone();if(na){Yn=Oe.sub(Le)._perp()._unit();const F=Xn.add(Yn)._unit(),Fe=na*Math.min(4,1/(Xn.x*F.x+Xn.y*F.y));He.x+=Fe*F.x,He.y+=Fe*F.y,He.x=Math.round(He.x),He.y=Math.round(He.y),Xn=Yn}if(!yo||0!==na&&!el||A(qr,He)||qr.push(He),lp(this.layoutVertexArray,He.x,He.y,0,0,1,1,0),this.wallMode){const Le=x(F,Gt);up(this.wallVertexArray,Do.joinNormals[F],!Le)}qe.vertexLength++,this.footprintVertices.emplaceBack(Le.x,Le.y),je.push(Le.x,Le.y),wi&&hp(this.layoutVertexExtArray,bi.projectTilePoint(He.x,He.y,Fe),bi.upVector(Fe,He.x,He.y))}yo&&(0===na||el)&&(0!==qr.length&&A(qr,qr[0])&&qr.pop(),this.groundEffect.addData(qr,Le,jt))}const Gt=this.wallMode?Do.indices:vc(je,He);for(let F=0;F<Gt.length;F+=3)this.footprintIndices.emplaceBack(xt.vertexOffset+Gt[F+0],xt.vertexOffset+Gt[F+1],xt.vertexOffset+Gt[F+2]),this.indexArray.emplaceBack(Oe+Gt[F],Oe+Gt[F+2],Oe+Gt[F+1]),qe.primitiveLength++;xt.indexCount+=Gt.length,xt.vertexCount+=this.footprintVertices.length-xt.vertexOffset}for(let je=0;je<F.length;je++){const He=F[je];Xn.startRing(Yn,He[0]);let xt=He.length>4&&Ip(He[He.length-2],He[0],He[1]),Gt=na?_p(He[He.length-2],He[0],He[1],na):0;const bo=[];let Ro,zs,Zs;zs=He[1].sub(He[0])._perp()._unit();let el=!0;for(let F=1,je=0;F<He.length;F++){let jt=He[F-1],qr=He[F];const nl=He[F===He.length-1?1:F+1];if(Xn.appendEdge(Yn,qr,jt),Mp(qr,jt,Le)){na&&(zs=nl.sub(qr)._perp()._unit(),el=!el);continue}const hl=qr.sub(jt)._perp(),pl=hl.x/(Math.abs(hl.x)+Math.abs(hl.y)),bl=hl.y>0?1:0,Tl=jt.dist(qr);if(je+Tl>32768&&(je=0),na){Zs=nl.sub(qr)._perp()._unit();let F=wp(jt,qr,nl,bp(zs,Zs),na);isNaN(F)&&(F=0);const Le=qr.sub(jt)._unit();jt=jt.add(Le.mult(Gt))._round(),qr=qr.add(Le.mult(-F))._round(),Gt=F,zs=Zs,yo&&this.zoom>=17&&(A(bo,jt)||bo.push(jt),A(bo,qr)||bo.push(qr))}const kl=qe.vertexLength,ec=He.length>4&&Ip(jt,qr,nl);let tc=Sp(je,xt,el);if(lp(this.layoutVertexArray,jt.x,jt.y,pl,bl,0,0,tc),lp(this.layoutVertexArray,jt.x,jt.y,pl,bl,0,1,tc),this.wallMode){const Le=x(F-1,He),Oe=Do.joinNormals[F-1];up(this.wallVertexArray,Oe,Le),up(this.wallVertexArray,Oe,Le)}if(je+=Tl,tc=Sp(je,ec,!el),xt=ec,lp(this.layoutVertexArray,qr.x,qr.y,pl,bl,0,0,tc),lp(this.layoutVertexArray,qr.x,qr.y,pl,bl,0,1,tc),this.wallMode){const Le=x(F,He),Oe=Do.joinNormals[F];up(this.wallVertexArray,Oe,Le),up(this.wallVertexArray,Oe,Le)}if(qe.vertexLength+=4,this.indexArray.emplaceBack(kl+0,kl+1,kl+2),this.indexArray.emplaceBack(kl+1,kl+3,kl+2),qe.primitiveLength+=2,na){const Fe=Oe+(1===F?He.length-2:F-2),je=1===F?Oe:Fe+1;if(this.indexArray.emplaceBack(kl+1,Fe,kl+3),this.indexArray.emplaceBack(Fe,je,kl+3),qe.primitiveLength+=2,void 0===Ro&&(Ro=kl),!Mp(nl,He[F],Le)){const Le=F===He.length-1?Ro:qe.vertexLength;this.indexArray.emplaceBack(kl+2,kl+3,Le),this.indexArray.emplaceBack(kl+3,Le+1,Le),this.indexArray.emplaceBack(kl+3,je,Le+1),qe.primitiveLength+=3}el=!el}if(wi){const F=this.layoutVertexExtArray,Le=bi.projectTilePoint(jt.x,jt.y,Fe),Oe=bi.projectTilePoint(qr.x,qr.y,Fe),je=bi.upVector(Fe,jt.x,jt.y),qe=bi.upVector(Fe,qr.x,qr.y);hp(F,Le,je),hp(F,Le,je),hp(F,Oe,qe),hp(F,Oe,qe)}}qr&&(Oe+=He.length-1),yo&&na&&this.zoom>=17&&(0!==bo.length&&A(bo,bo[0])&&bo.pop(),this.groundEffect.addData(bo,Le,jt,na>0))}this.footprintSegments.push(xt),He.triangleCount=this.indexArray.length-He.triangleArrayOffset,this.polygonSegments.push(He),++Yn.footprintSegLen,++Yn.polygonSegLen}if(Yn.vertexCount=this.layoutVertexArray.length-Yn.vertexArrayOffset,Yn.groundVertexCount=this.groundEffect.vertexArray.length-Yn.groundVertexArrayOffset,0!==Yn.vertexCount){if(Yn.centroidXY=Xn.borders?cg:this.encodeCentroid(Xn,Yn),this.centroidData.push(Yn),Xn.borders){this.featuresOnBorder.push(Xn);const F=this.featuresOnBorder.length-1;for(let Le=0;Le<Xn.borders.length;Le++)Xn.borders[Le][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Le].push(F)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Oe,je,qe,Fe,xt),this.groundEffect.addPaintPropertiesData(F,Oe,je,qe,Fe,xt),this.maxHeight=Math.max(this.maxHeight,bo)}}sortBorders(){for(let F=0;F<this.borderFeatureIndices.length;F++)this.borderFeatureIndices[F].sort(((Le,Oe)=>this.featuresOnBorder[Le].borders[F][0]-this.featuresOnBorder[Oe].borders[F][0]))}splitToSubtiles(){const F=[];for(let Le=0;Le<this.centroidData.length;Le++){const Oe=this.centroidData[Le],Fe=+(Oe.min.y+Oe.max.y>sp),je=2*Fe+(+(Oe.min.x+Oe.max.x>sp)^Fe);for(let Fe=0;Fe<Oe.polygonSegLen;Fe++){const qe=Oe.polygonSegIdx+Fe;F.push({centroidIdx:Le,subtile:je,polygonSegmentIdx:qe,triangleSegmentIdx:this.polygonSegments[qe].triangleSegIdx})}}const Le=new ja;F.sort(((F,Le)=>F.triangleSegmentIdx===Le.triangleSegmentIdx?F.subtile-Le.subtile:F.triangleSegmentIdx-Le.triangleSegmentIdx));let Oe=0,Fe=0,je=0;for(const Le of F){if(Le.triangleSegmentIdx!==Oe)break;je++}const qe=F.length;for(;Fe!==F.length;){Oe=F[Fe].triangleSegmentIdx;let He=0,xt=Fe,jt=Fe;for(let Le=xt;Le<je&&F[Le].subtile===He;Le++)jt++;for(;xt!==je;){const Fe=F[xt];He=Fe.subtile;const qe=this.centroidData[Fe.centroidIdx].min.clone(),Gt=this.centroidData[Fe.centroidIdx].max.clone(),bi={vertexOffset:this.segments.segments[Oe].vertexOffset,primitiveOffset:Le.length,vertexLength:this.segments.segments[Oe].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let Oe=xt;Oe<jt;Oe++){const Fe=F[Oe],je=this.polygonSegments[Fe.polygonSegmentIdx],He=this.centroidData[Fe.centroidIdx].min,xt=this.centroidData[Fe.centroidIdx].max,jt=this.indexArray.uint16;for(let F=je.triangleArrayOffset;F<je.triangleArrayOffset+je.triangleCount;F++)Le.emplaceBack(jt[3*F],jt[3*F+1],jt[3*F+2]);bi.primitiveLength+=je.triangleCount,qe.x=Math.min(qe.x,He.x),qe.y=Math.min(qe.y,He.y),Gt.x=Math.max(Gt.x,xt.x),Gt.y=Math.max(Gt.y,xt.y)}bi.primitiveLength>0&&this.triangleSubSegments.push({segment:bi,min:qe,max:Gt}),xt=jt;for(let Le=xt;Le<je&&F[Le].subtile===F[xt].subtile;Le++)jt++}Fe=je;for(let Le=Fe;Le<qe&&F[Le].triangleSegmentIdx===F[Fe].triangleSegmentIdx;Le++)je++}Le._trim(),this.indexArray=Le}getVisibleSegments(F,Le,Oe){const Fe=new xo;if(this.wallMode){for(const F of this.triangleSubSegments)Fe.segments.push(F.segment);return Fe}let je=0,qe=0;const He=1<<F.canonical.z;if(Le){const Oe=Le.getMinMaxForTile(F);Oe&&(je=Oe.min,qe=Oe.max)}qe+=this.maxHeight;const xt=F.toUnwrapped();let jt;const Gt=[xt.canonical.x/He+xt.wrap,xt.canonical.y/He],bi=[(xt.canonical.x+1)/He+xt.wrap,(xt.canonical.y+1)/He],h=(F,Le,Oe)=>[F[0]*(1-Oe[0])+Le[0]*Oe[0],F[1]*(1-Oe[1])+Le[1]*Oe[1]],wi=[],qr=[];for(const F of this.triangleSubSegments){wi[0]=F.min.x/sp,wi[1]=F.min.y/sp,qr[0]=F.max.x/sp,qr[1]=F.max.y/sp;const Le=h(Gt,bi,wi),He=h(Gt,bi,qr);if(0===new Au([Le[0],Le[1],je],[He[0],He[1],qe]).intersectsPrecise(Oe)){jt&&(Fe.segments.push(jt),jt=void 0);continue}const xt=F.segment;jt&&jt.vertexOffset!==xt.vertexOffset&&(Fe.segments.push(jt),jt=void 0),jt?(jt.vertexLength+=xt.vertexLength,jt.primitiveLength+=xt.primitiveLength):jt={vertexOffset:xt.vertexOffset,primitiveLength:xt.primitiveLength,vertexLength:xt.vertexLength,primitiveOffset:xt.primitiveOffset,sortKey:void 0,vaos:{}}}return jt&&Fe.segments.push(jt),Fe}encodeCentroid(F,Le){const Oe=F.centroid(),Fe=Le.span(),je=Math.min(7,Math.round(Fe.x*this.tileToMeter/10)),qe=Math.min(7,Math.round(Fe.y*this.tileToMeter/10));return new ic(Q(Oe.x,1,sp-1)<<3|je,Q(Oe.y,1,sp-1)<<3|qe)}encodeBorderCentroid(F){if(!F.borders)return new ic(0,0);const Le=F.borders,Oe=Number.MAX_VALUE;if(Le[0][0]!==Oe||Le[1][0]!==Oe){const F=Le[0][0]!==Oe?0:1;return new ic(6|(Le[0][0]!==Oe?0:65528),(Le[F][0]+Le[F][1])/2<<3|6)}{const F=Le[2][0]!==Oe?2:3;return new ic((Le[F][0]+Le[F][1])/2<<3|6,6|(Le[2][0]!==Oe?0:65528))}}showCentroid(F){const Le=this.centroidData[F.centroidDataIndex];Le.flags&=hg,Le.centroidXY.x=0,Le.centroidXY.y=0,this.writeCentroidToBuffer(Le)}writeCentroidToBuffer(F){this.groundEffect.updateHiddenByLandmark(F);const Le=F.vertexArrayOffset,Oe=F.vertexCount+F.vertexArrayOffset,Fe=F.flags&hg?cg:F.centroidXY,je=this.centroidVertexArray.geta_centroid_pos0(Le);if(this.centroidVertexArray.geta_centroid_pos1(Le)!==Fe.y||je!==Fe.x){for(let F=Le;F<Oe;++F)this.centroidVertexArray.emplace(F,Fe.x,Fe.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const F of this.centroidData)this.writeCentroidToBuffer(F)}updateReplacement(F,Le,Oe){if(Le.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=Le.updateTime;const Fe=Le.getReplacementRegionsForTile(F.toUnwrapped());if(Yh(this.activeReplacements,Fe))return;if(this.activeReplacements=Fe,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const F of this.centroidData)F.flags&=2147483647;const je=[];for(const Le of this.activeReplacements){if(Le.order<Oe)continue;const Fe=Math.max(1,Math.pow(2,Le.footprintTileId.canonical.z-F.canonical.z));for(const Oe of this.centroidData)if(!(Oe.flags&hg||Le.min.x>Oe.max.x||Oe.min.x>Le.max.x||Le.min.y>Oe.max.y||Oe.min.y>Le.max.y))for(let qe=0;qe<Oe.footprintSegLen;qe++){const He=this.footprintSegments[Oe.footprintSegIdx+qe];if(je.length=0,zp(this.footprintVertices,He.vertexOffset,He.vertexCount,Le.footprintTileId.canonical,F.canonical,je),Zh(Le.footprint,je,this.footprintIndices.uint16,He.indexOffset,He.indexCount,-He.vertexOffset,-Fe)){Oe.flags|=hg;break}}}for(const F of this.centroidData)this.writeCentroidToBuffer(F);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(F,Le,Oe){let Fe=!1;for(let je=0;je<Oe.footprintSegLen;je++){const qe=this.footprintSegments[Oe.footprintSegIdx+je];let He=0;for(const Oe of qe.ringIndices){for(let je=He,xt=Oe+He-1;je<Oe+He;xt=je++){const Oe=this.footprintVertices.int16[2*(je+qe.vertexOffset)+0],He=this.footprintVertices.int16[2*(je+qe.vertexOffset)+1],jt=this.footprintVertices.int16[2*(xt+qe.vertexOffset)+1];He>Le!=jt>Le&&F<(this.footprintVertices.int16[2*(xt+qe.vertexOffset)+0]-Oe)*(Le-He)/(jt-He)+Oe&&(Fe=!Fe)}He=Oe}}return Fe}getHeightAtTileCoord(F,Le){let Oe=Number.NEGATIVE_INFINITY,Fe=!0;const je=4*(F+sp)*sp+(Le+sp);if(this.partLookup.hasOwnProperty(je)){const F=this.partLookup[je];return F?{height:F.height,hidden:!!(F.flags&hg)}:void 0}for(const qe of this.centroidData)F>qe.max.x||qe.min.x>F||Le>qe.max.y||qe.min.y>Le||this.footprintContainsPoint(F,Le,qe)&&qe&&qe.height>Oe&&(Oe=qe.height,this.partLookup[je]=qe,Fe=!!(qe.flags&hg));if(Oe!==Number.NEGATIVE_INFINITY)return{height:Oe,hidden:Fe};this.partLookup[je]=void 0}}function bp(F,Le){const Oe=F.add(Le)._unit();return F.x*Oe.x+F.y*Oe.y}function _p(F,Le,Oe,Fe){const je=Le.sub(F)._perp()._unit(),qe=Oe.sub(Le)._perp()._unit();return wp(F,Le,Oe,bp(je,qe),Fe)}function wp(F,Le,Oe,Fe,je){const qe=Math.sqrt(1-Fe*Fe);return Math.min(F.dist(Le)/3,Le.dist(Oe)/3,je*qe/Fe)}function Mp(F,Le,Oe){return F.x<Oe[0].x&&Le.x<Oe[0].x||F.x>Oe[1].x&&Le.x>Oe[1].x||F.y<Oe[0].y&&Le.y<Oe[0].y||F.y>Oe[1].y&&Le.y>Oe[1].y}function Ap(F,Le){return F.x<Le[0].x||F.x>Le[1].x||F.y<Le[0].y||F.y>Le[1].y}function Ip(F,Le,Oe){if(F.x<0||F.x>=sp||Le.x<0||Le.x>=sp||Oe.x<0||Oe.x>=sp)return!1;const Fe=Oe.sub(Le),je=Fe.perp(),qe=F.sub(Le);return(Fe.x*qe.x+Fe.y*qe.y)/Math.sqrt((Fe.x*Fe.x+Fe.y*Fe.y)*(qe.x*qe.x+qe.y*qe.y))>-.866&&je.x*qe.x+je.y*qe.y<0}function Sp(F,Le,Oe){const Fe=Le?2|F:-3&F;return Oe?1|Fe:-2&Fe}function Pp(){const F=Math.PI/32,Le=Math.tan(F),Oe=Zm;return Oe*Math.sqrt(1+2*Le*Le)-Oe}function Ep(F,Le,Oe){const Fe=1<<Oe.z,je=gl(Oe.x/Fe),qe=gl((Oe.x+1)/Fe),He=xl(Oe.y/Fe),xt=xl((Oe.y+1)/Fe);return function(F,Le,Oe,Fe,je=0,qe){const He=[];if(!F.length||!Oe||!Fe)return He;const o=(F,Le)=>{for(const Oe of F)He.push({polygon:Oe,bounds:Le})},xt=Math.ceil(Math.log2(Oe)),jt=Math.ceil(Math.log2(Fe)),Gt=xt-jt,bi=[];for(let F=0;F<Math.abs(Gt);F++)bi.push(Gt>0?0:1);for(let F=0;F<Math.min(xt,jt);F++)bi.push(0),bi.push(1);let wi=F;if(wi=Fh(wi,Le[0].y-je,Le[1].y+je,1),wi=Fh(wi,Le[0].x-je,Le[1].x+je,0),!wi.length)return He;const qr=[];for(bi.length?qr.push({polygons:wi,bounds:Le,depth:0}):o(wi,Le);qr.length;){const F=qr.pop(),Le=F.depth,Oe=bi[Le],Fe=F.bounds[0],He=F.bounds[1],xt=0===Oe?Fe.x:Fe.y,jt=0===Oe?He.x:He.y,Gt=qe?qe(Oe,xt,jt):.5*(xt+jt),wi=Fh(F.polygons,xt-je,Gt+je,Oe),Xn=Fh(F.polygons,Gt-je,jt+je,Oe);if(wi.length){const F=[Fe,new ic(0===Oe?Gt:He.x,1===Oe?Gt:He.y)];bi.length>Le+1?qr.push({polygons:wi,bounds:F,depth:Le+1}):o(wi,F)}if(Xn.length){const F=[new ic(0===Oe?Gt:Fe.x,1===Oe?Gt:Fe.y),He];bi.length>Le+1?qr.push({polygons:Xn,bounds:F,depth:Le+1}):o(Xn,F)}}return He}(F,Le,Math.ceil((qe-je)/11.25),Math.ceil((He-xt)/11.25),1,((F,Le,je)=>{if(0===F)return.5*(Le+je);{const F=xl((Oe.y+Le/sp)/Fe);return(ml(.5*(xl((Oe.y+je/sp)/Fe)+F))*Fe-Oe.y)*sp}}))}function zp(F,Le,Oe,Fe,je,qe){const He=Math.pow(2,Fe.z-je.z);for(let xt=0;xt<Oe;xt++){let Oe=F.int16[2*(xt+Le)+0],jt=F.int16[2*(xt+Le)+1];Oe=(Oe+je.x*sp)*He-Fe.x*sp,jt=(jt+je.y*sp)*He-Fe.y*sp,qe.push(new ic(Oe,jt))}}let pg,fg;function Bp(F,Le){return F.x*Le.x+F.y*Le.y}function Vp(F,Le){if(1===F.length){let Oe=0;const Fe=Le[Oe++];let je;for(;!je||Fe.equals(je);)if(je=Le[Oe++],!je)return 1/0;for(;Oe<Le.length;Oe++){const qe=Le[Oe],He=F[0],xt=je.sub(Fe),jt=qe.sub(Fe),Gt=He.sub(Fe),bi=Bp(xt,xt),wi=Bp(xt,jt),qr=Bp(jt,jt),Xn=Bp(Gt,xt),Yn=Bp(Gt,jt),yo=bi*qr-wi*wi,bo=(qr*Xn-wi*Yn)/yo,Do=(bi*Yn-wi*Xn)/yo,Ro=Fe.z*(1-bo-Do)+je.z*bo+qe.z*Do;if(isFinite(Ro))return Ro}return 1/0}{let F=1/0;for(const Oe of Le)F=Math.min(F,Oe.z);return F}}function Cp(F,Le,Oe,Fe,je,qe,He,xt){const jt=He*je.getElevationAt(F,Le,!0,!0),Gt=0!==qe[0],bi=Gt?0===qe[1]?He*(qe[0]/7-450):He*function(F,Le,Oe){const Fe=Math.floor(Le[0]/8),je=Math.floor(Le[1]/8),qe=10*(Le[0]-8*Fe),He=10*(Le[1]-8*je),xt=F.getElevationAt(Fe,je,!0,!0),jt=F.getMeterToDEM(Oe),Gt=Math.floor(.5*(qe*jt-1)),bi=Math.floor(.5*(He*jt-1)),wi=F.tileCoordToPixel(Fe,je),qr=2*Gt+1,Xn=2*bi+1,Yn=function(F,Le,Oe,Fe,je){return[F.getElevationAtPixel(Le,Oe,!0),F.getElevationAtPixel(Le+je,Oe,!0),F.getElevationAtPixel(Le,Oe+je,!0),F.getElevationAtPixel(Le+Fe,Oe+je,!0)]}(F,wi.x-Gt,wi.y-bi,qr,Xn),yo=Math.abs(Yn[0]-Yn[1]),bo=Math.abs(Yn[2]-Yn[3]),Do=Math.abs(Yn[0]-Yn[2])+Math.abs(Yn[1]-Yn[3]),Ro=Math.min(.25,.5*jt*(yo+bo)/qr),zs=Math.min(.25,.5*jt*Do/Xn);return xt+Math.max(Ro*qe,zs*He)}(je,qe,xt):jt;return{base:jt+(0===Oe?-1:Oe),top:Gt?Math.max(bi+Fe,jt+Oe+2):jt+Fe}}us(vp,"FillExtrusionBucket",{omit:["layers","features"]}),us(fp,"PartData"),us(pp,"FootprintSegment"),us(dp,"BorderCentroidData"),us(xp,"GroundEffect");const ey=va([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),ty=va([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:ly}=ey,my=va([{name:"a_packed",components:3,type:"Float32"}]),{members:_y}=my,gy=va([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:yy}=gy;class jp{constructor(F,Le){this.width=F,this.height=Le,this.nextRow=0,this.image=new hc({width:F,height:Le}),this.positions={},this.uploaded=!1}getDash(F,Le){const Oe=this.getKey(F,Le);return this.positions[Oe]}trim(){const F=this.width,Le=this.height=at(this.nextRow);this.image.resize({width:F,height:Le})}getKey(F,Le){return F.join(",")+Le}getDashRanges(F,Le,Oe){const Fe=[];let je=F.length%2==1?-F[F.length-1]*Oe:0,qe=F[0]*Oe,He=!0;Fe.push({left:je,right:qe,isDash:He,zeroLength:0===F[0]});let xt=F[0];for(let Le=1;Le<F.length;Le++){He=!He;const jt=F[Le];je=xt*Oe,xt+=jt,qe=xt*Oe,Fe.push({left:je,right:qe,isDash:He,zeroLength:0===jt})}return Fe}addRoundDash(F,Le,Oe){const Fe=Le/2;for(let Le=-Oe;Le<=Oe;Le++){const je=this.width*(this.nextRow+Oe+Le);let qe=0,He=F[qe];for(let xt=0;xt<this.width;xt++){xt/He.right>1&&(He=F[++qe]);const jt=Math.abs(xt-He.left),Gt=Math.abs(xt-He.right),bi=Math.min(jt,Gt);let wi;const qr=Le/Oe*(Fe+1);if(He.isDash){const F=Fe-Math.abs(qr);wi=Math.sqrt(bi*bi+F*F)}else wi=Fe-Math.sqrt(bi*bi+qr*qr);this.image.data[je+xt]=Math.max(0,Math.min(255,wi+128))}}}addRegularDash(F,Le){for(let Le=F.length-1;Le>=0;--Le){const Oe=F[Le],Fe=F[Le+1];Oe.zeroLength?F.splice(Le,1):Fe&&Fe.isDash===Oe.isDash&&(Fe.left=Oe.left,F.splice(Le,1))}const Oe=F[0],Fe=F[F.length-1];Oe.isDash===Fe.isDash&&(Oe.left=Fe.left-this.width,Fe.right=Oe.right+this.width);const je=this.width*this.nextRow;let qe=0,He=F[qe];for(let Oe=0;Oe<this.width;Oe++){Oe/He.right>1&&(He=F[++qe]);const Fe=Math.abs(Oe-He.left),xt=Math.abs(Oe-He.right),jt=Math.min(Fe,xt);this.image.data[je+Oe]=Math.max(0,Math.min(255,(He.isDash?jt:-jt)+Le+128))}}addDash(F,Le){const Oe=this.getKey(F,Le);if(this.positions[Oe])return this.positions[Oe];const Fe="round"===Le,je=Fe?7:0,qe=2*je+1;if(this.nextRow+qe>this.height)return pt("LineAtlas out of space"),null;0===F.length&&F.push(1);let He=0;for(let Le=0;Le<F.length;Le++)F[Le]<0&&(pt("Negative value is found in line dasharray, replacing values with 0"),F[Le]=0),He+=F[Le];if(0!==He){const Oe=this.width/He,qe=this.getDashRanges(F,this.width,Oe);Fe?this.addRoundDash(qe,Oe,je):this.addRegularDash(qe,"square"===Le?.5*Oe:0)}const xt=this.nextRow+je;this.nextRow+=qe;const jt={tl:[xt,je],br:[He,0]};return this.positions[Oe]=jt,jt}}us(jp,"LineAtlas");const xy=F_.VectorTileFeature.types,vy=Math.cos(Math.PI/180*37.5),by=Math.cos(Math.PI/180*5);class Yp{constructor(F){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=F.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=F.overscaling,this.pixelRatio=F.pixelRatio,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.projection=F.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((F=>{this.gradients[F.id]={}})),this.layoutVertexArray=new Ea,this.layoutVertexArray2=new za,this.patternVertexArray=new za,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.segments=new xo,this.maxLineLength=0,this.zOffsetVertexArray=new za,this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.tessellationStep=F.tessellationStep?F.tessellationStep:sp/64}updateFootprints(F,Le){}populate(F,Le,Oe,Fe){this.hasPattern=Hc("line",this.layers,this.pixelRatio,Le);const je=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Al(Oe);const qe=this.layers[0].layout.get("line-z-offset"),He=qe.isConstant()&&!qe.constantOr(0),xt=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset="sea"===xt||"ground"===xt||!He&&"none"===xt,this.hasZOffset&&"none"===xt&&pt(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const jt=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&void 0!==jt;const Gt=[];for(const{feature:Le,id:qe,index:He,sourceLayerIndex:xt}of F){const F=this.layers[0]._featureFilter.needGeometry,jt=Cl(Le,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),jt,Oe))continue;const bi=je?je.evaluate(jt,{},Oe):void 0,wi={id:qe,properties:Le.properties,type:Le.type,sourceLayerIndex:xt,index:He,geometry:F?jt.geometry:Vl(Le,Oe,Fe),patterns:{},sortKey:bi};Gt.push(wi)}je&&Gt.sort(((F,Le)=>F.sortKey-Le.sortKey));const{lineAtlas:bi,featureIndex:wi}=Le,qr=this.addConstantDashes(bi);for(const Fe of Gt){const{geometry:je,index:qe,sourceLayerIndex:He}=Fe;if(qr&&this.addFeatureDashes(Fe,bi),this.hasPattern){const F=Xc("line",this.layers,Fe,this.zoom,this.pixelRatio,Le);this.patternFeatures.push(F)}else this.addFeature(Fe,je,qe,Oe,bi.positions,Le.availableImages,Le.brightness);wi.insert(F[qe].feature,je,qe,He,this.index)}}addConstantDashes(F){let Le=!1;for(const Oe of this.layers){const Fe=Oe.paint.get("line-dasharray").value,je=Oe.layout.get("line-cap").value;if("constant"!==Fe.kind||"constant"!==je.kind)Le=!0;else{const Le=je.value,Oe=Fe.value;if(!Oe)continue;F.addDash(Oe,Le)}}return Le}addFeatureDashes(F,Le){const Oe=this.zoom;for(const Fe of this.layers){const je=Fe.paint.get("line-dasharray").value,qe=Fe.layout.get("line-cap").value;if("constant"===je.kind&&"constant"===qe.kind)continue;let He,xt;if("constant"===je.kind){if(He=je.value,!He)continue}else He=je.evaluate({zoom:Oe},F);xt="constant"===qe.kind?qe.value:qe.evaluate({zoom:Oe},F),Le.addDash(He,xt),F.patterns[Fe.id]=Le.getKey(He,xt)}}update(F,Le,Oe,Fe,je,qe,He){this.programConfigurations.updatePaintArrays(F,Le,je,Oe,Fe,qe,He)}addFeatures(F,Le,Oe,Fe,je,qe){for(const F of this.patternFeatures)this.addFeature(F,F.geometry,F.index,Le,Oe,Fe,qe)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=F.createVertexBuffer(this.layoutVertexArray2,_y)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=F.createVertexBuffer(this.patternVertexArray,yy)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,ty.members,!0)),this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,ly),this.indexBuffer=F.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(F){if(F.properties&&F.properties.hasOwnProperty("mapbox_clip_start")&&F.properties.hasOwnProperty("mapbox_clip_end"))return{start:+F.properties.mapbox_clip_start,end:+F.properties.mapbox_clip_end}}addFeature(F,Le,Oe,Fe,je,qe,He){const xt=this.layers[0].layout,jt=xt.get("line-join").evaluate(F,{}),Gt=xt.get("line-cap").evaluate(F,{}),bi=xt.get("line-miter-limit"),wi=xt.get("line-round-limit");this.lineClips=this.lineFeatureClips(F),this.lineFeature=F,this.zOffsetValue=xt.get("line-z-offset").value;const qr=this.layers[0].paint.get("line-width").value;"constant"!==qr.kind&&!1===qr.isLineProgressConstant&&(this.variableWidthValue=qr);for(const Oe of Le)this.addLine(Oe,F,Fe,jt,Gt,bi,wi);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,Oe,je,qe,Fe,He)}addLine(F,Le,Oe,Fe,je,qe,He){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const xt="none"===Fe;if(this.patternJoinNone=this.hasPattern&&xt,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let Le=0;Le<F.length-1;Le++)this.totalDistance+=F[Le].dist(F[Le+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const jt="Polygon"===xy[Le.type];let Gt=F.length;for(;Gt>=2&&F[Gt-1].equals(F[Gt-2]);)Gt--;let bi=0;for(;bi<Gt-1&&F[bi].equals(F[bi+1]);)bi++;if(Gt<(jt?3:2))return;"bevel"===Fe&&(qe=1.05);const wi=this.segments.prepareSegment(10*Gt,this.layoutVertexArray,this.indexArray);let qr,Xn,Yn,yo,bo,Do;this.e1=this.e2=-1,jt&&(qr=F[Gt-2],bo=F[bi].sub(qr)._unit()._perp());for(let Le=bi;Le<Gt;Le++){if(Yn=Le===Gt-1?jt?F[bi+1]:void 0:F[Le+1],Yn&&F[Le].equals(Yn))continue;bo&&(yo=bo),qr&&(Xn=qr),qr=F[Le],Do=this.evaluateLineProgressFeatures(Xn?Xn.dist(qr):0),bo=Yn?Yn.sub(qr)._unit()._perp():yo,yo=yo||bo;const Oe=Xn&&Yn;let Ro=Oe?Fe:jt||xt?"butt":je;const zs=yo.x*bo.x+yo.y*bo.y;if(xt){const t=function(F){if(F.patternJoinNone){const Le=F.segmentPoints.length/2,Oe=F.lineSoFar-F.segmentStart;for(let Fe=0;Fe<Le;++Fe){const Le=F.segmentPoints[2*Fe+1],je=Math.round(F.segmentPoints[2*Fe])+.5+.25*Le;F.patternVertexArray.emplaceBack(je,Oe,F.segmentStart),F.patternVertexArray.emplaceBack(je,Oe,F.segmentStart)}F.segmentPoints.length=0}F.e1=F.e2=-1};if(Oe&&zs<by){this.updateDistance(Xn,qr),this.addCurrentVertex(qr,yo,1,1,wi,Do),t(this),this.addCurrentVertex(qr,bo,-1,-1,wi,Do);continue}if(Xn){if(!Yn){this.updateDistance(Xn,qr),this.addCurrentVertex(qr,yo,1,1,wi,Do),t(this);continue}Ro="miter"}}let Zs=yo.add(bo);0===Zs.x&&0===Zs.y||Zs._unit();const na=Zs.x*bo.x+Zs.y*bo.y,el=0!==na?1/na:1/0,nl=2*Math.sqrt(2-2*na),hl=na<vy&&Xn&&Yn,pl=yo.x*bo.y-yo.y*bo.x>0,bl=this.overscaling<=16?15*sp/(512*this.overscaling):0;if(Oe&&"round"===Ro)if(el<He)Ro="miter";else if(el<=2){const F=Hp(qr,-10,sp+10);Ro=this.hasZOffset&&(F||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===Ro&&el>qe&&(Ro="bevel"),"bevel"===Ro&&(el>2&&(Ro="flipbevel"),el<qe&&(Ro="miter")),Xn&&!("miter"===Ro&&hl)&&this.updateDistance(Xn,qr),"miter"===Ro)if(hl){const F=qr.dist(Xn);if(F>2*bl){const Le=qr.sub(qr.sub(Xn)._mult(bl/F)._round());this.updateDistance(Xn,Le),this.addCurrentVertex(Le,yo,0,0,wi,Do),Xn=Le}this.updateDistance(Xn,qr),Zs._mult(el),this.addCurrentVertex(qr,Zs,0,0,wi,Do);const Le=qr.dist(Yn);if(Le>2*bl){const F=qr.add(Yn.sub(qr)._mult(bl/Le)._round());this.updateDistance(qr,F),this.addCurrentVertex(F,bo,0,0,wi,Do),qr=F}}else Zs._mult(el),this.addCurrentVertex(qr,Zs,0,0,wi,Do);else if("flipbevel"===Ro){if(el>100)Zs=bo.mult(-1);else{const F=el*yo.add(bo).mag()/yo.sub(bo).mag();Zs._perp()._mult(F*(pl?-1:1))}this.addCurrentVertex(qr,Zs,0,0,wi,Do),this.addCurrentVertex(qr,Zs.mult(-1),0,0,wi,Do)}else if("bevel"===Ro||"fakeround"===Ro){null!=Do&&Xn&&this.addCurrentVertex(qr,yo,-1,-1,wi,Do);const F=qr.dist(Xn)<=2*bl&&"bevel"!==Ro,Le=Zs.mult(pl?1:-1);Le._mult(el);const Oe=bo.mult(pl?-1:1),Fe=yo.mult(pl?-1:1),je=this.evaluateLineProgressFeatures(this.distance);if(null==Do&&(this.addHalfVertex(qr,Le.x,Le.y,!1,!pl,0,wi,je),F||this.addHalfVertex(qr,Le.x+2*Fe.x,Le.y+2*Fe.y,!1,pl,0,wi,je)),"fakeround"===Ro){const F=Math.round(180*nl/Math.PI/20);this.addHalfVertex(qr,Fe.x,Fe.y,!1,pl,0,wi,je);for(let Le=0;Le<F;Le++){let qe=Le/F;if(.5!==qe){const F=qe-.5;qe+=qe*F*(qe-1)*((1.0904+zs*(zs*(3.55645-1.43519*zs)-3.2452))*F*F+(.848013+zs*(.215638*zs-1.06021)))}const He=Oe.sub(Fe)._mult(qe)._add(Fe)._unit();this.addHalfVertex(qr,He.x,He.y,!1,pl,0,wi,je)}this.addHalfVertex(qr,Oe.x,Oe.y,!1,pl,0,wi,je)}F||null!=Do||this.addHalfVertex(qr,Le.x+2*Oe.x,Le.y+2*Oe.y,!1,pl,0,wi,je),null!=Do&&Yn&&this.addCurrentVertex(qr,bo,1,1,wi,Do)}else"butt"===Ro?this.addCurrentVertex(qr,Zs,0,0,wi,Do):"square"===Ro?(Xn||this.addCurrentVertex(qr,Zs,-1,-1,wi,Do),this.addCurrentVertex(qr,Zs,0,0,wi,Do),Xn&&this.addCurrentVertex(qr,Zs,1,1,wi,Do)):"round"===Ro&&(Xn&&(this.addCurrentVertex(qr,yo,0,0,wi,Do),this.addCurrentVertex(qr,yo,1,1,wi,Do,!0)),Yn&&(this.addCurrentVertex(qr,bo,-1,-1,wi,Do,!0),this.addCurrentVertex(qr,bo,0,0,wi,Do)))}}addVerticesTo(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt){const bi=(Le.w-F.w)/this.tessellationStep|0;let wi=0;const qr=this.scaledDistance;if(bi>1){this.lineSoFar=F.w;const qr=(Le.x-F.x)/bi,Xn=(Le.y-F.y)/bi,Yn=(Le.z-F.z)/bi,yo=(Le.w-F.w)/bi;for(let Le=1;Le<bi;++Le){F.x+=qr,F.y+=Xn,F.z+=Yn,this.lineSoFar+=yo,wi+=yo;const Le=this.evaluateLineProgressFeatures(this.prevDistance+wi);this.scaledDistance=(this.prevDistance+wi)/this.totalDistance,this.addHalfVertex(F,Oe,Fe,Gt,!1,He,jt,Le),this.addHalfVertex(F,je,qe,Gt,!0,-xt,jt,Le)}}this.lineSoFar=Le.w,this.scaledDistance=qr;const Xn=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(Le,Oe,Fe,Gt,!1,He,jt,Xn),this.addHalfVertex(Le,je,qe,Gt,!0,-xt,jt,Xn)}evaluateLineProgressFeatures(F){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+F)/this.totalFeatureLength):pt(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let Le=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(Le=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:Le}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:Le}:{zOffset:0,variableWidth:Le}}addCurrentVertex(F,Le,Oe,Fe,je,qe,He=!1){const xt=Le.x+Le.y*Oe,jt=Le.y-Le.x*Oe,Gt=Le.y*Fe-Le.x,bi=-Le.y-Le.x*Fe;if(null!=qe){const Le=this.hasZOffset,wi=-10,qr=sp+10,Xn=qe.zOffset,Yn=new Lh(F.x,F.y,Xn,this.lineSoFar),yo=!!Le&&Hp(F,wi,qr),bo=this.lineSoFar,Do=this.distance;if(this.currentVertex)if(yo){const Le=this.currentVertexIsOutside,qe=this.currentVertex,yo=new Lh(F.x,F.y,Xn,this.lineSoFar);if(Nh(qe,yo,wi,qr),!Hp(yo,wi,qr)){if(Le){this.e1=this.e2=-1,this.distance-=qe.dist(Yn),this.lineSoFar=qe.w;const F=this.evaluateLineProgressFeatures(qe.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(qe,xt,jt,He,!1,Oe,je,F),this.addHalfVertex(qe,Gt,bi,He,!0,-Fe,je,F),this.prevDistance=this.distance}this.distance=this.prevDistance+qe.dist(yo),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(qe,yo,xt,jt,Gt,bi,Oe,Fe,je,He),this.distance=Do,this.scaledDistance=this.distance/this.totalDistance}}else{const F=this.currentVertex;if(this.currentVertexIsOutside){Nh(F,Yn,wi,qr),this.e1=this.e2=-1,this.distance-=F.dist(Yn),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=F.w;const Le=this.evaluateLineProgressFeatures(F.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(F,xt,jt,He,!1,Oe,je,Le),this.addHalfVertex(F,Gt,bi,He,!0,-Fe,je,Le),this.prevDistance=this.distance,this.distance=Do,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(F,Yn,xt,jt,Gt,bi,Oe,Fe,je,He)}else yo||(this.addHalfVertex(F,xt,jt,He,!1,Oe,je,qe),this.addHalfVertex(F,Gt,bi,He,!0,-Fe,je,qe));this.currentVertex=Yn,this.currentVertexIsOutside=yo,this.lineSoFar=bo}else this.addHalfVertex(F,xt,jt,He,!1,Oe,je,qe),this.addHalfVertex(F,Gt,bi,He,!0,-Fe,je,qe)}addHalfVertex({x:F,y:Le},Oe,Fe,je,qe,He,xt,jt){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),qe||this.segmentPoints.push(this.lineSoFar-this.segmentStart,He)),this.layoutVertexArray.emplaceBack((F<<1)+(je?1:0),(Le<<1)+(qe?1:0),Math.round(63*Oe)+128,Math.round(63*Fe)+128,1+(0===He?0:He<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const F=Ee(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,F)}const Gt=xt.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,Gt),xt.primitiveLength++),qe?this.e2=Gt:this.e1=Gt,null!=jt&&this.zOffsetVertexArray.emplaceBack(jt.zOffset,jt.variableWidth,jt.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(F,Le){this.prevDistance=this.distance,this.distance+=F.dist(Le),this.updateScaledDistance()}}function Hp(F,Le,Oe){return F.x<Le||F.x>Oe||F.y<Le||F.y>Oe}let wy,Ty;function Wp(F,Le,Oe){return Le*(sp/(F.tileSize*Math.pow(2,Oe-F.tileID.overscaledZ)))}us(Yp,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const Kp=(F,Le,Oe)=>(1-Oe)*F+Oe*Le;function Jp(F,Le){return 1/Wp(F,1,Le.tileZoom)}function Qp(F,Le,Oe,Fe){return F.translatePosMatrix(Fe||Le.tileID.projMatrix,Le,Oe.paint.get("line-translate"),Oe.paint.get("line-translate-anchor"))}const tf=F=>{const Le=[];ef(F)&&Le.push("RENDER_LINE_DASH"),F.paint.get("line-gradient")&&Le.push("RENDER_LINE_GRADIENT");const Oe=F.paint.get("line-trim-offset");0===Oe[0]&&0===Oe[1]||Le.push("RENDER_LINE_TRIM_OFFSET"),0!==F.paint.get("line-border-width").constantOr(1)&&Le.push("RENDER_LINE_BORDER");const Fe="none"===F.layout.get("line-join").constantOr("miter"),je=!!F.paint.get("line-pattern").constantOr(1);return Fe&&je&&Le.push("LINE_JOIN_NONE"),Le};function ef(F){const Le=F.paint.get("line-dasharray").value;return Le.value||"constant"!==Le.kind}let Ey;const nf=()=>Ey||(Ey={layout:wy||(wy=new Xs({"line-cap":new Ys(Df.layout_line["line-cap"]),"line-join":new Ys(Df.layout_line["line-join"]),"line-miter-limit":new Gs(Df.layout_line["line-miter-limit"]),"line-round-limit":new Gs(Df.layout_line["line-round-limit"]),"line-sort-key":new Ys(Df.layout_line["line-sort-key"]),"line-z-offset":new Ys(Df.layout_line["line-z-offset"]),"line-elevation-reference":new Gs(Df.layout_line["line-elevation-reference"]),"line-cross-slope":new Gs(Df.layout_line["line-cross-slope"]),visibility:new Gs(Df.layout_line.visibility),"line-width-unit":new Gs(Df.layout_line["line-width-unit"])})),paint:Ty||(Ty=new Xs({"line-opacity":new Ys(Df.paint_line["line-opacity"]),"line-color":new Ys(Df.paint_line["line-color"]),"line-translate":new Gs(Df.paint_line["line-translate"]),"line-translate-anchor":new Gs(Df.paint_line["line-translate-anchor"]),"line-width":new Ys(Df.paint_line["line-width"]),"line-gap-width":new Ys(Df.paint_line["line-gap-width"]),"line-offset":new Ys(Df.paint_line["line-offset"]),"line-blur":new Ys(Df.paint_line["line-blur"]),"line-dasharray":new Ys(Df.paint_line["line-dasharray"]),"line-pattern":new Ys(Df.paint_line["line-pattern"]),"line-gradient":new Hs(Df.paint_line["line-gradient"]),"line-trim-offset":new Gs(Df.paint_line["line-trim-offset"]),"line-trim-fade-range":new Gs(Df.paint_line["line-trim-fade-range"]),"line-trim-color":new Gs(Df.paint_line["line-trim-color"]),"line-emissive-strength":new Gs(Df.paint_line["line-emissive-strength"]),"line-border-width":new Ys(Df.paint_line["line-border-width"]),"line-border-color":new Ys(Df.paint_line["line-border-color"]),"line-occlusion-opacity":new Gs(Df.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Ey);class sf extends Ys{possiblyEvaluate(F,Le){return Le=new Rs(Math.floor(Le.zoom),{now:Le.now,fadeDuration:Le.fadeDuration,transition:Le.transition}),super.possiblyEvaluate(F,Le)}evaluate(F,Le,Oe,Fe){return Le=nt({},Le,{zoom:Math.floor(Le.zoom)}),super.evaluate(F,Le,Oe,Fe)}}let zy;function of(F,Le){return Le>0?Le+2*F:F}const Oy=va([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),ky=va([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Ny=va([{name:"a_projected_pos",components:4,type:"Float32"}],4);va([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const qy=va([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),Wy=va([{name:"a_texb",components:2,type:"Uint16"}]),lx=va([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),Tx=va([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);va([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Sx=va([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Ex=va([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);va([{name:"triangle",components:3,type:"Uint16"}]),va([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),va([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),va([{type:"Float32",name:"offsetX"}]),va([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var Mx=24;const Ax=128;function vf(F,Le,Oe,Fe,je){if("camera"===F.kind)return F.maxSize;if("composite"===F.kind){const Fe=Le.possiblyEvaluate(new Rs(F.maxZoom),Oe).evaluate(je,{},Oe),qe=Le.possiblyEvaluate(new Rs(F.minZoom),Oe).evaluate(je,{},Oe);return Math.max(Fe,qe)}return Le.possiblyEvaluate(new Rs(Fe)).evaluate(je,{},Oe)}function bf(F,Le){const{expression:Oe}=Le;if("constant"===Oe.kind)return{kind:"constant",layoutSize:Oe.evaluate(new Rs(F+1))};if("source"===Oe.kind)return{kind:"source"};{const{zoomStops:Le,interpolationType:Fe}=Oe;let je=0;for(;je<Le.length&&Le[je]<=F;)je++;je=Math.max(0,je-1);let qe=je;for(;qe<Le.length&&Le[qe]<F+1;)qe++;qe=Math.min(Le.length-1,qe);const He=Le[je],xt=Le[qe];return"composite"===Oe.kind?{kind:"composite",minZoom:He,maxZoom:xt,interpolationType:Fe}:{kind:"camera",minZoom:He,maxZoom:xt,minSize:Oe.evaluate(new Rs(He)),maxSize:Oe.evaluate(new Rs(xt)),interpolationType:Fe}}}function _f(F,{uSize:Le,uSizeT:Oe},{lowerSize:Fe,upperSize:je}){return"source"===F.kind?Fe/Ax:"composite"===F.kind?Ee(Fe/Ax,je/Ax,Oe):Le}function wf(F,Le,Oe=1){let Fe=0,je=0;if("constant"===F.kind)je=F.layoutSize*Oe;else if("source"!==F.kind){const{interpolationType:qe,minZoom:He,maxZoom:xt}=F,jt=qe?Q(ai.interpolationFactor(qe,Le,He,xt),0,1):0;"camera"===F.kind?je=Ee(F.minSize,F.maxSize,jt)*Oe:Fe=jt*Oe}return{uSizeT:Fe,uSize:je}}var Ix=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Ax,evaluateSizeForFeature:_f,evaluateSizeForZoom:wf,getRasterizedIconSize:vf,getSizeData:bf});function Af(F,Le,Oe){return F.sections.forEach((F=>{F.text=function(F,Le,Oe){const Fe=Le.layout.get("text-transform").evaluate(Oe,{});return"uppercase"===Fe?F=F.toLocaleUpperCase():"lowercase"===Fe&&(F=F.toLocaleLowerCase()),zf.applyArabicShaping&&(F=zf.applyArabicShaping(F)),F}(F.text,Le,Oe)})),F}const Cx={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function Sf(F){return""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F}function Pf(F){return""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F||""===F}var Px,Dx,Rx,Ox={};function Bf(){return Px||(Px=1,Ox.read=function(F,Le,Oe,Fe,je){var qe,He,xt=8*je-Fe-1,jt=(1<<xt)-1,Gt=jt>>1,bi=-7,wi=Oe?je-1:0,qr=Oe?-1:1,Xn=F[Le+wi];for(wi+=qr,qe=Xn&(1<<-bi)-1,Xn>>=-bi,bi+=xt;bi>0;qe=256*qe+F[Le+wi],wi+=qr,bi-=8);for(He=qe&(1<<-bi)-1,qe>>=-bi,bi+=Fe;bi>0;He=256*He+F[Le+wi],wi+=qr,bi-=8);if(0===qe)qe=1-Gt;else{if(qe===jt)return He?NaN:1/0*(Xn?-1:1);He+=Math.pow(2,Fe),qe-=Gt}return(Xn?-1:1)*He*Math.pow(2,qe-Fe)},Ox.write=function(F,Le,Oe,Fe,je,qe){var He,xt,jt,Gt=8*qe-je-1,bi=(1<<Gt)-1,wi=bi>>1,qr=23===je?Math.pow(2,-24)-Math.pow(2,-77):0,Xn=Fe?0:qe-1,Yn=Fe?1:-1,yo=Le<0||0===Le&&1/Le<0?1:0;for(Le=Math.abs(Le),isNaN(Le)||Le===1/0?(xt=isNaN(Le)?1:0,He=bi):(He=Math.floor(Math.log(Le)/Math.LN2),Le*(jt=Math.pow(2,-He))<1&&(He--,jt*=2),(Le+=He+wi>=1?qr/jt:qr*Math.pow(2,1-wi))*jt>=2&&(He++,jt/=2),He+wi>=bi?(xt=0,He=bi):He+wi>=1?(xt=(Le*jt-1)*Math.pow(2,je),He+=wi):(xt=Le*Math.pow(2,wi-1)*Math.pow(2,je),He=0));je>=8;F[Oe+Xn]=255&xt,Xn+=Yn,xt/=256,je-=8);for(He=He<<je|xt,Gt+=je;Gt>0;F[Oe+Xn]=255&He,Xn+=Yn,He/=256,Gt-=8);F[Oe+Xn-Yn]|=128*yo}),Ox}function Vf(){if(Rx)return Dx;Rx=1,Dx=e;var Le=Bf();function e(Le){(this||F).buf=ArrayBuffer.isView&&ArrayBuffer.isView(Le)?Le:new Uint8Array(Le||0),(this||F).pos=0,(this||F).type=0,(this||F).length=(this||F).buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var Oe=4294967296,Fe=1/Oe,je="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function s(F){return F.type===e.Bytes?F.readVarint()+F.pos:F.pos+1}function a(F,Le,Oe){return Oe?4294967296*Le+(F>>>0):4294967296*(Le>>>0)+(F>>>0)}function o(F,Le,Oe){var Fe=Le<=16383?1:Le<=2097151?2:Le<=268435455?3:Math.floor(Math.log(Le)/(7*Math.LN2));Oe.realloc(Fe);for(var je=Oe.pos-1;je>=F;je--)Oe.buf[je+Fe]=Oe.buf[je]}function l(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeVarint(F[Oe])}function u(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeSVarint(F[Oe])}function c(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeFloat(F[Oe])}function h(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeDouble(F[Oe])}function p(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeBoolean(F[Oe])}function f(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeFixed32(F[Oe])}function d(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeSFixed32(F[Oe])}function m(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeFixed64(F[Oe])}function y(F,Le){for(var Oe=0;Oe<F.length;Oe++)Le.writeSFixed64(F[Oe])}function g(F,Le){return(F[Le]|F[Le+1]<<8|F[Le+2]<<16)+16777216*F[Le+3]}function x(F,Le,Oe){F[Oe]=Le,F[Oe+1]=Le>>>8,F[Oe+2]=Le>>>16,F[Oe+3]=Le>>>24}function v(F,Le){return(F[Le]|F[Le+1]<<8|F[Le+2]<<16)+(F[Le+3]<<24)}return e.prototype={destroy:function(){(this||F).buf=null},readFields:function(Le,Oe,Fe){for(Fe=Fe||(this||F).length;(this||F).pos<Fe;){var je=this.readVarint(),qe=je>>3,He=(this||F).pos;(this||F).type=7&je,Le(qe,Oe,this||F),(this||F).pos===He&&this.skip(je)}return Oe},readMessage:function(Le,Oe){return this.readFields(Le,Oe,this.readVarint()+(this||F).pos)},readFixed32:function(){var Le=g((this||F).buf,(this||F).pos);return(this||F).pos+=4,Le},readSFixed32:function(){var Le=v((this||F).buf,(this||F).pos);return(this||F).pos+=4,Le},readFixed64:function(){var Le=g((this||F).buf,(this||F).pos)+g((this||F).buf,(this||F).pos+4)*Oe;return(this||F).pos+=8,Le},readSFixed64:function(){var Le=g((this||F).buf,(this||F).pos)+v((this||F).buf,(this||F).pos+4)*Oe;return(this||F).pos+=8,Le},readFloat:function(){var Oe=Le.read((this||F).buf,(this||F).pos,!0,23,4);return(this||F).pos+=4,Oe},readDouble:function(){var Oe=Le.read((this||F).buf,(this||F).pos,!0,52,8);return(this||F).pos+=8,Oe},readVarint:function(Le){var Oe,Fe,je=(this||F).buf;return Oe=127&(Fe=je[(this||F).pos++]),Fe<128?Oe:(Oe|=(127&(Fe=je[(this||F).pos++]))<<7,Fe<128?Oe:(Oe|=(127&(Fe=je[(this||F).pos++]))<<14,Fe<128?Oe:(Oe|=(127&(Fe=je[(this||F).pos++]))<<21,Fe<128?Oe:function(F,Le,Oe){var Fe,je,qe=Oe.buf;if(Fe=(112&(je=qe[Oe.pos++]))>>4,je<128)return a(F,Fe,Le);if(Fe|=(127&(je=qe[Oe.pos++]))<<3,je<128)return a(F,Fe,Le);if(Fe|=(127&(je=qe[Oe.pos++]))<<10,je<128)return a(F,Fe,Le);if(Fe|=(127&(je=qe[Oe.pos++]))<<17,je<128)return a(F,Fe,Le);if(Fe|=(127&(je=qe[Oe.pos++]))<<24,je<128)return a(F,Fe,Le);if(Fe|=(1&(je=qe[Oe.pos++]))<<31,je<128)return a(F,Fe,Le);throw new Error("Expected varint not more than 10 bytes")}(Oe|=(15&(Fe=je[(this||F).pos]))<<28,Le,this||F))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var F=this.readVarint();return F%2==1?(F+1)/-2:F/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var Le=this.readVarint()+(this||F).pos,Oe=(this||F).pos;return(this||F).pos=Le,Le-Oe>=12&&je?function(F,Le,Oe){return je.decode(F.subarray(Le,Oe))}((this||F).buf,Oe,Le):function(F,Le,Oe){for(var Fe="",je=Le;je<Oe;){var qe,He,xt,jt=F[je],Gt=null,bi=jt>239?4:jt>223?3:jt>191?2:1;if(je+bi>Oe)break;1===bi?jt<128&&(Gt=jt):2===bi?128==(192&(qe=F[je+1]))&&(Gt=(31&jt)<<6|63&qe)<=127&&(Gt=null):3===bi?(He=F[je+2],128==(192&(qe=F[je+1]))&&128==(192&He)&&((Gt=(15&jt)<<12|(63&qe)<<6|63&He)<=2047||Gt>=55296&&Gt<=57343)&&(Gt=null)):4===bi&&(He=F[je+2],xt=F[je+3],128==(192&(qe=F[je+1]))&&128==(192&He)&&128==(192&xt)&&((Gt=(15&jt)<<18|(63&qe)<<12|(63&He)<<6|63&xt)<=65535||Gt>=1114112)&&(Gt=null)),null===Gt?(Gt=65533,bi=1):Gt>65535&&(Gt-=65536,Fe+=String.fromCharCode(Gt>>>10&1023|55296),Gt=56320|1023&Gt),Fe+=String.fromCharCode(Gt),je+=bi}return Fe}((this||F).buf,Oe,Le)},readBytes:function(){var Le=this.readVarint()+(this||F).pos,Oe=(this||F).buf.subarray((this||F).pos,Le);return(this||F).pos=Le,Oe},readPackedVarint:function(Le,Oe){if((this||F).type!==e.Bytes)return Le.push(this.readVarint(Oe));var Fe=s(this||F);for(Le=Le||[];(this||F).pos<Fe;)Le.push(this.readVarint(Oe));return Le},readPackedSVarint:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readSVarint());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readSVarint());return Le},readPackedBoolean:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readBoolean());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readBoolean());return Le},readPackedFloat:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readFloat());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readFloat());return Le},readPackedDouble:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readDouble());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readDouble());return Le},readPackedFixed32:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readFixed32());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readFixed32());return Le},readPackedSFixed32:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readSFixed32());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readSFixed32());return Le},readPackedFixed64:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readFixed64());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readFixed64());return Le},readPackedSFixed64:function(Le){if((this||F).type!==e.Bytes)return Le.push(this.readSFixed64());var Oe=s(this||F);for(Le=Le||[];(this||F).pos<Oe;)Le.push(this.readSFixed64());return Le},skip:function(Le){var Oe=7&Le;if(Oe===e.Varint)for(;(this||F).buf[(this||F).pos++]>127;);else if(Oe===e.Bytes)(this||F).pos=this.readVarint()+(this||F).pos;else if(Oe===e.Fixed32)(this||F).pos+=4;else{if(Oe!==e.Fixed64)throw new Error("Unimplemented type: "+Oe);(this||F).pos+=8}},writeTag:function(F,Le){this.writeVarint(F<<3|Le)},realloc:function(Le){for(var Oe=(this||F).length||16;Oe<(this||F).pos+Le;)Oe*=2;if(Oe!==(this||F).length){var Fe=new Uint8Array(Oe);Fe.set((this||F).buf),(this||F).buf=Fe,(this||F).length=Oe}},finish:function(){return(this||F).length=(this||F).pos,(this||F).pos=0,(this||F).buf.subarray(0,(this||F).length)},writeFixed32:function(Le){this.realloc(4),x((this||F).buf,Le,(this||F).pos),(this||F).pos+=4},writeSFixed32:function(Le){this.realloc(4),x((this||F).buf,Le,(this||F).pos),(this||F).pos+=4},writeFixed64:function(Le){this.realloc(8),x((this||F).buf,-1&Le,(this||F).pos),x((this||F).buf,Math.floor(Le*Fe),(this||F).pos+4),(this||F).pos+=8},writeSFixed64:function(Le){this.realloc(8),x((this||F).buf,-1&Le,(this||F).pos),x((this||F).buf,Math.floor(Le*Fe),(this||F).pos+4),(this||F).pos+=8},writeVarint:function(Le){(Le=+Le||0)>268435455||Le<0?function(F,Le){var Oe,Fe;if(F>=0?(Oe=F%4294967296|0,Fe=F/4294967296|0):(Fe=~(-F/4294967296),4294967295^(Oe=~(-F%4294967296))?Oe=Oe+1|0:(Oe=0,Fe=Fe+1|0)),F>=0x10000000000000000||F<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");Le.realloc(10),function(F,Le,Oe){Oe.buf[Oe.pos++]=127&F|128,F>>>=7,Oe.buf[Oe.pos++]=127&F|128,F>>>=7,Oe.buf[Oe.pos++]=127&F|128,F>>>=7,Oe.buf[Oe.pos++]=127&F|128,Oe.buf[Oe.pos]=127&(F>>>=7)}(Oe,0,Le),function(F,Le){var Oe=(7&F)<<4;Le.buf[Le.pos++]|=Oe|((F>>>=3)?128:0),F&&(Le.buf[Le.pos++]=127&F|((F>>>=7)?128:0),F&&(Le.buf[Le.pos++]=127&F|((F>>>=7)?128:0),F&&(Le.buf[Le.pos++]=127&F|((F>>>=7)?128:0),F&&(Le.buf[Le.pos++]=127&F|((F>>>=7)?128:0),F&&(Le.buf[Le.pos++]=127&F)))))}(Fe,Le)}(Le,this||F):(this.realloc(4),(this||F).buf[(this||F).pos++]=127&Le|(Le>127?128:0),Le<=127||((this||F).buf[(this||F).pos++]=127&(Le>>>=7)|(Le>127?128:0),Le<=127||((this||F).buf[(this||F).pos++]=127&(Le>>>=7)|(Le>127?128:0),Le<=127||((this||F).buf[(this||F).pos++]=Le>>>7&127))))},writeSVarint:function(F){this.writeVarint(F<0?2*-F-1:2*F)},writeBoolean:function(F){this.writeVarint(Boolean(F))},writeString:function(Le){Le=String(Le),this.realloc(4*Le.length),(this||F).pos++;var Oe=(this||F).pos;(this||F).pos=function(F,Le,Oe){for(var Fe,je,qe=0;qe<Le.length;qe++){if((Fe=Le.charCodeAt(qe))>55295&&Fe<57344){if(!je){Fe>56319||qe+1===Le.length?(F[Oe++]=239,F[Oe++]=191,F[Oe++]=189):je=Fe;continue}if(Fe<56320){F[Oe++]=239,F[Oe++]=191,F[Oe++]=189,je=Fe;continue}Fe=je-55296<<10|Fe-56320|65536,je=null}else je&&(F[Oe++]=239,F[Oe++]=191,F[Oe++]=189,je=null);Fe<128?F[Oe++]=Fe:(Fe<2048?F[Oe++]=Fe>>6|192:(Fe<65536?F[Oe++]=Fe>>12|224:(F[Oe++]=Fe>>18|240,F[Oe++]=Fe>>12&63|128),F[Oe++]=Fe>>6&63|128),F[Oe++]=63&Fe|128)}return Oe}((this||F).buf,Le,(this||F).pos);var Fe=(this||F).pos-Oe;Fe>=128&&o(Oe,Fe,this||F),(this||F).pos=Oe-1,this.writeVarint(Fe),(this||F).pos+=Fe},writeFloat:function(Oe){this.realloc(4),Le.write((this||F).buf,Oe,(this||F).pos,!0,23,4),(this||F).pos+=4},writeDouble:function(Oe){this.realloc(8),Le.write((this||F).buf,Oe,(this||F).pos,!0,52,8),(this||F).pos+=8},writeBytes:function(Le){var Oe=Le.length;this.writeVarint(Oe),this.realloc(Oe);for(var Fe=0;Fe<Oe;Fe++)(this||F).buf[(this||F).pos++]=Le[Fe]},writeRawMessage:function(Le,Oe){(this||F).pos++;var Fe=(this||F).pos;Le(Oe,this||F);var je=(this||F).pos-Fe;je>=128&&o(Fe,je,this||F),(this||F).pos=Fe-1,this.writeVarint(je),(this||F).pos+=je},writeMessage:function(F,Le,Oe){this.writeTag(F,e.Bytes),this.writeRawMessage(Le,Oe)},writePackedVarint:function(F,Le){Le.length&&this.writeMessage(F,l,Le)},writePackedSVarint:function(F,Le){Le.length&&this.writeMessage(F,u,Le)},writePackedBoolean:function(F,Le){Le.length&&this.writeMessage(F,p,Le)},writePackedFloat:function(F,Le){Le.length&&this.writeMessage(F,c,Le)},writePackedDouble:function(F,Le){Le.length&&this.writeMessage(F,h,Le)},writePackedFixed32:function(F,Le){Le.length&&this.writeMessage(F,f,Le)},writePackedSFixed32:function(F,Le){Le.length&&this.writeMessage(F,d,Le)},writePackedFixed64:function(F,Le){Le.length&&this.writeMessage(F,m,Le)},writePackedSFixed64:function(F,Le){Le.length&&this.writeMessage(F,y,Le)},writeBytesField:function(F,Le){this.writeTag(F,e.Bytes),this.writeBytes(Le)},writeFixed32Field:function(F,Le){this.writeTag(F,e.Fixed32),this.writeFixed32(Le)},writeSFixed32Field:function(F,Le){this.writeTag(F,e.Fixed32),this.writeSFixed32(Le)},writeFixed64Field:function(F,Le){this.writeTag(F,e.Fixed64),this.writeFixed64(Le)},writeSFixed64Field:function(F,Le){this.writeTag(F,e.Fixed64),this.writeSFixed64(Le)},writeVarintField:function(F,Le){this.writeTag(F,e.Varint),this.writeVarint(Le)},writeSVarintField:function(F,Le){this.writeTag(F,e.Varint),this.writeSVarint(Le)},writeStringField:function(F,Le){this.writeTag(F,e.Bytes),this.writeString(Le)},writeFloatField:function(F,Le){this.writeTag(F,e.Fixed32),this.writeFloat(Le)},writeDoubleField:function(F,Le){this.writeTag(F,e.Fixed64),this.writeDouble(Le)},writeBooleanField:function(F,Le){this.writeVarintField(F,Boolean(Le))}},Dx}var kx=e(Vf());const Fx=3;function Rf(F,Le,Oe){Le.glyphs=[],1===F&&Oe.readMessage(Lf,Le)}function Lf(F,Le,Oe){if(3===F){const{id:F,bitmap:Fe,width:je,height:qe,left:He,top:xt,advance:jt}=Oe.readMessage(Ff,{});Le.glyphs.push({id:F,bitmap:new hc({width:je+2*Fx,height:qe+2*Fx},Fe),metrics:{width:je,height:qe,left:He,top:xt,advance:jt}})}else 4===F?Le.ascender=Oe.readSVarint():5===F&&(Le.descender=Oe.readSVarint())}function Ff(F,Le,Oe){1===F?Le.id=Oe.readVarint():2===F?Le.bitmap=Oe.readBytes():3===F?Le.width=Oe.readVarint():4===F?Le.height=Oe.readVarint():5===F?Le.left=Oe.readSVarint():6===F?Le.top=Oe.readSVarint():7===F&&(Le.advance=Oe.readVarint())}const Bx=Fx,Nx={horizontal:1,vertical:2,horizontalOnly:3};class Uf{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(F,Le){const Oe=new Uf;return Oe.scale=F||1,Oe.fontStack=Le,Oe}static forImage(F){const Le=new Uf;return Le.image=F,Le}}class jf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(F,Le,Oe){const Fe=new jf;for(let je=0;je<F.sections.length;je++){const qe=F.sections[je];qe.image?Fe.addImageSection(qe,Oe):Fe.addTextSection(qe,Le)}return Fe}length(){return this.text.length}getSection(F){return this.sections[this.sectionIndex[F]]}getSections(){return this.sections}getSectionIndex(F){return this.sectionIndex[F]}getCodePoint(F){return this.text.codePointAt(F)}verticalizePunctuation(F){this.text=function(F,Le){let Oe="";for(let Fe=0;Fe<F.length;Fe++){const je=F.charCodeAt(Fe+1)||null,qe=F.charCodeAt(Fe-1)||null;Oe+=!Le&&(je&&vs(je)&&!Cx[F[Fe+1]]||qe&&vs(qe)&&!Cx[F[Fe-1]])||!Cx[F[Fe]]?F[Fe]:Cx[F[Fe]]}return Oe}(this.text,F)}trim(){let F=0;for(let Le=0;Le<this.text.length&&Vx[this.text.charCodeAt(Le)];Le++)F++;let Le=this.text.length;for(let Oe=this.text.length-1;Oe>=0&&Oe>=F&&Vx[this.text.charCodeAt(Oe)];Oe--)Le--;this.text=this.text.substring(F,Le),this.sectionIndex=this.sectionIndex.slice(F,Le)}substring(F,Le){const Oe=new jf;return Oe.text=this.text.substring(F,Le),Oe.sectionIndex=this.sectionIndex.slice(F,Le),Oe.sections=this.sections,Oe}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((F,Le)=>Math.max(F,this.sections[Le].scale)),0)}addTextSection(F,Le){this.text+=F.text,this.sections.push(Uf.forText(F.scale,F.fontStack||Le));const Oe=this.sections.length-1;for(let Le=0;Le<F.text.length;++Le)this.sectionIndex.push(Oe)}addImageSection(F,Le){const Oe=F.image?F.image.getPrimary():null;if(!Oe)return void pt("Can't add FormattedSection with an empty image.");Oe.scaleSelf(Le);const Fe=this.getNextImageSectionCharCode();Fe?(this.text+=String.fromCodePoint(Fe),this.sections.push(Uf.forImage(Oe)),this.sectionIndex.push(this.sections.length-1)):pt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function qf(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo=1){const bo=jf.fromFeature(F,je,yo);wi===Nx.vertical&&bo.verticalizePunctuation(qr);let Do=[];const Ro=function(F,Le,Oe,Fe,je,qe){if(!F)return[];const He=[],xt=function(F,Le,Oe,Fe,je,qe){let He=0;for(let Oe=0;Oe<F.length();Oe++){const xt=F.getSection(Oe);He+=Yf(F.getCodePoint(Oe),xt,Fe,je,Le,qe)}return He/Math.max(1,Math.ceil(He/Oe))}(F,Le,Oe,Fe,je,qe),jt=F.text.indexOf("")>=0;let Gt=0;for(let Oe=0;Oe<F.length();Oe++){const wi=F.getSection(Oe),qr=F.getCodePoint(Oe);if(Vx[qr]||(Gt+=Yf(qr,wi,Fe,je,Le,qe)),Oe<F.length()-1){const Le=!((bi=qr)<11904||!(gf["Bopomofo Extended"](bi)||gf.Bopomofo(bi)||gf["CJK Compatibility Forms"](bi)||gf["CJK Compatibility Ideographs"](bi)||gf["CJK Compatibility"](bi)||gf["CJK Radicals Supplement"](bi)||gf["CJK Strokes"](bi)||gf["CJK Symbols and Punctuation"](bi)||gf["CJK Unified Ideographs Extension A"](bi)||gf["CJK Unified Ideographs"](bi)||gf["Enclosed CJK Letters and Months"](bi)||gf["Halfwidth and Fullwidth Forms"](bi)||gf.Hiragana(bi)||gf["Ideographic Description Characters"](bi)||gf["Kangxi Radicals"](bi)||gf["Katakana Phonetic Extensions"](bi)||gf.Katakana(bi)||gf["Vertical Forms"](bi)||gf["Yi Radicals"](bi)||gf["Yi Syllables"](bi)));(Ux[qr]||Le||wi.image)&&He.push(Zf(Oe+1,Gt,xt,He,Xf(qr,F.getCodePoint(Oe+1),Le&&jt),!1))}}var bi;return Wf(Zf(F.length(),Gt,xt,He,0,!0))}(bo,Gt,qe,Le,Fe,Xn),{processBidirectionalText:zs,processStyledBidirectionalText:Zs}=zf;if(zs&&1===bo.sections.length){const F=zs(bo.toString(),Ro);for(const Le of F){const F=new jf;F.text=Le,F.sections=bo.sections;for(let Oe=0;Oe<Le.length;Oe++)F.sectionIndex.push(0);Do.push(F)}}else if(Zs){const F=Zs(bo.text,bo.sectionIndex,Ro);for(const Le of F){const F=new jf;F.text=Le[0],F.sectionIndex=Le[1],F.sections=bo.sections,Do.push(F)}}else Do=function(F,Le){const Oe=[],Fe=F.text;let je=0;for(const Fe of Le)Oe.push(F.substring(je,Fe)),je=Fe;return je<Fe.length&&Oe.push(F.substring(je,Fe.length)),Oe}(bo,Ro);const na=[],el={positionedLines:na,text:bo.toString(),top:bi[1],bottom:bi[1],left:bi[0],right:bi[0],writingMode:wi,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi){let qr=0,Xn=0,Yn=0;const yo="right"===xt?1:"left"===xt?0:.5;let bo=!1;for(const F of je){const Oe=F.getSections();for(const F of Oe){if(F.image)continue;const Oe=Le[F.fontStack];if(Oe&&(bo=void 0!==Oe.ascender&&void 0!==Oe.descender,!bo))break}if(!bo)break}let Do=0;for(const He of je){He.trim();const je=He.getMaxScale(),xt=(je-1)*Mx,zs={positionedGlyphs:[],lineOffset:0};F.positionedLines[Do]=zs;const Zs=zs.positionedGlyphs;let na=0;if(!He.length()){Xn+=qe,++Do;continue}let el=0,nl=0;for(let qe=0;qe<He.length();qe++){const xt=He.getSection(qe),Yn=He.getSectionIndex(qe),yo=He.getCodePoint(qe);let Do=xt.scale,zs=null,hl=null,pl=null,bl=Mx,Tl=0;jt===Nx.vertical&&(12312===(Ro=yo)||12313===Ro||12316===Ro||12540===Ro||12448===Ro)&&(jt=Nx.horizontal);const kl=!(jt===Nx.horizontal||!bi&&!xs(yo)||bi&&(Vx[yo]||bs(yo)));if(xt.image){const Le=Fe.get(xt.image.toString());if(!Le)continue;pl=xt.image,F.iconsInText=F.iconsInText||!0,hl=Le.paddedRect;const Oe=Le.displaySize;Do=Do*Mx/wi,zs={width:Oe[0],height:Oe[1],left:0,top:-Bx,advance:kl?Oe[1]:Oe[0],localGlyph:!1},Tl=bo?-zs.height*Do:je*Mx-17-Oe[1]*Do,bl=zs.advance;const qe=(kl?Oe[0]:Oe[1])*Do-Mx*je;qe>0&&qe>na&&(na=qe)}else{const F=Oe[xt.fontStack];if(!F)continue;F[yo]&&(hl=F[yo]);const Fe=Le[xt.fontStack];if(!Fe)continue;const qe=Fe.glyphs[yo];if(!qe)continue;if(zs=qe.metrics,bl=8203!==yo?Mx:0,bo){const F=void 0!==Fe.ascender?Math.abs(Fe.ascender):0,Le=void 0!==Fe.descender?Math.abs(Fe.descender):0,Oe=(F+Le)*Do;el<Oe&&(el=Oe,nl=(F-Le)/2*Do),Tl=-F*Do}else Tl=(je-Do)*Mx-17}kl?(F.verticalizable=!0,Zs.push({glyph:yo,image:pl,x:qr,y:Xn+Tl,vertical:kl,scale:Do,localGlyph:zs.localGlyph,fontStack:xt.fontStack,sectionIndex:Yn,metrics:zs,rect:hl}),qr+=bl*Do+Gt):(Zs.push({glyph:yo,image:pl,x:qr,y:Xn+Tl,vertical:kl,scale:Do,localGlyph:zs.localGlyph,fontStack:xt.fontStack,sectionIndex:Yn,metrics:zs,rect:hl}),qr+=zs.advance*Do+Gt)}0!==Zs.length&&(Yn=Math.max(qr-Gt,Yn),bo?Jf(Zs,yo,na,nl,qe*je/2):Jf(Zs,yo,na,0,qe/2)),qr=0;const hl=qe*je+na;zs.lineOffset=Math.max(na,xt),Xn+=hl,++Do}var Ro;const zs=Xn,{horizontalAlign:Zs,verticalAlign:na}=Kf(He);(function(F,Le,Oe,Fe,je,qe){const He=(Le-Oe)*je,xt=-qe*Fe;for(const Le of F)for(const F of Le.positionedGlyphs)F.x+=He,F.y+=xt})(F.positionedLines,yo,Zs,na,Yn,zs),F.top+=-na*zs,F.bottom=F.top+zs,F.left+=-Zs*Yn,F.right=F.left+Yn,F.hasBaseline=bo}(el,Le,Oe,Fe,Do,He,xt,jt,wi,Gt,qr,Yn),!function(F){for(const Le of F)if(0!==Le.positionedGlyphs.length)return!1;return!0}(na))return el}const Vx={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Ux={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Yf(F,Le,Oe,Fe,je,qe){if(Le.image){const F=Fe.get(Le.image.toString());return F?F.displaySize[0]*Le.scale*Mx/qe+je:0}{const Fe=Oe[Le.fontStack],qe=Fe&&Fe.glyphs[F];return qe?qe.metrics.advance*Le.scale+je:0}}function Hf(F,Le,Oe,Fe){const je=Math.pow(F-Le,2);return Fe?F<Le?je/2:2*je:je+Math.abs(Oe)*Oe}function Xf(F,Le,Oe){let Fe=0;return 10===F&&(Fe-=1e4),Oe&&(Fe+=150),40!==F&&65288!==F||(Fe+=50),41!==Le&&65289!==Le||(Fe+=50),Fe}function Zf(F,Le,Oe,Fe,je,qe){let He=null,xt=Hf(Le,Oe,je,qe);for(const F of Fe){const Fe=Hf(Le-F.x,Oe,je,qe)+F.badness;Fe<=xt&&(He=F,xt=Fe)}return{index:F,x:Le,priorBreak:He,badness:xt}}function Wf(F){return F?Wf(F.priorBreak).concat(F.index):[]}function Kf(F){let Le=.5,Oe=.5;switch(F){case"right":case"top-right":case"bottom-right":Le=1;break;case"left":case"top-left":case"bottom-left":Le=0}switch(F){case"bottom":case"bottom-right":case"bottom-left":Oe=1;break;case"top":case"top-right":case"top-left":Oe=0}return{horizontalAlign:Le,verticalAlign:Oe}}function Jf(F,Le,Oe,Fe,je){if(!(Le||Oe||Fe||je))return;const qe=F.length-1,He=F[qe],xt=(He.x+He.metrics.advance*He.scale)*Le;for(let Le=0;Le<=qe;Le++)F[Le].x-=xt,F[Le].y+=Oe+Fe+je}function Qf(F,Le,Oe,Fe){const{horizontalAlign:je,verticalAlign:qe}=Kf(Fe),He=Oe[0]-F.displaySize[0]*je,xt=Oe[1]-F.displaySize[1]*qe;return{imagePrimary:F,imageSecondary:Le,top:xt,bottom:xt+F.displaySize[1],left:He,right:He+F.displaySize[0]}}function td(F,Le,Oe,Fe,je,qe){const He=F.imagePrimary;let xt;if(He.content){const F=He.content,Le=He.pixelRatio||1;xt=[F[0]/Le,F[1]/Le,He.displaySize[0]-F[2]/Le,He.displaySize[1]-F[3]/Le]}const jt=Le.left*qe,Gt=Le.right*qe;let bi,wi,qr,Xn;"width"===Oe||"both"===Oe?(Xn=je[0]+jt-Fe[3],wi=je[0]+Gt+Fe[1]):(Xn=je[0]+(jt+Gt-He.displaySize[0])/2,wi=Xn+He.displaySize[0]);const Yn=Le.top*qe,yo=Le.bottom*qe;return"height"===Oe||"both"===Oe?(bi=je[1]+Yn-Fe[0],qr=je[1]+yo+Fe[2]):(bi=je[1]+(Yn+yo-He.displaySize[1])/2,qr=bi+He.displaySize[1]),{imagePrimary:He,imageSecondary:void 0,top:bi,right:wi,bottom:qr,left:Xn,collisionPadding:xt}}class ed extends ic{constructor(F,Le,Oe,Fe,je){super(F,Le),this.angle=Fe,this.z=Oe,void 0!==je&&(this.segment=je)}clone(){return new ed(this.x,this.y,this.z,this.angle,this.segment)}}function rd(F,Le,Oe,Fe,je){if(void 0===Le.segment)return!0;let qe=Le,He=Le.segment+1,xt=0;for(;xt>-Oe/2;){if(He--,He<0)return!1;xt-=F[He].dist(qe),qe=F[He]}xt+=F[He].dist(F[He+1]),He++;const jt=[];let Gt=0;for(;xt<Oe/2;){const Le=F[He],Oe=F[He+1];if(!Oe)return!1;let qe=F[He-1].angleTo(Le)-Le.angleTo(Oe);for(qe=Math.abs((qe+3*Math.PI)%(2*Math.PI)-Math.PI),jt.push({distance:xt,angleDelta:qe}),Gt+=qe;xt-jt[0].distance>Fe;)Gt-=jt.shift().angleDelta;if(Gt>je)return!1;He++,xt+=Le.dist(Oe)}return!0}function nd(F){let Le=0;for(let Oe=0;Oe<F.length-1;Oe++)Le+=F[Oe].dist(F[Oe+1]);return Le}function id(F,Le,Oe){return F?.6*Le*Oe:0}function sd(F,Le){return Math.max(F?F.right-F.left:0,Le?Le.right-Le.left:0)}function ad(F,Le,Oe,Fe,je,qe){const He=id(Oe,je,qe),xt=sd(Oe,Fe)*qe;let jt=0;const Gt=nd(F)/2;for(let Oe=0;Oe<F.length-1;Oe++){const Fe=F[Oe],je=F[Oe+1],qe=Fe.dist(je);if(jt+qe>Gt){const bi=(Gt-jt)/qe,wi=Ee(Fe.x,je.x,bi),qr=Ee(Fe.y,je.y,bi),Xn=new ed(wi,qr,0,je.angleTo(Fe),Oe);return!He||rd(F,Xn,xt,He,Le)?Xn:void 0}jt+=qe}}function od(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=id(Fe,qe,He),bi=sd(Fe,je),wi=bi*He,qr=0===F[0].x||F[0].x===jt||0===F[0].y||F[0].y===jt;return Le-wi<Le/4&&(Le=wi+Le/4),ld(F,qr?Le/2*xt%Le:(bi/2+2*qe)*He*xt%Le,Le,Gt,Oe,wi,qr,!1,jt)}function ld(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=qe/2,bi=nd(F);let wi=0,qr=Le-Oe,Xn=[];for(let Le=0;Le<F.length-1;Le++){const He=F[Le],xt=F[Le+1],Yn=He.dist(xt),yo=xt.angleTo(He);for(;qr+Oe<wi+Yn;){qr+=Oe;const bo=(qr-wi)/Yn,Do=Ee(He.x,xt.x,bo),Ro=Ee(He.y,xt.y,bo);if(Do>=0&&Do<jt&&Ro>=0&&Ro<jt&&qr-Gt>=0&&qr+Gt<=bi){const Oe=new ed(Do,Ro,0,yo,Le);Fe&&!rd(F,Oe,qe,Fe,je)||Xn.push(Oe)}}wi+=Yn}return xt||Xn.length||He||(Xn=ld(F,wi/2,Oe,Fe,je,qe,He,!0,jt)),Xn}function ud(F,Le,Oe,Fe,je){const qe=[];for(let He=0;He<F.length;He++){const xt=F[He];let jt;for(let F=0;F<xt.length-1;F++){let He=xt[F],Gt=xt[F+1];He.x<Le&&Gt.x<Le||(He.x<Le?He=new ic(Le,He.y+(Le-He.x)/(Gt.x-He.x)*(Gt.y-He.y))._round():Gt.x<Le&&(Gt=new ic(Le,He.y+(Le-He.x)/(Gt.x-He.x)*(Gt.y-He.y))._round()),He.y<Oe&&Gt.y<Oe||(He.y<Oe?He=new ic(He.x+(Oe-He.y)/(Gt.y-He.y)*(Gt.x-He.x),Oe)._round():Gt.y<Oe&&(Gt=new ic(He.x+(Oe-He.y)/(Gt.y-He.y)*(Gt.x-He.x),Oe)._round()),He.x>=Fe&&Gt.x>=Fe||(He.x>=Fe?He=new ic(Fe,He.y+(Fe-He.x)/(Gt.x-He.x)*(Gt.y-He.y))._round():Gt.x>=Fe&&(Gt=new ic(Fe,He.y+(Fe-He.x)/(Gt.x-He.x)*(Gt.y-He.y))._round()),He.y>=je&&Gt.y>=je||(He.y>=je?He=new ic(He.x+(je-He.y)/(Gt.y-He.y)*(Gt.x-He.x),je)._round():Gt.y>=je&&(Gt=new ic(He.x+(je-He.y)/(Gt.y-He.y)*(Gt.x-He.x),je)._round()),jt&&He.equals(jt[jt.length-1])||(jt=[He],qe.push(jt)),jt.push(Gt)))))}}return qe}function cd(F){let Le=0,Oe=0;for(const Fe of F)Le+=Fe.w*Fe.h,Oe=Math.max(Oe,Fe.w);F.sort(((F,Le)=>Le.h-F.h));const Fe=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(Le/.95)),Oe),h:1/0}];let je=0,qe=0;for(const Le of F)for(let F=Fe.length-1;F>=0;F--){const Oe=Fe[F];if(!(Le.w>Oe.w||Le.h>Oe.h)){if(Le.x=Oe.x,Le.y=Oe.y,qe=Math.max(qe,Le.y+Le.h),je=Math.max(je,Le.x+Le.w),Le.w===Oe.w&&Le.h===Oe.h){const Le=Fe.pop();F<Fe.length&&(Fe[F]=Le)}else Le.h===Oe.h?(Oe.x+=Le.w,Oe.w-=Le.w):Le.w===Oe.w?(Oe.y+=Le.h,Oe.h-=Le.h):(Fe.push({x:Oe.x+Le.w,y:Oe.y,w:Oe.w-Le.w,h:Le.h}),Oe.y+=Le.h,Oe.h-=Le.h);break}}return{w:je,h:qe,fill:Le/(je*qe)||0}}us(ed,"Anchor");const Gx=1;class pd{static getImagePositionScale(F,Le,Oe){if(Le&&F&&F.options&&F.options.transform){const Le=F.options.transform;return{x:Le.a,y:Le.d}}return{x:Oe,y:Oe}}constructor(F,Le,Oe,Fe){this.paddedRect=F;const{pixelRatio:je,version:qe,stretchX:He,stretchY:xt,content:jt,sdf:Gt,usvg:bi}=Le;this.pixelRatio=je,this.stretchX=He,this.stretchY=xt,this.content=jt,this.version=qe,this.padding=Oe,this.sdf=Gt,this.scale=pd.getImagePositionScale(Fe,bi,je)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function fd(F,Le,Oe){const Fe=tr.parse(F),je=function(F,Le,Oe=[1,1]){return{x:0,y:0,w:(F.data?F.data.width:F.width*Oe[0])+2*Le,h:(F.data?F.data.height:F.height*Oe[1])+2*Le}}(Le,Oe,[Fe.options.transform.a,Fe.options.transform.d]);return{bin:je,imagePosition:new pd(je,Le,Oe,Fe),imageVariant:Fe}}class dd{constructor(F,Le,Oe){const Fe=new Map,je=new Map;this.haveRenderCallbacks=[];const qe=[];this.addImages(F,Fe,Gx,qe),this.addImages(Le,je,2,qe);const{w:He,h:xt}=cd(qe),jt=new pc({width:He||1,height:xt||1});for(const[Le,je]of F.entries()){const F=Fe.get(Le).paddedRect;pc.copy(je.data,jt,{x:0,y:0},{x:F.x+Gx,y:F.y+Gx},je.data,Oe,je.sdf)}for(const[F,Fe]of Le.entries()){const Le=je.get(F),qe=Le.paddedRect;let He=Le.padding;const xt=qe.x+He,Gt=qe.y+He,bi=Fe.data.width,wi=Fe.data.height;He=He>1?He-1:He,pc.copy(Fe.data,jt,{x:0,y:0},{x:xt,y:Gt},Fe.data,Oe),pc.copy(Fe.data,jt,{x:0,y:wi-He},{x:xt,y:Gt-He},{width:bi,height:He},Oe),pc.copy(Fe.data,jt,{x:0,y:0},{x:xt,y:Gt+wi},{width:bi,height:He},Oe),pc.copy(Fe.data,jt,{x:bi-He,y:0},{x:xt-He,y:Gt},{width:He,height:wi},Oe),pc.copy(Fe.data,jt,{x:0,y:0},{x:xt+bi,y:Gt},{width:He,height:wi},Oe),pc.copy(Fe.data,jt,{x:bi-He,y:wi-He},{x:xt-He,y:Gt-He},{width:He,height:He},Oe),pc.copy(Fe.data,jt,{x:0,y:wi-He},{x:xt+bi,y:Gt-He},{width:He,height:He},Oe),pc.copy(Fe.data,jt,{x:0,y:0},{x:xt+bi,y:Gt+wi},{width:He,height:He},Oe),pc.copy(Fe.data,jt,{x:bi-He,y:0},{x:xt-He,y:Gt+wi},{width:He,height:He},Oe)}this.lut=Oe,this.image=jt,this.iconPositions=Fe,this.patternPositions=je}addImages(F,Le,Oe,Fe){for(const[je,qe]of F.entries()){const{bin:F,imagePosition:He,imageVariant:xt}=fd(je,qe,Oe);Le.set(je,He),Fe.push(F),qe.hasRenderCallback&&this.haveRenderCallbacks.push(xt.id)}}patchUpdatedImages(F,Le,Oe){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((Le=>F.hasImage(Le,Oe))),F.dispatchRenderCallbacks(this.haveRenderCallbacks,Oe);for(const Fe of F.getUpdatedImages(Oe)){for(const je of this.iconPositions.keys()){const qe=tr.parse(je);if(we.isEqual(qe.id,Fe)){const qe=F.getImage(Fe,Oe);this.patchUpdatedImage(this.iconPositions.get(je),qe,Le)}}for(const je of this.patternPositions.keys()){const qe=tr.parse(je);if(we.isEqual(qe.id,Fe)){const qe=F.getImage(Fe,Oe);this.patchUpdatedImage(this.patternPositions.get(je),qe,Le)}}}}patchUpdatedImage(F,Le,Oe){if(!F||!Le)return;if(F.version===Le.version)return;F.version=Le.version;const[Fe,je]=F.tl,qe=F.sdf;if(this.lut||qe){const F={width:Le.data.width,height:Le.data.height},He=new pc(F);pc.copy(Le.data,He,{x:0,y:0},{x:0,y:0},F,this.lut,qe),Oe.update(He,{position:{x:Fe,y:je}})}else Oe.update(Le.data,{position:{x:Fe,y:je}})}}us(pd,"ImagePosition"),us(dd,"ImageAtlas");const Hx=1e20;function yd(F,Le,Oe,Fe,je,qe,He,xt,jt){for(let Gt=Le;Gt<Le+Fe;Gt++)gd(F,Oe*qe+Gt,qe,je,He,xt,jt);for(let Gt=Oe;Gt<Oe+je;Gt++)gd(F,Gt*qe+Le,1,Fe,He,xt,jt)}function gd(F,Le,Oe,Fe,je,qe,He){qe[0]=0,He[0]=-Hx,He[1]=Hx,je[0]=F[Le];for(let xt=1,jt=0,Gt=0;xt<Fe;xt++){je[xt]=F[Le+xt*Oe];const Fe=xt*xt;do{const F=qe[jt];Gt=(je[xt]-je[F]+Fe-F*F)/(xt-F)/2}while(Gt<=He[jt]&&--jt>-1);jt++,qe[jt]=xt,He[jt]=Gt,He[jt+1]=Hx}for(let xt=0,jt=0;xt<Fe;xt++){for(;He[jt+1]<xt;)jt++;const Fe=qe[jt],Gt=xt-Fe;F[Le+xt*Oe]=je[Fe]+Gt*Gt}}const Zx=2,Xx={none:0,ideographs:1,all:2};class bd{constructor(F,Le,Oe){this.requestManager=F,this.localGlyphMode=Le,this.localFontFamily=Oe,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(F,Le){this.urls[Le]=F}getGlyphs(F,Le,Oe){const Fe=[],je=this.urls[Le]||Zc.GLYPHS_URL;for(const Le in F)for(const Oe of F[Le])Fe.push({stack:Le,id:Oe});rt(Fe,(({stack:F,id:Le},Oe)=>{let Fe=this.entries[F];Fe||(Fe=this.entries[F]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let qe=Fe.glyphs[Le];if(void 0!==qe)return void Oe(null,{stack:F,id:Le,glyph:qe});if(qe=this._tinySDF(Fe,F,Le),qe)return Fe.glyphs[Le]=qe,void Oe(null,{stack:F,id:Le,glyph:qe});const He=Math.floor(Le/256);if(256*He>65535)return pt("glyphs > 65535 not supported"),void Oe(null,{stack:F,id:Le,glyph:qe});if(Fe.ranges[He])return void Oe(null,{stack:F,id:Le,glyph:qe});let xt=Fe.requests[He];xt||(xt=Fe.requests[He]=[],bd.loadGlyphRange(F,He,je,this.requestManager,((F,Le)=>{if(Le){Fe.ascender=Le.ascender,Fe.descender=Le.descender;for(const F in Le.glyphs)this._doesCharSupportLocalGlyph(+F)||(Fe.glyphs[+F]=Le.glyphs[+F]);Fe.ranges[He]=!0}for(const Oe of xt)Oe(F,Le);delete Fe.requests[He]}))),xt.push(((Fe,je)=>{Fe?Oe(Fe):je&&Oe(null,{stack:F,id:Le,glyph:je.glyphs[Le]||null})}))}),((F,Le)=>{if(F)Oe(F);else if(Le){const F={};for(const{stack:Oe,id:Fe,glyph:je}of Le)void 0===F[Oe]&&(F[Oe]={}),void 0===F[Oe].glyphs&&(F[Oe].glyphs={}),F[Oe].glyphs[Fe]=je&&{id:je.id,bitmap:je.bitmap.clone(),metrics:je.metrics},F[Oe].ascender=this.entries[Oe].ascender,F[Oe].descender=this.entries[Oe].descender;Oe(null,F)}}))}_doesCharSupportLocalGlyph(F){return this.localGlyphMode!==Xx.none&&(this.localGlyphMode===Xx.all?!!this.localFontFamily:!!this.localFontFamily&&(gf["CJK Unified Ideographs"](F)||gf["Hangul Syllables"](F)||gf.Hiragana(F)||gf.Katakana(F)||gf["CJK Symbols and Punctuation"](F)||gf["CJK Unified Ideographs Extension A"](F)||gf["CJK Unified Ideographs Extension B"](F)||gf.Osage(F)))}_tinySDF(F,Le,Oe){const Fe=this.localFontFamily;if(!Fe||!this._doesCharSupportLocalGlyph(Oe))return;let je=F.tinySDF;if(!je){let Oe="400";/bold/i.test(Le)?Oe="900":/medium/i.test(Le)?Oe="500":/light/i.test(Le)&&(Oe="200"),je=F.tinySDF=new bd.TinySDF({fontFamily:Fe,fontWeight:Oe,fontSize:24*Zx,buffer:3*Zx,radius:8*Zx}),je.fontWeight=Oe}if(this.localGlyphs[je.fontWeight][Oe])return this.localGlyphs[je.fontWeight][Oe];const qe=String.fromCodePoint(Oe),{data:He,width:xt,height:jt,glyphWidth:Gt,glyphHeight:bi,glyphLeft:wi,glyphTop:qr,glyphAdvance:Xn}=je.draw(qe);return this.localGlyphs[je.fontWeight][Oe]={id:Oe,bitmap:new hc({width:xt,height:jt},He),metrics:{width:Gt/Zx,height:bi/Zx,left:wi/Zx,top:qr/Zx-27,advance:Xn/Zx,localGlyph:!0}}}}bd.loadGlyphRange=function(F,Le,Oe,Fe,je){const qe=256*Le,He=qe+255,xt=Fe.transformRequest(Fe.normalizeGlyphsURL(Oe).replace("{fontstack}",F).replace("{range}",`${qe}-${He}`),kh.Glyphs);ne(xt,((F,Le)=>{if(F)je(F);else if(Le){const F={},Oe=function(F){return new kx(F).readFields(Rf,{})}(Le);for(const Le of Oe.glyphs)F[Le.id]=Le;je(null,{glyphs:F,ascender:Oe.ascender,descender:Oe.descender})}}))},bd.TinySDF=class{constructor({fontSize:F=24,buffer:Le=3,radius:Oe=8,cutoff:Fe=.25,fontFamily:je="sans-serif",fontWeight:qe="normal",fontStyle:He="normal"}={}){this.buffer=Le,this.cutoff=Fe,this.radius=Oe;const xt=this.size=F+4*Le,jt=this._createCanvas(xt),Gt=this.ctx=jt.getContext("2d",{willReadFrequently:!0});Gt.font=`${He} ${qe} ${F}px ${je}`,Gt.textBaseline="alphabetic",Gt.textAlign="left",Gt.fillStyle="black",this.gridOuter=new Float64Array(xt*xt),this.gridInner=new Float64Array(xt*xt),this.f=new Float64Array(xt),this.z=new Float64Array(xt+1),this.v=new Uint16Array(xt)}_createCanvas(F){const Le=document.createElement("canvas");return Le.width=Le.height=F,Le}draw(F){const{width:Le,actualBoundingBoxAscent:Oe,actualBoundingBoxDescent:Fe,actualBoundingBoxLeft:je,actualBoundingBoxRight:qe}=this.ctx.measureText(F),He=Math.ceil(Oe),xt=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(qe-je))),jt=Math.min(this.size-this.buffer,He+Math.ceil(Fe)),Gt=xt+2*this.buffer,bi=jt+2*this.buffer,wi=Math.max(Gt*bi,0),qr=new Uint8ClampedArray(wi),Xn={data:qr,width:Gt,height:bi,glyphWidth:xt,glyphHeight:jt,glyphTop:He,glyphLeft:0,glyphAdvance:Le};if(0===xt||0===jt)return Xn;const{ctx:Yn,buffer:yo,gridInner:bo,gridOuter:Do}=this;Yn.clearRect(yo,yo,xt,jt),Yn.fillText(F,yo,yo+He);const Ro=Yn.getImageData(yo,yo,xt,jt);Do.fill(Hx,0,wi),bo.fill(0,0,wi);for(let F=0;F<jt;F++)for(let Le=0;Le<xt;Le++){const Oe=Ro.data[4*(F*xt+Le)+3]/255;if(0===Oe)continue;const Fe=(F+yo)*Gt+Le+yo;if(1===Oe)Do[Fe]=0,bo[Fe]=Hx;else{const F=.5-Oe;Do[Fe]=F>0?F*F:0,bo[Fe]=F<0?F*F:0}}yd(Do,0,0,Gt,bi,Gt,this.f,this.v,this.z),yd(bo,yo,yo,xt,jt,Gt,this.f,this.v,this.z);for(let F=0;F<wi;F++){const Le=Math.sqrt(Do[F])-Math.sqrt(bo[F]);qr[F]=Math.round(255-255*(Le/this.radius+this.cutoff))}return Xn}};const Kx=Gx;function wd(F,Le){return F+Le[1]-Le[0]}function Md(F,Le,Oe,Fe,je=1){const qe=[],He=F.imagePrimary,xt=He.pixelRatio,jt=He.paddedRect.w-2*Kx,Gt=He.paddedRect.h-2*Kx,bi=(F.right-F.left)*je,wi=(F.bottom-F.top)*je,qr=He.stretchX||[[0,jt]],Xn=He.stretchY||[[0,Gt]],Yn=qr.reduce(wd,0),yo=Xn.reduce(wd,0),bo=jt-Yn,Do=Gt-yo;let Ro=0,zs=Yn,Zs=0,na=yo,el=0,nl=bo,hl=0,pl=Do;if(He.content&&Fe){const F=He.content;Ro=Ad(qr,0,F[0]),Zs=Ad(Xn,0,F[1]),zs=Ad(qr,F[0],F[2]),na=Ad(Xn,F[1],F[3]),el=F[0]-Ro,hl=F[1]-Zs,nl=F[2]-F[0]-zs,pl=F[3]-F[1]-na}const S=(Fe,qe,jt,Gt)=>{const qr=Sd(Fe.stretch-Ro,zs,bi,F.left*je),Xn=Pd(Fe.fixed-el,nl,Fe.stretch,Yn),bo=Sd(qe.stretch-Zs,na,wi,F.top*je),Do=Pd(qe.fixed-hl,pl,qe.stretch,yo),bl=Sd(jt.stretch-Ro,zs,bi,F.left*je),Tl=Pd(jt.fixed-el,nl,jt.stretch,Yn),kl=Sd(Gt.stretch-Zs,na,wi,F.top*je),ec=Pd(Gt.fixed-hl,pl,Gt.stretch,yo),tc=new ic(qr,bo),oc=new ic(bl,bo),sc=new ic(bl,kl),ac=new ic(qr,kl),mc=new ic(Xn/xt,Do/xt),gc=new ic(Tl/xt,ec/xt),yc=Le*Math.PI/180;if(yc){const F=Math.sin(yc),Le=Math.cos(yc),Oe=[Le,-F,F,Le];tc._matMult(Oe),oc._matMult(Oe),ac._matMult(Oe),sc._matMult(Oe)}const xc=Fe.stretch+Fe.fixed,Zc=jt.stretch+jt.fixed,Wc=qe.stretch+qe.fixed,Kc=Gt.stretch+Gt.fixed,Jc=F.imageSecondary;return{tl:tc,tr:oc,bl:ac,br:sc,texPrimary:{x:He.paddedRect.x+Kx+xc,y:He.paddedRect.y+Kx+Wc,w:Zc-xc,h:Kc-Wc},texSecondary:Jc?{x:Jc.paddedRect.x+Kx+xc,y:Jc.paddedRect.y+Kx+Wc,w:Zc-xc,h:Kc-Wc}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:mc,pixelOffsetBR:gc,minFontScaleX:nl/xt/bi,minFontScaleY:pl/xt/wi,isSDF:Oe}};if(Fe&&(He.stretchX||He.stretchY)){const F=Id(qr,bo,Yn),Le=Id(Xn,Do,yo);for(let Oe=0;Oe<F.length-1;Oe++){const Fe=F[Oe],je=F[Oe+1];for(let F=0;F<Le.length-1;F++)qe.push(S(Fe,Le[F],je,Le[F+1]))}}else qe.push(S({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:jt+1},{fixed:0,stretch:Gt+1}));return qe}function Ad(F,Le,Oe){let Fe=0;for(const je of F)Fe+=Math.max(Le,Math.min(Oe,je[1]))-Math.max(Le,Math.min(Oe,je[0]));return Fe}function Id(F,Le,Oe){const Fe=[{fixed:-Kx,stretch:0}];for(const[Le,Oe]of F){const F=Fe[Fe.length-1];Fe.push({fixed:Le-F.stretch,stretch:F.stretch}),Fe.push({fixed:Le-F.stretch,stretch:F.stretch+(Oe-Le)})}return Fe.push({fixed:Le+Kx,stretch:Oe}),Fe}function Sd(F,Le,Oe,Fe){return F/Le*Oe+Fe}function Pd(F,Le,Oe,Fe){return F-Le*Oe/Fe}function Ed(F,Le,Oe,Fe){const je=Le+F.positionedLines[Fe].lineOffset;return 0===Fe?Oe+je/2:Oe+(je+(Le+F.positionedLines[Fe-1].lineOffset))/2}function zd(F,Le=1,Oe=!1){let Fe=1/0,je=1/0,qe=-1/0,He=-1/0;const xt=F[0];for(let F=0;F<xt.length;F++){const Le=xt[F];(!F||Le.x<Fe)&&(Fe=Le.x),(!F||Le.y<je)&&(je=Le.y),(!F||Le.x>qe)&&(qe=Le.x),(!F||Le.y>He)&&(He=Le.y)}const jt=Math.min(qe-Fe,He-je);let Gt=jt/2;const bi=new Wr([],kd);if(0===jt)return new ic(Fe,je);for(let Le=Fe;Le<qe;Le+=jt)for(let Oe=je;Oe<He;Oe+=jt)bi.push(new Td(Le+Gt,Oe+Gt,Gt,F));let wi=function(F){let Le=0,Oe=0,Fe=0;const je=F[0];for(let F=0,qe=je.length,He=qe-1;F<qe;He=F++){const qe=je[F],xt=je[He],jt=qe.x*xt.y-xt.x*qe.y;Oe+=(qe.x+xt.x)*jt,Fe+=(qe.y+xt.y)*jt,Le+=3*jt}return new Td(Oe/Le,Fe/Le,0,F)}(F),qr=bi.length;for(;bi.length;){const Fe=bi.pop();(Fe.d>wi.d||!wi.d)&&(wi=Fe,Oe&&console.log("found best %d after %d probes",Math.round(1e4*Fe.d)/1e4,qr)),Fe.max-wi.d<=Le||(Gt=Fe.h/2,bi.push(new Td(Fe.p.x-Gt,Fe.p.y-Gt,Gt,F)),bi.push(new Td(Fe.p.x+Gt,Fe.p.y-Gt,Gt,F)),bi.push(new Td(Fe.p.x-Gt,Fe.p.y+Gt,Gt,F)),bi.push(new Td(Fe.p.x+Gt,Fe.p.y+Gt,Gt,F)),qr+=4)}return Oe&&(console.log(`num probes: ${qr}`),console.log(`best distance: ${wi.d}`)),wi.p}function kd(F,Le){return Le.max-F.max}class Td{constructor(F,Le,Oe,Fe){this.p=new ic(F,Le),this.h=Oe,this.d=function(F,Le){let Oe=!1,Fe=1/0;for(let je=0;je<Le.length;je++){const qe=Le[je];for(let Le=0,je=qe.length,He=je-1;Le<je;He=Le++){const je=qe[Le],xt=qe[He];je.y>F.y!=xt.y>F.y&&F.x<(xt.x-je.x)*(F.y-je.y)/(xt.y-je.y)+je.x&&(Oe=!Oe),Fe=Math.min(Fe,Gl(F,je,xt))}}return(Oe?1:-1)*Math.sqrt(Fe)}(this.p,Fe),this.max=this.d+this.h*Math.SQRT2}}const Jx=Number.POSITIVE_INFINITY,Qx=Math.sqrt(2);function Cd(F,[Le,Oe]){let Fe=0,je=0;if(Oe===Jx){Le<0&&(Le=0);const Oe=Le/Qx;switch(F){case"top-right":case"top-left":je=Oe-7;break;case"bottom-right":case"bottom-left":je=7-Oe;break;case"bottom":je=7-Le;break;case"top":je=Le-7}switch(F){case"top-right":case"bottom-right":Fe=-Oe;break;case"top-left":case"bottom-left":Fe=Oe;break;case"left":Fe=Le;break;case"right":Fe=-Le}}else{switch(Le=Math.abs(Le),Oe=Math.abs(Oe),F){case"top-right":case"top-left":case"top":je=Oe-7;break;case"bottom-right":case"bottom-left":case"bottom":je=7-Oe}switch(F){case"top-right":case"bottom-right":case"right":Fe=-Le;break;case"top-left":case"bottom-left":case"left":Fe=Le}}return[Fe,je]}function Dd(F,Le,Oe,Fe,je,qe,He,xt){if(!F)return;const jt=vf(Le,Oe,Fe,je,qe);return F.scaleSelf(jt*xt*He)}function Rd(F,Le,Oe,Fe,je,qe,He,xt){return{iconPrimary:Dd(F.getPrimary(),Le,Oe,Fe,je,qe,He,xt),iconSecondary:Dd(F.getSecondary(),Le,Oe,Fe,je,qe,He,xt)}}function Ld(F,Le,Oe,Fe){if(!F)return;const je=Le.get(Oe.toString());if(F.imagePrimary=je,Fe){const Oe=Le.get(Fe.toString());F.imageSecondary=Oe}}function Fd(F,Le){for(const Oe in F.horizontal)Od(F.horizontal[Oe],Le);Od(F.vertical,Le)}function Od(F,Le){if(F)for(const Oe of F.positionedLines)for(const F of Oe.positionedGlyphs)if(null!==F.image){const Oe=F.image.toString();F.rect=Le.get(Oe).paddedRect}}function Nd(F){switch(F){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Ud(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=Yd(qe.horizontal)||qe.vertical,bi=Oe.get("icon-text-fit-padding").evaluate(Fe,{},je);let wi,qr=Le;return Le&&"none"!==jt&&(F.allowVerticalPlacement&&qe.vertical&&(wi=td(Le,qe.vertical,jt,bi,xt,He)),Gt&&(qr=td(Le,Gt,jt,bi,xt,He))),{defaultShapedIcon:qr,verticallyShapedIcon:wi}}function jd(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs){let Zs=He.textMaxSize.evaluate(Le,{},qr);void 0===Zs?Zs=xt*He.textScaleFactor:Zs*=He.textScaleFactor;const na=F.layers[0].layout,el=Yd(Oe.horizontal)||Oe.vertical,nl="globe"===Xn.name,hl=Mx,pl=F.tilePixelRatio*Zs/hl,bl=(oc=F.overscaling,F.zoom>18&&oc>2&&(oc>>=1),Math.max(sp/(512*oc),1)*na.get("symbol-spacing")),Tl=na.get("text-padding")*F.tilePixelRatio,kl=na.get("icon-padding")*F.tilePixelRatio,ec=H(na.get("text-max-angle")),tc="map"===na.get("icon-rotation-alignment")&&"point"!==zs,ic=bl/2;var oc;!1===F.hasAnyIconTextFit&&"none"!==bo&&(F.hasAnyIconTextFit=!0);const sc=Le.properties?+Le.properties[B_]:null,ac=sc&&F.elevationFeatureIdToIndex?F.elevationFeatureIdToIndex.get(sc):65535,D=(xt,jt,zs)=>{if(jt.x<0||jt.x>=sp||jt.y<0||jt.y>=sp)return;let Zs=null;if(nl){const{x:F,y:Le,z:Oe}=Xn.projectTilePoint(jt.x,jt.y,zs);Zs={anchor:new ed(F,Le,Oe,0,void 0),up:Xn.upVector(zs,jt.x,jt.y)}}!function(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na,el,nl,hl,pl,bl,Tl,kl){const ec=F.addToLineVertexArray(Le,Fe);let tc,ic,oc,sc,ac,mc,gc,yc=0,xc=0,Zc=0,Wc=0,Kc=-1,Jc=-1;const Qc={};let eh=pu("");const th=Oe?Oe.anchor:Le,rh="none"!==Tl;let oh=0,ah=0;if(void 0===jt._unevaluatedLayout.getValue("text-radial-offset")?[oh,ah]=jt.layout.get("text-offset").evaluate(Zs,{},hl).map((F=>F*Mx)):(oh=jt.layout.get("text-radial-offset").evaluate(Zs,{},hl)*Mx,ah=Jx),F.allowVerticalPlacement&&je.vertical){const F=je.vertical;if(Yn)mc=Xd(F),xt&&(gc=Xd(xt));else{const Oe=jt.layout.get("text-rotate").evaluate(Zs,{},hl)+90;oc=Hd(Gt,th,Le,bi,wi,qr,F,Xn,Oe,yo),xt&&(sc=Hd(Gt,th,Le,bi,wi,qr,xt,Do,Oe))}}if(qe){const Fe=F.iconSizeData,je=jt.layout.get("icon-rotate").evaluate(Zs,{},hl),He=Md(qe,je,el,rh,na.iconScaleFactor),Xn=xt?Md(xt,je,el,rh,na.iconScaleFactor):void 0;ic=Hd(Gt,th,Le,bi,wi,qr,qe,Do,je,null),yc=4*He.length;let Yn=null;"source"===Fe.kind?(Yn=[Ax*jt.layout.get("icon-size").evaluate(Zs,{},hl)*na.iconScaleFactor],Yn[0]>iv&&pt(`${F.layerIds[0]}: Value for "icon-size" is >= ${tv}. Reduce your "icon-size".`)):"composite"===Fe.kind&&(Yn=[Ax*na.compositeIconSizes[0].evaluate(Zs,{},hl)*na.iconScaleFactor,Ax*na.compositeIconSizes[1].evaluate(Zs,{},hl)*na.iconScaleFactor],(Yn[0]>iv||Yn[1]>iv)&&pt(`${F.layerIds[0]}: Value for "icon-size" is >= ${tv}. Reduce your "icon-size".`)),F.addSymbols(F.icon,He,Yn,zs,Ro,Zs,!1,Oe,Le,ec.lineStartIndex,ec.lineLength,-1,nl,hl,pl,bl),Kc=F.icon.placedSymbolArray.length-1,Xn&&(xc=4*Xn.length,F.addSymbols(F.icon,Xn,Yn,zs,Ro,Zs,Nx.vertical,Oe,Le,ec.lineStartIndex,ec.lineLength,-1,nl,hl,pl,bl),Jc=F.icon.placedSymbolArray.length-1)}for(const Fe in je.horizontal){const qe=je.horizontal[Fe];tc||(eh=pu(qe.text),Yn?ac=Xd(qe):tc=Hd(Gt,th,Le,bi,wi,qr,qe,Xn,jt.layout.get("text-rotate").evaluate(Zs,{},hl),yo));const xt=1===qe.positionedLines.length;if(Zc+=Gd(F,Oe,Le,qe,He,jt,Yn,Zs,yo,ec,je.vertical?Nx.horizontal:Nx.horizontalOnly,xt?Object.keys(je.horizontal):[Fe],Qc,Kc,na,nl,hl,pl),xt)break}je.vertical&&(Wc+=Gd(F,Oe,Le,je.vertical,He,jt,Yn,Zs,yo,ec,Nx.vertical,["vertical"],Qc,Jc,na,nl,hl,pl));let lh=-1;const W=(F,Le)=>F?Math.max(F,Le):Le;lh=W(ac,lh),lh=W(mc,lh),lh=W(gc,lh);const hh=lh>-1?1:0;F.glyphOffsetArray.length>=65535&&pt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Zs.sortKey&&F.addToSortKeyRanges(F.symbolInstances.length,Zs.sortKey),F.symbolInstances.emplaceBack(Le.x,Le.y,th.x,th.y,th.z,Qc.right>=0?Qc.right:-1,Qc.center>=0?Qc.center:-1,Qc.left>=0?Qc.left:-1,Qc.vertical>=0?Qc.vertical:-1,Kc,Jc,eh,void 0!==tc?tc:F.collisionBoxArray.length,void 0!==tc?tc+1:F.collisionBoxArray.length,void 0!==oc?oc:F.collisionBoxArray.length,void 0!==oc?oc+1:F.collisionBoxArray.length,void 0!==ic?ic:F.collisionBoxArray.length,void 0!==ic?ic+1:F.collisionBoxArray.length,sc||F.collisionBoxArray.length,sc?sc+1:F.collisionBoxArray.length,bi,Zc,Wc,yc,xc,hh,0,oh,ah,lh,0,rh?1:0,kl)}(F,jt,Zs,xt,Oe,Fe,qe,je,F.layers[0],F.collisionBoxArray,Le.index,Le.sourceLayerIndex,F.index,Tl,Ro,Gt,0,kl,tc,Do,Le,He,bi,wi,qr,Yn,yo,bo,ac)};if("line"===zs)for(const je of ud(Le.geometry,0,0,sp,sp)){const Le=od(je,bl,ec,Oe.vertical||el,Fe,hl,pl,F.overscaling,sp);for(const Oe of Le)el&&Zd(F,el.text,ic,Oe)||D(je,Oe,qr)}else if("line-center"===zs){for(const F of Le.geometry)if(F.length>1){const Le=ad(F,ec,Oe.vertical||el,Fe,hl,pl);Le&&D(F,Le,qr)}}else if("Polygon"===Le.type)for(const F of $c(Le.geometry,0)){const Le=zd(F,16);D(F[0],new ed(Le.x,Le.y,0,0,void 0),qr)}else if("LineString"===Le.type)for(const F of Le.geometry)D(F,new ed(F[0].x,F[0].y,0,0,void 0),qr);else if("Point"===Le.type)for(const F of Le.geometry)for(const Le of F)D([Le],new ed(Le.x,Le.y,0,0,void 0),qr)}const tv=255,iv=tv*Ax;function Gd(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do){const Ro=function(F,Le,Oe,Fe,je,qe,He,xt){const jt=[];if(0===Le.positionedLines.length)return jt;const Gt=Fe.layout.get("text-rotate").evaluate(qe,{})*Math.PI/180,bi=function(F){const Le=F[0],Oe=F[1],Fe=Le*Oe;return Fe>0?[Le,-Oe]:Fe<0?[-Le,Oe]:0===Le?[Oe,Le]:[Oe,-Le]}(Oe);let wi=Math.abs(Le.top-Le.bottom);for(const F of Le.positionedLines)wi-=F.lineOffset;const qr=Le.positionedLines.length,Xn=wi/qr;let Yn=Le.top-Oe[1];for(let F=0;F<qr;++F){const Fe=Le.positionedLines[F];Yn=Ed(Le,Xn,Yn,F);for(const F of Fe.positionedGlyphs){if(!F.rect)continue;const Fe=F.rect||{};let qe=Bx+1,wi=!0,qr=1,Xn=0;if(F.image){const Le=He.get(F.image.toString());if(!Le)continue;if(Le.sdf){pt("SDF images are not supported in formatted text and will be ignored.");continue}wi=!1,qr=Le.pixelRatio,qe=Gx/qr}const yo=(je||xt)&&F.vertical,bo=F.metrics.advance*F.scale/2,Do=F.metrics,Ro=F.rect;if(null===Ro)continue;xt&&Le.verticalizable&&(Xn=F.image?bo-F.metrics.width*F.scale/2:0);const zs=je?[F.x+bo,F.y]:[0,0];let Zs=[0,0],na=[0,0],el=!1;je||(yo?(na=[F.x+bo+bi[0],F.y+bi[1]-Xn],el=!0):Zs=[F.x+bo+Oe[0],F.y+Oe[1]-Xn]);const nl=Ro.w*F.scale/(qr*(F.localGlyph?Zx:1)),hl=Ro.h*F.scale/(qr*(F.localGlyph?Zx:1));let pl,bl,Tl,kl;if(yo){const Le=F.y-Yn,Oe=new ic(-bo,bo-Le),Fe=-Math.PI/2,je=new ic(...na);pl=new ic(-bo+Zs[0],Zs[1]),pl._rotateAround(Fe,Oe)._add(je),pl.x+=-Le+bo,pl.y-=(Do.left-qe)*F.scale;const He=F.image?Do.advance*F.scale:Mx*F.scale,xt=String.fromCodePoint(F.glyph);Sf(xt)?pl.x+=(1-qe)*F.scale:Pf(xt)?pl.x+=He-Do.height*F.scale+(-qe-1)*F.scale:pl.x+=F.image||Do.width+2*qe===Ro.w&&Do.height+2*qe===Ro.h?(He-hl)/2:(He-(Do.height+2*qe)*F.scale)/2,bl=new ic(pl.x,pl.y-nl),Tl=new ic(pl.x+hl,pl.y),kl=new ic(pl.x+hl,pl.y-nl)}else{const Le=(Do.left-qe)*F.scale-bo+Zs[0],Oe=(-Do.top-qe)*F.scale+Zs[1],Fe=Le+nl,je=Oe+hl;pl=new ic(Le,Oe),bl=new ic(Fe,Oe),Tl=new ic(Le,je),kl=new ic(Fe,je)}if(Gt){let F;F=je?new ic(0,0):el?new ic(bi[0],bi[1]):new ic(Oe[0],Oe[1]),pl._rotateAround(Gt,F),bl._rotateAround(Gt,F),Tl._rotateAround(Gt,F),kl._rotateAround(Gt,F)}const ec=new ic(0,0),tc=new ic(0,0);jt.push({tl:pl,tr:bl,bl:Tl,br:kl,texPrimary:Fe,texSecondary:void 0,writingMode:Le.writingMode,glyphOffset:zs,sectionIndex:F.sectionIndex,isSDF:wi,pixelOffsetTL:ec,pixelOffsetBR:tc,minFontScaleX:0,minFontScaleY:0})}}return jt}(0,Fe,jt,qe,He,xt,je,F.allowVerticalPlacement),zs=F.textSizeData;let Zs=null;"source"===zs.kind?(Zs=[Ax*qe.layout.get("text-size").evaluate(xt,{},bo)*Yn.textScaleFactor],Zs[0]>iv&&pt(`${F.layerIds[0]}: Value for "text-size" is >= ${tv}. Reduce your "text-size".`)):"composite"===zs.kind&&(Zs=[Ax*Yn.compositeTextSizes[0].evaluate(xt,{},bo)*Yn.textScaleFactor,Ax*Yn.compositeTextSizes[1].evaluate(xt,{},bo)*Yn.textScaleFactor],(Zs[0]>iv||Zs[1]>iv)&&pt(`${F.layerIds[0]}: Value for "text-size" is >= ${tv}. Reduce your "text-size".`)),F.addSymbols(F.text,Ro,Zs,jt,He,xt,bi,Le,Oe,Gt.lineStartIndex,Gt.lineLength,Xn,yo,bo,Do,!1);for(const Le of wi)qr[Le]=F.text.placedSymbolArray.length-1;return 4*Ro.length}function Yd(F){for(const Le in F)return F[Le];return null}function Hd(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt){let bi=He.top,wi=He.bottom,qr=He.left,Xn=He.right;const Yn=He.collisionPadding;if(Yn&&(qr-=Yn[0],bi-=Yn[1],Xn+=Yn[2],wi+=Yn[3]),jt){const F=new ic(qr,bi),Le=new ic(Xn,bi),Oe=new ic(qr,wi),Fe=new ic(Xn,wi),je=H(jt);let qe=new ic(0,0);Gt&&(qe=new ic(Gt[0],Gt[1])),F._rotateAround(je,qe),Le._rotateAround(je,qe),Oe._rotateAround(je,qe),Fe._rotateAround(je,qe),qr=Math.min(F.x,Le.x,Oe.x,Fe.x),Xn=Math.max(F.x,Le.x,Oe.x,Fe.x),bi=Math.min(F.y,Le.y,Oe.y,Fe.y),wi=Math.max(F.y,Le.y,Oe.y,Fe.y)}return F.emplaceBack(Le.x,Le.y,Le.z,Oe.x,Oe.y,qr,bi,Xn,wi,xt,Fe,je,qe),F.length-1}function Xd(F){F.collisionPadding&&(F.top-=F.collisionPadding[1],F.bottom+=F.collisionPadding[3]);const Le=F.bottom-F.top;return Le>0?Math.max(10,Le):null}function Zd(F,Le,Oe,Fe){const je=F.compareText;if(Le in je){const F=je[Le];for(let Le=F.length-1;Le>=0;Le--)if(Fe.dist(F[Le])<Oe)return!0}else je[Le]=[];return je[Le].push(Fe),!1}function Wd(F,Le){const Oe=F.fovAboveCenter,Fe=F.elevation?F.elevation.getMinElevationBelowMSL()*Le:0,je=(F._camera.position[2]*F.worldSize-Fe)/Math.cos(F._pitch),qe=Math.sin(Oe)*je/Math.sin(Math.max(Math.PI/2-F._pitch-Oe,.01));let He=Math.sin(F._pitch)*qe+je;const xt=je*(1/F._horizonShift);if(!F.elevation||0===F.elevation.exaggeration()){let Le=Math.max(F.zoom-17,0);F.isOrthographic&&(Le/=10),He*=1+Le}return Math.min(1.01*He,xt)}function Kd(F,Le){if(!Le.isReprojectedInTileSpace)return{scale:1<<F.z,x:F.x,y:F.y,x2:F.x+1,y2:F.y+1,projection:Le};const Oe=Math.pow(2,-F.z),Fe=F.x*Oe,je=(F.x+1)*Oe,qe=F.y*Oe,He=(F.y+1)*Oe,xt=gl(Fe),jt=gl(je),Gt=xl(qe),bi=xl(He),wi=Le.project(xt,Gt),qr=Le.project(jt,Gt),Xn=Le.project(jt,bi),Yn=Le.project(xt,bi);let yo=Math.min(wi.x,qr.x,Xn.x,Yn.x),bo=Math.min(wi.y,qr.y,Xn.y,Yn.y),Do=Math.max(wi.x,qr.x,Xn.x,Yn.x),Ro=Math.max(wi.y,qr.y,Xn.y,Yn.y);const zs=Oe/16;function b(F,Oe,Fe,je,qe,He){const xt=(Fe+qe)/2,jt=(je+He)/2,Gt=Le.project(gl(xt),xl(jt)),bi=Math.max(0,yo-Gt.x,bo-Gt.y,Gt.x-Do,Gt.y-Ro);yo=Math.min(yo,Gt.x),Do=Math.max(Do,Gt.x),bo=Math.min(bo,Gt.y),Ro=Math.max(Ro,Gt.y),bi>zs&&(b(F,Gt,Fe,je,xt,jt),b(Gt,Oe,xt,jt,qe,He))}b(wi,qr,Fe,qe,je,qe),b(qr,Xn,je,qe,je,He),b(Xn,Yn,je,He,Fe,He),b(Yn,wi,Fe,He,Fe,qe),yo-=zs,bo-=zs,Do+=zs,Ro+=zs;const Zs=1/Math.max(Do-yo,Ro-bo);return{scale:Zs,x:yo*Zs,y:bo*Zs,x2:Do*Zs,y2:Ro*Zs,projection:Le}}function Jd(F,{x:Le,y:Oe},Fe=0){return new ic(((Le-Fe)*F.scale-F.x)*sp,(Oe*F.scale-F.y)*sp)}const ov=kl.mat4.identity(new Float32Array(16));class tm{constructor(F){this.spec=F,this.name=F.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(F,Le){return{x:0,y:0,z:0}}unproject(F,Le){return new ul(0,0)}projectTilePoint(F,Le,Oe){return{x:F,y:Le,z:0}}locationPoint(F,Le,Oe,Fe=!0){return F._coordinatePoint(F.locationCoordinate(Le,Oe),Fe)}pixelsPerMeter(F,Le){return yl(1,F)*Le}pixelSpaceConversion(F,Le,Oe){return 1}farthestPixelDistance(F){return Wd(F,F.pixelsPerMeter)}pointCoordinate(F,Le,Oe,Fe){const je=F.horizonLineFromTop(!1),qe=new ic(Le,Math.max(je,Oe));return F.rayIntersectionCoordinate(F.pointRayIntersection(qe,Fe))}pointCoordinate3D(F,Le,Oe){const Fe=new ic(Le,Oe);if(F.elevation)return F.elevation.pointCoordinate(Fe);{const Le=this.pointCoordinate(F,Fe.x,Fe.y,0);return[Le.x,Le.y,Le.z]}}isPointAboveHorizon(F,Le){if(F.elevation&&F.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(F,Le.x,Le.y);const Oe=F.horizonLineFromTop();return Le.y<Oe}createInversionMatrix(F,Le){return ov}createTileMatrix(F,Le,Oe){let Fe,je,qe;const He=Oe.canonical,xt=kl.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const jt=Kd(He,this);Fe=1,je=jt.x+Oe.wrap*jt.scale,qe=jt.y,kl.mat4.scale(xt,xt,[Fe/jt.scale,Fe/jt.scale,F.pixelsPerMeter/Le])}else Fe=Le/F.zoomScale(He.z),je=(He.x+Math.pow(2,He.z)*Oe.wrap)*Fe,qe=He.y*Fe;return kl.mat4.translate(xt,xt,[je,qe,0]),kl.mat4.scale(xt,xt,[Fe/sp,Fe/sp,1]),xt}upVector(F,Le,Oe){return[0,0,1]}upVectorScale(F,Le,Oe){return{metersToTile:1}}}class em extends tm{constructor(F){super(F),this.range=[4,7],this.center=F.center||[-96,37.5];const[Le,Oe]=this.parallels=F.parallels||[29.5,45.5],Fe=Math.sin(H(Le));this.n=(Fe+Math.sin(H(Oe)))/2,this.c=1+Fe*(2*this.n-Fe),this.r0=Math.sqrt(this.c)/this.n}project(F,Le){const{n:Oe,c:Fe,r0:je}=this,qe=H(F-this.center[0]),He=H(Le),xt=Math.sqrt(Fe-2*Oe*Math.sin(He))/Oe;return{x:xt*Math.sin(qe*Oe),y:xt*Math.cos(qe*Oe)-je,z:0}}unproject(F,Le){const{n:Oe,c:Fe,r0:je}=this,qe=je+Le;let He=Math.atan2(F,Math.abs(qe))*Math.sign(qe);qe*Oe<0&&(He-=Math.PI*Math.sign(F)*Math.sign(qe));const xt=H(this.center[0])*Oe;He=et(He,-Math.PI-xt,Math.PI-xt);const jt=Q(X(He/Oe)+this.center[0],-180,180),Gt=Math.asin(Q((Fe-(F*F+qe*qe)*Oe*Oe)/(2*Oe),-1,1)),bi=Q(X(Gt),-e_,e_);return new ul(jt,bi)}}const sv=1.340264,av=-.081106,lv=893e-6,uv=.003796,dv=Math.sqrt(3)/2;class om extends tm{project(F,Le){Le=Le/180*Math.PI,F=F/180*Math.PI;const Oe=Math.asin(dv*Math.sin(Le)),Fe=Oe*Oe,je=Fe*Fe*Fe;return{x:.5*(F*Math.cos(Oe)/(dv*(sv+3*av*Fe+je*(7*lv+9*uv*Fe)))/Math.PI+.5),y:1-.5*(Oe*(sv+av*Fe+je*(lv+uv*Fe))/Math.PI+1),z:0}}unproject(F,Le){F=(2*F-.5)*Math.PI;let Oe=Le=(2*(1-Le)-1)*Math.PI,Fe=Oe*Oe,je=Fe*Fe*Fe;for(let F,qe,He,xt=0;xt<12&&(qe=Oe*(sv+av*Fe+je*(lv+uv*Fe))-Le,He=sv+3*av*Fe+je*(7*lv+9*uv*Fe),F=qe/He,Oe=Q(Oe-F,-Math.PI/3,Math.PI/3),Fe=Oe*Oe,je=Fe*Fe*Fe,!(Math.abs(F)<1e-12));++xt);const qe=dv*F*(sv+3*av*Fe+je*(7*lv+9*uv*Fe))/Math.cos(Oe),He=Math.asin(Math.sin(Oe)/dv),xt=Q(180*qe/Math.PI,-180,180),jt=Q(180*He/Math.PI,-e_,e_);return new ul(xt,jt)}}class lm extends tm{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0}project(F,Le){return{x:.5+F/360,y:.5-Le/360,z:0}}unproject(F,Le){const Oe=360*(F-.5),Fe=Q(360*(.5-Le),-e_,e_);return new ul(Oe,Fe)}}const pv=Math.PI/2;function cm(F){return Math.tan((pv+F)/2)}class hm extends tm{constructor(F){super(F),this.center=F.center||[0,30];const[Le,Oe]=this.parallels=F.parallels||[30,30];let Fe=H(Le),je=H(Oe);this.southernCenter=Fe+je<0,this.southernCenter&&(Fe=-Fe,je=-je);const qe=Math.cos(Fe),He=cm(Fe);this.n=Fe===je?Math.sin(Fe):Math.log(qe/Math.cos(je))/Math.log(cm(je)/He),this.f=qe*Math.pow(cm(Fe),this.n)/this.n}project(F,Le){Le=H(Le),this.southernCenter&&(Le=-Le),F=H(F-this.center[0]);const Oe=1e-6,{n:Fe,f:je}=this;je>0?Le<-pv+Oe&&(Le=-pv+Oe):Le>pv-Oe&&(Le=pv-Oe);const qe=je/Math.pow(cm(Le),Fe);let He=qe*Math.sin(Fe*F),xt=je-qe*Math.cos(Fe*F);return He=.5*(He/Math.PI+.5),xt=.5*(xt/Math.PI+.5),{x:He,y:this.southernCenter?xt:1-xt,z:0}}unproject(F,Le){F=(2*F-.5)*Math.PI,this.southernCenter&&(Le=1-Le),Le=(2*(1-Le)-.5)*Math.PI;const{n:Oe,f:Fe}=this,je=Fe-Le,qe=Math.sign(je),He=Math.sign(Oe)*Math.sqrt(F*F+je*je);let xt=Math.atan2(F,Math.abs(je))*qe;je*Oe<0&&(xt-=Math.PI*Math.sign(F)*qe);const jt=Q(X(xt/Oe)+this.center[0],-180,180),Gt=Q(X(2*Math.atan(Math.pow(Fe/He,1/Oe))-pv),-e_,e_);return new ul(jt,this.southernCenter?-Gt:Gt)}}class pm extends tm{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(F,Le){return{x:dl(F),y:ml(Le),z:0}}unproject(F,Le){const Oe=gl(F),Fe=xl(Le);return new ul(Oe,Fe)}}const fv=H(e_);class dm extends tm{project(F,Le){const Oe=(Le=H(Le))*Le,Fe=Oe*Oe;return{x:.5*((F=H(F))*(.8707-.131979*Oe+Fe*(Fe*(.003971*Oe-.001529*Fe)-.013791))/Math.PI+.5),y:1-.5*(Le*(1.007226+Oe*(.015085+Fe*(.028874*Oe-.044475-.005916*Fe)))/Math.PI+1),z:0}}unproject(F,Le){F=(2*F-.5)*Math.PI;let Oe=Le=(2*(1-Le)-1)*Math.PI,Fe=25,je=0,qe=Oe*Oe;do{qe=Oe*Oe;const F=qe*qe;je=(Oe*(1.007226+qe*(.015085+F*(.028874*qe-.044475-.005916*F)))-Le)/(1.007226+qe*(.045255+F*(.259866*qe-.311325-.005916*11*F))),Oe=Q(Oe-je,-fv,fv)}while(Math.abs(je)>1e-6&&--Fe>0);qe=Oe*Oe;const He=Q(X(F/(.8707+qe*(qe*(qe*qe*qe*(.003971-.001529*qe)-.013791)-.131979))),-180,180),xt=X(Oe);return new ul(He,xt)}}const _v=H(e_);class ym extends tm{project(F,Le){Le=H(Le),F=H(F);const Oe=Math.cos(Le),Fe=2/Math.PI,je=Math.acos(Oe*Math.cos(F/2)),qe=Math.sin(je)/je,He=.5*(F*Fe+2*Oe*Math.sin(F/2)/qe)||0,xt=.5*(Le+Math.sin(Le)/qe)||0;return{x:.5*(He/Math.PI+.5),y:1-.5*(xt/Math.PI+1),z:0}}unproject(F,Le){let Oe=F=(2*F-.5)*Math.PI,Fe=Le=(2*(1-Le)-1)*Math.PI,je=25;const qe=1e-6;let He=0,xt=0;do{const je=Math.cos(Fe),qe=Math.sin(Fe),jt=2*qe*je,Gt=qe*qe,bi=je*je,wi=Math.cos(Oe/2),qr=Math.sin(Oe/2),Xn=2*wi*qr,Yn=qr*qr,yo=1-bi*wi*wi,bo=yo?1/yo:0,Do=yo?Math.acos(je*wi)*Math.sqrt(1/yo):0,Ro=.5*(2*Do*je*qr+2*Oe/Math.PI)-F,zs=.5*(Do*qe+Fe)-Le,Zs=.5*bo*(bi*Yn+Do*je*wi*Gt)+1/Math.PI,na=bo*(Xn*jt/4-Do*qe*qr),el=.125*bo*(jt*qr-Do*qe*bi*Xn),nl=.5*bo*(Gt*wi+Do*Yn*je)+.5,hl=na*el-nl*Zs;He=(zs*na-Ro*nl)/hl,xt=(Ro*el-zs*Zs)/hl,Oe=Q(Oe-He,-Math.PI,Math.PI),Fe=Q(Fe-xt,-_v,_v)}while((Math.abs(He)>qe||Math.abs(xt)>qe)&&--je>0);return new ul(X(Oe),X(Fe))}}class gm extends tm{constructor(F){super(F),this.center=F.center||[0,0],this.parallels=F.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(H(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(F,Le){const{scale:Oe,cosPhi:Fe}=this;return{x:H(F)*Fe*Oe+.5,y:-Math.sin(H(Le))/Fe*Oe+.5,z:0}}unproject(F,Le){const{scale:Oe,cosPhi:Fe}=this,je=-(Le-.5)/Oe,qe=Q(X((F-.5)/Oe)/Fe,-180,180),He=Math.asin(Q(je*Fe,-1,1)),xt=Q(X(He),-e_,e_);return new ul(qe,xt)}}class xm extends pm{constructor(F){super(F),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(F,Le,Oe){const Fe=Ru(F,Le,Oe),je=Ou(ku(Oe));return kl.vec3.transformMat4(Fe,Fe,je),{x:Fe[0],y:Fe[1],z:Fe[2]}}locationPoint(F,Le,Oe){const Fe=al(Le.lat,Le.lng),je=kl.vec3.normalize([],Fe),qe=Oe?F._centerAltitude+Oe:F.elevation?F.elevation.getAtPointOrZero(F.locationCoordinate(Le),F._centerAltitude):F._centerAltitude,He=yl(1,0)*sp*qe;kl.vec3.scaleAndAdd(Fe,Fe,je,He);const xt=kl.mat4.identity(new Float64Array(16));return kl.mat4.multiply(xt,F.pixelMatrix,F.globeMatrix),kl.vec3.transformMat4(Fe,Fe,xt),new ic(Fe[0],Fe[1])}pixelsPerMeter(F,Le){return yl(1,0)*Le}pixelSpaceConversion(F,Le,Oe){const Fe=yl(1,F)*Le,je=Ee(yl(1,45)*Le,Fe,Oe);return this.pixelsPerMeter(F,Le)/je}createTileMatrix(F,Le,Oe){const Fe=Nu(ku(Oe.canonical));return kl.mat4.multiply(new Float64Array(16),F.globeMatrix,Fe)}createInversionMatrix(F,Le){const{center:Oe}=F,Fe=Ou(ku(Le));return kl.mat4.rotateY(Fe,Fe,H(Oe.lng)),kl.mat4.rotateX(Fe,Fe,H(Oe.lat)),kl.mat4.scale(Fe,Fe,[F._pixelsPerMercatorPixel,F._pixelsPerMercatorPixel,1]),Float32Array.from(Fe)}pointCoordinate(F,Le,Oe,Fe){return Pu(F,Le,Oe,!0)||new Il(0,0)}pointCoordinate3D(F,Le,Oe){const Fe=this.pointCoordinate(F,Le,Oe,0);return[Fe.x,Fe.y,Fe.z]}isPointAboveHorizon(F,Le){return!Pu(F,Le.x,Le.y,!1)}farthestPixelDistance(F){const Le=function(F,Le){const Oe=F.cameraToCenterDistance,Fe=F._centerAltitude*Le,je=F._camera,qe=F._camera.forward(),He=kl.vec3.add([],kl.vec3.scale([],qe,-Oe),[0,0,Fe]),xt=F.worldSize/(2*Math.PI),jt=[0,0,-xt],Gt=F.width/F.height,bi=Math.tan(F.fovAboveCenter),wi=kl.vec3.scale([],je.up(),bi),qr=kl.vec3.scale([],je.right(),bi*Gt),Xn=kl.vec3.normalize([],kl.vec3.add([],kl.vec3.add([],qe,wi),qr)),Yn=[];let yo;if(new gu(He,Xn).closestPointOnSphere(jt,xt,Yn)){const Le=kl.vec3.add([],Yn,jt),Oe=kl.vec3.sub([],Le,He);yo=Math.cos(F.fovAboveCenter)*kl.vec3.length(Oe)}else{const F=kl.vec3.sub([],He,jt),Le=kl.vec3.sub([],jt,He);kl.vec3.normalize(Le,Le);const Oe=kl.vec3.length(F)-xt;yo=Math.sqrt(Oe*(Oe+2*xt));const Fe=Math.acos(yo/(xt+Oe))-Math.acos(kl.vec3.dot(qe,Le));yo*=Math.cos(Fe)}return 1.01*yo}(F,this.pixelsPerMeter(F.center.lat,F.worldSize)),Oe=$u(F.zoom);if(Oe>0){const Fe=Wd(F,yl(1,F.center.lat)*F.worldSize),je=F.worldSize/(2*Math.PI),qe=Math.max(F.width,F.height)/F.worldSize*Math.PI;return Ee(Le,Fe+je*(1-Math.cos(qe)),Math.pow(Oe,10))}return Le}upVector(F,Le,Oe){return Ru(Le,Oe,F,1)}upVectorScale(F){return{metersToTile:Iu(Lu(ku(F)))}}}function vm(F){const Le=F.parallels,Oe=!!Le&&Math.abs(Le[0]+Le[1])<.01;switch(F.name){case"mercator":return new pm(F);case"equirectangular":return new lm(F);case"naturalEarth":return new dm(F);case"equalEarth":return new om(F);case"winkelTripel":return new ym(F);case"albers":return Oe?new gm(F):new em(F);case"lambertConformalConic":return Oe?new gm(F):new hm(F);case"globe":return new xm(F)}throw new Error(`Invalid projection name: ${F.name}`)}const yv=F_.VectorTileFeature.types,xv=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function wm(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr){const Xn=xt?Math.min(iv,Math.round(xt[0])):0,Yn=xt?Math.min(iv,Math.round(xt[1])):0;F.emplaceBack(Le,Oe,Math.round(32*Fe),Math.round(32*je),qe,He,(Xn<<1)+(jt?1:0),Yn,16*Gt,16*bi,256*wi,256*qr)}function Mm(F,Le,Oe){F.emplaceBack(Le,Oe)}function Am(F,Le,Oe,Fe,je,qe,He){F.emplaceBack(Le,Oe,Fe,je,qe,He)}function Im(F,Le,Oe,Fe,je){F.emplaceBack(Le,Oe,Fe,je),F.emplaceBack(Le,Oe,Fe,je),F.emplaceBack(Le,Oe,Fe,je),F.emplaceBack(Le,Oe,Fe,je)}function Sm(F){for(const Le of F.sections)if(Ms(Le.text))return!0;return!1}class Pm{constructor(F){this.layoutVertexArray=new Va,this.indexArray=new ja,this.programConfigurations=F,this.segments=new xo,this.dynamicLayoutVertexArray=new Da,this.opacityVertexArray=new Ra,this.placedSymbolArray=new so,this.iconTransitioningVertexArray=new La,this.globeExtVertexArray=new Ca,this.zOffsetVertexArray=new Aa}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(F,Le,Oe,Fe,je){this.isEmpty()||(Oe&&(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,Oy.members),this.indexBuffer=F.createIndexBuffer(this.indexArray,Le),this.dynamicLayoutVertexBuffer=F.createVertexBuffer(this.dynamicLayoutVertexArray,Ny.members,!0),this.opacityVertexBuffer=F.createVertexBuffer(this.opacityVertexArray,xv,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=F.createVertexBuffer(this.iconTransitioningVertexArray,Wy.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,ky.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||je)&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,qy.members,!0)),this.opacityVertexBuffer.itemSize=1),(Oe||Fe)&&this.programConfigurations.upload(F))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}us(Pm,"SymbolBuffers");class Em{constructor(F,Le,Oe){this.layoutVertexArray=new F,this.layoutAttributes=Le,this.indexArray=new Oe,this.segments=new xo,this.collisionVertexArray=new Ua,this.collisionVertexArrayExt=new Da}upload(F){this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=F.createVertexBuffer(this.collisionVertexArray,lx.members,!0),this.collisionVertexBufferExt=F.createVertexBuffer(this.collisionVertexArrayExt,Tx.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}us(Em,"CollisionBuffers");class zm{constructor(F){this.collisionBoxArray=F.collisionBoxArray,this.zoom=F.zoom,this.lut=F.lut,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.index=F.index,this.pixelRatio=F.pixelRatio,this.sourceLayerIndex=F.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=kl.mat4.identity([]),this.placementViewportMatrix=kl.mat4.identity([]);const Le=this.layers[0]._unevaluatedLayout._values;this.textSizeData=bf(this.zoom,Le["text-size"]),this.iconSizeData=bf(this.zoom,Le["icon-size"]);const Oe=this.layers[0].layout,Fe=Oe.get("symbol-sort-key"),je=Oe.get("symbol-z-order");this.canOverlap=Oe.get("text-allow-overlap")||Oe.get("icon-allow-overlap")||Oe.get("text-ignore-placement")||Oe.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==je&&void 0!==Fe.constantOr(1),this.sortFeaturesByY=("viewport-y"===je||"auto"===je&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=Oe.get("text-writing-mode").map((F=>Nx[F])),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.sourceID=F.sourceID,this.projection=F.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new Pm(new Go(this.layers,{zoom:this.zoom,lut:this.lut},(F=>F.startsWith("text")||F.startsWith("symbol")))),this.icon=new Pm(new Go(this.layers,{zoom:this.zoom,lut:this.lut},(F=>F.startsWith("icon")||F.startsWith("symbol")))),this.glyphOffsetArray=new lo,this.lineVertexArray=new uo,this.symbolInstances=new oo}calculateGlyphDependencies(F,Le,Oe,Fe,je){for(const Oe of F){const F=Oe.codePointAt(0);if(void 0===F)break;if(Le[F]=!0,Fe&&je&&F<=65535){const F=Cx[Oe];F&&(Le[F.charCodeAt(0)]=!0)}}}updateFootprints(F,Le){}updateReplacement(F,Le){if(Le.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=Le.updateTime;const Oe=Le.getReplacementRegionsForTile(F.toUnwrapped(),!0);return!Yh(this.activeReplacements,Oe)&&(this.activeReplacements=Oe,!0)}populate(F,Le,Oe,Fe){const je=this.layers[0],qe=je.layout,He="globe"===this.projection.name,xt=qe.get("text-font"),jt=qe.get("text-field"),Gt=qe.get("icon-image"),[bi,wi]=qe.get("icon-size-scale-range"),qr=Q(Le.scaleFactor||1,bi,wi),Xn=("constant"!==jt.value.kind||jt.value.value instanceof Qe&&!jt.value.value.isEmpty()||jt.value.value.toString().length>0)&&("constant"!==xt.value.kind||xt.value.value.length>0),Yn="constant"!==Gt.value.kind||!!Gt.value.value||Object.keys(Gt.parameters).length>0,yo=qe.get("symbol-sort-key");if(this.features=[],!Xn&&!Yn)return;const bo=Le.iconDependencies,Do=Le.glyphDependencies,Ro=Le.availableImages,zs=new Rs(this.zoom);for(const{feature:Le,id:jt,index:Gt,sourceLayerIndex:bi}of F){const F=je._featureFilter.needGeometry,wi=Cl(Le,F);if(!je._featureFilter.filter(zs,wi,Oe))continue;if(F||(wi.geometry=Vl(Le,Oe,Fe)),He&&1!==Le.type&&Oe.z<=5){const F=wi.geometry,Le=.98078528056,n=(F,Fe)=>{const je=Ru(F.x,F.y,Oe,1),qe=Ru(Fe.x,Fe.y,Oe,1);return kl.vec3.dot(je,qe)<Le};for(let Le=0;Le<F.length;Le++)F[Le]=zl(F[Le],n)}let Zs,na;if(Xn){const F=je.getValueAndResolveTokens("text-field",wi,Oe,Ro),Le=Qe.factory(F);Sm(Le)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Vs()||this.hasRTLText&&zf.isParsed())&&(Zs=Af(Le,je,wi))}if(Yn){const F=je.getValueAndResolveTokens("icon-image",wi,Oe,Ro);na=F instanceof er?F:er.build(F)}if(!Zs&&!na)continue;const el=this.sortFeaturesByKey?yo.evaluate(wi,{},Oe):void 0,nl={id:jt,text:Zs,icon:na,index:Gt,sourceLayerIndex:bi,geometry:wi.geometry,properties:Le.properties,type:yv[Le.type],sortKey:el};if(this.features.push(nl),na){const F=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Le,iconSecondary:Fe}=Rd(na,this.iconSizeData,F["icon-size"],Oe,this.zoom,nl,this.pixelRatio,qr),je=Le.id.toString();if(bo.has(je)?bo.get(je).push(Le):bo.set(je,[Le]),Fe){const F=Fe.id.toString();bo.has(F)?bo.get(F).push(Fe):bo.set(F,[Fe])}}if(Zs){const F=xt.evaluate(wi,{},Oe).join(","),Le="map"===qe.get("text-rotation-alignment")&&"point"!==qe.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Nx.vertical)>=0;for(const Oe of Zs.sections)if(Oe.image){const F=Oe.image.getPrimary().scaleSelf(this.pixelRatio),Le=F.id.toString(),Fe=bo.get(Le)||[];Fe.push(F),bo.set(Le,Fe)}else{const Fe=ms(Zs.toString()),je=Oe.fontStack||F,qe=Do[je]=Do[je]||{};this.calculateGlyphDependencies(Oe.text,qe,Le,this.allowVerticalPlacement,Fe)}}}if("line"===qe.get("symbol-placement")&&(this.features=function(F){const Le={},Oe={},Fe=[];let je=0;function s(Le){Fe.push(F[Le]),je++}function a(F,Le,je){const qe=Oe[F];return delete Oe[F],Oe[Le]=qe,Fe[qe].geometry[0].pop(),Fe[qe].geometry[0]=Fe[qe].geometry[0].concat(je[0]),qe}function o(F,Oe,je){const qe=Le[Oe];return delete Le[Oe],Le[F]=qe,Fe[qe].geometry[0].shift(),Fe[qe].geometry[0]=je[0].concat(Fe[qe].geometry[0]),qe}function l(F,Le,Oe){const Fe=Oe?Le[0][Le[0].length-1]:Le[0][0];return`${F}:${Fe.x}:${Fe.y}`}for(let qe=0;qe<F.length;qe++){const He=F[qe],xt=He.geometry,jt=He.text?He.text.toString():null;if(!jt){s(qe);continue}const Gt=l(jt,xt),bi=l(jt,xt,!0);if(Gt in Oe&&bi in Le&&Oe[Gt]!==Le[bi]){const F=o(Gt,bi,xt),je=a(Gt,bi,Fe[F].geometry);delete Le[Gt],delete Oe[bi],Oe[l(jt,Fe[je].geometry,!0)]=je,Fe[F].geometry=null}else Gt in Oe?a(Gt,bi,xt):bi in Le?o(Gt,bi,xt):(s(qe),Le[Gt]=je-1,Oe[bi]=je-1)}return Fe.filter((F=>F.geometry))}(this.features)),"hd-road-markup"===qe.get("symbol-elevation-reference")){if(this.elevationType="road",Le.elevationFeatures){!this.elevationFeatures&&Le.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const F of Le.elevationFeatures)this.elevationFeatureIdToIndex.set(F.id,this.elevationFeatures.length),this.elevationFeatures.push(F)}}else qe.get("symbol-z-elevate")&&(this.elevationType="offset");"none"!==this.elevationType&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((F,Le)=>F.sortKey-Le.sortKey))}update(F,Le,Oe,Fe,je,qe,He){this.text.programConfigurations.updatePaintArrays(F,Le,je,Oe,Fe,qe,He),this.icon.programConfigurations.updatePaintArrays(F,Le,je,Oe,Fe,qe,He)}updateRoadElevation(){if("road"!==this.elevationType||!this.elevationFeatures)return;if(this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let F=!1;for(let Le=0;Le<this.symbolInstances.length;Le++){const Oe=this.symbolInstances.get(Le);if(65535===Oe.elevationFeatureIndex)continue;const Fe=this.elevationFeatures[Oe.elevationFeatureIndex];if(Fe){const Le=.05+Fe.pointElevation(new ic(Oe.tileAnchorX,Oe.tileAnchorY));Oe.zOffset!==Le&&(F=!0,Oe.zOffset=Le)}}F&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const t=(Le,Oe,Fe)=>{F+=Oe,F>Le.length&&Le.resize(F);for(let je=-Oe;je<0;je++)Le.emplace(je+F,Fe)},e=(F,Oe,Fe)=>{Le+=Oe,Le>F.length&&F.resize(Le);for(let je=-Oe;je<0;je++)F.emplace(je+Le,Fe)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let F=0,Le=0;for(let F=0;F<this.symbolInstances.length;F++){const Le=this.symbolInstances.get(F),{numHorizontalGlyphVertices:Oe,numVerticalGlyphVertices:Fe,numIconVertices:je}=Le,qe=Le.zOffset,He=je>0;if((Oe>0||Fe>0)&&(t(this.text.zOffsetVertexArray,Oe,qe),t(this.text.zOffsetVertexArray,Fe,qe)),He){const{placedIconSymbolIndex:F,verticalPlacedIconSymbolIndex:Oe}=Le;F>=0&&e(this.icon.zOffsetVertexArray,je,qe),Oe>=0&&e(this.icon.zOffsetVertexArray,Le.numVerticalIconVertices,qe)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(F){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(F),this.iconCollisionBox.upload(F)),this.text.upload(F,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(F,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=vm(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(F,Le){const Oe=this.lineVertexArray.length;if(void 0!==F.segment)for(const{x:F,y:Oe}of Le)this.lineVertexArray.emplaceBack(F,Oe);return{lineStartIndex:Oe,lineLength:this.lineVertexArray.length-Oe}}addSymbols(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo){const bo=F.indexArray,Do=F.layoutVertexArray,Ro=F.globeExtVertexArray,zs=F.segments.prepareSegment(4*Le.length,Do,bo,this.canOverlap?qe.sortKey:void 0),Zs=this.glyphOffsetArray.length,na=zs.vertexLength,el=this.allowVerticalPlacement&&He===Nx.vertical?Math.PI/2:0,nl=qe.text&&qe.text.sections;for(let Fe=0;Fe<Le.length;Fe++){const{tl:je,tr:He,bl:Gt,br:bi,texPrimary:wi,texSecondary:Zs,pixelOffsetTL:na,pixelOffsetBR:hl,minFontScaleX:pl,minFontScaleY:bl,glyphOffset:Tl,isSDF:kl,sectionIndex:ec}=Le[Fe],tc=zs.vertexLength,ic=Tl[1];if(wm(Do,jt.x,jt.y,je.x,ic+je.y,wi.x,wi.y,Oe,kl,na.x,na.y,pl,bl),wm(Do,jt.x,jt.y,He.x,ic+He.y,wi.x+wi.w,wi.y,Oe,kl,hl.x,na.y,pl,bl),wm(Do,jt.x,jt.y,Gt.x,ic+Gt.y,wi.x,wi.y+wi.h,Oe,kl,na.x,hl.y,pl,bl),wm(Do,jt.x,jt.y,bi.x,ic+bi.y,wi.x+wi.w,wi.y+wi.h,Oe,kl,hl.x,hl.y,pl,bl),xt){const{x:Le,y:Oe,z:Fe}=xt.anchor,[je,qe,He]=xt.up;Am(Ro,Le,Oe,Fe,je,qe,He),Am(Ro,Le,Oe,Fe,je,qe,He),Am(Ro,Le,Oe,Fe,je,qe,He),Am(Ro,Le,Oe,Fe,je,qe,He),Im(F.dynamicLayoutVertexArray,Le,Oe,Fe,el)}else Im(F.dynamicLayoutVertexArray,jt.x,jt.y,jt.z,el);if(yo){const Le=Zs||wi;Mm(F.iconTransitioningVertexArray,Le.x,Le.y),Mm(F.iconTransitioningVertexArray,Le.x+Le.w,Le.y),Mm(F.iconTransitioningVertexArray,Le.x,Le.y+Le.h),Mm(F.iconTransitioningVertexArray,Le.x+Le.w,Le.y+Le.h)}bo.emplaceBack(tc,tc+1,tc+2),bo.emplaceBack(tc+1,tc+2,tc+3),zs.vertexLength+=4,zs.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Tl[0]),Fe!==Le.length-1&&ec===Le[Fe+1].sectionIndex||F.programConfigurations.populatePaintArrays(Do.length,qe,qe.index,{},qr,Xn,Yn,nl&&nl[ec])}const hl=xt?xt.anchor:jt;F.placedSymbolArray.emplaceBack(hl.x,hl.y,hl.z,jt.x,jt.y,Zs,this.glyphOffsetArray.length-Zs,na,Gt,bi,jt.segment,Oe?Oe[0]:0,Oe?Oe[1]:0,Fe[0],Fe[1],He,0,!1,0,wi,0)}_commitLayoutVertex(F,Le,Oe,Fe,je,qe,He){F.emplaceBack(Le,Oe,Fe,je,qe,Math.round(He.x),Math.round(He.y))}_addCollisionDebugVertices(F,Le,Oe,Fe,je,qe,He){const xt=Oe.segments.prepareSegment(4,Oe.layoutVertexArray,Oe.indexArray),jt=xt.vertexLength,Gt=He.tileAnchorX,bi=He.tileAnchorY;for(let F=0;F<4;F++)Oe.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(Oe.collisionVertexArrayExt,Le,F.padding,He.zOffset),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,je,qe,Gt,bi,new ic(F.x1,F.y1)),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,je,qe,Gt,bi,new ic(F.x2,F.y1)),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,je,qe,Gt,bi,new ic(F.x2,F.y2)),this._commitLayoutVertex(Oe.layoutVertexArray,Fe,je,qe,Gt,bi,new ic(F.x1,F.y2)),xt.vertexLength+=4;const wi=Oe.indexArray;wi.emplaceBack(jt,jt+1),wi.emplaceBack(jt+1,jt+2),wi.emplaceBack(jt+2,jt+3),wi.emplaceBack(jt+3,jt),xt.primitiveLength+=4}_addTextDebugCollisionBoxes(F,Le,Oe,Fe,je,qe){for(let He=Fe;He<je;He++){const Fe=Oe.get(He),je=this.getSymbolInstanceTextSize(F,qe,Le,He);this._addCollisionDebugVertices(Fe,je,this.textCollisionBox,Fe.projectedAnchorX,Fe.projectedAnchorY,Fe.projectedAnchorZ,qe)}}_addIconDebugCollisionBoxes(F,Le,Oe,Fe,je,qe){for(let He=Fe;He<je;He++){const Fe=Oe.get(He),je=this.getSymbolInstanceIconSize(F,Le,qe.placedIconSymbolIndex);this._addCollisionDebugVertices(Fe,je,this.iconCollisionBox,Fe.projectedAnchorX,Fe.projectedAnchorY,Fe.projectedAnchorZ,qe)}}generateCollisionDebugBuffers(F,Le,Oe){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Em(Oa,Sx.members,La),this.iconCollisionBox=new Em(Oa,Sx.members,La);const Fe=wf(this.iconSizeData,F),je=wf(this.textSizeData,F,Oe);for(let Oe=0;Oe<this.symbolInstances.length;Oe++){const qe=this.symbolInstances.get(Oe);this._addTextDebugCollisionBoxes(je,F,Le,qe.textBoxStartIndex,qe.textBoxEndIndex,qe),this._addTextDebugCollisionBoxes(je,F,Le,qe.verticalTextBoxStartIndex,qe.verticalTextBoxEndIndex,qe),this._addIconDebugCollisionBoxes(Fe,F,Le,qe.iconBoxStartIndex,qe.iconBoxEndIndex,qe),this._addIconDebugCollisionBoxes(Fe,F,Le,qe.verticalIconBoxStartIndex,qe.verticalIconBoxEndIndex,qe)}}getSymbolInstanceTextSize(F,Le,Oe,Fe){const je=this.text.placedSymbolArray.get(Le.rightJustifiedTextSymbolIndex>=0?Le.rightJustifiedTextSymbolIndex:Le.centerJustifiedTextSymbolIndex>=0?Le.centerJustifiedTextSymbolIndex:Le.leftJustifiedTextSymbolIndex>=0?Le.leftJustifiedTextSymbolIndex:Le.verticalPlacedTextSymbolIndex>=0?Le.verticalPlacedTextSymbolIndex:Fe),qe=_f(this.textSizeData,F,je)/Mx;return this.tilePixelRatio*qe}getSymbolInstanceIconSize(F,Le,Oe){const Fe=this.icon.placedSymbolArray.get(Oe),je=_f(this.iconSizeData,F,Fe);return this.tilePixelRatio*je}_commitDebugCollisionVertexUpdate(F,Le,Oe,Fe){F.emplaceBack(Le,-Oe,-Oe,Fe),F.emplaceBack(Le,Oe,-Oe,Fe),F.emplaceBack(Le,Oe,Oe,Fe),F.emplaceBack(Le,-Oe,Oe,Fe)}_updateTextDebugCollisionBoxes(F,Le,Oe,Fe,je,qe,He){for(let He=Fe;He<je;He++){const Fe=Oe.get(He),je=this.getSymbolInstanceTextSize(F,qe,Le,He);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,je,Fe.padding,qe.zOffset)}}_updateIconDebugCollisionBoxes(F,Le,Oe,Fe,je,qe,He){for(let He=Fe;He<je;He++){const Fe=Oe.get(He),je=this.getSymbolInstanceIconSize(F,Le,qe.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,je,Fe.padding,qe.zOffset)}}updateCollisionDebugBuffers(F,Le,Oe,Fe){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const je=wf(this.iconSizeData,F,Fe),qe=wf(this.textSizeData,F,Oe);for(let He=0;He<this.symbolInstances.length;He++){const xt=this.symbolInstances.get(He);this._updateTextDebugCollisionBoxes(qe,F,Le,xt.textBoxStartIndex,xt.textBoxEndIndex,xt,Oe),this._updateTextDebugCollisionBoxes(qe,F,Le,xt.verticalTextBoxStartIndex,xt.verticalTextBoxEndIndex,xt,Oe),this._updateIconDebugCollisionBoxes(je,F,Le,xt.iconBoxStartIndex,xt.iconBoxEndIndex,xt,Fe),this._updateIconDebugCollisionBoxes(je,F,Le,xt.verticalIconBoxStartIndex,xt.verticalIconBoxEndIndex,xt,Fe)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt={};if(Le<Oe){const{x1:Oe,y1:Fe,x2:je,y2:qe,padding:He,projectedAnchorX:xt,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr,featureIndex:Xn}=F.get(Le);Gt.textBox={x1:Oe,y1:Fe,x2:je,y2:qe,padding:He,projectedAnchorX:xt,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr},Gt.textFeatureIndex=Xn}if(Fe<je){const{x1:Le,y1:Oe,x2:je,y2:qe,padding:He,projectedAnchorX:xt,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr,featureIndex:Xn}=F.get(Fe);Gt.verticalTextBox={x1:Le,y1:Oe,x2:je,y2:qe,padding:He,projectedAnchorX:xt,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr},Gt.verticalTextFeatureIndex=Xn}if(qe<He){const{x1:Le,y1:Oe,x2:Fe,y2:je,padding:He,projectedAnchorX:xt,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr,featureIndex:Xn}=F.get(qe);Gt.iconBox={x1:Le,y1:Oe,x2:Fe,y2:je,padding:He,projectedAnchorX:xt,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr},Gt.iconFeatureIndex=Xn}if(xt<jt){const{x1:Le,y1:Oe,x2:Fe,y2:je,padding:qe,projectedAnchorX:He,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr,featureIndex:Xn}=F.get(xt);Gt.verticalIconBox={x1:Le,y1:Oe,x2:Fe,y2:je,padding:qe,projectedAnchorX:He,projectedAnchorY:jt,projectedAnchorZ:bi,tileAnchorX:wi,tileAnchorY:qr},Gt.verticalIconFeatureIndex=Xn}return Gt}deserializeCollisionBoxes(F){this.collisionArrays=[];for(let Le=0;Le<this.symbolInstances.length;Le++){const Oe=this.symbolInstances.get(Le);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(F,Oe.textBoxStartIndex,Oe.textBoxEndIndex,Oe.verticalTextBoxStartIndex,Oe.verticalTextBoxEndIndex,Oe.iconBoxStartIndex,Oe.iconBoxEndIndex,Oe.verticalIconBoxStartIndex,Oe.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(F,Le){const Oe=F.placedSymbolArray.get(Le),Fe=Oe.vertexStartIndex+4*Oe.numGlyphs;for(let Le=Oe.vertexStartIndex;Le<Fe;Le+=4)F.indexArray.emplaceBack(Le,Le+1,Le+2),F.indexArray.emplaceBack(Le+1,Le+2,Le+3)}getSortedSymbolIndexes(F){if(this.sortedAngle===F&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const Le=Math.sin(F),Oe=Math.cos(F),Fe=[],je=[],qe=[];for(let F=0;F<this.symbolInstances.length;++F){qe.push(F);const He=this.symbolInstances.get(F);Fe.push(0|Math.round(Le*He.tileAnchorX+Oe*He.tileAnchorY)),je.push(He.featureIndex)}return qe.sort(((F,Le)=>Fe[F]-Fe[Le]||je[Le]-je[F])),qe}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let F=0;F<this.symbolInstances.length;++F)this.symbolInstanceIndexesSortedZOffset.push(F)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((F,Le)=>this.symbolInstances.get(Le).zOffset-this.symbolInstances.get(F).zOffset))}addToSortKeyRanges(F,Le){const Oe=this.sortKeyRanges[this.sortKeyRanges.length-1];Oe&&Oe.sortKey===Le?Oe.symbolInstanceEnd=F+1:this.sortKeyRanges.push({sortKey:Le,symbolInstanceStart:F,symbolInstanceEnd:F+1})}sortFeatures(F){if(this.sortFeaturesByY&&this.sortedAngle!==F&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(F),this.sortedAngle=F,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const F of this.symbolInstanceIndexes){const Le=this.symbolInstances.get(F);this.featureSortOrder.push(Le.featureIndex);const{rightJustifiedTextSymbolIndex:Oe,centerJustifiedTextSymbolIndex:Fe,leftJustifiedTextSymbolIndex:je,verticalPlacedTextSymbolIndex:qe,placedIconSymbolIndex:He,verticalPlacedIconSymbolIndex:xt}=Le;Oe>=0&&this.addIndicesForPlacedSymbol(this.text,Oe),Fe>=0&&Fe!==Oe&&this.addIndicesForPlacedSymbol(this.text,Fe),je>=0&&je!==Fe&&je!==Oe&&this.addIndicesForPlacedSymbol(this.text,je),qe>=0&&this.addIndicesForPlacedSymbol(this.text,qe),He>=0&&this.addIndicesForPlacedSymbol(this.icon,He),xt>=0&&this.addIndicesForPlacedSymbol(this.icon,xt)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let bv,Fv,qv;us(zm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),zm.addDynamicAttributes=Im;class Vm{constructor(F){this.type=F.property.overrides?F.property.overrides.runtimeType:Hu,this.defaultValue=F}evaluate(F){if(F.formattedSection){const Le=this.defaultValue.property.overrides;if(Le&&Le.hasOverride(F.formattedSection))return Le.getOverride(F.formattedSection)}return F.feature&&F.featureState?this.defaultValue.evaluate(F.feature,F.featureState):this.defaultValue.property.specification.default}eachChild(F){this.defaultValue.isConstant()||F(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}us(Vm,"FormatSectionOverride",{omit:["defaultValue"]});const Cm=()=>qv||(qv={layout:bv||(bv=new Xs({"symbol-placement":new Gs(Df.layout_symbol["symbol-placement"]),"symbol-spacing":new Gs(Df.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Gs(Df.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ys(Df.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Gs(Df.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Gs(Df.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Gs(Df.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Gs(Df.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Gs(Df.layout_symbol["icon-ignore-placement"]),"icon-optional":new Gs(Df.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Gs(Df.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ys(Df.layout_symbol["icon-size"]),"icon-size-scale-range":new Gs(Df.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Ys(Df.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ys(Df.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ys(Df.layout_symbol["icon-image"]),"icon-rotate":new Ys(Df.layout_symbol["icon-rotate"]),"icon-padding":new Gs(Df.layout_symbol["icon-padding"]),"icon-keep-upright":new Gs(Df.layout_symbol["icon-keep-upright"]),"icon-offset":new Ys(Df.layout_symbol["icon-offset"]),"icon-anchor":new Ys(Df.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Gs(Df.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Gs(Df.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Gs(Df.layout_symbol["text-rotation-alignment"]),"text-field":new Ys(Df.layout_symbol["text-field"]),"text-font":new Ys(Df.layout_symbol["text-font"]),"text-size":new Ys(Df.layout_symbol["text-size"]),"text-size-scale-range":new Gs(Df.layout_symbol["text-size-scale-range"]),"text-max-width":new Ys(Df.layout_symbol["text-max-width"]),"text-line-height":new Ys(Df.layout_symbol["text-line-height"]),"text-letter-spacing":new Ys(Df.layout_symbol["text-letter-spacing"]),"text-justify":new Ys(Df.layout_symbol["text-justify"]),"text-radial-offset":new Ys(Df.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Gs(Df.layout_symbol["text-variable-anchor"]),"text-anchor":new Ys(Df.layout_symbol["text-anchor"]),"text-max-angle":new Gs(Df.layout_symbol["text-max-angle"]),"text-writing-mode":new Gs(Df.layout_symbol["text-writing-mode"]),"text-rotate":new Ys(Df.layout_symbol["text-rotate"]),"text-padding":new Gs(Df.layout_symbol["text-padding"]),"text-keep-upright":new Gs(Df.layout_symbol["text-keep-upright"]),"text-transform":new Ys(Df.layout_symbol["text-transform"]),"text-offset":new Ys(Df.layout_symbol["text-offset"]),"text-allow-overlap":new Gs(Df.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Gs(Df.layout_symbol["text-ignore-placement"]),"text-optional":new Gs(Df.layout_symbol["text-optional"]),visibility:new Gs(Df.layout_symbol.visibility)})),paint:Fv||(Fv=new Xs({"icon-opacity":new Ys(Df.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Ys(Df.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Ys(Df.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Ys(Df.paint_symbol["text-emissive-strength"]),"icon-color":new Ys(Df.paint_symbol["icon-color"]),"icon-halo-color":new Ys(Df.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ys(Df.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ys(Df.paint_symbol["icon-halo-blur"]),"icon-translate":new Gs(Df.paint_symbol["icon-translate"]),"icon-translate-anchor":new Gs(Df.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ys(Df.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Ys(Df.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Ys(Df.paint_symbol["text-occlusion-opacity"]),"text-color":new Ys(Df.paint_symbol["text-color"],{runtimeType:hd,getOverride:F=>F.textColor,hasOverride:F=>!!F.textColor}),"text-halo-color":new Ys(Df.paint_symbol["text-halo-color"]),"text-halo-width":new Ys(Df.paint_symbol["text-halo-width"]),"text-halo-blur":new Ys(Df.paint_symbol["text-halo-blur"]),"text-translate":new Gs(Df.paint_symbol["text-translate"]),"text-translate-anchor":new Gs(Df.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Gs(Df.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Gs(Df.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Gs(Df.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Gs(Df.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Ys(Df.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},qv);class Dm extends ma{constructor(F,Le,Oe,Fe){super(F,Cm(),Le,Oe,Fe),this._colorAdjustmentMatrix=kl.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==F.paint&&("icon-occlusion-opacity"in F.paint||"text-occlusion-opacity"in F.paint)}recalculate(F,Le){super.recalculate(F,Le),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const Oe=this.layout.get("text-writing-mode");if(Oe){const F=[];for(const Le of Oe)F.indexOf(Le)<0&&F.push(Le);this.layout._values["text-writing-mode"]=F}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(F,Le,Oe,Fe){return this._saturation===F&&this._contrast===Le&&this._brightnessMin===Oe&&this._brightnessMax===Fe||(this._colorAdjustmentMatrix=function(F,Le,Oe,Fe){F=Mt(F),Le=wt(Le);const je=kl.mat4.create(),qe=F/3,He=1-2*qe,xt=[He,qe,qe,0,qe,He,qe,0,qe,qe,He,0,0,0,0,1],jt=.5-.5*Le,Gt=Fe-Oe;return kl.mat4.multiply(je,[Gt,0,0,0,0,Gt,0,0,0,0,Gt,0,Oe,Oe,Oe,1],[Le,0,0,0,0,Le,0,0,0,0,Le,0,jt,jt,jt,1]),kl.mat4.multiply(je,je,xt),je}(F,Le,Oe,Fe),this._saturation=F,this._contrast=Le,this._brightnessMin=Oe,this._brightnessMax=Fe),this._colorAdjustmentMatrix}getValueAndResolveTokens(F,Le,Oe,Fe){const je=this.layout.get(F).evaluate(Le,{},Oe,Fe),qe=this._unevaluatedLayout._values[F];return qe.isDataDriven()||Ki(qe.value)||!je?je:function(F,Le){return Le.replace(/{([^{}]+)}/g,((Le,Oe)=>Oe in F?String(F[Oe]):""))}(Le.properties,je)}createBucket(F){return new zm(F)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const F of Cm().paint.overridableProperties){if(!Dm.hasPaintOverride(this.layout,F))continue;const Le=this.paint.get(F),Oe=new Vm(Le),Fe=new Wi(Oe,Le.property.specification,this.scope,this.options);let je=null;je="constant"===Le.value.kind||"source"===Le.value.kind?new Qi("source",Fe):new ts("composite",Fe,Le.value.zoomStops,Le.value._interpolationType),this.paint._values[F]=new qs(Le.property,je,Le.parameters)}}_handleOverridablePaintPropertyUpdate(F,Le,Oe){return!(!this.layout||Le.isDataDriven()||Oe.isDataDriven())&&Dm.hasPaintOverride(this.layout,F)}static hasPaintOverride(F,Le){const Oe=F.get("text-field"),Fe=Cm().paint.properties[Le];let je=!1;const s=F=>{for(const Le of F)if(Fe.overrides&&Fe.overrides.hasOverride(Le))return void(je=!0)};if("constant"===Oe.value.kind&&Oe.value.value instanceof Qe)s(Oe.value.value.sections);else if("source"===Oe.value.kind){const t=F=>{je||(F instanceof ar&&ir(F.value)===vd?s(F.value.sections):F instanceof cr?s(F.sections):F.eachChild(t))},F=Oe.value;F._styleExpression&&t(F._styleExpression.expression)}return je}getProgramIds(){return["symbol"]}getDefaultProgramParams(F,Le,Oe){return{config:new $o(this,{zoom:Le,lut:Oe}),overrideFog:!1}}}let Wv,Kv,Jv,Qv;var eb=va([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Um(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function jm(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class qm{constructor(F,Le,Oe,Fe){this.context=F,this.format=Oe,this.useMipmap=Fe&&Fe.useMipmap,this.texture=F.gl.createTexture(),this.update(Le,{premultiply:Fe&&Fe.premultiply})}update(F,Le){const Oe=F&&F instanceof HTMLVideoElement&&0===F.width?F.videoWidth:F.width,Fe=F&&F instanceof HTMLVideoElement&&0===F.height?F.videoHeight:F.height,{context:je}=this,{gl:qe}=je,{x:He,y:xt}=Le&&Le.position?Le.position:{x:0,y:0},jt=He+Oe,Gt=xt+Fe;!this.size||this.size[0]===jt&&this.size[1]===Gt||(qe.bindTexture(qe.TEXTURE_2D,null),qe.deleteTexture(this.texture),this.texture=qe.createTexture(),this.size=null),qe.bindTexture(qe.TEXTURE_2D,this.texture),je.pixelStoreUnpackFlipY.set(!1),je.pixelStoreUnpack.set(1),je.pixelStoreUnpackPremultiplyAlpha.set(this.format===qe.RGBA8&&(!Le||!1!==Le.premultiply));const bi=F instanceof HTMLImageElement||F instanceof HTMLCanvasElement||F instanceof HTMLVideoElement||F instanceof ImageData||ImageBitmap&&F instanceof ImageBitmap;if(!this.size&&jt>0&&Gt>0){const F=this.useMipmap?Math.floor(Math.log2(Math.max(jt,Gt)))+1:1;qe.texStorage2D(qe.TEXTURE_2D,F,this.format,jt,Gt),this.size=[jt,Gt]}if(this.size)if(bi)qe.texSubImage2D(qe.TEXTURE_2D,0,He,xt,Um(this.format),jm(this.format),F);else{const Le=F.data;Le&&qe.texSubImage2D(qe.TEXTURE_2D,0,He,xt,Oe,Fe,Um(this.format),jm(this.format),Le)}this.useMipmap&&qe.generateMipmap(qe.TEXTURE_2D)}bind(F,Le,Oe=!1){const{context:Fe}=this,{gl:je}=Fe;je.bindTexture(je.TEXTURE_2D,this.texture),F!==this.minFilter&&(je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MAG_FILTER,F),je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MIN_FILTER,this.useMipmap&&!Oe?F===je.NEAREST?je.NEAREST_MIPMAP_NEAREST:je.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),Le!==this.wrapS&&(je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_S,Le),je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_T,Le),this.wrapS=Le)}bindExtraParam(F,Le,Oe,Fe){const{context:je}=this,{gl:qe}=je;qe.bindTexture(qe.TEXTURE_2D,this.texture),Le!==this.magFilter&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_MAG_FILTER,Le),this.magFilter=Le),F!==this.minFilter&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_MIN_FILTER,this.useMipmap?F===qe.NEAREST?qe.NEAREST_MIPMAP_NEAREST:qe.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),Oe!==this.wrapS&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_WRAP_S,Oe),this.wrapS=Oe),Fe!==this.wrapT&&(qe.texParameteri(qe.TEXTURE_2D,qe.TEXTURE_WRAP_T,Fe),this.wrapT=Fe)}destroy(){const{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}}class $m{constructor(F,Le){this.context=F,this.texture=Le}bind(F,Le){const{context:Oe}=this,{gl:Fe}=Oe;Fe.bindTexture(Fe.TEXTURE_2D,this.texture),F!==this.minFilter&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MAG_FILTER,F),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_MIN_FILTER,F),this.minFilter=F),Le!==this.wrapS&&(Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_S,Le),Fe.texParameteri(Fe.TEXTURE_2D,Fe.TEXTURE_WRAP_T,Le),this.wrapS=Le)}}function Gm(F,Le,Oe,Fe,je,qe,He,xt){const jt=[F,Le,1,Oe,Fe,1,je,qe,1],Gt=[He,xt,1],bi=kl.mat3.adjoint([],jt),[wi,qr,Xn]=kl.vec3.transformMat3(Gt,Gt,bi);return kl.mat3.multiply(jt,jt,[wi,0,0,0,qr,0,0,0,Xn])}function Ym(F,Le,Oe,Fe,je,qe,He,xt){const jt=function(F,Le,Oe,Fe,je,qe,He,xt){const jt=Gm(0,0,1,0,1,1,0,1),Gt=Gm(F,Le,Oe,Fe,je,qe,He,xt),bi=kl.mat3.adjoint([],jt);return kl.mat3.multiply(Gt,Gt,bi)}(F,Le,Oe,Fe,je,qe,He,xt);return[jt[2]/jt[8]/sp,jt[5]/jt[8]/sp]}function Hm(F){return[F[0],Math.min(Math.max(F[1],-e_),e_)]}class Xm extends _e{constructor(F,Le,Oe,Fe){super(),this.id=F,this.dispatcher=Oe,this.coordinates=Le.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(Fe),this.options=Le,this._dirty=!1}load(F,Le){if(this._loaded=Le||!1,this.fire(new ge("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return F&&(this.coordinates=F),this._loaded=!0,void this._finishLoading();this._imageRequest=le(this.map._requestManager.transformRequest(this.url,kh.Image),((Le,Oe)=>{this._imageRequest=null,this._loaded=!0,Le?this.fire(new xe(Le)):Oe&&(this.image=Oe instanceof HTMLImageElement?rh.getImageData(Oe):Oe,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,F&&(this.coordinates=F),this._finishLoading())}))}loaded(){return this._loaded}updateImage(F){return F.url?(this._imageRequest&&F.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=F.url,this.load(F.coordinates,this._loaded),this):this}setTexture(F){if(!(F.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new $m(this.map.painter.context,F.handle),this.width=F.dimensions[0],this.height=F.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new ge("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(F){this.map=F,this.load()}onRemove(F){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof $m||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(F){if(this.coordinates=F,this._boundsArray=void 0,this._unsupportedCoords=!1,!F.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let Le=F[0][1],Oe=F[0][1];for(const Fe of F)Fe[1]>Oe&&(Oe=Fe[1]),Fe[1]<Le&&(Le=Fe[1]);const Fe=(Oe+Le)/2;if(Fe>e_?this.onNorthPole=!0:Fe<-e_&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const Le=F.map(Il.fromLngLat);this.tileID=function(F){let Le=1/0,Oe=1/0,Fe=-1/0,je=-1/0;for(const qe of F)Le=Math.min(Le,qe.x),Oe=Math.min(Oe,qe.y),Fe=Math.max(Fe,qe.x),je=Math.max(je,qe.y);const qe=Math.max(Fe-Le,je-Oe),He=Math.max(0,Math.floor(-Math.log(qe)/Math.LN2)),xt=Math.pow(2,He);let jt=Math.floor((Le+Fe)/2*xt);return jt>1&&(jt-=1),new ou(He,jt,Math.floor((Oe+je)/2*xt))}(Le),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new ge("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(F){for(const F in this.tiles){const Le=this.tiles[F];"loaded"!==Le.state&&(Le.state="loaded",Le.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const Le=Kd(new ou(0,0,0),this.map.transform.projection),Oe=[Le.projection.project(this.coordinates[0][0],this.coordinates[0][1]),Le.projection.project(this.coordinates[1][0],this.coordinates[1][1]),Le.projection.project(this.coordinates[2][0],this.coordinates[2][1]),Le.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(F){const Le=F[1].x-F[0].x,Oe=F[1].y-F[0].y,Fe=F[2].x-F[1].x,je=F[2].y-F[1].y,qe=F[3].x-F[2].x,He=F[3].y-F[2].y,xt=F[0].x-F[3].x,jt=F[0].y-F[3].y,Gt=Le*je-Fe*Oe,bi=Fe*He-qe*je,wi=qe*jt-xt*He,qr=xt*Oe-Le*jt;return Gt>0&&bi>0&&wi>0&&qr>0||Gt<0&&bi<0&&wi<0&&qr<0}(Oe))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const Fe=Kd(this.tileID,this.map.transform.projection),[je,qe,He,xt]=this.coordinates.map((F=>{const Le=Fe.projection.project(F[0],F[1]);return Jd(Fe,Le)._round()}));this.perspectiveTransform=Ym(je.x,je.y,qe.x,qe.y,He.x,He.y,xt.x,xt.y);const jt=this._boundsArray=new Ma;jt.emplaceBack(je.x,je.y,0,0),jt.emplaceBack(qe.x,qe.y,sp,0),jt.emplaceBack(xt.x,xt.y,0,sp),jt.emplaceBack(He.x,He.y,sp,sp),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=F.createVertexBuffer(jt,eb.members),this.boundsSegments=xo.simpleSegment(0,0,4,2);const Gt=[],bi=[Hm((wi=this.coordinates)[0]),Hm(wi[1]),Hm(wi[2]),Hm(wi[3])];var wi;const[qr,Xn,Yn,yo]=function(F){let Le=F[0][0],Oe=Le,Fe=F[0][1],je=Fe;for(let qe=1;qe<F.length;qe++)F[qe][0]<Le?Le=F[qe][0]:F[qe][0]>Oe&&(Oe=F[qe][0]),F[qe][1]<Fe?Fe=F[qe][1]:F[qe][1]>je&&(je=F[qe][1]);return[Le,Fe,Oe-Le,je-Fe]}(bi);{const Fe=new Ma,[je,qe,He,xt]=function(F){let Le=F[0].x,Oe=Le,Fe=F[0].y,je=Fe;for(let qe=1;qe<F.length;qe++)F[qe].x<Le?Le=F[qe].x:F[qe].x>Oe&&(Oe=F[qe].x),F[qe].y<Fe?Fe=F[qe].y:F[qe].y>je&&(je=F[qe].y);return[Le,Fe,Oe-Le,je-Fe]}(Oe),l=F=>[(F.x-je)/He,(F.y-qe)/xt],[jt,bi,wi,bo]=Oe.map(l),Do=function(F,Le,Oe,Fe,je,qe,He,xt){const jt=Gm(0,0,1,0,1,1,0,1),Gt=Gm(F,Le,Oe,Fe,je,qe,He,xt),bi=kl.mat3.adjoint([],Gt);return kl.mat3.multiply(jt,jt,bi)}(jt[0],jt[1],bi[0],bi[1],wi[0],wi[1],bo[0],bo[1]);this.elevatedGlobePerspectiveTransform=Ym(jt[0],jt[1],bi[0],bi[1],wi[0],wi[1],bo[0],bo[1]);const v=(F,Le)=>{Gt.push(F.lng);const Oe=Math.round((F.lng-qr)/Yn*sp),je=Math.round((F.lat-Xn)/yo*sp),qe=l(Le),He=kl.vec3.transformMat3([],[qe[0],qe[1],1],Do),xt=Math.round(He[0]/He[2]*sp),jt=Math.round(He[1]/He[2]*sp);Fe.emplaceBack(Oe,je,xt,jt)},Ro=Oe[3].x-Oe[0].x,zs=Oe[3].y-Oe[0].y,Zs=Oe[2].x-Oe[1].x,na=Oe[2].y-Oe[1].y;for(let F=0;F<65;F++){const Fe=F/64,je=[Oe[0].x+Fe*Ro,Oe[0].y+Fe*zs],qe=[Oe[1].x+Fe*Zs,Oe[1].y+Fe*na],He=qe[0]-je[0],xt=qe[1]-je[1];for(let F=0;F<65;F++){const Oe=F/64,Fe={x:je[0]+He*Oe,y:je[1]+xt*Oe,z:0};v(Le.projection.unproject(Fe.x,Fe.y),Fe)}}this.elevatedGlobeVertexBuffer=F.createVertexBuffer(Fe,eb.members)}{this.maxLongitudeTriangleSize=0;let Le=[],Oe=new ja;const n=(F,Fe,je)=>{Oe.emplaceBack(F,Fe,je);const qe=Gt[F],He=Gt[Fe],xt=Gt[je],jt=Math.min(Math.min(qe,He),xt),bi=Math.max(Math.max(qe,He),xt)-jt;bi>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=bi),Le.push(jt+bi/2)};for(let F=0;F<64;F++)for(let Le=0;Le<64;Le++){const Oe=65*F+Le,Fe=Oe+1,je=Oe+65,qe=je+1;n(Oe,je,Fe),n(Fe,je,qe)}[Le,Oe]=function(F,Le){const Oe=Array.from({length:F.length},((F,Le)=>Le));Oe.sort(((Le,Oe)=>F[Le]-F[Oe]));const Fe=[],je=new ja;for(let qe=0;qe<Oe.length;qe++){const He=Oe[qe];Fe.push(F[He]);const xt=3*He,jt=xt+1;je.emplaceBack(Le.uint16[xt],Le.uint16[jt],Le.uint16[jt+1])}return[Fe,je]}(Le,Oe),this.elevatedGlobeTrianglesCenterLongitudes=Le,this.elevatedGlobeIndexBuffer=F.createIndexBuffer(Oe)}this.elevatedGlobeSegments=xo.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,Yn/sp,0,yo/sp,0,0,Xn,qr,0])}prepare(){const F=0!==Object.keys(this.tiles).length;if(this.tileID&&!F)return;const Le=this.map.painter.context,Oe=Le.gl;!this._dirty||this.texture instanceof $m||(this.texture?this.texture.update(this.image):(this.texture=new qm(Le,this.image,Oe.RGBA8),this.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE)),this._dirty=!1),F&&this._prepareData(Le)}loadTile(F,Le){this.tileID&&this.tileID.equals(F.tileID.canonical)?(this.tiles[String(F.tileID.wrap)]=F,F.buckets={},Le(null)):(F.state="errored",Le(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(F){const Le=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!Le)return null;const Oe=this.elevatedGlobeTrianglesCenterLongitudes;let Fe=(je=F+180)+360*Math.round((Oe[0]-je)/360);var je;const qe=new xo,a=(F,Oe)=>{qe.segments.push({vertexOffset:0,primitiveOffset:F,vertexLength:Le.segments[0].vertexLength,primitiveLength:Oe,sortKey:void 0,vaos:{}})},He=.51*this.maxLongitudeTriangleSize;if(Math.abs(Oe[0]-Fe)<=He){const F=_t(Oe,0,Oe.length,Fe+He);return F===Oe.length||a(F,bt(Oe,F+1,Oe.length,Fe+360-He)-F),qe}Fe<Oe[0]&&(Fe+=360);const xt=bt(Oe,0,Oe.length,Fe-He);if(xt===Oe.length)return a(0,Oe.length),qe;a(0,xt-0);const jt=_t(Oe,xt+1,Oe.length,Fe+He);return jt!==Oe.length&&a(jt,Oe.length-jt),qe}}const tb=(Math.pow(256,2)-1)/16907520;class Wm extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:Jv||(Jv=new Xs({visibility:new Gs(Df.layout_raster.visibility)})),paint:Qv||(Qv=new Xs({"raster-opacity":new Gs(Df.paint_raster["raster-opacity"]),"raster-color":new Hs(Df.paint_raster["raster-color"]),"raster-color-mix":new Gs(Df.paint_raster["raster-color-mix"]),"raster-color-range":new Gs(Df.paint_raster["raster-color-range"]),"raster-hue-rotate":new Gs(Df.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Gs(Df.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Gs(Df.paint_raster["raster-brightness-max"]),"raster-saturation":new Gs(Df.paint_raster["raster-saturation"]),"raster-contrast":new Gs(Df.paint_raster["raster-contrast"]),"raster-resampling":new Gs(Df.paint_raster["raster-resampling"]),"raster-fade-duration":new Gs(Df.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Gs(Df.paint_raster["raster-emissive-strength"]),"raster-array-band":new Gs(Df.paint_raster["raster-array-band"]),"raster-elevation":new Gs(Df.paint_raster["raster-elevation"]),"raster-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(F){return!(F&&F._source instanceof Xm&&(F._source.onNorthPole||F._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(F){"raster-color"!==F&&"raster-color-range"!==F||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(F){if(!this.hasColorMap())return;if(!this._curRampRange)return;const Le=this._transitionablePaint._values["raster-color"].value.expression,[Oe,Fe]=F||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(Oe)&&isNaN(Fe)||Oe===this._curRampRange[0]&&Fe===this._curRampRange[1]||(this.colorRamp=dc({expression:Le,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:Oe,end:Fe}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[Oe,Fe])}}let ib,rb,nb,ob,sb;class ry extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:ib||(ib=new Xs({visibility:new Gs(Df["layout_raster-particle"].visibility)})),paint:rb||(rb=new Xs({"raster-particle-array-band":new Gs(Df["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Gs(Df["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Hs(Df["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Gs(Df["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Gs(Df["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Gs(Df["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Gs(Df["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Gs(Df["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe),this._updateColorRamp(),this.lastInvalidatedAt=rh.now()}onRemove(F){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(F){return!1}_handleSpecialPaintPropertyUpdate(F){"raster-particle-color"!==F&&"raster-particle-max-speed"!==F||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===F&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const F=this._transitionablePaint._values["raster-particle-color"].value.expression,Le=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=dc({expression:F,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:Le}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=rh.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class ny extends ma{constructor(F,Le){super(F,{},Le,null),this.implementation=F,F.slot&&(this.slot=F.slot)}is3D(F){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(F){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(F){this.implementation.onAdd&&this.implementation.onAdd(F,F.painter.context.gl)}onRemove(F){this.implementation.onRemove&&this.implementation.onRemove(F,F.painter.context.gl)}}function iy(F,Le,Oe){const Fe=[0,0,1],je=kl.quat.identity([]);return kl.quat.rotateY(je,je,Oe?-H(F)+Math.PI:H(F)),kl.quat.rotateX(je,je,-H(Le)),kl.vec3.transformQuat(Fe,Fe,je),kl.vec3.normalize(Fe,Fe)}function sy(F,Le){const Oe=oy(F.projection,F.zoom,F.width,F.height),Fe=function(F,Le,Oe,Fe,je){const qe=new ul(Oe.lng-180*ab,Oe.lat),He=new ul(Oe.lng+180*ab,Oe.lat),xt=F.project(qe.lng,qe.lat),jt=F.project(He.lng,He.lat),Gt=-Math.atan2(jt.y-xt.y,jt.x-xt.x),bi=Il.fromLngLat(Oe);bi.y=Q(bi.y,-1+ab,1-ab);const wi=bi.toLngLat(),qr=F.project(wi.lng,wi.lat),Xn=Il.fromLngLat(wi);Xn.x+=ab;const Yn=Xn.toLngLat(),yo=F.project(Yn.lng,Yn.lat),bo=cy(yo.x-qr.x,yo.y-qr.y,Gt),Do=Il.fromLngLat(wi);Do.y+=ab;const Ro=Do.toLngLat(),zs=F.project(Ro.lng,Ro.lat),Zs=cy(zs.x-qr.x,zs.y-qr.y,Gt),na=Math.abs(bo.x)/Math.abs(Zs.y),el=kl.mat4.identity([]);kl.mat4.rotateZ(el,el,-Gt*(1-(je?0:Fe)));const nl=kl.mat4.identity([]);return kl.mat4.scale(nl,nl,[1,1-(1-na)*Fe,1]),nl[4]=-Zs.x/Zs.y*Fe,kl.mat4.rotateZ(nl,nl,Gt),kl.mat4.multiply(nl,el,nl),nl}(F.projection,0,F.center,Oe,Le),je=ay(F);return kl.mat4.scale(Fe,Fe,[je,je,1]),Fe}function ay(F){const Le=F.projection,Oe=oy(F.projection,F.zoom,F.width,F.height),Fe=uy(Le,F.center),je=uy(Le,ul.convert(Le.center));return Math.pow(2,Fe*Oe+(1-Oe)*je)}function oy(F,Le,Oe,Fe,je=1/0){const qe=F.range;if(!qe)return 0;const He=Math.min(je,Math.max(Oe,Fe)),xt=Math.log(He/1024)/Math.LN2;return tt(qe[0]+xt,qe[1]+xt,Le)}const ab=1/4e4;function uy(F,Le){const Oe=Q(Le.lat,-e_,e_),Fe=new ul(Le.lng-180*ab,Oe),je=new ul(Le.lng+180*ab,Oe),qe=F.project(Fe.lng,Oe),He=F.project(je.lng,Oe),xt=Il.fromLngLat(Fe),jt=Il.fromLngLat(je),Gt=He.x-qe.x,bi=He.y-qe.y,wi=jt.x-xt.x,qr=jt.y-xt.y,Xn=Math.sqrt((wi*wi+qr*qr)/(Gt*Gt+bi*bi));return Math.log(Xn)/Math.LN2}function cy(F,Le,Oe){const Fe=Math.cos(Oe),je=Math.sin(Oe);return{x:F*Fe-Le*je,y:F*je+Le*Fe}}function hy(F,Le,Oe){kl.mat4.identity(F),kl.mat4.rotateZ(F,F,H(Le[2])),kl.mat4.rotateX(F,F,H(Le[0])),kl.mat4.rotateY(F,F,H(Le[1])),kl.mat4.scale(F,F,Oe),kl.mat4.multiply(F,F,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function py(F,Le,Oe,Fe,je,qe,He,xt){const jt=[Oe[0]-Le[0],Oe[1]-Le[1],0],Gt=[Fe[0]-Le[0],Fe[1]-Le[1],0];if(kl.vec3.length(jt)<1e-12||kl.vec3.length(Gt)<1e-12)return kl.quat.identity(F);const bi=kl.vec3.cross([],jt,Gt);kl.vec3.normalize(bi,bi),kl.vec3.subtract(Gt,Fe,Le),jt[2]=(qe-je)*xt,Gt[2]=(He-je)*xt;const wi=jt;return kl.vec3.cross(wi,jt,Gt),kl.vec3.normalize(wi,wi),kl.quat.rotationTo(F,bi,wi)}function fy(F,Le,Oe=!1){const Fe=$u(Le.zoom),je=function(F,Le,Oe){const Fe=Le.worldSize,je=[F[12],F[13],F[14]],qe=xl(je[1]/Fe),He=gl(je[0]/Fe),xt=kl.mat4.identity([]),jt=yl(1,qe)*Fe,Gt=yl(1,0)*Fe*wl(qe,Le.zoom),bi=1/Uu(Fe);let wi=Gt*bi;if(Oe){const F=oy(Le.projection,Le.zoom,Le.width,Le.height,1024);wi=bi*Le.projection.pixelSpaceConversion(Le.center.lat,Fe,F)}const qr=al(qe,He);kl.vec3.add(qr,qr,kl.vec3.scale([],kl.vec3.normalize([],qr),jt*wi*je[2]));const Xn=function(F){const Le=[F[0],F[1],F[2]];let Oe=[0,1,0];const Fe=kl.vec3.cross([],Oe,Le);return kl.vec3.cross(Oe,Le,Fe),0===kl.vec3.squaredLength(Oe)&&(Oe=[0,1,0],kl.vec3.cross(Fe,Le,Oe)),kl.vec3.normalize(Fe,Fe),kl.vec3.normalize(Oe,Oe),kl.vec3.normalize(Le,Le),[Fe[0],Fe[1],Fe[2],0,Oe[0],Oe[1],Oe[2],0,Le[0],Le[1],Le[2],0,F[0],F[1],F[2],1]}(qr);kl.mat4.scale(xt,xt,[wi,wi,wi*jt]),kl.mat4.translate(xt,xt,[-je[0],-je[1],-je[2]]);const Yn=kl.mat4.multiply([],Le.globeMatrix,Xn);return kl.mat4.multiply(Yn,Yn,xt),kl.mat4.multiply(Yn,Yn,F),Yn}(F,Le,Oe);if(Fe>0){const Oe=function(F,Le){const Oe=Le.worldSize,Fe=yl(1,0)*Oe*wl(Le.center.lat,Le.zoom)/Uu(Oe),je=yl(1,Le.center.lat)*Oe,qe=kl.mat4.identity([]);return kl.mat4.rotateY(qe,qe,H(Le.center.lng)),kl.mat4.rotateX(qe,qe,H(Le.center.lat)),kl.mat4.translate(qe,qe,[0,0,Tm]),kl.mat4.scale(qe,qe,[Fe,Fe,Fe*je]),kl.mat4.translate(qe,qe,[Le.point.x-.5*Oe,Le.point.y-.5*Oe,0]),kl.mat4.multiply(qe,qe,F),kl.mat4.multiply(qe,Le.globeMatrix,qe)}(F,Le);return function(F,Le,Oe){const n=(F,Le,Oe)=>{const Fe=kl.vec3.length(F),je=kl.vec3.length(Le),qe=Tu(F,Le,Oe);return kl.vec3.scale(qe,qe,1/kl.vec3.length(qe)*Ee(Fe,je,Oe))},Fe=n([F[0],F[1],F[2]],[Le[0],Le[1],Le[2]],Oe),je=n([F[4],F[5],F[6]],[Le[4],Le[5],Le[6]],Oe),qe=n([F[8],F[9],F[10]],[Le[8],Le[9],Le[10]],Oe),He=Tu([F[12],F[13],F[14]],[Le[12],Le[13],Le[14]],Oe);return[Fe[0],Fe[1],Fe[2],0,je[0],je[1],je[2],0,qe[0],qe[1],qe[2],0,He[0],He[1],He[2],1]}(je,Oe,Fe)}return je}function dy(F,Le,Oe,Fe){const je=Au.projectAabbCorners(Fe,Oe);let qe=Number.MAX_VALUE,He=-1;for(let F=0;F<je.length;++F){const Oe=je[F];Oe[0]=(.5*Oe[0]+.5)*Le.width,Oe[1]=(.5-.5*Oe[1])*Le.height,Oe[2]<qe&&(He=F,qe=Oe[2])}const o=F=>new ic(je[F][0],je[F][1]);let xt;switch(He){case 0:case 6:xt=[o(1),o(5),o(4),o(7),o(3),o(2),o(1)];break;case 1:case 7:xt=[o(0),o(4),o(5),o(6),o(2),o(3),o(0)];break;case 3:case 5:xt=[o(1),o(0),o(4),o(7),o(6),o(2),o(1)];break;default:xt=[o(1),o(5),o(6),o(7),o(3),o(0),o(1)]}if(Fl(F,xt))return qe}const lb=va([{name:"a_pos_3f",components:3,type:"Float32"}]),cb=va([{name:"a_color_3f",components:3,type:"Float32"}]),hb=va([{name:"a_color_4f",components:4,type:"Float32"}]),ub=va([{name:"a_uv_2f",components:2,type:"Float32"}]),db=va([{name:"a_normal_3f",components:3,type:"Float32"}]),pb=va([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),fb=va([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),mb={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class My{constructor(F,Le,Oe,Fe){this.message=(F?`${F}: `:"")+Oe,Fe&&(this.identifier=Fe),null!=Le&&Le.__line__&&(this.line=Le.__line__)}}function Ay(F,Le){const Oe=-1===F.indexOf("://");try{return new URL(F,Oe&&Le?"http://example.com":void 0),!0}catch(F){return!1}}class Iy{constructor(F,Le){this.feature=F,this.instancedDataOffset=Le,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Sy{constructor(){this.instancedDataArray=new Ja,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Py{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.layers=F.layers,this.layerIds=this.layers.map((F=>F.fqid)),this.projection=F.projection,this.index=F.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(F,Le){}populate(F,Le,Oe,Fe){this.tileToMeter=Al(Oe);const je=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:qe,id:He,index:xt,sourceLayerIndex:jt}of F){const F=null!=He?He:qe.properties&&qe.properties.hasOwnProperty("id")?qe.properties.id:void 0,Gt=Cl(qe,je);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),Gt,Oe))continue;const bi={id:F,sourceLayerIndex:jt,index:xt,geometry:je?Gt.geometry:Vl(qe,Oe,Fe),properties:qe.properties,type:qe.type,patterns:{}},wi=this.addFeature(bi,bi.geometry,Gt);wi&&Le.featureIndex.insert(qe,bi.geometry,xt,jt,this.index,this.instancesPerModel[wi].instancedDataArray.length,sp/32)}this.lookup=null}update(F,Le,Oe,Fe){for(const Le in this.instancesPerModel){const Oe=this.instancesPerModel[Le];for(const Le in F)Oe.idToFeaturesIndex.hasOwnProperty(Le)&&(this.evaluate(Oe.features[Oe.idToFeaturesIndex[Le]],F[Le],Oe,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let F=!1;for(const Le in this.instancesPerModel){const Oe=this.instancesPerModel[Le];for(const Le of Oe.features){const Fe=this.layers[0],je=Le.feature,qe=this.canonical,He=Fe.paint.get("model-rotation").evaluate(je,{},qe),xt=Fe.paint.get("model-scale").evaluate(je,{},qe),jt=Fe.paint.get("model-translation").evaluate(je,{},qe);kl.vec3.exactEquals(Le.rotation,He)&&kl.vec3.exactEquals(Le.scale,xt)&&kl.vec3.exactEquals(Le.translation,jt)||(this.evaluate(Le,Le.featureStates,Oe,!0),F=!0)}}return F}updateReplacement(F,Le,Oe,Fe){if(Le.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=Le.updateTime;const je=Le.getReplacementRegionsForTile(F.toUnwrapped(),!0);if(Yh(this.activeReplacements,je))return!1;this.activeReplacements=je;let qe=!1;for(const Le in this.instancesPerModel){const je=this.instancesPerModel[Le],He=je.instancedDataArray;for(const Le of je.features){const je=Le.instancedDataOffset,xt=Le.instancedDataCount;for(let Le=0;Le<xt;Le++){const xt=16*(Le+je);let jt=He.float32[xt+0];const Gt=jt>sp;jt=Gt?jt-sp:jt;const bi=Math.floor(jt),wi=He.float32[xt+1];let qr=!1;for(const Le of this.activeReplacements)if(!jh(Le,Oe,mb.Model,Fe)&&!(Le.min.x>bi||bi>Le.max.x||Le.min.y>wi||wi>Le.max.y)&&(qr=Jh(Kh(bi,wi,F.canonical,Le.footprintTileId.canonical),Le.footprint),qr))break;He.float32[xt]=qr?jt+sp:jt,qe=qe||qr!==Gt}}}return qe}isEmpty(){for(const F in this.instancesPerModel)if(0!==this.instancesPerModel[F].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(F){if(!this.uploaded)for(const Le in this.instancesPerModel){const Oe=this.instancesPerModel[Le];Oe.instancedDataArray.length<0||0===Oe.instancedDataArray.length||(Oe.instancedDataBuffer?Oe.instancedDataBuffer.updateData(Oe.instancedDataArray):Oe.instancedDataBuffer=F.createVertexBuffer(Oe.instancedDataArray,pb.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const F in this.instancesPerModel){const Le=this.instancesPerModel[F];0!==Le.instancedDataArray.length&&Le.instancedDataBuffer&&Le.instancedDataBuffer.destroy()}const F=this.layers[0].modelManager;if(F&&this.modelUris)for(const Le of this.modelUris)F.removeModel(Le,"")}addFeature(F,Le,Oe){const Fe=this.layers[0],je=Fe.layout.get("model-id").evaluate(Oe,{},this.canonical);if(!je)return pt(`modelId is not evaluated for layer ${Fe.id} and it is not going to get rendered.`),je;Ay(je,!1)&&(this.modelUris.includes(je)||this.modelUris.push(je)),this.instancesPerModel[je]||(this.instancesPerModel[je]=new Sy);const qe=this.instancesPerModel[je],He=qe.instancedDataArray,xt=new Iy(Oe,He.length);for(const F of Le)for(const Le of F){if(Le.x<0||Le.x>=sp||Le.y<0||Le.y>=sp)continue;const F=(this.lookupDim-1)/sp,Oe=this.lookupDim*(Le.y*F|0)+Le.x*F|0;if(this.lookup){if(0!==this.lookup[Oe])continue;this.lookup[Oe]=1}this.instanceCount++;const Fe=He.length;He.resize(Fe+1),qe.instancesEvaluatedElevation.push(0),He.float32[16*Fe]=Le.x,He.float32[16*Fe+1]=Le.y}return xt.instancedDataCount=qe.instancedDataArray.length-xt.instancedDataOffset,xt.instancedDataCount>0&&(F.id&&(qe.idToFeaturesIndex[F.id]=qe.features.length),qe.features.push(xt),this.evaluate(xt,{},qe,!1)),je}getModelUris(){return this.modelUris}evaluate(F,Le,Oe,Fe){const je=this.layers[0],qe=F.feature,He=this.canonical,xt=F.rotation=je.paint.get("model-rotation").evaluate(qe,Le,He),jt=F.scale=je.paint.get("model-scale").evaluate(qe,Le,He),Gt=F.translation=je.paint.get("model-translation").evaluate(qe,Le,He),bi=je.paint.get("model-color").evaluate(qe,Le,He);bi.a=je.paint.get("model-color-mix-intensity").evaluate(qe,Le,He);const wi=[];this.maxVerticalOffset<Gt[2]&&(this.maxVerticalOffset=Gt[2]),this.maxScale=Math.max(Math.max(this.maxScale,jt[0]),Math.max(jt[1],jt[2])),hy(wi,xt,jt);const qr=Math.round(100*bi.a)+bi.b/1.05;for(let Le=0;Le<F.instancedDataCount;++Le){const je=F.instancedDataOffset+Le,qe=16*je,xt=Oe.instancedDataArray.float32;let jt=0;Fe&&(jt=xt[qe+6]-Oe.instancesEvaluatedElevation[je]);const Xn=0|xt[qe+1];xt[qe]=(0|xt[qe])+bi.r/1.05,xt[qe+1]=Xn+bi.g/1.05,xt[qe+2]=qr,xt[qe+3]=1/(He.z>10?this.tileToMeter:Al(He,Xn)),xt[qe+4]=Gt[0],xt[qe+5]=Gt[1],xt[qe+6]=Gt[2]+jt,xt[qe+7]=wi[0],xt[qe+8]=wi[1],xt[qe+9]=wi[2],xt[qe+10]=wi[4],xt[qe+11]=wi[5],xt[qe+12]=wi[6],xt[qe+13]=wi[8],xt[qe+14]=wi[9],xt[qe+15]=wi[10],Oe.instancesEvaluatedElevation[je]=Gt[2]}}}let _b,gb;us(Py,"ModelBucket",{omit:["layers"]}),us(Sy,"PerModelAttributes"),us(Iy,"ModelFeature");const yb=64,xb={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function By(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt=!1){const bi=Oe.zoom,wi=Oe.project(Fe),qr=wl(Fe.lat,bi),Xn=1/qr;kl.mat4.identity(F),kl.mat4.translate(F,F,[wi.x+He[0]*Xn,wi.y+He[1]*Xn,He[2]]);let Yn=1,yo=1;const bo=Oe.worldSize;if(Gt){if("mercator"===Oe.projection.name){let F=0;Oe.elevation&&(F=Oe.elevation.getAtPointOrZero(new Il(wi.x/bo,wi.y/bo),0));const Le=kl.vec4.transformMat4([],[wi.x,wi.y,F,1],Oe.projMatrix)[3]/Oe.cameraToCenterDistance;Yn=Le,yo=Le*wl(Oe.center.lat,bi)}else if("globe"===Oe.projection.name){const Le=fy(F,Oe),je=kl.mat4.multiply([],Oe.projMatrix,Le),qe=[0,0,0,1];kl.vec4.transformMat4(qe,qe,je);const He=qe[3]/Oe.cameraToCenterDistance,xt=$u(bi),jt=Oe.projection.pixelsPerMeter(Fe.lat,bo)*wl(Fe.lat,bi),Gt=Oe.projection.pixelsPerMeter(Oe.center.lat,bo)*wl(Oe.center.lat,bi);Yn=He/Ee(jt,_l(Oe.center.lat),xt),yo=He*qr/jt,Yn*=Gt,yo*=Gt}}else Yn=Xn;kl.mat4.scale(F,F,[Yn,Yn,yo]);const Do=[...F],Ro=Le.orientation,zs=[];if(hy(zs,[Ro[0]+je[0],Ro[1]+je[1],Ro[2]+je[2]],qe),kl.mat4.multiply(F,Do,zs),xt&&Oe.elevation){let je=0;const qe=[];if(jt&&Oe.elevation){je=function(F,Le,Oe,Fe,je){const qe=Le.elevation;if(!qe)return 0;const He=Au.projectAabbCorners(Oe,Fe),xt=yl(1,je.lat)*Le.worldSize,jt=function(F,Le){const Oe=[0,0,1],Fe=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const je of Fe){const Fe=F[je.corners[0]],qe=F[je.corners[1]],He=F[je.corners[2]],xt=[qe[0]-Fe[0],qe[1]-Fe[1],Le*(qe[2]-Fe[2])],jt=kl.vec3.cross(xt,xt,[He[0]-Fe[0],He[1]-Fe[1],Le*(He[2]-Fe[2])]);kl.vec3.normalize(jt,jt),je.dotProductWithUp=kl.vec3.dot(jt,Oe)}return Fe.sort(((F,Le)=>F.dotProductWithUp-Le.dotProductWithUp)),Fe[0].corners}(He,xt),Gt=He[jt[0]],bi=He[jt[1]],wi=He[jt[2]],qr=He[jt[3]],Xn=qe.getAtPointOrZero(new Il(Gt[0]/Le.worldSize,Gt[1]/Le.worldSize),0),Yn=qe.getAtPointOrZero(new Il(bi[0]/Le.worldSize,bi[1]/Le.worldSize),0),yo=qe.getAtPointOrZero(new Il(wi[0]/Le.worldSize,wi[1]/Le.worldSize),0),bo=qe.getAtPointOrZero(new Il(qr[0]/Le.worldSize,qr[1]/Le.worldSize),0),Do=(Xn+bo)/2,Ro=(Yn+yo)/2;return Do>Ro?Yn<yo?py(F,bi,qr,Gt,Yn,bo,Xn,xt):py(F,wi,Gt,qr,yo,Xn,bo,xt):Xn<bo?py(F,Gt,bi,wi,Xn,Yn,yo,xt):py(F,qr,wi,bi,bo,yo,Yn,xt),Math.max(Do,Ro)}(qe,Oe,Le.aabb,F,Fe);const He=kl.mat4.fromQuat([],qe),xt=kl.mat4.multiply([],He,zs);kl.mat4.multiply(F,Do,xt)}else je=Oe.elevation.getAtPointOrZero(new Il(wi.x/bo,wi.y/bo),0);0!==je&&(F[14]+=je)}}function Vy(F,Le,Oe=!1){F.uploaded||(F.gfxTexture=new qm(Le,F.image,Oe?Le.gl.R8:Le.gl.RGBA8,{useMipmap:F.sampler.minFilter>=Le.gl.NEAREST_MIPMAP_NEAREST}),F.uploaded=!0,F.image=null)}function Cy(F,Le,Oe){F.indexBuffer=Le.createIndexBuffer(F.indexArray,!1,!0),F.vertexBuffer=Le.createVertexBuffer(F.vertexArray,lb.members,!1,!0),F.normalArray&&(F.normalBuffer=Le.createVertexBuffer(F.normalArray,db.members,!1,!0)),F.texcoordArray&&(F.texcoordBuffer=Le.createVertexBuffer(F.texcoordArray,ub.members,!1,!0)),F.colorArray&&(F.colorBuffer=Le.createVertexBuffer(F.colorArray,(12===F.colorArray.bytesPerElement?cb:hb).members,!1,!0)),F.featureArray&&(F.pbrBuffer=Le.createVertexBuffer(F.featureArray,fb.members,!0)),F.segments=xo.simpleSegment(0,0,F.vertexArray.length,F.indexArray.length);const Fe=F.material;Fe.pbrMetallicRoughness.baseColorTexture&&Vy(Fe.pbrMetallicRoughness.baseColorTexture,Le),Fe.pbrMetallicRoughness.metallicRoughnessTexture&&Vy(Fe.pbrMetallicRoughness.metallicRoughnessTexture,Le),Fe.normalTexture&&Vy(Fe.normalTexture,Le),Fe.occlusionTexture&&Vy(Fe.occlusionTexture,Le,Oe),Fe.emissionTexture&&Vy(Fe.emissionTexture,Le)}function Dy(F,Le,Oe){if(F.meshes)for(const Fe of F.meshes)Cy(Fe,Le,Oe);if(F.children)for(const Fe of F.children)Dy(Fe,Le,Oe)}function Ry(F){if(F.meshes)for(const Le of F.meshes)Le.indexArray.destroy(),Le.vertexArray.destroy(),Le.colorArray&&Le.colorArray.destroy(),Le.normalArray&&Le.normalArray.destroy(),Le.texcoordArray&&Le.texcoordArray.destroy(),Le.featureArray&&Le.featureArray.destroy();if(F.children)for(const Le of F.children)Ry(Le)}function Ly(F){if(F.meshes)for(const Oe of F.meshes)Oe.vertexBuffer&&(Oe.vertexBuffer.destroy(),Oe.indexBuffer.destroy(),Oe.normalBuffer&&Oe.normalBuffer.destroy(),Oe.texcoordBuffer&&Oe.texcoordBuffer.destroy(),Oe.colorBuffer&&Oe.colorBuffer.destroy(),Oe.pbrBuffer&&Oe.pbrBuffer.destroy(),Oe.segments.destroy(),Oe.material&&((Le=Oe.material).pbrMetallicRoughness.baseColorTexture&&Le.pbrMetallicRoughness.baseColorTexture.gfxTexture&&Le.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),Le.pbrMetallicRoughness.metallicRoughnessTexture&&Le.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&Le.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),Le.normalTexture&&Le.normalTexture.gfxTexture&&Le.normalTexture.gfxTexture.destroy(),Le.emissionTexture&&Le.emissionTexture.gfxTexture&&Le.emissionTexture.gfxTexture.destroy(),Le.occlusionTexture&&Le.occlusionTexture.gfxTexture&&Le.occlusionTexture.gfxTexture.destroy()));var Le;if(F.children)for(const Le of F.children)Ly(Le)}class Fy{constructor(F,Le,Oe){this._demTile=F,this._dem=this._demTile.dem,this._scale=Le,this._offset=Oe}static create(F,Le,Oe){const Fe=Oe||F.findDEMTileFor(Le);if(!Fe||!Fe.dem)return;const je=Fe.dem,qe=Fe.tileID,He=1<<Le.canonical.z-qe.canonical.z;return new Fy(Fe,je.dim/sp/He,[(Le.canonical.x/He-qe.canonical.x)*je.dim,(Le.canonical.y/He-qe.canonical.y)*je.dim])}tileCoordToPixel(F,Le){const Oe=Le*this._scale+this._offset[1],Fe=Math.floor(F*this._scale+this._offset[0]),je=Math.floor(Oe);return new ic(Fe,je)}getElevationAt(F,Le,Oe,Fe){const je=F*this._scale+this._offset[0],qe=Le*this._scale+this._offset[1],He=Math.floor(je),xt=Math.floor(qe),jt=this._dem;return Fe=!!Fe,Oe?Ee(Ee(jt.get(He,xt,Fe),jt.get(He,xt+1,Fe),qe-xt),Ee(jt.get(He+1,xt,Fe),jt.get(He+1,xt+1,Fe),qe-xt),je-He):jt.get(He,xt,Fe)}getElevationAtPixel(F,Le,Oe){return this._dem.get(F,Le,!!Oe)}getMeterToDEM(F){return(1<<this._demTile.tileID.canonical.z)*yl(1,F)*this._dem.stride}}const vb=new Float32Array(262144),bb=new Uint8Array(262144);function Uy(F){let Le=0;if(F.meshes)for(const Oe of F.meshes)Le=Math.max(Le,Oe.aabb.max[2]);if(F.children)for(const Oe of F.children)Le=Math.max(Le,Uy(Oe));return Le}function jy(F,Le,Oe){if(F.meshes)for(const Fe of F.meshes){if(Fe.aabb.min[0]===1/0)continue;const je=Au.applyTransform(Fe.aabb,F.matrix);Oe.insert(Le,je.min[0],je.min[1],je.max[0],je.max[1])}if(F.children)for(const Fe of F.children)jy(Fe,Le,Oe)}const wb=["","wall","door","roof","window","lamp","logo"];class $y{constructor(F){this.node=F,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:F.id,geometry:[],properties:{height:Uy(F)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let F=0;const Le=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const Oe of this.node.meshes)this.node.lightMeshIndex!==F&&(Oe.transformedAabb=Au.applyTransformFast(Oe.aabb,this.node.matrix),Le.encapsulate(Oe.transformedAabb)),F++;this.aabb=Le}return this.aabb}}class Gy{constructor(F,Le,Oe,Fe,je,qe,He){this.id=Oe,this.layers=F,this.layerIds=this.layers.map((F=>F.fqid)),this.stateDependentLayerIds=this.layers.filter((F=>F.isStateDependent())).map((F=>F.id)),this.modelTraits|=xb.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,Fe&&(this.modelTraits|=xb.HasMapboxMeshFeatures),je&&(this.modelTraits|=xb.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=qe,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const F of Le)this.nodesInfo.push(new $y(F)),jy(F,He.featureIndexArray.length,He.grid),He.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,He.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(F,Le){for(const Oe of this.getNodesInfo()){const Fe=Oe.node;Fe.footprint&&Le.push({footprint:Fe.footprint,id:F})}}update(F){const Le=0!==Object.keys(F).length;if(Le&&!this.stateDependentLayers.length)return;const Oe=Le?this.stateDependentLayers:this.layers;if(!$(F,this.states))for(const Le of Oe)this.evaluate(Le,F);this.states=structuredClone(F)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(F){if(!this.needsUpload)return;const Le=this.getNodesInfo();for(const Oe of Le){const Le=Oe.node;this.uploaded?this.updatePbrBuffer(Le):Dy(Le,F,!0)}for(const F of Le)Ry(F.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(F){let Le=!1;if(!F.meshes)return Le;for(const Oe of F.meshes)Oe.pbrBuffer&&(Oe.pbrBuffer.updateData(Oe.featureArray),Le=!0);return Le}needsReEvaluation(F,Le,Oe){const Fe=F.transform.projectionOptions,je=F.style.getBrightness(),qe=this.brightness!==je;if(!this.uploaded||this.dirty||Fe.name!==this.projection.name||Yy(Oe.paint.get("model-color").value,qe)||Yy(Oe.paint.get("model-color-mix-intensity").value,qe)||Yy(Oe.paint.get("model-roughness").value,qe)||Yy(Oe.paint.get("model-emissive-strength").value,qe)||Yy(Oe.paint.get("model-height-based-emissive-strength-multiplier").value,qe)){this.projection=Fe,this.brightness=je;const F=this.getNodesInfo();for(const Le of F)Le.state=null;return!0}return!1}evaluateScale(F,Le){if(F.transform.zoom===this.zoom)return;this.zoom=F.transform.zoom;const Oe=this.getNodesInfo(),Fe=this.id.canonical;for(const F of Oe){const Oe=F.feature;F.evaluatedScale=Le.paint.get("model-scale").evaluate(Oe,{},Fe)}}evaluate(F,Le){const Oe=this.getNodesInfo();for(const Fe of Oe){if(!Fe.node.meshes)continue;const Oe=Fe.feature,je=Le&&Le[Oe.id];if($(je,Fe.state))continue;Fe.state=structuredClone(je);const qe=Fe.node.meshes&&Fe.node.meshes[0].featureData,He=Fe.evaluatedColor[2],xt=Fe.evaluatedRMEA[2],jt=this.id.canonical;if(Fe.hasTranslucentParts=!1,qe){for(let Le=0;Le<wb.length;Le++){const qe=wb[Le];qe.length&&(Oe.properties.part=qe);const He=F.paint.get("model-color").evaluate(Oe,je,jt).toRenderColor(null),xt=F.paint.get("model-color-mix-intensity").evaluate(Oe,je,jt);Fe.evaluatedColor[Le]=[He.r,He.g,He.b,xt],Fe.evaluatedRMEA[Le][0]=F.paint.get("model-roughness").evaluate(Oe,je,jt),Fe.evaluatedRMEA[Le][2]=F.paint.get("model-emissive-strength").evaluate(Oe,je,jt),Fe.evaluatedRMEA[Le][3]=He.a,Fe.emissionHeightBasedParams[Le]=F.paint.get("model-height-based-emissive-strength-multiplier").evaluate(Oe,je,jt),!Fe.hasTranslucentParts&&He.a<1&&(Fe.hasTranslucentParts=!0)}delete Oe.properties.part,Xy(Fe,He!==Fe.evaluatedColor[2]||xt!==Fe.evaluatedRMEA[2],this.modelTraits)}else Fe.evaluatedRMEA[0][2]=F.paint.get("model-emissive-strength").evaluate(Oe,je,jt);Fe.evaluatedScale=F.paint.get("model-scale").evaluate(Oe,je,jt),this.updatePbrBuffer(Fe.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(F,Le,Oe,Fe){const je=F.findDEMTileFor(Oe);if(je&&(je.tileID.canonical!==this.terrainTile||Le!==this.terrainExaggeration)){if(je.dem&&je.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=je.tileID.overscaledZ;const Le=Fy.create(F,Oe,je);if(!Le)return;this.modelTraits&xb.HasMapboxMeshFeatures&&this.updateDEM(F,Le,Oe,Fe);for(const F of this.getNodesInfo()){const Oe=F.node;if(!Oe.footprint||!Oe.footprint.vertices||!Oe.footprint.vertices.length)continue;const Fe=Oe.footprint.vertices;let je=Le.getElevationAt(Fe[0].x,Fe[0].y,!0,!0);for(let F=1;F<Fe.length;F++)je=Math.min(je,Le.getElevationAt(Fe[F].x,Fe[F].y,!0,!0));Oe.elevation=je}}this.terrainTile=je.tileID.canonical,this.terrainExaggeration=Le}}updateDEM(F,Le,Oe,Fe){let je=Le._dem._modifiedForSources[Fe];if(void 0===je&&(Le._dem._modifiedForSources[Fe]=[],je=Le._dem._modifiedForSources[Fe]),je.includes(Oe.canonical))return;const qe=Le._dem.dim;je.push(Oe.canonical);let He=!1;for(const F of this.getNodesInfo()){const Oe=F.node;if(!Oe.footprint||!Oe.footprint.grid)continue;const Fe=Oe.footprint.grid,je=Le.tileCoordToPixel(Fe.min.x,Fe.min.y),xt=Le.tileCoordToPixel(Fe.max.x,Fe.max.y),jt=Math.min(Math.min(qe-xt.y,je.x),Math.min(je.y,qe-xt.x));if(jt<0)continue;const Gt=Q(jt,2,5);let bi=Math.max(0,je.x-Gt),wi=Math.max(0,je.y-Gt),qr=Math.min(xt.x+Gt,qe-1),Xn=Math.min(xt.y+Gt,qe-1);for(let F=wi;F<=Xn;++F)for(let Le=bi;Le<=qr;++Le)bb[F*qe+Le]=255;let Yn=0,yo=0;for(let F=0;F<Fe.cellsY;++F)for(let Oe=0;Oe<Fe.cellsX;++Oe){if(!Fe.cells[F*Fe.cellsX+Oe])continue;const je=Le.tileCoordToPixel(Fe.min.x+Oe/Fe.xScale,Fe.min.y+F/Fe.yScale),He=Le.tileCoordToPixel(Fe.min.x+(Oe+1)/Fe.xScale,Fe.min.y+(F+1)/Fe.yScale);for(let F=je.y;F<=Math.min(He.y+1,qe-1);++F)for(let Oe=je.x;Oe<=Math.min(He.x+1,qe-1);++Oe)255===bb[F*qe+Oe]&&(bb[F*qe+Oe]=0,Yn+=Le.getElevationAtPixel(Oe,F),yo++)}const bo=Yn/yo;bi=Math.max(1,je.x-Gt),wi=Math.max(1,je.y-Gt),qr=Math.min(xt.x+Gt,qe-2),Xn=Math.min(xt.y+Gt,qe-2),He=!0;for(let F=wi;F<=Xn;++F)for(let Oe=bi;Oe<=qr;++Oe)0===bb[F*qe+Oe]&&(vb[F*qe+Oe]=Le._dem.set(Oe,F,bo));for(let F=1;F<Gt;++F){bi=Math.max(1,je.x-F),wi=Math.max(1,je.y-F),qr=Math.min(xt.x+F,qe-2),Xn=Math.min(xt.y+F,qe-2);for(let Oe=wi;Oe<=Xn;++Oe)for(let Fe=bi;Fe<=qr;++Fe){const je=Oe*qe+Fe;if(255===bb[je]){let He=0,xt=0,jt=-1,bi=-1;for(let Le=-1;Le<=1;++Le)for(let je=-1;je<=1;++je){const Gt=(Oe+Le)*qe+Fe+je;if(bb[Gt]>=F)continue;const wi=vb[Gt],qr=Math.abs(wi);qr>xt&&(He=wi,xt=qr,jt=je,bi=Le)}if(xt>.1){const qe=1-(F+.5*Math.abs(jt*bi))/Gt;let xt=Le._dem.get(Fe,Oe)+He*qe;const wi=Le._dem.get(Fe+jt,Oe+bi),qr=Le._dem.get(Fe-jt,Oe-bi,!0);(xt-wi)*(xt-qr)>0&&(xt=(wi+qr)/2),vb[je]=Le._dem.set(Fe,Oe,xt),bb[je]=F}}}}}He&&(Le._demTile.needsDEMTextureUpload=!0,Le._dem._timestamp=rh.now())}setFilter(F){this.filter=F?Qs(F):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((F=>this.filter.filter(new Rs(this.id.overscaledZ),F.feature,this.id.canonical))):this.nodesInfo}destroy(){const F=this.getNodesInfo();for(const Le of F)Ry(Le.node),Ly(Le.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(F,Le){if(Le.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=Le.updateTime;const Oe=Le.getReplacementRegionsForTile(F.toUnwrapped()),Fe=this.getNodesInfo();for(let F=0;F<this.nodesInfo.length;F++){const Le=Fe[F].node;Fe[F].hiddenByReplacement=!!Le.footprint&&!Oe.find((F=>F.footprint===Le.footprint))}}getHeightAtTileCoord(F,Le){const Oe=this.getNodesInfo(),Fe=[],je=[0,0,0],qe=kl.mat4.identity([]);for(let He=0;He<this.nodesInfo.length;He++){const xt=Oe[He],jt=xt.node.meshes[0],Gt=jt.transformedAabb;if(F<Gt.min[0]||Le<Gt.min[1]||F>Gt.max[0]||Le>Gt.max[1])continue;if(!0===xt.node.hidden)return{height:1/0,maxHeight:xt.feature.properties.height,hidden:!1,verticalScale:xt.evaluatedScale[2]};kl.mat4.invert(qe,xt.node.matrix),je[0]=F,je[1]=Le,kl.vec3.transformMat4(je,je,qe);const bi=(je[0]-jt.aabb.min[0])/(jt.aabb.max[0]-jt.aabb.min[0])*yb|0,wi=Math.min(63,(je[1]-jt.aabb.min[1])/(jt.aabb.max[1]-jt.aabb.min[1])*yb|0)*yb+Math.min(63,bi),qr=jt.heightmap[wi];if(!(qr<0&&xt.node.footprint)){if(xt.hiddenByReplacement)return;return{height:qr,maxHeight:xt.feature.properties.height,hidden:!1,verticalScale:xt.evaluatedScale[2]}}if(xt.node.footprint.grid.query(new ic(F,Le),new ic(F,Le),Fe),Fe.length>0)return{height:void 0,maxHeight:xt.feature.properties.height,hidden:xt.hiddenByReplacement,verticalScale:xt.evaluatedScale[2]}}}}function Yy(F,Le){return!F.isLightConstant&&Le}function Hy(F,Le,Oe,Fe,je,qe,He,xt){let jt=(61440&Le|(61440&Le)>>4)>>8,Gt=(3840&Le|(3840&Le)>>4)>>4,bi=240&Le|(240&Le)>>4;Oe[3]>0&&(jt=Ee(jt,255*Oe[0],Oe[3]),Gt=Ee(Gt,255*Oe[1],Oe[3]),bi=Ee(bi,255*Oe[2],Oe[3]));const wi=jt<<8|Gt,qr=bi<<8|Math.floor(255*Fe[3]),Xn=function(F){const Le=Q(F,0,2);return Math.min(Math.round(.5*Le*255),255)}(Fe[2])<<8|15*Fe[0]<<4|15*Fe[1],Yn=Q(je[0],0,1),yo=Q(je[1],0,1),bo=Q(je[2],0,1),Do=Q(je[3],0,1);let Ro,zs,Zs,na;if(Yn!==yo&&He!==qe&&yo!==Yn){const F=He-qe;zs=1/(F*(yo-Yn)),Zs=-(qe+F*Yn)/(F*(yo-Yn));const Le=Q(je[4],-1,1);na=Math.pow(10,Le),Ro=255*bo<<8|255*Do}else Ro=65535,zs=0,Zs=1,na=1;if(F.emplaceBack(wi,qr,Xn,Ro,zs,Zs,na),xt){const F=xt.length;xt.clear();for(let Le=0;Le<F;Le++)xt.emplaceBack(wi,qr,Xn,Ro,zs,Zs,na)}}function Xy(F,Le,Oe){const Fe=F.node;let je=0;const qe=Oe&xb.HasMeshoptCompression;for(const Oe of Fe.meshes){if(Fe.lights&&Fe.lightMeshIndex===je)continue;if(!Oe.featureData)continue;Oe.featureArray=new Qa,Oe.featureArray.reserve(Oe.featureData.length);let He=Le;for(const Le of Oe.featureData){const je=qe?65535&Le:Le>>16&65535,xt=qe?Le>>16&65535:65535&Le,jt=(15&xt)<8?15&xt:0,Gt=F.evaluatedRMEA[jt],bi=F.evaluatedColor[jt],wi=F.emissionHeightBasedParams[jt];let qr;if(He&&2===jt&&Fe.lights&&(qr=new Qa,qr.resize(10*Fe.lights.length)),Hy(Oe.featureArray,je,bi,Gt,wi,Oe.aabb.min[2],Oe.aabb.max[2],qr),qr&&He){He=!1;const F=Fe.meshes[Fe.lightMeshIndex];F.featureArray=qr,F.featureArray._trim()}}Oe.featureArray._trim(),je++}}function Zy(F,Le,Oe,Fe){const je=1<<F.z;Le.lat=xl((Fe/sp+F.y)/je),Le.lng=gl((Oe/sp+F.x)/je)}us(Gy,"Tiled3dModelBucket",{omit:["layers"]}),us($y,"Tiled3dModelFeature");const Tb={circle:class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:r_||(r_=new Xs({"circle-sort-key":new Ys(Df.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Gs(Df.layout_circle["circle-elevation-reference"]),visibility:new Gs(Df.layout_circle.visibility)})),paint:n_||(n_=new Xs({"circle-radius":new Ys(Df.paint_circle["circle-radius"]),"circle-color":new Ys(Df.paint_circle["circle-color"]),"circle-blur":new Ys(Df.paint_circle["circle-blur"]),"circle-opacity":new Ys(Df.paint_circle["circle-opacity"]),"circle-translate":new Gs(Df.paint_circle["circle-translate"]),"circle-translate-anchor":new Gs(Df.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Gs(Df.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Gs(Df.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ys(Df.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ys(Df.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ys(Df.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Gs(Df.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe)}createBucket(F){return new Ll(F)}queryRadius(F){const Le=F;return Jl("circle-radius",this,Le)+Jl("circle-stroke-width",this,Le)+Ql(this.paint.get("circle-translate"))}queryIntersectsFeature(F,Le,Oe,Fe,je,qe,He,xt){const jt=eu(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),Gt=this.paint.get("circle-radius").evaluate(Le,Oe)+this.paint.get("circle-stroke-width").evaluate(Le,Oe);return Ju(F,Fe,qe,He,xt,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),jt,Gt)}getProgramIds(){return["circle"]}getDefaultProgramParams(F,Le,Oe){const Fe=Ku(this);return{config:new $o(this,{zoom:Le,lut:Oe}),defines:Fe,overrideFog:!1}}},heatmap:class extends ma{createBucket(F){return new nc(F)}constructor(F,Le,Oe,Fe){super(F,{layout:b_||(b_=new Xs({visibility:new Gs(Df.layout_heatmap.visibility)})),paint:w_||(w_=new Xs({"heatmap-radius":new Ys(Df.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ys(Df.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Gs(Df.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Hs(Df.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Gs(Df.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"heatmap-color"===F&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(F){return Jl("heatmap-radius",this,F)}queryIntersectsFeature(F,Le,Oe,Fe,je,qe,He,xt){const jt=this.paint.get("heatmap-radius").evaluate(Le,Oe);return Ju(F,Fe,qe,He,xt,!0,!0,new ic(0,0),jt)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(F,Le,Oe){return"heatmap"===F?{config:new $o(this,{zoom:Le,lut:Oe}),overrideFog:!1}:{}}},hillshade:class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:T_||(T_=new Xs({visibility:new Gs(Df.layout_hillshade.visibility)})),paint:S_||(S_=new Xs({"hillshade-illumination-direction":new Gs(Df.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Gs(Df.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Gs(Df.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Gs(Df.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Gs(Df.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Gs(Df.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Gs(Df.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(F,Le,Oe){return{overrideFog:!1}}},fill:class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:j_||(j_=new Xs({"fill-sort-key":new Ys(Df.layout_fill["fill-sort-key"]),visibility:new Gs(Df.layout_fill.visibility),"fill-elevation-reference":new Gs(Df.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Ys(Df.layout_fill["fill-construct-bridge-guard-rail"])})),paint:G_||(G_=new Xs({"fill-antialias":new Gs(Df.paint_fill["fill-antialias"]),"fill-opacity":new Ys(Df.paint_fill["fill-opacity"]),"fill-color":new Ys(Df.paint_fill["fill-color"]),"fill-outline-color":new Ys(Df.paint_fill["fill-outline-color"]),"fill-translate":new Gs(Df.paint_fill["fill-translate"]),"fill-translate-anchor":new Gs(Df.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ys(Df.paint_fill["fill-pattern"]),"fill-emissive-strength":new Gs(Df.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Ys(Df.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Ys(Df.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Ys(Df.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe)}getProgramIds(){const F=this.paint.get("fill-pattern"),Le=F&&F.constantOr(1),Oe=[Le?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&Oe.push(Le&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),Oe}getDefaultProgramParams(F,Le,Oe){return{config:new $o(this,{zoom:Le,lut:Oe}),overrideFog:!1}}recalculate(F,Le){super.recalculate(F,Le);const Oe=this.paint._values["fill-outline-color"];"constant"===Oe.value.kind&&void 0===Oe.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(F){return new _h(F)}queryRadius(){return Ql(this.paint.get("fill-translate"))}queryIntersectsFeature(F,Le,Oe,Fe,je,qe){return!F.queryGeometry.isAboveHorizon&&Nl(tu(F.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),Fe)}isTileClipped(){return 0===this.paint.get("fill-z-offset").constantOr(1)}is3D(F){if(0!==this.paint.get("fill-z-offset").constantOr(1))return!0;const Le=this.layout&&"none"!==this.layout.get("fill-elevation-reference");return null!=F?Le&&!F:Le}},"fill-extrusion":class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:pg||(pg=new Xs({visibility:new Gs(Df["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Gs(Df["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:fg||(fg=new Xs({"fill-extrusion-opacity":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Ys(Df["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Gs(Df["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new vp(F)}queryRadius(){return Ql(this.paint.get("fill-extrusion-translate"))}is3D(F){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=eu(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),bi=this.paint.get("fill-extrusion-height").evaluate(Le,Oe),wi=this.paint.get("fill-extrusion-base").evaluate(Le,Oe),qr=[0,0],Xn=xt&&qe.elevation,Yn=qe.elevation?qe.elevation.exaggeration():1,yo=F.tile.getBucket(this);if(Xn&&yo instanceof vp){const F=yo.centroidVertexArray,Le=jt+1;Le<F.length&&(qr[0]=F.geta_centroid_pos0(Le),qr[1]=F.geta_centroid_pos1(Le))}if(0===qr[0]&&1===qr[1])return!1;"globe"===qe.projection.name&&(Fe=Ep([Fe],[new ic(0,0),new ic(sp,sp)],F.tileID.canonical).map((F=>F.polygon)).flat());const bo=Xn?xt:null,[Do,Ro]=function(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi){return"globe"===F.projection.name?function(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi){const wi=[],qr=[],Xn=F.projection.upVectorScale(bi,F.center.lat,F.worldSize).metersToTile,Yn=[0,0,0,1],yo=[0,0,0,1],y=(F,Le,Oe,Fe)=>{F[0]=Le,F[1]=Oe,F[2]=Fe,F[3]=1},bo=Pp();Oe>0&&(Oe+=bo),Fe+=bo;for(const bo of Le){const Le=[],Do=[];for(const wi of bo){const qr=wi.x+je.x,bo=wi.y+je.y,Ro=F.projection.projectTilePoint(qr,bo,bi),zs=F.projection.upVector(bi,wi.x,wi.y);let Zs=Oe,na=Fe;if(He){const F=Cp(qr,bo,Oe,Fe,He,xt,jt,Gt);Zs+=F.base,na+=F.top}0!==Oe?y(Yn,Ro.x+zs[0]*Xn*Zs,Ro.y+zs[1]*Xn*Zs,Ro.z+zs[2]*Xn*Zs):y(Yn,Ro.x,Ro.y,Ro.z),y(yo,Ro.x+zs[0]*Xn*na,Ro.y+zs[1]*Xn*na,Ro.z+zs[2]*Xn*na),kl.vec3.transformMat4(Yn,Yn,qe),kl.vec3.transformMat4(yo,yo,qe),Le.push(new Rh(Yn[0],Yn[1],Yn[2])),Do.push(new Rh(yo[0],yo[1],yo[2]))}wi.push(Le),qr.push(Do)}return[wi,qr]}(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi):He?function(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=[],bi=[],wi=[0,0,0,1];for(const qr of F){const F=[],Xn=[];for(const Gt of qr){const bi=Gt.x+Fe.x,qr=Gt.y+Fe.y,Yn=Cp(bi,qr,Le,Oe,qe,He,xt,jt);wi[0]=bi,wi[1]=qr,wi[2]=Yn.base,wi[3]=1,kl.vec4.transformMat4(wi,wi,je),wi[3]=Math.max(wi[3],1e-5);const yo=new Rh(wi[0]/wi[3],wi[1]/wi[3],wi[2]/wi[3]);wi[0]=bi,wi[1]=qr,wi[2]=Yn.top,wi[3]=1,kl.vec4.transformMat4(wi,wi,je),wi[3]=Math.max(wi[3],1e-5);const bo=new Rh(wi[0]/wi[3],wi[1]/wi[3],wi[2]/wi[3]);F.push(yo),Xn.push(bo)}Gt.push(F),bi.push(Xn)}return[Gt,bi]}(Le,Oe,Fe,je,qe,He,xt,jt,Gt):function(F,Le,Oe,Fe,je){const qe=[],He=[],xt=je[8]*Le,jt=je[9]*Le,Gt=je[10]*Le,bi=je[11]*Le,wi=je[8]*Oe,qr=je[9]*Oe,Xn=je[10]*Oe,Yn=je[11]*Oe;for(const Le of F){const F=[],Oe=[];for(const qe of Le){const Le=qe.x+Fe.x,He=qe.y+Fe.y,yo=je[0]*Le+je[4]*He+je[12],bo=je[1]*Le+je[5]*He+je[13],Do=je[2]*Le+je[6]*He+je[14],Ro=je[3]*Le+je[7]*He+je[15],zs=yo+xt,Zs=bo+jt,na=Do+Gt,el=Math.max(Ro+bi,1e-5),nl=yo+wi,hl=bo+qr,pl=Do+Xn,bl=Math.max(Ro+Yn,1e-5);F.push(new Rh(zs/el,Zs/el,na/el)),Oe.push(new Rh(nl/bl,hl/bl,pl/bl))}qe.push(F),He.push(Oe)}return[qe,He]}(Le,Oe,Fe,je,qe)}(qe,Fe,wi,bi,Gt,He,bo,qr,Yn,qe.center.lat,F.tileID.canonical),zs=F.queryGeometry;return function(F,Le,Oe){let Fe=1/0;Nl(Oe,Le)&&(Fe=Vp(Oe,Le[0]));for(let je=0;je<Le.length;je++){const qe=Le[je],He=F[je];for(let F=0;F<qe.length-1;F++){const Le=qe[F],je=[Le,qe[F+1],He[F+1],He[F],Le];Fl(Oe,je)&&(Fe=Math.min(Fe,Vp(Oe,je)))}}return Fe!==1/0&&Fe}(Do,Ro,zs.isPointQuery()?zs.screenBounds:zs.screenGeometry)}},line:class extends ma{constructor(F,Le,Oe,Fe){const je=nf();super(F,je,Le,Oe,Fe),je.layout&&(this.layout=new $s(je.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(F){if("line-gradient"===F){const F=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=F._styleExpression&&F._styleExpression.expression instanceof Un,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(F,Le){super.recalculate(F,Le),this.paint._values["line-floorwidth"]=(()=>{if(zy)return zy;const F=nf();return zy=new sf(F.paint.properties["line-width"].specification),zy.useIntegerZoom=!0,zy})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,F)}createBucket(F){return new Yp(F)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(F,Le,Oe){const Fe=tf(this);return{config:new $o(this,{zoom:Le,lut:Oe}),defines:Fe,overrideFog:!1}}queryRadius(F){const Le=F,Oe=of(Jl("line-width",this,Le),Jl("line-gap-width",this,Le)),Fe=Jl("line-offset",this,Le);return Oe/2+Math.abs(Fe)+Ql(this.paint.get("line-translate"))}queryIntersectsFeature(F,Le,Oe,Fe,je,qe){if(F.queryGeometry.isAboveHorizon)return!1;const He=tu(F.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),qe.angle,F.pixelToTileUnitsFactor),xt=F.pixelToTileUnitsFactor/2*of(this.paint.get("line-width").evaluate(Le,Oe),this.paint.get("line-gap-width").evaluate(Le,Oe)),jt=this.paint.get("line-offset").evaluate(Le,Oe);return jt&&(Fe=function(F,Le){const Oe=[],Fe=new ic(0,0);for(let je=0;je<F.length;je++){const qe=F[je],He=[];for(let F=0;F<qe.length;F++){const Oe=qe[F],je=qe[F+1],xt=0===F?Fe:Oe.sub(qe[F-1])._unit()._perp(),jt=F===qe.length-1?Fe:je.sub(Oe)._unit()._perp(),Gt=xt._add(jt)._unit();Gt._mult(1/(Gt.x*jt.x+Gt.y*jt.y)),He.push(Gt._mult(Le)._add(Oe))}Oe.push(He)}return Oe}(Fe,jt*F.pixelToTileUnitsFactor)),function(F,Le,Oe){for(let Fe=0;Fe<Le.length;Fe++){const je=Le[Fe];if(F.length>=3)for(let Le=0;Le<je.length;Le++)if(Hl(F,je[Le]))return!0;if(Ul(F,je,Oe))return!0}return!1}(He,Fe,xt)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(F){return!this.hasElevatedBuckets}},symbol:Dm,background:class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:Wv||(Wv=new Xs({visibility:new Gs(Df.layout_background.visibility)})),paint:Kv||(Kv=new Xs({"background-pitch-alignment":new Gs(Df.paint_background["background-pitch-alignment"]),"background-color":new Gs(Df.paint_background["background-color"]),"background-pattern":new Gs(Df.paint_background["background-pattern"]),"background-opacity":new Gs(Df.paint_background["background-opacity"]),"background-emissive-strength":new Gs(Df.paint_background["background-emissive-strength"]),"background-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(F,Le,Oe){return{overrideFog:!1}}is3D(F){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:Wm,"raster-particle":ry,sky:class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:nb||(nb=new Xs({visibility:new Gs(Df.layout_sky.visibility)})),paint:ob||(ob=new Xs({"sky-type":new Gs(Df.paint_sky["sky-type"]),"sky-atmosphere-sun":new Gs(Df.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Gs(Df.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Gs(Df.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Gs(Df.paint_sky["sky-gradient-radius"]),"sky-gradient":new Hs(Df.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Gs(Df.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Gs(Df.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Gs(Df.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"sky-gradient"===F?this._updateColorRamp():"sky-atmosphere-sun"!==F&&"sky-atmosphere-halo-color"!==F&&"sky-atmosphere-color"!==F&&"sky-atmosphere-sun-intensity"!==F||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(F){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const Le=F.style.light.properties.get("position");return this._lightPosition.azimuthal!==Le.azimuthal||this._lightPosition.polar!==Le.polar}return!1}getCenter(F,Le){if("atmosphere"===this.paint.get("sky-type")){const Oe=this.paint.get("sky-atmosphere-sun"),Fe=!Oe,je=F.style.light,qe=je.properties.get("position");return Fe&&"viewport"===je.properties.get("anchor")&&pt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),Fe?iy(qe.azimuthal,90-qe.polar,Le):iy(Oe[0],90-Oe[1],Le)}const Oe=this.paint.get("sky-gradient-center");return iy(Oe[0],90-Oe[1],Le)}isSky(){return!0}markSkyboxValid(F){this._skyboxInvalidated=!1,this._lightPosition=F.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const F=this.paint.get("sky-type");return"atmosphere"===F?["skyboxCapture","skybox"]:"gradient"===F?["skyboxGradient"]:null}},slot:class extends ma{constructor(F,Le,Oe,Fe){super(F,{paint:sb||(sb=new Xs({}))},Le,null)}},model:class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:_b||(_b=new Xs({visibility:new Gs(Df.layout_model.visibility),"model-id":new Ys(Df.layout_model["model-id"])})),paint:gb||(gb=new Xs({"model-opacity":new Ys(Df.paint_model["model-opacity"]),"model-rotation":new Ys(Df.paint_model["model-rotation"]),"model-scale":new Ys(Df.paint_model["model-scale"]),"model-translation":new Ys(Df.paint_model["model-translation"]),"model-color":new Ys(Df.paint_model["model-color"]),"model-color-mix-intensity":new Ys(Df.paint_model["model-color-mix-intensity"]),"model-type":new Gs(Df.paint_model["model-type"]),"model-cast-shadows":new Gs(Df.paint_model["model-cast-shadows"]),"model-receive-shadows":new Gs(Df.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Gs(Df.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Ys(Df.paint_model["model-emissive-strength"]),"model-roughness":new Ys(Df.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Ys(Df.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Gs(Df.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Gs(Df.paint_model["model-front-cutoff"]),"model-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},Le,Oe,Fe),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new Py(F)}getProgramIds(){return["model"]}is3D(F){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(F){return F instanceof Gy?sp-1:0}queryIntersectsFeature(F,Le,Oe,Fe,je,qe){if(!this.modelManager)return!1;const He=this.modelManager,xt=F.tile.getBucket(this);if(!(xt&&xt instanceof Py))return!1;for(const Oe in xt.instancesPerModel){const Fe=xt.instancesPerModel[Oe],je=void 0!==Le.id?Le.id:Le.properties&&Le.properties.hasOwnProperty("id")?Le.properties.id:void 0;if(Fe.idToFeaturesIndex.hasOwnProperty(je)){const Le=Fe.features[Fe.idToFeaturesIndex[je]],jt=He.getModel(Oe,this.scope);if(!jt)return!1;let Gt=kl.mat4.create();const bi=new ul(0,0),wi=xt.canonical;let qr=Number.MAX_VALUE;for(let Oe=0;Oe<Le.instancedDataCount;++Oe){const je=16*(Le.instancedDataOffset+Oe),He=Fe.instancedDataArray.float32,xt=[He[je+4],He[je+5],He[je+6]];Zy(wi,bi,He[je],0|He[je+1]),By(Gt,jt,qe,bi,Le.rotation,Le.scale,xt,!1,!1,!1),"globe"===qe.projection.name&&(Gt=fy(Gt,qe));const Xn=kl.mat4.multiply([],qe.projMatrix,Gt),Yn=F.queryGeometry,yo=dy(Yn.isPointQuery()?Yn.screenBounds:Yn.screenGeometry,qe,Xn,jt.aabb);null!=yo&&(qr=Math.min(yo,qr))}return qr!==Number.MAX_VALUE&&qr}}return!1}_handleOverridablePaintPropertyUpdate(F,Le,Oe){return!(!this.layout||Le.isDataDriven()||Oe.isDataDriven()||"model-color"!==F&&"model-color-mix-intensity"!==F&&"model-rotation"!==F&&"model-scale"!==F&&"model-translation"!==F&&"model-emissive-strength"!==F)}_isPropertyZoomDependent(F){const Le=this._transitionablePaint._values[F];return null!=Le&&null!=Le.value&&null!=Le.value.expression&&Le.value.expression instanceof ts}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ma{constructor(F,Le,Oe,Fe){super(F,{layout:q_||(q_=new Xs({"clip-layer-types":new Gs(Df.layout_clip["clip-layer-types"]),"clip-layer-scope":new Gs(Df.layout_clip["clip-layer-scope"])})),paint:H_||(H_=new Xs({}))},Le,Oe,Fe)}recalculate(F,Le){super.recalculate(F,Le)}createBucket(F){return new Eh(F)}is3D(F){return!0}}};class Ky{constructor(F){this._callback=F,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class Jy{constructor(){this.tasks={},this.taskQueue=[],ot(["process"],this),this.invoker=new Ky(this.process),this.nextId=0}add(F,Le){const Oe=this.nextId++,Fe=function({type:F,isSymbolTile:Le,zoom:Oe}){return Oe=Oe||0,"message"===F?0:"maybePrepare"!==F||Le?"parseTile"!==F||Le?"parseTile"===F&&Le?300-Oe:"maybePrepare"===F&&Le?400-Oe:500:200-Oe:100-Oe}(Le);if(0===Fe){try{F()}finally{}return null}return this.tasks[Oe]={fn:F,metadata:Le,priority:Fe,id:Oe},this.taskQueue.push(Oe),this.invoker.trigger(),{cancel:()=>{delete this.tasks[Oe]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((F=>!!this.tasks[F])),!this.taskQueue.length)return;const F=this.pick();if(null===F)return;const Le=this.tasks[F];if(delete this.tasks[F],this.taskQueue.length&&this.invoker.trigger(),!Le)return;Le.fn()}finally{}}pick(){let F=null,Le=1/0;for(let Oe=0;Oe<this.taskQueue.length;Oe++){const Fe=this.tasks[this.taskQueue[Oe]];Fe.priority<Le&&(Le=Fe.priority,F=Oe)}if(null===F)return null;const Oe=this.taskQueue[F];return this.taskQueue.splice(F,1),Oe}remove(){this.invoker.remove()}}class Qy{constructor(F,Le,Oe){this.target=F,this.parent=Le,this.mapId=Oe,this.callbacks={},this.cancelCallbacks={},ot(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new Jy}send(F,Le,Oe,Fe,je=!1,qe){const He=Math.round(1e18*Math.random()).toString(36).substring(0,10);Oe&&(Oe.metadata=qe,this.callbacks[He]=Oe);const xt=new Set;return this.target.postMessage({id:He,type:F,hasCallback:!!Oe,targetMapId:Fe,mustQueue:je,sourceMapId:this.mapId,data:ps(Le,xt)},xt),{cancel:()=>{Oe&&delete this.callbacks[He],this.target.postMessage({id:He,type:"<cancel>",targetMapId:Fe,sourceMapId:this.mapId})}}}receive(F){const Le=F.data;if(!Le)return;const Oe=Le.id;if(Oe&&(!Le.targetMapId||this.mapId===Le.targetMapId))if("<cancel>"===Le.type){const F=this.cancelCallbacks[Oe];delete this.cancelCallbacks[Oe],F&&F.cancel()}else if(Le.mustQueue||yt()){const F=this.callbacks[Oe],Fe=this.scheduler.add((()=>this.processTask(Oe,Le)),F&&F.metadata||{type:"message"});Fe&&(this.cancelCallbacks[Oe]=Fe)}else this.processTask(Oe,Le)}processTask(F,Le){if(delete this.cancelCallbacks[F],"<response>"===Le.type){const Oe=this.callbacks[F];delete this.callbacks[F],Oe&&(Le.error?Oe(fs(Le.error)):Oe(null,fs(Le.data)))}else{const Oe=new Set,Fe=Le.hasCallback?(Le,Fe)=>{this.target.postMessage({id:F,type:"<response>",sourceMapId:this.mapId,error:Le?ps(Le):null,data:ps(Fe,Oe)},Oe)}:()=>{},je=fs(Le.data);if(this.parent[Le.type])this.parent[Le.type](Le.sourceMapId,je,Fe);else if(this.parent.getWorkerSource){const F=Le.type.split(".");this.parent.getWorkerSource(Le.sourceMapId,F[0],je.source,je.scope)[F[1]](je,Fe)}else Fe(new Error(`Could not find function ${Le.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var Sb={workerUrl:"",workerClass:null,workerParams:void 0};const Eb="mapboxgl_preloaded_worker_pool";class rg{constructor(){this.active={}}acquire(F,Le=rg.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<Le;)this.workers.push(null!=Sb.workerClass?new Sb.workerClass:new self.Worker(Sb.workerUrl,Sb.workerParams));return this.active[F]=!0,this.workers.slice()}release(F){delete this.active[F],this.workers&&0===this.numActive()&&(this.workers.forEach((F=>{F.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Eb]}numActive(){return Object.keys(this.active).length}}rg.workerCount=2;class ng{constructor(F,Le,Oe="Worker",Fe=rg.workerCount){this.workerPool=F,this.actors=[],this.currentActor=0,this.id=st();const je=this.workerPool.acquire(this.id,Fe);for(let F=0;F<je.length;F++){const Fe=new ng.Actor(je[F],Le,this.id);Fe.name=`${Oe} ${F}`,this.actors.push(Fe)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(F,Le,Oe){rt(this.actors,((Oe,Fe)=>{Oe.send(F,Le,Fe)}),Oe=Oe||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((F=>{F.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Mb,Ab;function ag(){return Mb||(Mb=new rg),Mb}ng.Actor=Qy;const Ib=new Se(0,0,0);var Cb=(F=>(F[F.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",F[F.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",F[F.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",F))(Cb||{}),Pb=(F=>(F[F.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",F[F.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",F[F.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",F[F.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",F))(Pb||{}),zb=(F=>(F[F.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",F[F.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",F[F.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",F[F.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",F[F.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",F))(zb||{}),Db=(F=>(F[F.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",F[F.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",F[F.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",F))(Db||{}),Rb=(F=>(F[F.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",F[F.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",F[F.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",F[F.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",F[F.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",F[F.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",F))(Rb||{}),Lb=(F=>(F[F.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",F[F.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",F[F.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",F))(Lb||{});function dg(F,Le,Oe){1===F&&Le.icons.push(function(F,Le){return function(F){if(F.usvg_tree.height||(F.usvg_tree.height=F.usvg_tree.width),!F.metadata)return F;const{metadata:Le}=F;if(Le.content_area){const{content_area:Oe}=Le;null==Oe.top&&(Oe.top=Oe.left),null==Oe.width&&(Oe.width=F.usvg_tree.width),null==Oe.height&&(Oe.height=Oe.width)}return Le.stretch_x&&Le.stretch_x.length&&mg(Le,"x"),Le.stretch_y&&Le.stretch_y.length&&mg(Le,"y"),F}(F.readFields(yg,{name:void 0},Le))}(Oe,Oe.readVarint()+Oe.pos))}function mg(F,Le){const Oe=[],Fe=F[`stretch_${Le}`];let je=null;for(let F=0;F<Fe.length;F++)null===je?je=0===Oe.length?Fe[0]:Oe[Oe.length-1][1]+Fe[F]:(Oe.push([je,je+Fe[F]]),je=null);F[`stretch_${Le}_areas`]=Oe}function yg(F,Le,Oe){1===F?Le.name=Oe.readString():2===F?Le.metadata=function(F,Le){return F.readFields(gg,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},Le)}(Oe,Oe.readVarint()+Oe.pos):3===F&&(Le.usvg_tree=function(F,Le){return F.readFields(bg,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},Le)}(Oe,Oe.readVarint()+Oe.pos),Le.data="usvg_tree")}function gg(F,Le,Oe){1===F?Le.stretch_x=Oe.readPackedVarint():2===F?Le.stretch_y=Oe.readPackedVarint():3===F?Le.content_area=function(F,Le){return F.readFields(xg,{left:0},Le)}(Oe,Oe.readVarint()+Oe.pos):4===F&&Le.variables.push(function(F,Le){return F.readFields(vg,{name:void 0},Le)}(Oe,Oe.readVarint()+Oe.pos))}function xg(F,Le,Oe){1===F?Le.left=Oe.readVarint():2===F?Le.width=Oe.readVarint():3===F?Le.top=Oe.readVarint():4===F&&(Le.height=Oe.readVarint())}function vg(F,Le,Oe){1===F?Le.name=Oe.readString():2===F&&(Le.rgb_color=Eg(Oe.readVarint()),Le.value="rgb_color")}function bg(F,Le,Oe){1===F?Le.width=Le.height=Oe.readVarint():2===F?Le.height=Oe.readVarint():3===F?Le.children.push(_g(Oe,Oe.readVarint()+Oe.pos)):4===F?Le.linear_gradients.push(function(F,Le){return F.readFields(kg,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},Le)}(Oe,Oe.readVarint()+Oe.pos)):5===F?Le.radial_gradients.push(function(F,Le){return F.readFields(Vg,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},Le)}(Oe,Oe.readVarint()+Oe.pos)):7===F?Le.clip_paths.push(function(F,Le){return F.readFields(Cg,{children:[]},Le)}(Oe,Oe.readVarint()+Oe.pos)):8===F&&Le.masks.push(function(F,Le){const Oe=F.readFields(Dg,{left:0,width:20,mask_type:1,children:[]},Le);return null==Oe.height&&(Oe.height=Oe.width),null==Oe.top&&(Oe.top=Oe.left),Oe}(Oe,Oe.readVarint()+Oe.pos))}function _g(F,Le){return F.readFields(wg,{},Le)}function wg(F,Le,Oe){1===F?(Le.group=function(F,Le){return F.readFields(Mg,{opacity:255,children:[]},Le)}(Oe,Oe.readVarint()+Oe.pos),Le.node="group"):2===F&&(Le.path=function(F,Le){return F.readFields(Sg,{paint_order:1,commands:[],step:1,diffs:[],rule:1},Le)}(Oe,Oe.readVarint()+Oe.pos),Le.node="path")}function Mg(F,Le,Oe){1===F?Le.transform=Ag(Oe,Oe.readVarint()+Oe.pos):2===F?Le.opacity=Oe.readVarint():5===F?Le.clip_path_idx=Oe.readVarint():6===F?Le.mask_idx=Oe.readVarint():7===F&&Le.children.push(_g(Oe,Oe.readVarint()+Oe.pos))}function Ag(F,Le){return F.readFields(Ig,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},Le)}function Ig(F,Le,Oe){1===F?Le.sx=Oe.readFloat():2===F?Le.ky=Oe.readFloat():3===F?Le.kx=Oe.readFloat():4===F?Le.sy=Oe.readFloat():5===F?Le.tx=Oe.readFloat():6===F&&(Le.ty=Oe.readFloat())}function Sg(F,Le,Oe){1===F?Le.fill=function(F,Le){return F.readFields(Pg,{rgb_color:Ib,paint:"rgb_color",opacity:255},Le)}(Oe,Oe.readVarint()+Oe.pos):2===F?Le.stroke=function(F,Le){return F.readFields(zg,{rgb_color:Ib,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},Le)}(Oe,Oe.readVarint()+Oe.pos):3===F?Le.paint_order=Oe.readVarint():5===F?Oe.readPackedVarint(Le.commands):6===F?Le.step=Oe.readFloat():7===F?Oe.readPackedSVarint(Le.diffs):8===F&&(Le.rule=Oe.readVarint())}function Pg(F,Le,Oe){1===F?(Le.rgb_color=Eg(Oe.readVarint()),Le.paint="rgb_color"):2===F?(Le.linear_gradient_idx=Oe.readVarint(),Le.paint="linear_gradient_idx"):3===F?(Le.radial_gradient_idx=Oe.readVarint(),Le.paint="radial_gradient_idx"):5===F&&(Le.opacity=Oe.readVarint())}function Eg(F){return new Se((F>>16&255)/255,(F>>8&255)/255,(255&F)/255,1)}function zg(F,Le,Oe){1===F?(Le.rgb_color=Eg(Oe.readVarint()),Le.paint="rgb_color"):2===F?(Le.linear_gradient_idx=Oe.readVarint(),Le.paint="linear_gradient_idx"):3===F?(Le.radial_gradient_idx=Oe.readVarint(),Le.paint="radial_gradient_idx"):5===F?Oe.readPackedFloat(Le.dasharray):6===F?Le.dashoffset=Oe.readFloat():7===F?Le.miterlimit=Oe.readFloat():8===F?Le.opacity=Oe.readVarint():9===F?Le.width=Oe.readFloat():10===F?Le.linecap=Oe.readVarint():11===F&&(Le.linejoin=Oe.readVarint())}function kg(F,Le,Oe){1===F?Le.transform=Ag(Oe,Oe.readVarint()+Oe.pos):2===F?Le.spread_method=Oe.readVarint():3===F?Le.stops.push(Tg(Oe,Oe.readVarint()+Oe.pos)):4===F?Le.x1=Oe.readFloat():5===F?Le.y1=Oe.readFloat():6===F?Le.x2=Oe.readFloat():7===F&&(Le.y2=Oe.readFloat())}function Tg(F,Le){return F.readFields(Bg,{offset:0,opacity:255,rgb_color:Ib},Le)}function Bg(F,Le,Oe){1===F?Le.offset=Oe.readFloat():2===F?Le.opacity=Oe.readVarint():3===F&&(Le.rgb_color=Eg(Oe.readVarint()))}function Vg(F,Le,Oe){1===F?Le.transform=Ag(Oe,Oe.readVarint()+Oe.pos):2===F?Le.spread_method=Oe.readVarint():3===F?Le.stops.push(Tg(Oe,Oe.readVarint()+Oe.pos)):4===F?Le.cx=Oe.readFloat():5===F?Le.cy=Oe.readFloat():6===F?Le.r=Oe.readFloat():7===F?Le.fx=Oe.readFloat():8===F?Le.fy=Oe.readFloat():9===F&&(Le.fr=Oe.readFloat())}function Cg(F,Le,Oe){1===F?Le.transform=Ag(Oe,Oe.readVarint()+Oe.pos):2===F?Le.clip_path_idx=Oe.readVarint():3===F&&Le.children.push(_g(Oe,Oe.readVarint()+Oe.pos))}function Dg(F,Le,Oe){1===F?Le.left=Le.top=Oe.readFloat():2===F?Le.width=Le.height=Oe.readFloat():3===F?Le.top=Oe.readFloat():4===F?Le.height=Oe.readFloat():5===F?Le.mask_type=Oe.readVarint():6===F?Le.mask_idx=Oe.readVarint():7===F&&Le.children.push(_g(Oe,Oe.readVarint()+Oe.pos))}class Rg{static calculate(F={},Le=[]){const Oe=new Map,Fe=new Map;if(0===Object.keys(F).length)return Oe;Le.forEach((F=>{Fe.set(F.name,F.rgb_color||new Se(0,0,0))}));for(const[Le,je]of Object.entries(F))Fe.has(Le)?Oe.set(Fe.get(Le).toStringPremultipliedAlpha(),je):console.warn(`Ignoring unknown image variable "${Le}"`);return Oe}}function Lg(F,Le=255,Oe){const Fe=Le/255,je=F.toStringPremultipliedAlpha(),qe=Oe.has(je)?Oe.get(je).clone():F.clone();return qe.a*=Fe,qe.toString()}function Fg(F,Le){if(!Vt()){const Oe=document.createElement("canvas");return Oe.width=F,Oe.height=Le,Oe}return new OffscreenCanvas(F,Le)}function Og(F,Le){const Oe=Rg.calculate(Le.params,F.metadata?F.metadata.variables:[]),Fe=F.usvg_tree,je=Fe.width,qe=Fe.height,He=Le.transform?Le.transform:new DOMMatrix,xt=Math.max(1,Math.round(je*He.a)),jt=Math.max(1,Math.round(qe*He.d)),Gt=new DOMMatrix([xt/je,0,0,jt/qe,0,0]),bi=Fg(xt,jt).getContext("2d");return Ng(bi,Gt,Fe,Fe,Oe),bi.getImageData(0,0,xt,jt)}function Ng(F,Le,Oe,Fe,je){for(const qe of Fe.children)Ug(F,Le,Oe,qe,je)}function Ug(F,Le,Oe,Fe,je){Fe.group?(F.save(),function(F,Le,Oe,Fe,je){const qe=null!=Fe.mask_idx?Oe.masks[Fe.mask_idx]:null,He=null!=Fe.clip_path_idx?Oe.clip_paths[Fe.clip_path_idx]:null;if(Fe.transform&&(Le=Wg(Fe.transform).preMultiplySelf(Le)),!function(F,Le,Oe){return 255!==F.opacity||Le||Oe}(Fe,null!=He,null!=qe))return void Ng(F,Le,Oe,Fe,je);const xt=Fg(F.canvas.width,F.canvas.height),jt=xt.getContext("2d");Ng(jt,Le,Oe,Fe,je),He&&Xg(jt,Le,Oe,He),qe&&Zg(jt,Le,Oe,qe,je),F.globalAlpha=Fe.opacity/255,F.drawImage(xt,0,0)}(F,Le,Oe,Fe.group,je),F.restore()):Fe.path&&(F.save(),function(F,Le,Oe,Fe,je){const qe=Kg(Fe);F.setTransform(Le),Fe.paint_order===Db.PAINT_ORDER_FILL_AND_STROKE?(jg(F,Oe,Fe,qe,je),$g(F,Oe,Fe,qe,je)):($g(F,Oe,Fe,qe,je),jg(F,Oe,Fe,qe,je))}(F,Le,Oe,Fe.path,je),F.restore())}function jg(F,Le,Oe,Fe,je){const qe=Oe.fill;if(!qe)return;const He=qe.opacity/255;switch(qe.paint){case"rgb_color":F.fillStyle=Lg(qe.rgb_color,qe.opacity,je);break;case"linear_gradient_idx":F.fillStyle=Gg(F,Le.linear_gradients[qe.linear_gradient_idx],He,je);break;case"radial_gradient_idx":F.fillStyle=Yg(F,Le.radial_gradients[qe.radial_gradient_idx],He,je)}F.fill(Fe,qg(Oe))}function qg(F){return F.rule===Cb.PATH_RULE_NON_ZERO?"nonzero":F.rule===Cb.PATH_RULE_EVEN_ODD?"evenodd":void 0}function $g(F,Le,Oe,Fe,je){const qe=Oe.stroke;if(!qe)return;F.lineWidth=qe.width,F.miterLimit=qe.miterlimit,F.setLineDash(qe.dasharray),F.lineDashOffset=qe.dashoffset;const He=qe.opacity/255;switch(qe.paint){case"rgb_color":F.strokeStyle=Lg(qe.rgb_color,qe.opacity,je);break;case"linear_gradient_idx":F.strokeStyle=Gg(F,Le.linear_gradients[qe.linear_gradient_idx],He,je);break;case"radial_gradient_idx":F.strokeStyle=Yg(F,Le.radial_gradients[qe.radial_gradient_idx],He,je)}switch(qe.linejoin){case zb.LINE_JOIN_MITER_CLIP:case zb.LINE_JOIN_MITER:F.lineJoin="miter";break;case zb.LINE_JOIN_ROUND:F.lineJoin="round";break;case zb.LINE_JOIN_BEVEL:F.lineJoin="bevel"}switch(qe.linecap){case Pb.LINE_CAP_BUTT:F.lineCap="butt";break;case Pb.LINE_CAP_ROUND:F.lineCap="round";break;case Pb.LINE_CAP_SQUARE:F.lineCap="square"}F.stroke(Fe)}function Gg(F,Le,Oe,Fe){if(1===Le.stops.length){const F=Le.stops[0];return Lg(F.rgb_color,F.opacity*Oe,Fe)}const je=Wg(Le.transform),{x1:qe,y1:He,x2:xt,y2:jt}=Le,Gt=je.transformPoint(new DOMPoint(qe,He)),bi=je.transformPoint(new DOMPoint(xt,jt)),wi=F.createLinearGradient(Gt.x,Gt.y,bi.x,bi.y);for(const F of Le.stops)wi.addColorStop(F.offset,Lg(F.rgb_color,F.opacity*Oe,Fe));return wi}function Yg(F,Le,Oe,Fe){if(1===Le.stops.length){const F=Le.stops[0];return Lg(F.rgb_color,F.opacity*Oe,Fe)}const je=Wg(Le.transform),{fx:qe,fy:He,cx:xt,cy:jt}=Le,Gt=je.transformPoint(new DOMPoint(qe,He)),bi=je.transformPoint(new DOMPoint(xt,jt)),wi=F.createRadialGradient(Gt.x,Gt.y,0,bi.x,bi.y,Le.r*((je.a+je.d)/2));for(const F of Le.stops)wi.addColorStop(F.offset,Lg(F.rgb_color,F.opacity*Oe,Fe));return wi}function Hg(F,Le,Oe,Fe){const je=Fe.transform?Wg(Fe.transform).preMultiplySelf(Le):Le,qe=Fg(F.canvas.width,F.canvas.height),He=qe.getContext("2d");for(const F of Fe.children)if(F.group)Hg(He,je,Oe,F.group);else if(F.path){const Le=F.path,Oe=new Path2D;Oe.addPath(Kg(Le),je),He.fill(Oe,qg(Le))}const xt=null!=Fe.clip_path_idx?Oe.clip_paths[Fe.clip_path_idx]:null;xt&&Xg(He,je,Oe,xt),F.globalCompositeOperation="source-over",F.drawImage(qe,0,0)}function Xg(F,Le,Oe,Fe){const je=Fg(F.canvas.width,F.canvas.height);Hg(je.getContext("2d"),Le,Oe,Fe),F.globalCompositeOperation="destination-in",F.drawImage(je,0,0)}function Zg(F,Le,Oe,Fe,je){if(0===Fe.children.length)return;const qe=null!=Fe.mask_idx?Oe.masks[Fe.mask_idx]:null;qe&&Zg(F,Le,Oe,qe,je);const He=F.canvas.width,xt=F.canvas.height,jt=Fg(He,xt),Gt=jt.getContext("2d"),bi=Fe.width,wi=Fe.height,qr=Fe.left,Xn=Fe.top,Yn=new Path2D,yo=new Path2D;yo.rect(qr,Xn,bi,wi),Yn.addPath(yo,Le),Gt.clip(Yn);for(const F of Fe.children)Ug(Gt,Le,Oe,F,je);const bo=Gt.getImageData(0,0,He,xt),Do=bo.data;if(Fe.mask_type===Lb.MASK_TYPE_LUMINANCE)for(let F=0;F<Do.length;F+=4)Do[F+3]=Do[F+3]/255*(.2126*Do[F]+.7152*Do[F+1]+.0722*Do[F+2]);Gt.putImageData(bo,0,0),F.globalCompositeOperation="destination-in",F.drawImage(jt,0,0)}function Wg(F){return F?new DOMMatrix([F.sx,F.ky,F.kx,F.sy,F.tx,F.ty]):new DOMMatrix}function Kg(F){const Le=new Path2D,Oe=F.step;let Fe=F.diffs[0]*Oe,je=F.diffs[1]*Oe;Le.moveTo(Fe,je);for(let qe=0,He=2;qe<F.commands.length;qe++)switch(F.commands[qe]){case Rb.PATH_COMMAND_MOVE:Fe+=F.diffs[He++]*Oe,je+=F.diffs[He++]*Oe,Le.moveTo(Fe,je);break;case Rb.PATH_COMMAND_LINE:Fe+=F.diffs[He++]*Oe,je+=F.diffs[He++]*Oe,Le.lineTo(Fe,je);break;case Rb.PATH_COMMAND_QUAD:{const qe=Fe+F.diffs[He++]*Oe,xt=je+F.diffs[He++]*Oe;Fe=qe+F.diffs[He++]*Oe,je=xt+F.diffs[He++]*Oe,Le.quadraticCurveTo(qe,xt,Fe,je);break}case Rb.PATH_COMMAND_CUBIC:{const qe=Fe+F.diffs[He++]*Oe,xt=je+F.diffs[He++]*Oe,jt=qe+F.diffs[He++]*Oe,Gt=xt+F.diffs[He++]*Oe;Fe=jt+F.diffs[He++]*Oe,je=Gt+F.diffs[He++]*Oe,Le.bezierCurveTo(qe,xt,jt,Gt,Fe,je);break}case Rb.PATH_COMMAND_CLOSE:Le.closePath()}return Le}class Jg{constructor(F){this.capacity=F,this.cache=new Map}get(F){if(!this.cache.has(F))return;const Le=this.cache.get(F);return this.cache.delete(F),this.cache.set(F,Le),Le}put(F,Le){this.cache.has(F)?this.cache.delete(F):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(F,Le)}delete(F){this.cache.delete(F)}}us(Jg,"LRUCache");class Qg{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(F){return new pc(F,F.data)}getFromCache(F,Le,Oe){return this.cacheMap.has(Oe)||this.cacheMap.set(Oe,new Jg(150)),this.cacheMap.get(Oe).get(pa(F.toString(),Le))}setInCache(F,Le,Oe,Fe){this.cacheDependenciesMap.has(Fe)||this.cacheDependenciesMap.set(Fe,new Map),this.cacheMap.has(Fe)||this.cacheMap.set(Fe,new Jg(150));const je=this.cacheDependenciesMap.get(Fe),qe=pa(F.id.toString(),Oe);je.get(qe)||je.set(qe,new Set);const He=this.cacheMap.get(Fe),xt=F.toString();je.get(qe).add(xt),He.put(pa(F.toString(),Oe),Le)}removeImagesFromCacheByIds(F,Le,Oe=0){if(!this.cacheMap.has(Oe)||!this.cacheDependenciesMap.has(Oe))return;const Fe=this.cacheMap.get(Oe),je=this.cacheDependenciesMap.get(Oe);for(const Oe of F){const F=pa(Oe.toString(),Le);if(je.has(F)){for(const Le of je.get(F))Fe.delete(Le);je.delete(F)}}}rasterize(F,Le,Oe,Fe,je=Og){const qe=this.getFromCache(F,Oe,Fe);if(qe)return qe.clone();const He=je(Le.icon,F.options),xt=Qg._getImage(He);return this.setInCache(F,xt,Oe,Fe),xt.clone()}}class tx{constructor(F){this.size=F,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(F,Le){const Oe=this.toIdx(F,Le);return{min:this.minimums[Oe],max:this.maximums[Oe]}}isLeaf(F,Le){return this.leaves[this.toIdx(F,Le)]}toIdx(F,Le){return Le*this.size+F}}function ex(F,Le,Oe,Fe){let je=0,qe=Number.MAX_VALUE;for(let He=0;He<3;He++)if(Math.abs(Fe[He])<1e-15){if(Oe[He]<F[He]||Oe[He]>Le[He])return null}else{const xt=1/Fe[He];let jt=(F[He]-Oe[He])*xt,Gt=(Le[He]-Oe[He])*xt;if(jt>Gt){const F=jt;jt=Gt,Gt=F}if(jt>je&&(je=jt),Gt<qe&&(qe=Gt),je>qe)return null}return je}function rx(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi){const wi=Fe-F,qr=je-Le,Xn=qe-Oe,Yn=He-F,yo=xt-Le,bo=jt-Oe,Do=bi[1]*bo-bi[2]*yo,Ro=bi[2]*Yn-bi[0]*bo,zs=bi[0]*yo-bi[1]*Yn,Zs=wi*Do+qr*Ro+Xn*zs;if(Math.abs(Zs)<1e-15)return null;const na=1/Zs,el=Gt[0]-F,nl=Gt[1]-Le,hl=Gt[2]-Oe,pl=(el*Do+nl*Ro+hl*zs)*na;if(pl<0||pl>1)return null;const bl=nl*Xn-hl*qr,Tl=hl*wi-el*Xn,kl=el*qr-nl*wi,ec=(bi[0]*bl+bi[1]*Tl+bi[2]*kl)*na;return ec<0||pl+ec>1?null:(Yn*bl+yo*Tl+bo*kl)*na}function nx(F,Le,Oe){return(F-Le)/(Oe-Le)}function ix(F,Le,Oe,Fe,je,qe,He,xt,jt){const Gt=1<<Oe,bi=qe-Fe,wi=He-je,qr=(F+1)/Gt*bi+Fe,Xn=(Le+0)/Gt*wi+je,Yn=(Le+1)/Gt*wi+je;xt[0]=(F+0)/Gt*bi+Fe,xt[1]=Xn,jt[0]=qr,jt[1]=Yn}class sx{constructor(F){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=F,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const Le=function(F){const Le=Math.ceil(Math.log2(F.dim/8)),Oe=[];let Fe=Math.ceil(Math.pow(2,Le));const je=1/Fe,s=(F,Le,Oe,Fe,je)=>{const qe=Fe?1:0,He=(F+1)*Oe-qe,xt=Le*Oe,jt=(Le+1)*Oe-qe;je[0]=F*Oe,je[1]=xt,je[2]=He,je[3]=jt};let qe=new tx(Fe);const He=[];for(let Le=0;Le<Fe*Fe;Le++){s(Le%Fe,Math.floor(Le/Fe),je,!1,He);const Oe=ox(He[0],He[1],F),xt=ox(He[2],He[1],F),jt=ox(He[2],He[3],F),Gt=ox(He[0],He[3],F);qe.minimums.push(Math.min(Oe,xt,jt,Gt)),qe.maximums.push(Math.max(Oe,xt,jt,Gt)),qe.leaves.push(1)}for(Oe.push(qe),Fe/=2;Fe>=1;Fe/=2){const F=Oe[Oe.length-1];qe=new tx(Fe);for(let Le=0;Le<Fe*Fe;Le++){s(Le%Fe,Math.floor(Le/Fe),2,!0,He);const Oe=F.getElevation(He[0],He[1]),je=F.getElevation(He[2],He[1]),xt=F.getElevation(He[2],He[3]),jt=F.getElevation(He[0],He[3]),Gt=F.isLeaf(He[0],He[1]),bi=F.isLeaf(He[2],He[1]),wi=F.isLeaf(He[2],He[3]),qr=F.isLeaf(He[0],He[3]),Xn=Math.min(Oe.min,je.min,xt.min,jt.min),Yn=Math.max(Oe.max,je.max,xt.max,jt.max),yo=Gt&&bi&&wi&&qr;qe.maximums.push(Yn),qe.minimums.push(Xn),qe.leaves.push(Yn-Xn<=5&&yo?1:0)}Oe.push(qe)}return Oe}(this.dem),Oe=Le.length-1,Fe=Le[Oe];this._addNode(Fe.minimums[0],Fe.maximums[0],Fe.leaves[0]),this._construct(Le,0,0,Oe,0)}raycastRoot(F,Le,Oe,Fe,je,qe,He=1){return ex([F,Le,-100],[Oe,Fe,this.maximums[0]*He],je,qe)}raycast(F,Le,Oe,Fe,je,qe,He=1){if(!this.nodeCount)return null;const xt=this.raycastRoot(F,Le,Oe,Fe,je,qe,He);if(null==xt)return null;const jt=[],Gt=[],bi=[],wi=[],qr=[{idx:0,t:xt,nodex:0,nodey:0,depth:0}];for(;qr.length>0;){const{idx:xt,t:Xn,nodex:Yn,nodey:yo,depth:bo}=qr.pop();if(this.leaves[xt]){ix(Yn,yo,bo,F,Le,Oe,Fe,bi,wi);const xt=1<<bo,jt=(Yn+0)/xt,Gt=(Yn+1)/xt,qr=(yo+0)/xt,Do=(yo+1)/xt,Ro=ox(jt,qr,this.dem)*He,zs=ox(Gt,qr,this.dem)*He,Zs=ox(Gt,Do,this.dem)*He,na=ox(jt,Do,this.dem)*He,el=rx(bi[0],bi[1],Ro,wi[0],bi[1],zs,wi[0],wi[1],Zs,je,qe),nl=rx(wi[0],wi[1],Zs,bi[0],wi[1],na,bi[0],bi[1],Ro,je,qe),hl=Math.min(null!==el?el:Number.MAX_VALUE,null!==nl?nl:Number.MAX_VALUE);if(hl!==Number.MAX_VALUE)return hl;{const F=kl.vec3.scaleAndAdd([],je,qe,Xn);if(ax(Ro,zs,na,Zs,nx(F[0],bi[0],wi[0]),nx(F[1],bi[1],wi[1]))>=F[2])return Xn}continue}let Do=0;for(let qr=0;qr<this._siblingOffset.length;qr++){ix((Yn<<1)+this._siblingOffset[qr][0],(yo<<1)+this._siblingOffset[qr][1],bo+1,F,Le,Oe,Fe,bi,wi),bi[2]=-100,wi[2]=this.maximums[this.childOffsets[xt]+qr]*He;const Xn=ex(bi,wi,je,qe);if(null!=Xn){const F=Xn;jt[qr]=F;let Le=!1;for(let Oe=0;Oe<Do&&!Le;Oe++)F>=jt[Gt[Oe]]&&(Gt.splice(Oe,0,qr),Le=!0);Le||(Gt[Do]=qr),Do++}}for(let F=0;F<Do;F++){const Le=Gt[F];qr.push({idx:this.childOffsets[xt]+Le,t:jt[Le],nodex:(Yn<<1)+this._siblingOffset[Le][0],nodey:(yo<<1)+this._siblingOffset[Le][1],depth:bo+1})}}return null}_addNode(F,Le,Oe){return this.minimums.push(F),this.maximums.push(Le),this.leaves.push(Oe),this.childOffsets.push(0),this.nodeCount++}_construct(F,Le,Oe,Fe,je){if(1===F[Fe].isLeaf(Le,Oe))return;this.childOffsets[je]||(this.childOffsets[je]=this.nodeCount);const qe=Fe-1,He=F[qe];let xt=0,jt=0;for(let F=0;F<this._siblingOffset.length;F++){const Fe=2*Le+this._siblingOffset[F][0],je=2*Oe+this._siblingOffset[F][1],qe=He.getElevation(Fe,je),Gt=He.isLeaf(Fe,je),bi=this._addNode(qe.min,qe.max,Gt);Gt&&(xt|=1<<F),jt||(jt=bi)}for(let Fe=0;Fe<this._siblingOffset.length;Fe++)xt&1<<Fe||this._construct(F,2*Le+this._siblingOffset[Fe][0],2*Oe+this._siblingOffset[Fe][1],qe,jt+Fe)}}function ax(F,Le,Oe,Fe,je,qe){return Ee(Ee(F,Oe,qe),Ee(Le,Fe,qe),je)}function ox(F,Le,Oe){const Fe=Oe.dim,je=Q(F*Fe-.5,0,Fe-1),qe=Q(Le*Fe-.5,0,Fe-1),He=Math.floor(je),xt=Math.floor(qe),jt=Math.min(He+1,Fe-1),Gt=Math.min(xt+1,Fe-1);return ax(Oe.get(He,xt),Oe.get(jt,xt),Oe.get(He,Gt),Oe.get(jt,Gt),je-He,qe-xt)}const Ob={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function ux(F,Le,Oe){return(256*F*256+256*Le+Oe)/10-1e4}function cx(F,Le,Oe){return 256*F+Le+Oe/256-32768}class hx{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(F,Le,Oe,Fe=!1){if(this.uid=F,Le.height!==Le.width)throw new RangeError("DEM tiles must be square");if(Oe&&"mapbox"!==Oe&&"terrarium"!==Oe)return void pt(`"${Oe}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=Le.height;const je=this.dim=Le.height-2,qe=new Uint32Array(Le.data.buffer);if(this.pixels=new Uint8Array(Le.data.buffer),this.floatView=new Float32Array(Le.data.buffer),this.borderReady=Fe,this._modifiedForSources={},!Fe){for(let F=0;F<je;F++)qe[this._idx(-1,F)]=qe[this._idx(0,F)],qe[this._idx(je,F)]=qe[this._idx(je-1,F)],qe[this._idx(F,-1)]=qe[this._idx(F,0)],qe[this._idx(F,je)]=qe[this._idx(F,je-1)];qe[this._idx(-1,-1)]=qe[this._idx(0,0)],qe[this._idx(je,-1)]=qe[this._idx(je-1,0)],qe[this._idx(-1,je)]=qe[this._idx(0,je-1)],qe[this._idx(je,je)]=qe[this._idx(je-1,je-1)]}const He="terrarium"===Oe?cx:ux;for(let F=0;F<qe.length;++F){const Le=4*F;this.floatView[F]=He(this.pixels[Le],this.pixels[Le+1],this.pixels[Le+2])}this._timestamp=rh.now()}_buildQuadTree(){this._tree=new sx(this)}get(F,Le,Oe=!1){Oe&&(F=Q(F,-1,this.dim),Le=Q(Le,-1,this.dim));const Fe=this._idx(F,Le);return this.floatView[Fe]}set(F,Le,Oe){const Fe=this._idx(F,Le),je=this.floatView[Fe];return this.floatView[Fe]=Oe,Oe-je}static getUnpackVector(F){return Ob[F]}_idx(F,Le){if(F<-1||F>=this.dim+1||Le<-1||Le>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(Le+1)*this.stride+(F+1)}static pack(F,Le){const Oe=[0,0,0,0],Fe=hx.getUnpackVector(Le);let je=Math.floor((F+Fe[3])/Fe[2]);return Oe[2]=je%256,je=Math.floor(je/256),Oe[1]=je%256,je=Math.floor(je/256),Oe[0]=je,Oe}getPixels(){return new fc({width:this.stride,height:this.stride},this.pixels)}backfillBorder(F,Le,Oe){if(this.dim!==F.dim)throw new Error("dem dimension mismatch");let Fe=Le*this.dim,je=Le*this.dim+this.dim,qe=Oe*this.dim,He=Oe*this.dim+this.dim;switch(Le){case-1:Fe=je-1;break;case 1:je=Fe+1}switch(Oe){case-1:qe=He-1;break;case 1:He=qe+1}const xt=-Le*this.dim,jt=-Oe*this.dim;for(let Le=qe;Le<He;Le++)for(let Oe=Fe;Oe<je;Oe++){const Fe=4*this._idx(Oe,Le),je=4*this._idx(Oe+xt,Le+jt);this.pixels[Fe+0]=F.pixels[je+0],this.pixels[Fe+1]=F.pixels[je+1],this.pixels[Fe+2]=F.pixels[je+2],this.pixels[Fe+3]=F.pixels[je+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function px(F,Le,Oe){1===F?Le.headerLength=Oe.readFixed32():2===F?Le.x=Oe.readVarint():3===F?Le.y=Oe.readVarint():4===F?Le.z=Oe.readVarint():5===F&&Le.layers.push(function(F,Le){return F.readFields(gx,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},Le)}(Oe,Oe.readVarint()+Oe.pos))}function fx(F,Le,Oe){1===F?(Le.delta_filter=function(F,Le){return F.readFields(dx,{blockSize:0},Le)}(Oe,Oe.readVarint()+Oe.pos),Le.filter="delta_filter"):2===F?(Oe.readVarint(),Le.filter="zigzag_filter"):3===F?(Oe.readVarint(),Le.filter="bitshuffle_filter"):4===F&&(Oe.readVarint(),Le.filter="byteshuffle_filter")}function dx(F,Le,Oe){1===F&&(Le.blockSize=Oe.readVarint())}function mx(F,Le,Oe){1===F?(Oe.readVarint(),Le.codec="gzip_data"):2===F?(Oe.readVarint(),Le.codec="jpeg_image"):3===F?(Oe.readVarint(),Le.codec="webp_image"):4===F&&(Oe.readVarint(),Le.codec="png_image")}function yx(F,Le,Oe){let Fe=0,je=0;1===F?Le.firstByte=Oe.readFixed64():2===F?Le.lastByte=Oe.readFixed64():3===F?Le.filters.push(function(F,Le){return F.readFields(fx,{},Le)}(Oe,Oe.readVarint()+Oe.pos)):4===F?Le.codec=function(F,Le){return F.readFields(mx,{},Le)}(Oe,Oe.readVarint()+Oe.pos):5===F?je=Oe.readFloat():6===F?Fe=Oe.readFloat():7===F?Le.bands.push(Oe.readString()):8===F?Le.offset=Oe.readDouble():9===F&&(Le.scale=Oe.readDouble()),0===Le.offset&&(Le.offset=je),0===Le.scale&&(Le.scale=Fe)}function gx(F,Le,Oe){1===F?Le.version=Oe.readVarint():2===F?Le.name=Oe.readString():3===F?Le.units=Oe.readString():4===F?Le.tileSize=Oe.readVarint():5===F?Le.buffer=Oe.readVarint():6===F?Le.pixelFormat=Oe.readVarint():7===F&&Le.dataIndex.push(function(F,Le){return F.readFields(yx,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},Le)}(Oe,Oe.readVarint()+Oe.pos))}function xx(F,Le,Oe){if(2===F)!function(F,Le,Oe){F.readFields(vx,Oe,Le)}(Oe,Oe.readVarint()+Oe.pos,Le);else if(3===F)throw new Error("Not implemented")}function vx(F,Le,Oe){if(1===F){let F=0;const Fe=Oe.readVarint()+Oe.pos;for(;Oe.pos<Fe;)Le[F++]=Oe.readVarint()}}function bx(F,Le){if(4!==Le.length)throw new Error(`Expected data of dimension 4 but got ${Le.length}.`);let Oe=Le[3];for(let Fe=2;Fe>=1;Fe--){const je=1===Fe?1:0,qe=2===Fe?1:0;for(let Fe=0;Fe<Le[0];Fe++){const He=Le[1]*Fe;for(let Fe=je;Fe<Le[1];Fe++){const je=Le[2]*(Fe+He);for(let Fe=qe;Fe<Le[2];Fe++){const qe=Le[3]*(Fe+je);for(let Fe=0;Fe<Le[3];Fe++){const Le=qe+Fe;F[Le]+=F[Le-Oe]}}}}Oe*=Le[Fe]}return F}function _x(F){for(let Le=0,Oe=F.length;Le<Oe;Le++)F[Le]=F[Le]>>>1^-(1&F[Le]);return F}function wx(F,Le){switch(Le){case"uint32":return F;case"uint16":for(let Le=0;Le<F.length;Le+=2){const Oe=F[Le],Fe=F[Le+1];F[Le]=(240&Oe)>>4|(61440&Oe)>>8|(240&Fe)<<4|61440&Fe,F[Le+1]=15&Oe|(3840&Oe)>>4|(15&Fe)<<8|(3840&Fe)<<4}return F;case"uint8":for(let Le=0;Le<F.length;Le+=4){const Oe=F[Le],Fe=F[Le+1],je=F[Le+2],qe=F[Le+3];F[Le+0]=(192&Oe)>>6|(192&Fe)>>4|(192&je)>>2|192&qe,F[Le+1]=(48&Oe)>>4|(48&Fe)>>2|48&je|(48&qe)<<2,F[Le+2]=(12&Oe)>>2|12&Fe|(12&je)<<2|(12&qe)<<4,F[Le+3]=3&Oe|(3&Fe)<<2|(3&je)<<4|(3&qe)<<6}return F;default:throw new Error(`Invalid pixel format, "${Le}"`)}}us(hx,"DEMData"),us(sx,"DemMinMaxQuadTree",{omit:["dem"]});var kb=Uint8Array,Fb=Uint16Array,Bb=Int32Array,Nb=new kb([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Vb=new kb([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ub=new kb([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),zx=function(F,Le){for(var Oe=new Fb(31),Fe=0;Fe<31;++Fe)Oe[Fe]=Le+=1<<F[Fe-1];var je=new Bb(Oe[30]);for(Fe=1;Fe<30;++Fe)for(var qe=Oe[Fe];qe<Oe[Fe+1];++qe)je[qe]=qe-Oe[Fe]<<5|Fe;return{b:Oe,r:je}},jb=zx(Nb,2),Gb=jb.b,qb=jb.r;Gb[28]=258,qb[258]=28;for(var Hb=zx(Vb,0).b,$b=new Fb(32768),Zb=0;Zb<32768;++Zb){var Wb=(43690&Zb)>>1|(21845&Zb)<<1;$b[Zb]=((65280&(Wb=(61680&(Wb=(52428&Wb)>>2|(13107&Wb)<<2))>>4|(3855&Wb)<<4))>>8|(255&Wb)<<8)>>1}var Lx=function(F,Le,Oe){for(var Fe=F.length,je=0,qe=new Fb(Le);je<Fe;++je)F[je]&&++qe[F[je]-1];var He,xt=new Fb(Le);for(je=1;je<Le;++je)xt[je]=xt[je-1]+qe[je-1]<<1;He=new Fb(1<<Le);var jt=15-Le;for(je=0;je<Fe;++je)if(F[je])for(var Gt=je<<4|F[je],bi=Le-F[je],wi=xt[F[je]-1]++<<bi,qr=wi|(1<<bi)-1;wi<=qr;++wi)He[$b[wi]>>jt]=Gt;return He},Xb=new kb(288);for(Zb=0;Zb<144;++Zb)Xb[Zb]=8;for(Zb=144;Zb<256;++Zb)Xb[Zb]=9;for(Zb=256;Zb<280;++Zb)Xb[Zb]=7;for(Zb=280;Zb<288;++Zb)Xb[Zb]=8;var Yb=new kb(32);for(Zb=0;Zb<32;++Zb)Yb[Zb]=5;var Kb=Lx(Xb,9),Jb=Lx(Yb,5),jx=function(F){for(var Le=F[0],Oe=1;Oe<F.length;++Oe)F[Oe]>Le&&(Le=F[Oe]);return Le},qx=function(F,Le,Oe){var Fe=Le/8|0;return(F[Fe]|F[Fe+1]<<8)>>(7&Le)&Oe},$x=function(F,Le){var Oe=Le/8|0;return(F[Oe]|F[Oe+1]<<8|F[Oe+2]<<16)>>(7&Le)},Qb=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Yx=function(F,Le,Oe){var Fe=new Error(Le||Qb[F]);if(Fe.code=F,Error.captureStackTrace&&Error.captureStackTrace(Fe,Yx),!Oe)throw Fe;return Fe},ew=new kb(0),tw="undefined"!=typeof TextDecoder&&new TextDecoder;try{tw.decode(ew,{stream:!0})}catch(Le){}const iw={gzip_data:"gzip"};class Wx extends Error{constructor(F){super(F),this.name="MRTError"}}const rw={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},nw={uint32:1,uint16:2,uint8:4},ow={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let sw;class ev{constructor(F=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=F}getLayer(F){const Le=this.layers[F];if(!Le)throw new Wx(`Layer '${F}' not found`);return Le}getHeaderLength(F){const Le=new Uint8Array(F),Oe=new DataView(F);if(13!==Le[0])throw new Wx("File is not a valid MRT.");return Oe.getUint32(1,!0)}parseHeader(F){const Le=new Uint8Array(F),Oe=this.getHeaderLength(F);if(Le.length<Oe)throw new Wx(`Expected header with length >= ${Oe} but got buffer of length ${Le.length}`);const Fe=function(F){return F.readFields(px,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0)}(new sw(Le.subarray(0,Oe)));if(!isNaN(this.x)&&(this.x!==Fe.x||this.y!==Fe.y||this.z!==Fe.z))throw new Wx(`Invalid attempt to parse header ${Fe.z}/${Fe.x}/${Fe.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=Fe.x,this.y=Fe.y,this.z=Fe.z;for(const F of Fe.layers)this.layers[F.name]=new rv(F,{cacheSize:this._cacheSize});return this}createDecodingTask(F){const Le=[],Oe=this.getLayer(F.layerName);for(let Fe of F.blockIndices){const je=Oe.dataIndex[Fe],qe=je.firstByte-F.firstByte,He=je.lastByte-F.firstByte;if(Oe._blocksInProgress.has(Fe))continue;const xt={layerName:Oe.name,firstByte:qe,lastByte:He,pixelFormat:Oe.pixelFormat,blockIndex:Fe,blockShape:[je.bands.length].concat(Oe.bandShape),buffer:Oe.buffer,codec:je.codec.codec,filters:je.filters.map((F=>F.filter))};Oe._blocksInProgress.add(Fe),Le.push(xt)}return new nv(Le,(()=>{Le.forEach((F=>Oe._blocksInProgress.delete(F.blockIndex)))}),((F,Fe)=>{if(Le.forEach((F=>Oe._blocksInProgress.delete(F.blockIndex))),F)throw F;Fe.forEach((F=>{this.getLayer(F.layerName).processDecodedData(F)}))}))}}class rv{constructor({version:F,name:Le,units:Oe,tileSize:Fe,pixelFormat:je,buffer:qe,dataIndex:He},xt){if(this.version=F,1!==this.version)throw new Wx(`Cannot parse raster layer encoded with MRT version ${F}`);this.name=Le,this.units=Oe,this.tileSize=Fe,this.buffer=qe,this.pixelFormat=rw[je],this.dataIndex=He,this.bandShape=[Fe+2*qe,Fe+2*qe,nw[this.pixelFormat]],this._decodedBlocks=new Jg(xt?xt.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return nw[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:F})=>F)).flat()}processDecodedData(F){const Le=F.blockIndex.toString();this._decodedBlocks.get(Le)||this._decodedBlocks.put(Le,F.data)}getBlockForBand(F){let Le=0;switch(typeof F){case"string":for(const[Oe,Fe]of this.dataIndex.entries()){for(const[je,qe]of Fe.bands.entries())if(qe===F)return{bandIndex:Le+je,blockIndex:Oe,blockBandIndex:je};Le+=Fe.bands.length}break;case"number":for(const[Oe,Fe]of this.dataIndex.entries()){if(F>=Le&&F<Le+Fe.bands.length)return{bandIndex:F,blockIndex:Oe,blockBandIndex:F-Le};Le+=Fe.bands.length}break;default:throw new Wx(`Invalid band \`${JSON.stringify(F)}\`. Expected string or integer.`)}throw new Wx(`Band not found: ${JSON.stringify(F)}`)}getDataRange(F){let Le=1/0,Oe=-1/0;const Fe=[],je=new Set;for(const qe of F){const{blockIndex:F}=this.getBlockForBand(qe);if(F<0)throw new Wx(`Invalid band: ${JSON.stringify(qe)}`);const He=this.dataIndex[F];Fe.includes(F)||Fe.push(F),je.add(F),Le=Math.min(Le,He.firstByte),Oe=Math.max(Oe,He.lastByte)}if(je.size>this.cacheSize)throw new Wx(`Number of blocks to decode (${je.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:Le,lastByte:Oe,blockIndices:Fe}}hasBand(F){const{blockIndex:Le}=this.getBlockForBand(F);return Le>=0}hasDataForBand(F){const{blockIndex:Le}=this.getBlockForBand(F);return Le>=0&&!!this._decodedBlocks.get(Le.toString())}getBandView(F){const{blockIndex:Le,blockBandIndex:Oe}=this.getBlockForBand(F),Fe=this._decodedBlocks.get(Le.toString());if(!Fe)throw new Wx(`Data for band ${JSON.stringify(F)} of layer "${this.name}" not decoded.`);const je=this.dataIndex[Le],qe=this.bandShape.reduce(((F,Le)=>F*Le),1),He=Oe*qe,xt=Fe.subarray(He,He+qe);return{data:xt,bytes:new Uint8Array(xt.buffer).subarray(xt.byteOffset,xt.byteOffset+xt.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:je.offset,scale:je.scale}}}ev.setPbf=function(F){sw=F};class nv{constructor(F,Le,Oe){this.tasks=F,this._onCancel=Le,this._onComplete=Oe,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(F,Le){this._finalized||(this._onComplete(F,Le),this._finalized=!0)}}ev.performDecoding=function(F,Le){const Oe=new Uint8Array(F);return Promise.all(Le.tasks.map((F=>{const{layerName:Le,firstByte:Fe,lastByte:je,pixelFormat:qe,blockShape:He,blockIndex:xt,filters:jt,codec:Gt}=F,bi=Oe.subarray(Fe,je+1),wi=new Uint32Array(He[0]*He[1]*He[2]);let qr;if("gzip_data"!==Gt)throw new Wx(`Unhandled codec: ${Gt}`);return qr=function(F,Le){if(!globalThis.DecompressionStream&&"gzip_data"===Le)return Promise.resolve(((qe=function(F){31==F[0]&&139==F[1]&&8==F[2]||Yx(6,"invalid gzip data");var Le=F[3],Oe=10;4&Le&&(Oe+=2+(F[10]|F[11]<<8));for(var Fe=(Le>>3&1)+(Le>>4&1);Fe>0;Fe-=!F[Oe++]);return Oe+(2&Le)}(je=F))+8>je.length&&Yx(6,"invalid gzip data"),function(F,Le,Oe){var Fe=F.length;if(!Fe||Le.f&&!Le.l)return Oe||new kb(0);var je=!Oe,qe=je||2!=Le.i,He=Le.i;je&&(Oe=new kb(3*Fe));var xt,jt,c=function(F){var Le=Oe.length;if(F>Le){var Fe=new kb(Math.max(2*Le,F));Fe.set(Oe),Oe=Fe}},Gt=Le.f||0,bi=Le.p||0,wi=Le.b||0,qr=Le.l,Xn=Le.d,Yn=Le.m,yo=Le.n,bo=8*Fe;do{if(!qr){Gt=qx(F,bi,1);var Do=qx(F,bi+1,3);if(bi+=3,!Do){var Ro=F[(ec=4+((bi+7)/8|0))-4]|F[ec-3]<<8,zs=ec+Ro;if(zs>Fe){He&&Yx(0);break}qe&&c(wi+Ro),Oe.set(F.subarray(ec,zs),wi),Le.b=wi+=Ro,Le.p=bi=8*zs,Le.f=Gt;continue}if(1==Do)qr=Kb,Xn=Jb,Yn=9,yo=5;else if(2==Do){var Zs=qx(F,bi,31)+257,na=qx(F,bi+10,15)+4,el=Zs+qx(F,bi+5,31)+1;bi+=14;for(var nl=new kb(el),hl=new kb(19),pl=0;pl<na;++pl)hl[Ub[pl]]=qx(F,bi+3*pl,7);bi+=3*na;var bl=jx(hl),Tl=(1<<bl)-1,kl=Lx(hl,bl);for(pl=0;pl<el;){var ec,tc=kl[qx(F,bi,Tl)];if(bi+=15&tc,(ec=tc>>4)<16)nl[pl++]=ec;else{var ic=0,oc=0;for(16==ec?(oc=3+qx(F,bi,3),bi+=2,ic=nl[pl-1]):17==ec?(oc=3+qx(F,bi,7),bi+=3):18==ec&&(oc=11+qx(F,bi,127),bi+=7);oc--;)nl[pl++]=ic}}var sc=nl.subarray(0,Zs),ac=nl.subarray(Zs);Yn=jx(sc),yo=jx(ac),qr=Lx(sc,Yn),Xn=Lx(ac,yo)}else Yx(1);if(bi>bo){He&&Yx(0);break}}qe&&c(wi+131072);for(var mc=(1<<Yn)-1,gc=(1<<yo)-1,yc=bi;;yc=bi){var xc=(ic=qr[$x(F,bi)&mc])>>4;if((bi+=15&ic)>bo){He&&Yx(0);break}if(ic||Yx(2),xc<256)Oe[wi++]=xc;else{if(256==xc){yc=bi,qr=null;break}var Zc=xc-254;xc>264&&(Zc=qx(F,bi,(1<<(Jc=Nb[pl=xc-257]))-1)+Gb[pl],bi+=Jc);var Wc=Xn[$x(F,bi)&gc],Kc=Wc>>4;if(Wc||Yx(3),bi+=15&Wc,ac=Hb[Kc],Kc>3){var Jc=Vb[Kc];ac+=$x(F,bi)&(1<<Jc)-1,bi+=Jc}if(bi>bo){He&&Yx(0);break}qe&&c(wi+131072);var Qc=wi+Zc;if(wi<ac){var eh=0-ac,th=Math.min(ac,Qc);for(eh+wi<0&&Yx(3);wi<th;++wi)Oe[wi]=(void 0)[eh+wi]}for(;wi<Qc;++wi)Oe[wi]=Oe[wi-ac]}}Le.l=qr,Le.p=yc,Le.b=wi,Le.f=Gt,qr&&(Gt=1,Le.m=Yn,Le.d=Xn,Le.n=yo)}while(!Gt);return wi!=Oe.length&&je?(xt=Oe,(null==(jt=wi)||jt>xt.length)&&(jt=xt.length),new kb(xt.subarray(0,jt))):Oe.subarray(0,wi)}(je.subarray(qe,-8),{i:2},new kb(((Oe=je)[(Fe=Oe.length)-4]|Oe[Fe-3]<<8|Oe[Fe-2]<<16|Oe[Fe-1]<<24)>>>0))));var Oe,Fe,je,qe;const He=iw[Le];if(!He)throw new Error(`Unhandled codec: ${Le}`);const xt=new globalThis.DecompressionStream(He);return new Response(new Blob([F]).stream().pipeThrough(xt)).arrayBuffer().then((F=>new Uint8Array(F)))}(bi,Gt).then((F=>(function(F,Le){F.readFields(xx,Le)}(new sw(F),wi),new(0,ow[qe])(wi.buffer)))),qr.then((F=>{for(let Le=jt.length-1;Le>=0;Le--)switch(jt[Le]){case"delta_filter":bx(F,He);break;case"zigzag_filter":_x(F);break;case"bitshuffle_filter":wx(F,qe);break;default:throw new Wx(`Unhandled filter "${jt[Le]}"`)}return{layerName:Le,blockIndex:xt,data:F}})).catch((F=>{throw F}))})))},us(nv,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),us(ev,"MapboxRasterTile"),us(rv,"MapboxRasterLayer",{omit:["_blocksInProgress"]});let aw,lw,cw,hw,uw,dw=null;function cv(){return yt()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:lw||Zc.DRACO_URL}function hv(){if(yt()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(hw)return hw;const F=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return hw=WebAssembly.validate(F)?Zc.MESHOPT_SIMD_URL:Zc.MESHOPT_URL,hw}const pw={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},fw={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},mw={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function mv(F,Le,Oe){const Fe=Oe.json.bufferViews.length,je=Oe.buffers.length;Le.bufferView=Fe,Oe.json.bufferViews[Fe]={buffer:je,byteLength:F.byteLength},Oe.buffers[je]=F}const _w="KHR_draco_mesh_compression";function gv(F,Le){const Oe=F.extensions&&F.extensions[_w];if(!Oe)return;const Fe=new cw.Decoder,je=Av(Le,Oe.bufferView),qe=new cw.Mesh;if(!Fe.DecodeArrayToMesh(je,je.byteLength,qe))throw new Error("Failed to decode Draco mesh");const He=Le.json.accessors[F.indices],xt=pw[He.componentType],jt=He.count*xt.BYTES_PER_ELEMENT,Gt=cw._malloc(jt);xt===Uint16Array?Fe.GetTrianglesUInt16Array(qe,jt,Gt):Fe.GetTrianglesUInt32Array(qe,jt,Gt),mv(cw.memory.buffer.slice(Gt,Gt+jt),He,Le),cw._free(Gt);for(const je of Object.keys(Oe.attributes)){const He=Fe.GetAttributeByUniqueId(qe,Oe.attributes[je]),xt=Le.json.accessors[F.attributes[je]],jt=fw[xt.componentType],Gt=xt.count*mw[xt.type]*pw[xt.componentType].BYTES_PER_ELEMENT,bi=cw._malloc(Gt);Fe.GetAttributeDataArrayForAllPoints(qe,He,cw[jt],Gt,bi),mv(cw.memory.buffer.slice(bi,bi+Gt),xt,Le),cw._free(bi)}Fe.destroy(),qe.destroy(),delete F.extensions[_w]}const gw="EXT_meshopt_compression";function vv(F,Le){if(!F.extensions||!F.extensions[gw])return;const Oe=F.extensions[gw],Fe=new Uint8Array(Le.buffers[Oe.buffer],Oe.byteOffset||0,Oe.byteLength||0),je=new Uint8Array(Oe.count*Oe.byteStride);uw.decodeGltfBuffer(je,Oe.count,Oe.byteStride,Fe,Oe.mode,Oe.filter),F.buffer=Le.buffers.length,F.byteOffset=0,Le.buffers[F.buffer]=je.buffer,delete F.extensions[gw]}const yw=1179937895,xw=new TextDecoder("utf8");function wv(F,Le){return new URL(F,Le).href}function Mv(F,Le,Oe,Fe){return fetch(wv(F.uri,Fe)).then((F=>F.arrayBuffer())).then((F=>{Le.buffers[Oe]=F}))}function Av(F,Le){const Oe=F.json.bufferViews[Le];return new Uint8Array(F.buffers[Oe.buffer],Oe.byteOffset||0,Oe.byteLength)}function Iv(F,Le,Oe,Fe){if(F.uri){const je=wv(F.uri,Fe);return fetch(je).then((F=>F.blob())).then((F=>createImageBitmap(F))).then((F=>{Le.images[Oe]=F}))}if(void 0!==F.bufferView){const Fe=Av(Le,F.bufferView),je=new Blob([Fe],{type:F.mimeType});return createImageBitmap(je).then((F=>{Le.images[Oe]=F}))}}function Sv(F,Le=0,Oe){const Fe={json:null,images:[],buffers:[]};if(new Uint32Array(F,Le,1)[0]===yw){const Oe=new Uint32Array(F,Le);let je=2;const qe=(Oe[je++]>>2)-3,He=Oe[je++]>>2;if(je++,Fe.json=JSON.parse(xw.decode(Oe.subarray(je,je+He))),je+=He,je<qe){const qe=Oe[je++];je++;const He=Le+(je<<2);Fe.buffers[0]=F.slice(He,He+qe)}}else Fe.json=JSON.parse(xw.decode(new Uint8Array(F,Le)));const{buffers:je,images:qe,meshes:He,extensionsUsed:xt,bufferViews:jt}=Fe.json;let Gt=Promise.resolve();if(je){const F=[];for(let Le=0;Le<je.length;Le++){const qe=je[Le];qe.uri?F.push(Mv(qe,Fe,Le,Oe)):Fe.buffers[Le]||(Fe.buffers[Le]=null)}Gt=Promise.all(F)}return Gt.then((()=>{const F=[],Le=xt&&xt.includes(_w),je=xt&&xt.includes(gw);if(Le&&F.push(function(){if(!cw)return null!=aw?aw:(aw=function(F){let Le,Oe=null;function n(){Le=new Uint8Array(Oe.buffer)}function i(){throw new Error("Unexpected Draco error.")}const Fe={a:{a:i,d:function(F,Oe,Fe){return Le.copyWithin(F,Oe,Oe+Fe)},c:function(F){const Fe=Le.length,je=Math.max(F>>>0,Math.ceil(1.2*Fe)),qe=Math.ceil((je-Fe)/65536);try{return Oe.grow(qe),n(),!0}catch(F){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(F,Fe):F.then((F=>F.arrayBuffer())).then((F=>WebAssembly.instantiate(F,Fe)))).then((F=>{const{Rb:Fe,Qb:je,P:qe,T:He,X:xt,Ja:jt,La:Gt,Qa:bi,Va:wi,Wa:qr,eb:Xn,jb:Yn,f:yo,e:bo,yb:Do,zb:Ro,Ab:zs,Bb:Zs,Db:na,Gb:el}=F.instance.exports;Oe=bo;const nl=(()=>{let F=0,Oe=0,qe=0,He=0;return xt=>{qe&&(Fe(He),Fe(F),Oe+=qe,qe=F=0),F||(Oe+=128,F=je(Oe));const jt=xt.length+7&-8;let Gt=F;jt>=Oe&&(qe=jt,Gt=He=je(jt));for(let F=0;F<xt.length;F++)Le[Gt+F]=xt[F];return Gt}})();return n(),yo(),{memory:bo,_free:Fe,_malloc:je,Mesh:class{constructor(){this.ptr=qe()}destroy(){He(this.ptr)}},Decoder:class{constructor(){this.ptr=jt()}destroy(){Yn(this.ptr)}DecodeArrayToMesh(F,Le,Oe){const Fe=nl(F),je=Gt(this.ptr,Fe,Le,Oe.ptr);return!!xt(je)}GetAttributeByUniqueId(F,Le){return{ptr:bi(this.ptr,F.ptr,Le)}}GetTrianglesUInt16Array(F,Le,Oe){wi(this.ptr,F.ptr,Le,Oe)}GetTrianglesUInt32Array(F,Le,Oe){qr(this.ptr,F.ptr,Le,Oe)}GetAttributeDataArrayForAllPoints(F,Le,Oe,Fe,je){Xn(this.ptr,F.ptr,Le.ptr,Oe,Fe,je)}},DT_INT8:Do(),DT_UINT8:Ro(),DT_INT16:zs(),DT_UINT16:Zs(),DT_UINT32:na(),DT_FLOAT32:el()}}))}(fetch(cv())),aw.then((F=>{cw=F,aw=void 0})))}()),je&&F.push(function(){if(uw)return;const F=function(F){let Le;const Oe=WebAssembly.instantiateStreaming(F,{}).then((F=>{Le=F.instance,Le.exports.__wasm_call_ctors()})),Fe={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},je={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:Oe,supported:!0,decodeGltfBuffer(F,Oe,qe,He,xt,jt){!function(F,Le,Oe,Fe,je,qe,He){const xt=F.exports.sbrk,jt=Fe+3&-4,Gt=xt(jt*je),bi=xt(qe.length),wi=new Uint8Array(F.exports.memory.buffer);wi.set(qe,bi);const qr=Le(Gt,Fe,je,bi,qe.length);if(0===qr&&He&&He(Gt,jt,je),Oe.set(wi.subarray(Gt,Gt+Fe*je)),xt(Gt-xt(0)),0!==qr)throw new Error(`Malformed buffer data: ${qr}`)}(Le,Le.exports[je[xt]],F,Oe,qe,He,Le.exports[Fe[jt]])}}}(fetch(hv()));return F.ready.then((()=>{uw=F}))}()),qe)for(let Le=0;Le<qe.length;Le++)F.push(Iv(qe[Le],Fe,Le,Oe));return(F.length?Promise.all(F):Promise.resolve()).then((()=>{if(Le&&He)for(const{primitives:F}of He)for(const Le of F)gv(Le,Fe);if(je&&He&&jt)for(const F of jt)vv(F,Fe);return Fe}))}))}function Pv(F,Le){const Oe=F.json.bufferViews[Le.bufferView],Fe=pw[Le.componentType];return new Fe(F.buffers[Oe.buffer],(Le.byteOffset||0)+(Oe.byteOffset||0),Le.count*(Oe.byteStride&&Oe.byteStride!==mw[Le.type]*Fe.BYTES_PER_ELEMENT?Oe.byteStride/Fe.BYTES_PER_ELEMENT:mw[Le.type]))}function Ev(F,Le,Oe,Fe){const je=pw[Le.componentType],qe=function(F){switch(F){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(je),He=F.json.bufferViews[Le.bufferView],xt=He.byteStride?He.byteStride/je.BYTES_PER_ELEMENT:mw[Le.type],jt=Oe.float32,Gt=jt.length/Oe.capacity;for(let F=0,Oe=0;F<Le.count*xt;F+=xt,Oe+=Gt)for(let Le=0;Le<Gt;Le++)jt[Oe+Le]=Fe[F+Le]*qe;Oe._trim()}function zv(F,Le,Oe){const Fe=F.indices,je=F.attributes,qe={};qe.indexArray=new ja;const He=Le.json.accessors[Fe],xt=He.count/3;qe.indexArray.reserve(xt);const jt=Pv(Le,He);for(let F=0;F<xt;F++)qe.indexArray.emplaceBack(jt[3*F],jt[3*F+1],jt[3*F+2]);qe.indexArray._trim(),qe.vertexArray=new za;const Gt=Le.json.accessors[je.POSITION];qe.vertexArray.reserve(Gt.count);const bi=Pv(Le,Gt);for(let F=0;F<Gt.count;F++)qe.vertexArray.emplaceBack(bi[3*F],bi[3*F+1],bi[3*F+2]);if(qe.vertexArray._trim(),qe.aabb=new Au(Gt.min,Gt.max),qe.centroid=function(F,Le){const Oe=[0,0,0],Fe=F.length;if(Fe>0){for(let je=0;je<Fe;je++){const Fe=3*F[je];Oe[0]+=Le[Fe],Oe[1]+=Le[Fe+1],Oe[2]+=Le[Fe+2]}Oe[0]/=Fe,Oe[1]/=Fe,Oe[2]/=Fe}return Oe}(jt,bi),void 0!==je.COLOR_0){const F=Le.json.accessors[je.COLOR_0],Oe=mw[F.type],Fe=Pv(Le,F);qe.colorArray=3===Oe?new za:new Da,qe.colorArray.resize(F.count),Ev(Le,F,qe.colorArray,Fe)}if(void 0!==je.NORMAL){qe.normalArray=new za;const F=Le.json.accessors[je.NORMAL];qe.normalArray.resize(F.count);const Oe=Pv(Le,F);Ev(Le,F,qe.normalArray,Oe)}if(void 0!==je.TEXCOORD_0&&Oe.length>0){qe.texcoordArray=new Za;const F=Le.json.accessors[je.TEXCOORD_0];qe.texcoordArray.resize(F.count);const Oe=Pv(Le,F);Ev(Le,F,qe.texcoordArray,Oe)}if(void 0!==je._FEATURE_ID_RGBA4444){const F=Le.json.accessors[je._FEATURE_ID_RGBA4444];Le.json.extensionsUsed&&Le.json.extensionsUsed.includes("EXT_meshopt_compression")&&(qe.featureData=Pv(Le,F))}void 0!==je._FEATURE_RGBA4444&&(qe.featureData=new Uint32Array(Pv(Le,Le.json.accessors[je._FEATURE_RGBA4444]).buffer));const wi=F.material;return qe.material=function(F,Le){const{emissiveFactor:Oe=[0,0,0],alphaMode:Fe="OPAQUE",alphaCutoff:je=.5,normalTexture:qe,occlusionTexture:He,emissiveTexture:xt,doubleSided:jt}=F,{baseColorFactor:Gt=[1,1,1,1],metallicFactor:bi=1,roughnessFactor:wi=1,baseColorTexture:qr,metallicRoughnessTexture:Xn}=F.pbrMetallicRoughness||{},Yn=He?Le[He.index]:void 0;if(He&&He.extensions&&He.extensions.KHR_texture_transform&&Yn){const F=He.extensions.KHR_texture_transform;Yn.offsetScale=[F.offset[0],F.offset[1],F.scale[0],F.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Se(...Gt),metallicFactor:bi,roughnessFactor:wi,baseColorTexture:qr?Le[qr.index]:void 0,metallicRoughnessTexture:Xn?Le[Xn.index]:void 0},doubleSided:jt,emissiveFactor:Oe,alphaMode:Fe,alphaCutoff:je,normalTexture:qe?Le[qe.index]:void 0,occlusionTexture:Yn,emissionTexture:xt?Le[xt.index]:void 0,defined:void 0===F.defined}}(void 0!==wi?Le.json.materials[wi]:{defined:!1},Oe),qe}function kv(F,Le,Oe){const{matrix:Fe,rotation:je,translation:qe,scale:He,mesh:xt,extras:jt,children:Gt}=F,bi={};if(bi.matrix=Fe||kl.mat4.fromRotationTranslationScale([],je||[0,0,0,1],qe||[0,0,0],He||[1,1,1]),void 0!==xt){bi.meshes=Oe[xt];const F=bi.anchor=[0,0];for(const Le of bi.meshes){const{min:Oe,max:Fe}=Le.aabb;F[0]+=Oe[0]+Fe[0],F[1]+=Oe[1]+Fe[1]}F[0]=Math.floor(F[0]/bi.meshes.length/2),F[1]=Math.floor(F[1]/bi.meshes.length/2)}if(jt&&(jt.id&&(bi.id=jt.id),jt.lights&&(bi.lights=function(F){if(!F.length)return[];const Le=function(F){const Le=atob(F),Oe=new Uint8Array(Le.length);for(let F=0;F<Le.length;F++)Oe[F]=Le.codePointAt(F);return Oe}(F),Oe=[],Fe=Le.length/24,je=new Uint16Array(Le.buffer),qe=new Float32Array(Le.buffer);for(let F=0;F<Fe;F++){const Le=je[2*F*6]/30,Fe=je[2*F*6+1]/30,He=je[2*F*6+10]/100,xt=qe[6*F+1],jt=qe[6*F+2],Gt=qe[6*F+3],bi=qe[6*F+4],wi=Gt-xt,qr=bi-jt,Xn=Math.hypot(wi,qr);Oe.push({pos:[xt+.5*wi,jt+.5*qr,Fe],normal:[qr/Xn,-wi/Xn,0],width:Xn,height:Le,depth:He,points:[xt,jt,Gt,bi]})}return Oe}(jt.lights))),Gt){const F=[];for(const Fe of Gt)F.push(kv(Le.json.nodes[Fe],Le,Oe));bi.children=F}return bi}function Tv(F){if(0===F.vertices.length||0===F.indices.length)return null;const Le=new Sh(F.vertices,F.indices,8,256),[Oe,Fe]=[Le.min.clone(),Le.max.clone()];return{vertices:F.vertices,indices:F.indices,grid:Le,min:Oe,max:Fe}}function Bv(F){if(!F.extras||!F.extras.ground)return null;const Le=F.extras.ground;if(!Le||!Array.isArray(Le)||0===Le.length)return null;const Oe=Le[0];if(!Oe||!Array.isArray(Oe)||0===Oe.length)return null;const Fe=[];for(const F of Oe){if(!Array.isArray(F)||2!==F.length)continue;const Le=F[0],Oe=F[1];"number"==typeof Le&&"number"==typeof Oe&&Fe.push(new ic(Le,Oe))}if(Fe.length<3)return null;Fe.length>1&&Fe[Fe.length-1].equals(Fe[0])&&Fe.pop();let je=0;for(let F=0;F<Fe.length;F++){const Le=Fe[F],Oe=Fe[(F+1)%Fe.length],qe=Fe[(F+2)%Fe.length];je+=(Le.x-Oe.x)*(qe.y-Oe.y)-(qe.x-Oe.x)*(Le.y-Oe.y)}je>0&&Fe.reverse();const qe=vc(Fe.flatMap((F=>[F.x,F.y])),[]);return 0===qe.length?null:{vertices:Fe,indices:qe}}function Vv(F,Le){const Oe=[],Fe=[];let je=0;const qe=[];for(const He of F){je=Oe.length;const F=He.vertexArray.float32,xt=He.indexArray.uint16;for(let Fe=0;Fe<He.vertexArray.length;Fe++)qe[0]=F[3*Fe+0],qe[1]=F[3*Fe+1],qe[2]=F[3*Fe+2],kl.vec3.transformMat4(qe,qe,Le),Oe.push(new ic(qe[0],qe[1]));for(let F=0;F<3*He.indexArray.length;F++)Fe.push(xt[F]+je)}if(Fe.length%3!=0)return null;for(let F=0;F<Fe.length;F+=3){const Le=Oe[Fe[F+0]],je=Oe[Fe[F+1]],qe=Oe[Fe[F+2]];(Le.x-je.x)*(qe.y-je.y)-(qe.x-je.x)*(Le.y-je.y)>0&&([Fe[F+1],Fe[F+2]]=[Fe[F+2],Fe[F+1]])}return{vertices:Oe,indices:Fe}}function Cv(F){const Le=function(F,Le){const Oe=[],Fe=WebGL2RenderingContext;if(F.json.textures)for(const je of F.json.textures){const qe={magFilter:Fe.LINEAR,minFilter:Fe.NEAREST,wrapS:Fe.REPEAT,wrapT:Fe.REPEAT};void 0!==je.sampler&&Object.assign(qe,F.json.samplers[je.sampler]),Oe.push({image:Le[je.source],sampler:qe,uploaded:!1})}return Oe}(F,F.images),Oe=function(F,Le){const Oe=[];for(const Fe of F.json.meshes){const je=[];for(const Oe of Fe.primitives)je.push(zv(Oe,F,Le));Oe.push(je)}return Oe}(F,Le),{scenes:Fe,scene:je,nodes:qe}=F.json,He=Fe?Fe[je||0].nodes:qe,xt=[];for(const Le of He)xt.push(kv(qe[Le],F,Oe));return function(F,Le,Oe){const Fe={},je=new Set;for(let qe=0;qe<F.length;qe++){const F=Oe[Le[qe]];if(!F.extras)continue;const He=F.extras["mapbox:footprint:version"],xt=F.extras["mapbox:footprint:id"];(He||xt)&&je.add(qe),"1.0.0"===He&&xt&&(Fe[xt]=qe)}for(let qe=0;qe<F.length;qe++){if(je.has(qe))continue;const He=F[qe],xt=Oe[Le[qe]];if(!xt.extras)continue;let jt=null;He.id in Fe&&(jt=Vv(F[Fe[He.id]].meshes,He.matrix)),jt||(jt=Bv(xt)),jt&&(He.footprint=Tv(jt))}if(je.size>0){const Le=Array.from(je.values()).sort(((F,Le)=>F-Le));for(let Oe=Le.length-1;Oe>=0;Oe--)F.splice(Le[Oe],1)}}(xt,He,F.json.nodes),xt}function Dv(F){F.heightmap=new Float32Array(4096),F.heightmap.fill(-1);const Le=F.vertexArray.float32,Oe=F.aabb.min[0]-1,Fe=F.aabb.min[1]-1,je=yb/(F.aabb.max[0]-Oe+2),qe=yb/(F.aabb.max[1]-Fe+2);for(let He=0;He<Le.length;He+=3){const xt=Le[He+2],jt=(Le[He+0]-Oe)*je|0,Gt=(Le[He+1]-Fe)*qe|0;xt>F.heightmap[Gt*yb+jt]&&(F.heightmap[Gt*yb+jt]=xt)}}function Rv(F,Le){const Oe={};Oe.indexArray=new ja,Oe.indexArray.reserve(4*F.length),Oe.vertexArray=new za,Oe.vertexArray.reserve(10*F.length),Oe.colorArray=new Da,Oe.vertexArray.reserve(10*F.length);let Fe=0;for(const je of F){const F=Math.min(10,Math.max(4,1.3*je.height))*Le,qe=[-je.normal[1],je.normal[0],0],He=Math.min(.29,.1*je.width/je.depth),xt=je.width-2*je.depth*Le*(He+.01),jt=kl.vec3.scaleAndAdd([],je.pos,qe,xt/2),Gt=kl.vec3.scaleAndAdd([],je.pos,qe,-xt/2),bi=[jt[0],jt[1],jt[2]+je.height],wi=[Gt[0],Gt[1],Gt[2]+je.height],qr=kl.vec3.scaleAndAdd([],je.normal,qe,He);kl.vec3.scale(qr,qr,F);const Xn=kl.vec3.scaleAndAdd([],je.normal,qe,-He);kl.vec3.scale(Xn,Xn,F),kl.vec3.add(qr,jt,qr),kl.vec3.add(Xn,Gt,Xn),jt[2]+=.1,Gt[2]+=.1,Oe.vertexArray.emplaceBack(qr[0],qr[1],qr[2]),Oe.vertexArray.emplaceBack(Xn[0],Xn[1],Xn[2]),Oe.vertexArray.emplaceBack(jt[0],jt[1],jt[2]),Oe.vertexArray.emplaceBack(Gt[0],Gt[1],Gt[2]),Oe.vertexArray.emplaceBack(bi[0],bi[1],bi[2]),Oe.vertexArray.emplaceBack(wi[0],wi[1],wi[2]),Oe.vertexArray.emplaceBack(jt[0],jt[1],jt[2]),Oe.vertexArray.emplaceBack(Gt[0],Gt[1],Gt[2]),Oe.vertexArray.emplaceBack(qr[0],qr[1],qr[2]),Oe.vertexArray.emplaceBack(Xn[0],Xn[1],Xn[2]);const Yn=xt/F/2;Oe.colorArray.emplaceBack(-Yn-He,-1,Yn,.8),Oe.colorArray.emplaceBack(Yn+He,-1,Yn,.8),Oe.colorArray.emplaceBack(-Yn,0,Yn,1.3),Oe.colorArray.emplaceBack(Yn,0,Yn,1.3),Oe.colorArray.emplaceBack(Yn+He,-.8,Yn,.7),Oe.colorArray.emplaceBack(Yn+He,-.8,Yn,.7),Oe.colorArray.emplaceBack(0,0,Yn,1.3),Oe.colorArray.emplaceBack(0,0,Yn,1.3),Oe.colorArray.emplaceBack(Yn+He,-1.2,Yn,.8),Oe.colorArray.emplaceBack(Yn+He,-1.2,Yn,.8),Oe.indexArray.emplaceBack(6+Fe,4+Fe,8+Fe),Oe.indexArray.emplaceBack(7+Fe,9+Fe,5+Fe),Oe.indexArray.emplaceBack(0+Fe,1+Fe,2+Fe),Oe.indexArray.emplaceBack(1+Fe,3+Fe,2+Fe),Fe+=10}const je={defined:!0,emissiveFactor:[0,0,0]},qe={};return qe.baseColorFactor=Se.white,je.pbrMetallicRoughness=qe,Oe.material=je,Oe.aabb=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Oe}class Lv{constructor(F){this._stringToNumber={},this._numberToString=[];for(let Le=0;Le<F.length;Le++){const Oe=F[Le];this._stringToNumber[Oe]=Le,this._numberToString[Le]=Oe}}encode(F){return this._stringToNumber[F]}decode(F){return this._numberToString[F]}}const vw=["id","tile","layer","source","sourceLayer","state"];class Ov{constructor(F,Le,Oe,Fe,je){this.type="Feature",this._vectorTileFeature=F,this._z=Le,this._x=Oe,this._y=Fe,this.properties=F.properties,this.id=je}clone(){const F=new Ov(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(F.state=Object.assign({},this.state)),this.layer&&(F.layer=Object.assign({},this.layer)),this.source&&(F.source=this.source),this.sourceLayer&&(F.sourceLayer=this.sourceLayer),F}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(F){this._geometry=F}toJSON(){const F={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const Le of vw)void 0!==this[Le]&&(F[Le]=this[Le]);return F}}class Nv{constructor(F,Le){this.tileID=F,this.x=F.canonical.x,this.y=F.canonical.y,this.z=F.canonical.z,this.grid=new ff(sp,16,0),this.featureIndexArray=new ho,this.promoteId=Le,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(F,Le,Oe,Fe,je,qe=0,He=0){const xt=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(Oe,Fe,je,qe);const jt=this.grid;for(let F=0;F<Le.length;F++){const Oe=Le[F],Fe=[1/0,1/0,-1/0,-1/0];for(let F=0;F<Oe.length;F++){const Le=Oe[F];Fe[0]=Math.min(Fe[0],Le.x),Fe[1]=Math.min(Fe[1],Le.y),Fe[2]=Math.max(Fe[2],Le.x),Fe[3]=Math.max(Fe[3],Le.y)}0!==He&&(Fe[0]-=He,Fe[1]-=He,Fe[2]+=He,Fe[3]+=He),Fe[0]<sp&&Fe[1]<sp&&Fe[2]>=0&&Fe[3]>=0&&jt.insert(xt,Fe[0],Fe[1],Fe[2],Fe[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new F_.VectorTile(new kx(this.rawTileData)).layers,this.sourceLayerCoder=new Lv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const F in this.vtLayers)this.vtFeatures[F]=[]}return this.vtLayers}query(F,Le){const{tilespaceGeometry:Oe,transform:Fe,tileTransform:je,pixelPosMatrix:qe,availableImages:He}=Le;this.loadVTLayers(),this.serializedLayersCache.clear();const xt=Oe.bufferedTilespaceBounds,jt=this.grid.query(xt.min.x,xt.min.y,xt.max.x,xt.max.y,((F,Le,Fe,je)=>Xl(Oe.bufferedTilespaceGeometry,F,Le,Fe,je)));jt.sort(jv);let Gt=null;Fe.elevation&&jt.length>0&&(Gt=Fy.create(Fe.elevation,this.tileID));const bi={};let wi;for(let Le=0;Le<jt.length;Le++){const xt=jt[Le];if(xt===wi)continue;wi=xt;const qr=this.featureIndexArray.get(xt);let Xn=null;this.is3DTile?this.loadMatchingModelFeature(bi,qr,F,Oe,Fe):this.loadMatchingFeature(bi,qr,F,He,((F,Le,He,xt=0)=>(Xn||(Xn=Vl(F,this.tileID.canonical,je)),Le.queryIntersectsFeature(Oe,F,He,Xn,this.z,Fe,qe,Gt,xt))))}return bi}loadMatchingFeature(F,Le,Oe,Fe,je){const{featureIndex:qe,bucketIndex:He,sourceLayerIndex:xt,layoutVertexArrayOffset:jt}=Le,Gt=this.bucketLayerIDs[He],bi=Oe.layers,wi=Object.keys(bi);if(wi.length&&!function(F,Le){for(let Oe=0;Oe<F.length;Oe++)if(Le.indexOf(F[Oe])>=0)return!0;return!1}(wi,Gt))return;const qr=Oe.sourceCache,Xn=this.sourceLayerCoder.decode(xt),Yn=this.vtLayers[Xn].feature(qe),yo=this.getId(Yn,Xn);for(let Le=0;Le<Gt.length;Le++){const Oe=Gt[Le];if(!bi[Oe])continue;const{styleLayer:He,targets:xt}=bi[Oe];let wi={};void 0!==yo&&(wi=qr.getFeatureState(He.sourceLayer,yo));const Xn=!je||je(Yn,He,wi,jt);if(!Xn)continue;const bo=new Ov(Yn,this.z,this.x,this.y,yo);bo.tile=this.tileID.canonical,bo.state=wi;let Do=this.serializedLayersCache.get(Oe);Do||(Do=He.serialize(),Do.id=Oe,this.serializedLayersCache.set(Oe,Do)),bo.source=Do.source,bo.sourceLayer=Do["source-layer"],bo.layer=nt({},Do),bo.layer.paint=Uv(Do.paint,He.paint,Yn,wi,Fe),bo.layer.layout=Uv(Do.layout,He.layout,Yn,wi,Fe);let Ro=!1;for(const F of xt){this.updateFeatureProperties(bo,F);const{filter:Le}=F;if(Le)if(Yn.properties=bo.properties,Le.needGeometry){const F=Cl(Yn,!0);if(!Le.filter(new Rs(this.tileID.overscaledZ),F,this.tileID.canonical))continue}else if(!Le.filter(new Rs(this.tileID.overscaledZ),Yn))continue;Ro=!0,F.targetId&&this.addFeatureVariant(bo,F)}Ro&&this.appendToResult(F,Oe,qe,bo,Xn)}}loadMatchingModelFeature(F,Le,Oe,Fe,je){const qe=this.bucketLayerIDs[0][0],He=Oe.layers;if(!He[qe])return;const{styleLayer:xt,targets:jt}=He[qe];if("model"!==xt.type)return;const Gt=Fe.tile,bi=Le.featureIndex,wi=Gt.getBucket(xt);if(!(wi&&wi instanceof Gy))return;const qr=function(F,Le,Oe,Fe){const je=F.getNodesInfo()[Le];if(je.hiddenByReplacement||!je.node.meshes)return;let qe=Number.MAX_VALUE;const He=je.node,xt=Oe.tile,jt=Fe.calculatePosMatrix(xt.tileID.toUnwrapped(),Fe.worldSize),Gt=je.evaluatedScale;let bi=0;Fe.elevation&&He.elevation&&(bi=He.elevation*Fe.elevation.exaggeration()),kl.mat4.translate(jt,jt,[(He.anchor?He.anchor[0]:0)*(Gt[0]-1),(He.anchor?He.anchor[1]:0)*(Gt[1]-1),bi]),kl.mat4.scale(jt,jt,Gt);const wi=Oe.queryGeometry,qr=wi.isPointQuery()?wi.screenBounds:wi.screenGeometry,f=function(F){const Le=kl.mat4.multiply([],jt,F.matrix);kl.mat4.multiply(Le,Fe.expandedFarZProjMatrix,Le);for(let Oe=0;Oe<F.meshes.length;++Oe){const je=F.meshes[Oe];if(Oe===F.lightMeshIndex)continue;const He=dy(qr,Fe,Le,je.aabb);null!=He&&(qe=Math.min(He,qe))}if(F.children)for(const Le of F.children)f(Le)};if(f(He),qe===Number.MAX_VALUE)return;const Xn=new ul(0,0);return Zy(xt.tileID.canonical,Xn,je.node.anchor[0],je.node.anchor[1]),{intersectionZ:qe,position:Xn,feature:je.feature}}(wi,bi,Fe,je);if(!qr)return;const{z:Xn,x:Yn,y:yo}=Gt.tileID.canonical,{feature:bo,intersectionZ:Do,position:Ro}=qr;let zs={};void 0!==bo.id&&(zs=Oe.sourceCache.getFeatureState(xt.sourceLayer,bo.id));const Zs=new Ov({},Xn,Yn,yo,bo.id);Zs.tile=this.tileID.canonical,Zs.state=zs,Zs.properties=bo.properties,Zs.geometry={type:"Point",coordinates:[Ro.lng,Ro.lat]};let na=this.serializedLayersCache.get(qe);na||(na=xt.serialize(),na.id=qe,this.serializedLayersCache.set(qe,na)),Zs.source=na.source,Zs.sourceLayer=na["source-layer"],Zs.layer=nt({},na);let el=!1;for(const F of jt){this.updateFeatureProperties(Zs,F);const{filter:Le}=F;if(Le)if(bo.properties=Zs.properties,Le.needGeometry){if(!Le.filter(new Rs(this.tileID.overscaledZ),bo,this.tileID.canonical))continue}else if(!Le.filter(new Rs(this.tileID.overscaledZ),bo))continue;el=!0,F.targetId&&this.addFeatureVariant(Zs,F)}el&&this.appendToResult(F,qe,bi,Zs,Do)}updateFeatureProperties(F,Le,Oe){if(Le.properties){const Fe={};for(const je in Le.properties){const qe=Le.properties[je].evaluate({zoom:this.z},F._vectorTileFeature,F.state,F.tile,Oe);null!=qe&&(Fe[je]=qe)}F.properties=Fe}}addFeatureVariant(F,Le,Oe){const Fe={target:Le.target,namespace:Le.namespace,uniqueFeatureID:Le.uniqueFeatureID};Le.properties&&(Fe.properties=F.properties),F.variants=F.variants||{},F.variants[Le.targetId]=F.variants[Le.targetId]||[],F.variants[Le.targetId].push(Fe)}appendToResult(F,Le,Oe,Fe,je){let qe=F[Le];void 0===qe&&(qe=F[Le]=[]),qe.push({featureIndex:Oe,feature:Fe,intersectionZ:je})}lookupSymbolFeatures(F,Le,Oe,Fe,je){const qe={};this.loadVTLayers();for(const He of F)this.loadMatchingFeature(qe,{bucketIndex:Le,sourceLayerIndex:Oe,featureIndex:He,layoutVertexArrayOffset:0},Fe,je);return qe}loadFeature(F){const{featureIndex:Le,sourceLayerIndex:Oe}=F;this.loadVTLayers();const Fe=this.sourceLayerCoder.decode(Oe),je=this.vtFeatures[Fe];if(je[Le])return je[Le];const qe=this.vtLayers[Fe].feature(Le);return je[Le]=qe,qe}hasLayer(F){for(const Le of this.bucketLayerIDs)for(const Oe of Le)if(F===Oe)return!0;return!1}getId(F,Le){let Oe=F.id;if(this.promoteId){const Fe=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[Le];if(null!=Fe)if(Array.isArray(Fe)){if(!this.promoteIdExpression){const F=Ji(Fe);if("success"!==F.result){const Le=F.value.map((F=>`${F.key}: ${F.message}`)).join(", ");return void pt(`Failed to create expression for promoteId: ${Le}`)}this.promoteIdExpression=F.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new yr),Oe=this.promoteIdExpression.evaluate({zoom:0},F)}else Oe=F.properties[Fe];"boolean"==typeof Oe&&(Oe=Number(Oe))}return Oe}}function Uv(F,Le,Oe,Fe,je){return lt(F,((F,qe)=>{const He=Le instanceof $s?Le.get(qe):null;return He&&He.evaluate?He.evaluate(Oe,Fe,je):He}))}function jv(F,Le){return Le-F}us(Nv,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const bw=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class $v{static from(F){if(!(F instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[Le,Oe]=new Uint8Array(F,0,2);if(219!==Le)throw new Error("Data does not appear to be in a KDBush format.");const Fe=Oe>>4;if(1!==Fe)throw new Error(`Got v${Fe} data when expected v1.`);const je=bw[15&Oe];if(!je)throw new Error("Unrecognized array type.");const[qe]=new Uint16Array(F,2,1),[He]=new Uint32Array(F,4,1);return new $v(He,qe,je,F)}constructor(F,Le=64,Oe=Float64Array,Fe){if(isNaN(F)||F<0)throw new Error(`Unpexpected numItems value: ${F}.`);this.numItems=+F,this.nodeSize=Math.min(Math.max(+Le,2),65535),this.ArrayType=Oe,this.IndexArrayType=F<65536?Uint16Array:Uint32Array;const je=bw.indexOf(this.ArrayType),qe=2*F*this.ArrayType.BYTES_PER_ELEMENT,He=F*this.IndexArrayType.BYTES_PER_ELEMENT,xt=(8-He%8)%8;if(je<0)throw new Error(`Unexpected typed array class: ${Oe}.`);Fe&&Fe instanceof ArrayBuffer?(this.data=Fe,this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+He+xt,2*F),this._pos=2*F,this._finished=!0):(this.data=new ArrayBuffer(8+qe+He+xt),this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+He+xt,2*F),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+je]),new Uint16Array(this.data,2,1)[0]=Le,new Uint32Array(this.data,4,1)[0]=F)}add(F,Le){const Oe=this._pos>>1;return this.ids[Oe]=Oe,this.coords[this._pos++]=F,this.coords[this._pos++]=Le,Oe}finish(){const F=this._pos>>1;if(F!==this.numItems)throw new Error(`Added ${F} items when expected ${this.numItems}.`);return Gv(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(F,Le,Oe,Fe){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:je,coords:qe,nodeSize:He}=this,xt=[0,je.length-1,0],jt=[];for(;xt.length;){const Gt=xt.pop()||0,bi=xt.pop()||0,wi=xt.pop()||0;if(bi-wi<=He){for(let He=wi;He<=bi;He++){const xt=qe[2*He],Gt=qe[2*He+1];xt>=F&&xt<=Oe&&Gt>=Le&&Gt<=Fe&&jt.push(je[He])}continue}const qr=wi+bi>>1,Xn=qe[2*qr],Yn=qe[2*qr+1];Xn>=F&&Xn<=Oe&&Yn>=Le&&Yn<=Fe&&jt.push(je[qr]),(0===Gt?F<=Xn:Le<=Yn)&&(xt.push(wi),xt.push(qr-1),xt.push(1-Gt)),(0===Gt?Oe>=Xn:Fe>=Yn)&&(xt.push(qr+1),xt.push(bi),xt.push(1-Gt))}return jt}within(F,Le,Oe){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:Fe,coords:je,nodeSize:qe}=this,He=[0,Fe.length-1,0],xt=[],jt=Oe*Oe;for(;He.length;){const Gt=He.pop()||0,bi=He.pop()||0,wi=He.pop()||0;if(bi-wi<=qe){for(let Oe=wi;Oe<=bi;Oe++)Zv(je[2*Oe],je[2*Oe+1],F,Le)<=jt&&xt.push(Fe[Oe]);continue}const qr=wi+bi>>1,Xn=je[2*qr],Yn=je[2*qr+1];Zv(Xn,Yn,F,Le)<=jt&&xt.push(Fe[qr]),(0===Gt?F-Oe<=Xn:Le-Oe<=Yn)&&(He.push(wi),He.push(qr-1),He.push(1-Gt)),(0===Gt?F+Oe>=Xn:Le+Oe>=Yn)&&(He.push(qr+1),He.push(bi),He.push(1-Gt))}return xt}}function Gv(F,Le,Oe,Fe,je,qe){if(je-Fe<=Oe)return;const He=Fe+je>>1;Yv(F,Le,He,Fe,je,qe),Gv(F,Le,Oe,Fe,He-1,1-qe),Gv(F,Le,Oe,He+1,je,1-qe)}function Yv(F,Le,Oe,Fe,je,qe){for(;je>Fe;){if(je-Fe>600){const He=je-Fe+1,xt=Oe-Fe+1,jt=Math.log(He),Gt=.5*Math.exp(2*jt/3),bi=.5*Math.sqrt(jt*Gt*(He-Gt)/He)*(xt-He/2<0?-1:1);Yv(F,Le,Oe,Math.max(Fe,Math.floor(Oe-xt*Gt/He+bi)),Math.min(je,Math.floor(Oe+(He-xt)*Gt/He+bi)),qe)}const He=Le[2*Oe+qe];let xt=Fe,jt=je;for(Hv(F,Le,Fe,Oe),Le[2*je+qe]>He&&Hv(F,Le,Fe,je);xt<jt;){for(Hv(F,Le,xt,jt),xt++,jt--;Le[2*xt+qe]<He;)xt++;for(;Le[2*jt+qe]>He;)jt--}Le[2*Fe+qe]===He?Hv(F,Le,Fe,jt):(jt++,Hv(F,Le,jt,je)),jt<=Oe&&(Fe=jt+1),Oe<=jt&&(je=jt-1)}}function Hv(F,Le,Oe,Fe){Xv(F,Oe,Fe),Xv(Le,2*Oe,2*Fe),Xv(Le,2*Oe+1,2*Fe+1)}function Xv(F,Le,Oe){const Fe=F[Le];F[Le]=F[Oe],F[Oe]=Fe}function Zv(F,Le,Oe,Fe){const je=F-Oe,qe=Le-Fe;return je*je+qe*qe}Le.$=gr,Le.A=ge,Le.B=tr,Le.C=pa,Le.D=ng,Le.E=_e,Le.F=2,Le.G=pd,Le.H=cd,Le.I=we,Le.J=class extends My{},Le.K=pr,Le.L=Be,Le.M=Ws,Le.N=Ui,Le.O=Fi,Le.P=ic,Le.Q=Ni,Le.R=kh,Le.S=Ki,Le.T=qm,Le.U=Ks,Le.V=My,Le.W=es,Le.X=Ji,Le.Y=Vn,Le.Z=Dn,Le._=Bn,Le.a=function(F){return Zc.API_CDN_URL_REGEX.test(F)},Le.a$=Cl,Le.a0=Su,Le.a1=Js,Le.a2=ji,Le.a3=Oi,Le.a4=function(F){const Le=F.value;let Oe=[];if(!Le)return Oe;const Fe=pr(Le);return"string"!==Fe?(Oe=Oe.concat([new My(F.key,Le,`string expected, "${Fe}" found`)]),Oe):(Ay(Le,!0)||(Oe=Oe.concat([new My(F.key,Le,`invalid url "${Le}"`)])),Oe)},Le.a5=Df,Le.a6=Os,Le.a7=Xs,Le.a8=Gs,Le.a9=class{constructor(F){this.specification=F}possiblyEvaluate(F,Le){return mt(F.expression.evaluate(Le))}interpolate(F,Le,Oe){return{x:Ee(F.x,Le.x,Oe),y:Ee(F.y,Le.y,Oe),z:Ee(F.z,Le.z,Oe),azimuthal:Ee(F.azimuthal,Le.azimuthal,Oe),polar:Ee(F.polar,Le.polar,Oe)}}},Le.aA=function(F,Le){const Oe={};for(let Fe=0;Fe<Le.length;Fe++){const je=Le[Fe];je in F&&(Oe[je]=F[je])}return Oe},Le.aB=cl,Le.aC=ml,Le.aD=class{constructor(F){this.entries={},this.scheduler=F}request(F,Le,Oe,Fe){const je=this.entries[F]=this.entries[F]||{callbacks:[]};if(je.result){const[F,Oe]=je.result;return this.scheduler?this.scheduler.add((()=>{Fe(F,Oe)}),Le):Fe(F,Oe),()=>{}}return je.callbacks.push(Fe),je.cancel||(je.cancel=Oe(((Oe,Fe)=>{je.result=[Oe,Fe];for(const F of je.callbacks)this.scheduler?this.scheduler.add((()=>{F(Oe,Fe)}),Le):F(Oe,Fe);setTimeout((()=>delete this.entries[F]),3e3)}))),()=>{je.result||(je.callbacks=je.callbacks.filter((F=>F!==Fe)),je.callbacks.length||(je.cancel(),delete this.entries[F]))}}},Le.aE=function(Le,Oe,Fe){const je=JSON.stringify(Le.request);return Le.data&&((this||F).deduped.entries[je]={result:[null,Le.data]}),(this||F).deduped.request(je,{type:"parseTile",isSymbolTile:Le.isSymbolTile,zoom:Le.tileZoom},(F=>{const Oe=ne(Le.request,((Le,Oe,je,qe)=>{Le?F(Le):Oe&&F(null,{vectorTile:Fe?void 0:new F_.VectorTile(new kx(Oe)),rawData:Oe,cacheControl:je,expires:qe})}));return()=>{Oe.cancel(),F()}}),Oe)},Le.aF=function(F){Th++,Th>lh&&(F.getActor().send("enforceCacheSizeLimit",ah),Th=0)},Le.aG=function(F){return F<=1?1:Math.pow(2,Math.floor(Math.log(F)/Math.LN2))},Le.aH=uu,Le.aI=Wm,Le.aJ=ry,Le.aK=Xm,Le.aL=function(F,Le){const Oe=document.createElement("video");Oe.muted=!0,Oe.onloadstart=function(){Le(null,Oe)};for(let Le=0;Le<F.length;Le++){const Fe=document.createElement("source");ie(F[Le])||(Oe.crossOrigin="Anonymous"),Fe.src=F[Le],Oe.appendChild(Fe)}return{cancel:()=>{}}},Le.aM=$m,Le.aN=function(F){return fetch(F).then((F=>F.arrayBuffer())).then((Le=>Sv(Le,0,F)))},Le.aO=Cv,Le.aP=class{constructor(F,Le,Oe,Fe){this.id=F,this.position=null!=Le?new ul(Le[0],Le[1]):new ul(0,0),this.orientation=null!=Oe?Oe:[0,0,0],this.nodes=Fe,this.uploaded=!1,this.aabb=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(F,Le){if(kl.mat4.multiply(F.matrix,Le,F.matrix),F.meshes)for(const Le of F.meshes){const Oe=Au.applyTransformFast(Le.aabb,F.matrix);this.aabb.encapsulate(Oe)}if(F.children)for(const Le of F.children)this._applyTransformations(Le,F.matrix)}computeBoundsAndApplyParent(){const F=kl.mat4.identity([]);for(const Le of this.nodes)this._applyTransformations(Le,F)}computeModelMatrix(F,Le,Oe,Fe,je,qe,He=!1){By(this.matrix,this,F.transform,this.position,Le,Oe,Fe,je,qe,He)}upload(F){if(!this.uploaded){for(const Le of this.nodes)Dy(Le,F);for(const F of this.nodes)Ry(F);this.uploaded=!0}}destroy(){for(const F of this.nodes)Ly(F)}},Le.aQ=ot,Le.aR=Kd,Le.aS=gl,Le.aT=xl,Le.aU=Ma,Le.aV=ja,Le.aW=st,Le.aX=no,Le.aY=zm,Le.aZ=function(){zf.isLoading()||zf.isLoaded()||"deferred"!==Vs()||Cs()},Le.a_=Qs,Le.aa=Rs,Le.ab=ts,Le.ac=Il,Le.ad=kl,Le.ae=tt,Le.af=$s,Le.ag=$u,Le.ah=Ee,Le.ai=sp,Le.aj=ze,Le.ak=H,Le.al=Se,Le.am=class{constructor(F){this.specification=F}possiblyEvaluate(F,Le){return function([F,Le]){const Oe=mt([1,F,Le]);return{x:Oe.x,y:Oe.y,z:Oe.z}}(F.expression.evaluate(Le))}interpolate(F,Le,Oe){return{x:Ee(F.x,Le.x,Oe),y:Ee(F.y,Le.y,Oe),z:Ee(F.z,Le.z,Oe)}}},Le.an=function(F,Le,Oe=0,Fe=!0){const je=new ic(Oe,Oe),qe=F.sub(je),He=Le.add(je),xt=[qe,new ic(He.x,qe.y),He,new ic(qe.x,He.y)];return Fe&&xt.push(qe.clone()),xt},Le.ao=function(F,Le){const Oe=[];for(let Fe=0;Fe<F.length;Fe++){const je=et(Fe-1,-1,F.length-1),qe=et(Fe+1,-1,F.length-1),He=F[Fe],xt=F[qe],jt=F[je].sub(He).unit(),Gt=xt.sub(He).unit(),bi=Gt.angleWithSep(jt.x,jt.y),wi=jt.add(Gt).unit().mult(-1*Le/Math.sin(bi/2));Oe.push(He.add(wi))}return Oe},Le.ap=Jd,Le.aq=Xl,Le.ar=function(F,Le,Oe=0){return kl.vec3.fromValues(((Le.x-Oe)*F.scale-F.x)*sp,(Le.y*F.scale-F.y)*sp,vl(Le.z,Le.y))},Le.as=gu,Le.at=Wp,Le.au=function(F){let Le=1/0,Oe=1/0,Fe=-1/0,je=-1/0;for(const qe of F)Le=Math.min(Le,qe.x),Oe=Math.min(Oe,qe.y),Fe=Math.max(Fe,qe.x),je=Math.max(je,qe.y);return{min:new ic(Le,Oe),max:new ic(Fe,je)}},Le.av=dl,Le.aw=Hl,Le.ax=Pl,Le.ay=Q,Le.az=Tm,Le.b=function(F){return Zc.API_FONTS_REGEX.test(F)},Le.b$=oy,Le.b0=Ov,Le.b1=gt,Le.b2=Yp,Le.b3=_h,Le.b4=Vl,Le.b5=_a,Le.b6=Ka,Le.b7=d_,Le.b8=xo,Le.b9=vc,Le.bA=Jh,Le.bB=Nd,Le.bC=Cd,Le.bD=Kf,Le.bE=$v,Le.bF=et,Le.bG=vt,Le.bH=yl,Le.bI=function(F,Le,Oe){F[4*Le+0]=Oe[0],F[4*Le+1]=Oe[1],F[4*Le+2]=Oe[2],F[4*Le+3]=Oe[3]},Le.bJ=Co,Le.bK=zo,Le.bL=ko,Le.bM=Eo,Le.bN=Po,Le.bO=ul,Le.bP=vm,Le.bQ=lu,Le.bR=Mu,Le.bS=ay,Le.bT=ou,Le.bU=Vu,Le.bV=function(F,Le,Oe,Fe,je,qe,He,xt,jt){if("globe"===jt.name)return Vu(F,Le,new ou(Oe,Fe,je),!1);const Gt=Kd({z:Oe,x:Fe,y:je},jt);return new Au([(qe+Gt.x/Gt.scale)*Le,Le*(Gt.y/Gt.scale),He],[(qe+Gt.x2/Gt.scale)*Le,Le*(Gt.y2/Gt.scale),xt])},Le.bW=function(F,Le,Oe){let Fe=0;for(let Oe=0;Oe<2;++Oe){const je=0;F[Oe]>je&&(Fe+=(F[Oe]-je)*(F[Oe]-je)),Le[Oe]<je&&(Fe+=(je-Le[Oe])*(je-Le[Oe]))}return Fe},Le.bX=e_,Le.bY=Lm,Le.bZ=function(F){const Le=kl.mat4.identity(new Float64Array(16));kl.mat4.multiply(Le,F.pixelMatrix,F.globeMatrix);const Oe=[0,Bm,0],Fe=[0,Nm,0];return kl.vec3.transformMat4(Oe,Oe,Le),kl.vec3.transformMat4(Fe,Fe,Le),[Oe[0]>0&&Oe[0]<=F.width&&Oe[1]>0&&Oe[1]<=F.height&&!Yu(F,new ul(F.center.lat,90)),Fe[0]>0&&Fe[0]<=F.width&&Fe[1]>0&&Fe[1]<=F.height&&!Yu(F,new ul(F.center.lat,-90))]},Le.b_=function(F,Le){const{scale:Oe}=F.tileTransform,Fe=Oe*sp/(F.tileSize*Math.pow(2,Le.zoom-F.tileID.overscaledZ+F.tileID.canonical.z));return kl.mat2.scale(new Float32Array(4),Le.inverseAdjustmentMatrix,[Fe,Fe])},Le.ba=eb,Le.bb=function(F,Le){const Oe=$u(Le.zoom);if(0===Oe)return ku(F);const Fe=Cu(F),je=Du(Fe),qe=dl(Fe.getWest())*Le.worldSize,He=dl(Fe.getEast())*Le.worldSize,xt=ml(Fe.getNorth())*Le.worldSize,jt=ml(Fe.getSouth())*Le.worldSize,Gt=[qe,xt,0],bi=[He,xt,0],wi=[qe,jt,0],qr=[He,jt,0],Xn=kl.mat4.invert([],Le.globeMatrix);return kl.vec3.transformMat4(Gt,Gt,Xn),kl.vec3.transformMat4(bi,bi,Xn),kl.vec3.transformMat4(wi,wi,Xn),kl.vec3.transformMat4(qr,qr,Xn),je[0]=Tu(je[0],wi,Oe),je[1]=Tu(je[1],qr,Oe),je[2]=Tu(je[2],bi,Oe),je[3]=Tu(je[3],Gt,Oe),Au.fromPoints(je)},Le.bc=Ou,Le.bd=Ru,Le.be=Tu,Le.bf=wa,Le.bg=u_,Le.bh=ev,Le.bi=kx,Le.bj=ne,Le.bk=function(F,Le){const Oe=[];for(const Fe in F)Fe in Le||Oe.push(Fe);return Oe},Le.bl=rt,Le.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],Le.bn=$,Le.bo=function(F,Le){const{x:Oe,y:Fe}=F.point,je=qu(Oe,Fe,F.worldSize/F._pixelsPerMercatorPixel,0,0);return kl.mat4.multiply(je,je,Nu(ku(Le)))},Le.bp=wf,Le.bq=Nx,Le.br=_f,Le.bs=function(F,Le,Oe,Fe,je){const qe=5*Le+2;F.float32[qe+0]=Oe,F.float32[qe+1]=Fe,F.float32[qe+2]=je},Le.bt=Im,Le.bu=ud,Le.bv=Fl,Le.bw=Mx,Le.bx=jh,Le.by=mb,Le.bz=Kh,Le.c=St,Le.c$=tf,Le.c0=sy,Le.c1=function(F){const Le=sy(F,!0);return kl.mat2.invert([],[Le[0],Le[1],Le[4],Le[5]])},Le.c2=xu,Le.c3=function(F){const{x:Le,y:Oe}=F.point,{lng:Fe,lat:je}=F._center;return qu(Le,Oe,F.worldSize,Fe,je)},Le.c4=X,Le.c5=cu,Le.c6=Rm,Le.c7=function(F){const Le=Math.round((F+45+360)%360/90)%4;return ac[Le]},Le.c8=45,Le.c9=ke,Le.cA=Bo,Le.cB=class extends So{constructor(F){super(F),this.current=um}set(F,Le,Oe){if(this.fetchUniformLocation(F,Le))for(let F=0;F<9;F++)if(Oe[F]!==this.current[F]){this.current=Oe,this.gl.uniformMatrix3fv(this.location,!1,Oe);break}}},Le.cC=W,Le.cD=function(F,Le,Oe){const Fe=$u(Oe.zoom),je=F.style.map._antialias,qe=F.terrain&&F.terrain.exaggeration()>0;return 0===Fe&&!je&&!qe},Le.cE=function(F){const Le=F.pixelsPerMeter,Oe=Le/yl(1,F.center.lat),Fe=kl.mat4.identity(new Float64Array(16));return kl.mat4.translate(Fe,Fe,[F.point.x,F.point.y,0]),kl.mat4.scale(Fe,Fe,[Oe,Oe,Le]),Float32Array.from(Fe)},Le.cF=Cu,Le.cG=function(F){const Le=e_-5;F=Q(F,-Le,Le)/Le*90;const Oe=Math.pow(Math.abs(Math.sin(H(F))),3);return Math.round(Oe*(Fm.length-1))},Le.cH=function(F,Le,Oe,Fe){const je=Le.getNorth(),qe=Le.getSouth(),He=Le.getWest(),xt=Le.getEast(),jt=1<<F.z,Gt=xt-He,bi=je-qe,wi=Gt/km,qr=-bi/Fm[Oe],Xn=[0,wi,0,qr,0,0,je,He,0];if(F.z>0){const F=180/Fe;kl.mat3.multiply(Xn,Xn,[F/Gt+1,0,0,0,F/bi+1,0,-.5*F/wi,.5*F/qr,1])}return Xn[2]=jt,Xn[5]=F.x,Xn[8]=F.y,Xn},Le.cI=ku,Le.cJ=function(F,Le,Oe){const Fe=kl.mat4.identity(new Float64Array(16)),je=(Le/(1<<F)-.5)*Math.PI*2;return kl.mat4.rotateY(Fe,Oe.globeMatrix,je),Float32Array.from(Fe)},Le.cK=class{isDataAvailableAtPoint(F){const Le=this._source();if(this.isUsingMockSource()||!Le||F.y<0||F.y>1)return!1;const Oe=Le.getSource().maxzoom,Fe=1<<Oe,je=Math.floor(F.x),qe=Math.floor((F.x-je)*Fe),He=Math.floor(F.y*Fe),xt=this.findDEMTileFor(new uu(Oe,je,Oe,qe,He));return!(!xt||!xt.dem)}getAtPointOrZero(F,Le=0){return this.getAtPoint(F,Le)||0}getAtPoint(F,Le,Oe=!0){if(this.isUsingMockSource())return null;null==Le&&(Le=null);const Fe=this._source();if(!Fe)return Le;if(F.y<0||F.y>1)return Le;const je=Fe.getSource().maxzoom,qe=1<<je,He=Math.floor(F.x),xt=F.x-He,jt=new uu(je,He,je,Math.floor(xt*qe),Math.floor(F.y*qe)),Gt=this.findDEMTileFor(jt);if(!Gt||!Gt.dem)return Le;const bi=Gt.dem,wi=1<<Gt.tileID.canonical.z,qr=(xt*wi-Gt.tileID.canonical.x)*bi.dim,Xn=(F.y*wi-Gt.tileID.canonical.y)*bi.dim,Yn=Math.floor(qr),yo=Math.floor(Xn);return(Oe?this.exaggeration():1)*Ee(Ee(bi.get(Yn,yo),bi.get(Yn,yo+1),Xn-yo),Ee(bi.get(Yn+1,yo),bi.get(Yn+1,yo+1),Xn-yo),qr-Yn)}getAtTileOffset(F,Le,Oe){const Fe=1<<F.canonical.z;return this.getAtPointOrZero(new Il(F.wrap+(F.canonical.x+Le/sp)/Fe,(F.canonical.y+Oe/sp)/Fe))}getAtTileOffsetFunc(F,Le,Oe,Fe){return je=>{const qe=this.getAtTileOffset(F,je.x,je.y),He=Fe.upVector(F.canonical,je.x,je.y),xt=Fe.upVectorScale(F.canonical,Le,Oe).metersToTile;return kl.vec3.scale(He,He,qe*xt),He}}getForTilePoints(F,Le,Oe,Fe){if(this.isUsingMockSource())return!1;const je=Fy.create(this,F,Fe);return!!je&&(Le.forEach((F=>{F[2]=this.exaggeration()*je.getElevationAt(F[0],F[1],Oe)})),!0)}getMinMaxForTile(F){if(this.isUsingMockSource())return null;const Le=this.findDEMTileFor(F);if(!Le||!Le.dem)return null;const Oe=Le.dem.tree,Fe=Le.tileID,je=1<<F.canonical.z-Fe.canonical.z;let qe=F.canonical.x/je-Fe.canonical.x,He=F.canonical.y/je-Fe.canonical.y,xt=0;for(let Le=0;Le<F.canonical.z-Fe.canonical.z&&!Oe.leaves[xt];Le++){qe*=2,He*=2;const F=2*Math.floor(He)+Math.floor(qe);xt=Oe.childOffsets[xt]+F,qe%=1,He%=1}return{min:this.exaggeration()*Oe.minimums[xt],max:this.exaggeration()*Oe.maximums[xt]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(F,Le,Oe){throw new Error("Pure virtual method called.")}pointCoordinate(F){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(F){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const F=this.visibleDemTiles;if(0===F.length)return null;let Le=!1,Oe=Number.MAX_VALUE,Fe=Number.MIN_VALUE;for(const je of F){const F=this.getMinMaxForTile(je.tileID);F&&(Oe=Math.min(Oe,F.min),Fe=Math.max(Fe,F.max),Le=!0)}return Le?{min:Oe,max:Fe}:null}},Le.cL=fc,Le.cM=Iu,Le.cN=function(F,Le){return[Math.pow(F[0],2.2)*Le,Math.pow(F[1],2.2)*Le,Math.pow(F[2],2.2)*Le]},Le.cO=ju,Le.cP=Mt,Le.cQ=wt,Le.cR=256,Le.cS=function(F,Le){const Oe=[0,0,0],Fe=Ou(ku(Le.canonical));return kl.vec3.transformMat4(Oe,Oe,Fe),kl.vec3.transformMat4(Oe,Oe,F),Oe},Le.cT=F=>({u_camera_to_center_distance:new Eo(F),u_extrude_scale:new Lo(F),u_device_pixel_ratio:new Eo(F),u_matrix:new Co(F),u_inv_rot_matrix:new Co(F),u_merc_center:new zo(F),u_tile_id:new ko(F),u_zoom_transition:new Eo(F),u_up_dir:new ko(F),u_emissive_strength:new Eo(F)}),Le.cU=F=>({u_matrix:new Co(F),u_pixels_to_tile_units:new Lo(F),u_device_pixel_ratio:new Eo(F),u_width_scale:new Eo(F),u_floor_width_scale:new Eo(F),u_units_to_pixels:new zo(F),u_dash_image:new Po(F),u_gradient_image:new Po(F),u_image_height:new Eo(F),u_texsize:new zo(F),u_tile_units_to_pixels:new Eo(F),u_alpha_discard_threshold:new Eo(F),u_trim_offset:new zo(F),u_trim_fade_range:new zo(F),u_trim_color:new To(F),u_emissive_strength:new Eo(F),u_zbias_factor:new Eo(F),u_tile_to_meter:new Eo(F)}),Le.cV=F=>({u_matrix:new Co(F),u_texsize:new zo(F),u_pixels_to_tile_units:new Lo(F),u_device_pixel_ratio:new Eo(F),u_width_scale:new Eo(F),u_floor_width_scale:new Eo(F),u_image:new Po(F),u_units_to_pixels:new zo(F),u_tile_units_to_pixels:new Eo(F),u_alpha_discard_threshold:new Eo(F),u_trim_offset:new zo(F),u_trim_fade_range:new zo(F),u_trim_color:new To(F),u_emissive_strength:new Eo(F),u_zbias_factor:new Eo(F),u_tile_to_meter:new Eo(F)}),Le.cW=Na,Le.cX=Ex,Le.cY=Ix,Le.cZ=Ku,Le.c_=(F,Le,Oe,Fe,je,qe)=>{const He=F.transform,xt="globe"===He.projection.name;let jt;if("map"===qe.paint.get("circle-pitch-alignment"))if(xt){const F=ju(He.zoom,Le.canonical)*He._pixelsPerMercatorPixel;jt=Float32Array.from([F,0,0,F])}else jt=He.calculatePixelsToTileUnitsMatrix(Oe);else jt=new Float32Array([He.pixelsToGLUnits[0],0,0,He.pixelsToGLUnits[1]]);const Gt={u_camera_to_center_distance:F.transform.getCameraToCenterDistance(He.projection),u_matrix:F.translatePosMatrix(Le.projMatrix,Oe,qe.paint.get("circle-translate"),qe.paint.get("circle-translate-anchor")),u_device_pixel_ratio:rh.devicePixelRatio,u_extrude_scale:jt,u_inv_rot_matrix:y_,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:qe.paint.get("circle-emissive-strength")};if(xt){Gt.u_inv_rot_matrix=Fe,Gt.u_merc_center=je,Gt.u_tile_id=[Le.canonical.x,Le.canonical.y,1<<Le.canonical.z],Gt.u_zoom_transition=$u(He.zoom);const F=je[0]*sp,Oe=je[1]*sp;Gt.u_up_dir=He.projection.upVector(new ou(0,0,0),F,Oe)}return Gt},Le.ca=fl,Le.cb=To,Le.cc=function(F,Le,Oe){const Fe=Math.sqrt(F*F+Le*Le+Oe*Oe),je=Fe>0?Math.acos(Oe/Fe)*sc:0;let qe=0!==F||0!==Le?Math.atan2(-Le,-F)*sc+90:0;return qe<0&&(qe+=360),[Fe,qe,je]},Le.cd=Al,Le.ce=Au,Le.cf=mt,Le.cg=function(F){return[Math.pow(F[0],1/2.2),Math.pow(F[1],1/2.2),Math.pow(F[2],1/2.2)]},Le.ch=function(F,Le){return F.readFields(dg,{icons:[]},Le)},Le.ci=function(F){return F({pluginStatus:Mf,pluginURL:If}),Cf.on("pluginStateChange",F),F},Le.cj=ag,Le.ck=bd,Le.cl=Xx,Le.cm=Bh,Le.cn=ks,Le.co=Rt,Le.cp=pu,Le.cq=ct,Le.cr=function(F){const Le=F.indexOf(kf);return Le>=0?F.slice(0,Le):F},Le.cs=function(F){return F.indexOf(kf)>=0},Le.ct=function(F){const Le=F.indexOf(kf);return Le>=0?F.slice(Le+1):""},Le.cu=function(F){const Le=[],Oe=F.id;return void 0===Oe&&Le.push({message:`layers.${Oe}: missing required property "id"`}),void 0===F.render&&Le.push({message:`layers.${Oe}: missing required method "render"`}),F.renderingMode&&"2d"!==F.renderingMode&&"3d"!==F.renderingMode&&Le.push({message:`layers.${Oe}: property "renderingMode" must be either "2d" or "3d"`}),Le},Le.cv=function(F,Le,Oe,Fe){return"custom"===F.type?new ny(F,Le):new Tb[F.type](F,Le,Oe,Fe)},Le.cw=ut,Le.cx=class extends Ov{constructor(F,Le){super(F._vectorTileFeature,F._z,F._x,F._y,F.id),F.state&&(this.state=Object.assign({},F.state)),this.target=Le.target,this.namespace=Le.namespace,Le.properties&&(this.properties=Le.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=F.source,this.sourceLayer=F.sourceLayer,this.layer=F.layer)}toJSON(){const F=super.toJSON();return F.target=this.target,F.namespace=this.namespace,F}},Le.cy=Cf,Le.cz=re,Le.d=function(F){return Zc.API_TILEJSON_REGEX.test(F)},Le.d$=Lv,Le.d0=er,Le.d1=(F,Le,Oe,Fe,je,qe,He,xt)=>{const jt=F.transform,Gt=jt.pitch<15?Kp(.07,.7,Q((14-jt.zoom)/5,0,1)):.07,bi="none"===Oe.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:Qp(F,Le,Oe,Fe),u_texsize:Le.imageAtlasTexture?Le.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:jt.calculatePixelsToTileUnitsMatrix(Le),u_device_pixel_ratio:je,u_width_scale:qe,u_floor_width_scale:He,u_image:0,u_tile_units_to_pixels:Jp(Le,jt),u_units_to_pixels:[1/jt.pixelsToGLUnits[0],1/jt.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:xt,u_trim_fade_range:Oe.paint.get("line-trim-fade-range"),u_trim_color:Oe.paint.get("line-trim-color").toRenderColor(bi?null:Oe.lut).toArray01(),u_emissive_strength:Oe.paint.get("line-emissive-strength"),u_zbias_factor:Gt,u_tile_to_meter:Al(Le.tileID.canonical,0)}},Le.d2=(F,Le,Oe,Fe,je,qe,He,xt,jt)=>{const Gt=F.transform,bi=Gt.calculatePixelsToTileUnitsMatrix(Le),wi="none"===Oe.paint.get("line-trim-color-use-theme").constantOr("default"),qr=Gt.pitch<15?Kp(.07,.7,Q((14-Gt.zoom)/5,0,1)):.07;return{u_matrix:Qp(F,Le,Oe,Fe),u_pixels_to_tile_units:bi,u_device_pixel_ratio:qe,u_width_scale:He,u_floor_width_scale:xt,u_units_to_pixels:[1/Gt.pixelsToGLUnits[0],1/Gt.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:je,u_texsize:ef(Oe)&&Le.lineAtlasTexture?Le.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Jp(Le,F.transform),u_alpha_discard_threshold:0,u_trim_offset:jt,u_trim_fade_range:Oe.paint.get("line-trim-fade-range"),u_trim_color:Oe.paint.get("line-trim-color").toRenderColor(wi?null:Oe.lut).toArray01(),u_emissive_strength:Oe.paint.get("line-emissive-strength"),u_zbias_factor:qr,u_tile_to_meter:Al(Le.tileID.canonical,0)}},Le.d3=at,Le.d4=dc,Le.d5=vl,Le.d6=Pp,Le.d7=l_,Le.d8=vp,Le.d9=hg,Le.dA=Q_,Le.dB=K,Le.dC=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},Le.dD=mc,Le.dE=Ml,Le.dF=al,Le.dG=function([F,Le,Oe]){const Fe=Math.hypot(F,Le,Oe),je=Math.atan2(F,Oe),qe=.5*Math.PI-Math.acos(-Le/Fe);return new ul(X(je),X(qe))},Le.dH=uy,Le.dI=function(F){const Le=F.navigator?F.navigator.userAgent:null;return!!function(F){if(null==xc){const Le=F.navigator?F.navigator.userAgent:null;xc=!!F.safari||!(!Le||!(/\b(iPad|iPhone|iPod)\b/.test(Le)||Le.match("Safari")&&!Le.match("Chrome")))}return xc}(F)&&Le&&(Le.match("Version/15.4")||Le.match("Version/15.5")||Le.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},Le.dJ=function(F,Le){ah=F,lh=Le},Le.dK=Yu,Le.dL=Gu,Le.dM=function(F){const Le=[0,0,0],Oe=kl.mat4.identity(new Float64Array(16));return kl.mat4.multiply(Oe,F.pixelMatrix,F.globeMatrix),kl.vec3.transformMat4(Le,Le,Oe),new ic(Le[0],Le[1])},Le.dN=function(F,Le,Oe=!1){if(Mf===yf||Mf===xf||Mf===Tf)throw new Error("setRTLTextPlugin cannot be called multiple times.");If=rh.resolveURL(F),Mf=yf,Ef=Le,Ts(),Oe||Cs()},Le.dO=Vs,Le.dP=function(){ag().acquire(Eb)},Le.dQ=function(){const F=Mb;F&&(F.isPreloaded()&&1===F.numActive()?(F.release(Eb),Mb=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},Le.dR=rg,Le.dS=function(F){const Le=qt();if(!Le)return;const Oe=Le.delete(oh);F&&Oe.catch(F).then((()=>F()))},Le.dT=Sb,Le.dU=cv,Le.dV=function(F){lw=rh.resolveURL(F),dw||(dw=new ng(ag(),new _e)),dw.broadcast("setDracoUrl",lw)},Le.dW=hv,Le.dX=function(F){hw=rh.resolveURL(F),dw||(dw=new ng(ag(),new _e)),dw.broadcast("setMeshoptUrl",hw)},Le.dY=us,Le.dZ=hc,Le.d_=Zx,Le.da=450,Le.db=7,Le.dc=tb,Le.dd=va,Le.de=to,Le.df=256,Le.dg=Nu,Le.dh=za,Le.di=Ga,Le.dj=Ya,Le.dk=function(F,Le,Oe,Fe,je){return Q((F-Le)/(Oe-Le)*(je-Fe)+Fe,Fe,je)},Le.dl=Ei,Le.dm=wl,Le.dn=class{constructor(F,Le,Oe,Fe){this.context=F,this.format=Fe,this.size=Oe,this.texture=F.gl.createTexture();const[je,qe,He]=this.size,{gl:xt}=F;xt.bindTexture(xt.TEXTURE_3D,this.texture),F.pixelStoreUnpackFlipY.set(!1),F.pixelStoreUnpack.set(1),F.pixelStoreUnpackPremultiplyAlpha.set(!1),xt.texImage3D(xt.TEXTURE_3D,0,this.format,je,qe,He,0,Um(this.format),jm(this.format),Le.data)}bind(F,Le){const{context:Oe}=this,{gl:Fe}=Oe;Fe.bindTexture(Fe.TEXTURE_3D,this.texture),F!==this.minFilter&&(Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_MAG_FILTER,F),Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_MIN_FILTER,F),this.minFilter=F),Le!==this.wrapS&&(Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_WRAP_S,Le),Fe.texParameteri(Fe.TEXTURE_3D,Fe.TEXTURE_WRAP_T,Le),this.wrapS=Le)}destroy(){const{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}},Le.dp=fy,Le.dq=[1,1,1],Le.dr=Fy,Le.ds=xb,Le.dt=La,Le.du=Za,Le.dv=Zm,Le.dw=Xa,Le.dx=Ha,Le.dy=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new ic(1/0,1/0),max:new ic(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(F,Le=!1){const Oe=Hh(new ic(0,0),new ic(sp,sp),F),Fe=[];if(Le&&!Gh(Oe,this._globalClipBounds))return Fe;for(const Le of this._activeRegions){if(Le.hiddenByOverlap)continue;if(!Gh(Oe,Le))continue;const je=Xh(Le.min,Le.max,F);Fe.push({min:je.min,max:je.max,sourceId:this._sourceIds[Le.priority],footprint:Le.footprint,footprintTileId:Le.tileId,order:Le.order,clipMask:Le.clipMask,clipScope:Le.clipScope})}return Fe}setSources(F){this._setSources(F.map((F=>({getSourceId:()=>F.cache.id,getFootprints:()=>{const Le=[];for(const Oe of F.cache.getVisibleCoordinates()){const Fe=F.cache.getTile(Oe).buckets[F.layer];Fe&&Fe.updateFootprints(Oe.toUnwrapped(),Le)}return Le},getOrder:()=>F.order,getClipMask:()=>F.clipMask,getClipScope:()=>F.clipScope}))))}_addSource(F){const Le=F.getFootprints();if(0===Le.length)return;const Oe=F.getOrder(),Fe=F.getClipMask(),je=F.getClipScope();for(const F of Le){if(!F.footprint)continue;const Le=Hh(F.footprint.min,F.footprint.max,F.id);this._activeRegions.push({min:Le.min,max:Le.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:F.id,footprint:F.footprint,order:Oe,clipMask:Fe,clipScope:je})}this._sourceIds.push(F.getSourceId())}_computeReplacement(){this._activeRegions.sort(((F,Le)=>F.priority-Le.priority||qh(F.min,Le.min)||qh(F.max,Le.max)||F.order-Le.order||F.clipMask-Le.clipMask||function(F,Le){const r=(F,Le)=>F+Le;return F.length-Le.length||F.reduce(r,"").localeCompare(Le.reduce(r,""))}(F.clipScope,Le.clipScope)));let F=this._activeRegions.length!==this._prevRegions.length;if(!F){let Le=0;for(;!F&&Le!==this._activeRegions.length;){const Oe=this._activeRegions[Le],Fe=this._prevRegions[Le];F=Oe.priority!==Fe.priority||!$h(Oe,Fe)||Oe.order!==Fe.order||Oe.clipMask!==Fe.clipMask||!$(Oe.clipScope,Fe.clipScope),++Le}}if(F){++this._updateTime;for(const F of this._activeRegions)F.order!==Q_&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,F.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,F.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,F.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,F.max.y));const t=F=>{const Le=this._activeRegions;if(F>=Le.length)return F;const Oe=Le[F].priority;for(;F<Le.length&&Le[F].priority===Oe;)++F;return F};if(this._sourceIds.length>1){let F=0,Le=t(F);for(;F!==Le;){let Oe=F;const Fe=F;for(;Oe!==Le;){const F=this._activeRegions[Oe];F.hiddenByOverlap=!1;for(let Le=0;Le<Fe;Le++){const Oe=this._activeRegions[Le];if(!Oe.hiddenByOverlap&&F.order===Q_&&Gh(F,Oe)&&(F.hiddenByOverlap=Wh(F.footprint,F.tileId,Oe.footprint,Oe.tileId),F.hiddenByOverlap))break}++Oe}F=Le,Le=t(F)}}}}_setSources(F){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let Le=F.length-1;Le>=0;Le--)this._addSource(F[Le]);this._computeReplacement()}},Le.dz=class{constructor(F){this._createGrid(F),this._createPoles(F)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const F of this._poleSegments)F.destroy();for(const F of this._gridSegments)F.withSkirts.destroy(),F.withoutSkirts.destroy()}_fillGridMeshWithLods(F,Le){const Oe=new _a,Fe=new ja,je=[],qe=F+1+2,He=Le[0]+1,xt=Le[0]+1+(1+Le.length),l=(F,Le,Oe)=>{let Fe=F===qe-1?F-2:0===F?F:F-1;return Fe+=Oe?24575:0,[Fe,Le]};for(let F=0;F<qe;++F)Oe.emplaceBack(...l(F,0,!0));for(let F=0;F<He;++F)for(let Le=0;Le<qe;++Le)Oe.emplaceBack(...l(Le,F,(0===Le||Le===qe-1)&&!0));for(let F=0;F<Le.length;++F){const Fe=Le[F];for(let F=0;F<qe;++F)Oe.emplaceBack(...l(F,Fe,!0))}for(let F=0;F<Le.length;++F){const He=Fe.length,jt=Le[F]+1+2,Gt=new ja;for(let Oe=0;Oe<jt-1;Oe++){const je=Oe===jt-2,He=je?qe*(xt-Le.length+F-Oe):qe;for(let F=0;F<qe-1;F++){const Le=Oe*qe+F;0===Oe||je||0===F||F===qe-2?(Gt.emplaceBack(Le+1,Le,Le+He),Gt.emplaceBack(Le+He,Le+He+1,Le+1)):(Fe.emplaceBack(Le+1,Le,Le+He),Fe.emplaceBack(Le+He,Le+He+1,Le+1))}}const bi=xo.simpleSegment(0,He,Oe.length,Fe.length-He);for(let F=0;F<Gt.uint16.length;F+=3)Fe.emplaceBack(Gt.uint16[F],Gt.uint16[F+1],Gt.uint16[F+2]);const wi=xo.simpleSegment(0,He,Oe.length,Fe.length-He);je.push({withoutSkirts:bi,withSkirts:wi})}return{vertices:Oe,indices:Fe,segments:je}}_createGrid(F){const Le=this._fillGridMeshWithLods(km,Fm);this._gridSegments=Le.segments,this._gridBuffer=F.createVertexBuffer(Le.vertices,d_.members),this._gridIndexBuffer=F.createIndexBuffer(Le.indices,!0)}_createPoles(F){const Le=new ja;for(let F=0;F<=km;F++)Le.emplaceBack(0,F+1,F+2);this._poleIndexBuffer=F.createIndexBuffer(Le,!0);const Oe=new Ga,Fe=new Ga,je=new Ga,qe=new Ga;this._poleSegments=[];for(let F=0,Le=0;F<Rm;F++){const He=360/(1<<F);Oe.emplaceBack(0,-Tm,0,.5,0),Fe.emplaceBack(0,-Tm,0,.5,1),je.emplaceBack(0,-Tm,0,.5,.5),qe.emplaceBack(0,-Tm,0,.5,.5);for(let F=0;F<=km;F++){let Le=F/km,xt=0;const jt=Ee(0,He,Le),[Gt,bi,wi]=sl(__,g_,jt,Tm);Oe.emplaceBack(Gt,bi,wi,Le,xt),Fe.emplaceBack(Gt,bi,wi,Le,1-xt);const qr=H(jt);Le=.5+.5*Math.sin(qr),xt=.5+.5*Math.cos(qr),je.emplaceBack(Gt,bi,wi,Le,xt),qe.emplaceBack(Gt,bi,wi,Le,1-xt)}this._poleSegments.push(xo.simpleSegment(Le,0,66,64)),Le+=66}this._poleNorthVertexBuffer=F.createVertexBuffer(Oe,h_,!1),this._poleSouthVertexBuffer=F.createVertexBuffer(Fe,h_,!1),this._texturedPoleNorthVertexBuffer=F.createVertexBuffer(je,h_,!1),this._texturedPoleSouthVertexBuffer=F.createVertexBuffer(qe,h_,!1)}getGridBuffers(F,Le){return[this._gridBuffer,this._gridIndexBuffer,Le?this._gridSegments[F].withSkirts:this._gridSegments[F].withoutSkirts]}getPoleBuffers(F,Le){return[Le?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,Le?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[F]]}},Le.e=Zc,Le.e0=Nv,Le.e1=jp,Le.e2=B_,Le.e3="hd_road_elevation",Le.e4=class{static parseFrom(F,Le){const Oe=fh.parse(F);if(!Oe)return[];let{vertices:Fe,features:je}=Oe;const qe=1/Al(Le);je.sort(((F,Le)=>F.id-Le.id)),Fe.sort(((F,Le)=>F.id-Le.id||F.idx-Le.idx)),Fe=Fe.filter(((F,Le,Oe)=>Le===Oe.findIndex((Le=>Le.id===F.id&&Le.idx===F.idx))));const He=new Array;let xt=0;const jt=Fe.length;for(const F of je){if(F.constantHeight){He.push(new dh(F.id,F.bounds,F.constantHeight));continue}for(;xt!==jt&&Fe[xt].id<F.id;)xt++;if(xt===jt||Fe[xt].id!==F.id)continue;const Le=new Array,Oe=new Array,je=xt;for(;xt!==jt&&Fe[xt].id===F.id;){const F=Fe[xt];if(Le.push({position:F.position,height:F.height,extent:F.extent}),xt!==je&&Fe[xt-1].idx===F.idx-1){const F=xt-je;Oe.push({a:F-1,b:F})}xt++}He.push(new dh(F.id,F.bounds,void 0,Le,Oe,qe))}return He}},Le.e5=lt,Le.e6=gh,Le.e7=fd,Le.e8=Gx,Le.e9=function(F,Le,Oe,Fe,je,qe,He,xt=1,jt){F.createArrays(),F.tilePixelRatio=sp/(512*F.overscaling),F.compareText={},F.iconsNeedLinear=!1;const Gt=F.layers[0].layout,bi=F.layers[0]._unevaluatedLayout._values,wi={};wi.scaleFactor=xt,wi.textSizeScaleRange=Gt.get("text-size-scale-range"),wi.iconSizeScaleRange=Gt.get("icon-size-scale-range");const[qr,Xn]=wi.textSizeScaleRange,[Yn,yo]=wi.iconSizeScaleRange;wi.textScaleFactor=Q(wi.scaleFactor,qr,Xn),wi.iconScaleFactor=Q(wi.scaleFactor,Yn,yo);const bo=bi["text-size"],Do=bi["icon-size"];if("composite"===F.textSizeData.kind){const{minZoom:Le,maxZoom:Oe}=F.textSizeData;wi.compositeTextSizes=[bo.possiblyEvaluate(new Rs(Le),qe),bo.possiblyEvaluate(new Rs(Oe),qe)]}if("composite"===F.iconSizeData.kind){const{minZoom:Le,maxZoom:Oe}=F.iconSizeData;wi.compositeIconSizes=[Do.possiblyEvaluate(new Rs(Le),qe),Do.possiblyEvaluate(new Rs(Oe),qe)]}wi.layoutTextSize=bo.possiblyEvaluate(new Rs(He+1),qe),wi.layoutIconSize=Do.possiblyEvaluate(new Rs(He+1),qe),wi.textMaxSize=bo.possiblyEvaluate(new Rs(18),qe);const Ro=Gt.get("symbol-placement"),zs="map"===Gt.get("text-rotation-alignment")&&"point"!==Ro,Zs=Gt.get("text-size");let na=!1;const el=[];for(const He of F.features){const xt=Gt.get("text-font").evaluate(He,{},qe).join(","),qr=Zs.evaluate(He,{},qe)*wi.textScaleFactor,Xn=wi.layoutTextSize.evaluate(He,{},qe)*wi.textScaleFactor,Yn=wi.layoutIconSize.evaluate(He,{},qe)*wi.iconScaleFactor,yo={horizontal:{},vertical:void 0},bo=He.text;let Do,nl=[0,0];if(bo){const Fe=bo.toString(),bi=Gt.get("text-letter-spacing").evaluate(He,{},qe)*Mx,wi=Gt.get("text-line-height").evaluate(He,{},qe)*Mx,Yn=ys(Fe)?bi:0,Do=Gt.get("text-anchor").evaluate(He,{},qe),Zs=Gt.get("text-variable-anchor");if(!Zs){const F=Gt.get("text-radial-offset").evaluate(He,{},qe);nl=F?Cd(Do,[F*Mx,Jx]):Gt.get("text-offset").evaluate(He,{},qe).map((F=>F*Mx))}let na=zs?"center":Gt.get("text-justify").evaluate(He,{},qe);const el="point"===Ro,hl=el?Gt.get("text-max-width").evaluate(He,{},qe)*Mx:1/0,I=qe=>{F.allowVerticalPlacement&&ms(Fe)&&(yo.vertical=qf(bo,Le,Oe,je,xt,hl,wi,Do,qe,Yn,nl,Nx.vertical,!0,Xn,qr,jt))};if(!zs&&Zs){const F="auto"===na?Zs.map((F=>Nd(F))):[na];let Fe=!1;for(let qe=0;qe<F.length;qe++){const He=F[qe];if(!yo.horizontal[He])if(Fe)yo.horizontal[He]=yo.horizontal[0];else{const F=qf(bo,Le,Oe,je,xt,hl,wi,"center",He,Yn,nl,Nx.horizontal,!1,Xn,qr,jt);F&&(yo.horizontal[He]=F,Fe=1===F.positionedLines.length)}}I("left")}else{if("auto"===na&&(na=Nd(Do)),el||Gt.get("text-writing-mode").indexOf("horizontal")>=0||!ms(Fe)){const F=qf(bo,Le,Oe,je,xt,hl,wi,Do,na,Yn,nl,Nx.horizontal,!1,Xn,qr,jt);F&&(yo.horizontal[na]=F)}I(el?"left":na)}}let hl,pl,bl,Tl,kl,ec=!1;if(He.icon&&He.icon.hasPrimary()){const Le=Rd(He.icon,F.iconSizeData,bi["icon-size"],qe,F.zoom,He,jt,wi.iconScaleFactor);hl=Le.iconPrimary,pl=Le.iconSecondary;const Oe=hl.toString(),xt=Fe.get(Oe);xt&&(bl=Gt.get("icon-offset").evaluate(He,{},qe),Tl=Gt.get("icon-anchor").evaluate(He,{},qe),kl=Gt.get("icon-text-fit").evaluate(He,{},qe),Do=Qf(je.get(Oe),pl?je.get(pl.toString()):void 0,bl,Tl),ec=xt.sdf,void 0===F.sdfIcons?F.sdfIcons=xt.sdf:F.sdfIcons!==xt.sdf&&pt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(xt.pixelRatio!==F.pixelRatio||0!==Gt.get("icon-rotate").constantOr(1))&&(F.iconsNeedLinear=!0))}na=na||!(!He.icon||!He.icon.hasSecondary());const tc=Yd(yo.horizontal)||yo.vertical;F.iconsInText||(F.iconsInText=!!tc&&tc.iconsInText);const ic=Xn*wi.textScaleFactor/Mx,{defaultShapedIcon:oc,verticallyShapedIcon:sc}=Ud(F,Do,Gt,He,qe,yo,ic,bl,kl);Do=oc,el.push({feature:He,shapedTextOrientations:yo,shapedText:tc,shapedIcon:Do,iconPrimary:hl,iconSecondary:pl,iconOffset:bl,iconAnchor:Tl,verticallyShapedIcon:sc,layoutTextSize:Xn,layoutIconSize:Yn,textOffset:nl,isSDFIcon:ec,iconTextFit:kl})}return{featureData:el,sizes:wi,hasAnySecondaryIcon:na,textAlongLine:zs,symbolPlacement:Ro}},Le.ea=dd,Le.eb=function(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt){const{featureData:bi,hasAnySecondaryIcon:wi,sizes:qr,textAlongLine:Xn,symbolPlacement:Yn}=Le;for(const Le of bi){const{shapedIcon:Oe,verticallyShapedIcon:qe,feature:bi,shapedTextOrientations:yo,shapedText:bo,layoutTextSize:Do,textOffset:Ro,isSDFIcon:zs,iconPrimary:Zs,iconSecondary:na,iconTextFit:el,iconOffset:nl}=Le;Ld(Oe,Gt.iconPositions,Zs,na),Ld(qe,Gt.iconPositions,Zs,na),Fd(yo,Gt.iconPositions),(bo||Oe)&&jd(F,bi,yo,Oe,qe,jt,qr,Do,0,Ro,zs,Fe,je,He,xt,wi,el,nl,Xn,Yn)}Oe&&F.generateCollisionDebugBuffers(qe,F.collisionBoxArray,qr.textScaleFactor)},Le.ec=F_,Le.ed=hx,Le.ee=j,Le.ef=sh,Le.eg=Vf,Le.eh=e,Le.ei=function(F){let Le=0;if(new Uint32Array(F,0,1)[0]!==yw){const Oe=new Uint32Array(F,0,7),[,,Fe,je,qe,He]=Oe;Le=Oe.byteLength+je+qe+He+qe,(Fe!==F.byteLength||Le>=F.byteLength)&&pt("Invalid b3dm header information.")}return Sv(F,Le)},Le.ej=function(F,Le){const Oe=Cv(F);for(const F of Oe){for(const Le of F.meshes)Dv(Le);F.lights&&(F.lightMeshIndex=F.meshes.length,F.meshes.push(Rv(F.lights,Le)))}return Oe},Le.ek=Gy,Le.el=Qy,Le.em=zf,Le.en=function(F){$t(),null!=ph&&ph.then((Le=>{Le.keys().then((Oe=>{for(let Fe=0;Fe<Oe.length-F;Fe++)Le.delete(Oe[Fe])}))}))},Le.f=function(F){return 0===F.indexOf("mapbox:")},Le.g=function(F,Le){return re(nt(F,{method:"GET"}),Le)},Le.h=It,Le.i=function(F){return Zc.API_STYLE_REGEX.test(F)&&!St(F)},Le.j=function(F){return decodeURIComponent(atob(F).split("").map((F=>"%"+("00"+F.charCodeAt(0).toString(16)).slice(-2))).join(""))},Le.k=function(F){return btoa(encodeURIComponent(F).replace(/%([0-9A-F]{2})/g,((F,Le)=>String.fromCharCode(Number("0x"+Le)))))},Le.l=nt,Le.m=Mh,Le.n=function(F,Le){return re(nt(F,{type:"json"}),Le)},Le.o=le,Le.p=function(F,Le){return re(nt(F,{method:"POST"}),Le)},Le.q=rh,Le.r=pc,Le.s=function(F){try{const Le=self[F];return Le.setItem("_mapbox_test_",1),Le.removeItem("_mapbox_test_"),!0}catch(F){return!1}},Le.t=Vt,Le.u=function(){return function t(F){return F?(F^Math.random()*(16>>F/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()},Le.v=function(F){return!!F&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(F)},Le.w=pt,Le.x=function(){return Ab||(Ab=new rg),Ab},Le.y=Qg,Le.z=xe}));define(["./shared"],(function(Le){function t(F){const Le=F?F.url.toString():void 0;return Le?performance.getEntriesByName(Le):[]}function s(F){if("number"==typeof F||"boolean"==typeof F||"string"==typeof F||null==F)return JSON.stringify(F);if(Array.isArray(F)){let Le="[";for(const Oe of F)Le+=`${s(Oe)},`;return`${Le}]`}let Le="{";for(const Oe of Object.keys(F).sort())Le+=`${Oe}:${s(F[Oe])},`;return`${Le}}`}function i(F){let Oe="";for(const Fe of Le.bm)("model"!==F.type||"minzoom"!==Fe&&"maxzoom"!==Fe)&&(Oe+=`/${s(F[Fe])}`);return Oe}class o{constructor(F){this.keyCache={},this._layers={},this._layerConfigs={},F&&this.replace(F)}replace(F,Le){this._layerConfigs={},this._layers={},this.update(F,[],Le)}update(F,Oe,Fe){this._options=Fe;for(const Oe of F)this._layerConfigs[Oe.id]=Oe,(this._layers[Oe.id]=Le.cv(Oe,this.scope,null,this._options)).compileFilter(Fe),this.keyCache[Oe.id]&&delete this.keyCache[Oe.id];for(const F of Oe)delete this.keyCache[F],delete this._layerConfigs[F],delete this._layers[F];this.familiesBySource={};const je=function(F,Le){const Oe={};for(let Fe=0;Fe<F.length;Fe++){const je=F[Fe];let qe=Le&&Le[je.id];!qe&&(qe=i(je),"line"===je.type&&je.paint)&&function e(F){return"string"==typeof F&&"line-progress"===F||(Array.isArray(F)?F.some(e):!(!F||"object"!=typeof F)&&Object.values(F).some(e))}(je.paint["line-width"])&&(qe+=`/${s(je.paint["line-width"])}`),Le&&(Le[je.id]=qe);let He=Oe[qe];He||(He=Oe[qe]=[]),He.push(je)}const Fe=[];for(const F in Oe)Fe.push(Oe[F]);return Fe}(Object.values(this._layerConfigs),this.keyCache);for(const F of je){const Le=F.map((F=>this._layers[F.id])),Oe=Le[0];if("none"===Oe.visibility)continue;const Fe=Oe.source||"";let je=this.familiesBySource[Fe];je||(je=this.familiesBySource[Fe]={});const qe=Oe.sourceLayer||"_geojsonTileLayer";let He=je[qe];He||(He=je[qe]=[]),He.push(Le)}}}const Oe=1*Le.d_;class r{constructor(F){const Fe={},je=[];for(const Le in F){const qe=F[Le],He=Fe[Le]={};for(const F in qe.glyphs){const Le=qe.glyphs[+F];if(!Le||0===Le.bitmap.width||0===Le.bitmap.height)continue;const Fe=Le.metrics.localGlyph?Oe:1,xt={x:0,y:0,w:Le.bitmap.width+2*Fe,h:Le.bitmap.height+2*Fe};je.push(xt),He[F]=xt}}const{w:qe,h:He}=Le.H(je),xt=new Le.dZ({width:qe||1,height:He||1});for(const je in F){const qe=F[je];for(const F in qe.glyphs){const He=qe.glyphs[+F];if(!He||0===He.bitmap.width||0===He.bitmap.height)continue;const jt=Fe[je][F],Gt=He.metrics.localGlyph?Oe:1;Le.dZ.copy(He.bitmap,xt,{x:0,y:0},{x:jt.x+Gt,y:jt.y+Gt},He.bitmap)}}this.image=xt,this.positions=Fe}}Le.dY(r,"GlyphAtlas");class a{constructor(F){this.tileID=new Le.aH(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.lut=F.lut,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.scope=F.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=F.showCollisionBoxes,this.collectResourceTiming=!!F.request&&F.request.collectResourceTiming,this.promoteId=F.promoteId,this.isSymbolTile=F.isSymbolTile,this.tileTransform=Le.aR(F.tileID.canonical,F.projection),this.projection=F.projection,this.worldview=F.worldview,this.localizableLayerIds=F.localizableLayerIds,this.brightness=F.brightness,this.extraShadowCaster=!!F.extraShadowCaster,this.tessellationStep=F.tessellationStep,this.scaleFactor=F.scaleFactor}parse(F,Oe,Fe,je,qe){this.status="parsing",this.data=F,this.collisionBoxArray=new Le.aX;const He=new Le.d$(Object.keys(F.layers).sort()),xt=new Le.e0(this.tileID,this.promoteId);xt.bucketLayerIDs=[];const jt={},Gt=new Le.e1(256,256),bi={featureIndex:xt,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:Gt,availableImages:Fe,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},wi=Oe.familiesBySource[this.source];for(const Oe in wi){const je=F.layers[Oe];if(!je)continue;let qe=!1,Gt=!1,qr=!1;for(const F of wi[Oe])"symbol"===F[0].type?qe=!0:Gt=!0,F[0].is3D()&&"model"!==F[0].type&&(qr=!0);if(this.extraShadowCaster&&!qr)continue;if(!0===this.isSymbolTile&&!qe)continue;if(!1===this.isSymbolTile&&!Gt)continue;1===je.version&&Le.w(`Vector tile source "${this.source}" layer "${Oe}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Xn=He.encode(Oe),Yn=[];let yo=!1;for(let F=0,Fe=0;F<je.length;F++){const qe=je.feature(F),He=xt.getId(qe,Oe);if(this.localizableLayerIds&&this.localizableLayerIds.has(Oe)){const F=qe.properties?qe.properties.worldview:null;if(this.worldview&&"string"==typeof F)if("all"===F)qe.properties.$localized=!0;else{if(!F.split(",").includes(this.worldview))continue;qe.properties.$localized=!0,qe.properties.worldview=this.worldview}}!yo&&qe.properties&&qe.properties.hasOwnProperty(Le.e2)&&(yo=!0),Yn.push({feature:qe,id:He,index:Fe,sourceLayerIndex:Xn}),Fe++}yo&&!bi.elevationFeatures&&F.layers.hasOwnProperty(Le.e3)&&(bi.elevationFeatures=Le.e4.parseFrom(F.layers[Le.e3],this.canonical));for(const F of wi[Oe]){const Oe=F[0];(!this.extraShadowCaster||Oe.is3D()&&"model"!==Oe.type)&&(void 0!==this.isSymbolTile&&"symbol"===Oe.type!==this.isSymbolTile||Oe.minzoom&&this.zoom<Math.floor(Oe.minzoom)||Oe.maxzoom&&this.zoom>=Oe.maxzoom||"none"!==Oe.visibility&&(l(F,this.zoom,bi.brightness,Fe),(jt[Oe.id]=Oe.createBucket({index:xt.bucketLayerIDs.length,layers:F,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Xn,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(Yn,bi,this.tileID.canonical,this.tileTransform),xt.bucketLayerIDs.push(F.map((F=>Le.C(F.id,F.scope))))))}}let qr,Xn,Yn,yo,bo,Do;Gt.trim();const Ro={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},v=()=>{if(qr)return this.status="done",qe(qr);if(this.extraShadowCaster)this.status="done",qe(null,{buckets:Object.values(jt).filter((F=>!F.isEmpty())),featureIndex:xt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:bi.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Xn&&Yn&&yo){const F=new r(Xn),Oe=new Map;for(const[F,Fe]of Yn.entries()){const{imagePosition:je}=Le.e7(F,Fe,Le.e8);Oe.set(F,je)}const qe={};for(const je in jt){const He=jt[je];He instanceof Le.aY&&(l(He.layers,this.zoom,bi.brightness,Fe),qe[je]=Le.e9(He,Xn,F.positions,Yn,Oe,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio))}const He={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(je,Yn,bo,(()=>{He.iconsPending=!1,I(qe,F,He)})),this.rasterizeIfNeeded(je,yo,Do,(()=>{He.patternsPending=!1,I(qe,F,He)}))}},I=(F,Oe,je,He)=>{if(je.iconsPending||je.patternsPending)return;const wi=new Le.ea(Yn,yo,this.lut);for(const Oe in jt){const je=jt[Oe];if(Oe in F)Le.eb(je,F[Oe],this.showCollisionBoxes,Fe,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Yn,wi);else if(je.hasPattern&&(je instanceof Le.b2||je instanceof Le.b3||je instanceof Le.d8)){l(je.layers,this.zoom,bi.brightness,Fe);const F=Object.fromEntries(wi.patternPositions);je.addFeatures(bi,this.tileID.canonical,F,Fe,this.tileTransform,this.brightness)}}this.status="done",qe(null,{buckets:Object.values(jt).filter((F=>!F.isEmpty())),featureIndex:xt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Oe.image,lineAtlas:Gt,imageAtlas:wi,brightness:bi.brightness})};if(!this.extraShadowCaster){const F=Le.e5(bi.glyphDependencies,(F=>Object.keys(F).map(Number)));Object.keys(F).length?je.send("getGlyphs",{uid:this.uid,stacks:F,scope:this.scope},((F,Le)=>{qr||(qr=F,Xn=Le,v())}),void 0,!1,Ro):Xn={};const Oe=Array.from(bi.iconDependencies.keys()).map((F=>Le.I.parse(F)));Oe.length?je.send("getImages",{images:Oe,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((F,Le)=>{qr||(qr=F,Yn=new Map,bo=this.updateImageMapAndGetImageTaskQueue(Yn,Le,bi.iconDependencies),v())}),void 0,!1,Ro):(Yn=new Map,bo=new Map);const Fe=Array.from(bi.patternDependencies.keys()).map((F=>Le.I.parse(F)));Fe.length?je.send("getImages",{images:Fe,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((F,Le)=>{qr||(qr=F,yo=new Map,Do=this.updateImageMapAndGetImageTaskQueue(yo,Le,bi.patternDependencies),v())}),void 0,!1,Ro):(yo=new Map,Do=new Map)}if(bi.elevationFeatures&&bi.elevationFeatures.length>0){const F=[];for(const Oe of Object.values(jt))if(Oe instanceof Le.b3){const Le=Oe.getUnevaluatedPortalGraph();Le&&F.push(Le)}const Oe=Le.e6.evaluate(F);for(const F of Object.values(jt))F instanceof Le.b3&&F.setEvaluatedPortalGraph(Oe)}v()}rasterizeIfNeeded(F,Le,Oe,Fe){Array.from(Le.values()).some((F=>F.usvg))?this.rasterize(F,Le,Oe,Fe):Fe()}updateImageMapAndGetImageTaskQueue(F,Le,Oe){const Fe=new Map;for(const je of Le.keys()){const qe=Oe.get(je)||[];for(const Oe of qe){const je=Oe.toString(),qe=Le.get(Oe.id.toString());qe.usvg?Fe.has(je)||(Fe.set(je,Oe),F.set(je,Object.assign({},qe))):F.set(je,qe)}}return Fe}rasterize(F,Le,Oe,Fe){this.rasterizeTask=F.send("rasterizeImages",{scope:this.scope,tasks:Oe},((F,Oe)=>{if(!F)for(const[F,Fe]of Oe.entries()){const Oe=Object.assign(Le.get(F),{data:Fe});Le.set(F,Oe)}Fe()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function l(F,Oe,Fe,je){const qe=new Le.aa(Oe,{brightness:Fe});for(const Le of F)Le.recalculate(qe,je)}class c extends Le.E{constructor(F,Oe,Fe,je,qe,He){super(),this.actor=F,this.layerIndex=Oe,this.availableImages=Fe,this.loadVectorData=qe||Le.aE,this.loading={},this.loaded={},this.deduped=new Le.aD(F.scheduler),this.isSpriteLoaded=je,this.scheduler=F.scheduler,this.brightness=He}loadTile(F,Oe){const Fe=F.uid,je=F&&F.request,qe=je&&je.collectResourceTiming,He=this.loading[Fe]=new a(F);He.abort=this.loadVectorData(F,((xt,jt)=>{const Gt=!this.loading[Fe];if(delete this.loading[Fe],He.cancelRasterize(),Gt||xt||!jt)return He.status="done",Gt||(this.loaded[Fe]=He),Oe(xt);const bi=jt.rawData,wi={};jt.expires&&(wi.expires=jt.expires),jt.cacheControl&&(wi.cacheControl=jt.cacheControl),He.vectorTile=jt.vectorTile||new Le.ec.VectorTile(new Le.bi(bi));const p=()=>{He.parse(He.vectorTile,this.layerIndex,this.availableImages,this.actor,((F,Fe)=>{if(F||!Fe)return Oe(F);const He={};if(qe){const F=t(je);F.length>0&&(He.resourceTiming=JSON.parse(JSON.stringify(F)))}Oe(null,Le.l({rawTileData:bi.slice(0)},Fe,wi,He))}))};this.isSpriteLoaded?p():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(p,{type:"parseTile",isSymbolTile:F.isSymbolTile,zoom:F.tileZoom}):p()})),this.loaded=this.loaded||{},this.loaded[Fe]=He}))}reloadTile(F,Oe){const Fe=this.loaded,je=F.uid;if(Fe&&Fe[je]){const qe=Fe[je];qe.scaleFactor=F.scaleFactor,qe.showCollisionBoxes=F.showCollisionBoxes,qe.projection=F.projection,qe.brightness=F.brightness,qe.tileTransform=Le.aR(F.tileID.canonical,F.projection),qe.extraShadowCaster=F.extraShadowCaster,qe.lut=F.lut;const r=(F,Le)=>{const Fe=qe.reloadCallback;Fe&&(delete qe.reloadCallback,qe.parse(qe.vectorTile,this.layerIndex,this.availableImages,this.actor,Fe)),Oe(F,Le)};"parsing"===qe.status?qe.reloadCallback=r:"done"===qe.status&&(qe.vectorTile?qe.parse(qe.vectorTile,this.layerIndex,this.availableImages,this.actor,r):r())}else Oe(null,void 0)}abortTile(F,Le){const Oe=F.uid,Fe=this.loading[Oe];Fe&&(Fe.abort&&Fe.abort(),delete this.loading[Oe]),Le()}removeTile(F,Le){const Oe=this.loaded,Fe=F.uid;Oe&&Oe[Fe]&&delete Oe[Fe],Le()}}class h{loadTile(F,Oe){const{uid:Fe,encoding:je,rawImageData:qe,padding:He}=F,xt=ImageBitmap&&qe instanceof ImageBitmap?this.getImageData(qe,He):qe;Oe(null,new Le.ed(Fe,xt,je,He<1))}reloadTile(F,Le){Le(null,null)}abortTile(F,Le){Le()}removeTile(F,Le){Le()}getImageData(F,Le){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);const Oe=this.offscreenCanvasContext.getImageData(-Le,-Le,F.width+2*Le,F.height+2*Le);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),Oe}}Le.bh.setPbf(Le.bi);class u{constructor(F){this._mrt=new Le.bh(F.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=F.uid,this.tileID=F.tileID,this.source=F.source}parse(F,Oe){const Fe=this._mrt;this.status="parsing",this._entireBuffer=F;try{Fe.parseHeader(F),this._isHeaderLoaded=!0;const je=[];for(const Oe in Fe.layers){const qe=Fe.getLayer(Oe),He=qe.getDataRange(qe.getBandList()),xt=Fe.createDecodingTask(He),jt=F.slice(He.firstByte,He.lastByte+1),Gt=Le.bh.performDecoding(jt,xt).then((F=>xt.complete(null,F))).catch((F=>xt.complete(F,null)));je.push(Gt)}Promise.allSettled(je).then((()=>Oe(null,Fe)))}catch(F){Oe(F)}}}class d{constructor(F){this.actor=F,this.loading={},this.loaded={}}loadTile(F,Oe){const Fe=F.uid,je=F.request,qe=this.loading[Fe]=new u(F),{cancel:He}=Le.bj(je,((F,Le,je,He)=>{const xt=!this.loading[Fe];if(delete this.loading[Fe],xt||F||!Le)return qe.status="done",xt||(this.loaded[Fe]=qe),Oe(F);qe.parse(Le,((F,Le)=>{if(F||!Le)return Oe(F);Oe(null,Le,je,He)})),this.loaded[Fe]=qe}));qe.abort=He}reloadTile(F,Le){Le(null,void 0)}abortTile(F,Le){const Oe=F.uid,Fe=this.loading[Oe];Fe&&(Fe.abort&&Fe.abort(),delete this.loading[Oe]),Le()}removeTile(F,Le){const Oe=F.uid;this.loaded[Oe]&&delete this.loaded[Oe],Le()}decodeRasterArray({task:F,buffer:Oe},Fe){Le.bh.performDecoding(Oe,F).then((F=>Fe(null,F))).catch((F=>Fe(F)))}}const Fe=Le.ec.VectorTileFeature.prototype.toGeoJSON;class f{constructor(F){this._feature=F,this.extent=Le.ai,this.type=F.type,this.properties=F.tags,"id"in F&&!isNaN(F.id)&&(this.id=parseInt(F.id,10))}loadGeometry(){if(1===this._feature.type){const F=[];for(const Oe of this._feature.geometry)F.push([new Le.P(Oe[0],Oe[1])]);return F}{const F=[];for(const Oe of this._feature.geometry){const Fe=[];for(const F of Oe)Fe.push(new Le.P(F[0],F[1]));F.push(Fe)}return F}}toGeoJSON(F,Le,Oe){return Fe.call(this,F,Le,Oe)}}class g{constructor(F){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=Le.ai,this.length=F.length,this._features=F}feature(F){return new f(this._features[F])}}const je=64/4096,qe=128;class x{constructor(){this.features=new Map}clear(){this.features.clear()}load(F=[],Le){for(const Oe of F){const F=Oe.id;if(null==F)continue;let Fe=this.features.get(F);Fe&&this.updateCache(Fe,Le),Oe.geometry?(Fe=b(Oe),this.updateCache(Fe,Le),this.features.set(F,Fe)):this.features.delete(F),this.updateCache(Fe,Le)}}updateCache(F,Le){for(const{canonical:Oe,uid:Fe}of Object.values(Le)){const{z:je,x:qe,y:He}=Oe;w(F,Math.pow(2,je),qe,He)&&delete Le[Fe]}}getTile(F,Le,Oe){const Fe=Math.pow(2,F),je=[];for(const F of this.features.values())w(F,Fe,Le,Oe)&&je.push(M(F,Fe,Le,Oe));return{features:je}}getFeatures(){return[...this.features.values()]}}function w({minX:F,minY:Le,maxX:Oe,maxY:Fe},qe,He,xt){return F<(He+1+je)/qe&&Le<(xt+1+je)/qe&&Oe>(He-je)/qe&&Fe>(xt-je)/qe}function b(F){const{id:Le,geometry:Oe,properties:Fe}=F;if(!Oe)return;if("GeometryCollection"===Oe.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:je,coordinates:qe}=Oe,He={id:Le,type:1,geometry:[],tags:Fe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},xt=He.geometry;if("Point"===je)v(qe,xt,He);else if("MultiPoint"===je)for(const F of qe)v(F,xt,He);else if("LineString"===je)He.type=2,I(qe,xt,He);else if("MultiLineString"===je)He.type=2,S(qe,xt,He);else if("Polygon"===je)He.type=3,S(qe,xt,He,!0);else{if("MultiPolygon"!==je)throw new Error("Input data is not a valid GeoJSON object.");He.type=3;for(const F of qe)S(F,xt,He,!0)}return He}function v([F,Oe],Fe,je){const qe=Le.av(F);let He=Le.aC(Oe);He=He<0?0:He>1?1:He,Fe.push(qe,He),je.minX=Math.min(je.minX,qe),je.minY=Math.min(je.minY,He),je.maxX=Math.max(je.maxX,qe),je.maxY=Math.max(je.maxY,He)}function I(F,Le,Oe,Fe=!1,je=!1){const qe=[];for(const Le of F)v(Le,qe,Oe);Le.push(qe),Fe&&function(F,Le){let Oe=0;for(let Le=0,Fe=F.length,je=Fe-2;Le<Fe;je=Le,Le+=2)Oe+=(F[Le]-F[je])*(F[Le+1]+F[je+1]);if(Oe>0===Le)for(let Le=0,Oe=F.length;Le<Oe/2;Le+=2){const Fe=F[Le],je=F[Le+1];F[Le]=F[Oe-2-Le],F[Le+1]=F[Oe-1-Le],F[Oe-2-Le]=Fe,F[Oe-1-Le]=je}}(qe,je)}function S(F,Le,Oe,Fe=!1){for(let je=0;je<F.length;je++)I(F[je],Le,Oe,Fe,0===je)}function M(F,Oe,Fe,je){const{id:qe,type:He,geometry:xt,tags:jt}=F,Gt=[];if(1===He)!function(F,Oe,Fe,je,qe){for(let He=0;He<F.length;He+=2){const xt=Math.round(Le.ai*(F[He+0]*Oe-Fe)),jt=Math.round(Le.ai*(F[He+1]*Oe-je));qe.push([xt,jt])}}(xt,Oe,Fe,je,Gt);else for(const F of xt)T(F,Oe,Fe,je,Gt);return{id:qe,type:He,geometry:Gt,tags:jt}}function T(F,Oe,Fe,je,He){const xt=-qe,jt=Le.ai+qe;let Gt;for(let qe=0;qe<F.length-2;qe+=2){let bi=Math.round(Le.ai*(F[qe+0]*Oe-Fe)),wi=Math.round(Le.ai*(F[qe+1]*Oe-je)),qr=Math.round(Le.ai*(F[qe+2]*Oe-Fe)),Xn=Math.round(Le.ai*(F[qe+3]*Oe-je));const Yn=qr-bi,yo=Xn-wi;bi<xt&&qr<xt||(bi<xt?(wi+=Math.round(yo*((xt-bi)/Yn)),bi=xt):qr<xt&&(Xn=wi+Math.round(yo*((xt-bi)/Yn)),qr=xt),wi<xt&&Xn<xt||(wi<xt?(bi+=Math.round(Yn*((xt-wi)/yo)),wi=xt):Xn<xt&&(qr=bi+Math.round(Yn*((xt-wi)/yo)),Xn=xt),bi>=jt&&qr>=jt||(bi>=jt?(wi+=Math.round(yo*((jt-bi)/Yn)),bi=jt):qr>=jt&&(Xn=wi+Math.round(yo*((jt-bi)/Yn)),qr=jt),wi>=jt&&Xn>=jt||(wi>=jt?(bi+=Math.round(Yn*((jt-wi)/yo)),wi=jt):Xn>=jt&&(qr=bi+Math.round(Yn*((jt-wi)/yo)),Xn=jt),Gt&&bi===Gt[Gt.length-1][0]&&wi===Gt[Gt.length-1][1]||(Gt=[[bi,wi]],He.push(Gt)),Gt.push([qr,Xn])))))}}var He,xt,jt,Gt={exports:{}},bi=function(){if(jt)return Gt.exports;jt=1;var Oe=Le.eg(),Fe=function(){if(xt)return He;xt=1;var Oe=Le.ee(),Fe=Le.ef().VectorTileFeature;function i(Le,Oe){(this||F).options=Oe||{},(this||F).features=Le,(this||F).length=Le.length}function o(Le,Oe){(this||F).id="number"==typeof Le.id?Le.id:void 0,(this||F).type=Le.type,(this||F).rawGeometry=1===Le.type?[Le.geometry]:Le.geometry,(this||F).properties=Le.tags,(this||F).extent=Oe||4096}return He=i,i.prototype.feature=function(Le){return new o((this||F).features[Le],(this||F).options.extent)},o.prototype.loadGeometry=function(){var Le=(this||F).rawGeometry;(this||F).geometry=[];for(var Fe=0;Fe<Le.length;Fe++){for(var je=Le[Fe],qe=[],He=0;He<je.length;He++)qe.push(new Oe(je[He][0],je[He][1]));(this||F).geometry.push(qe)}return(this||F).geometry},o.prototype.bbox=function(){(this||F).geometry||this.loadGeometry();for(var Le=(this||F).geometry,Oe=1/0,Fe=-1/0,je=1/0,qe=-1/0,He=0;He<Le.length;He++)for(var xt=Le[He],jt=0;jt<xt.length;jt++){var Gt=xt[jt];Oe=Math.min(Oe,Gt.x),Fe=Math.max(Fe,Gt.x),je=Math.min(je,Gt.y),qe=Math.max(qe,Gt.y)}return[Oe,je,Fe,qe]},o.prototype.toGeoJSON=Fe.prototype.toGeoJSON,He}();function i(F){var Le=new Oe;return function(F,Le){for(var Oe in F.layers)Le.writeMessage(3,o,F.layers[Oe])}(F,Le),Le.finish()}function o(F,Le){var Oe;Le.writeVarintField(15,F.version||1),Le.writeStringField(1,F.name||""),Le.writeVarintField(5,F.extent||4096);var Fe={keys:[],values:[],keycache:{},valuecache:{}};for(Oe=0;Oe<F.length;Oe++)Fe.feature=F.feature(Oe),Le.writeMessage(2,n,Fe);var je=Fe.keys;for(Oe=0;Oe<je.length;Oe++)Le.writeStringField(3,je[Oe]);var qe=Fe.values;for(Oe=0;Oe<qe.length;Oe++)Le.writeMessage(4,h,qe[Oe])}function n(F,Le){var Oe=F.feature;void 0!==Oe.id&&Le.writeVarintField(1,Oe.id),Le.writeMessage(2,r,F),Le.writeVarintField(3,Oe.type),Le.writeMessage(4,c,Oe)}function r(F,Le){var Oe=F.feature,Fe=F.keys,je=F.values,qe=F.keycache,He=F.valuecache;for(var xt in Oe.properties){var jt=Oe.properties[xt],Gt=qe[xt];if(null!==jt){void 0===Gt&&(Fe.push(xt),qe[xt]=Gt=Fe.length-1),Le.writeVarint(Gt);var bi=typeof jt;"string"!==bi&&"boolean"!==bi&&"number"!==bi&&(jt=JSON.stringify(jt));var wi=bi+":"+jt,qr=He[wi];void 0===qr&&(je.push(jt),He[wi]=qr=je.length-1),Le.writeVarint(qr)}}}function a(F,Le){return(Le<<3)+(7&F)}function l(F){return F<<1^F>>31}function c(F,Le){for(var Oe=F.loadGeometry(),Fe=F.type,je=0,qe=0,He=Oe.length,xt=0;xt<He;xt++){var jt=Oe[xt],Gt=1;1===Fe&&(Gt=jt.length),Le.writeVarint(a(1,Gt));for(var bi=3===Fe?jt.length-1:jt.length,wi=0;wi<bi;wi++){1===wi&&1!==Fe&&Le.writeVarint(a(2,bi-1));var qr=jt[wi].x-je,Xn=jt[wi].y-qe;Le.writeVarint(l(qr)),Le.writeVarint(l(Xn)),je+=qr,qe+=Xn}3===Fe&&Le.writeVarint(a(7,1))}}function h(F,Le){var Oe=typeof F;"string"===Oe?Le.writeStringField(1,F):"boolean"===Oe?Le.writeBooleanField(7,F):"number"===Oe&&(F%1!=0?Le.writeDoubleField(3,F):F<0?Le.writeSVarintField(6,F):Le.writeVarintField(5,F))}return Gt.exports=i,Gt.exports.fromVectorTileJs=i,Gt.exports.fromGeojsonVt=function(F,Le){Le=Le||{};var Oe={};for(var je in F)Oe[je]=new Fe(F[je].features,Le),Oe[je].name=je,Oe[je].version=Le.version,Oe[je].extent=Le.extent;return i({layers:Oe})},Gt.exports.GeoJSONWrapper=Fe,Gt.exports}(),wi=Le.eh(bi);const qr={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:F=>F},Xn=Math.fround||(Yn=new Float32Array(1),F=>(Yn[0]=+F,Yn[0]));var Yn;const yo=3,bo=5,Do=6;class E{constructor(F){this.options=Object.assign(Object.create(qr),F),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(F){const{log:Le,minZoom:Oe,maxZoom:Fe}=this.options;Le&&console.time("total time");const je=`prepare ${F.length} points`;Le&&console.time(je),this.points=F;const qe=[];for(let Le=0;Le<F.length;Le++){const Oe=F[Le];if(!Oe.geometry)continue;const[Fe,je]=Oe.geometry.coordinates,He=Xn(B(Fe)),xt=Xn(G(je));qe.push(He,xt,1/0,Le,-1,1),this.options.reduce&&qe.push(0)}let He=this.trees[Fe+1]=this._createTree(qe);Le&&console.timeEnd(je);for(let F=Fe;F>=Oe;F--){const Oe=+Date.now();He=this.trees[F]=this._createTree(this._cluster(He,F)),Le&&console.log("z%d: %d clusters in %dms",F,He.numItems,+Date.now()-Oe)}return Le&&console.timeEnd("total time"),this}getClusters(F,Le){let Oe=((F[0]+180)%360+360)%360-180;const Fe=Math.max(-90,Math.min(90,F[1]));let je=180===F[2]?180:((F[2]+180)%360+360)%360-180;const qe=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)Oe=-180,je=180;else if(Oe>je){const F=this.getClusters([Oe,Fe,180,qe],Le),He=this.getClusters([-180,Fe,je,qe],Le);return F.concat(He)}const He=this.trees[this._limitZoom(Le)],xt=He.range(B(Oe),G(qe),B(je),G(Fe)),jt=He.data,Gt=[];for(const F of xt){const Le=this.stride*F;Gt.push(jt[Le+bo]>1?N(jt,Le,this.clusterProps):this.points[jt[Le+yo]])}return Gt}getChildren(F){const Le=this._getOriginId(F),Oe=this._getOriginZoom(F),Fe="No cluster with the specified id.",je=this.trees[Oe];if(!je)throw new Error(Fe);const qe=je.data;if(Le*this.stride>=qe.length)throw new Error(Fe);const He=this.options.radius/(this.options.extent*Math.pow(2,Oe-1)),xt=je.within(qe[Le*this.stride],qe[Le*this.stride+1],He),jt=[];for(const Le of xt){const Oe=Le*this.stride;qe[Oe+4]===F&&jt.push(qe[Oe+bo]>1?N(qe,Oe,this.clusterProps):this.points[qe[Oe+yo]])}if(0===jt.length)throw new Error(Fe);return jt}getLeaves(F,Le,Oe){const Fe=[];return this._appendLeaves(Fe,F,Le=Le||10,Oe=Oe||0,0),Fe}getTile(F,Le,Oe){const Fe=this.trees[this._limitZoom(F)],je=Math.pow(2,F),{extent:qe,radius:He}=this.options,xt=He/qe,jt=(Oe-xt)/je,Gt=(Oe+1+xt)/je,bi={features:[]};return this._addTileFeatures(Fe.range((Le-xt)/je,jt,(Le+1+xt)/je,Gt),Fe.data,Le,Oe,je,bi),0===Le&&this._addTileFeatures(Fe.range(1-xt/je,jt,1,Gt),Fe.data,je,Oe,je,bi),Le===je-1&&this._addTileFeatures(Fe.range(0,jt,xt/je,Gt),Fe.data,-1,Oe,je,bi),bi.features.length?bi:null}getClusterExpansionZoom(F){let Le=this._getOriginZoom(F)-1;for(;Le<=this.options.maxZoom;){const Oe=this.getChildren(F);if(Le++,1!==Oe.length)break;F=Oe[0].properties.cluster_id}return Le}_appendLeaves(F,Le,Oe,Fe,je){const qe=this.getChildren(Le);for(const Le of qe){const qe=Le.properties;if(qe&&qe.cluster?je+qe.point_count<=Fe?je+=qe.point_count:je=this._appendLeaves(F,qe.cluster_id,Oe,Fe,je):je<Fe?je++:F.push(Le),F.length===Oe)break}return je}_createTree(F){const Oe=new Le.bE(F.length/this.stride|0,this.options.nodeSize,Float32Array);for(let Le=0;Le<F.length;Le+=this.stride)Oe.add(F[Le],F[Le+1]);return Oe.finish(),Oe.data=F,Oe}_addTileFeatures(F,Le,Oe,Fe,je,qe){for(const He of F){const F=He*this.stride,xt=Le[F+bo]>1;let jt,Gt,bi;if(xt)jt=X(Le,F,this.clusterProps),Gt=Le[F],bi=Le[F+1];else{const Oe=this.points[Le[F+yo]];jt=Oe.properties;const[Fe,je]=Oe.geometry.coordinates;Gt=B(Fe),bi=G(je)}const wi={type:1,geometry:[[Math.round(this.options.extent*(Gt*je-Oe)),Math.round(this.options.extent*(bi*je-Fe))]],tags:jt};let qr;qr=xt||this.options.generateId?Le[F+yo]:this.points[Le[F+yo]].id,void 0!==qr&&(wi.id=qr),qe.features.push(wi)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,Le){const{radius:Oe,extent:Fe,reduce:je,minPoints:qe}=this.options,He=Oe/(Fe*Math.pow(2,Le)),xt=F.data,jt=[],Gt=this.stride;for(let Oe=0;Oe<xt.length;Oe+=Gt){if(xt[Oe+2]<=Le)continue;xt[Oe+2]=Le;const Fe=xt[Oe],bi=xt[Oe+1],wi=F.within(xt[Oe],xt[Oe+1],He),qr=xt[Oe+bo];let Xn=qr;for(const F of wi){const Oe=F*Gt;xt[Oe+2]>Le&&(Xn+=xt[Oe+bo])}if(Xn>qr&&Xn>=qe){let F,qe=Fe*qr,He=bi*qr,Yn=-1;const yo=(Oe/Gt<<5)+(Le+1)+this.points.length;for(const Fe of wi){const jt=Fe*Gt;if(xt[jt+2]<=Le)continue;xt[jt+2]=Le;const bi=xt[jt+bo];qe+=xt[jt]*bi,He+=xt[jt+1]*bi,xt[jt+4]=yo,je&&(F||(F=this._map(xt,Oe,!0),Yn=this.clusterProps.length,this.clusterProps.push(F)),je(F,this._map(xt,jt)))}xt[Oe+4]=yo,jt.push(qe/Xn,He/Xn,1/0,yo,-1,Xn),je&&jt.push(Yn)}else{for(let F=0;F<Gt;F++)jt.push(xt[Oe+F]);if(Xn>1)for(const F of wi){const Oe=F*Gt;if(!(xt[Oe+2]<=Le)){xt[Oe+2]=Le;for(let F=0;F<Gt;F++)jt.push(xt[Oe+F])}}}}return jt}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,Le,Oe){if(F[Le+bo]>1){const Fe=this.clusterProps[F[Le+Do]];return Oe?Object.assign({},Fe):Fe}const Fe=this.points[F[Le+yo]].properties,je=this.options.map(Fe);return Oe&&je===Fe?Object.assign({},je):je}}function N(F,Le,Oe){return{type:"Feature",id:F[Le+yo],properties:X(F,Le,Oe),geometry:{type:"Point",coordinates:[(Fe=F[Le],360*(Fe-.5)),Y(F[Le+1])]}};var Fe}function X(F,Le,Oe){const Fe=F[Le+bo],je=Fe>=1e4?`${Math.round(Fe/1e3)}k`:Fe>=1e3?Math.round(Fe/100)/10+"k":Fe,qe=F[Le+Do],He=-1===qe?{}:Object.assign({},Oe[qe]);return Object.assign(He,{cluster:!0,cluster_id:F[Le+yo],point_count:Fe,point_count_abbreviated:je})}function B(F){return F/360+.5}function G(F){const Le=Math.sin(F*Math.PI/180),Oe=.5-.25*Math.log((1+Le)/(1-Le))/Math.PI;return Oe<0?0:Oe>1?1:Oe}function Y(F){const Le=(180-360*F)*Math.PI/180;return 360*Math.atan(Math.exp(Le))/Math.PI-90}function R(F,Le,Oe,Fe){let je=Fe;const qe=Le+(Oe-Le>>1);let He,xt=Oe-Le;const jt=F[Le],Gt=F[Le+1],bi=F[Oe],wi=F[Oe+1];for(let Fe=Le+3;Fe<Oe;Fe+=3){const Le=J(F[Fe],F[Fe+1],jt,Gt,bi,wi);if(Le>je)He=Fe,je=Le;else if(Le===je){const F=Math.abs(Fe-qe);F<xt&&(He=Fe,xt=F)}}je>Fe&&(He-Le>3&&R(F,Le,He,Fe),F[He+2]=je,Oe-He>3&&R(F,He,Oe,Fe))}function J(F,Le,Oe,Fe,je,qe){let He=je-Oe,xt=qe-Fe;if(0!==He||0!==xt){const jt=((F-Oe)*He+(Le-Fe)*xt)/(He*He+xt*xt);jt>1?(Oe=je,Fe=qe):jt>0&&(Oe+=He*jt,Fe+=xt*jt)}return He=F-Oe,xt=Le-Fe,He*He+xt*xt}function V(F,Le,Oe,Fe){const je={id:F??null,type:Le,geometry:Oe,tags:Fe,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===Le||"MultiPoint"===Le||"LineString"===Le)$(je,Oe);else if("Polygon"===Le)$(je,Oe[0]);else if("MultiLineString"===Le)for(const F of Oe)$(je,F);else if("MultiPolygon"===Le)for(const F of Oe)$(je,F[0]);return je}function $(F,Le){for(let Oe=0;Oe<Le.length;Oe+=3)F.minX=Math.min(F.minX,Le[Oe]),F.minY=Math.min(F.minY,Le[Oe+1]),F.maxX=Math.max(F.maxX,Le[Oe]),F.maxY=Math.max(F.maxY,Le[Oe+1])}function W(F,Le,Oe,Fe){if(!Le.geometry)return;const je=Le.geometry.coordinates;if(je&&0===je.length)return;const qe=Le.geometry.type,He=Math.pow(Oe.tolerance/((1<<Oe.maxZoom)*Oe.extent),2);let xt=[],jt=Le.id;if(Oe.promoteId?jt=Le.properties[Oe.promoteId]:Oe.generateId&&(jt=Fe||0),"Point"===qe)q(je,xt);else if("MultiPoint"===qe)for(const F of je)q(F,xt);else if("LineString"===qe)U(je,xt,He,!1);else if("MultiLineString"===qe){if(Oe.lineMetrics){for(const Oe of je)xt=[],U(Oe,xt,He,!1),F.push(V(jt,"LineString",xt,Le.properties));return}H(je,xt,He,!1)}else if("Polygon"===qe)H(je,xt,He,!0);else{if("MultiPolygon"!==qe){if("GeometryCollection"===qe){for(const je of Le.geometry.geometries)W(F,{id:jt,geometry:je,properties:Le.properties},Oe,Fe);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const F of je){const Le=[];H(F,Le,He,!0),xt.push(Le)}}F.push(V(jt,qe,xt,Le.properties))}function q(F,Le){Le.push(Q(F[0]),K(F[1]),0)}function U(F,Le,Oe,Fe){let je,qe,He=0;for(let Oe=0;Oe<F.length;Oe++){const xt=Q(F[Oe][0]),jt=K(F[Oe][1]);Le.push(xt,jt,0),Oe>0&&(He+=Fe?(je*jt-xt*qe)/2:Math.sqrt(Math.pow(xt-je,2)+Math.pow(jt-qe,2))),je=xt,qe=jt}const xt=Le.length-3;Le[2]=1,R(Le,0,xt,Oe),Le[xt+2]=1,Le.size=Math.abs(He),Le.start=0,Le.end=Le.size}function H(F,Le,Oe,Fe){for(let je=0;je<F.length;je++){const qe=[];U(F[je],qe,Oe,Fe),Le.push(qe)}}function Q(F){return F/360+.5}function K(F){const Le=Math.sin(F*Math.PI/180),Oe=.5-.25*Math.log((1+Le)/(1-Le))/Math.PI;return Oe<0?0:Oe>1?1:Oe}function ee(F,Le,Oe,Fe,je,qe,He,xt){if(Fe/=Le,qe>=(Oe/=Le)&&He<Fe)return F;if(He<Oe||qe>=Fe)return null;const jt=[];for(const Le of F){const F=Le.geometry;let qe=Le.type;const He=0===je?Le.minX:Le.minY,Gt=0===je?Le.maxX:Le.maxY;if(He>=Oe&&Gt<Fe){jt.push(Le);continue}if(Gt<Oe||He>=Fe)continue;let bi=[];if("Point"===qe||"MultiPoint"===qe)te(F,bi,Oe,Fe,je);else if("LineString"===qe)se(F,bi,Oe,Fe,je,!1,xt.lineMetrics);else if("MultiLineString"===qe)oe(F,bi,Oe,Fe,je,!1);else if("Polygon"===qe)oe(F,bi,Oe,Fe,je,!0);else if("MultiPolygon"===qe)for(const Le of F){const F=[];oe(Le,F,Oe,Fe,je,!0),F.length&&bi.push(F)}if(bi.length){if(xt.lineMetrics&&"LineString"===qe){for(const F of bi)jt.push(V(Le.id,qe,F,Le.tags));continue}"LineString"!==qe&&"MultiLineString"!==qe||(1===bi.length?(qe="LineString",bi=bi[0]):qe="MultiLineString"),"Point"!==qe&&"MultiPoint"!==qe||(qe=3===bi.length?"Point":"MultiPoint"),jt.push(V(Le.id,qe,bi,Le.tags))}}return jt.length?jt:null}function te(F,Le,Oe,Fe,je){for(let qe=0;qe<F.length;qe+=3){const He=F[qe+je];He>=Oe&&He<=Fe&&ne(Le,F[qe],F[qe+1],F[qe+2])}}function se(F,Le,Oe,Fe,je,qe,He){let xt=ie(F);const jt=0===je?re:ae;let Gt,bi,wi=F.start;for(let qr=0;qr<F.length-3;qr+=3){const Xn=F[qr],Yn=F[qr+1],yo=F[qr+2],bo=F[qr+3],Do=F[qr+4],Ro=0===je?Xn:Yn,zs=0===je?bo:Do;let Zs=!1;He&&(Gt=Math.sqrt(Math.pow(Xn-bo,2)+Math.pow(Yn-Do,2))),Ro<Oe?zs>Oe&&(bi=jt(xt,Xn,Yn,bo,Do,Oe),He&&(xt.start=wi+Gt*bi)):Ro>Fe?zs<Fe&&(bi=jt(xt,Xn,Yn,bo,Do,Fe),He&&(xt.start=wi+Gt*bi)):ne(xt,Xn,Yn,yo),zs<Oe&&Ro>=Oe&&(bi=jt(xt,Xn,Yn,bo,Do,Oe),Zs=!0),zs>Fe&&Ro<=Fe&&(bi=jt(xt,Xn,Yn,bo,Do,Fe),Zs=!0),!qe&&Zs&&(He&&(xt.end=wi+Gt*bi),Le.push(xt),xt=ie(F)),He&&(wi+=Gt)}let qr=F.length-3;const Xn=F[qr],Yn=F[qr+1],yo=0===je?Xn:Yn;yo>=Oe&&yo<=Fe&&ne(xt,Xn,Yn,F[qr+2]),qr=xt.length-3,qe&&qr>=3&&(xt[qr]!==xt[0]||xt[qr+1]!==xt[1])&&ne(xt,xt[0],xt[1],xt[2]),xt.length&&Le.push(xt)}function ie(F){const Le=[];return Le.size=F.size,Le.start=F.start,Le.end=F.end,Le}function oe(F,Le,Oe,Fe,je,qe){for(const He of F)se(He,Le,Oe,Fe,je,qe,!1)}function ne(F,Le,Oe,Fe){F.push(Le,Oe,Fe)}function re(F,Le,Oe,Fe,je,qe){const He=(qe-Le)/(Fe-Le);return ne(F,qe,Oe+(je-Oe)*He,1),He}function ae(F,Le,Oe,Fe,je,qe){const He=(qe-Oe)/(je-Oe);return ne(F,Le+(Fe-Le)*He,qe,1),He}function le(F,Le){const Oe=[];for(let Fe=0;Fe<F.length;Fe++){const je=F[Fe],qe=je.type;let He;if("Point"===qe||"MultiPoint"===qe||"LineString"===qe)He=ce(je.geometry,Le);else if("MultiLineString"===qe||"Polygon"===qe){He=[];for(const F of je.geometry)He.push(ce(F,Le))}else if("MultiPolygon"===qe){He=[];for(const F of je.geometry){const Oe=[];for(const Fe of F)Oe.push(ce(Fe,Le));He.push(Oe)}}Oe.push(V(je.id,qe,He,je.tags))}return Oe}function ce(F,Le){const Oe=[];Oe.size=F.size,void 0!==F.start&&(Oe.start=F.start,Oe.end=F.end);for(let Fe=0;Fe<F.length;Fe+=3)Oe.push(F[Fe]+Le,F[Fe+1],F[Fe+2]);return Oe}function he(F,Le){if(F.transformed)return F;const Oe=1<<F.z,Fe=F.x,je=F.y;for(const qe of F.features){const F=qe.geometry,He=qe.type;if(qe.geometry=[],1===He)for(let He=0;He<F.length;He+=2)qe.geometry.push(ue(F[He],F[He+1],Le,Oe,Fe,je));else for(let He=0;He<F.length;He++){const xt=[];for(let qe=0;qe<F[He].length;qe+=2)xt.push(ue(F[He][qe],F[He][qe+1],Le,Oe,Fe,je));qe.geometry.push(xt)}}return F.transformed=!0,F}function ue(F,Le,Oe,Fe,je,qe){return[Math.round(Oe*(F*Fe-je)),Math.round(Oe*(Le*Fe-qe))]}function de(F,Le,Oe,Fe,je){const qe=Le===je.maxZoom?0:je.tolerance/((1<<Le)*je.extent),He={features:[],numPoints:0,numSimplified:0,numFeatures:F.length,source:null,x:Oe,y:Fe,z:Le,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const Le of F)pe(He,Le,qe,je);return He}function pe(F,Le,Oe,Fe){const je=Le.geometry,qe=Le.type,He=[];if(F.minX=Math.min(F.minX,Le.minX),F.minY=Math.min(F.minY,Le.minY),F.maxX=Math.max(F.maxX,Le.maxX),F.maxY=Math.max(F.maxY,Le.maxY),"Point"===qe||"MultiPoint"===qe)for(let Le=0;Le<je.length;Le+=3)He.push(je[Le],je[Le+1]),F.numPoints++,F.numSimplified++;else if("LineString"===qe)fe(He,je,F,Oe,!1,!1);else if("MultiLineString"===qe||"Polygon"===qe)for(let Le=0;Le<je.length;Le++)fe(He,je[Le],F,Oe,"Polygon"===qe,0===Le);else if("MultiPolygon"===qe)for(let Le=0;Le<je.length;Le++){const Fe=je[Le];for(let Le=0;Le<Fe.length;Le++)fe(He,Fe[Le],F,Oe,!0,0===Le)}if(He.length){let Oe=Le.tags||null;if("LineString"===qe&&Fe.lineMetrics){Oe={};for(const F in Le.tags)Oe[F]=Le.tags[F];Oe.mapbox_clip_start=je.start/je.size,Oe.mapbox_clip_end=je.end/je.size}const xt={geometry:He,type:"Polygon"===qe||"MultiPolygon"===qe?3:"LineString"===qe||"MultiLineString"===qe?2:1,tags:Oe};null!==Le.id&&(xt.id=Le.id),F.features.push(xt)}}function fe(F,Le,Oe,Fe,je,qe){const He=Fe*Fe;if(Fe>0&&Le.size<(je?He:Fe))return void(Oe.numPoints+=Le.length/3);const xt=[];for(let F=0;F<Le.length;F+=3)(0===Fe||Le[F+2]>He)&&(Oe.numSimplified++,xt.push(Le[F],Le[F+1])),Oe.numPoints++;je&&function(F,Le){let Oe=0;for(let Le=0,Fe=F.length,je=Fe-2;Le<Fe;je=Le,Le+=2)Oe+=(F[Le]-F[je])*(F[Le+1]+F[je+1]);if(Oe>0===Le)for(let Le=0,Oe=F.length;Le<Oe/2;Le+=2){const Fe=F[Le],je=F[Le+1];F[Le]=F[Oe-2-Le],F[Le+1]=F[Oe-1-Le],F[Oe-2-Le]=Fe,F[Oe-1-Le]=je}}(xt,qe),F.push(xt)}const Ro={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class me{constructor(F,Le){const Oe=(Le=this.options=function(F,Le){for(const Oe in Le)F[Oe]=Le[Oe];return F}(Object.create(Ro),Le)).debug;if(Oe&&console.time("preprocess data"),Le.maxZoom<0||Le.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Le.promoteId&&Le.generateId)throw new Error("promoteId and generateId cannot be used together.");let Fe=function(F,Le){const Oe=[];if("FeatureCollection"===F.type)for(let Fe=0;Fe<F.features.length;Fe++)W(Oe,F.features[Fe],Le,Fe);else W(Oe,"Feature"===F.type?F:{geometry:F},Le);return Oe}(F,Le);this.tiles={},this.tileCoords=[],Oe&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Le.indexMaxZoom,Le.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),Fe=function(F,Le){const Oe=Le.buffer/Le.extent;let Fe=F;const je=ee(F,1,-1-Oe,Oe,0,-1,2,Le),qe=ee(F,1,1-Oe,2+Oe,0,-1,2,Le);return(je||qe)&&(Fe=ee(F,1,-Oe,1+Oe,0,-1,2,Le)||[],je&&(Fe=le(je,1).concat(Fe)),qe&&(Fe=Fe.concat(le(qe,-1)))),Fe}(Fe,Le),Fe.length&&this.splitTile(Fe,0,0,0),Oe&&(Fe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(F,Le,Oe,Fe,je,qe,He){const xt=[F,Le,Oe,Fe],jt=this.options,Gt=jt.debug;for(;xt.length;){Fe=xt.pop(),Oe=xt.pop(),Le=xt.pop(),F=xt.pop();const bi=1<<Le,wi=ye(Le,Oe,Fe);let qr=this.tiles[wi];if(!qr&&(Gt>1&&console.time("creation"),qr=this.tiles[wi]=de(F,Le,Oe,Fe,jt),this.tileCoords.push({z:Le,x:Oe,y:Fe}),Gt)){Gt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Le,Oe,Fe,qr.numFeatures,qr.numPoints,qr.numSimplified),console.timeEnd("creation"));const F=`z${Le}`;this.stats[F]=(this.stats[F]||0)+1,this.total++}if(qr.source=F,null==je){if(Le===jt.indexMaxZoom||qr.numPoints<=jt.indexMaxPoints)continue}else{if(Le===jt.maxZoom||Le===je)continue;if(null!=je){const F=je-Le;if(Oe!==qe>>F||Fe!==He>>F)continue}}if(qr.source=null,0===F.length)continue;Gt>1&&console.time("clipping");const Xn=.5*jt.buffer/jt.extent,Yn=.5-Xn,yo=.5+Xn,bo=1+Xn;let Do=null,Ro=null,zs=null,Zs=null,na=ee(F,bi,Oe-Xn,Oe+yo,0,qr.minX,qr.maxX,jt),el=ee(F,bi,Oe+Yn,Oe+bo,0,qr.minX,qr.maxX,jt);F=null,na&&(Do=ee(na,bi,Fe-Xn,Fe+yo,1,qr.minY,qr.maxY,jt),Ro=ee(na,bi,Fe+Yn,Fe+bo,1,qr.minY,qr.maxY,jt),na=null),el&&(zs=ee(el,bi,Fe-Xn,Fe+yo,1,qr.minY,qr.maxY,jt),Zs=ee(el,bi,Fe+Yn,Fe+bo,1,qr.minY,qr.maxY,jt),el=null),Gt>1&&console.timeEnd("clipping"),xt.push(Do||[],Le+1,2*Oe,2*Fe),xt.push(Ro||[],Le+1,2*Oe,2*Fe+1),xt.push(zs||[],Le+1,2*Oe+1,2*Fe),xt.push(Zs||[],Le+1,2*Oe+1,2*Fe+1)}}getTile(F,Le,Oe){F=+F,Le=+Le,Oe=+Oe;const Fe=this.options,{extent:je,debug:qe}=Fe;if(F<0||F>24)return null;const He=1<<F,xt=ye(F,Le=Le+He&He-1,Oe);if(this.tiles[xt])return he(this.tiles[xt],je);qe>1&&console.log("drilling down to z%d-%d-%d",F,Le,Oe);let jt,Gt=F,bi=Le,wi=Oe;for(;!jt&&Gt>0;)Gt--,bi>>=1,wi>>=1,jt=this.tiles[ye(Gt,bi,wi)];return jt&&jt.source?(qe>1&&(console.log("found parent tile z%d-%d-%d",Gt,bi,wi),console.time("drilling down")),this.splitTile(jt.source,Gt,bi,wi,F,Le,Oe),qe>1&&console.timeEnd("drilling down"),this.tiles[xt]?he(this.tiles[xt],je):null):null}}function ye(F,Le,Oe){return 32*((1<<F)*Oe+Le)+F}function xe(Le,Oe){const Fe=Le.tileID.canonical;if(!(this||F)._geoJSONIndex)return void Oe(null,null);const je=(this||F)._geoJSONIndex.getTile(Fe.z,Fe.x,Fe.y);if(!je)return void Oe(null,null);const qe=new g(je.features);let He=wi(qe);0===He.byteOffset&&He.byteLength===He.buffer.byteLength||(He=new Uint8Array(He)),Oe(null,{vectorTile:qe,rawData:He.buffer})}class we extends c{constructor(F,Le,Oe,Fe,je,qe){super(F,Le,Oe,Fe,xe,qe),je&&(this.loadGeoJSON=je),this._dynamicIndex=new x}loadData(F,Oe){const Fe=F&&F.request,je=Fe&&Fe.collectResourceTiming;this.loadGeoJSON(F,((qe,He)=>{if(qe||!He)return Oe(qe);if("object"!=typeof He)return Oe(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));{try{if(F.filter){const Oe=Le.X(F.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Oe.result)throw new Error(Oe.value.map((F=>`${F.key}: ${F.message}`)).join(", "));He.features=He.features.filter((F=>Oe.value.evaluate({zoom:0},F)))}F.dynamic?("Feature"===He.type&&(He={type:"FeatureCollection",features:[He]}),F.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(He.features,this.loaded),F.cluster&&(He.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=F.cluster?new E(function({superclusterOptions:F,clusterProperties:Oe}){if(!Oe||!F)return F;const Fe={},je={},qe={accumulated:null,zoom:0},He={properties:null},xt=Object.keys(Oe);for(const F of xt){const[qe,He]=Oe[F],xt=Le.X(He),jt=Le.X("string"==typeof qe?[qe,["accumulated"],["get",F]]:qe);Fe[F]=xt.value,je[F]=jt.value}return F.map=F=>{He.properties=F;const Le={};for(const F of xt)Le[F]=Fe[F].evaluate(qe,He);return Le},F.reduce=(F,Le)=>{He.properties=Le;for(const Le of xt)qe.accumulated=F[Le],F[Le]=je[Le].evaluate(qe,He)},F}(F)).load(He.features):F.dynamic?this._dynamicIndex:function(F,Le){return new me(F,Le)}(He,F.geojsonVtOptions)}catch(F){return Oe(F)}const qe={};if(je){const Le=t(Fe);Le&&(qe.resourceTiming={},qe.resourceTiming[F.source]=JSON.parse(JSON.stringify(Le)))}Oe(null,qe)}}))}reloadTile(F,Le){const Oe=this.loaded;return Oe&&Oe[F.uid]?F.partial?Le(null,void 0):super.reloadTile(F,Le):this.loadTile(F,Le)}loadGeoJSON(F,Oe){if(F.request)Le.n(F.request,Oe);else{if("string"!=typeof F.data)return Oe(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`));try{return Oe(null,JSON.parse(F.data))}catch(Le){return Oe(new Error(`Input data given to '${F.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(F,Le){try{Le(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(F){Le(F)}}getClusterChildren(F,Le){try{Le(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(F){Le(F)}}getClusterLeaves(F,Le){try{Le(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(F){Le(F)}}}class be{constructor(F,Oe){this.tileID=new Le.aH(F.tileID.overscaledZ,F.tileID.wrap,F.tileID.canonical.z,F.tileID.canonical.x,F.tileID.canonical.y),this.tileZoom=F.tileZoom,this.uid=F.uid,this.zoom=F.zoom,this.canonical=F.tileID.canonical,this.pixelRatio=F.pixelRatio,this.tileSize=F.tileSize,this.source=F.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=F.projection,this.brightness=Oe}parse(F,Oe,Fe,je){this.status="parsing";const qe=new Le.aH(Fe.tileID.overscaledZ,Fe.tileID.wrap,Fe.tileID.canonical.z,Fe.tileID.canonical.x,Fe.tileID.canonical.y),He=[],xt=Oe.familiesBySource[Fe.source],jt=new Le.e0(qe,Fe.promoteId);return jt.bucketLayerIDs=[],jt.is3DTile=!0,Le.ei(F).then((F=>{if(!F)return je(new Error("Could not parse tile"));const Oe=Le.ej(F,1/Le.cd(Fe.tileID.canonical)),Gt=F.json.extensionsUsed&&F.json.extensionsUsed.includes("MAPBOX_mesh_features")||F.json.asset.extras&&F.json.asset.extras.MAPBOX_mesh_features,bi=F.json.extensionsUsed&&F.json.extensionsUsed.includes("EXT_meshopt_compression"),wi=new Le.aa(this.zoom,{brightness:this.brightness});for(const F in xt)for(const Fe of xt[F]){const F=Fe[0];jt.bucketLayerIDs.push(Fe.map((F=>Le.C(F.id,F.scope)))),F.recalculate(wi,[]);const je=new Le.ek(Fe,Oe,qe,Gt,bi,this.brightness,jt);Gt||(je.needsUpload=!0),He.push(je),je.evaluate(F)}this.status="done",je(null,{buckets:He,featureIndex:jt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((F=>je(new Error(F.message))))}}class ve{constructor(F,Le,Oe,Fe,je,qe){this.actor=F,this.layerIndex=Le,this.availableImages=Oe,this.brightness=qe,this.loading={},this.loaded={}}loadTile(F,Oe){const Fe=F.uid,je=this.loading[Fe]=new be(F,this.brightness);Le.bj(F.request,((Le,qe)=>{const He=!this.loading[Fe];return delete this.loading[Fe],He||Le?(je.status="done",He||(this.loaded[Fe]=je),Oe(Le)):qe&&0!==qe.byteLength?void je.parse(qe,this.layerIndex,F,((F,Le)=>{je.status="done",this.loaded=this.loaded||{},this.loaded[Fe]=je,F||!Le?Oe(F):Oe(null,Le)})):(je.status="done",this.loaded[Fe]=je,Oe())}))}reloadTile(F,Le){const Oe=this.loaded,Fe=F.uid;if(Oe&&Oe[Fe]){const je=Oe[Fe];je.projection=F.projection,je.brightness=F.brightness;const n=(Oe,Fe)=>{je.reloadCallback&&(delete je.reloadCallback,this.loadTile(F,Le)),Le(Oe,Fe)};"parsing"===je.status?je.reloadCallback=n:"done"===je.status&&this.loadTile(F,Le)}}abortTile(F,Le){const Oe=F.uid;this.loading[Oe]&&delete this.loading[Oe],Le()}removeTile(F,Le){const Oe=this.loaded,Fe=F.uid;Oe&&Oe[Fe]&&delete Oe[Fe],Le()}}class Ie{constructor(F){this.self=F,this.actor=new Le.el(F,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new Le.y,this.projections={},this.defaultProjection=Le.bP({name:"mercator"}),this.workerSourceTypes={vector:c,geojson:we,"raster-dem":h,"raster-array":d,"batched-model":ve},this.workerSources={},this.self.registerWorkerSource=(F,Le)=>{if(this.workerSourceTypes[F])throw new Error(`Worker source with name "${F}" already registered.`);this.workerSourceTypes[F]=Le},this.self.registerRTLTextPlugin=F=>{if(Le.em.isParsed())throw new Error("RTL text plugin already registered.");Le.em.applyArabicShaping=F.applyArabicShaping,Le.em.processBidirectionalText=F.processBidirectionalText,Le.em.processStyledBidirectionalText=F.processStyledBidirectionalText}}clearCaches(F,Le,Oe){delete this.layerIndexes[F],delete this.availableImages[F],delete this.workerSources[F],Oe()}checkIfReady(F,Le,Oe){Oe()}setReferrer(F,Le){this.referrer=Le}spriteLoaded(F,{scope:Oe,isLoaded:Fe}){if(this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),this.isSpriteLoaded[F][Oe]=Fe,this.workerSources[F]&&this.workerSources[F][Oe])for(const je in this.workerSources[F][Oe]){const qe=this.workerSources[F][Oe][je];for(const F in qe){const Oe=qe[F];Oe instanceof c&&(Oe.isSpriteLoaded=Fe,Oe.fire(new Le.A("isSpriteLoaded")))}}}setImages(F,{scope:Le,images:Oe},Fe){if(this.availableImages[F]||(this.availableImages[F]={}),this.availableImages[F][Le]=Oe,this.workerSources[F]&&this.workerSources[F][Le]){for(const Fe in this.workerSources[F][Le]){const je=this.workerSources[F][Le][Fe];for(const F in je)je[F].availableImages=Oe}Fe()}else Fe()}setProjection(F,Oe){this.projections[F]=Le.bP(Oe)}setBrightness(F,Le,Oe){this.brightness=Le,Oe()}setLayers(F,Le,Oe){this.getLayerIndex(F,Le.scope).replace(Le.layers,Le.options),Oe()}updateLayers(F,Le,Oe){this.getLayerIndex(F,Le.scope).update(Le.layers,Le.removedIds,Le.options),Oe()}loadTile(F,Le,Oe){Le.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,Le.type,Le.source,Le.scope).loadTile(Le,Oe)}decodeRasterArray(F,Le,Oe){this.getWorkerSource(F,Le.type,Le.source,Le.scope).decodeRasterArray(Le,Oe)}reloadTile(F,Le,Oe){Le.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,Le.type,Le.source,Le.scope).reloadTile(Le,Oe)}abortTile(F,Le,Oe){this.getWorkerSource(F,Le.type,Le.source,Le.scope).abortTile(Le,Oe)}removeTile(F,Le,Oe){this.getWorkerSource(F,Le.type,Le.source,Le.scope).removeTile(Le,Oe)}removeSource(F,Le,Oe){if(!(this.workerSources[F]&&this.workerSources[F][Le.scope]&&this.workerSources[F][Le.scope][Le.type]&&this.workerSources[F][Le.scope][Le.type][Le.source]))return;const Fe=this.workerSources[F][Le.scope][Le.type][Le.source];delete this.workerSources[F][Le.scope][Le.type][Le.source],void 0!==Fe.removeSource?Fe.removeSource(Le,Oe):Oe()}loadWorkerSource(F,Le,Oe){try{this.self.importScripts(Le.url),Oe()}catch(F){Oe(F.toString())}}syncRTLPluginState(F,Oe,Fe){try{Le.em.setState(Oe);const F=Le.em.getPluginURL();if(Le.em.isLoaded()&&!Le.em.isParsed()&&null!=F){this.self.importScripts(F);const Oe=Le.em.isParsed();Fe(Oe?void 0:new Error(`RTL Text Plugin failed to import scripts from ${F}`),Oe)}}catch(F){Fe(F.toString())}}setDracoUrl(F,Le){this.dracoUrl=Le}getAvailableImages(F,Le){this.availableImages[F]||(this.availableImages[F]={});let Oe=this.availableImages[F][Le];return Oe||(Oe=[]),Oe}getLayerIndex(F,Le){this.layerIndexes[F]||(this.layerIndexes[F]={});let Oe=this.layerIndexes[F][Le];return Oe||(Oe=this.layerIndexes[F][Le]=new o,Oe.scope=Le),Oe}getWorkerSource(F,Le,Oe,Fe){const je=this.workerSources;return je[F]||(je[F]={}),je[F][Fe]||(je[F][Fe]={}),je[F][Fe][Le]||(je[F][Fe][Le]={}),this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),je[F][Fe][Le][Oe]||(je[F][Fe][Le][Oe]=new this.workerSourceTypes[Le]({send:(Le,Oe,Fe,je,qe,He)=>{this.actor.send(Le,Oe,Fe,F,qe,He)},scheduler:this.actor.scheduler},this.getLayerIndex(F,Fe),this.getAvailableImages(F,Fe),this.isSpriteLoaded[F][Fe],void 0,this.brightness)),je[F][Fe][Le][Oe]}rasterizeImages(F,Le,Oe){const Fe=new Map;for(const[Oe,{image:je,imageVariant:qe}]of Le.tasks.entries()){const He=this.imageRasterizer.rasterize(qe,je,Le.scope,F);Fe.set(Oe,He)}Oe(void 0,Fe)}removeRasterizedImages(F,Le,Oe){this.imageRasterizer.removeImagesFromCacheByIds(Le.imageIds,Le.scope,F),Oe()}enforceCacheSizeLimit(F,Oe){Le.en(Oe)}getWorkerPerformanceMetrics(F,Le,Oe){Oe(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new Ie(self)),Ie}));define(["./shared"],(function(F){var Le="3.11.0";const Oe={create:"create",load:"load",fullLoad:"fullLoad"},Fe={mark(F){performance.mark(F)},measure(F,Le,Oe){performance.measure(F,Le,Oe)}};function s(Le){const Oe=Le.name.split("?")[0];return F.a(Oe)&&Oe.includes("mapbox-gl.js")?"javascript":F.a(Oe)&&Oe.includes("mapbox-gl.css")?"css":F.b(Oe)?"fontRange":F.c(Oe)?"sprite":F.i(Oe)?"style":F.d(Oe)?"tilejson":"other"}var je,qe={},He=function(){if(je)return qe;function e(F){return!t(F)}function t(Le){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var F,Le,Oe=new Blob([""],{type:"text/javascript"}),Fe=URL.createObjectURL(Oe);try{Le=new Worker(Fe),F=!0}catch(Le){F=!1}return Le&&Le.terminate(),URL.revokeObjectURL(Fe),F}()?function(){var F=document.createElement("canvas");F.width=F.height=1;var Le=F.getContext("2d");if(!Le)return!1;var Oe=Le.getImageData(0,0,1,1);return Oe&&Oe.width===F.width}()?(void 0===F[Oe=Le&&Le.failIfMajorPerformanceCaveat]&&(F[Oe]=function(F){var Le,Oe=function(F){var Le=document.createElement("canvas"),Oe=Object.create(e.webGLContextAttributes);return Oe.failIfMajorPerformanceCaveat=F,Le.getContext("webgl2",Oe)}(F);if(!Oe)return!1;try{Le=Oe.createShader(Oe.VERTEX_SHADER)}catch(F){return!1}return!(!Le||Oe.isContextLost())&&(Oe.shaderSource(Le,"void main() {}"),Oe.compileShader(Le),!0===Oe.getShaderParameter(Le,Oe.COMPILE_STATUS))}(Oe)),F[Oe]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var Oe}je=1,qe.supported=e,qe.notSupportedReason=t;var F={};return e.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},qe}();function l(F,Le,Oe){const Fe=document.createElement(F);return null!=Le&&(Fe.className=Le),Oe&&Oe.appendChild(Fe),Fe}function c(F,Le,Oe){const Fe=document.createElementNS("http://www.w3.org/2000/svg",F);for(const F of Object.keys(Le))Fe.setAttributeNS(null,F,String(Le[F]));return Oe&&Oe.appendChild(Fe),Fe}const xt="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,jt=xt&&void 0!==xt.userSelect?"userSelect":"WebkitUserSelect";let Gt;function _(){xt&&jt&&(Gt=xt[jt],xt[jt]="none")}function p(){xt&&jt&&(xt[jt]=Gt)}function f(F){F.preventDefault(),F.stopPropagation(),window.removeEventListener("click",f,!0)}function m(){window.addEventListener("click",f,!0),window.setTimeout((()=>{window.removeEventListener("click",f,!0)}),0)}function g(F,Le){const Oe=F.getBoundingClientRect();return x(F,Oe,Le)}function v(F,Le){const Oe=F.getBoundingClientRect(),Fe=[];for(let je=0;je<Le.length;je++)Fe.push(x(F,Oe,Le[je]));return Fe}function y(F){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===F.button&&F.ctrlKey?0:F.button}function x(Le,Oe,Fe){const je=Le.offsetWidth===Oe.width?1:Le.offsetWidth/Oe.width;return new F.P((Fe.clientX-Oe.left)*je,(Fe.clientY-Oe.top)*je)}const bi="01",wi="NO_ACCESS_TOKEN";class T{constructor(F,Le,Oe){this._transformRequestFn=F,this._customAccessToken=Le,this._silenceAuthErrors=!!Oe,this._createSkuToken()}_createSkuToken(){const F=function(){let F="";for(let Le=0;Le<10;Le++)F+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",bi,F].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=F.token,this._skuTokenExpiresAt=F.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(F,Le){return this._transformRequestFn&&this._transformRequestFn(F,Le)||{url:F}}normalizeStyleURL(Oe,Fe){if(!F.f(Oe))return Oe;const je=S(Oe);return je.params.push(`sdk=js-${Le}`),je.path=`/styles/v1${je.path}`,this._makeAPIURL(je,this._customAccessToken||Fe)}normalizeGlyphsURL(Le,Oe){if(!F.f(Le))return Le;const Fe=S(Le);return Fe.path=`/fonts/v1${Fe.path}`,this._makeAPIURL(Fe,this._customAccessToken||Oe)}normalizeModelURL(Le,Oe){if(!F.f(Le))return Le;const Fe=S(Le);return Fe.path=`/models/v1${Fe.path}`,this._makeAPIURL(Fe,this._customAccessToken||Oe)}normalizeSourceURL(Le,Oe,Fe,je){if(!F.f(Le))return Le;const qe=S(Le);return qe.path=`/v4/${qe.authority}.json`,qe.params.push("secure"),Fe&&qe.params.push(`language=${Fe}`),je&&qe.params.push(`worldview=${je}`),this._makeAPIURL(qe,this._customAccessToken||Oe)}normalizeIconsetURL(Le,Oe){const Fe=S(Le);return F.f(Le)?(Fe.path=`/styles/v1${Fe.path}/iconset.pbf`,this._makeAPIURL(Fe,this._customAccessToken||Oe)):C(Fe)}normalizeSpriteURL(Le,Oe,Fe,je){const qe=S(Le);return F.f(Le)?(qe.path=`/styles/v1${qe.path}/sprite${Oe}${Fe}`,this._makeAPIURL(qe,this._customAccessToken||je)):(qe.path+=`${Oe}${Fe}`,C(qe))}normalizeTileURL(Le,Oe,Fe){if(this._isSkuTokenExpired()&&this._createSkuToken(),Le&&!F.f(Le))return Le;const je=S(Le);je.path=je.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${Oe||Fe&&"raster"!==je.authority&&512===Fe?"@2x":""}${F.m.supported?".webp":"$1"}`),"raster"===je.authority?je.path=`/${F.e.RASTER_URL_PREFIX}${je.path}`:"rasterarrays"===je.authority?je.path=`/${F.e.RASTERARRAYS_URL_PREFIX}${je.path}`:"3dtiles"===je.authority?je.path=`/${F.e.TILES3D_URL_PREFIX}${je.path}`:(je.path=je.path.replace(/^.+\/v4\//,"/"),je.path=`/${F.e.TILE_URL_VERSION}${je.path}`);const qe=this._customAccessToken||function(F){for(const Le of F){const F=Le.match(/^access_token=(.*)$/);if(F)return F[1]}return null}(je.params)||F.e.ACCESS_TOKEN;return F.e.REQUIRE_ACCESS_TOKEN&&qe&&this._skuToken&&je.params.push(`sku=${this._skuToken}`),this._makeAPIURL(je,qe)}canonicalizeTileURL(Le,Oe){const Fe=S(Le);if(!Fe.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!Fe.path.match(/\.[\w]+$/))return Le;let je="mapbox://";Fe.path.match(/^\/raster\/v1\//)?je+=`raster/${Fe.path.replace(`/${F.e.RASTER_URL_PREFIX}/`,"")}`:Fe.path.match(/^\/rasterarrays\/v1\//)?je+=`rasterarrays/${Fe.path.replace(`/${F.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:je+=`tiles/${Fe.path.replace(`/${F.e.TILE_URL_VERSION}/`,"")}`;let qe=Fe.params;return Oe&&(qe=qe.filter((F=>!F.match(/^access_token=/)))),qe.length&&(je+=`?${qe.join("&")}`),je}canonicalizeTileset(Le,Oe){const Fe=!!Oe&&F.f(Oe),je=[];for(const Oe of Le.tiles||[])F.h(Oe)?je.push(this.canonicalizeTileURL(Oe,Fe)):je.push(Oe);return je}_makeAPIURL(Le,Oe){const Fe="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",je=S(F.e.API_URL);if(Le.protocol=je.protocol,Le.authority=je.authority,"http"===Le.protocol){const F=Le.params.indexOf("secure");F>=0&&Le.params.splice(F,1)}if("/"!==je.path&&(Le.path=`${je.path}${Le.path}`),!F.e.REQUIRE_ACCESS_TOKEN)return C(Le);if(Oe=Oe||F.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!Oe)throw new Error(`An API access token is required to use Mapbox GL. ${Fe}`);if("s"===Oe[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${Fe}`)}return Le.params=Le.params.filter((F=>-1===F.indexOf("access_token"))),Le.params.push(`access_token=${Oe||""}`),C(Le)}}const qr=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function S(F){const Le=F.match(qr);if(!Le)throw new Error("Unable to parse URL object");return{protocol:Le[1],authority:Le[2],path:Le[3]||"/",params:Le[4]?Le[4].split("&"):[]}}function C(F){const Le=F.params.length?`?${F.params.join("&")}`:"";return`${F.protocol}://${F.authority}${F.path}${Le}`}const Xn="mapbox.eventData";function R(Le){if(!Le)return null;const Oe=Le.split(".");if(!Oe||3!==Oe.length)return null;try{return JSON.parse(F.j(Oe[1]))}catch(F){return null}}class D{constructor(F){this.type=F,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(Le){const Oe=R(F.e.ACCESS_TOKEN);let Fe="";return Fe=Oe&&Oe.u?F.k(Oe.u):F.e.ACCESS_TOKEN||"",Le?`${Xn}.${Le}:${Fe}`:`${Xn}:${Fe}`}fetchEventData(){const Le=F.s("localStorage"),Oe=this.getStorageKey(),Fe=this.getStorageKey("uuid");if(Le)try{const F=localStorage.getItem(Oe);F&&(this.eventData=JSON.parse(F));const Le=localStorage.getItem(Fe);Le&&(this.anonId=Le)}catch(Le){F.w("Unable to read from LocalStorage")}}saveEventData(){const Le=F.s("localStorage"),Oe=this.getStorageKey(),Fe=this.getStorageKey("uuid"),je=this.anonId;if(Le&&je)try{localStorage.setItem(Fe,je),Object.keys(this.eventData).length>=1&&localStorage.setItem(Oe,JSON.stringify(this.eventData))}catch(Le){F.w("Unable to write to LocalStorage")}}processRequests(F){}postEvent(Le,Oe,Fe,je){if(!F.e.EVENTS_URL)return;const qe=S(F.e.EVENTS_URL);qe.params.push(`access_token=${je||F.e.ACCESS_TOKEN||""}`);const He={event:this.type,created:new Date(Le).toISOString()},xt=Oe?F.l(He,Oe):He,jt={url:C(qe),headers:{"Content-Type":"text/plain"},body:JSON.stringify([xt])};this.pendingRequest=F.p(jt,(F=>{this.pendingRequest=null,Fe(F),this.saveEventData(),this.processRequests(je)}))}queueRequest(F,Le){this.queue.push(F),this.processRequests(Le)}}const Yn=new class extends D{constructor(F){super("appUserTurnstile"),this._customAccessToken=F}postTurnstileEvent(Le,Oe){F.e.EVENTS_URL&&F.e.ACCESS_TOKEN&&Array.isArray(Le)&&Le.some((Le=>F.f(Le)||F.h(Le)))&&this.queueRequest(Date.now(),Oe)}processRequests(Oe){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const Fe=R(F.e.ACCESS_TOKEN),je=Fe?Fe.u:F.e.ACCESS_TOKEN;let qe=je!==this.eventData.tokenU;F.v(this.anonId)||(this.anonId=F.u(),qe=!0);const He=this.queue.shift();if(this.eventData.lastSuccess){const F=new Date(this.eventData.lastSuccess),Le=new Date(He),Oe=(He-this.eventData.lastSuccess)/864e5;qe=qe||Oe>=1||Oe<-1||F.getDate()!==Le.getDate()}else qe=!0;qe?this.postEvent(He,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Le,skuId:bi,"enabled.telemetry":!1,userId:this.anonId},(F=>{F||(this.eventData.lastSuccess=He,this.eventData.tokenU=je)}),Oe):this.processRequests()}},yo=Yn.postTurnstileEvent.bind(Yn),bo=new class extends D{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(Le,Oe,Fe,je){this.skuToken=Oe,this.errorCb=je,F.e.EVENTS_URL&&(Fe||F.e.ACCESS_TOKEN?this.queueRequest({id:Le,timestamp:Date.now()},Fe):this.errorCb(new Error(wi)))}processRequests(Oe){if(this.pendingRequest||0===this.queue.length)return;const{id:Fe,timestamp:je}=this.queue.shift();Fe&&this.success[Fe]||(this.anonId||this.fetchEventData(),F.v(this.anonId)||(this.anonId=F.u()),this.postEvent(je,{sdkIdentifier:"mapbox-gl-js",sdkVersion:Le,skuId:bi,skuToken:this.skuToken,userId:this.anonId},(F=>{F?this.errorCb(F):Fe&&(this.success[Fe]=!0)}),Oe))}remove(){this.errorCb=null}},Do=bo.postMapLoadEvent.bind(bo),Ro=new class extends D{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(Le){let Oe=this.mapInstanceIdMap.get(Le);return Oe||(Oe=F.u(),this.mapInstanceIdMap.set(Le,Oe)),Oe}getEventId(F){const Le=this.eventIdPerMapInstanceMap.get(F)||0;return this.eventIdPerMapInstanceMap.set(F,Le+1),Le}postStyleLoadEvent(Le,Oe){const{map:Fe,style:je,importedStyles:qe}=Oe;if(!F.e.EVENTS_URL||!Le&&!F.e.ACCESS_TOKEN)return;const He=this.getMapInstanceId(Fe),xt={mapInstanceId:He,eventId:this.getEventId(He),style:je};qe.length&&(xt.importedStyles=qe),this.queueRequest({timestamp:Date.now(),payload:xt},Le)}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:Le,payload:Oe}=this.queue.shift();this.postEvent(Le,Oe,(()=>{}),F)}},zs=Ro.postStyleLoadEvent.bind(Ro),Zs=new class extends D{constructor(){super("gljs.performance")}postPerformanceEvent(Le,Oe){F.e.EVENTS_URL&&(Le||F.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:Oe},Le)}processRequests(Fe){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:je,performanceData:qe}=this.queue.shift(),He=function(Fe){const je=performance.getEntriesByType("resource"),qe=performance.getEntriesByType("mark"),He=function(F){const Le={};if(F)for(const Oe in F)if("other"!==Oe)for(const Fe of F[Oe]){const F=`${Oe}ResolveRangeMin`,je=`${Oe}ResolveRangeMax`,qe=`${Oe}RequestCount`,He=`${Oe}RequestCachedCount`;Le[F]=Math.min(Le[F]||1/0,Fe.startTime),Le[je]=Math.max(Le[je]||-1/0,Fe.responseEnd);const a=F=>{void 0===Le[F]&&(Le[F]=0),++Le[F]};void 0!==Fe.transferSize&&0===Fe.transferSize&&a(He),a(qe)}return Le}(function(F,Le){const Oe={};if(F)for(const Fe of F){const F=Le(Fe);void 0===Oe[F]&&(Oe[F]=[]),Oe[F].push(Fe)}return Oe}(je,s)),xt=window.devicePixelRatio,jt=navigator.connection||navigator.mozConnection||navigator.webkitConnection,Gt=jt?jt.effectiveType:void 0,bi={counters:[],metadata:[],attributes:[]},u=(F,Le,Oe)=>{null!=Oe&&F.push({name:Le,value:Oe.toString()})};for(const F in He)u(bi.counters,F,He[F]);if(Fe.interactionRange[0]!==1/0&&Fe.interactionRange[1]!==-1/0&&(u(bi.counters,"interactionRangeMin",Fe.interactionRange[0]),u(bi.counters,"interactionRangeMax",Fe.interactionRange[1])),qe)for(const F of Object.keys(Oe)){const Le=Oe[F],Fe=qe.find((F=>F.name===Le));Fe&&u(bi.counters,Le,Fe.startTime)}return u(bi.counters,"visibilityHidden",Fe.visibilityHidden),u(bi.attributes,"style",function(Le){if(Le)for(const Oe of Le){const Le=Oe.name.split("?")[0];if(F.i(Le)){const F=Le.split("/").slice(-2);if(2===F.length)return`mapbox://styles/${F[0]}/${F[1]}`}}}(je)),u(bi.attributes,"terrainEnabled",Fe.terrainEnabled?"true":"false"),u(bi.attributes,"fogEnabled",Fe.fogEnabled?"true":"false"),u(bi.attributes,"projection",Fe.projection),u(bi.attributes,"zoom",Fe.zoom),u(bi.metadata,"devicePixelRatio",xt),u(bi.metadata,"connectionEffectiveType",Gt),u(bi.metadata,"navigatorUserAgent",navigator.userAgent),u(bi.metadata,"screenWidth",window.screen.width),u(bi.metadata,"screenHeight",window.screen.height),u(bi.metadata,"windowWidth",window.innerWidth),u(bi.metadata,"windowHeight",window.innerHeight),u(bi.metadata,"mapWidth",Fe.width/xt),u(bi.metadata,"mapHeight",Fe.height/xt),u(bi.metadata,"webglRenderer",Fe.renderer),u(bi.metadata,"webglVendor",Fe.vendor),u(bi.metadata,"sdkVersion",Le),u(bi.metadata,"sdkIdentifier","mapbox-gl-js"),bi}(qe);for(const F of He.metadata);for(const F of He.counters);for(const F of He.attributes);this.postEvent(je,He,(()=>{}),Fe)}},na=Zs.postPerformanceEvent.bind(Zs),el=new class extends D{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(Le,Oe,Fe,je){if(!F.e.API_URL||!F.e.SESSION_PATH)return;const qe=S(F.e.API_URL+F.e.SESSION_PATH);qe.params.push(`sku=${Oe||""}`),qe.params.push(`access_token=${je||F.e.ACCESS_TOKEN||""}`);const He={url:C(qe),headers:{"Content-Type":"text/plain"}};this.pendingRequest=F.g(He,(F=>{this.pendingRequest=null,Fe(F),this.saveEventData(),this.processRequests(je)}))}getSessionAPI(Le,Oe,Fe,je){this.skuToken=Oe,this.errorCb=je,F.e.SESSION_PATH&&F.e.API_URL&&(Fe||F.e.ACCESS_TOKEN?this.queueRequest({id:Le,timestamp:Date.now()},Fe):this.errorCb(new Error(wi)))}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;const{id:Le,timestamp:Oe}=this.queue.shift();Le&&this.success[Le]||this.getSession(Oe,this.skuToken,(F=>{F?this.errorCb(F):Le&&(this.success[Le]=!0)}),F)}remove(){this.errorCb=null}},nl=el.getSessionAPI.bind(el),hl=new Set;function V(F,Le){Le?hl.add(F):hl.delete(F)}class G{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(F,Le){this._updatedSourceCaches[F]=Le,this.setDirty()}discardSourceCacheUpdate(F){delete this._updatedSourceCaches[F]}updateLayer(F){const Le=F.scope;this._updatedLayers[Le]=this._updatedLayers[Le]||new Set,this._updatedLayers[Le].add(F.id),this.setDirty()}removeLayer(F){const Le=F.scope;this._removedLayers[Le]=this._removedLayers[Le]||{},this._updatedLayers[Le]=this._updatedLayers[Le]||new Set,this._removedLayers[Le][F.id]=F,this._updatedLayers[Le].delete(F.id),this._updatedPaintProps.delete(F.fqid),this.setDirty()}getRemovedLayer(F){return this._removedLayers[F.scope]?this._removedLayers[F.scope][F.id]:null}discardLayerRemoval(F){this._removedLayers[F.scope]&&delete this._removedLayers[F.scope][F.id]}getLayerUpdatesByScope(){const F={};for(const Le in this._updatedLayers)F[Le]=F[Le]||{},F[Le].updatedIds=Array.from(this._updatedLayers[Le].values());for(const Le in this._removedLayers)F[Le]=F[Le]||{},F[Le].removedIds=Object.keys(this._removedLayers[Le]);return F}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(F){this._updatedPaintProps.add(F.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(Le){this._updatedImages.add(F.I.toString(Le)),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function j(F){const{userImage:Le}=F;return!!(Le&&Le.render&&Le.render())&&(F.data.replace(new Uint8Array(Le.data.buffer)),!0)}class q extends F.E{constructor(Le){super(),this._images={},this._iconsets={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.patternsInFlight=new Set,this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=Le,"raster"!==Le&&F.t()&&(this.imageRasterizerDispatcher=new F.D(F.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new F.y),this._imageRasterizer}createScope(Le){this._images[Le]={},this._iconsets[Le]={},this.loaded[Le]=!1,this.updatedImages[Le]=new Set,this.patterns[Le]={},this.callbackDispatchedThisFrame[Le]=new Set,this.atlasImage[Le]=new F.r({width:1,height:1})}createIconset(F,Le){this._iconsets[F][Le]={}}isLoaded(){for(const F in this.loaded)if(!this.loaded[F])return!1;return!0}setLoaded(F,Le){if(this.loaded[Le]!==F&&(this.loaded[Le]=F,F)){for(const{ids:F,callback:Oe}of this.requestors)this._notify(F,Le,Oe);this.requestors=[]}}hasImage(F,Le){return!!this.getImage(F,Le)}getImage(F,Le){return(F.iconsetId?this._iconsets[Le][F.iconsetId]:this._images[Le])[F.name]}addImage(F,Le,Oe){const Fe=F.iconsetId?this._iconsets[Le][F.iconsetId]:this._images[Le];this._validate(F,Oe)&&(Fe[F.name]=Oe)}_validate(Le,Oe){let Fe=!0;return this._validateStretch(Oe.stretchX,Oe.data&&Oe.data.width)||(this.fire(new F.z(new Error(`Image "${Le.name}" has invalid "stretchX" value`))),Fe=!1),this._validateStretch(Oe.stretchY,Oe.data&&Oe.data.height)||(this.fire(new F.z(new Error(`Image "${Le.name}" has invalid "stretchY" value`))),Fe=!1),this._validateContent(Oe.content,Oe)||(this.fire(new F.z(new Error(`Image "${Le.name}" has invalid "content" value`))),Fe=!1),Fe}_validateStretch(F,Le){if(!F)return!0;let Oe=0;for(const Fe of F){if(Fe[0]<Oe||Fe[1]<Fe[0]||Le<Fe[1])return!1;Oe=Fe[1]}return!0}_validateContent(F,Le){if(!F)return!0;if(4!==F.length)return!1;if(!Le.usvg){if(F[0]<0||Le.data.width<F[0])return!1;if(F[1]<0||Le.data.height<F[1])return!1;if(F[2]<0||Le.data.width<F[2])return!1;if(F[3]<0||Le.data.height<F[3])return!1}return!(F[2]<F[0]||F[3]<F[1])}updateImage(F,Le,Oe){const Fe=F.iconsetId?this._iconsets[Le][F.iconsetId]:this._images[Le];Oe.version=Fe[F.name].version+1,Fe[F.name]=Oe,this.updatedImages[Le].add(F),this.removeFromImageRasterizerCache(F,Le)}clearUpdatedImages(F){this.updatedImages[F].clear()}removeFromImageRasterizerCache(Le,Oe){if("raster"!==this.spriteFormat)if(F.t()){const F={imageIds:[Le],scope:Oe};this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",F)}else this.imageRasterizer.removeImagesFromCacheByIds([Le],Oe)}removeImage(F,Le){const Oe=F.iconsetId?this._iconsets[Le][F.iconsetId]:this._images[Le],Fe=Oe[F.name];delete Oe[F.name],delete this.patterns[Le][F.name],this.removeFromImageRasterizerCache(F,Le),Fe.userImage&&Fe.userImage.onRemove&&Fe.userImage.onRemove()}listImages(Le){const Oe=[];for(const Fe of Object.keys(this._images[Le]))Oe.push(new F.I(Fe));for(const Fe in this._iconsets[Le])for(const je of Object.keys(this._iconsets[Le][Fe]))Oe.push(new F.I({name:je,iconsetId:Fe}));return Oe}getImages(F,Le,Oe){let Fe=!0;const je=!!this.loaded[Le];if(!je)for(const Oe of F)(Oe.iconsetId?this._iconsets[Le][Oe.iconsetId]:this._images[Le])[Oe.name]||(Fe=!1);je||Fe?this._notify(F,Le,Oe):this.requestors.push({ids:F,scope:Le,callback:Oe})}rasterizeImages({scope:F,tasks:Le},Oe){const Fe=new Map;for(const[Oe,je]of Le.entries()){const Le=this.getImage(je.id,F);Le&&Fe.set(Oe,{image:Le,imageVariant:je})}this._rasterizeImages(F,Fe,Oe)}_rasterizeImages(Le,Oe,Fe){if(F.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{tasks:Oe,scope:Le},Fe);else{const F=new Map;for(const[Fe,{image:je,imageVariant:qe}]of Oe.entries())F.set(Fe,this.imageRasterizer.rasterize(qe,je,Le,0));Fe(void 0,F)}}getUpdatedImages(F){return this.updatedImages[F]||new Set}_notify(Le,Oe,Fe){const je=new Map;for(const Fe of Le){Fe.iconsetId&&(this._iconsets[Oe][Fe.iconsetId]=this._iconsets[Oe][Fe.iconsetId]||{});const Le=(Fe.iconsetId?this._iconsets[Oe][Fe.iconsetId]:this._images[Oe])[Fe.name];if(!Le){if(Fe.iconsetId)continue;F.w(`Image "${Fe.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`),this.fire(new F.A("styleimagemissing",{id:Fe.name}));continue}const qe={data:Le.usvg?null:Le.data.clone(),pixelRatio:Le.pixelRatio,sdf:Le.sdf,usvg:Le.usvg,version:Le.version,stretchX:Le.stretchX,stretchY:Le.stretchY,content:Le.content,hasRenderCallback:Boolean(Le.userImage&&Le.userImage.render)};Le.usvg&&Object.assign(qe,{width:Le.icon.usvg_tree.width,height:Le.icon.usvg_tree.height}),je.set(F.I.toString(Fe),qe)}Fe(null,je)}getPixelSize(F){const{width:Le,height:Oe}=this.atlasImage[F];return{width:Le,height:Oe}}getPattern(Le,Oe,Fe){const je=this.patterns[Oe][Le.name],qe=this.getImage(Le,Oe);if(!qe)return null;if(je){if(je.position.version===qe.version)return je.position;je.position.version=qe.version}else{if(qe.usvg&&!qe.data){const je=this.getPatternInFlightId(Le.toString(),Oe);if(this.patternsInFlight.has(je))return null;this.patternsInFlight.add(je);const He=new F.B(Le).scaleSelf(F.q.devicePixelRatio),xt=new Map([[He.toString(),{image:qe,imageVariant:He}]]);return this._rasterizeImages(Oe,xt,((F,Le)=>this.storePatternImage(He,Oe,qe,Fe,Le))),null}this.storePattern(Le,Oe,qe)}return this._updatePatternAtlas(Oe,Fe),this.patterns[Oe][Le.name].position}getPatternInFlightId(Le,Oe){return F.C(Le,Oe)}hasPatternsInFlight(){return 0!==this.patternsInFlight.size}storePatternImage(F,Le,Oe,Fe,je){const qe=F.toString(),He=je?je.get(qe):void 0;He&&(Oe.data=He,this.storePattern(F.id,Le,Oe),this._updatePatternAtlas(Le,Fe),this.patternsInFlight.delete(this.getPatternInFlightId(F.id.toString(),Le)))}storePattern(Le,Oe,Fe){const je={w:Fe.data.width+2*F.F,h:Fe.data.height+2*F.F,x:0,y:0},qe=new F.G(je,Fe,F.F);this.patterns[Oe][Le.name]={bin:je,position:qe}}bind(Le,Oe){const Fe=Le.gl;let je=this.atlasTexture[Oe];je?this.dirty&&(je.update(this.atlasImage[Oe]),this.dirty=!1):(je=new F.T(Le,this.atlasImage[Oe],Fe.RGBA8),this.atlasTexture[Oe]=je),je.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE)}_updatePatternAtlas(Le,Oe){const Fe=[];for(const F in this.patterns[Le])Fe.push(this.patterns[Le][F].bin);const{w:je,h:qe}=F.H(Fe),He=this.atlasImage[Le];He.resize({width:je||1,height:qe||1});for(const Fe in this.patterns[Le]){const{bin:je,position:qe}=this.patterns[Le][Fe];let xt=qe.padding;const jt=je.x+xt,Gt=je.y+xt,bi=this._images[Le][Fe].data,wi=bi.width,qr=bi.height;xt=xt>1?xt-1:xt,F.r.copy(bi,He,{x:0,y:0},{x:jt,y:Gt},{width:wi,height:qr},Oe),F.r.copy(bi,He,{x:0,y:qr-xt},{x:jt,y:Gt-xt},{width:wi,height:xt},Oe),F.r.copy(bi,He,{x:0,y:0},{x:jt,y:Gt+qr},{width:wi,height:xt},Oe),F.r.copy(bi,He,{x:wi-xt,y:0},{x:jt-xt,y:Gt},{width:xt,height:qr},Oe),F.r.copy(bi,He,{x:0,y:0},{x:jt+wi,y:Gt},{width:xt,height:qr},Oe),F.r.copy(bi,He,{x:wi-xt,y:qr-xt},{x:jt-xt,y:Gt-xt},{width:xt,height:xt},Oe),F.r.copy(bi,He,{x:0,y:qr-xt},{x:jt+wi,y:Gt-xt},{width:xt,height:xt},Oe),F.r.copy(bi,He,{x:0,y:0},{x:jt+wi,y:Gt+qr},{width:xt,height:xt},Oe),F.r.copy(bi,He,{x:wi-xt,y:0},{x:jt-xt,y:Gt+qr},{width:xt,height:xt},Oe)}this.dirty=!0}beginFrame(){for(const F in this._images)this.callbackDispatchedThisFrame[F]=new Set}dispatchRenderCallbacks(F,Le){for(const Oe of F){if(this.callbackDispatchedThisFrame[Le].has(Oe.toString()))continue;this.callbackDispatchedThisFrame[Le].add(Oe.toString());const F=(Oe.iconsetId?this._iconsets[Le][Oe.iconsetId]:this._images[Le])[Oe.name];j(F)&&this.updateImage(Oe,Le,F)}}}function H(Le){const Oe=Le.key,Fe=Le.value,je=Le.valueSpec||{},qe=Le.objectElementValidators||{},He=Le.style,xt=Le.styleSpec;let jt=[];const Gt=F.K(Fe);if("object"!==Gt)return[new F.V(Oe,Fe,`object expected, ${Gt} found`)];for(const Le in Fe){const Gt=Le.split(".")[0];let bi;qe[Gt]?bi=qe[Gt]:je[Gt]?bi=_e:qe["*"]?bi=qe["*"]:je["*"]&&(bi=_e),bi?jt=jt.concat(bi({key:(Oe?`${Oe}.`:Oe)+Le,value:Fe[Le],valueSpec:je[Gt]||je["*"],style:He,styleSpec:xt,object:Fe,objectKey:Le},Fe)):jt.push(new F.J(Oe,Fe[Le],`unknown property "${Le}"`))}for(const Le in je)qe[Le]||je[Le].required&&void 0===je[Le].default&&void 0===Fe[Le]&&jt.push(new F.V(Oe,Fe,`missing required property "${Le}"`));return jt}function Z(Le){const Oe=Le.value,Fe=Le.valueSpec,je=Le.style,qe=Le.styleSpec,He=Le.key,xt=Le.arrayElementValidator||_e;if("array"!==F.K(Oe))return[new F.V(He,Oe,`array expected, ${F.K(Oe)} found`)];if(Fe.length&&Oe.length!==Fe.length)return[new F.V(He,Oe,`array length ${Fe.length} expected, length ${Oe.length} found`)];if(Fe["min-length"]&&Oe.length<Fe["min-length"])return[new F.V(He,Oe,`array length at least ${Fe["min-length"]} expected, length ${Oe.length} found`)];let jt={type:Fe.value,values:Fe.values,minimum:Fe.minimum,maximum:Fe.maximum,function:void 0};qe.$version<7&&(jt.function=Fe.function),"object"===F.K(Fe.value)&&(jt=Fe.value);let Gt=[];for(let F=0;F<Oe.length;F++)Gt=Gt.concat(xt({array:Oe,arrayIndex:F,value:Oe[F],valueSpec:jt,style:je,styleSpec:qe,key:`${He}[${F}]`},!0));return Gt}function W(Le){const Oe=Le.key,Fe=Le.value,je=Le.valueSpec;let qe=F.K(Fe);if("number"===qe&&Fe!=Fe&&(qe="NaN"),"number"!==qe)return[new F.V(Oe,Fe,`number expected, ${qe} found`)];if("minimum"in je){let qe=je.minimum;if("array"===F.K(je.minimum)&&(qe=je.minimum[Le.arrayIndex]),Fe<qe)return[new F.V(Oe,Fe,`${Fe} is less than the minimum value ${qe}`)]}if("maximum"in je){let qe=je.maximum;if("array"===F.K(je.maximum)&&(qe=je.maximum[Le.arrayIndex]),Fe>qe)return[new F.V(Oe,Fe,`${Fe} is greater than the maximum value ${qe}`)]}return[]}function $(Le){const Oe=Le.valueSpec,Fe=F.M(Le.value.type);let je,qe,He,xt={};const jt="categorical"!==Fe&&void 0===Le.value.property,Gt=!jt,bi="array"===F.K(Le.value.stops)&&"array"===F.K(Le.value.stops[0])&&"object"===F.K(Le.value.stops[0][0]),wi=H({key:Le.key,value:Le.value,valueSpec:Le.styleSpec.function,style:Le.style,styleSpec:Le.styleSpec,objectElementValidators:{stops:function(Le){if("identity"===Fe)return[new F.V(Le.key,Le.value,'identity function may not have a "stops" property')];let Oe=[];const je=Le.value;return Oe=Oe.concat(Z({key:Le.key,value:je,valueSpec:Le.valueSpec,style:Le.style,styleSpec:Le.styleSpec,arrayElementValidator:u})),"array"===F.K(je)&&0===je.length&&Oe.push(new F.V(Le.key,je,"array must have at least one stop")),Oe},default:function(F){return _e({key:F.key,value:F.value,valueSpec:Oe,style:F.style,styleSpec:F.styleSpec})}}});return"identity"===Fe&&jt&&wi.push(new F.V(Le.key,Le.value,'missing required property "property"')),"identity"===Fe||Le.value.stops||wi.push(new F.V(Le.key,Le.value,'missing required property "stops"')),"exponential"===Fe&&Le.valueSpec.expression&&!F.N(Le.valueSpec)&&wi.push(new F.V(Le.key,Le.value,"exponential functions not supported")),Le.styleSpec.$version>=8&&(Gt&&!F.O(Le.valueSpec)?wi.push(new F.V(Le.key,Le.value,"property functions not supported")):jt&&!F.Q(Le.valueSpec)&&wi.push(new F.V(Le.key,Le.value,"zoom functions not supported"))),"categorical"!==Fe&&!bi||void 0!==Le.value.property||wi.push(new F.V(Le.key,Le.value,'"property" property is required')),wi;function u(Le){let Fe=[];const je=Le.value,jt=Le.key;if("array"!==F.K(je))return[new F.V(jt,je,`array expected, ${F.K(je)} found`)];if(2!==je.length)return[new F.V(jt,je,`array length 2 expected, length ${je.length} found`)];if(bi){if("object"!==F.K(je[0]))return[new F.V(jt,je,`object expected, ${F.K(je[0])} found`)];if(void 0===je[0].zoom)return[new F.V(jt,je,"object stop key must have zoom")];if(void 0===je[0].value)return[new F.V(jt,je,"object stop key must have value")];const Oe=F.M(je[0].zoom);if("number"!=typeof Oe)return[new F.V(jt,je[0].zoom,"stop zoom values must be numbers")];if(He&&He>Oe)return[new F.V(jt,je[0].zoom,"stop zoom values must appear in ascending order")];Oe!==He&&(He=Oe,qe=void 0,xt={}),Fe=Fe.concat(H({key:`${jt}[0]`,value:je[0],valueSpec:{zoom:{}},style:Le.style,styleSpec:Le.styleSpec,objectElementValidators:{zoom:W,value:_}}))}else Fe=Fe.concat(_({key:`${jt}[0]`,value:je[0],valueSpec:{},style:Le.style,styleSpec:Le.styleSpec},je));return F.S(F.U(je[1]))?Fe.concat([new F.V(`${jt}[1]`,je[1],"expressions are not allowed in function stops.")]):Fe.concat(_e({key:`${jt}[1]`,value:je[1],valueSpec:Oe,style:Le.style,styleSpec:Le.styleSpec}))}function _(Le,He){const jt=F.K(Le.value),Gt=F.M(Le.value),bi=null!==Le.value?Le.value:He;if(je){if(jt!==je)return[new F.V(Le.key,bi,`${jt} stop domain type must match previous stop domain type ${je}`)]}else je=jt;if("number"!==jt&&"string"!==jt&&"boolean"!==jt&&"number"!=typeof Gt&&"string"!=typeof Gt&&"boolean"!=typeof Gt)return[new F.V(Le.key,bi,"stop domain value must be a number, string, or boolean")];if("number"!==jt&&"categorical"!==Fe){let je=`number expected, ${jt} found`;return F.O(Oe)&&void 0===Fe&&(je+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new F.V(Le.key,bi,je)]}return"categorical"!==Fe||"number"!==jt||"number"==typeof Gt&&isFinite(Gt)&&Math.floor(Gt)===Gt?"categorical"!==Fe&&"number"===jt&&"number"==typeof Gt&&"number"==typeof qe&&void 0!==qe&&Gt<qe?[new F.V(Le.key,bi,"stop domain values must appear in ascending order")]:(qe=Gt,"categorical"===Fe&&Gt in xt?[new F.V(Le.key,bi,"stop domain values must be unique")]:(xt[Gt]=!0,[])):[new F.V(Le.key,bi,`integer expected, found ${String(Gt)}`)]}}function X(Le){const Oe=("property"===Le.expressionContext?F.W:F.X)(F.U(Le.value),Le.valueSpec);if("error"===Oe.result)return Oe.value.map((Oe=>new F.V(`${Le.key}${Oe.key}`,Le.value,Oe.message)));const Fe=Oe.value.expression||Oe.value._styleExpression.expression;if("property"===Le.expressionContext&&"text-font"===Le.propertyKey&&!Fe.outputDefined())return[new F.V(Le.key,Le.value,`Invalid data expression for "${Le.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===Le.expressionContext&&"layout"===Le.propertyType&&!F.Y(Fe))return[new F.V(Le.key,Le.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===Le.expressionContext)return K(Fe,Le);if(Le.expressionContext&&0===Le.expressionContext.indexOf("cluster")){if(!F.Z(Fe,["zoom","feature-state"]))return[new F.V(Le.key,Le.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===Le.expressionContext&&!F._(Fe))return[new F.V(Le.key,Le.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function K(Le,Oe){const Fe=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(Oe.valueSpec&&Oe.valueSpec.expression)for(const F of Oe.valueSpec.expression.parameters)Fe.delete(F);if(0===Fe.size)return[];const je=[];return Le instanceof F.$&&Fe.has(Le.name)?[new F.V(Oe.key,Oe.value,`["${Le.name}"] expression is not supported in a filter for a ${Oe.object.type} layer with id: ${Oe.object.id}`)]:(Le.eachChild((F=>{je.push(...K(F,Oe))})),je)}function Y(Le){const Oe=Le.key,Fe=Le.value,je=Le.valueSpec,qe=[];return Array.isArray(je.values)?-1===je.values.indexOf(F.M(Fe))&&qe.push(new F.V(Oe,Fe,`expected one of [${je.values.join(", ")}], ${JSON.stringify(Fe)} found`)):-1===Object.keys(je.values).indexOf(F.M(Fe))&&qe.push(new F.V(Oe,Fe,`expected one of [${Object.keys(je.values).join(", ")}], ${JSON.stringify(Fe)} found`)),qe}function J(Le){return F.a1(F.U(Le.value))?X(F.L({},Le,{expressionContext:"filter",valueSpec:Le.styleSpec[`filter_${Le.layerType||"fill"}`]})):Q(Le)}function Q(Le){const Oe=Le.value,Fe=Le.key;if("array"!==F.K(Oe))return[new F.V(Fe,Oe,`array expected, ${F.K(Oe)} found`)];const je=Le.styleSpec;let qe,He=[];if(Oe.length<1)return[new F.V(Fe,Oe,"filter array must have at least 1 element")];switch(He=He.concat(Y({key:`${Fe}[0]`,value:Oe[0],valueSpec:je.filter_operator,style:Le.style,styleSpec:Le.styleSpec})),F.M(Oe[0])){case"<":case"<=":case">":case">=":Oe.length>=2&&"$type"===F.M(Oe[1])&&He.push(new F.V(Fe,Oe,`"$type" cannot be use with operator "${Oe[0]}"`));case"==":case"!=":3!==Oe.length&&He.push(new F.V(Fe,Oe,`filter array for operator "${Oe[0]}" must have 3 elements`));case"in":case"!in":Oe.length>=2&&(qe=F.K(Oe[1]),"string"!==qe&&He.push(new F.V(`${Fe}[1]`,Oe[1],`string expected, ${qe} found`)));for(let xt=2;xt<Oe.length;xt++)qe=F.K(Oe[xt]),"$type"===F.M(Oe[1])?He=He.concat(Y({key:`${Fe}[${xt}]`,value:Oe[xt],valueSpec:je.geometry_type,style:Le.style,styleSpec:Le.styleSpec})):"string"!==qe&&"number"!==qe&&"boolean"!==qe&&He.push(new F.V(`${Fe}[${xt}]`,Oe[xt],`string, number, or boolean expected, ${qe} found`));break;case"any":case"all":case"none":for(let F=1;F<Oe.length;F++)He=He.concat(Q({key:`${Fe}[${F}]`,value:Oe[F],style:Le.style,styleSpec:Le.styleSpec}));break;case"has":case"!has":qe=F.K(Oe[1]),2!==Oe.length?He.push(new F.V(Fe,Oe,`filter array for "${Oe[0]}" operator must have 2 elements`)):"string"!==qe&&He.push(new F.V(`${Fe}[1]`,Oe[1],`string expected, ${qe} found`))}return He}function ee(Le,Oe){const Fe=Le.key,je=Le.style,qe=Le.layer,He=Le.styleSpec,xt=Le.value,jt=Le.objectKey,Gt=He[`${Oe}_${Le.layerType}`];if(!Gt)return[];const bi=jt.match(/^(.*)-use-theme$/);if("paint"===Oe&&bi&&Gt[bi[1]])return F.S(xt)?[].concat(_e({key:Le.key,value:xt,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:je,styleSpec:He,expressionContext:"property",propertyType:Oe,propertyKey:jt})):_e({key:Fe,value:xt,valueSpec:{type:"string"},style:je,styleSpec:He});const wi=jt.match(/^(.*)-transition$/);if("paint"===Oe&&wi&&Gt[wi[1]]&&Gt[wi[1]].transition)return _e({key:Fe,value:xt,valueSpec:He.transition,style:je,styleSpec:He});const qr=Le.valueSpec||Gt[jt];if(!qr)return[new F.J(Fe,xt,`unknown property "${jt}"`)];let Xn;if("string"===F.K(xt)&&F.O(qr)&&!qr.tokens&&(Xn=/^{([^}]+)}$/.exec(xt))){const Le=`\`{ "type": "identity", "property": ${Xn?JSON.stringify(Xn[1]):'"_"'} }\``;return[new F.V(Fe,xt,`"${jt}" does not support interpolation syntax\nUse an identity property function instead: ${Le}.`)]}const Yn=[];if("symbol"===Le.layerType)"text-field"!==jt||!je||je.glyphs||je.imports||Yn.push(new F.V(Fe,xt,'use of "text-field" requires a style "glyphs" property')),"text-font"===jt&&F.a2(F.U(xt))&&"identity"===F.M(xt.type)&&Yn.push(new F.V(Fe,xt,'"text-font" does not support identity functions'));else if("model"===Le.layerType&&"paint"===Oe&&qe&&qe.layout&&qe.layout.hasOwnProperty("model-id")&&F.O(qr)&&(F.a3(qr)||F.Q(qr))){const Le=F.W(F.U(xt),qr),Oe=Le.value.expression||Le.value._styleExpression.expression;Oe&&!F.Z(Oe,["measure-light"])&&("model-emissive-strength"===jt&&F._(Oe)&&F.Y(Oe)||Yn.push(new F.V(Fe,xt,`${jt} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return Yn.concat(_e({key:Le.key,value:xt,valueSpec:qr,style:je,styleSpec:He,expressionContext:"property",propertyType:Oe,propertyKey:jt}))}function te(F){return ee(F,"paint")}function ie(F){return ee(F,"layout")}function oe(Le){let Oe=[];const Fe=Le.value,je=Le.key,qe=Le.style,He=Le.styleSpec;Fe.type||Fe.ref||Oe.push(new F.V(je,Fe,'either "type" or "ref" is required'));let xt=F.M(Fe.type);const jt=F.M(Fe.ref);if(Fe.id){const He=F.M(Fe.id);for(let xt=0;xt<Le.arrayIndex;xt++){const Le=qe.layers[xt];F.M(Le.id)===He&&Oe.push(new F.V(je,Fe.id,`duplicate layer id "${Fe.id}", previously used at line ${Le.id.__line__}`))}}if("ref"in Fe){let Le;["type","source","source-layer","filter","layout"].forEach((Le=>{Le in Fe&&Oe.push(new F.V(je,Fe[Le],`"${Le}" is prohibited for ref layers`))})),qe.layers.forEach((Oe=>{F.M(Oe.id)===jt&&(Le=Oe)})),Le?Le.ref?Oe.push(new F.V(je,Fe.ref,"ref cannot reference another ref layer")):xt=F.M(Le.type):"string"==typeof jt&&Oe.push(new F.V(je,Fe.ref,`ref layer "${jt}" not found`))}else if("background"!==xt&&"sky"!==xt&&"slot"!==xt)if(Fe.source){const Le=qe.sources&&qe.sources[Fe.source],He=Le&&F.M(Le.type);Le?"vector"===He&&"raster"===xt?Oe.push(new F.V(je,Fe.source,`layer "${Fe.id}" requires a raster source`)):"raster"===He&&"raster"!==xt?Oe.push(new F.V(je,Fe.source,`layer "${Fe.id}" requires a vector source`)):"vector"!==He||Fe["source-layer"]?"raster-dem"===He&&"hillshade"!==xt?Oe.push(new F.V(je,Fe.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==He||["raster","raster-particle"].includes(xt)?"line"!==xt||!Fe.paint||!Fe.paint["line-gradient"]&&!Fe.paint["line-trim-offset"]||"geojson"===He&&Le.lineMetrics?"raster-particle"===xt&&"raster-array"!==He&&Oe.push(new F.V(je,Fe.source,`layer "${Fe.id}" requires a 'raster-array' source.`)):Oe.push(new F.V(je,Fe,`layer "${Fe.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):Oe.push(new F.V(je,Fe.source,"raster-array source can only be used with layer type 'raster'.")):Oe.push(new F.V(je,Fe,`layer "${Fe.id}" must specify a "source-layer"`)):Oe.push(new F.V(je,Fe.source,`source "${Fe.source}" not found`))}else Oe.push(new F.V(je,Fe,'missing required property "source"'));return Oe=Oe.concat(H({key:je,value:Fe,valueSpec:He.layer,style:Le.style,styleSpec:Le.styleSpec,objectElementValidators:{"*":()=>[],type:()=>_e({key:`${je}.type`,value:Fe.type,valueSpec:He.layer.type,style:Le.style,styleSpec:Le.styleSpec,object:Fe,objectKey:"type"}),filter:Le=>J(F.L({layerType:xt},Le)),layout:Le=>H({layer:Fe,key:Le.key,value:Le.value,valueSpec:{},style:Le.style,styleSpec:Le.styleSpec,objectElementValidators:{"*":Le=>ie(F.L({layerType:xt},Le))}}),paint:Le=>H({layer:Fe,key:Le.key,value:Le.value,valueSpec:{},style:Le.style,styleSpec:Le.styleSpec,objectElementValidators:{"*":Le=>te(F.L({layerType:xt,layer:Fe},Le))}})}})),Oe}function se(Le){const Oe=Le.value,Fe=Le.key,je=F.K(Oe);return"string"!==je?[new F.V(Fe,Oe,`string expected, ${je} found`)]:[]}const pl={promoteId:function t({key:Le,value:Oe}){if("string"===F.K(Oe))return se({key:Le,value:Oe});if(Array.isArray(Oe)){const Fe=[],je=F.U(Oe),qe=F.X(je);return"error"===qe.result&&qe.value.forEach((Oe=>{Fe.push(new F.V(`${Le}${Oe.key}`,null,`${Oe.message}`))})),F.Z(qe.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||Fe.push(new F.V(`${Le}`,null,"promoteId expression should be only feature dependent")),Fe}{const F=[];for(const Fe in Oe)F.push(...t({key:`${Le}.${Fe}`,value:Oe[Fe]}));return F}}};function ne(Le){const Oe=Le.value,Fe=Le.key,je=Le.styleSpec,qe=Le.style;if(!Oe.type)return[new F.V(Fe,Oe,'"type" is required')];const He=F.M(Oe.type);let xt=[];switch(["vector","raster","raster-dem","raster-array"].includes(He)&&(Oe.url||Oe.tiles||xt.push(new F.J(Fe,Oe,'Either "url" or "tiles" is required.'))),He){case"vector":case"raster":case"raster-dem":case"raster-array":return xt=xt.concat(H({key:Fe,value:Oe,valueSpec:je[`source_${He.replace("-","_")}`],style:Le.style,styleSpec:je,objectElementValidators:pl})),xt;case"geojson":if(xt=H({key:Fe,value:Oe,valueSpec:je.source_geojson,style:qe,styleSpec:je,objectElementValidators:pl}),Oe.cluster)for(const F in Oe.clusterProperties){const[Le,je]=Oe.clusterProperties[F],qe="string"==typeof Le?[Le,["accumulated"],["get",F]]:Le;xt.push(...X({key:`${Fe}.${F}.map`,value:je,expressionContext:"cluster-map"})),xt.push(...X({key:`${Fe}.${F}.reduce`,value:qe,expressionContext:"cluster-reduce"}))}return xt;case"video":return H({key:Fe,value:Oe,valueSpec:je.source_video,style:qe,styleSpec:je});case"image":return H({key:Fe,value:Oe,valueSpec:je.source_image,style:qe,styleSpec:je});case"canvas":return[new F.V(Fe,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Y({key:`${Fe}.type`,value:Oe.type,valueSpec:{values:ae(je)},style:qe,styleSpec:je})}}function ae(F){return F.source.reduce(((Le,Oe)=>{const Fe=F[Oe];return"enum"===Fe.type.type&&(Le=Le.concat(Object.keys(Fe.type.values))),Le}),[])}function le(Le){const Oe=Le.value,Fe=Le.styleSpec,je=Fe.light,qe=Le.style;let He=[];const xt=F.K(Oe);if(void 0===Oe)return He;if("object"!==xt)return He=He.concat([new F.V("light",Oe,`object expected, ${xt} found`)]),He;for(const Le in Oe){const xt=Le.match(/^(.*)-transition$/),jt=Le.match(/^(.*)-use-theme$/);He=He.concat(jt&&je[jt[1]]?_e({key:Le,value:Oe[Le],valueSpec:{type:"string"},style:qe,styleSpec:Fe}):xt&&je[xt[1]]&&je[xt[1]].transition?_e({key:Le,value:Oe[Le],valueSpec:Fe.transition,style:qe,styleSpec:Fe}):je[Le]?_e({key:Le,value:Oe[Le],valueSpec:je[Le],style:qe,styleSpec:Fe}):[new F.V(Le,Oe[Le],`unknown property "${Le}"`)])}return He}function ce(Le){const Oe=Le.value;let Fe=[];if(!Oe)return Fe;const je=F.K(Oe);if("object"!==je)return Fe=Fe.concat([new F.V("light-3d",Oe,`object expected, ${je} found`)]),Fe;const qe=Le.styleSpec,He=qe["light-3d"],xt=Le.key,jt=Le.style,Gt=Le.style.lights;for(const Le of["type","id"])if(!(Le in Oe))return Fe=Fe.concat([new F.V("light-3d",Oe,`missing property ${Le} on light`)]),Fe;if(Oe.type&&Gt)for(let je=0;je<Le.arrayIndex;je++){const Le=F.M(Oe.type),qe=Gt[je];F.M(qe.type)===Le&&Fe.push(new F.V(xt,Oe.id,`duplicate light type "${Oe.type}", previously defined at line ${qe.id.__line__}`))}const bi=`properties_light_${Oe.type}`;if(!(bi in qe))return Fe=Fe.concat([new F.V("light-3d",Oe,`Invalid light type ${Oe.type}`)]),Fe;const wi=qe[bi];for(const je in Oe)if("properties"===je){const He=Oe[je],xt=F.K(He);if("object"!==xt)return Fe=Fe.concat([new F.V("properties",He,`object expected, ${xt} found`)]),Fe;for(const Oe in He)Fe=Fe.concat(wi[Oe]?_e({key:Oe,value:He[Oe],valueSpec:wi[Oe],style:jt,styleSpec:qe}):[new F.J(Le.key,He[Oe],`unknown property "${Oe}"`)])}else{const Le=je.match(/^(.*)-transition$/),xt=je.match(/^(.*)-use-theme$/);Fe=Fe.concat(xt&&He[xt[1]]?_e({key:je,value:Oe[je],valueSpec:{type:"string"},style:jt,styleSpec:qe}):Le&&He[Le[1]]&&He[Le[1]].transition?_e({key:je,value:Oe[je],valueSpec:qe.transition,style:jt,styleSpec:qe}):He[je]?_e({key:je,value:Oe[je],valueSpec:He[je],style:jt,styleSpec:qe}):[new F.J(je,Oe[je],`unknown property "${je}"`)])}return Fe}function he(Le){const Oe=Le.value,Fe=Le.key,je=Le.style,qe=Le.styleSpec,He=qe.terrain;let xt=[];const jt=F.K(Oe);if(void 0===Oe)return xt;if("null"===jt)return xt;if("object"!==jt)return xt=xt.concat([new F.V("terrain",Oe,`object expected, ${jt} found`)]),xt;for(const Le in Oe){const Fe=Le.match(/^(.*)-transition$/),jt=Le.match(/^(.*)-use-theme$/);xt=xt.concat(jt&&He[jt[1]]?_e({key:Le,value:Oe[Le],valueSpec:{type:"string"},style:je,styleSpec:qe}):Fe&&He[Fe[1]]&&He[Fe[1]].transition?_e({key:Le,value:Oe[Le],valueSpec:qe.transition,style:je,styleSpec:qe}):He[Le]?_e({key:Le,value:Oe[Le],valueSpec:He[Le],style:je,styleSpec:qe}):[new F.J(Le,Oe[Le],`unknown property "${Le}"`)])}if(Oe.source){const Le=je.sources&&je.sources[Oe.source],qe=Le&&F.M(Le.type);Le?"raster-dem"!==qe&&xt.push(new F.V(Fe,Oe.source,`terrain cannot be used with a source of type ${String(qe)}, it only be used with a "raster-dem" source type`)):xt.push(new F.V(Fe,Oe.source,`source "${Oe.source}" not found`))}else xt.push(new F.V(Fe,Oe,'terrain is missing required property "source"'));return xt}function de(Le){const Oe=Le.value,Fe=Le.style,je=Le.styleSpec,qe=je.fog;let He=[];const xt=F.K(Oe);if(void 0===Oe)return He;if("object"!==xt)return He=He.concat([new F.V("fog",Oe,`object expected, ${xt} found`)]),He;for(const Le in Oe){const xt=Le.match(/^(.*)-transition$/),jt=Le.match(/^(.*)-use-theme$/);He=He.concat(jt&&qe[jt[1]]?_e({key:Le,value:Oe[Le],valueSpec:{type:"string"},style:Fe,styleSpec:je}):xt&&qe[xt[1]]&&qe[xt[1]].transition?_e({key:Le,value:Oe[Le],valueSpec:je.transition,style:Fe,styleSpec:je}):qe[Le]?_e({key:Le,value:Oe[Le],valueSpec:qe[Le],style:Fe,styleSpec:je}):[new F.J(Le,Oe[Le],`unknown property "${Le}"`)])}return He}const bl={"*":()=>[],array:Z,boolean:function(Le){const Oe=Le.value,Fe=Le.key,je=F.K(Oe);return"boolean"!==je?[new F.V(Fe,Oe,`boolean expected, ${je} found`)]:[]},number:W,color:function(Le){const Oe=Le.key,Fe=Le.value,je=F.K(Fe);return"string"!==je?[new F.V(Oe,Fe,`color expected, ${je} found`)]:null===F.a0.parseCSSColor(Fe)?[new F.V(Oe,Fe,`color expected, "${Fe}" found`)]:[]},enum:Y,filter:J,function:$,layer:oe,object:H,source:ne,model:F.a4,light:le,"light-3d":ce,terrain:he,fog:de,string:se,formatted:function(F){return 0===se(F).length?[]:X(F)},resolvedImage:function(F){return 0===se(F).length?[]:X(F)},projection:function(Le){const Oe=Le.value,Fe=Le.styleSpec,je=Fe.projection,qe=Le.style;let He=[];const xt=F.K(Oe);if("object"===xt)for(const F in Oe)He=He.concat(_e({key:F,value:Oe[F],valueSpec:je[F],style:qe,styleSpec:Fe}));else"string"!==xt&&(He=He.concat([new F.V("projection",Oe,`object or string expected, ${xt} found`)]));return He},import:function(Le){const{value:Oe,styleSpec:Fe}=Le,{data:je,...qe}=Oe;Object.defineProperty(qe,"__line__",{value:Oe.__line__,enumerable:!1});let He=H(F.L({},Le,{value:qe,valueSpec:Fe.import}));return""===F.M(qe.id)&&He.push(new F.V(`${Le.key}.id`,qe,"import id can't be an empty string")),je&&(He=He.concat(fe(je,Fe,{key:`${Le.key}.data`}))),He},iconset:function(Le){const Oe=Le.value,Fe=Le.key,je=Le.styleSpec,qe=Le.style;if(!Oe.type)return[new F.V(Fe,Oe,'"type" is required')];const He=F.M(Oe.type);let xt=[];if(xt=xt.concat(H({key:Fe,value:Oe,valueSpec:je[`iconset_${He}`],style:qe,styleSpec:je})),"source"===He&&Oe.source){const Le=qe.sources&&qe.sources[Oe.source],je=Le&&F.M(Le.type);Le?"raster-array"!==je&&xt.push(new F.V(Fe,Oe.source,`iconset cannot be used with a source of type ${String(je)}, it only be used with a "raster-array" source type`)):xt.push(new F.V(Fe,Oe.source,`source "${Oe.source}" not found`))}return xt}};function _e(Le,Oe=!1){const Fe=Le.value,je=Le.valueSpec,qe=Le.styleSpec;if(je.expression&&F.a2(F.M(Fe)))return $(Le);if(je.expression&&F.S(F.U(Fe)))return X(Le);if(je.type&&bl[je.type]){const Fe=bl[je.type](Le);return!0===Oe&&Fe.length>0&&"array"===F.K(Le.value)?X(Le):Fe}return H(F.L({},Le,{valueSpec:je.type?qe[je.type]:je}))}function pe(Le){const Oe=Le.value,Fe=Le.key,je=se(Le);return je.length||(-1===Oe.indexOf("{fontstack}")&&je.push(new F.V(Fe,Oe,'"glyphs" url must include a "{fontstack}" token')),-1===Oe.indexOf("{range}")&&je.push(new F.V(Fe,Oe,'"glyphs" url must include a "{range}" token'))),je}function fe(Le,Oe=F.a5,Fe={}){return _e({key:Fe.key||"",value:Le,valueSpec:Oe.$root,styleSpec:Oe,style:Le,objectElementValidators:{glyphs:pe,"*":()=>[]}})}function me(Le,Oe=F.a5){return De(fe(Le,Oe))}const ge=F=>De(ne(F)),ve=F=>De(le(F)),ye=F=>De(ce(F)),xe=F=>De(he(F)),be=F=>De(de(F)),we=Le=>De(function(Le){const Oe=Le.value,Fe=Le.style,je=Le.styleSpec,qe=je.snow;let He=[];const xt=F.K(Oe);if(void 0===Oe)return He;if("object"!==xt)return He=He.concat([new F.V("snow",Oe,`object expected, ${xt} found`)]),He;for(const Le in Oe){const xt=Le.match(/^(.*)-transition$/);He=He.concat(xt&&qe[xt[1]]&&qe[xt[1]].transition?_e({key:Le,value:Oe[Le],valueSpec:je.transition,style:Fe,styleSpec:je}):qe[Le]?_e({key:Le,value:Oe[Le],valueSpec:qe[Le],style:Fe,styleSpec:je}):[new F.J(Le,Oe[Le],`unknown property "${Le}"`)])}return He}(Le)),Te=Le=>De(function(Le){const Oe=Le.value,Fe=Le.style,je=Le.styleSpec,qe=je.rain;let He=[];const xt=F.K(Oe);if(void 0===Oe)return He;if("object"!==xt)return He=He.concat([new F.V("rain",Oe,`object expected, ${xt} found`)]),He;for(const Le in Oe){const xt=Le.match(/^(.*)-transition$/);He=He.concat(xt&&qe[xt[1]]&&qe[xt[1]].transition?_e({key:Le,value:Oe[Le],valueSpec:je.transition,style:Fe,styleSpec:je}):qe[Le]?_e({key:Le,value:Oe[Le],valueSpec:qe[Le],style:Fe,styleSpec:je}):[new F.J(Le,Oe[Le],`unknown property "${Le}"`)])}return He}(Le)),Ee=F=>De(oe(F)),Se=F=>De(J(F)),Ce=F=>De(te(F)),Ie=F=>De(ie(F)),Re=Le=>De(F.a4(Le));function De(F){return F.slice().sort(((F,Le)=>F.line&&Le.line?F.line-Le.line:0))}function Ae(Le,Oe){let Fe=!1;if(Oe&&Oe.length)for(const je of Oe)je instanceof F.J?F.w(je.message):(Le.fire(new F.z(new Error(je.message))),Fe=!0);return Fe}let Tl;class Me extends F.E{constructor(Le,Oe="flat"){super(),this._transitionable=new F.a6(Tl||(Tl=new F.a7({anchor:new F.a8(F.a5.light.anchor),position:new F.a9(F.a5.light.position),color:new F.a8(F.a5.light.color),intensity:new F.a8(F.a5.light.intensity)}))),this.setLight(Le,Oe),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(F,Le,Oe={}){this._validate(ve,F,Oe)||(this._transitionable.setTransitionOrValue(F),this.id=Le)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Le,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Ae(this,Le.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}}let kl=class extends F.E{constructor(Le,Oe,Fe,je){super(),this.scope=Fe,this._transitionable=new F.a6(new F.a7({source:new F.a8(F.a5.terrain.source),exaggeration:new F.a8(F.a5.terrain.exaggeration)}),Fe,je),this._transitionable.setTransitionOrValue(Le,je),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=Oe}get(){return this._transitionable.serialize()}set(F,Le){this._transitionable.setTransitionOrValue(F,Le)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}getExaggeration(Le){return this._transitioning.possiblyEvaluate(new F.aa(Le)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const Le=this._transitionable._values.exaggeration;if(!Le)return null;const Oe=Le.value.expression;if(!Oe)return null;let Fe=-1,je=-1,qe=1;for(const Le of Oe.zoomStops)qe=Oe.evaluate(new F.aa(Le)),qe>.01?(Fe=Le,je=-1):je=Le;return qe<.01&&Fe>0&&je>Fe?[Fe,je]:null}isZoomDependent(){const Le=this._transitionable._values.exaggeration;return null!=Le&&null!=Le.value&&null!=Le.value.expression&&Le.value.expression instanceof F.ab}};const ec=45,tc=65,ic=.05;function ke(Le,Oe,Fe,je){const qe=F.ae(ec,tc,Fe),[He,xt]=Be(Le,je);let jt=1-Math.min(1,Math.exp((Oe-He)/(xt-He)*-6));return jt*=jt*jt,jt=Math.min(1,1.00747*jt),jt*qe*Le.alpha}function Be(F,Le){const Oe=.5/Math.tan(.5*Le);return[F.range[0]+Oe,F.range[1]+Oe]}function Ne(Le,Oe,Fe,je,qe){const He=F.ad.vec3.transformMat4([],[Oe,Fe,je],qe.mercatorFogMatrix);return ke(Le,F.ad.vec3.length(He),qe.pitch,qe._fov)}function Ue(Le,Oe,Fe,je,qe,He,xt){const jt=[[Fe,je,0],[qe,je,0],[qe,He,0],[Fe,He,0]];let Gt=Number.MAX_VALUE,bi=-Number.MAX_VALUE;for(const Le of jt){const Fe=F.ad.vec3.transformMat4([],Le,Oe),je=F.ad.vec3.length(Fe);Gt=Math.min(Gt,je),bi=Math.max(bi,je)}return[ke(Le,Gt,xt.pitch,xt._fov),ke(Le,bi,xt.pitch,xt._fov)]}class Ve extends F.E{constructor(Le,Oe,Fe,je){super();const qe=new F.a7({range:new F.a8(F.a5.fog.range),color:new F.a8(F.a5.fog.color),"color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new F.a8(F.a5.fog["high-color"]),"high-color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new F.a8(F.a5.fog["space-color"]),"space-color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new F.a8(F.a5.fog["horizon-blend"]),"star-intensity":new F.a8(F.a5.fog["star-intensity"]),"vertical-range":new F.a8(F.a5.fog["vertical-range"])});this._transitionable=new F.a6(qe,Fe,new Map(je)),this.set(Le,je),this._transitioning=this._transitionable.untransitioned(),this._transform=Oe,this.properties=new F.af(qe),this.scope=Fe}get state(){const Le=this._transform,Oe="globe"===Le.projection.name,Fe=F.ag(Le.zoom),je=this.properties.get("range"),qe=[.5,3];return{range:Oe?[F.ah(qe[0],je[0],Fe),F.ah(qe[1],je[1],Fe)]:je,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(Le,Oe,Fe={}){if(this._validate(be,Le,Fe))return;const je=F.l({},Le);for(const Le of Object.keys(F.a5.fog))void 0===je[Le]&&(je[Le]=F.a5.fog[Le].default);this._options=je,this._transitionable.setTransitionOrValue(this._options,Oe)}getOpacity(Le){if(!this._transform.projection.supportsFog)return 0;const Oe=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:F.ae(ec,tc,Le))*Oe.a}getOpacityAtLatLng(Le,Oe){return this._transform.projection.supportsFog?function(Le,Oe,Fe){const je=F.ac.fromLngLat(Oe),qe=Fe.elevation?Fe.elevation.getAtPointOrZero(je):0;return Ne(Le,je.x,je.y,qe,Fe)}(this.state,Le,Oe):0}getOpacityForTile(Le){if(!this._transform.projection.supportsFog)return[1,1];const Oe=this._transform.calculateFogTileMatrix(Le.toUnwrapped());return Ue(this.state,Oe,0,0,F.ai,F.ai,this._transform)}getOpacityForBounds(F,Le,Oe,Fe,je){return this._transform.projection.supportsFog?Ue(this.state,F,Le,Oe,Fe,je,this._transform):[1,1]}getFovAdjustedRange(F){return this._transform.projection.supportsFog?Be(this.state,F):[0,1]}isVisibleOnFrustum(Le){if(!this._transform.projection.supportsFog)return!1;const Oe=[4,5,6,7];for(const Fe of Oe){const Oe=Le.points[Fe];let je;if(Oe[2]>=0)je=Oe;else{const qe=Le.points[Fe-4];je=F.aj(qe,Oe,qe[2]/(qe[2]-Oe[2]))}if(Ne(this.state,je[0],je[1],0,this._transform)>=ic)return!0}return!1}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Le,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Ae(this,Le.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}}let oc,sc,ac,mc,gc=class extends F.E{constructor(Le,Oe,Fe,je){super();const qe=oc||(oc=new F.a7({density:new F.a8(F.a5.snow.density),intensity:new F.a8(F.a5.snow.intensity),color:new F.a8(F.a5.snow.color),opacity:new F.a8(F.a5.snow.opacity),vignette:new F.a8(F.a5.snow.vignette),"vignette-color":new F.a8(F.a5.snow["vignette-color"]),"center-thinning":new F.a8(F.a5.snow["center-thinning"]),direction:new F.a8(F.a5.snow.direction),"flake-size":new F.a8(F.a5.snow["flake-size"])}));this._transitionable=new F.a6(qe,Fe,new Map(je)),this.set(Le,je),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.af(qe),this.scope=Fe}get state(){const Le=this.properties.get("opacity"),Oe=this.properties.get("color"),Fe=this.properties.get("direction"),je=F.ak(Fe[0]),qe=-Math.max(F.ak(Fe[1]),.01),He=[Math.cos(je)*Math.cos(qe),Math.sin(je)*Math.cos(qe),Math.sin(qe)],xt=this.properties.get("vignette"),jt=this.properties.get("vignette-color");return jt.a=xt,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.al(Oe.r,Oe.g,Oe.b,Oe.a*Le),direction:He,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:jt}}get(){return this._transitionable.serialize()}set(Le,Oe,Fe={}){if(this._validate(we,Le,Fe))return;const je=F.l({},Le);for(const Le of Object.keys(F.a5.snow))void 0===je[Le]&&(je[Le]=F.a5.snow[Le].default);this._options=je,this._transitionable.setTransitionOrValue(this._options,Oe)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Le,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Ae(this,Le.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}},yc=class extends F.E{constructor(Le,Oe,Fe,je){super();const qe=sc||(sc=new F.a7({density:new F.a8(F.a5.rain.density),intensity:new F.a8(F.a5.rain.intensity),color:new F.a8(F.a5.rain.color),opacity:new F.a8(F.a5.rain.opacity),vignette:new F.a8(F.a5.rain.vignette),"vignette-color":new F.a8(F.a5.rain["vignette-color"]),"center-thinning":new F.a8(F.a5.rain["center-thinning"]),direction:new F.a8(F.a5.rain.direction),"droplet-size":new F.a8(F.a5.rain["droplet-size"]),"distortion-strength":new F.a8(F.a5.rain["distortion-strength"])}));this._transitionable=new F.a6(qe,Fe,new Map(je)),this.set(Le,je),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.af(qe),this.scope=Fe}get state(){const Le=this.properties.get("opacity"),Oe=this.properties.get("color"),Fe=this.properties.get("direction"),je=F.ak(Fe[0]),qe=-Math.max(F.ak(Fe[1]),.01),He=[Math.cos(je)*Math.cos(qe),Math.sin(je)*Math.cos(qe),Math.sin(qe)],xt=this.properties.get("vignette-color");return xt.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.al(Oe.r,Oe.g,Oe.b,Oe.a*Le),direction:He,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:xt}}get(){return this._transitionable.serialize()}set(Le,Oe,Fe={}){if(this._validate(Te,Le,Fe))return;const je=F.l({},Le);for(const Le of Object.keys(F.a5.rain))void 0===je[Le]&&(je[Le]=F.a5.rain[Le].default);this._options=je,this._transitionable.setTransitionOrValue(this._options,Oe)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(Le,Oe,Fe){return(!Fe||!1!==Fe.validate)&&Ae(this,Le.call(me,F.l({value:Oe,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}};class $e extends F.E{constructor(Le,Oe,Fe,je){super(),this.scope=Fe,this._options=Le,this.properties=new F.af(Oe),this._transitionable=new F.a6(Oe,Fe,new Map(je)),this._transitionable.setTransitionOrValue(Le.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(F){this._transitionable.setTransitionOrValue(this._options.properties,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(F,Le){this._options=F,this._transitionable.setTransitionOrValue(F.properties,Le)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class Xe{constructor(F,Le,Oe,Fe){this.screenBounds=F,this.cameraPoint=Le,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=Oe,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,Fe)}static createFromScreenPoints(Le,Oe){let Fe,je;if(Le instanceof F.P||"number"==typeof Le[0]){const qe=F.P.convert(Le);Fe=[qe],je=Oe.isPointAboveHorizon(qe)}else{const qe=F.P.convert(Le[0]),He=F.P.convert(Le[1]);Fe=[qe,He],je=F.an(qe,He).every((F=>Oe.isPointAboveHorizon(F)))}return new Xe(Fe,Oe.getCameraPoint(),je,Oe)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(Le){return F.an(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],Le)}bufferedCameraGeometry(Le){const Oe=this.screenBounds[0],Fe=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],je=F.an(Oe,Fe,0,!1);return this.cameraPoint.y>Fe.y&&(this.cameraPoint.x>Oe.x&&this.cameraPoint.x<Fe.x?je.splice(3,0,this.cameraPoint):this.cameraPoint.x>=Fe.x?je[2]=this.cameraPoint:this.cameraPoint.x<=Oe.x&&(je[3]=this.cameraPoint)),F.ao(je,Le)}bufferedCameraGeometryGlobe(Le){const Oe=this.screenBounds[0],Fe=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],je=F.an(Oe,Fe,Le),qe=this.cameraPoint.clone();switch(3*((qe.y>Oe.y)+(qe.y>Fe.y))+((qe.x>Oe.x)+(qe.x>Fe.x))){case 0:je[0]=qe,je[4]=qe.clone();break;case 1:je.splice(1,0,qe);break;case 2:je[1]=qe;break;case 3:je.splice(4,0,qe);break;case 5:je.splice(2,0,qe);break;case 6:je[3]=qe;break;case 7:je.splice(3,0,qe);break;case 8:je[2]=qe}return je}containsTile(Le,Oe,Fe,je=0){const qe=Le.queryPadding/Oe._pixelsPerMercatorPixel+1,He=Fe?this._bufferedCameraMercator(qe,Oe):this._bufferedScreenMercator(qe,Oe);let xt=Le.tileID.wrap+(He.unwrapped?je:0);const jt=He.polygon.map((Oe=>F.ap(Le.tileTransform,Oe,xt)));if(!F.aq(jt,0,0,F.ai,F.ai))return;xt=Le.tileID.wrap+(this.screenGeometryMercator.unwrapped?je:0);const Gt=this.screenGeometryMercator.polygon.map((Oe=>F.ar(Le.tileTransform,Oe,xt))),bi=Gt.map((Le=>new F.P(Le[0],Le[1]))),wi=Oe.getFreeCameraOptions().position||new F.ac(0,0,0),qr=F.ar(Le.tileTransform,wi,xt),Xn=Gt.map((Le=>{const Oe=F.ad.vec3.sub(Le,Le,qr);return F.ad.vec3.normalize(Oe,Oe),new F.as(qr,Oe)})),Yn=F.at(Le,1,Oe.zoom)*Oe._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:bi,tilespaceRays:Xn,bufferedTilespaceGeometry:jt,bufferedTilespaceBounds:(yo=F.au(jt),yo.min.x=F.ay(yo.min.x,0,F.ai),yo.min.y=F.ay(yo.min.y,0,F.ai),yo.max.x=F.ay(yo.max.x,0,F.ai),yo.max.y=F.ay(yo.max.y,0,F.ai),yo),tile:Le,tileID:Le.tileID,pixelToTileUnitsFactor:Yn};var yo}_bufferedScreenMercator(F,Le){const Oe=Je(F);if(this._screenRaycastCache[Oe])return this._screenRaycastCache[Oe];{let Fe;return Fe="globe"===Le.projection.name?this._projectAndResample(this.bufferedScreenGeometry(F),Le):{polygon:this.bufferedScreenGeometry(F).map((F=>Le.pointCoordinate3D(F))),unwrapped:!0},this._screenRaycastCache[Oe]=Fe,Fe}}_bufferedCameraMercator(F,Le){const Oe=Je(F);if(this._cameraRaycastCache[Oe])return this._cameraRaycastCache[Oe];{let Fe;return Fe="globe"===Le.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(F),Le):{polygon:this.bufferedCameraGeometry(F).map((F=>Le.pointCoordinate3D(F))),unwrapped:!0},this._cameraRaycastCache[Oe]=Fe,Fe}}_projectAndResample(Le,Oe){const Fe=function(Le,Oe){const Fe=F.ad.mat4.multiply([],Oe.pixelMatrix,Oe.globeMatrix),je=[0,-F.az,0,1],qe=[0,F.az,0,1],He=[0,0,0,1];F.ad.vec4.transformMat4(je,je,Fe),F.ad.vec4.transformMat4(qe,qe,Fe),F.ad.vec4.transformMat4(He,He,Fe);const xt=new F.P(je[0]/je[3],je[1]/je[3]),jt=new F.P(qe[0]/qe[3],qe[1]/qe[3]),Gt=F.aw(Le,xt)&&je[3]<He[3],bi=F.aw(Le,jt)&&qe[3]<He[3];if(!Gt&&!bi)return null;const wi=function(F,Le,Oe){for(let Fe=1;Fe<F.length;Fe++){const je=Ye(Le.pointCoordinate3D(F[Fe-1]).x),qe=Ye(Le.pointCoordinate3D(F[Fe]).x);if(Oe<0){if(je<qe)return{idx:Fe,t:-je/(qe-1-je)}}else if(qe<je)return{idx:Fe,t:(1-je)/(qe+1-je)}}return null}(Le,Oe,Gt?-1:1);if(!wi)return null;const{idx:qr,t:Xn}=wi;let Yn=qr>1?Ke(Le.slice(0,qr),Oe):[],yo=qr<Le.length?Ke(Le.slice(qr),Oe):[];Yn=Yn.map((Le=>new F.P(Ye(Le.x),Le.y))),yo=yo.map((Le=>new F.P(Ye(Le.x),Le.y)));const bo=[...Yn];0===bo.length&&bo.push(yo[yo.length-1]);const Do=F.ah(bo[bo.length-1].y,(0===yo.length?Yn[0]:yo[0]).y,Xn);let Ro;return Ro=Gt?[new F.P(0,Do),new F.P(0,0),new F.P(1,0),new F.P(1,Do)]:[new F.P(1,Do),new F.P(1,1),new F.P(0,1),new F.P(0,Do)],bo.push(...Ro),0===yo.length?bo.push(Yn[0]):bo.push(...yo),{polygon:bo.map((Le=>new F.ac(Le.x,Le.y))),unwrapped:!1}}(Le,Oe);if(Fe)return Fe;const je=function(Le,Oe){let Fe=!1,je=-1/0,qe=0;for(let F=0;F<Le.length-1;F++)Le[F].x>je&&(je=Le[F].x,qe=F);for(let F=0;F<Le.length-1;F++){const Oe=(qe+F)%(Le.length-1),je=Le[Oe],He=Le[Oe+1];Math.abs(je.x-He.x)>.5&&(je.x<He.x?(je.x+=1,0===Oe&&(Le[Le.length-1].x+=1)):(He.x+=1,Oe+1===Le.length-1&&(Le[0].x+=1)),Fe=!0)}const He=F.av(Oe.center.lng);return Fe&&He<Math.abs(He-1)&&Le.forEach((F=>{F.x-=1})),{polygon:Le,unwrapped:Fe}}(Ke(Le,Oe).map((Le=>new F.P(Ye(Le.x),Le.y))),Oe);return{polygon:je.polygon.map((Le=>new F.ac(Le.x,Le.y))),unwrapped:je.unwrapped}}}function Ke(Le,Oe){return F.ax(Le,(F=>{const Le=Oe.pointCoordinate3D(F);F.x=Le.x,F.y=Le.y}),1/256)}function Ye(F){return F<0?1+F%1:F%1}function Je(F){return 100*F|0}function Qe(Le,Oe,Fe,je,qe){const n=function(Fe,je){if(Fe)return qe(Fe);if(je){if(Le.url&&je.tiles&&Le.tiles&&delete Le.tiles,je.variants){if(!Array.isArray(je.variants))return qe(new Error("variants must be an array"));for(const Le of je.variants){if(null==Le||"object"!=typeof Le||Le.constructor!==Object)return qe(new Error("variant must be an object"));if(!Array.isArray(Le.capabilities))return qe(new Error("capabilities must be an array"));if(1===Le.capabilities.length&&"meshopt"===Le.capabilities[0]){je=F.l(je,Le);break}}}const Fe=F.aA(F.l({},je,Le),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);Fe.tiles=Oe.canonicalizeTileset(Fe,Le.url),qe(null,Fe)}},He=function(F,Le,Oe){if(!F)return null;if(!Le&&!Oe)return F;Oe=Oe||F.worldview_default;const Fe=Object.values(F.language||{});if(0===Fe.length)return null;const je=Object.values(F.worldview||{});if(0===je.length)return null;const qe=Fe.every((F=>F===Le)),He=je.every((F=>F===Oe));return qe&&He?F:Le in(F.language_options||{})||Oe in(F.worldview_options||{})?null:F.language_options&&F.worldview_options?F:null}(Le.data,Fe,je);return He?F.q.frame((()=>n(null,He))):Le.url?F.n(Oe.transformRequest(Oe.normalizeSourceURL(Le.url,null,Fe,je),F.R.Source),n):F.q.frame((()=>{const{data:F,...Oe}=Le;n(null,Oe)}))}class et{constructor(Le,Oe,Fe){this.bounds=F.aB.convert(this.validateBounds(Le)),this.minzoom=Oe||0,this.maxzoom=Fe||24}validateBounds(F){return Array.isArray(F)&&4===F.length?[Math.max(-180,F[0]),Math.max(-90,F[1]),Math.min(180,F[2]),Math.min(90,F[3])]:[-180,-90,180,90]}contains(Le){const Oe=Math.pow(2,Le.z),Fe=Math.floor(F.av(this.bounds.getWest())*Oe),je=Math.floor(F.aC(this.bounds.getNorth())*Oe),qe=Math.ceil(F.av(this.bounds.getEast())*Oe),He=Math.ceil(F.aC(this.bounds.getSouth())*Oe);return Le.x>=Fe&&Le.x<qe&&Le.y>=je&&Le.y<He}}class tt extends F.E{constructor(Le,Oe,Fe,je){if(super(),this.id=Le,this.dispatcher=Fe,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,F.l(this,F.aA(Oe,["url","scheme","tileSize","promoteId"])),this._options=F.l({type:"vector"},Oe),this._collectResourceTiming=!!Oe.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(je),this._tileWorkers={},this._deduped=new F.aD}load(Le){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"}));const Oe=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Fe=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Oe,Fe,((je,qe)=>{if(this._tileJSONRequest=null,this._loaded=!0,je)Oe&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Oe}`),Fe&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Fe}`),this.fire(new F.z(je));else if(qe){if(F.l(this,qe),this.hasWorldviews=!!qe.worldview_options,qe.worldview_default&&(this.worldviewDefault=qe.worldview_default),qe.vector_layers){this.vectorLayers=qe.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const F of qe.vector_layers)this.vectorLayerIds.push(F.id),qe.worldview&&qe.worldview[F.source]&&this.localizableLayerIds.add(F.id)}qe.bounds&&(this.tileBounds=new et(qe.bounds,this.minzoom,this.maxzoom)),yo(qe.tiles,this.map._requestManager._customAccessToken),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}Le&&Le(je)}))}loaded(){return this._loaded}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Le=F.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(Le)))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}loadTile(Le,Oe){const Fe=Le.tileID.canonical.url(this.tiles,this.scheme),je=this.map._requestManager.normalizeTileURL(Fe),qe=this.map._requestManager.transformRequest(je,F.R.Tile),He=this.map.style?this.map.style.getLut(this.scope):null,xt=He?{image:He.image.clone()}:null,jt={request:qe,data:void 0,uid:Le.uid,tileID:Le.tileID,tileZoom:Le.tileZoom,zoom:Le.tileID.overscaledZ,maxZoom:this.maxzoom,lut:xt,tileSize:this.tileSize*Le.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:Le.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:Le.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&F.f(Fe)&&(jt.worldview=this.map.getWorldview()||this.worldviewDefault,jt.localizableLayerIds=this.localizableLayerIds),jt.request.collectResourceTiming=this._collectResourceTiming,Le.actor&&"expired"!==Le.state)"loading"===Le.state?Le.reloadCallback=Oe:Le.request=Le.actor.send("reloadTile",jt,c.bind(this));else if(Le.actor=this._tileWorkers[je]=this._tileWorkers[je]||this.dispatcher.getActor(),this.dispatcher.ready)Le.request=Le.actor.send("loadTile",jt,c.bind(this),void 0,!0);else{const Oe=F.aE.call({deduped:this._deduped},jt,((F,Oe)=>{F||!Oe?c.call(this,F):(jt.data={cacheControl:Oe.cacheControl,expires:Oe.expires,rawData:Oe.rawData.slice(0)},Le.actor&&Le.actor.send("loadTile",jt,c.bind(this),void 0,!0))}),!0);Le.request={cancel:Oe}}function c(Fe,je){return delete Le.request,Le.aborted?Oe(null):Fe&&404!==Fe.status?Oe(Fe):(je&&je.resourceTiming&&(Le.resourceTiming=je.resourceTiming),this.map._refreshExpiredTiles&&je&&Le.setExpiryData(je),Le.loadVectorData(je,this.map.painter),F.aF(this.dispatcher),Oe(null),void(Le.reloadCallback&&(this.loadTile(Le,Le.reloadCallback),Le.reloadCallback=null)))}}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.actor&&F.actor.send("abortTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(F,Le){F.actor&&F.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class it extends F.E{constructor(Le,Oe,Fe,je){super(),this.id=Le,this.dispatcher=Fe,this.setEventedParent(je),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=F.l({type:"raster"},Oe),F.l(this,F.aA(Oe,["url","scheme","tileSize"]))}load(Le){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"})),this._tileJSONRequest=Qe(this._options,this.map._requestManager,null,null,((Oe,Fe)=>{this._tileJSONRequest=null,this._loaded=!0,Oe?this.fire(new F.z(Oe)):Fe&&(F.l(this,Fe),Fe.raster_layers&&(this.rasterLayers=Fe.raster_layers,this.rasterLayerIds=this.rasterLayers.map((F=>F.id))),Fe.bounds&&(this.tileBounds=new et(Fe.bounds,this.minzoom,this.maxzoom)),yo(Fe.tiles),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))),Le&&Le(Oe)}))}loaded(){return this._loaded}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Le=F.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(Le)))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(Le,Oe){const Fe=F.q.devicePixelRatio>=2,je=this.map._requestManager.normalizeTileURL(Le.tileID.canonical.url(this.tiles,this.scheme),Fe,this.tileSize);Le.request=F.o(this.map._requestManager.transformRequest(je,F.R.Tile),((Fe,je,qe,He)=>(delete Le.request,Le.aborted?(Le.state="unloaded",Oe(null)):Fe?(Le.state="errored",Oe(Fe)):je?(this.map._refreshExpiredTiles&&Le.setExpiryData({cacheControl:qe,expires:He}),Le.setTexture(je,this.map.painter),Le.state="loaded",F.aF(this.dispatcher),void Oe(null)):Oe(null))))}abortTile(F,Le){F.request&&(F.request.cancel(),delete F.request),Le&&Le()}unloadTile(Le,Oe){Le.texture&&Le.texture instanceof F.T?(Le.destroy(!0),Le.texture&&Le.texture instanceof F.T&&this.map.painter.saveTileTexture(Le.texture)):Le.destroy(),Oe&&Oe()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ot extends it{constructor(Le,Oe,Fe,je){super(Le,Oe,Fe,je),this.type="raster-array",this.maxzoom=22,this.partial=!0,this.iconsets={},this._options=F.l({type:"raster-array"},Oe)}triggerRepaint(F){const Le=this.map.painter._terrain,Oe=this.map.style.getSourceCache(this.id);Le&&Le.enabled&&Oe&&Le._clearRenderCacheForTile(Oe.id,F.tileID),this.map.triggerRepaint()}loadTile(Le,Oe){const Fe=this.map._requestManager.normalizeTileURL(Le.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),je=this.map._requestManager.transformRequest(Fe,F.R.Tile),qe={request:je,uid:Le.uid,tileID:Le.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};Le.source=this.id,Le.scope=this.scope,Le.requestParams=je,Le.actor||(Le.actor=this.dispatcher.getActor());const n=(Fe,je,qe,He)=>{if(delete Le.request,Le.aborted)return Le.state="unloaded",Oe(null);if(Fe){if("AbortError"===Fe.name)return;return Le.state="errored",Oe(Fe)}if(this.map._refreshExpiredTiles&&je&&Le.setExpiryData({cacheControl:qe,expires:He}),this.partial)Le.state="empty";else{if(!je)return Oe(null);Le.state="loaded",Le._isHeaderLoaded=!0,Le._mrt=je;const Fe=new Map;for(const Oe in Le._mrt.layers){const je=Le.getLayer(Oe);if(je)for(const Le of je.getBandList()){const{bytes:qe,tileSize:He,buffer:xt}=je.getBandView(Le),jt=He+2*xt,Gt={data:new F.r({width:jt,height:jt},qe),pixelRatio:2,sdf:!1,usvg:!1,version:0};Fe.set(`${Oe}/${Le}`,Gt)}}for(const F in this.iconsets)this.iconsets[F].addIcons(Fe)}Oe(null)};Le.request=this.partial?Le.fetchHeader(void 0,n.bind(this)):Le.actor.send("loadTile",qe,n.bind(this),void 0,!0)}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.actor&&F.actor.send("abortTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(Le,Oe){const Fe=Le.texture;Fe&&Fe instanceof F.T?(Le.destroy(!0),this.map.painter.saveTileTexture(Fe)):(Le.destroy(),Le.flushQueues(),Le._isHeaderLoaded=!1,delete Le._mrt,delete Le.textureDescriptor),Le.fbo&&(Le.fbo.destroy(),delete Le.fbo),delete Le.request,delete Le.requestParams,delete Le.neighboringTiles,Le.state="unloaded"}prepareTile(Le,Oe,Fe){Le._isHeaderLoaded&&("empty"!==Le.state&&(Le.state="reloading"),Le.fetchBand(Oe,Fe,((Oe,Fe)=>{if(Oe)return Le.state="errored",this.fire(new F.z(Oe)),void this.triggerRepaint(Le);Fe&&(Le._isHeaderLoaded=!0,Le.setTexture(Fe,this.map.painter),Le.state="loaded",this.triggerRepaint(Le))})))}getInitialBand(F){if(!this.rasterLayers)return 0;const Le=this.rasterLayers.find((({id:Le})=>Le===F)),Oe=Le&&Le.fields,Fe=Oe&&Oe.bands&&Oe.bands;return Fe?Fe[0]:0}getTextureDescriptor(Le,Oe,Fe){if(!Le)return;const je=Oe.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!je)return;let qe=null;Oe instanceof F.aI?qe=Oe.paint.get("raster-array-band"):Oe instanceof F.aJ&&(qe=Oe.paint.get("raster-particle-array-band"));const He=qe||this.getInitialBand(je);if(null!=He)if(Le.textureDescriptor){if(!Le.updateNeeded(je,He)||Fe)return Object.assign({},Le.textureDescriptor,{texture:Le.texture})}else this.prepareTile(Le,je,He)}addIconset(F,Le){this.iconsets[F]=Le,this.partial=!1}}const xc={vector:tt,raster:it,"raster-dem":class extends it{constructor(Le,Oe,Fe,je){super(Le,Oe,Fe,je),this.type="raster-dem",this.maxzoom=22,this._options=F.l({type:"raster-dem"},Oe),this.encoding=Oe.encoding||"mapbox"}loadTile(Le,Oe){const Fe=this.map._requestManager.normalizeTileURL(Le.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function s(F,Fe){F&&(Le.state="errored",Oe(F)),Fe&&(Le.dem=Fe,Le.dem.onDeserialize(),Le.needsHillshadePrepare=!0,Le.needsDEMTextureUpload=!0,Le.state="loaded",Oe(null))}Le.request=F.o(this.map._requestManager.transformRequest(Fe,F.R.Tile),function(Fe,je,qe,He){if(delete Le.request,Le.aborted)Le.state="unloaded",Oe(null);else if(Fe)Le.state="errored",Oe(Fe);else if(je){this.map._refreshExpiredTiles&&Le.setExpiryData({cacheControl:qe,expires:He});const Oe=ImageBitmap&&je instanceof ImageBitmap&&F.t(),Fe=1-(je.width-F.aG(je.width))/2;Fe<1||Le.neighboringTiles||(Le.neighboringTiles=this._getNeighboringTiles(Le.tileID));const xt=Oe?je:F.q.getImageData(je,Fe),jt={uid:Le.uid,tileID:Le.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:xt,encoding:this.encoding,padding:Fe};Le.actor&&"expired"!==Le.state||(Le.actor=this.dispatcher.getActor(),Le.actor.send("loadTile",jt,s.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(Le){const Oe=Le.canonical,Fe=Math.pow(2,Oe.z),je=(Oe.x-1+Fe)%Fe,qe=0===Oe.x?Le.wrap-1:Le.wrap,He=(Oe.x+1+Fe)%Fe,xt=Oe.x+1===Fe?Le.wrap+1:Le.wrap,jt={};return jt[new F.aH(Le.overscaledZ,qe,Oe.z,je,Oe.y).key]={backfilled:!1},jt[new F.aH(Le.overscaledZ,xt,Oe.z,He,Oe.y).key]={backfilled:!1},Oe.y>0&&(jt[new F.aH(Le.overscaledZ,qe,Oe.z,je,Oe.y-1).key]={backfilled:!1},jt[new F.aH(Le.overscaledZ,Le.wrap,Oe.z,Oe.x,Oe.y-1).key]={backfilled:!1},jt[new F.aH(Le.overscaledZ,xt,Oe.z,He,Oe.y-1).key]={backfilled:!1}),Oe.y+1<Fe&&(jt[new F.aH(Le.overscaledZ,qe,Oe.z,je,Oe.y+1).key]={backfilled:!1},jt[new F.aH(Le.overscaledZ,Le.wrap,Oe.z,Oe.x,Oe.y+1).key]={backfilled:!1},jt[new F.aH(Le.overscaledZ,xt,Oe.z,He,Oe.y+1).key]={backfilled:!1}),jt}},"raster-array":ot,geojson:class extends F.E{constructor(Le,Oe,Fe,je){super(),this.id=Le,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=Fe.getActor(),this.setEventedParent(je),this._data=Oe.data,this._options=F.l({},Oe),this._collectResourceTiming=Oe.collectResourceTiming,void 0!==Oe.maxzoom&&(this.maxzoom=Oe.maxzoom),void 0!==Oe.minzoom&&(this.minzoom=Oe.minzoom),Oe.type&&(this.type=Oe.type),Oe.attribution&&(this.attribution=Oe.attribution),this.promoteId=Oe.promoteId;const qe=F.ai/this.tileSize;this.workerOptions=F.l({source:this.id,scope:this.scope,cluster:Oe.cluster||!1,geojsonVtOptions:{buffer:(void 0!==Oe.buffer?Oe.buffer:128)*qe,tolerance:(void 0!==Oe.tolerance?Oe.tolerance:.375)*qe,extent:F.ai,maxZoom:this.maxzoom,lineMetrics:Oe.lineMetrics||!1,generateId:Oe.generateId||!1},superclusterOptions:{maxZoom:void 0!==Oe.clusterMaxZoom?Oe.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,Oe.clusterMinPoints||2),extent:F.ai,radius:(void 0!==Oe.clusterRadius?Oe.clusterRadius:50)*qe,log:!1,generateId:Oe.generateId||!1},clusterProperties:Oe.clusterProperties,filter:Oe.filter,dynamic:Oe.dynamic},Oe.workerOptions)}onAdd(F){this.map=F,this.setData(this._data)}setData(F){return this._data=F,this._updateWorkerData(),this}updateData(Le){if(!this._options.dynamic)return this.fire(new F.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof Le&&("Feature"===Le.type&&(Le={type:"FeatureCollection",features:[Le]}),"FeatureCollection"!==Le.type))return this.fire(new F.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof Le&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const F=new Map;for(const Le of this._data.features)F.set(Le.id,Le);for(const Oe of Le.features)F.set(Oe.id,Oe);this._data.features=[...F.values()]}else this._data=Le;return this._updateWorkerData(!0),this}getClusterExpansionZoom(F,Le){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:F,source:this.id,scope:this.scope},Le),this}getClusterChildren(F,Le){return this.actor.send("geojson.getClusterChildren",{clusterId:F,source:this.id,scope:this.scope},Le),this}getClusterLeaves(F,Le,Oe,Fe){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:F,limit:Le,offset:Oe},Fe),this}_updateWorkerData(Le=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new F.A("dataloading",{dataType:"source"})),this._loaded=!1;const Oe=F.l({append:Le},this.workerOptions);Oe.scope=this.scope;const Fe=this._data;"string"==typeof Fe?(Oe.request=this.map._requestManager.transformRequest(F.q.resolveURL(Fe),F.R.Source),Oe.request.collectResourceTiming=this._collectResourceTiming):Oe.data=JSON.stringify(Fe),this._pendingLoad=this.actor.send(`${this.type}.loadData`,Oe,((Oe,Fe)=>{if(this._loaded=!0,this._pendingLoad=null,Oe)this.fire(new F.z(Oe));else{const Oe={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&Fe&&Fe.resourceTiming&&Fe.resourceTiming[this.id]&&(Oe.resourceTiming=Fe.resourceTiming[this.id]),Le&&(this._partialReload=!0),this.fire(new F.A("data",Oe)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(Le),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const Le=F.C(this.id,this.scope);this.map.style.clearSource(Le),this._updateWorkerData()}loadTile(Le,Oe){const Fe=Le.actor?"reloadTile":"loadTile";Le.actor=this.actor;const je=this.map.style?this.map.style.getLut(this.scope):null,qe=je?{image:je.image.clone()}:null,He=this._partialReload,xt={type:this.type,uid:Le.uid,tileID:Le.tileID,tileZoom:Le.tileZoom,zoom:Le.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:qe,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:He};Le.request=this.actor.send(Fe,xt,((F,je)=>He&&!je?(Le.state="loaded",Oe(null)):(delete Le.request,Le.destroy(),Le.aborted?Oe(null):F?Oe(F):(Le.loadVectorData(je,this.map.painter,"reloadTile"===Fe),Oe(null)))),void 0,"loadTile"===Fe)}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.aborted=!0}unloadTile(F,Le){this.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}onRemove(F){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return F.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends F.aK{constructor(F,Le,Oe,Fe){super(F,Le,Oe,Fe),this.roundZoom=!0,this.type="video",this.options=Le}load(){this._loaded=!1;const Le=this.options;this.urls=[];for(const Oe of Le.urls)this.urls.push(this.map._requestManager.transformRequest(Oe,F.R.Source).url);F.aL(this.urls,((Le,Oe)=>{this._loaded=!0,Le?this.fire(new F.z(Le)):Oe&&(this.video=Oe,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(Le){if(this.video){const Oe=this.video.seekable;Le<Oe.start(0)||Le>Oe.end(0)?this.fire(new F.z(new F.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${Oe.start(0)} and ${Oe.end(0)}-second mark.`))):this.video.currentTime=Le}}getVideo(){return this.video}onAdd(F){this.map||(this.map=F,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const Le=this.map.painter.context,Oe=Le.gl;this.texture?this.video.paused||(this.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE),Oe.texSubImage2D(Oe.TEXTURE_2D,0,0,0,Oe.RGBA,Oe.UNSIGNED_BYTE,this.video)):(this.texture=new F.T(Le,this.video,Oe.RGBA8),this.texture.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(Le)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:F.aK,model:class extends F.E{constructor(F,Le,Oe,Fe){super(),this.id=F,this.type="model",this.models=[],this._loaded=!1,this._options=Le}load(){const Le=[];for(const Oe in this._options.models){const Fe=this._options.models[Oe],je=F.aN(this.map._requestManager.transformRequest(Fe.uri,F.R.Model).url).then((Le=>{if(!Le)return;const je=F.aO(Le),qe=new F.aP(Oe,Fe.position,Fe.orientation,je);qe.computeBoundsAndApplyParent(),this.models.push(qe)})).catch((Le=>{this.fire(new F.z(new Error(`Could not load model ${Oe} from ${Fe.uri}: ${Le.message}`)))}));Le.push(je)}return Promise.allSettled(Le).then((()=>{this._loaded=!0,this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((Le=>{this.fire(new F.z(new Error(`Could not load models: ${Le.message}`)))}))}onAdd(F){this.map=F,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(F,Le){}serialize(){return{type:"model"}}},"batched-model":class extends F.E{constructor(F,Le,Oe,Fe){super(),this.type="batched-model",this.id=F,this.tileSize=512,this._options=Le,this.tiles=this._options.tiles,this.maxzoom=Le.maxzoom||19,this.minzoom=Le.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=Oe,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(Fe)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();const Le=F.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(Le)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(Le){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"}));const Oe=Array.isArray(this.map._language)?this.map._language.join():this.map._language,Fe=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,Oe,Fe,((je,qe)=>{this._tileJSONRequest=null,this._loaded=!0,je?(Oe&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${Oe}`),Fe&&2!==Fe.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${Fe}`),this.fire(new F.z(je))):qe&&(F.l(this,qe),qe.bounds&&(this.tileBounds=new et(qe.bounds,this.minzoom,this.maxzoom)),yo(qe.tiles,this.map._requestManager._customAccessToken),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))),Le&&Le(je)}))}hasTransition(){return!1}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loaded(){return this._loaded}loadTile(Le,Oe){const Fe=this.map._requestManager.normalizeTileURL(Le.tileID.canonical.url(this.tiles,this.scheme)),je={request:this.map._requestManager.transformRequest(Fe,F.R.Tile),data:void 0,uid:Le.uid,tileID:Le.tileID,tileZoom:Le.tileZoom,zoom:Le.tileID.overscaledZ,tileSize:this.tileSize*Le.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:Le.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:F.q.devicePixelRatio,promoteId:this.promoteId};if(Le.actor&&"expired"!==Le.state)if("loading"===Le.state)Le.reloadCallback=Oe;else{if(Le.buckets){const F=Object.values(Le.buckets);for(const Le of F)Le.dirty=!0;return void(Le.state="loaded")}Le.request=Le.actor.send("reloadTile",je,r.bind(this))}else Le.actor=this.dispatcher.getActor(),Le.request=Le.actor.send("loadTile",je,r.bind(this),void 0,!0);function r(F,Fe){return Le.aborted?Oe(null):F&&404!==F.status?Oe(F):(this.map._refreshExpiredTiles&&Fe&&Le.setExpiryData(Fe),Le.loadModelData(Fe,this.map.painter),Le.state="loaded",void Oe(null))}}serialize(){return F.l({},this._options)}},canvas:class extends F.aK{constructor(Le,Oe,Fe,je){super(Le,Oe,Fe,je),Oe.coordinates?Array.isArray(Oe.coordinates)&&4===Oe.coordinates.length&&!Oe.coordinates.some((F=>!Array.isArray(F)||2!==F.length||F.some((F=>"number"!=typeof F))))||this.fire(new F.z(new F.V(`sources.${Le}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new F.z(new F.V(`sources.${Le}`,null,'missing required property "coordinates"'))),Oe.animate&&"boolean"!=typeof Oe.animate&&this.fire(new F.z(new F.V(`sources.${Le}`,null,'optional "animate" property must be a boolean value'))),Oe.canvas?"string"==typeof Oe.canvas||Oe.canvas instanceof HTMLCanvasElement||this.fire(new F.z(new F.V(`sources.${Le}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new F.z(new F.V(`sources.${Le}`,null,'missing required property "canvas"'))),this.options=Oe,this.animate=void 0===Oe.animate||Oe.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new F.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(F){this.map=F,this.load(),this.canvas&&this.animate&&this.play()}onRemove(F){this.pause()}prepare(){let Le=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,Le=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,Le=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const Oe=this.map.painter.context;this.texture?!Le&&!this._playing||this.texture instanceof F.aM||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new F.T(Oe,this.canvas,Oe.gl.RGBA8,{premultiply:!0}),this._prepareData(Oe)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const F of[this.canvas.width,this.canvas.height])if(isNaN(F)||F<=0)return!0;return!1}},custom:class extends F.E{constructor(Le,Oe,Fe,je){super(),this.id=Le,this.type="custom",this._dataType="raster",this._dispatcher=Fe,this._implementation=Oe,this.setEventedParent(je),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new F.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new F.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new et(this._implementation.bounds,this.minzoom,this.maxzoom)),Oe.update=this._update.bind(this),Oe.clearTiles=this._clearTiles.bind(this),Oe.coveringTiles=this._coveringTiles.bind(this),F.l(this,F.aA(Oe,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return F.aA(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(Le){this.map=Le,this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(Le),this.load()}onRemove(F){this._implementation.onRemove&&this._implementation.onRemove(F)}hasTile(F){if(this._implementation.hasTile){const{x:Le,y:Oe,z:Fe}=F.canonical;return this._implementation.hasTile({x:Le,y:Oe,z:Fe})}return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(F,Le){const{x:Oe,y:Fe,z:je}=F.tileID.canonical,qe=new AbortController;F.request=Promise.resolve(this._implementation.loadTile({x:Oe,y:Fe,z:je},{signal:qe.signal})).then(function(Oe){return delete F.request,F.aborted?(F.state="unloaded",Le(null)):void 0===Oe?(F.state="errored",Le(null)):null===Oe?(this.loadTileData(F,{width:this.tileSize,height:this.tileSize,data:null}),F.state="loaded",Le(null)):function(F){return F instanceof ImageData||F instanceof HTMLCanvasElement||F instanceof ImageBitmap||F instanceof HTMLImageElement}(Oe)?(this.loadTileData(F,Oe),F.state="loaded",void Le(null)):(F.state="errored",Le(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((Oe=>{"AbortError"!==Oe.name&&(F.state="errored",Le(Oe))})),F.request.cancel=()=>qe.abort()}loadTileData(F,Le){F.setTexture(Le,this.map.painter)}unloadTile(Le,Oe){if(Le.texture&&Le.texture instanceof F.T?(Le.destroy(!0),Le.texture&&Le.texture instanceof F.T&&this.map.painter.saveTileTexture(Le.texture)):Le.destroy(),this._implementation.unloadTile){const{x:F,y:Oe,z:Fe}=Le.tileID.canonical;this._implementation.unloadTile({x:F,y:Oe,z:Fe})}Oe&&Oe()}abortTile(F,Le){F.request&&F.request.cancel&&(F.request.cancel(),delete F.request),Le&&Le()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((F=>({x:F.canonical.x,y:F.canonical.y,z:F.canonical.z})))}_clearTiles(){const Le=F.C(this.id,this.scope);this.map.style.clearSource(Le)}_update(){this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}}},rt=function(Le,Oe,Fe,je){const qe=new xc[Oe.type](Le,Oe,Fe,je);if(qe.id!==Le)throw new Error(`Expected Source id to be ${Le} instead of ${qe.id}`);return F.aQ(["load","abort","unload","serialize","prepare"],qe),qe};function nt(F,Le,Oe=""){return`${Oe}:${Le.id||""}:${Le.layer.id}:${function(F){if("layerId"in F)return`layer:${F.layerId}`;{const{featuresetId:Le,importId:Oe}=F;return`featureset:${Le}${Oe?`:import:${Oe}`:""}`}}(F.target)}`}function at(F,Le,Oe,Fe=""){if(F.uniqueFeatureID){const je=nt(F,Le,Fe);if(Oe.has(je))return!0;Oe.add(je)}return!1}function lt(F,Le,Oe,Fe,je=!1){const qe=Le.sourceCache.transform,He=Le.sourceCache.tilesIn(F,Le.has3DLayers,je);He.sort(dt);const xt=[];for(const F of He){const He=F.tile.queryRenderedFeatures(Le,F,Oe,Fe,qe,je);Object.keys(He).length&&xt.push({wrappedTileID:F.tile.tileID.wrapped().key,queryResults:He})}return 0===xt.length?{}:function(F){const Le={},Oe={};for(const Fe of F){const F=Fe.queryResults,je=Fe.wrappedTileID,qe=Oe[je]=Oe[je]||{};for(const Oe in F){const Fe=F[Oe],je=qe[Oe]=qe[Oe]||{},He=Le[Oe]=Le[Oe]||[];for(const F of Fe)je[F.featureIndex]||(je[F.featureIndex]=!0,He.push(F))}}return Le}(xt)}function ct(F,Le,Oe,Fe,je){const qe={},He=Fe.queryRenderedSymbols(F),xt=[];for(const F of Object.keys(He).map(Number))xt.push(je[F]);xt.sort(dt);for(const F of xt){const Fe=F.featureIndex.lookupSymbolFeatures(He[F.bucketInstanceId],F.bucketIndex,F.sourceLayerIndex,Le,Oe);for(const Le in Fe){const Oe=qe[Le]=qe[Le]||[],je=Fe[Le];je.sort(((Le,Oe)=>{const Fe=F.featureSortOrder;if(Fe){const F=Fe.indexOf(Le.featureIndex);return Fe.indexOf(Oe.featureIndex)-F}return Oe.featureIndex-Le.featureIndex}));for(const F of je)Oe.push(F)}}return qe}function ht(F,Le){const Oe=F.getRenderableIds().map((Le=>F.getTileByID(Le))),Fe=[],je={};for(let F=0;F<Oe.length;F++){const qe=Oe[F],He=qe.tileID.canonical.key;je[He]||(je[He]=!0,qe.querySourceFeatures(Fe,Le))}return Fe}function dt(F,Le){const Oe=F.tileID,Fe=Le.tileID;return Oe.overscaledZ-Fe.overscaledZ||Oe.canonical.y-Fe.canonical.y||Oe.wrap-Fe.wrap||Oe.canonical.x-Fe.canonical.x}function ut(F,Le){const Oe={};if(!Le)return Oe;for(const Fe of F){const F=Fe.layerIds.map((F=>Le.getLayer(F))).filter(Boolean);if(0!==F.length){Fe.layers=F,Fe.stateDependentLayerIds&&(Fe.stateDependentLayers=Fe.stateDependentLayerIds.map((Le=>F.filter((F=>F.id===Le))[0])));for(const Le of F)Oe[Le.fqid]=Fe}}return Oe}const Zc=32,Wc=33,Kc=new Uint16Array(8184);for(let F=0;F<2046;F++){let Le=F+2,Oe=0,Fe=0,je=0,qe=0,He=0,xt=0;for(1&Le?je=qe=He=Zc:Oe=Fe=xt=Zc;(Le>>=1)>1;){const F=Oe+je>>1,jt=Fe+qe>>1;1&Le?(je=Oe,qe=Fe,Oe=He,Fe=xt):(Oe=je,Fe=qe,je=He,qe=xt),He=F,xt=jt}const jt=4*F;Kc[jt+0]=Oe,Kc[jt+1]=Fe,Kc[jt+2]=je,Kc[jt+3]=qe}const Jc=new Uint16Array(2178),Qc=new Uint8Array(1089),eh=new Uint16Array(1089);function yt(F){return 0===F?-.03125:32===F?.03125:0}const th=(()=>({type:2,extent:F.ai,loadGeometry:()=>[[new F.P(0,0),new F.P(F.ai+1,0),new F.P(F.ai+1,F.ai+1),new F.P(0,F.ai+1),new F.P(0,0)]]}))();class bt{constructor(Le,Oe,Fe,je,qe){this.tileID=Le,this.uid=F.aW(),this.uses=0,this.tileSize=Oe,this.tileZoom=Fe,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=qe,je&&je.style&&(this._lastUpdatedBrightness=je.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",je&&je.transform&&(this.projection=je.transform.projection)}registerFadeDuration(Le){const Oe=Le+this.timeAdded;Oe<F.q.now()||this.fadeEndTime&&Oe<this.fadeEndTime||(this.fadeEndTime=Oe)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=F.aR(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(Le,Oe,Fe){if(this.unloadVectorData(),this.state="loaded",Le){Le.featureIndex&&(this.latestFeatureIndex=Le.featureIndex,Le.rawTileData?(this.latestRawTileData=Le.rawTileData,this.latestFeatureIndex.rawTileData=Le.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=Le.collisionBoxArray,this.buckets=ut(Le.buckets,Oe.style),this.hasSymbolBuckets=!1;for(const Le in this.buckets){const Oe=this.buckets[Le];if(Oe instanceof F.aY){if(this.hasSymbolBuckets=!0,!Fe)break;Oe.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const Le in this.buckets){const Oe=this.buckets[Le];if(Oe instanceof F.aY&&Oe.hasRTLText){this.hasRTLText=!0,F.aZ();break}}this.queryPadding=0;for(const F in this.buckets){const Le=this.buckets[F],Fe=Oe.style.getOwnLayer(F);if(!Fe)continue;const je=Fe.queryRadius(Le);this.queryPadding=Math.max(this.queryPadding,je)}Le.imageAtlas&&(this.imageAtlas=Le.imageAtlas),Le.glyphAtlasImage&&(this.glyphAtlasImage=Le.glyphAtlasImage),Le.lineAtlas&&(this.lineAtlas=Le.lineAtlas),this._lastUpdatedBrightness=Le.brightness}else this.collisionBoxArray=new F.aX}unloadVectorData(){if(this.hasData()){for(const F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(F,Le,Oe){F&&(F.resourceTiming&&(this.resourceTiming=F.resourceTiming),this.buckets=Object.assign({},this.buckets,ut(F.buckets,Le.style)),F.featureIndex&&(this.latestFeatureIndex=F.featureIndex))}getBucket(F){return this.buckets[F.fqid]}upload(Le){for(const F in this.buckets){const Oe=this.buckets[F];Oe.uploadPending()&&Oe.upload(Le)}const Oe=Le.gl,Fe=this.imageAtlas;Fe&&!Fe.uploaded&&(this.imageAtlasTexture=new F.T(Le,Fe.image,Oe.RGBA8,{useMipmap:!!Fe.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new F.T(Le,this.glyphAtlasImage,Oe.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new F.T(Le,this.lineAtlas.image,Oe.R8),this.lineAtlas.uploaded=!0)}prepare(F,Le,Oe){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(F,this.imageAtlasTexture,Oe),!Le||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const Fe=Le.style.getBrightness();(this._lastUpdatedBrightness||Fe)&&(this._lastUpdatedBrightness&&Fe&&Math.abs(this._lastUpdatedBrightness-Fe)<.001||(this.updateBuckets(Le,this._lastUpdatedBrightness!==Fe),this._lastUpdatedBrightness=Fe))}queryRenderedFeatures(Le,Oe,Fe,je,qe,He){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const xt=function(Le,Oe){const Fe=F.ad.mat4.fromScaling([],[.5*Le.width,.5*-Le.height,1]);return F.ad.mat4.translate(Fe,Fe,[1,-1,0]),F.ad.mat4.multiply(Fe,Fe,Le.calculateProjMatrix(Oe.toUnwrapped())),Float32Array.from(Fe)}(qe,this.tileID);return this.latestFeatureIndex.query(Le,{tilespaceGeometry:Oe,pixelPosMatrix:xt,transform:je,availableImages:Fe,tileTransform:this.tileTransform})}querySourceFeatures(Le,Oe){const Fe=this.latestFeatureIndex;if(!Fe||!Fe.rawTileData)return;const je=Fe.loadVTLayers(),qe=Oe?Oe.sourceLayer:"",He=je._geojsonTileLayer||je[qe];if(!He)return;const xt=F.a_(Oe&&Oe.filter),{z:jt,x:Gt,y:bi}=this.tileID.canonical,wi={z:jt,x:Gt,y:bi};for(let Oe=0;Oe<He.length;Oe++){const je=He.feature(Oe);if(xt.needGeometry){const Le=F.a$(je,!0);if(!xt.filter(new F.aa(this.tileID.overscaledZ),Le,this.tileID.canonical))continue}else if(!xt.filter(new F.aa(this.tileID.overscaledZ),je))continue;const qr=Fe.getId(je,qe),Xn=new F.b0(je,jt,Gt,bi,qr);Xn.tile=wi,Le.push(Xn)}}loaded(){return"loaded"===this.state||"errored"===this.state}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(Le){const Oe=this.expirationTime;if(Le.cacheControl){const Oe=F.b1(Le.cacheControl);Oe["max-age"]&&(this.expirationTime=Date.now()+1e3*Oe["max-age"])}else Le.expires&&(this.expirationTime=new Date(Le.expires).getTime());if(this.expirationTime){const F=Date.now();let Le=!1;if(this.expirationTime>F)Le=!1;else if(Oe)if(this.expirationTime<Oe)Le=!0;else{const Fe=this.expirationTime-Oe;Fe?this.expirationTime=F+Math.max(Fe,3e4):Le=!0}else Le=!0;Le?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(F){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&F&&this.updateBuckets(F)}updateBuckets(Le,Oe){if(!this.latestFeatureIndex)return;if(!Le.style)return;const Fe=this.latestFeatureIndex.loadVTLayers(),je=Le.style.listImages(),qe=Le.style.getBrightness();for(const He in this.buckets){if(!Le.style.hasLayer(He))continue;const xt=this.buckets[He],jt=xt.layers[0],Gt=jt.sourceLayer||"_geojsonTileLayer",bi=Fe[Gt],wi=Le.style.getLayerSourceCache(jt);let qr={};wi&&(qr=wi._state.getState(Gt,void 0));const Xn=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},Yn=Object.keys(qr).length>0&&!Oe;Yn&&!xt.stateDependentLayers.length&&!Oe||xt.update(qr,bi,je,Xn,Yn?xt.stateDependentLayers:xt.layers,Oe,qe),(xt instanceof F.b2||xt instanceof F.b3)&&Le._terrain&&Le._terrain.enabled&&wi&&xt.uploadPending()&&Le._terrain._clearRenderCacheForTile(wi.id,this.tileID);const yo=Le&&Le.style&&Le.style.getOwnLayer(He);yo&&(this.queryPadding=Math.max(this.queryPadding,yo.queryRadius(xt)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<F.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(Le){this.symbolFadeHoldUntil=F.q.now()+Le}setTexture(Le,Oe){const Fe=Oe.context,je=Fe.gl;this.texture=this.texture||Oe.getTileTexture(Le.width),this.texture&&this.texture instanceof F.T?this.texture.update(Le):(this.texture=new F.T(Fe,Le,je.RGBA8,{useMipmap:!0}),this.texture.bind(je.LINEAR,je.CLAMP_TO_EDGE))}setDependencies(F,Le){const Oe={};for(const F of Le)Oe[F]=!0;this.dependencies[F]=Oe}hasDependency(F,Le){for(const Oe of F){const F=this.dependencies[Oe];if(F)for(const Oe of Le)if(F[Oe])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(Le,Oe){if(!Oe||"mercator"===Oe.name||this._tileDebugBuffer)return;const Fe=F.b4(th,this.tileID.canonical,this.tileTransform)[0],je=new F.b5,qe=new F.b6;for(let F=0;F<Fe.length;F++){const{x:Le,y:Oe}=Fe[F];je.emplaceBack(Le,Oe),qe.emplaceBack(F)}qe.emplaceBack(0),this._tileDebugIndexBuffer=Le.createIndexBuffer(qe),this._tileDebugBuffer=Le.createVertexBuffer(je,F.b7.members),this._tileDebugSegments=F.b8.simpleSegment(0,0,je.length,qe.length)}_makeTileBoundsBuffers(Le,Oe){if(this._tileBoundsBuffer||!Oe||"mercator"===Oe.name)return;const Fe=F.b4(th,this.tileID.canonical,this.tileTransform)[0];let je,qe;if(this.isRaster){const Le=function(Le,Oe){const Fe=F.aR(Le,Oe),je=Math.pow(2,Le.z);for(let qe=0;qe<Wc;qe++)for(let He=0;He<Wc;He++){const xt=F.aS((Le.x+(He+yt(He))/Zc)/je),jt=F.aT((Le.y+(qe+yt(qe))/Zc)/je),Gt=Oe.project(xt,jt),bi=qe*Wc+He;Jc[2*bi+0]=Math.round((Gt.x*Fe.scale-Fe.x)*F.ai),Jc[2*bi+1]=Math.round((Gt.y*Fe.scale-Fe.y)*F.ai)}Qc.fill(0),eh.fill(0);for(let F=2045;F>=0;F--){const Le=4*F,Oe=Kc[Le+0],Fe=Kc[Le+1],je=Kc[Le+2],qe=Kc[Le+3],He=Oe+je>>1,xt=Fe+qe>>1,jt=He+xt-Fe,Gt=xt+Oe-He,bi=Fe*Wc+Oe,wi=qe*Wc+je,qr=xt*Wc+He,Xn=Math.hypot((Jc[2*bi+0]+Jc[2*wi+0])/2-Jc[2*qr+0],(Jc[2*bi+1]+Jc[2*wi+1])/2-Jc[2*qr+1])>=16;Qc[qr]=Qc[qr]||(Xn?1:0),F<1022&&(Qc[qr]=Qc[qr]||Qc[(Fe+Gt>>1)*Wc+(Oe+jt>>1)]||Qc[(qe+Gt>>1)*Wc+(je+jt>>1)])}const qe=new F.aU,He=new F.aV;let xt=0;function l(Le,Oe){const Fe=Oe*Wc+Le;return 0===eh[Fe]&&(qe.emplaceBack(Jc[2*Fe+0],Jc[2*Fe+1],Le*F.ai/Zc,Oe*F.ai/Zc),eh[Fe]=++xt),eh[Fe]-1}function c(F,Le,Oe,Fe,je,qe){const xt=F+Oe>>1,jt=Le+Fe>>1;if(Math.abs(F-je)+Math.abs(Le-qe)>1&&Qc[jt*Wc+xt])c(je,qe,F,Le,xt,jt),c(Oe,Fe,je,qe,xt,jt);else{const xt=l(F,Le),jt=l(Oe,Fe),Gt=l(je,qe);He.emplaceBack(xt,jt,Gt)}}return c(0,0,Zc,Zc,Zc,0),c(Zc,Zc,0,0,0,Zc),{vertices:qe,indices:He}}(this.tileID.canonical,Oe);je=Le.vertices,qe=Le.indices}else{je=new F.aU,qe=new F.aV;for(const{x:F,y:Le}of Fe)je.emplaceBack(F,Le,0,0);const Le=F.b9(je.int16,void 0,4);for(let F=0;F<Le.length;F+=3)qe.emplaceBack(Le[F],Le[F+1],Le[F+2])}this._tileBoundsBuffer=Le.createVertexBuffer(je,F.ba.members),this._tileBoundsIndexBuffer=Le.createIndexBuffer(qe),this._tileBoundsSegments=F.b8.simpleSegment(0,0,je.length,qe.length)}_makeGlobeTileDebugBuffers(Le,Oe){const Fe=Oe.projection;if(!Fe||"globe"!==Fe.name||Oe.freezeTileCoverage)return;const je=this.tileID.canonical,qe=F.bb(je,Oe),He=F.bc(qe),xt=F.ag(Oe.zoom);let jt;xt>0&&(jt=F.ad.mat4.invert(new Float64Array(16),Oe.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(Le,je,Oe,He,jt,xt),this._makeGlobeTileDebugTextBuffer(Le,je,Oe,He,jt,xt)}_globePoint(Le,Oe,Fe,je,qe,He,xt){let jt=F.bd(Le,Oe,Fe);if(He){const qe=1<<Fe.z,Gt=F.av(je.center.lng),bi=F.aC(je.center.lat),wi=(Fe.x+.5)/qe-Gt;let qr=0;wi>.5?qr=-1:wi<-.5&&(qr=1);let Xn=(Le/F.ai+Fe.x)/qe+qr,Yn=(Oe/F.ai+Fe.y)/qe;Xn=(Xn-Gt)*je._pixelsPerMercatorPixel+Gt,Yn=(Yn-bi)*je._pixelsPerMercatorPixel+bi;const yo=[Xn*je.worldSize,Yn*je.worldSize,0];F.ad.vec3.transformMat4(yo,yo,He),jt=F.be(jt,yo,xt)}return F.ad.vec3.transformMat4(jt,jt,qe)}_makeGlobeTileDebugBorderBuffer(Le,Oe,Fe,je,qe,He){const xt=new F.b5,jt=new F.b6,Gt=new F.bf,h=(F,Le,bi,wi,qr)=>{const Xn=(bi-F)/(qr-1),Yn=(wi-Le)/(qr-1),yo=xt.length;for(let bi=0;bi<qr;bi++){const wi=F+bi*Xn,qr=Le+bi*Yn;xt.emplaceBack(wi,qr);const bo=this._globePoint(wi,qr,Oe,Fe,je,qe,He);Gt.emplaceBack(bo[0],bo[1],bo[2]),jt.emplaceBack(yo+bi)}},bi=F.ai;h(0,0,bi,0,16),h(bi,0,bi,bi,16),h(bi,bi,0,bi,16),h(0,bi,0,0,16),this._tileDebugIndexBuffer=Le.createIndexBuffer(jt),this._tileDebugBuffer=Le.createVertexBuffer(xt,F.b7.members),this._globeTileDebugBorderBuffer=Le.createVertexBuffer(Gt,F.bg.members),this._tileDebugSegments=F.b8.simpleSegment(0,0,xt.length,jt.length)}_makeGlobeTileDebugTextBuffer(Le,Oe,Fe,je,qe,He){const xt=F.ai/4,jt=new F.b5,Gt=new F.aV,bi=new F.bf,wi=25;Gt.reserve(32),jt.reserve(wi),bi.reserve(wi);const u=(F,Le)=>wi*F+Le;for(let F=0;F<wi;F++){const Le=F*xt;for(let F=0;F<wi;F++){const Gt=F*xt;jt.emplaceBack(Gt,Le);const wi=this._globePoint(Gt,Le,Oe,Fe,je,qe,He);bi.emplaceBack(wi[0],wi[1],wi[2])}}for(let F=0;F<4;F++)for(let Le=0;Le<4;Le++){const Oe=u(F,Le),Fe=u(F,Le+1),je=u(F+1,Le),qe=u(F+1,Le+1);Gt.emplaceBack(Oe,Fe,je),Gt.emplaceBack(je,Fe,qe)}this._tileDebugTextIndexBuffer=Le.createIndexBuffer(Gt),this._tileDebugTextBuffer=Le.createVertexBuffer(jt,F.b7.members),this._globeTileDebugTextBuffer=Le.createVertexBuffer(bi,F.bg.members),this._tileDebugTextSegments=F.b8.simpleSegment(0,0,wi,32)}destroy(Le=!1){for(const F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!Le&&this.texture&&this.texture instanceof F.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}F.bh.setPbf(F.bi);class wt extends bt{constructor(F,Le,Oe,Fe,je){super(F,Le,Oe,Fe,je),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(F){return this._mrt&&this._mrt.getLayer(F)}setTexture(Le,Oe){const Fe=Oe.context,je=Fe.gl;this.texture=this.texture||Oe.getTileTexture(Le.width),this.texture&&this.texture instanceof F.T?this.texture.update(Le,{premultiply:!1}):this.texture=new F.T(Fe,Le,je.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(Le=16384,Oe){const Fe=this._mrt=new F.bh(30),je=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(Le-1)}});return this.entireBuffer=null,this.request=F.bj(je,((F,je,qe,He)=>{if(F)Oe(F);else try{const F=Fe.getHeaderLength(je);if(F>Le)return void(this.request=this.fetchHeader(F,Oe));Fe.parseHeader(je),this._isHeaderLoaded=!0;let xt=0;for(const F of Object.values(Fe.layers))xt=Math.max(xt,F.dataIndex[F.dataIndex.length-1].lastByte);je.byteLength>=xt&&(this.entireBuffer=je),Oe(null,this.entireBuffer||je,qe,He)}catch(F){Oe(F)}})),this.request}fetchBand(Le,Oe,Fe){const je=this._mrt;if(!this._isHeaderLoaded||!je)return void Fe(new Error("Tile header is not ready"));const qe=this.actor;if(!qe)return void Fe(new Error("Can't fetch tile band without an actor"));let He;const a=(F,je)=>{He.complete(F,je),F?Fe(F):(this.updateTextureDescriptor(Le,Oe),Fe(null,this.textureDescriptor&&this.textureDescriptor.img))},l=(F,Le)=>{if(F)return Fe(F);const Oe=qe.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:Le,task:He},a,void 0,!0);this._workQueue.push((()=>{Oe&&Oe.cancel(),He.cancel()}))},xt=je.getLayer(Le);if(!xt)return void Fe(new Error(`Unknown sourceLayer "${Le}"`));if(xt.hasDataForBand(Oe))return this.updateTextureDescriptor(Le,Oe),void Fe(null,this.textureDescriptor?this.textureDescriptor.img:null);const jt=xt.getDataRange([Oe]);if(He=je.createDecodingTask(jt),!He||He.tasks.length)if(this.flushQueues(),this.entireBuffer)l(null,this.entireBuffer.slice(jt.firstByte,jt.lastByte+1));else{const Le=Object.assign({},this.requestParams,{headers:{Range:`bytes=${jt.firstByte}-${jt.lastByte}`}}),Oe=F.bj(Le,l);this._fetchQueue.push((()=>{Oe.cancel(),He.cancel()}))}else Fe(null)}updateNeeded(F,Le){return(!this.textureDescriptor||this.textureDescriptor.band!==Le||this.textureDescriptor.layer!==F)&&"errored"!==this.state}updateTextureDescriptor(Le,Oe){if(!this._mrt)return;const Fe=this._mrt.getLayer(Le);if(!Fe||!Fe.hasBand(Oe)||!Fe.hasDataForBand(Oe))return;const{bytes:je,tileSize:qe,buffer:He,offset:xt,scale:jt}=Fe.getBandView(Oe),Gt=qe+2*He,bi=new F.r({width:Gt,height:Gt},je),wi=this.texture;wi&&wi instanceof F.T&&wi.update(bi,{premultiply:!1}),this.textureDescriptor={layer:Le,band:Oe,img:bi,buffer:He,offset:xt,tileSize:qe,format:Fe.pixelFormat,mix:[jt,256*jt,65536*jt,16777216*jt]}}}class Tt{constructor(F,Le){this.max=F,this.onRemove=Le,this.reset()}reset(){for(const F in this.data)for(const Le of this.data[F])Le.timeout&&clearTimeout(Le.timeout),this.onRemove(Le.value);return this.data={},this.order=[],this}add(F,Le,Oe){const Fe=F.wrapped().key;void 0===this.data[Fe]&&(this.data[Fe]=[]);const je={value:Le,timeout:void 0};if(void 0!==Oe&&(je.timeout=setTimeout((()=>{this.remove(F,je)}),Oe)),this.data[Fe].push(je),this.order.push(Fe),this.order.length>this.max){const F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}has(F){return F.wrapped().key in this.data}getAndRemove(F){return this.has(F)?this._getAndRemoveByKey(F.wrapped().key):null}_getAndRemoveByKey(F){const Le=this.data[F].shift();return Le.timeout&&clearTimeout(Le.timeout),0===this.data[F].length&&delete this.data[F],this.order.splice(this.order.indexOf(F),1),Le.value}getByKey(F){const Le=this.data[F];return Le?Le[0].value:null}get(F){return this.has(F)?this.data[F.wrapped().key][0].value:null}remove(F,Le){if(!this.has(F))return this;const Oe=F.wrapped().key,Fe=void 0===Le?0:this.data[Oe].indexOf(Le),je=this.data[Oe][Fe];return this.data[Oe].splice(Fe,1),je.timeout&&clearTimeout(je.timeout),0===this.data[Oe].length&&delete this.data[Oe],this.onRemove(je.value),this.order.splice(this.order.indexOf(Oe),1),this}setMaxSize(F){for(this.max=F;this.order.length>this.max;){const F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}filter(F){const Le=[];for(const Oe in this.data)for(const Fe of this.data[Oe])F(Fe.value)||Le.push(Fe);for(const F of Le)this.remove(F.value.tileID,F)}}class Et{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(Le,Oe,Fe){const je=String(Oe);if(this.stateChanges[Le]=this.stateChanges[Le]||{},this.stateChanges[Le][je]=this.stateChanges[Le][je]||{},F.l(this.stateChanges[Le][je],Fe),null===this.deletedStates[Le]){this.deletedStates[Le]={};for(const F in this.state[Le])F!==je&&(this.deletedStates[Le][F]=null)}else if(this.deletedStates[Le]&&null===this.deletedStates[Le][je]){this.deletedStates[Le][je]={};for(const F in this.state[Le][je])Fe[F]||(this.deletedStates[Le][je][F]=null)}else for(const F in Fe)this.deletedStates[Le]&&this.deletedStates[Le][je]&&null===this.deletedStates[Le][je][F]&&delete this.deletedStates[Le][je][F]}removeFeatureState(F,Le,Oe){if(null===this.deletedStates[F])return;const Fe=String(Le);if(this.deletedStates[F]=this.deletedStates[F]||{},Oe&&void 0!==Le)null!==this.deletedStates[F][Fe]&&(this.deletedStates[F][Fe]=this.deletedStates[F][Fe]||{},this.deletedStates[F][Fe][Oe]=null);else if(void 0!==Le)if(this.stateChanges[F]&&this.stateChanges[F][Fe])for(Oe in this.deletedStates[F][Fe]={},this.stateChanges[F][Fe])this.deletedStates[F][Fe][Oe]=null;else this.deletedStates[F][Fe]=null;else this.deletedStates[F]=null}getState(Le,Oe){const Fe=this.state[Le]||{},je=this.stateChanges[Le]||{},qe=this.deletedStates[Le];if(null===qe)return{};if(void 0!==Oe){const Le=String(Oe),He=F.l({},Fe[Le],je[Le]);if(qe){const F=qe[Oe];if(null===F)return{};for(const Le in F)delete He[Le]}return He}const He=F.l({},Fe,je);if(qe)for(const F in qe)delete He[F];return He}initializeTileState(F,Le){F.refreshFeatureState(Le)}coalesceChanges(Le,Oe){const Fe={};for(const Le in this.stateChanges){this.state[Le]=this.state[Le]||{};const Oe={};for(const Fe in this.stateChanges[Le])this.state[Le][Fe]||(this.state[Le][Fe]={}),F.l(this.state[Le][Fe],this.stateChanges[Le][Fe]),Oe[Fe]=this.state[Le][Fe];Fe[Le]=Oe}for(const Le in this.deletedStates){this.state[Le]=this.state[Le]||{};const Oe={};if(null===this.deletedStates[Le])for(const F in this.state[Le])Oe[F]={},this.state[Le][F]={};else for(const F in this.deletedStates[Le]){if(null===this.deletedStates[Le][F])this.state[Le][F]={};else if(this.state[Le][F])for(const Oe of Object.keys(this.deletedStates[Le][F]))delete this.state[Le][F][Oe];Oe[F]=this.state[Le][F]}Fe[Le]=Fe[Le]||{},F.l(Fe[Le],Oe)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(Fe).length)for(const F in Le)Le[F].refreshFeatureState(Oe)}}class St extends F.E{constructor(F,Le,Oe){super(),this.id=F,this._onlySymbols=Oe,Le.on("data",(F=>{"source"===F.dataType&&"metadata"===F.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===F.dataType&&"content"===F.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),Le.on("error",(()=>{this._sourceErrored=!0})),this._source=Le,this._tiles={},this._cache=new Tt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=Le.minTileCacheSize,this._maxTileCacheSize=Le.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Et,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(F){this.map=F,this._minTileCacheSize=void 0===this._minTileCacheSize&&F?F._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&F?F._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const F in this._tiles)if(!this._tiles[F].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const F=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,F&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(F,Le){return F.isSymbolTile=this._onlySymbols,F.isExtraShadowCaster=this._shadowCasterTiles[F.tileID.key],this._source.loadTile(F,Le)}_unloadTile(F){if(this._source.unloadTile)return this._source.unloadTile(F)}_abortTile(F){if(this._source.abortTile)return this._source.abortTile(F)}serialize(){return this._source.serialize()}prepare(F){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const Le in this._tiles){const Oe=this._tiles[Le];Oe.upload(F),Oe.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((F=>F.tileID)).sort(Ct).map((F=>F.key))}getRenderableIds(Le,Oe){const Fe=[];for(const F in this._tiles)this._isIdRenderable(+F,Le,Oe)&&Fe.push(this._tiles[F]);return Le?Fe.sort(((Le,Oe)=>{const Fe=Le.tileID,je=Oe.tileID,qe=new F.P(Fe.canonical.x,Fe.canonical.y)._rotate(this.transform.angle),He=new F.P(je.canonical.x,je.canonical.y)._rotate(this.transform.angle);return Fe.overscaledZ-je.overscaledZ||He.y-qe.y||He.x-qe.x})).map((F=>F.tileID.key)):Fe.map((F=>F.tileID)).sort(Ct).map((F=>F.key))}hasRenderableParent(F){const Le=this.findLoadedParent(F,0);return!!Le&&this._isIdRenderable(Le.tileID.key)}_isIdRenderable(F,Le,Oe){return this._tiles[F]&&this._tiles[F].hasData()&&!this._coveredTiles[F]&&(Le||!this._tiles[F].holdingForFade())&&(Oe||!this._shadowCasterTiles[F])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const F in this._tiles)"errored"!==this._tiles[F].state&&this._reloadTile(+F,"reloading")}}_reloadTile(F,Le){const Oe=this._tiles[F];Oe&&("loading"!==Oe.state&&(Oe.state=Le),this._loadTile(Oe,this._tileLoaded.bind(this,Oe,F,Le)))}_tileLoaded(Le,Oe,Fe,je){if(je)if(Le.state="errored",404!==je.status)this._source.fire(new F.z(je,{tile:Le}));else{if(this._source.fire(new F.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:Le})),!(Le.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const F=this.map.painter.terrain;this.update(this.transform,F.getScaledDemTileSize(),!0),F.resetTileLookupCache(this.id)}else this.update(this.transform)}else Le.timeAdded=F.q.now(),"expired"===Fe&&(Le.refreshedUponExpiration=!0),this._setTileReloadTimer(Oe,Le),"raster-dem"===this._source.type&&Le.dem&&this._backfillDEM(Le),this._state.initializeTileState(Le,this.map?this.map.painter:null),this._source.fire(new F.A("data",{dataType:"source",tile:Le,coord:Le.tileID,sourceCacheId:this.id}))}_backfillDEM(F){const Le=this.getRenderableIds();for(let Oe=0;Oe<Le.length;Oe++){const Fe=Le[Oe];if(F.neighboringTiles&&F.neighboringTiles[Fe]){const Le=this.getTileByID(Fe);i(F,Le),i(Le,F)}}function i(F,Le){if(!F.dem||F.dem.borderReady)return;F.needsHillshadePrepare=!0,F.needsDEMTextureUpload=!0;let Oe=Le.tileID.canonical.x-F.tileID.canonical.x;const Fe=Le.tileID.canonical.y-F.tileID.canonical.y,je=Math.pow(2,F.tileID.canonical.z),qe=Le.tileID.key;0===Oe&&0===Fe||Math.abs(Fe)>1||(Math.abs(Oe)>1&&(1===Math.abs(Oe+je)?Oe+=je:1===Math.abs(Oe-je)&&(Oe-=je)),Le.dem&&F.dem&&(F.dem.backfillBorder(Le.dem,Oe,Fe),F.neighboringTiles&&F.neighboringTiles[qe]&&(F.neighboringTiles[qe].backfilled=!0)))}}getTile(F){return this.getTileByID(F.key)}getTileByID(F){return this._tiles[F]}_retainLoadedChildren(F,Le,Oe,Fe){for(const je in this._tiles){let qe=this._tiles[je];if(Fe[je]||!qe.hasData()||qe.tileID.overscaledZ<=Le||qe.tileID.overscaledZ>Oe)continue;let He=qe.tileID;for(;qe&&qe.tileID.overscaledZ>Le+1;){const F=qe.tileID.scaledTo(qe.tileID.overscaledZ-1);qe=this._tiles[F.key],qe&&qe.hasData()&&(He=F)}let xt=He;for(;xt.overscaledZ>Le;)if(xt=xt.scaledTo(xt.overscaledZ-1),F[xt.key]){Fe[He.key]=He;break}}}findLoadedParent(F,Le){if(F.key in this._loadedParentTiles){const Oe=this._loadedParentTiles[F.key];return Oe&&Oe.tileID.overscaledZ>=Le?Oe:null}for(let Oe=F.overscaledZ-1;Oe>=Le;Oe--){const Le=F.scaledTo(Oe),Fe=this._getLoadedTile(Le);if(Fe)return Fe}}_getLoadedTile(F){const Le=this._tiles[F.key];return Le&&Le.hasData()?Le:this._cache.getByKey(this._source.reparseOverscaled?F.wrapped().key:F.canonical.key)}updateCacheSize(F,Le){Le=Le||this._source.tileSize;const Oe=Math.ceil(F.width/Le)+1,Fe=Math.ceil(F.height/Le)+1,je=Math.floor(Oe*Fe*5),qe="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,je):je,He="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,qe):qe;this._cache.setMaxSize(He)}handleWrapJump(F){const Le=Math.round((F-(void 0===this._prevLng?F:this._prevLng))/360);if(this._prevLng=F,Le){const F={};for(const Oe in this._tiles){const Fe=this._tiles[Oe];Fe.tileID=Fe.tileID.unwrapTo(Fe.tileID.wrap+Le),F[Fe.tileID.key]=Fe}this._tiles=F;for(const F in this._timers)clearTimeout(this._timers[F]),delete this._timers[F];for(const F in this._tiles)this._setTileReloadTimer(+F,this._tiles[F])}}update(Le,Oe,Fe,je){if(this.transform=Le,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!Fe)return;this.updateCacheSize(Le,Oe),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const qe="batched-model"===this._source.type;let He,xt=this._source.maxzoom;const jt=this.map&&this.map.painter?this.map.painter._terrain:null;if(jt&&jt.sourceCache===this&&jt.attenuationRange()){const F=jt.attenuationRange()[0],Le=Math.floor(F)-Math.log2(jt.getDemUpscale());xt>Le&&(xt=Le)}if(this.used||this.usedForTerrain){if(this._source.tileID)He=Le.getVisibleUnwrappedCoordinates(this._source.tileID).map((Le=>new F.aH(Le.canonical.z,Le.wrap,Le.canonical.z,Le.canonical.x,Le.canonical.y)));else if(0!==this.tileCoverLift){const je=Le.clone();je.tileCoverLift=this.tileCoverLift,He=je.coveringTiles({tileSize:Oe||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:xt,roundZoom:this._source.roundZoom&&!Fe,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:qe}),this._source.minzoom<=1&&"globe"===Le.projection.name&&(He.push(new F.aH(1,0,1,0,0)),He.push(new F.aH(1,0,1,1,0)),He.push(new F.aH(1,0,1,0,1)),He.push(new F.aH(1,0,1,1,1)))}else if(He=Le.coveringTiles({tileSize:Oe||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:xt,roundZoom:this._source.roundZoom&&!Fe,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:qe}),this._source.hasTile){const F=this._source.hasTile.bind(this._source);He=He.filter((Le=>F(Le)))}}else He=[];if(He.length>0&&this.castsShadows&&je&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!It(this._source.type)){const F=Le.coveringZoomLevel({tileSize:Oe||this._source.tileSize,roundZoom:this._source.roundZoom&&!Fe}),xt=Math.min(F,this._source.maxzoom);if(qe){const F=Le.extendTileCover(He,xt);for(const Le of F)He.push(Le)}else{const F=Le.extendTileCover(He,xt,je);for(const Le of F)this._shadowCasterTiles[Le.key]=!0,He.push(Le)}}const Gt=this._updateRetainedTiles(He);if(It(this._source.type)&&0!==He.length){const Le={},Oe={},Fe=Object.keys(Gt);for(const je of Fe){const Fe=Gt[je],qe=this._tiles[je];if(!qe||qe.fadeEndTime&&qe.fadeEndTime<=F.q.now())continue;const He=this.findLoadedParent(Fe,Math.max(Fe.overscaledZ-St.maxOverzooming,this._source.minzoom));He&&(this._addTile(He.tileID),Le[He.tileID.key]=He.tileID),Oe[je]=Fe}const je=He[He.length-1].overscaledZ;for(const F in this._tiles){const Le=this._tiles[F];if(Gt[F]||!Le.hasData())continue;let Fe=Le.tileID;for(;Fe.overscaledZ>je;){Fe=Fe.scaledTo(Fe.overscaledZ-1);const je=this._tiles[Fe.key];if(je&&je.hasData()&&Oe[Fe.key]){Gt[F]=Le.tileID;break}}}for(const F in Le)Gt[F]||(this._coveredTiles[F]=!0,Gt[F]=Le[F])}for(const F in Gt)this._tiles[F].clearFadeHold();const bi=F.bk(this._tiles,Gt);for(const F of bi){const Le=this._tiles[F];Le.hasSymbolBuckets&&!Le.holdingForFade()?Le.setHoldDuration(this.map._fadeDuration):Le.hasSymbolBuckets&&!Le.symbolFadeFinished()||this._removeTile(+F)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const F in this._tiles)this._tiles[F].holdingForFade()&&this._removeTile(+F)}_updateRetainedTiles(F){const Le={};if(0===F.length)return Le;const Oe={},Fe=F.reduce(((F,Le)=>Math.min(F,Le.overscaledZ)),1/0),je=F[0].overscaledZ,qe=Math.max(je-St.maxOverzooming,this._source.minzoom),He=Math.max(je+St.maxUnderzooming,this._source.minzoom),xt={};for(const Oe of F){const F=this._addTile(Oe);Le[Oe.key]=Oe,F.hasData()||Fe<this._source.maxzoom&&(xt[Oe.key]=Oe)}this._retainLoadedChildren(xt,Fe,He,Le);for(const Fe of F){let F=this._tiles[Fe.key];if(F.hasData())continue;if(Fe.canonical.z>=this._source.maxzoom){const F=Fe.children(this._source.maxzoom)[0],Oe=this.getTile(F);if(Oe&&Oe.hasData()){Le[F.key]=F;continue}}else{const F=Fe.children(this._source.maxzoom);if(Le[F[0].key]&&Le[F[1].key]&&Le[F[2].key]&&Le[F[3].key])continue}let je=F.wasRequested();for(let He=Fe.overscaledZ-1;He>=qe;--He){const qe=Fe.scaledTo(He);if(Oe[qe.key])break;if(Oe[qe.key]=!0,F=this.getTile(qe),!F&&je&&(F=this._addTile(qe)),F&&(Le[qe.key]=qe,je=F.wasRequested(),F.hasData()))break}}return Le}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const F in this._tiles){const Le=[];let Oe,Fe=this._tiles[F].tileID;for(;Fe.overscaledZ>0;){if(Fe.key in this._loadedParentTiles){Oe=this._loadedParentTiles[Fe.key];break}Le.push(Fe.key);const F=Fe.scaledTo(Fe.overscaledZ-1);if(Oe=this._getLoadedTile(F),Oe)break;Fe=F}for(const F of Le)this._loadedParentTiles[F]=Oe}}_addTile(Le){let Oe=this._tiles[Le.key];if(Oe)return!0!==Oe.isExtraShadowCaster||!!this._shadowCasterTiles[Le.key]||this._reloadTile(Le.key,"reloading"),Oe;Oe=this._cache.getAndRemove(Le),Oe&&(this._setTileReloadTimer(Le.key,Oe),Oe.tileID=Le,this._state.initializeTileState(Oe,this.map?this.map.painter:null),this._cacheTimers[Le.key]&&(clearTimeout(this._cacheTimers[Le.key]),delete this._cacheTimers[Le.key],this._setTileReloadTimer(Le.key,Oe)));const Fe=Boolean(Oe);if(!Fe){const F=this.map?this.map.painter:null,Fe=this._source.tileSize*Le.overscaleFactor();Oe="raster-array"===this._source.type?new wt(Le,Fe,this.transform.tileZoom,F,this._isRaster):new bt(Le,Fe,this.transform.tileZoom,F,this._isRaster),this._loadTile(Oe,this._tileLoaded.bind(this,Oe,Le.key,Oe.state))}return Oe?(Oe.uses++,this._tiles[Le.key]=Oe,Fe||this._source.fire(new F.A("dataloading",{tile:Oe,coord:Oe.tileID,dataType:"source"})),Oe):null}_setTileReloadTimer(F,Le){F in this._timers&&(clearTimeout(this._timers[F]),delete this._timers[F]);const Oe=Le.getExpiryTimeout();Oe&&(this._timers[F]=setTimeout((()=>{this._reloadTile(F,"expired"),delete this._timers[F]}),Oe))}_removeTile(F){const Le=this._tiles[F];Le&&(Le.uses--,delete this._tiles[F],this._timers[F]&&(clearTimeout(this._timers[F]),delete this._timers[F]),Le.uses>0||(Le.hasData()&&"reloading"!==Le.state||"empty"===Le.state?this._cache.add(Le.tileID,Le,Le.getExpiryTimeout()):(Le.aborted=!0,this._abortTile(Le),this._unloadTile(Le))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const F in this._tiles)this._removeTile(+F);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(Le,Oe,Fe){const je=[],qe=this.transform;if(!qe)return je;const He="globe"===qe.projection.name,xt=F.av(qe.center.lng);for(const jt in this._tiles){const Gt=this._tiles[jt];if(Fe&&Gt.clearQueryDebugViz(),Gt.holdingForFade())continue;let bi;if(He){const Le=Gt.tileID.canonical;if(0===Le.z){const Oe=[Math.abs(F.ay(xt,...Rt(Le,-1))-xt),Math.abs(F.ay(xt,...Rt(Le,1))-xt)];bi=[0,2*Oe.indexOf(Math.min(...Oe))-1]}else{const Oe=[Math.abs(F.ay(xt,...Rt(Le,-1))-xt),Math.abs(F.ay(xt,...Rt(Le,0))-xt),Math.abs(F.ay(xt,...Rt(Le,1))-xt)];bi=[Oe.indexOf(Math.min(...Oe))-1]}}else bi=[0];for(const F of bi){const Fe=Le.containsTile(Gt,qe,Oe,F);Fe&&je.push(Fe)}}return je}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(F){return this._getRenderableCoordinates(F)}_getRenderableCoordinates(F,Le){const Oe=this.getRenderableIds(F,Le).map((F=>this._tiles[F].tileID)),Fe="globe"===this.transform.projection.name;for(const F of Oe)F.projMatrix=this.transform.calculateProjMatrix(F.toUnwrapped()),F.expandedProjMatrix=Fe?this.transform.calculateProjMatrix(F.toUnwrapped(),!1,!0):F.projMatrix;return Oe}sortCoordinatesByDistance(F){const Le=F.slice(),Oe=this.transform._camera.position,Fe=this.transform._camera.forward(),je={};for(const F of Le){const Le=1/(1<<F.canonical.z);je[F.key]=((F.canonical.x+.5)*Le+F.wrap-Oe[0])*Fe[0]+((F.canonical.y+.5)*Le-Oe[1])*Fe[1]-Oe[2]*Fe[2]}return Le.sort(((F,Le)=>je[F.key]-je[Le.key])),Le}hasTransition(){if(this._source.hasTransition())return!0;if(It(this._source.type))for(const Le in this._tiles){const Oe=this._tiles[Le];if(void 0!==Oe.fadeEndTime&&Oe.fadeEndTime>=F.q.now())return!0}return!1}setFeatureState(F,Le,Oe){this._state.updateState(F=F||"_geojsonTileLayer",Le,Oe)}removeFeatureState(F,Le,Oe){this._state.removeFeatureState(F=F||"_geojsonTileLayer",Le,Oe)}getFeatureState(F,Le){return this._state.getState(F=F||"_geojsonTileLayer",Le)}setDependencies(F,Le,Oe){const Fe=this._tiles[F];Fe&&Fe.setDependencies(Le,Oe)}reloadTilesForDependencies(F,Le){for(const Oe in this._tiles)this._tiles[Oe].hasDependency(F,Le)&&this._reloadTile(+Oe,"reloading");this._cache.filter((Oe=>!Oe.hasDependency(F,Le)))}_preloadTiles(Le,Oe){if(!this._sourceLoaded){const e=()=>{this._sourceLoaded&&(this._source.off("data",e),this._preloadTiles(Le,Oe))};return void this._source.on("data",e)}const Fe=new Map,je=Array.isArray(Le)?Le:[Le],qe=this.map.painter.terrain,He=this.usedForTerrain&&qe?qe.getScaledDemTileSize():this._source.tileSize;for(const F of je){const Le=F.coveringTiles({tileSize:He,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const F of Le)Fe.set(F.key,F);this.usedForTerrain&&F.updateElevation(!1)}const xt=Array.from(Fe.values());F.bl(xt,((F,Le)=>{const Oe=new bt(F,this._source.tileSize*F.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(Oe,(F=>{"raster-dem"===this._source.type&&Oe.dem&&this._backfillDEM(Oe),Le(F,Oe)}))}),Oe)}}function Ct(F,Le){const Oe=Math.abs(2*F.wrap)-+(F.wrap<0),Fe=Math.abs(2*Le.wrap)-+(Le.wrap<0);return F.overscaledZ-Le.overscaledZ||Fe-Oe||Le.canonical.y-F.canonical.y||Le.canonical.x-F.canonical.x}function It(F){return"raster"===F||"image"===F||"video"===F||"custom"===F}function Rt(F,Le){const Oe=1<<F.z;return[F.x/Oe+Le,(F.x+1)/Oe+Le]}St.maxOverzooming=10,St.maxUnderzooming=3;class Dt{constructor(F){this.style=F,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const F=!1,Le=!1;for(const Oe in this.style._mergedLayers){const Fe=this.style._mergedLayers[Oe];if("fill-extrusion"===Fe.type)this.layers.push({layer:Fe,visible:F,visibilityChanged:Le});else if("model"===Fe.type){const Oe=this.style.getLayerSource(Fe);Oe&&"batched-model"===Oe.type&&this.layers.push({layer:Fe,visible:F,visibilityChanged:Le})}}}onNewFrame(F){this.layersGotHidden=!1;for(const Le of this.layers){const Oe=Le.layer;let Fe=!1;"fill-extrusion"===Oe.type?Fe=!Oe.isHidden(F)&&Oe.paint.get("fill-extrusion-opacity")>0:"model"===Oe.type&&(Fe=!Oe.isHidden(F)&&Oe.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!Fe&&Le.visible,Le.visible=Fe}}updateZOffset(F,Le){this.currentBuildingBuckets=[];for(const F of this.layers){const Oe=F.layer,Fe=this.style.getLayerSourceCache(Oe);let je=1;"fill-extrusion"===Oe.type&&(je=F.visible?Oe.paint.get("fill-extrusion-vertical-scale"):0);let qe=Fe?Fe.getTile(Le):null;if(!qe&&Fe&&Le.canonical.z>Fe.getSource().minzoom){let F=Le.scaledTo(Math.min(Fe.getSource().maxzoom,Le.overscaledZ-1));for(;F.overscaledZ>=Fe.getSource().minzoom&&(qe=Fe.getTile(F),!qe&&0!==F.overscaledZ);)F=F.scaledTo(F.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:qe?qe.getBucket(Oe):null,tileID:qe?qe.tileID:Le,verticalScale:je})}F.hasAnyZOffset=!1;let Oe=!1;for(let Fe=0;Fe<F.symbolInstances.length;Fe++){const je=F.symbolInstances.get(Fe),qe=je.zOffset,He=this._getHeightAtTileOffset(Le,je.tileAnchorX,je.tileAnchorY);je.zOffset=He!==Number.NEGATIVE_INFINITY?He:qe,Oe||qe===je.zOffset||(Oe=!0),F.hasAnyZOffset||0===je.zOffset||(F.hasAnyZOffset=!0)}Oe&&(F.zOffsetBuffersNeedUpload=!0,F.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(Le,Oe,Fe,je){let qe=Oe,He=Fe;if(Le.canonical.z!==je.canonical.z){const xt=je.canonical,jt=1/(1<<Le.canonical.z-xt.z);qe=(Oe+Le.canonical.x*F.ai)*jt-xt.x*F.ai|0,He=(Fe+Le.canonical.y*F.ai)*jt-xt.y*F.ai|0}return{tileX:qe,tileY:He}}_getHeightAtTileOffset(F,Le,Oe){let Fe,je;for(let qe=0;qe<this.layers.length;++qe){if("fill-extrusion"!==this.layers[qe].layer.type)continue;const{bucket:He,tileID:xt,verticalScale:jt}=this.currentBuildingBuckets[qe];if(!He)continue;const{tileX:Gt,tileY:bi}=this._mapCoordToOverlappingTile(F,Le,Oe,xt),wi=He.getHeightAtTileCoord(Gt,bi);wi&&void 0!==wi.height&&(wi.hidden?Fe=wi.height:je=Math.max(wi.height*jt,je||0))}if(void 0!==je)return je;for(let je=0;je<this.layers.length;++je){const qe=this.layers[je];if("model"!==qe.layer.type||!qe.visible)continue;const{bucket:He,tileID:xt}=this.currentBuildingBuckets[je];if(!He)continue;const{tileX:jt,tileY:Gt}=this._mapCoordToOverlappingTile(F,Le,Oe,xt),bi=He.getHeightAtTileCoord(jt,Gt);if(bi&&!bi.hidden)return void 0===bi.height&&void 0!==Fe?Math.min(bi.maxHeight,Fe)*bi.verticalScale:bi.height?bi.height*bi.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function At(Le,Oe){const Fe={};for(const F in Le)"ref"!==F&&(Fe[F]=Le[F]);return F.bm.forEach((F=>{F in Oe&&(Fe[F]=Oe[F])})),Fe}function Lt(F){F=F.slice();const Le=Object.create(null);for(let Oe=0;Oe<F.length;Oe++)Le[F[Oe].id]=F[Oe];for(let Oe=0;Oe<F.length;Oe++)"ref"in F[Oe]&&(F[Oe]=At(F[Oe],Le[F[Oe].ref]));return F}const rh={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Pt(F,Le,Oe){Oe.push({command:rh.addSource,args:[F,Le[F]]})}function zt(F,Le,Oe){Le.push({command:rh.removeSource,args:[F]}),Oe[F]=!0}function Ot(F,Le,Oe,Fe){zt(F,Oe,Fe),Pt(F,Le,Oe)}function Ft(Le,Oe,Fe){let je;for(je in Le[Fe])if(Le[Fe].hasOwnProperty(je)&&"data"!==je&&!F.bn(Le[Fe][je],Oe[Fe][je]))return!1;for(je in Oe[Fe])if(Oe[Fe].hasOwnProperty(je)&&"data"!==je&&!F.bn(Le[Fe][je],Oe[Fe][je]))return!1;return!0}function kt(Le,Oe,Fe,je,qe,He){let xt;for(xt in Oe=Oe||{},Le=Le||{})Le.hasOwnProperty(xt)&&(F.bn(Le[xt],Oe[xt])||Fe.push({command:He,args:[je,xt,Oe[xt],qe]}));for(xt in Oe)Oe.hasOwnProperty(xt)&&!Le.hasOwnProperty(xt)&&(F.bn(Le[xt],Oe[xt])||Fe.push({command:He,args:[je,xt,Oe[xt],qe]}))}function Bt(F){return F.id}function Nt(F,Le){return F[Le.id]=Le,F}class Ut{constructor(F,Le){this.reset(F,Le)}reset(F,Le){this.points=F||[],this._distances=[0];for(let F=1;F<this.points.length;F++)this._distances[F]=this._distances[F-1]+this.points[F].dist(this.points[F-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(Le||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(Le){if(1===this.points.length)return this.points[0];Le=F.ay(Le,0,1);let Oe=1,Fe=this._distances[Oe];const je=Le*this.paddedLength+this.padding;for(;Fe<je&&Oe<this._distances.length;)Fe=this._distances[++Oe];const qe=Oe-1,He=this._distances[qe],xt=Fe-He,jt=xt>0?(je-He)/xt:0;return this.points[qe].mult(1-jt).add(this.points[Oe].mult(jt))}}class Vt{constructor(F,Le,Oe){const Fe=this.boxCells=[],je=this.circleCells=[];this.xCellCount=Math.ceil(F/Oe),this.yCellCount=Math.ceil(Le/Oe);for(let F=0;F<this.xCellCount*this.yCellCount;F++)Fe.push([]),je.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=F,this.height=Le,this.xScale=this.xCellCount/F,this.yScale=this.yCellCount/Le,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(F,Le,Oe,Fe,je){this._forEachCell(Le,Oe,Fe,je,this._insertBoxCell,this.boxUid++),this.boxKeys.push(F),this.bboxes.push(Le),this.bboxes.push(Oe),this.bboxes.push(Fe),this.bboxes.push(je)}insertCircle(F,Le,Oe,Fe){this._forEachCell(Le-Fe,Oe-Fe,Le+Fe,Oe+Fe,this._insertCircleCell,this.circleUid++),this.circleKeys.push(F),this.circles.push(Le),this.circles.push(Oe),this.circles.push(Fe)}_insertBoxCell(F,Le,Oe,Fe,je,qe){this.boxCells[je].push(qe)}_insertCircleCell(F,Le,Oe,Fe,je,qe){this.circleCells[je].push(qe)}_query(F,Le,Oe,Fe,je,qe){if(Oe<0||F>this.width||Fe<0||Le>this.height)return!je&&[];const He=[];if(F<=0&&Le<=0&&this.width<=Oe&&this.height<=Fe){if(je)return!0;for(let F=0;F<this.boxKeys.length;F++)He.push({key:this.boxKeys[F],x1:this.bboxes[4*F],y1:this.bboxes[4*F+1],x2:this.bboxes[4*F+2],y2:this.bboxes[4*F+3]});for(let F=0;F<this.circleKeys.length;F++){const Le=this.circles[3*F],Oe=this.circles[3*F+1],Fe=this.circles[3*F+2];He.push({key:this.circleKeys[F],x1:Le-Fe,y1:Oe-Fe,x2:Le+Fe,y2:Oe+Fe})}return qe?He.filter(qe):He}return this._forEachCell(F,Le,Oe,Fe,this._queryCell,He,{hitTest:je,seenUids:{box:{},circle:{}}},qe),je?He.length>0:He}_queryCircle(F,Le,Oe,Fe,je){const qe=F-Oe,He=F+Oe,xt=Le-Oe,jt=Le+Oe;if(He<0||qe>this.width||jt<0||xt>this.height)return!Fe&&[];const Gt=[];return this._forEachCell(qe,xt,He,jt,this._queryCellCircle,Gt,{hitTest:Fe,circle:{x:F,y:Le,radius:Oe},seenUids:{box:{},circle:{}}},je),Fe?Gt.length>0:Gt}query(F,Le,Oe,Fe,je){return this._query(F,Le,Oe,Fe,!1,je)}hitTest(F,Le,Oe,Fe,je){return this._query(F,Le,Oe,Fe,!0,je)}hitTestCircle(F,Le,Oe,Fe){return this._queryCircle(F,Le,Oe,!0,Fe)}_queryCell(F,Le,Oe,Fe,je,qe,He,xt){const jt=He.seenUids,Gt=this.boxCells[je];if(null!==Gt){const je=this.bboxes;for(const bi of Gt)if(!jt.box[bi]){jt.box[bi]=!0;const Gt=4*bi;if(F<=je[Gt+2]&&Le<=je[Gt+3]&&Oe>=je[Gt+0]&&Fe>=je[Gt+1]&&(!xt||xt(this.boxKeys[bi]))){if(He.hitTest)return qe.push(!0),!0;qe.push({key:this.boxKeys[bi],x1:je[Gt],y1:je[Gt+1],x2:je[Gt+2],y2:je[Gt+3]})}}}const bi=this.circleCells[je];if(null!==bi){const je=this.circles;for(const Gt of bi)if(!jt.circle[Gt]){jt.circle[Gt]=!0;const bi=3*Gt;if(this._circleAndRectCollide(je[bi],je[bi+1],je[bi+2],F,Le,Oe,Fe)&&(!xt||xt(this.circleKeys[Gt]))){if(He.hitTest)return qe.push(!0),!0;{const F=je[bi],Le=je[bi+1],Oe=je[bi+2];qe.push({key:this.circleKeys[Gt],x1:F-Oe,y1:Le-Oe,x2:F+Oe,y2:Le+Oe})}}}}}_queryCellCircle(F,Le,Oe,Fe,je,qe,He,xt){const jt=He.circle,Gt=He.seenUids,bi=this.boxCells[je];if(null!==bi){const F=this.bboxes;for(const Le of bi)if(!Gt.box[Le]){Gt.box[Le]=!0;const Oe=4*Le;if(this._circleAndRectCollide(jt.x,jt.y,jt.radius,F[Oe+0],F[Oe+1],F[Oe+2],F[Oe+3])&&(!xt||xt(this.boxKeys[Le])))return qe.push(!0),!0}}const wi=this.circleCells[je];if(null!==wi){const F=this.circles;for(const Le of wi)if(!Gt.circle[Le]){Gt.circle[Le]=!0;const Oe=3*Le;if(this._circlesCollide(F[Oe],F[Oe+1],F[Oe+2],jt.x,jt.y,jt.radius)&&(!xt||xt(this.circleKeys[Le])))return qe.push(!0),!0}}}_forEachCell(F,Le,Oe,Fe,je,qe,He,xt){const jt=this._convertToXCellCoord(F),Gt=this._convertToYCellCoord(Le),bi=this._convertToXCellCoord(Oe),wi=this._convertToYCellCoord(Fe);for(let qr=jt;qr<=bi;qr++)for(let jt=Gt;jt<=wi;jt++)if(je.call(this,F,Le,Oe,Fe,this.xCellCount*jt+qr,qe,He,xt))return}_convertToXCellCoord(F){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(F*this.xScale)))}_convertToYCellCoord(F){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(F*this.yScale)))}_circlesCollide(F,Le,Oe,Fe,je,qe){const He=Fe-F,xt=je-Le,jt=Oe+qe;return jt*jt>He*He+xt*xt}_circleAndRectCollide(F,Le,Oe,Fe,je,qe,He){const xt=(qe-Fe)/2,jt=Math.abs(F-(Fe+xt));if(jt>xt+Oe)return!1;const Gt=(He-je)/2,bi=Math.abs(Le-(je+Gt));if(bi>Gt+Oe)return!1;if(jt<=xt||bi<=Gt)return!0;const wi=jt-xt,qr=bi-Gt;return wi*wi+qr*qr<=Oe*Oe}}const oh={unknown:0,flipRequired:1,flipNotRequired:2},ah=Math.tan(85*Math.PI/180);function qt(Le,Oe,Fe,je,qe,He,xt){const jt=F.ad.mat4.create();if(Fe)if("globe"===He.name){const Le=F.bo(qe,Oe);F.ad.mat4.multiply(jt,jt,Le)}else{const Le=F.ad.mat2.invert([],xt);jt[0]=Le[0],jt[1]=Le[1],jt[4]=Le[2],jt[5]=Le[3],je||F.ad.mat4.rotateZ(jt,jt,qe.angle)}else F.ad.mat4.multiply(jt,qe.labelPlaneMatrix,Le);return jt}function Ht(F,Le,Oe,Fe,je,qe,He){const xt=qt(F,Le,Oe,Fe,je,qe,He);return"globe"===qe.name&&Oe||(xt[2]=xt[6]=xt[10]=xt[14]=0),xt}function Zt(Le,Oe,Fe,je,qe,He,xt){if(Fe){if("globe"===He.name){const jt=qt(Le,Oe,Fe,je,qe,He,xt);return F.ad.mat4.invert(jt,jt),F.ad.mat4.multiply(jt,Le,jt),jt}{const Oe=F.ad.mat4.clone(Le),Fe=F.ad.mat4.identity([]);return Fe[0]=xt[0],Fe[1]=xt[1],Fe[4]=xt[2],Fe[5]=xt[3],F.ad.mat4.multiply(Oe,Oe,Fe),je||F.ad.mat4.rotateZ(Oe,Oe,-qe.angle),Oe}}return qe.glCoordMatrix}function Wt(Le,Oe,Fe,je){const qe=[Le,Oe,Fe,1];Fe?F.ad.vec4.transformMat4(qe,qe,je):si(qe,qe,je);const He=qe[3];return qe[0]/=He,qe[1]/=He,qe[2]/=He,qe}function $t(F,Le){return Math.min(.5+F/Le*.5,1.5)}function Xt(F,Le){const Oe=F[0]/F[3],Fe=F[1]/F[3];return Oe>=-Le[0]&&Oe<=Le[0]&&Fe>=-Le[1]&&Fe<=Le[1]}function Kt(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi){const wi=Fe.transform,qr=je?Le.textSizeData:Le.iconSizeData,Xn=F.bp(qr,Fe.transform.zoom),Yn="globe"===wi.projection.name,yo=[256/Fe.width*2+1,256/Fe.height*2+1],bo=je?Le.text.dynamicLayoutVertexArray:Le.icon.dynamicLayoutVertexArray;bo.clear();let Do=null;Yn&&(Do=je?Le.text.globeExtVertexArray:Le.icon.globeExtVertexArray);const Ro=Le.lineVertexArray,zs=je?Le.text.placedSymbolArray:Le.icon.placedSymbolArray,Zs=Fe.transform.width/Fe.transform.height;let na,el=!1;for(let je=0;je<zs.length;je++){const Yn=zs.get(je),{numGlyphs:nl,writingMode:hl}=Yn;if(hl!==F.bq.vertical||el||na===F.bq.horizontal||(el=!0),na=hl,(Yn.hidden||hl===F.bq.vertical)&&!el){oi(nl,bo);continue}el=!1;const pl=new F.P(Yn.tileAnchorX,Yn.tileAnchorY);let{x:bl,y:Tl,z:kl}=wi.projection.projectTilePoint(pl.x,pl.y,bi.canonical);if(Gt){const[F,Le,Oe]=Gt(pl);bl+=F,Tl+=Le,kl+=Oe}const ec=[bl,Tl,kl,1];if(F.ad.vec4.transformMat4(ec,ec,Oe),!Xt(ec,yo)){oi(nl,bo);continue}const tc=ec[3],ic=$t(Fe.transform.getCameraToCenterDistance(wi.projection),tc),oc=F.br(qr,Xn,Yn),sc=xt?oc/ic:oc*ic,ac=Wt(bl,Tl,kl,qe);if(ac[3]<=0){oi(nl,bo);continue}let mc={};const gc=F.ak(Le.layers[0].layout.get("text-max-angle")),yc=Math.cos(gc),xc=xt?null:Gt,Zc=Qt(Yn,sc,!1,jt,Oe,qe,He,Le.glyphOffsetArray,Ro,bo,Do,ac,pl,mc,Zs,xc,wi.projection,bi,xt,yc);el=Zc.useVertical,xc&&Zc.needsFlipping&&(mc={}),(Zc.notEnoughRoom||el||Zc.needsFlipping&&Qt(Yn,sc,!0,jt,Oe,qe,He,Le.glyphOffsetArray,Ro,bo,Do,ac,pl,mc,Zs,xc,wi.projection,bi,xt,yc).notEnoughRoom)&&oi(nl,bo)}je?(Le.text.dynamicLayoutVertexBuffer.updateData(bo),Do&&Le.text.globeExtVertexBuffer&&Le.text.globeExtVertexBuffer.updateData(Do)):(Le.icon.dynamicLayoutVertexBuffer.updateData(bo),Do&&Le.icon.globeExtVertexBuffer&&Le.icon.globeExtVertexBuffer.updateData(Do))}function Yt(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo){const{lineStartIndex:Do,glyphStartIndex:Ro,segment:zs}=xt,Zs=Ro+xt.numGlyphs,na=Do+xt.lineLength,el=Le.getoffsetX(Ro),nl=Le.getoffsetX(Zs-1),hl=ii(F*el,Oe,Fe,je,qe,He,zs,Do,na,jt,Gt,bi,wi,qr,!0,Xn,Yn,yo,bo);if(!hl)return null;const pl=ii(F*nl,Oe,Fe,je,qe,He,zs,Do,na,jt,Gt,bi,wi,qr,!0,Xn,Yn,yo,bo);return pl?{first:hl,last:pl}:null}function Jt(Le,Oe,Fe,je){return Le===F.bq.horizontal&&Math.abs(je)>Math.abs(Fe)?{useVertical:!0}:Le===F.bq.vertical?je>0?{needsFlipping:!0}:null:Oe!==oh.unknown&&function(F,Le){return 0===F||Math.abs(Le/F)>ah}(Fe,je)?Oe===oh.flipRequired?{needsFlipping:!0}:null:Fe<0?{needsFlipping:!0}:null}function Qt(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs){const na=Oe/24,el=Le.lineOffsetX*na,nl=Le.lineOffsetY*na,{lineStartIndex:hl,glyphStartIndex:pl,numGlyphs:bl,segment:Tl,writingMode:kl,flipState:ec}=Le,tc=hl+Le.lineLength,L=Le=>{if(wi){const[Oe,Fe,je]=Le.up,qe=bi.length;F.bs(wi,qe+0,Oe,Fe,je),F.bs(wi,qe+1,Oe,Fe,je),F.bs(wi,qe+2,Oe,Fe,je),F.bs(wi,qe+3,Oe,Fe,je)}const[Oe,Fe,je]=Le.point;F.bt(bi,Oe,Fe,je,Le.angle)};if(bl>1){const F=Yt(na,jt,el,nl,Fe,qr,Xn,Le,Gt,He,Yn,bo,!1,Do,Ro,zs,Zs);if(!F)return{notEnoughRoom:!0};if(je&&!Fe){let[Oe,Fe,je]=F.first.point,[qe,He,jt]=F.last.point;[Oe,Fe]=Wt(Oe,Fe,je,xt),[qe,He]=Wt(qe,He,jt,xt);const Gt=Jt(kl,ec,(qe-Oe)*yo,He-Fe);if(Le.flipState=Gt&&Gt.needsFlipping?oh.flipRequired:oh.flipNotRequired,Gt)return Gt}L(F.first);for(let F=pl+1;F<pl+bl-1;F++){const Le=ii(na*jt.getoffsetX(F),el,nl,Fe,qr,Xn,Tl,hl,tc,Gt,He,Yn,bo,!1,!1,Do,Ro,zs,Zs);if(!Le)return bi.length-=4*(F-pl),{notEnoughRoom:!0};L(Le)}L(F.last)}else{if(je&&!Fe){const Oe=Wt(Xn.x,Xn.y,0,qe),Fe=hl+Tl+1,je=new F.P(Gt.getx(Fe),Gt.gety(Fe)),He=Wt(je.x,je.y,0,qe),xt=He[3]>0?He:ti(Xn,je,Oe,1,qe,void 0,Do,Ro.canonical),jt=Jt(kl,ec,(xt[0]-Oe[0])*yo,xt[1]-Oe[1]);if(Le.flipState=jt&&jt.needsFlipping?oh.flipRequired:oh.flipNotRequired,jt)return jt}const Oe=ii(na*jt.getoffsetX(pl),el,nl,Fe,qr,Xn,Tl,hl,tc,Gt,He,Yn,bo,!1,!1,Do,Ro,zs,Zs);if(!Oe)return{notEnoughRoom:!0};L(Oe)}return{}}function ei(F,Le,Oe,Fe,je){const{x:qe,y:He,z:xt}=Fe.projectTilePoint(F.x,F.y,Le);if(!je)return Wt(qe,He,xt,Oe);const[jt,Gt,bi]=je(F);return Wt(qe+jt,He+Gt,xt+bi,Oe)}function ti(Le,Oe,Fe,je,qe,He,xt,jt){const Gt=ei(Le.sub(Oe)._unit()._add(Le),jt,qe,xt,He);return F.ad.vec3.sub(Gt,Fe,Gt),F.ad.vec3.normalize(Gt,Gt),F.ad.vec3.scaleAndAdd(Gt,Fe,Gt,je)}function ii(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs){const Zs=je?Le-Oe:Le+Oe;let na=Zs>0?1:-1,el=0;je&&(na*=-1,el=Math.PI),na<0&&(el+=Math.PI);let nl=jt+xt+(na>0?0:1)|0,hl=qe,pl=qe,bl=0,Tl=0;const kl=Math.abs(Zs),ec=[],tc=[];let ic=He,oc=ic,sc=F.ad.vec3.zero([]);const z=()=>ti(oc,ic,pl,kl-bl+1,wi,Xn,bo,Do.canonical);for(;bl+Tl<=kl;){if(nl+=na,nl<jt||nl>=Gt)return null;if(pl=hl,oc=ic,ec.push(pl),Yn&&tc.push(oc),ic=new F.P(bi.getx(nl),bi.gety(nl)),hl=qr[nl],!hl){const F=ei(ic,Do.canonical,wi,bo,Xn);hl=F[3]>0?qr[nl]=F:z()}bl+=Tl;const Le=F.ad.vec3.sub([],hl,pl),Oe=F.ad.vec3.distance(pl,hl);if(Fe&&Oe>0&&Tl>0&&F.ad.vec3.dot(sc,Le)/(Tl*Oe)<zs)return null;Tl=Oe,sc=Le}yo&&Xn&&(qr[nl]&&(hl=z(),Tl=F.ad.vec3.distance(pl,hl),sc=F.ad.vec3.sub([],hl,pl)),qr[nl]=hl);const ac=(kl-bl)/Tl,mc=ic.sub(oc)._mult(ac)._add(oc),gc=F.ad.vec3.scaleAndAdd([],pl,sc,ac);let yc=[0,0,1],xc=sc[0],Zc=sc[1];if(Ro&&(yc=bo.upVector(Do.canonical,mc.x,mc.y),0!==yc[0]||0!==yc[1]||1!==yc[2])){const Le=[yc[2],0,-yc[0]],Oe=F.ad.vec3.cross([],yc,Le);F.ad.vec3.normalize(Le,Le),F.ad.vec3.normalize(Oe,Oe),xc=F.ad.vec3.dot(sc,Le),Zc=F.ad.vec3.dot(sc,Oe)}if(Fe){const Le=F.ad.vec3.cross([],yc,sc);F.ad.vec3.normalize(Le,Le),F.ad.vec3.scaleAndAdd(gc,gc,Le,Fe*na)}const Wc=el+Math.atan2(Zc,xc);return ec.push(gc),Yn&&tc.push(mc),{point:gc,angle:Wc,path:ec,tilePath:tc,up:yc}}function oi(F,Le){const Oe=Le.length,Fe=Oe+4*F;Le.resize(Fe),Le.float32.fill(-1/0,4*Oe,4*Fe)}function si(F,Le,Oe){const Fe=Le[0],je=Le[1];return F[0]=Oe[0]*Fe+Oe[4]*je+Oe[12],F[1]=Oe[1]*Fe+Oe[5]*je+Oe[13],F[3]=Oe[3]*Fe+Oe[7]*je+Oe[15],F}const lh=100;class ni{constructor(F,Le,Oe=new Vt(F.width+200,F.height+200,25),Fe=new Vt(F.width+200,F.height+200,25)){this.transform=F,this.grid=Oe,this.ignoredGrid=Fe,this.pitchfactor=Math.cos(F._pitch)*F.cameraToCenterDistance,this.screenRightBoundary=F.width+lh,this.screenBottomBoundary=F.height+lh,this.gridRightBoundary=F.width+200,this.gridBottomBoundary=F.height+200,this.fogState=Le}placeCollisionBox(F,Le,Oe,Fe,je,qe,He,xt){let jt=Oe.projectedAnchorX,Gt=Oe.projectedAnchorY,bi=Oe.projectedAnchorZ;const wi=Oe.elevation,qr=Oe.tileID,Xn=F.getProjection();if(wi&&qr){const[F,Le,Fe]=Xn.upVector(qr.canonical,Oe.tileAnchorX,Oe.tileAnchorY),je=Xn.upVectorScale(qr.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;jt+=F*wi*je,Gt+=Le*wi*je,bi+=Fe*wi*je}const Yn=this.projectAndGetPerspectiveRatio(He,jt,Gt,bi,Oe.tileID,"globe"===Xn.name||!!wi||this.transform.pitch>0,Xn),yo=qe*Yn.perspectiveRatio,bo=(Oe.x1*Le+Fe.x-Oe.padding)*yo+Yn.point.x,Do=(Oe.y1*Le+Fe.y-Oe.padding)*yo+Yn.point.y,Ro=(Oe.x2*Le+Fe.x+Oe.padding)*yo+Yn.point.x,zs=(Oe.y2*Le+Fe.y+Oe.padding)*yo+Yn.point.y,Zs=Yn.perspectiveRatio<=.55||Yn.occluded;return!this.isInsideGrid(bo,Do,Ro,zs)||!je&&this.grid.hitTest(bo,Do,Ro,zs,xt)||Zs?{box:[],offscreen:!1,occluded:Yn.occluded}:{box:[bo,Do,Ro,zs],offscreen:this.isOffscreen(bo,Do,Ro,zs),occluded:!1}}placeCollisionCircles(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo){const bo=[],Do=this.transform.elevation,Ro=Le.getProjection(),zs=Do?Do.getAtTileOffsetFunc(yo,this.transform.center.lat,this.transform.worldSize,Ro):null,Zs=new F.P(Fe.tileAnchorX,Fe.tileAnchorY);let{x:na,y:el,z:nl}=Ro.projectTilePoint(Zs.x,Zs.y,yo.canonical);if(zs){const[F,Le,Oe]=zs(Zs);na+=F,el+=Le,nl+=Oe}const hl="globe"===Ro.name,pl=this.projectAndGetPerspectiveRatio(xt,na,el,nl,yo,hl||!!Do||this.transform.pitch>0,Ro),{perspectiveRatio:bl}=pl,Tl=(wi?He/bl:He*bl)/F.bw,kl=Wt(na,el,nl,jt),ec=Fe.lineOffsetX*Tl,tc=Fe.lineOffsetY*Tl,ic=F.ak(Le.layers[0].layout.get("text-max-angle")),oc=Math.cos(ic),sc=pl.signedDistanceFromCamera>0?Yt(Tl,qe,ec,tc,!1,kl,Zs,Fe,je,jt,{},Do&&!wi?zs:null,wi&&!!Do,Ro,yo,wi,oc):null;let ac=!1,mc=!1,gc=!0;if(sc&&!pl.occluded){const Le=.5*Xn*bl+Yn,Fe=new F.P(-100,-100),je=new F.P(this.screenRightBoundary,this.screenBottomBoundary),qe=new Ut,{first:He,last:xt}=sc,jt=He.path.length;let wi=[];for(let F=jt-1;F>=1;F--)wi.push(He.path[F]);for(let F=1;F<xt.path.length;F++)wi.push(xt.path[F]);const yo=2.5*Le;Gt&&(wi=wi.map((([F,Le,Oe],Fe)=>(zs&&!hl&&(Oe=zs(Fe<jt-1?He.tilePath[jt-1-Fe]:xt.tilePath[Fe-jt+2])[2]),Wt(F,Le,Oe,Gt)))),wi.some((F=>F[3]<=0))&&(wi=[]));let Do=[];if(wi.length>0){let Le=1/0,Oe=-1/0,qe=1/0,He=-1/0;for(const F of wi)Le=Math.min(Le,F[0]),qe=Math.min(qe,F[1]),Oe=Math.max(Oe,F[0]),He=Math.max(He,F[1]);Oe>=Fe.x&&Le<=je.x&&He>=Fe.y&&qe<=je.y&&(Do=[wi.map((Le=>new F.P(Le[0],Le[1])))],(Le<Fe.x||Oe>je.x||qe<Fe.y||He>je.y)&&(Do=F.bu(Do,Fe.x,Fe.y,je.x,je.y)))}for(const F of Do){qe.reset(F,.25*Le);let Fe=0;Fe=qe.length<=.5*Le?1:Math.ceil(qe.paddedLength/yo)+1;for(let F=0;F<Fe;F++){const je=F/Math.max(Fe-1,1),He=qe.lerp(je),xt=He.x+lh,jt=He.y+lh;bo.push(xt,jt,Le,0);const Gt=xt-Le,wi=jt-Le,Xn=xt+Le,Yn=jt+Le;if(gc=gc&&this.isOffscreen(Gt,wi,Xn,Yn),mc=mc||this.isInsideGrid(Gt,wi,Xn,Yn),!Oe&&this.grid.hitTestCircle(xt,jt,Le,qr)&&(ac=!0,!bi))return{circles:[],offscreen:!1,collisionDetected:ac,occluded:!1}}}}return{circles:!bi&&ac||!mc?[]:bo,offscreen:gc,collisionDetected:ac,occluded:pl.occluded}}queryRenderedSymbols(Le){if(0===Le.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const Oe=[];let Fe=1/0,je=1/0,qe=-1/0,He=-1/0;for(const xt of Le){const Le=new F.P(xt.x+lh,xt.y+lh);Fe=Math.min(Fe,Le.x),je=Math.min(je,Le.y),qe=Math.max(qe,Le.x),He=Math.max(He,Le.y),Oe.push(Le)}const xt=this.grid.query(Fe,je,qe,He).concat(this.ignoredGrid.query(Fe,je,qe,He)),jt={},Gt={};for(const Le of xt){const Fe=Le.key;if(void 0===jt[Fe.bucketInstanceId]&&(jt[Fe.bucketInstanceId]={}),jt[Fe.bucketInstanceId][Fe.featureIndex])continue;const je=[new F.P(Le.x1,Le.y1),new F.P(Le.x2,Le.y1),new F.P(Le.x2,Le.y2),new F.P(Le.x1,Le.y2)];F.bv(Oe,je)&&(jt[Fe.bucketInstanceId][Fe.featureIndex]=!0,void 0===Gt[Fe.bucketInstanceId]&&(Gt[Fe.bucketInstanceId]=[]),Gt[Fe.bucketInstanceId].push(Fe.featureIndex))}return Gt}insertCollisionBox(F,Le,Oe,Fe,je){(Le?this.ignoredGrid:this.grid).insert({bucketInstanceId:Oe,featureIndex:Fe,collisionGroupID:je},F[0],F[1],F[2],F[3])}insertCollisionCircles(F,Le,Oe,Fe,je){const qe=Le?this.ignoredGrid:this.grid,He={bucketInstanceId:Oe,featureIndex:Fe,collisionGroupID:je};for(let Le=0;Le<F.length;Le+=4)qe.insertCircle(He,F[Le],F[Le+1],F[Le+2])}projectAndGetPerspectiveRatio(Le,Oe,Fe,je,qe,He,xt){const jt=[Oe,Fe,je,1];let Gt=!1;if(je||this.transform.pitch>0){if(F.ad.vec4.transformMat4(jt,jt,Le),this.fogState&&qe&&"globe"!==xt.name){const Le=function(Le,Oe,Fe,je,qe,He){const xt=He.calculateFogTileMatrix(qe),jt=[Oe,Fe,je];return F.ad.vec3.transformMat4(jt,jt,xt),ke(Le,F.ad.vec3.length(jt),He.pitch,He._fov)}(this.fogState,Oe,Fe,je,qe.toUnwrapped(),this.transform);Gt=Le>.9}}else si(jt,jt,Le);const bi=jt[3];return{point:new F.P((jt[0]/bi+1)/2*this.transform.width+lh,(-jt[1]/bi+1)/2*this.transform.height+lh),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(xt)/bi*.5,1.5),signedDistanceFromCamera:bi,occluded:He&&jt[2]>bi||Gt}}isOffscreen(F,Le,Oe,Fe){return Oe<lh||F>=this.screenRightBoundary||Fe<lh||Le>this.screenBottomBoundary}isInsideGrid(F,Le,Oe,Fe){return Oe>=0&&F<this.gridRightBoundary&&Fe>=0&&Le<this.gridBottomBoundary}getViewportMatrix(){const Le=F.ad.mat4.identity([]);return F.ad.mat4.translate(Le,Le,[-100,-100,0]),Le}}function ai(Le,Oe,Fe){const je=Oe.createTileMatrix(Le,Le.worldSize,Fe.toUnwrapped());return F.ad.mat4.multiply(new Float32Array(16),Le.projMatrix,je)}function li(F,Le,Oe){if(Le.projection.name===Oe.projection.name)return F.projMatrix;const Fe=Oe.clone();return Fe.setProjection(Le.projection),ai(Fe,Le.getProjection(),F)}function ci(F,Le,Oe){return Le.name===Oe.projection.name?F.projMatrix:ai(Oe,Le,F)}class hi{constructor(F,Le,Oe,Fe){this.opacity=F?Math.max(0,Math.min(1,F.opacity+(F.placed?Le:-Le))):Fe&&Oe?1:0,this.placed=Oe}isHidden(){return 0===this.opacity&&!this.placed}}class di{constructor(F,Le,Oe,Fe,je,qe=!1){this.text=new hi(F?F.text:null,Le,Oe,je),this.icon=new hi(F?F.icon:null,Le,Fe,je),this.clipped=qe}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class ui{constructor(F,Le,Oe,Fe=!1){this.text=F,this.icon=Le,this.skipFade=Oe,this.clipped=Fe}}class _i{constructor(){this.invProjMatrix=F.ad.mat4.create(),this.viewportMatrix=F.ad.mat4.create(),this.circles=[]}}class pi{constructor(F,Le,Oe,Fe,je){this.bucketInstanceId=F,this.featureIndex=Le,this.sourceLayerIndex=Oe,this.bucketIndex=Fe,this.tileID=je}}class fi{constructor(F){this.crossSourceCollisions=F,this.maxGroupID=0,this.collisionGroups={}}get(F){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[F]){const Le=++this.maxGroupID;this.collisionGroups[F]={ID:Le,predicate:F=>F.collisionGroupID===Le}}return this.collisionGroups[F]}}function mi(Le,Oe,Fe,je,qe){const{horizontalAlign:He,verticalAlign:xt}=F.bD(Le),jt=-(He-.5)*Oe,Gt=-(xt-.5)*Fe,bi=F.bC(Le,je);return new F.P(jt+bi[0]*qe,Gt+bi[1]*qe)}function gi(Le,Oe,Fe,je,qe){const He=new F.P(Le,Oe);return Fe&&He._rotate(je?qe:-qe),He}class vi{constructor(F,Le,Oe,Fe,je,qe){this.transform=F.clone(),this.projection=F.projection.name,this.collisionIndex=new ni(this.transform,je),this.buildingIndex=qe,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=Le,this.retainedQueryData={},this.collisionGroups=new fi(Oe),this.collisionCircleArrays={},this.prevPlacement=Fe,Fe&&(Fe.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(Le,Oe,Fe,je,qe=1){const He=Fe.getBucket(Oe),xt=Fe.latestFeatureIndex;if(!He||!xt||Oe.fqid!==He.layerIds[0])return;const jt=He.layers[0].layout,Gt=He.layers[0].paint,bi=Fe.collisionBoxArray,wi=Math.pow(2,this.transform.zoom-Fe.tileID.overscaledZ),qr=Fe.tileSize/F.ai,Xn=Fe.tileID.toUnwrapped();this.transform.setProjection(He.projection);const Yn=(yo=Fe.tileID,bo=He.getProjection(),Do=this.transform,bo.name===this.projection?Do.calculateProjMatrix(yo.toUnwrapped()):ai(Do,bo,yo));var yo,bo,Do;const Ro="map"===jt.get("text-pitch-alignment"),zs="map"===jt.get("text-rotation-alignment");Oe.compileFilter(Oe.options);const Zs=Oe.dynamicFilter(),na=Oe.dynamicFilterNeedsFeature(),el=this.transform.calculatePixelsToTileUnitsMatrix(Fe),nl=Ht(Yn,Fe.tileID.canonical,Ro,zs,this.transform,He.getProjection(),el);let hl=null;if(Ro){const Le=Zt(Yn,Fe.tileID.canonical,Ro,zs,this.transform,He.getProjection(),el);hl=F.ad.mat4.multiply([],this.transform.labelPlaneMatrix,Le)}let pl=null;Zs&&Fe.latestFeatureIndex&&(pl={unwrappedTileID:Xn,dynamicFilter:Zs,dynamicFilterNeedsFeature:na}),this.retainedQueryData[He.bucketInstanceId]=new pi(He.bucketInstanceId,xt,He.sourceLayerIndex,He.index,Fe.tileID);const[bl,Tl]=He.layers[0].layout.get("text-size-scale-range"),kl=F.ay(qe,bl,Tl),[ec,tc]=jt.get("icon-size-scale-range"),ic=F.ay(qe,ec,tc),oc={bucket:He,layout:jt,paint:Gt,posMatrix:Yn,textLabelPlaneMatrix:nl,labelToScreenMatrix:hl,clippingData:pl,scale:wi,textPixelRatio:qr,holdingForFade:Fe.holdingForFade(),collisionBoxArray:bi,partiallyEvaluatedTextSize:F.bp(He.textSizeData,this.transform.zoom,kl),partiallyEvaluatedIconSize:F.bp(He.iconSizeData,this.transform.zoom,ic),collisionGroup:this.collisionGroups.get(He.sourceID),latestFeatureIndex:Fe.latestFeatureIndex};if(je)for(const F of He.sortKeyRanges){const{sortKey:Oe,symbolInstanceStart:Fe,symbolInstanceEnd:je}=F;Le.push({sortKey:Oe,symbolInstanceStart:Fe,symbolInstanceEnd:je,parameters:oc})}else Le.push({symbolInstanceStart:0,symbolInstanceEnd:He.symbolInstances.length,parameters:oc})}attemptAnchorPlacement(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do){const{textOffset0:Ro,textOffset1:zs,crossTileID:Zs}=wi,na=[Ro,zs],el=mi(F,Oe,Fe,na,je),nl=this.collisionIndex.placeCollisionBox(Xn,je,Le,gi(el.x,el.y,qe,He,this.transform.angle),bi,xt,jt,Gt.predicate);if(yo){const F=Xn.getSymbolInstanceIconSize(Do,this.transform.zoom,wi.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(Xn,F,yo,gi(el.x,el.y,qe,He,this.transform.angle),bi,xt,jt,Gt.predicate).box.length)return}if(nl.box.length>0){let Le;return this.prevPlacement&&this.prevPlacement.variableOffsets[Zs]&&this.prevPlacement.placements[Zs]&&this.prevPlacement.placements[Zs].text&&(Le=this.prevPlacement.variableOffsets[Zs].anchor),this.variableOffsets[Zs]={textOffset:na,width:Oe,height:Fe,anchor:F,textScale:je,prevAnchor:Le},this.markUsedJustification(Xn,F,wi,Yn),Xn.allowVerticalPlacement&&(this.markUsedOrientation(Xn,Yn,wi),this.placedOrientations[Zs]=Yn),{shift:el,placedGlyphBoxes:nl}}}placeLayerBucketPart(Le,Oe,Fe,je,qe=1){const{bucket:He,layout:xt,paint:jt,posMatrix:Gt,textLabelPlaneMatrix:bi,labelToScreenMatrix:wi,clippingData:qr,textPixelRatio:Xn,holdingForFade:Yn,collisionBoxArray:yo,partiallyEvaluatedTextSize:bo,partiallyEvaluatedIconSize:Do,collisionGroup:Ro,latestFeatureIndex:zs}=Le.parameters,Zs=xt.get("text-optional"),na=xt.get("icon-optional"),el=xt.get("text-allow-overlap"),nl=xt.get("icon-allow-overlap"),hl="map"===xt.get("text-rotation-alignment"),pl="map"===xt.get("text-pitch-alignment"),bl=jt.get("symbol-z-offset"),Tl="sea"===xt.get("symbol-elevation-reference"),[kl,ec]=xt.get("text-size-scale-range"),[tc,ic]=xt.get("icon-size-scale-range"),oc=F.ay(qe,kl,ec),sc=F.ay(qe,tc,ic);this.transform.setProjection(He.projection);let ac=el&&(nl||!He.hasIconData()||na),mc=nl&&(el||!He.hasTextData()||Zs);const gc=!bl.isConstant();!He.collisionArrays&&yo&&He.deserializeCollisionBoxes(yo),Fe&&je&&He.updateCollisionDebugBuffers(this.transform.zoom,yo,oc,sc);const k=(Le,je,jt)=>{const{crossTileID:yo,numVerticalGlyphVertices:kl}=Le;let ec=null;if(qr&&qr.dynamicFilterNeedsFeature||gc){const F=this.retainedQueryData[He.bucketInstanceId];ec=zs.loadFeature({featureIndex:Le.featureIndex,bucketIndex:F.bucketIndex,sourceLayerIndex:F.sourceLayerIndex,layoutVertexArrayOffset:0})}if(qr&&!(0,qr.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},ec,this.retainedQueryData[He.bucketInstanceId].tileID.canonical,new F.P(Le.tileAnchorX,Le.tileAnchorY),this.transform.calculateDistanceTileData(qr.unwrappedTileID)))return this.placements[yo]=new ui(!1,!1,!1,!0),void Oe.add(yo);const tc=bl.evaluate(ec,{});if(Oe.has(yo))return;if(Yn)return void(this.placements[yo]=new ui(!1,!1,!1));let ic=!1,oc=!1,sc=!0,yc=!1,xc=!1,Zc=null,Wc={box:null,offscreen:null,occluded:null},Kc={box:null,offscreen:null,occluded:null},Jc=null,Qc=null,eh=null,th=0,rh=0,oh=0;jt.textFeatureIndex?th=jt.textFeatureIndex:Le.useRuntimeCollisionCircles&&(th=Le.featureIndex),jt.verticalTextFeatureIndex&&(rh=jt.verticalTextFeatureIndex);const $=F=>{F.tileID=this.retainedQueryData[He.bucketInstanceId].tileID;const Oe=this.transform.elevation;F.elevation=Tl?tc:tc+(Oe?Oe.getAtTileOffset(F.tileID,F.tileAnchorX,F.tileAnchorY):0),F.elevation+=Le.zOffset},ah=jt.textBox;if(ah){$(ah);const i=Oe=>{let Fe=F.bq.horizontal;if(He.allowVerticalPlacement&&!Oe&&this.prevPlacement){const F=this.prevPlacement.placedOrientations[yo];F&&(this.placedOrientations[yo]=F,Fe=F,this.markUsedOrientation(He,Fe,Le))}return Fe},o=(Le,Oe)=>{if(He.allowVerticalPlacement&&kl>0&&jt.verticalTextBox){for(const Fe of He.writingModes)if(Fe===F.bq.vertical?(Wc=Oe(),Kc=Wc):Wc=Le(),Wc&&Wc.box&&Wc.box.length)break}else Wc=Le()};if(xt.get("text-variable-anchor")){let Oe=xt.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[yo]){const F=this.prevPlacement.variableOffsets[yo];Oe.indexOf(F.anchor)>0&&(Oe=Oe.filter((Le=>Le!==F.anchor)),Oe.unshift(F.anchor))}const h=(F,Fe,qe)=>{const xt=He.getSymbolInstanceTextSize(bo,Le,this.transform.zoom,je),jt=(F.x2-F.x1)*xt+2*F.padding,bi=(F.y2-F.y1)*xt+2*F.padding,wi=Le.hasIconTextFit&&!nl?Fe:null;wi&&$(wi);let qr={box:[],offscreen:!1,occluded:!1};const Yn=el?2*Oe.length:Oe.length;for(let Fe=0;Fe<Yn;++Fe){const Yn=this.attemptAnchorPlacement(Oe[Fe%Oe.length],F,jt,bi,xt,hl,pl,Xn,Gt,Ro,Fe>=Oe.length,Le,je,He,qe,wi,bo,Do);if(Yn&&(qr=Yn.placedGlyphBoxes,qr&&qr.box&&qr.box.length)){ic=!0,Zc=Yn.shift;break}}return qr};o((()=>h(ah,jt.iconBox,F.bq.horizontal)),(()=>{const Le=jt.verticalTextBox;return Le&&$(Le),He.allowVerticalPlacement&&!(Wc&&Wc.box&&Wc.box.length)&&kl>0&&Le?h(Le,jt.verticalIconBox,F.bq.vertical):{box:null,offscreen:null,occluded:null}})),Wc&&(ic=Wc.box,sc=Wc.offscreen,yc=Wc.occluded);const Fe=i(!(!Wc||!Wc.box));if(!ic&&this.prevPlacement){const F=this.prevPlacement.variableOffsets[yo];F&&(this.variableOffsets[yo]=F,this.markUsedJustification(He,F.anchor,Le,Fe))}}else{const a=(Oe,Fe)=>{const xt=He.getSymbolInstanceTextSize(bo,Le,this.transform.zoom,je,qe),jt=this.collisionIndex.placeCollisionBox(He,xt,Oe,new F.P(0,0),el,Xn,Gt,Ro.predicate);return jt&&jt.box&&jt.box.length&&(this.markUsedOrientation(He,Fe,Le),this.placedOrientations[yo]=Fe),jt};o((()=>a(ah,F.bq.horizontal)),(()=>{const Le=jt.verticalTextBox;return He.allowVerticalPlacement&&kl>0&&Le?($(Le),a(Le,F.bq.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!(Wc&&Wc.box&&Wc.box.length))}}if(Jc=Wc,ic=Jc&&Jc.box&&Jc.box.length>0,sc=Jc&&Jc.offscreen,yc=Jc&&Jc.occluded,Le.useRuntimeCollisionCircles){const Oe=He.text.placedSymbolArray.get(Le.centerJustifiedTextSymbolIndex>=0?Le.centerJustifiedTextSymbolIndex:Le.verticalPlacedTextSymbolIndex),je=F.br(He.textSizeData,bo,Oe),qe=xt.get("text-padding");Qc=this.collisionIndex.placeCollisionCircles(He,el,Oe,He.lineVertexArray,He.glyphOffsetArray,je,Gt,bi,wi,Fe,pl,Ro.predicate,Le.collisionCircleDiameter*je/F.bw,qe,this.retainedQueryData[He.bucketInstanceId].tileID),ic=el||Qc.circles.length>0&&!Qc.collisionDetected,sc=sc&&Qc.offscreen,yc=Qc.occluded}if(jt.iconFeatureIndex&&(oh=jt.iconFeatureIndex),jt.iconBox){const i=Oe=>{$(Oe);const Fe=Le.hasIconTextFit&&Zc?gi(Zc.x,Zc.y,hl,pl,this.transform.angle):new F.P(0,0),je=He.getSymbolInstanceIconSize(Do,this.transform.zoom,Le.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(He,je,Oe,Fe,nl,Xn,Gt,Ro.predicate)};Kc&&Kc.box&&Kc.box.length&&jt.verticalIconBox?(eh=i(jt.verticalIconBox),oc=eh.box.length>0):(eh=i(jt.iconBox),oc=eh.box.length>0),sc=sc&&eh.offscreen,xc=eh.occluded}const lh=Zs||0===Le.numHorizontalGlyphVertices&&0===kl,hh=na||0===Le.numIconVertices;if(lh||hh?hh?lh||(oc=oc&&ic):ic=oc&&ic:oc=ic=oc&&ic,ic&&Jc&&Jc.box&&this.collisionIndex.insertCollisionBox(Jc.box,xt.get("text-ignore-placement"),He.bucketInstanceId,Kc&&Kc.box&&rh?rh:th,Ro.ID),oc&&eh&&this.collisionIndex.insertCollisionBox(eh.box,xt.get("icon-ignore-placement"),He.bucketInstanceId,oh,Ro.ID),Qc&&(ic&&this.collisionIndex.insertCollisionCircles(Qc.circles,xt.get("text-ignore-placement"),He.bucketInstanceId,th,Ro.ID),Fe)){const F=He.bucketInstanceId;let Le=this.collisionCircleArrays[F];void 0===Le&&(Le=this.collisionCircleArrays[F]=new _i);for(let F=0;F<Qc.circles.length;F+=4)Le.circles.push(Qc.circles[F+0]),Le.circles.push(Qc.circles[F+1]),Le.circles.push(Qc.circles[F+2]),Le.circles.push(Qc.collisionDetected?1:0)}const ph="globe"!==He.projection.name;ac=ac&&(ph||!yc),mc=mc&&(ph||!xc),this.placements[yo]=new ui(ic||ac,oc||mc,sc||He.justReloaded),Oe.add(yo)};if("offset"===He.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(He,this.retainedQueryData[He.bucketInstanceId].tileID),"road"===He.elevationType&&He.updateRoadElevation(),He.updateZOffset(),He.sortFeaturesByY){const Le=He.getSortedSymbolIndexes(this.transform.angle);for(let F=Le.length-1;F>=0;--F){const Oe=Le[F];k(He.symbolInstances.get(Oe),Oe,He.collisionArrays[Oe])}He.hasAnyZOffset&&F.w(`${He.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(He.hasAnyZOffset){const F=He.getSortedIndexesByZOffset();for(let Le=0;Le<F.length;++Le){const Oe=F[Le];k(He.symbolInstances.get(Oe),Oe,He.collisionArrays[Oe])}}else for(let F=Le.symbolInstanceStart;F<Le.symbolInstanceEnd;F++)k(He.symbolInstances.get(F),F,He.collisionArrays[F]);if(Fe&&He.bucketInstanceId in this.collisionCircleArrays){const Le=this.collisionCircleArrays[He.bucketInstanceId];F.ad.mat4.invert(Le.invProjMatrix,Gt),Le.viewportMatrix=this.collisionIndex.getViewportMatrix()}He.justReloaded=!1}markUsedJustification(Le,Oe,Fe,je){const{leftJustifiedTextSymbolIndex:qe,centerJustifiedTextSymbolIndex:He,rightJustifiedTextSymbolIndex:xt,verticalPlacedTextSymbolIndex:jt,crossTileID:Gt}=Fe,bi=F.bB(Oe),wi=je===F.bq.vertical?jt:"left"===bi?qe:"center"===bi?He:"right"===bi?xt:-1;qe>=0&&(Le.text.placedSymbolArray.get(qe).crossTileID=wi>=0&&qe!==wi?0:Gt),He>=0&&(Le.text.placedSymbolArray.get(He).crossTileID=wi>=0&&He!==wi?0:Gt),xt>=0&&(Le.text.placedSymbolArray.get(xt).crossTileID=wi>=0&&xt!==wi?0:Gt),jt>=0&&(Le.text.placedSymbolArray.get(jt).crossTileID=wi>=0&&jt!==wi?0:Gt)}markUsedOrientation(Le,Oe,Fe){const je=Oe===F.bq.horizontal||Oe===F.bq.horizontalOnly?Oe:0,qe=Oe===F.bq.vertical?Oe:0,{leftJustifiedTextSymbolIndex:He,centerJustifiedTextSymbolIndex:xt,rightJustifiedTextSymbolIndex:jt,verticalPlacedTextSymbolIndex:Gt}=Fe,bi=Le.text.placedSymbolArray;He>=0&&(bi.get(He).placedOrientation=je),xt>=0&&(bi.get(xt).placedOrientation=je),jt>=0&&(bi.get(jt).placedOrientation=je),Gt>=0&&(bi.get(Gt).placedOrientation=qe)}commit(F){this.commitTime=F,this.zoomAtLastRecencyCheck=this.transform.zoom;const Le=this.prevPlacement;let Oe=!1;this.prevZoomAdjustment=Le?Le.zoomAdjustment(this.transform.zoom):0;const Fe=Le?Le.symbolFadeChange(F):1,je=Le?Le.opacities:{},qe=Le?Le.variableOffsets:{},He=Le?Le.placedOrientations:{};for(const F in this.placements){const Le=this.placements[F],qe=je[F];qe?(this.opacities[F]=new di(qe,Fe,Le.text,Le.icon,null,Le.clipped),Oe=Oe||Le.text!==qe.text.placed||Le.icon!==qe.icon.placed):(this.opacities[F]=new di(null,Fe,Le.text,Le.icon,Le.skipFade,Le.clipped),Oe=Oe||Le.text||Le.icon)}for(const F in je){const Le=je[F];if(!this.opacities[F]){const je=new di(Le,Fe,!1,!1);je.isHidden()||(this.opacities[F]=je,Oe=Oe||Le.text.placed||Le.icon.placed)}}for(const F in qe)this.variableOffsets[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.variableOffsets[F]=qe[F]);for(const F in He)this.placedOrientations[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.placedOrientations[F]=He[F]);Oe?this.lastPlacementChangeTime=F:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=Le?Le.lastPlacementChangeTime:F)}updateLayerOpacities(F,Le,Oe,Fe){const je=new Set;for(const qe of Le){const Le=qe.getBucket(F);Le&&qe.latestFeatureIndex&&F.fqid===Le.layerIds[0]&&(this.updateBucketOpacities(Le,je,qe,qe.collisionBoxArray,Oe,Fe,qe.tileID,F.scope),"offset"===Le.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(Le,qe.tileID),"road"===Le.elevationType&&Le.updateRoadElevation(),Le.updateZOffset())}}updateBucketOpacities(Le,Oe,Fe,je,qe,He,xt,jt){Le.hasTextData()&&Le.text.opacityVertexArray.clear(),Le.hasIconData()&&Le.icon.opacityVertexArray.clear(),Le.hasIconCollisionBoxData()&&Le.iconCollisionBox.collisionVertexArray.clear(),Le.hasTextCollisionBoxData()&&Le.textCollisionBox.collisionVertexArray.clear();const Gt=Le.layers[0].layout,bi=Le.layers[0].paint,wi=!!Le.layers[0].dynamicFilter(),qr=new di(null,0,!1,!1,!0),Xn=Gt.get("text-allow-overlap"),Yn=Gt.get("icon-allow-overlap"),yo=Gt.get("text-variable-anchor"),bo="map"===Gt.get("text-rotation-alignment"),Do="map"===Gt.get("text-pitch-alignment"),Ro=bi.get("symbol-z-offset"),zs="sea"===Gt.get("symbol-elevation-reference"),Zs=!Ro.isConstant(),na=new di(null,0,Xn&&(Yn||!Le.hasIconData()||Gt.get("icon-optional")),Yn&&(Xn||!Le.hasTextData()||Gt.get("text-optional")),!0);!Le.collisionArrays&&je&&(Le.hasIconCollisionBoxData()||Le.hasTextCollisionBoxData())&&Le.deserializeCollisionBoxes(je);const w=(F,Le,Oe)=>{for(let Fe=0;Fe<Le/4;Fe++)F.opacityVertexArray.emplaceBack(Oe)};let el=0;He&&Le.updateReplacement(xt,He);for(let je=0;je<Le.symbolInstances.length;je++){const Gt=Le.symbolInstances.get(je),{numHorizontalGlyphVertices:bi,numVerticalGlyphVertices:Xn,crossTileID:Yn,numIconVertices:nl,tileAnchorX:hl,tileAnchorY:pl}=Gt;let bl=null;const Tl=this.retainedQueryData[Le.bucketInstanceId];Zs&&Gt&&Tl&&(bl=Fe.latestFeatureIndex.loadFeature({featureIndex:Gt.featureIndex,bucketIndex:Tl.bucketIndex,sourceLayerIndex:Tl.sourceLayerIndex,layoutVertexArrayOffset:0}));const kl=Ro.evaluate(bl,{}),ec=Oe.has(Yn);let tc=this.opacities[Yn];ec?tc=qr:tc||(tc=na,this.opacities[Yn]=tc),Oe.add(Yn);const ic=bi>0||Xn>0,oc=nl>0,sc=this.placedOrientations[Yn],ac=sc===F.bq.vertical,mc=sc===F.bq.horizontal||sc===F.bq.horizontalOnly;!ic&&!oc||tc.isHidden()||el++;let gc=!1;if((ic||oc)&&He)for(const Oe of Le.activeReplacements){if(F.bx(Oe,qe,F.by.Symbol,jt))continue;if(Oe.min.x>hl||hl>Oe.max.x||Oe.min.y>pl||pl>Oe.max.y)continue;const Le=F.bz(hl,pl,xt.canonical,Oe.footprintTileId.canonical);if(gc=F.bA(Le,Oe.footprint),gc)break}if(ic){const F=gc?Ch:Ii(tc.text);w(Le.text,bi,ac?Ch:F),w(Le.text,Xn,mc?Ch:F);const Oe=tc.text.isHidden(),{leftJustifiedTextSymbolIndex:Fe,centerJustifiedTextSymbolIndex:je,rightJustifiedTextSymbolIndex:qe,verticalPlacedTextSymbolIndex:He}=Gt,xt=Le.text.placedSymbolArray,jt=Oe||ac?1:0;Fe>=0&&(xt.get(Fe).hidden=jt),je>=0&&(xt.get(je).hidden=jt),qe>=0&&(xt.get(qe).hidden=jt),He>=0&&(xt.get(He).hidden=Oe||mc?1:0);const wi=this.variableOffsets[Yn];wi&&this.markUsedJustification(Le,wi.anchor,Gt,sc);const qr=this.placedOrientations[Yn];qr&&(this.markUsedJustification(Le,"left",Gt,qr),this.markUsedOrientation(Le,qr,Gt))}if(oc){const F=gc?Ch:Ii(tc.icon),{placedIconSymbolIndex:Oe,verticalPlacedIconSymbolIndex:Fe}=Gt,je=Le.icon.placedSymbolArray,qe=tc.icon.isHidden()?1:0;Oe>=0&&(w(Le.icon,nl,ac?Ch:F),je.get(Oe).hidden=qe),Fe>=0&&(w(Le.icon,Gt.numVerticalIconVertices,mc?Ch:F),je.get(Fe).hidden=qe)}if(Le.hasIconCollisionBoxData()||Le.hasTextCollisionBoxData()){const Oe=Le.collisionArrays[je];if(Oe){let Fe=new F.P(0,0),je=!0;if(Oe.textBox||Oe.verticalTextBox){if(yo){const F=this.variableOffsets[Yn];F?(Fe=mi(F.anchor,F.width,F.height,F.textOffset,F.textScale),bo&&Fe._rotate(Do?this.transform.angle:-this.transform.angle)):je=!1}wi&&(je=!tc.clipped),Oe.textBox&&yi(Le.textCollisionBox.collisionVertexArray,tc.text.placed,!je||ac,kl,zs,Fe.x,Fe.y),Oe.verticalTextBox&&yi(Le.textCollisionBox.collisionVertexArray,tc.text.placed,!je||mc,kl,zs,Fe.x,Fe.y)}const qe=je&&Boolean(!mc&&Oe.verticalIconBox);Oe.iconBox&&yi(Le.iconCollisionBox.collisionVertexArray,tc.icon.placed,qe,kl,zs,Gt.hasIconTextFit?Fe.x:0,Gt.hasIconTextFit?Fe.y:0),Oe.verticalIconBox&&yi(Le.iconCollisionBox.collisionVertexArray,tc.icon.placed,!qe,kl,zs,Gt.hasIconTextFit?Fe.x:0,Gt.hasIconTextFit?Fe.y:0)}}}if(Le.fullyClipped=0===el,Le.sortFeatures(this.transform.angle),this.retainedQueryData[Le.bucketInstanceId]&&(this.retainedQueryData[Le.bucketInstanceId].featureSortOrder=Le.featureSortOrder),Le.hasTextData()&&Le.text.opacityVertexBuffer&&Le.text.opacityVertexBuffer.updateData(Le.text.opacityVertexArray),Le.hasIconData()&&Le.icon.opacityVertexBuffer&&Le.icon.opacityVertexBuffer.updateData(Le.icon.opacityVertexArray),Le.hasIconCollisionBoxData()&&Le.iconCollisionBox.collisionVertexBuffer&&Le.iconCollisionBox.collisionVertexBuffer.updateData(Le.iconCollisionBox.collisionVertexArray),Le.hasTextCollisionBoxData()&&Le.textCollisionBox.collisionVertexBuffer&&Le.textCollisionBox.collisionVertexBuffer.updateData(Le.textCollisionBox.collisionVertexArray),Le.bucketInstanceId in this.collisionCircleArrays){const F=this.collisionCircleArrays[Le.bucketInstanceId];Le.placementInvProjMatrix=F.invProjMatrix,Le.placementViewportMatrix=F.viewportMatrix,Le.collisionCircleArray=F.circles,delete this.collisionCircleArrays[Le.bucketInstanceId]}}symbolFadeChange(F){return 0===this.fadeDuration?1:(F-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(F){return Math.max(0,(this.transform.zoom-F)/1.5)}hasTransitions(F){return this.stale||F-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(F,Le){const Oe=this.zoomAtLastRecencyCheck===Le?1-this.zoomAdjustment(Le):1;return this.zoomAtLastRecencyCheck=Le,this.commitTime+this.fadeDuration*Oe>F}setStale(){this.stale=!0}}function yi(F,Le,Oe,Fe,je,qe,He){F.emplaceBack(Le?1:0,Oe?1:0,qe||0,He||0,Fe,je?1:0),F.emplaceBack(Le?1:0,Oe?1:0,qe||0,He||0,Fe,je?1:0),F.emplaceBack(Le?1:0,Oe?1:0,qe||0,He||0,Fe,je?1:0),F.emplaceBack(Le?1:0,Oe?1:0,qe||0,He||0,Fe,je?1:0)}const hh=Math.pow(2,25),ph=Math.pow(2,24),wh=Math.pow(2,17),Th=Math.pow(2,16),Mh=Math.pow(2,9),Ah=Math.pow(2,8),Ih=Math.pow(2,1);function Ii(F){if(0===F.opacity&&!F.placed)return 0;if(1===F.opacity&&F.placed)return 4294967295;const Le=F.placed?1:0,Oe=Math.floor(127*F.opacity);return Oe*hh+Le*ph+Oe*wh+Le*Th+Oe*Mh+Le*Ah+Oe*Ih+Le}const Ch=0;class Di{constructor(F){this._sortAcrossTiles="viewport-y"!==F.layout.get("symbol-z-order")&&void 0!==F.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(F,Le,Oe,Fe,je,qe){const He=this._bucketParts;for(;this._currentTileIndex<F.length;)if(Le.getBucketParts(He,Fe,F[this._currentTileIndex],this._sortAcrossTiles,qe),this._currentTileIndex++,je())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,He.sort(((F,Le)=>F.sortKey-Le.sortKey)));this._currentPartIndex<He.length;){const F=He[this._currentPartIndex];if(Le.placeLayerBucketPart(F,this._seenCrossTileIDs,Oe,0===F.symbolInstanceStart,qe),this._currentPartIndex++,je())return!0}return!1}}class Ai{constructor(F,Le,Oe,Fe,je,qe,He,xt,jt){this.placement=new vi(F,je,qe,He,xt,jt),this._currentPlacementIndex=Le.length-1,this._forceFullPlacement=Oe,this._showCollisionBoxes=Fe,this._done=!1}isDone(){return this._done}continuePlacement(Le,Oe,Fe,je,qe){const He=F.q.now(),a=()=>{const Le=F.q.now()-He;return!this._forceFullPlacement&&Le>2};for(;this._currentPlacementIndex>=0;){const He=Oe[Le[this._currentPlacementIndex]],xt=this.placement.collisionIndex.transform.zoom;if("symbol"===He.type&&(!He.minzoom||He.minzoom<=xt)&&(!He.maxzoom||He.maxzoom>xt)){const Le=He,Oe=Le.layout.get("symbol-z-elevate"),xt=void 0!==Le.layout.get("symbol-sort-key").constantOr(1),jt=Le.layout.get("symbol-z-order"),Gt="viewport-y"===jt||"auto"===jt&&!("viewport-y"!==jt&&xt),bi=Le.layout.get("text-allow-overlap")||Le.layout.get("icon-allow-overlap")||Le.layout.get("text-ignore-placement")||Le.layout.get("icon-ignore-placement"),wi=Gt&&bi,qr=this._inProgressLayer=this._inProgressLayer||new Di(Le),Xn=F.C(He.source,He.scope);if(qr.continuePlacement(Oe||wi?je[Xn]:Fe[Xn],this.placement,this._showCollisionBoxes,He,a,qe))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(F){return this.placement.commit(F),this.placement}}const zh=512/F.ai/2;class Mi{constructor(Le,Oe,Fe){this.tileID=Le,this.bucketInstanceId=Fe,this.index=new F.bE(Oe.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const je=Le.canonical.x*F.ai,qe=Le.canonical.y*F.ai;for(let F=0;F<Oe.length;F++){const{key:Le,crossTileID:Fe,tileAnchorX:He,tileAnchorY:xt}=Oe.get(F),jt=Math.floor((je+He)*zh),Gt=Math.floor((qe+xt)*zh);this.index.add(jt,Gt),this.keys.push(Le),this.crossTileIDs.push(Fe)}this.index.finish()}findMatches(Le,Oe,Fe){const je=this.tileID.canonical.z<Oe.canonical.z?1:Math.pow(2,this.tileID.canonical.z-Oe.canonical.z),qe=zh/Math.pow(2,Oe.canonical.z-this.tileID.canonical.z),He=Oe.canonical.x*F.ai,xt=Oe.canonical.y*F.ai;for(let F=0;F<Le.length;F++){const Oe=Le.get(F);if(Oe.crossTileID)continue;const{key:jt,tileAnchorX:Gt,tileAnchorY:bi}=Oe,wi=Math.floor((He+Gt)*qe),qr=Math.floor((xt+bi)*qe),Xn=this.index.range(wi-je,qr-je,wi+je,qr+je);for(const F of Xn){const Le=this.crossTileIDs[F];if(this.keys[F]===jt&&!Fe.has(Le)){Fe.add(Le),Oe.crossTileID=Le;break}}}}}class Pi{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class zi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(F){const Le=Math.round((F-this.lng)/360);if(0!==Le)for(const F in this.indexes){const Oe=this.indexes[F],Fe={};for(const F in Oe){const je=Oe[F];je.tileID=je.tileID.unwrapTo(je.tileID.wrap+Le),Fe[je.tileID.key]=je}this.indexes[F]=Fe}this.lng=F}addBucket(F,Le,Oe){if(this.indexes[F.overscaledZ]&&this.indexes[F.overscaledZ][F.key]){if(this.indexes[F.overscaledZ][F.key].bucketInstanceId===Le.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(F.overscaledZ,this.indexes[F.overscaledZ][F.key])}for(let F=0;F<Le.symbolInstances.length;F++)Le.symbolInstances.get(F).crossTileID=0;this.usedCrossTileIDs[F.overscaledZ]||(this.usedCrossTileIDs[F.overscaledZ]=new Set);const Fe=this.usedCrossTileIDs[F.overscaledZ];for(const Oe in this.indexes){const je=this.indexes[Oe];if(Number(Oe)>F.overscaledZ)for(const Oe in je){const qe=je[Oe];qe.tileID.isChildOf(F)&&qe.findMatches(Le.symbolInstances,F,Fe)}else{const qe=je[F.scaledTo(Number(Oe)).key];qe&&qe.findMatches(Le.symbolInstances,F,Fe)}}for(let F=0;F<Le.symbolInstances.length;F++){const je=Le.symbolInstances.get(F);je.crossTileID||(je.crossTileID=Oe.generate(),Fe.add(je.crossTileID))}return void 0===this.indexes[F.overscaledZ]&&(this.indexes[F.overscaledZ]={}),this.indexes[F.overscaledZ][F.key]=new Mi(F,Le.symbolInstances,Le.bucketInstanceId),!0}removeBucketCrossTileIDs(F,Le){for(const Oe of Le.crossTileIDs)this.usedCrossTileIDs[F].delete(Oe)}removeStaleBuckets(F){let Le=!1;for(const Oe in this.indexes){const Fe=this.indexes[Oe];for(const je in Fe)F[Fe[je].bucketInstanceId]||(this.removeBucketCrossTileIDs(Oe,Fe[je]),delete Fe[je],Le=!0)}return Le}}class Oi{constructor(){this.layerIndexes={},this.crossTileIDs=new Pi,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(F,Le,Oe,Fe){let je=this.layerIndexes[F.fqid];void 0===je&&(je=this.layerIndexes[F.fqid]=new zi);let qe=!1;const He={};"globe"!==Fe.name&&je.handleWrapJump(Oe);for(const Oe of Le){const Le=Oe.getBucket(F);Le&&F.fqid===Le.layerIds[0]&&(Le.bucketInstanceId||(Le.bucketInstanceId=++this.maxBucketInstanceId),je.addBucket(Oe.tileID,Le,this.crossTileIDs)&&(qe=!0),He[Le.bucketInstanceId]=!0)}return je.removeStaleBuckets(He)&&(qe=!0),qe}pruneUnusedLayers(F){const Le={};F.forEach((F=>{Le[F]=!0}));for(const F in this.layerIndexes)Le[F]||delete this.layerIndexes[F]}}const Dh=771;class ki{constructor(F,Le,Oe,Fe){this.blendFunction=F,this.blendColor=Le,this.mask=Oe,this.blendEquation=Fe}}ki.Replace=[1,0,1,0],ki.disabled=new ki(ki.Replace,F.al.transparent,[!1,!1,!1,!1]),ki.unblended=new ki(ki.Replace,F.al.transparent,[!0,!0,!0,!0]),ki.alphaBlended=new ki([1,Dh,1,Dh],F.al.transparent,[!0,!0,!0,!0]),ki.alphaBlendedNonPremultiplied=new ki([770,Dh,770,Dh],F.al.transparent,[!0,!0,!0,!0]),ki.multiply=new ki([774,0,774,0],F.al.transparent,[!0,!0,!0,!0]);class Bi{constructor(F,Le,Oe){this.func=F,this.mask=Le,this.range=Oe}}Bi.ReadOnly=!1,Bi.ReadWrite=!0,Bi.disabled=new Bi(519,Bi.ReadOnly,[0,1]);const kh=7680;class Ui{constructor(F,Le,Oe,Fe,je,qe){this.test=F,this.ref=Le,this.mask=Oe,this.fail=Fe,this.depthFail=je,this.pass=qe}}Ui.disabled=new Ui({func:519,mask:0},0,0,kh,kh,kh);const Bh=1029,Vh=2305;class ji{constructor(F,Le,Oe){this.enable=F,this.mode=Le,this.frontFace=Oe}}function qi(Le,Oe){const Fe=F.bG(Le,3);F.ad.mat4.fromQuat(Le,Oe),F.bI(Le,3,Fe)}function Hi(Le,Oe){const Fe=F.ad.quat.identity([]);return F.ad.quat.rotateZ(Fe,Fe,-Oe),F.ad.quat.rotateX(Fe,Fe,-Le),Fe}function Zi(Le,Oe){const Fe=[Le[0],Le[1],0],je=[Oe[0],Oe[1],0];if(F.ad.vec3.length(Fe)>=1e-15){const Le=F.ad.vec3.normalize([],Fe);F.ad.vec3.scale(je,Le,F.ad.vec3.dot(je,Le)),Oe[0]=je[0],Oe[1]=je[1]}const qe=F.ad.vec3.cross([],Oe,Le);if(F.ad.vec3.len(qe)<1e-15)return null;const He=Math.atan2(-qe[1],qe[0]);return Hi(Math.atan2(Math.sqrt(Le[0]*Le[0]+Le[1]*Le[1]),-Le[2]),He)}ji.disabled=new ji(!1,Bh,Vh),ji.backCCW=new ji(!0,Bh,Vh),ji.backCW=new ji(!0,Bh,2304),ji.frontCW=new ji(!0,1028,2304),ji.frontCCW=new ji(!0,1028,Vh);class Wi{constructor(F,Le){this.position=F,this.orientation=Le}get position(){return this._position}set position(Le){if(Le){const Oe=Le instanceof F.ac?Le:new F.ac(Le[0],Le[1],Le[2]);this._renderWorldCopies&&(Oe.x=F.bF(Oe.x,0,1)),this._position=Oe}else this._position=null}lookAtPoint(Le,Oe){if(this.orientation=null,!this.position)return;const Fe=this.position,je=this._elevation?this._elevation.getAtPointOrZero(F.ac.fromLngLat(Le)):0,qe=F.ac.fromLngLat(Le,je),He=[qe.x-Fe.x,qe.y-Fe.y,qe.z-Fe.z];Oe||(Oe=[0,0,1]),Oe[2]=Math.abs(Oe[2]),this.orientation=Zi(He,Oe)}setPitchBearing(Le,Oe){this.orientation=Hi(F.ak(Le),F.ak(-Oe))}}class $i{constructor(Le,Oe){this._transform=F.ad.mat4.identity([]),this.orientation=Oe,this.position=Le}get mercatorPosition(){const Le=this.position;return new F.ac(Le[0],Le[1],Le[2])}get position(){const Le=F.bG(this._transform,3);return[Le[0],Le[1],Le[2]]}set position(Le){var Oe;Le&&F.bI(this._transform,3,[(Oe=Le)[0],Oe[1],Oe[2],1])}get orientation(){return this._orientation}set orientation(Le){this._orientation=Le||F.ad.quat.identity([]),Le&&qi(this._transform,this._orientation)}getPitchBearing(){const F=this.forward(),Le=this.right();return{bearing:Math.atan2(-Le[1],Le[0]),pitch:Math.atan2(Math.sqrt(F[0]*F[0]+F[1]*F[1]),-F[2])}}setPitchBearing(F,Le){this._orientation=Hi(F,Le),qi(this._transform,this._orientation)}forward(){const Le=F.bG(this._transform,2);return[-Le[0],-Le[1],-Le[2]]}up(){const Le=F.bG(this._transform,1);return[-Le[0],-Le[1],-Le[2]]}right(){const Le=F.bG(this._transform,0);return[Le[0],Le[1],Le[2]]}getCameraToWorld(Le,Oe){const Fe=new Float64Array(16);return F.ad.mat4.invert(Fe,this.getWorldToCamera(Le,Oe)),Fe}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(Le,Oe,Fe){const je=this.position;F.ad.vec3.scale(je,je,-Le);const qe=new Float64Array(16);return F.ad.mat4.fromScaling(qe,[Fe,Fe,Fe]),F.ad.mat4.translate(qe,qe,je),qe[10]*=Oe,qe}getWorldToCamera(Le,Oe){const Fe=new Float64Array(16),je=new Float64Array(4),qe=this.position;return F.ad.quat.conjugate(je,this._orientation),F.ad.vec3.scale(qe,qe,-Le),F.ad.mat4.fromQuat(Fe,je),F.ad.mat4.translate(Fe,Fe,qe),Fe[1]*=-1,Fe[5]*=-1,Fe[9]*=-1,Fe[13]*=-1,Fe[8]*=Oe,Fe[9]*=Oe,Fe[10]*=Oe,Fe[11]*=Oe,Fe}getCameraToClipPerspective(Le,Oe,Fe,je){const qe=new Float64Array(16);return F.ad.mat4.perspective(qe,Le,Oe,Fe,je),qe}getCameraToClipOrthographic(Le,Oe,Fe,je,qe,He){const xt=new Float64Array(16);return F.ad.mat4.ortho(xt,Le,Oe,Fe,je,qe,He),xt}getDistanceToElevation(Le,Oe=!1){const Fe=0===Le?0:F.bH(Le,Oe?F.aT(this.position[1]):this.position[1]),je=this.forward();return(Fe-this.position[2])/je[2]}clone(){return new $i([...this.position],[...this.orientation])}}const Uh={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Ki{constructor(F=0,Le=0,Oe=0,Fe=0){if(isNaN(F)||F<0||isNaN(Le)||Le<0||isNaN(Oe)||Oe<0||isNaN(Fe)||Fe<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=F,this.bottom=Le,this.left=Oe,this.right=Fe}interpolate(Le,Oe,Fe){return null!=Oe.top&&null!=Le.top&&(this.top=F.ah(Le.top,Oe.top,Fe)),null!=Oe.bottom&&null!=Le.bottom&&(this.bottom=F.ah(Le.bottom,Oe.bottom,Fe)),null!=Oe.left&&null!=Le.left&&(this.left=F.ah(Le.left,Oe.left,Fe)),null!=Oe.right&&null!=Le.right&&(this.right=F.ah(Le.right,Oe.right,Fe)),this}getCenter(Le,Oe){const Fe=F.ay((this.left+Le-this.right)/2,0,Le),je=F.ay((this.top+Oe-this.bottom)/2,0,Oe);return new F.P(Fe,je)}equals(F){return this.top===F.top&&this.bottom===F.bottom&&this.left===F.left&&this.right===F.right}clone(){return new Ki(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Qh=15;class Ji{constructor(Le,Oe,Fe,je,qe,He,xt){this.tileSize=512,this._renderWorldCopies=void 0===qe||qe,this._minZoom=Le||0,this._maxZoom=Oe||22,this._minPitch=Fe??0,this._maxPitch=je??60,this.setProjection(He),this.setMaxBounds(xt),this.width=0,this.height=0,this._center=new F.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ki,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new $i,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const F=new Ji(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return F._elevation=this._elevation,F._centerAltitude=this._centerAltitude,F._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,F.tileSize=this.tileSize,F.mercatorFromTransition=this.mercatorFromTransition,F.width=this.width,F.height=this.height,F.cameraElevationReference=this.cameraElevationReference,F._center=this._center,F._setZoom(this.zoom),F._seaLevelZoom=this._seaLevelZoom,F.angle=this.angle,F._fov=this._fov,F._pitch=this._pitch,F._nearZ=this._nearZ,F._farZ=this._farZ,F._averageElevation=this._averageElevation,F._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,F._unmodified=this._unmodified,F._edgeInsets=this._edgeInsets.clone(),F._camera=this._camera.clone(),F._calcMatrices(),F.freezeTileCoverage=this.freezeTileCoverage,F.frustumCorners=this.frustumCorners,F._allowWorldUnderZoom=this._allowWorldUnderZoom,F}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<Qh}get elevation(){return this._elevation}set elevation(F){this._elevation!==F&&(this._elevation=F,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(F,Le=!1){const Oe=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||Oe)&&this._updateCameraOnTerrain(),(F||Oe)&&this._constrainCamera(Le),this._calcMatrices()}getProjection(){return F.aA(this.projection,["name","center","parallels"])}setProjection(Le){this.projectionOptions=Le||{name:"mercator"};const Oe=this.projection?this.getProjection():void 0;this.projection=F.bP(this.projectionOptions);const Fe=this.getProjection(),je=!F.bn(Oe,Fe);return je&&this._calcMatrices(),this.mercatorFromTransition=!1,je}setOrthographicProjectionAtLowPitch(F){return this._orthographicProjectionAtLowPitch!==F&&(this._orthographicProjectionAtLowPitch=F,this._calcMatrices(),!0)}setMercatorFromTransition(){const Le=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=F.bP({name:"mercator"});const Oe=Le!==this.projection.name;return Oe&&this._calcMatrices(),Oe}get minZoom(){return this._minZoom}set minZoom(F){this._minZoom!==F&&(this._minZoom=F,this.zoom=Math.max(this.zoom,F))}get maxZoom(){return this._maxZoom}set maxZoom(F){this._maxZoom!==F&&(this._maxZoom=F,this.zoom=Math.min(this.zoom,F))}get minPitch(){return this._minPitch}set minPitch(F){this._minPitch!==F&&(this._minPitch=F,this.pitch=Math.max(this.pitch,F))}get maxPitch(){return this._maxPitch}set maxPitch(F){this._maxPitch!==F&&(this._maxPitch=F,this.pitch=Math.min(this.pitch,F))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(F){void 0===F?F=!0:null===F&&(F=!1),this._renderWorldCopies=F}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const F=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get cameraWorldSize(){const F=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return F.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new F.P(this.width,this.height)}get bearing(){return F.bF(this.rotation,-180,180)}set bearing(F){this.rotation=F}get rotation(){return-this.angle/Math.PI*180}set rotation(Le){const Oe=-Le*Math.PI/180;this.angle!==Oe&&(this._unmodified=!1,this.angle=Oe,this._calcMatrices(),this.rotationMatrix=F.ad.mat2.create(),F.ad.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(Le){const Oe=F.ay(Le,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==Oe&&(this._unmodified=!1,this._pitch=Oe,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(Le){Le=Math.max(.01,Math.min(60,Le)),this._fov!==Le&&(this._unmodified=!1,this._fov=F.ak(Le),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const F=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/F)}get averageElevation(){return this._averageElevation}set averageElevation(F){this._averageElevation=F,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(F){const Le=Math.min(Math.max(F,this.minZoom),this.maxZoom);this._zoom!==Le&&(this._unmodified=!1,this._setZoom(Le),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(F){this._zoom=F,this.scale=this.zoomScale(F),this.tileZoom=Math.floor(F),this.zoomFraction=F-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(F){this._tileCoverLift!==F&&(this._tileCoverLift=F)}_updateCameraOnTerrain(){const F=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,Le=this.elevation&&F===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||F===Number.NEGATIVE_INFINITY&&(!Le||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const Oe=this._elevation;Le||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&Oe.exaggeration()&&this._centerAltitudeValidForExaggeration!==Oe.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*Oe.exaggeration(),this._centerAltitudeValidForExaggeration=Oe.exaggeration()):(this._centerAltitude=F||0,this._centerAltitudeValidForExaggeration=Oe.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const Le=this._elevation,Oe=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],Fe=this.horizonLineFromTop();let je=0,qe=0;for(let He=0;He<Oe.length;He++){const xt=new F.P(Oe[He][0]*this.width,Fe+Oe[He][1]*(this.height-Fe)),jt=Le.pointCoordinate(xt);if(!jt)continue;const Gt=1/Math.hypot(jt[0]-this._camera.position[0],jt[1]-this._camera.position[1]);je+=jt[3]*Gt,qe+=Gt}return 0===qe?NaN:je/qe}get center(){return this._center}set center(F){F.lat===this._center.lat&&F.lng===this._center.lng||(this._unmodified=!1,this._center=F,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const F=this._seaLevelZoom,Le=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),Oe=this.pixelsPerMeter/this.worldSize*Le,Fe=this._mercatorZfromZoom(F),je=this._mercatorZfromZoom(this._maxZoom),qe=Math.max(Fe-Oe,je);this._setZoom(this._zoomFromMercatorZ(qe))}get padding(){return this._edgeInsets.toJSON()}set padding(F){this._edgeInsets.equals(F)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,F,1),this._calcMatrices())}computeZoomRelativeTo(Le){const Oe=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,Le.toAltitude()));let Fe;Fe=Le.z<this._camera.position[2]?[Oe.x,Oe.y,Oe.z]:[Le.x,Le.y,Le.z];const je=F.ad.vec3.length(F.ad.vec3.sub([],this._camera.position,Fe));return F.ay(this._zoomFromMercatorZ(je),this._minZoom,this._maxZoom)}setFreeCameraOptions(Le){if(!this.height)return;if(!Le.position&&!Le.orientation)return;this._updateCameraState();let Oe=!1;if(Le.orientation&&!F.ad.quat.exactEquals(Le.orientation,this._camera.orientation)&&(Oe=this._setCameraOrientation(Le.orientation)),Le.position){const Fe=[Le.position.x,Le.position.y,Le.position.z];F.ad.vec3.exactEquals(Fe,this._camera.position)||(this._setCameraPosition(Fe),Oe=!0)}Oe&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const Le=this._camera.position,Oe=new Wi;return Oe.position=new F.ac(Le[0],Le[1],Le[2]),Oe.orientation=this._camera.orientation,Oe._elevation=this.elevation,Oe._renderWorldCopies=this.renderWorldCopies,Oe}_setCameraOrientation(Le){if(!F.ad.quat.length(Le))return!1;F.ad.quat.normalize(Le,Le);const Oe=F.ad.vec3.transformQuat([],[0,0,-1],Le),Fe=F.ad.vec3.transformQuat([],[0,-1,0],Le);if(Fe[2]<0)return!1;const je=Zi(Oe,Fe);return!!je&&(this._camera.orientation=je,!0)}_setCameraPosition(Le){const Oe=this.zoomScale(this.minZoom)*this.tileSize,Fe=this.zoomScale(this.maxZoom)*this.tileSize,je=this.cameraToCenterDistance;Le[2]=F.ay(Le[2],je/Fe,je/Oe),this._camera.position=Le}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(F){return this._edgeInsets.equals(F)}interpolatePadding(F,Le,Oe){this._unmodified=!1,this._edgeInsets.interpolate(F,Le,Oe),this._constrain(),this._calcMatrices()}coveringZoomLevel(F){const Le=(F.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/F.tileSize));return Math.max(0,Le)}getVisibleUnwrappedCoordinates(Le){const Oe=[new F.bQ(0,Le)];if(this.renderWorldCopies){const Fe=this.pointCoordinate(new F.P(0,0)),je=this.pointCoordinate(new F.P(this.width,0)),qe=this.pointCoordinate(new F.P(this.width,this.height)),He=this.pointCoordinate(new F.P(0,this.height)),xt=Math.floor(Math.min(Fe.x,je.x,qe.x,He.x)),jt=Math.floor(Math.max(Fe.x,je.x,qe.x,He.x)),Gt=1;for(let Fe=xt-Gt;Fe<=jt+Gt;Fe++)0!==Fe&&Oe.push(new F.bQ(Fe,Le))}return Oe}isLODDisabled(F){return(!F||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(Le,Oe,Fe){let je=[];const qe=void 0!==Fe,He=!qe;if(He&&this.zoom<Oe)return je;if(qe&&0===Fe[0]&&0===Fe[1])return je;const xt=new Set,l=(Le,Oe,Fe,qe,He)=>{const jt=F.c5(Oe,Le,Fe,qe,He);xt.has(jt)||(je.push(new F.aH(Le,Oe,Fe,qe,He)),xt.add(jt))};for(let F=0;F<Le.length;F++){const je=Le[F];if(He&&je.canonical.z!==Oe)continue;const xt=je.canonical,jt=je.overscaledZ,Gt=je.wrap,bi=1<<xt.z,wi=xt.x+1<bi,qr=xt.x>0,Xn=xt.y+1<bi,Yn=xt.y>0,yo=je.wrap-(qr?0:1),bo=je.wrap+(wi?0:1),Do=qr?xt.x-1:bi-1,Ro=wi?xt.x+1:0;if(qe)Fe[0]<0?(l(jt,bo,xt.z,Ro,xt.y),Fe[1]<0&&Xn&&(l(jt,Gt,xt.z,xt.x,xt.y+1),l(jt,bo,xt.z,Ro,xt.y+1)),Fe[1]>0&&Yn&&(l(jt,Gt,xt.z,xt.x,xt.y-1),l(jt,bo,xt.z,Ro,xt.y-1))):Fe[0]>0?(l(jt,yo,xt.z,Do,xt.y),Fe[1]<0&&Xn&&(l(jt,Gt,xt.z,xt.x,xt.y+1),l(jt,yo,xt.z,Do,xt.y+1)),Fe[1]>0&&Yn&&(l(jt,Gt,xt.z,xt.x,xt.y-1),l(jt,yo,xt.z,Do,xt.y-1))):Fe[1]<0&&Xn?l(jt,Gt,xt.z,xt.x,xt.y+1):Yn&&l(jt,Gt,xt.z,xt.x,xt.y-1);else{const F=je.visibleQuadrants;1&F&&(l(jt,yo,xt.z,Do,xt.y),Yn&&(l(jt,Gt,xt.z,xt.x,xt.y-1),l(jt,yo,xt.z,Do,xt.y-1))),2&F&&(l(jt,bo,xt.z,Ro,xt.y),Yn&&(l(jt,Gt,xt.z,xt.x,xt.y-1),l(jt,bo,xt.z,Ro,xt.y-1))),4&F&&(l(jt,yo,xt.z,Do,xt.y),Xn&&(l(jt,Gt,xt.z,xt.x,xt.y+1),l(jt,yo,xt.z,Do,xt.y+1))),8&F&&(l(jt,bo,xt.z,Ro,xt.y),Xn&&(l(jt,Gt,xt.z,xt.x,xt.y+1),l(jt,bo,xt.z,Ro,xt.y+1)))}}const jt=[];for(const F of je)je.some((Le=>F.isChildOf(Le)))||jt.push(F);if(je=jt.filter((F=>!Le.some((Le=>!!(F.overscaledZ<Oe&&Le.isChildOf(F))||F.equals(Le)||F.isChildOf(Le))))),He){const F=1<<Oe,Le="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Fe=[F*Le.x,F*Le.y],qe=4,He=qe*qe;je=je.filter((F=>{const Le=F.canonical.x+.5-Fe[0],Oe=F.canonical.y+.5-Fe[1];return Le*Le+Oe*Oe<He}))}return je}coveringTiles(Le){let Oe=this.coveringZoomLevel(Le);const Fe=Oe,je=this.elevation&&this.elevation.exaggeration(),qe=je&&!Le.isTerrainDEM,He="mercator"===this.projection.name;if(void 0!==Le.minzoom&&Oe<Le.minzoom)return[];void 0!==Le.maxzoom&&Oe>Le.maxzoom&&(Oe=Le.maxzoom);const xt=this.locationCoordinate(this.center),jt=this.center.lat,Gt=1<<Oe,bi=[Gt*xt.x,Gt*xt.y,0],wi="globe"===this.projection.name,qr=!wi,Xn=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,Oe,qr),Yn=wi?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),yo=Gt*F.bH(1,this.center.lat),bo=this._camera.position[2]/F.bH(1,this.center.lat),Do=[Gt*Yn.x,Gt*Yn.y,bo*(qr?1:yo)],Ro=wi||je,zs=this.cameraToCenterDistance/Le.tileSize*(Le.roundZoom?1:.502),Zs=this.isLODDisabled(!0)?Oe:0;let na;if(this._elevation&&Le.isTerrainDEM)na=1e4*this._elevation.exaggeration();else if(this._elevation){const F=this._elevation.getMinMaxForVisibleTiles();na=F?F.max:this._centerAltitude}else na=this._centerAltitude;const el=Le.isTerrainDEM?-na:this._elevation?this._elevation.getMinElevationBelowMSL():0,nl=this.projection.isReprojectedInTileSpace?F.bS(this):1,E=Le=>{const Oe=1/4e4,Fe=new F.ac(Le.x+Oe,Le.y,Le.z),je=new F.ac(Le.x,Le.y+Oe,Le.z),qe=Le.toLngLat(),He=Fe.toLngLat(),xt=je.toLngLat(),jt=this.locationCoordinate(qe),Gt=this.locationCoordinate(He),bi=this.locationCoordinate(xt),wi=Math.hypot(Gt.x-jt.x,Gt.y-jt.y),qr=Math.hypot(bi.x-jt.x,bi.y-jt.y);return Math.sqrt(wi*qr)*nl/Oe},S=Le=>{const Oe=na,Fe=el;return{aabb:F.bV(this,Gt,0,0,0,Le,Fe,Oe,this.projection),zoom:0,x:0,y:0,minZ:Fe,maxZ:Oe,wrap:Le,fullyVisible:!1}},hl=[];let pl=[];const bl=Oe,Tl=Le.reparseOverscaled?Fe:Oe,kl=(bo-this._centerAltitude)*yo,L=F=>{if(!this._elevation||!F.tileID||!He)return;const Le=this._elevation.getMinMaxForTile(F.tileID),Oe=F.aabb;Le?(Oe.min[2]=Le.min,Oe.max[2]=Le.max,Oe.center[2]=(Oe.min[2]+Oe.max[2])/2):(F.shouldSplit=P(F),F.shouldSplit||(Oe.min[2]=Oe.max[2]=Oe.center[2]=this._centerAltitude))},M=(F,Le)=>{if(.707*Le<F)return 1;const Oe=Le/F;return Oe/(1.4144271570014144+(Math.pow(1.1,Oe-1.4144271570014144+1)-1)/(1.1-1)-1)},P=Le=>{if(Le.zoom<Zs)return!0;if(Le.zoom===bl)return!1;if(null!=Le.shouldSplit)return Le.shouldSplit;const Oe=Le.aabb.distanceX(Do),je=Le.aabb.distanceY(Do);let xt=kl,Gt=1;if(wi){xt=Le.aabb.distanceZ(Do);const Oe=Math.pow(2,Le.zoom),Fe=F.aT((Le.y+1)/Oe),je=F.aT(Le.y/Oe),qe=Math.min(Math.max(jt,Fe),je),He=F.ca(qe)/F.ca(jt);if(Gt=qe===jt?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,He/this._mercatorScaleRatio),this.zoom<=F.c6&&Le.zoom===bl-1&&He>=.9)return!0}else if(qe&&(xt=Le.aabb.distanceZ(Do)*yo),this.projection.isReprojectedInTileSpace&&Fe<=5){const Oe=Math.pow(2,Le.zoom),Fe=E(new F.ac((Le.x+.5)/Oe,(Le.y+.5)/Oe));Gt=Fe>.85?1:Fe}if(!He){const F=Math.sqrt(Oe*Oe+je*je+xt*xt);let Fe=(1<<bl-Le.zoom)*zs*Gt;return Fe*=M(Math.max(xt,kl),F),F<Fe}let qr=Number.MAX_VALUE,Xn=0;const Yn=Le.aabb.getCorners(),bo=[];for(const Le of Yn){F.ad.vec3.sub(bo,Le,Do),wi||(qe?bo[2]*=yo:bo[2]=kl);const Oe=F.ad.vec3.dot(bo,this._camera.forward());Oe<qr&&(qr=Oe,Xn=Math.abs(bo[2]))}let Ro=(1<<bl-Le.zoom)*zs*Gt;if(Ro*=M(Math.max(Xn,kl),qr),qr<Ro)return!0;const na=Le.aabb.closestPoint(bi);return na[0]===bi[0]&&na[1]===bi[1]};if(this.renderWorldCopies)for(let F=1;F<=3;F++)hl.push(S(-F)),hl.push(S(F));for(hl.push(S(0));hl.length>0;){const Fe=hl.pop(),je=Fe.x,xt=Fe.y;let jt=Fe.fullyVisible;const u=()=>"globe"===this.projection.name&&(0===Fe.y||Fe.y===(1<<Fe.zoom)-1);if(!jt){let Le=Ro?Fe.aabb.intersects(Xn):Fe.aabb.intersectsFlat(Xn);if(0===Le&&u()){const Oe=new F.bT(Fe.zoom,je,xt);Le=F.bU(this,Gt,Oe,!0).intersects(Xn)}if(0===Le)continue;jt=2===Le}if(Fe.zoom!==bl&&P(Fe))for(let Le=0;Le<4;Le++){const Oe=(je<<1)+Le%2,bi=(xt<<1)+(Le>>1),qr={aabb:He?Fe.aabb.quadrant(Le):F.bV(this,Gt,Fe.zoom+1,Oe,bi,Fe.wrap,Fe.minZ,Fe.maxZ,this.projection),zoom:Fe.zoom+1,x:Oe,y:bi,wrap:Fe.wrap,fullyVisible:jt,tileID:void 0,shouldSplit:void 0,minZ:Fe.minZ,maxZ:Fe.maxZ};qe&&!wi&&(qr.tileID=new F.aH(Fe.zoom+1===bl?Tl:Fe.zoom+1,Fe.wrap,Fe.zoom+1,Oe,bi),L(qr)),hl.push(qr)}else{const qe=Fe.zoom===bl?Tl:Fe.zoom;if(Le.minzoom&&Le.minzoom>qe)continue;let He=0;if(!jt){let Oe=Ro?Fe.aabb.intersectsPrecise(Xn):Fe.aabb.intersectsPreciseFlat(Xn);if(0===Oe&&u()){const Le=new F.bT(Fe.zoom,je,xt);Oe=F.bU(this,Gt,Le,!0).intersectsPrecise(Xn)}if(0===Oe)continue;if(Le.calculateQuadrantVisibility)if(Xn.containsPoint(Fe.aabb.center))He=15;else for(let F=0;F<4;F++)0!==Fe.aabb.quadrant(F).intersects(Xn)&&(He|=1<<F)}const wi=bi[0]-(.5+je+(Fe.wrap<<Fe.zoom))*(1<<Oe-Fe.zoom),qr=bi[1]-.5-xt,Yn=Fe.tileID?Fe.tileID:new F.aH(qe,Fe.wrap,Fe.zoom,je,xt);Le.calculateQuadrantVisibility&&(Yn.visibleQuadrants=He),pl.push({tileID:Yn,distanceSq:wi*wi+qr*qr})}}if(this.fogCullDistSq){const Oe=this.fogCullDistSq,Fe=this.horizonLineFromTop();pl=pl.filter((je=>{const qe=[0,0,0,1],He=[F.ai,F.ai,0,1],xt=this.calculateFogTileMatrix(je.tileID.toUnwrapped());F.ad.vec4.transformMat4(qe,qe,xt),F.ad.vec4.transformMat4(He,He,xt);const jt=F.ad.vec4.min([],qe,He),Gt=F.ad.vec4.max([],qe,He),bi=F.bW(jt,Gt);if(0===bi)return!0;let wi=!1;const qr=this._elevation;if(qr&&bi>Oe&&0!==Fe){const Oe=this.calculateProjMatrix(je.tileID.toUnwrapped());let qe;Le.isTerrainDEM||(qe=qr.getMinMaxForTile(je.tileID)),qe||(qe={min:el,max:na});const He=F.c7(this.rotation),xt=[He[0]*F.ai,He[1]*F.ai,qe.max];F.ad.vec3.transformMat4(xt,xt,Oe),wi=(1-xt[1])*this.height*.5<Fe}return bi<Oe||wi}))}return pl.sort(((F,Le)=>F.distanceSq-Le.distanceSq)).map((F=>F.tileID))}resize(F,Le){this.width=F,this.height=Le,this.pixelsToGLUnits=[2/F,-2/Le],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(F){return Math.pow(2,F)}scaleZoom(F){return Math.log(F)/Math.LN2}project(Le){const Oe=F.ay(Le.lat,-F.bX,F.bX),Fe=this.projection.project(Le.lng,Oe);return new F.P(Fe.x*this.worldSize,Fe.y*this.worldSize)}unproject(F){return this.projection.unproject(F.x/this.worldSize,F.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/F.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(Le,Oe){let Fe,je;const qe=this.centerPoint;if("globe"===this.projection.name){const F=this.worldSize;Fe=(Oe.x-qe.x)/F,je=(Oe.y-qe.y)/F}else{const F=this.pointCoordinate(Oe),Le=this.pointCoordinate(qe);Fe=F.x-Le.x,je=F.y-Le.y}const He=this.locationCoordinate(Le);this.setLocation(new F.ac(He.x-Fe,He.y-je))}setLocation(F){this.center=this.coordinateLocation(F),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(F,Le){return this.projection.locationPoint(this,F,Le)}locationPoint3D(F,Le){return this.projection.locationPoint(this,F,Le,!0)}pointLocation(F){return this.coordinateLocation(this.pointCoordinate(F))}pointLocation3D(F,Le){return this.coordinateLocation(this.pointCoordinate3D(F,Le))}locationCoordinate(Le,Oe){const Fe=Oe?F.bH(Oe,Le.lat):void 0,je=this.projection.project(Le.lng,Le.lat);return new F.ac(je.x,je.y,Fe)}coordinateLocation(F){return this.projection.unproject(F.x,F.y)}pointRayIntersection(Le,Oe){const Fe=null!=Oe?Oe:this._centerAltitude,je=[Le.x,Le.y,0,1],qe=[Le.x,Le.y,1,1];F.ad.vec4.transformMat4(je,je,this.pixelMatrixInverse),F.ad.vec4.transformMat4(qe,qe,this.pixelMatrixInverse);const He=qe[3];F.ad.vec4.scale(je,je,1/je[3]),F.ad.vec4.scale(qe,qe,1/He);const xt=je[2],jt=qe[2];return{p0:je,p1:qe,t:xt===jt?0:(Fe-xt)/(jt-xt)}}screenPointToMercatorRay(Le){const Oe=[Le.x,Le.y,0,1],Fe=[Le.x,Le.y,1,1];return F.ad.vec4.transformMat4(Oe,Oe,this.pixelMatrixInverse),F.ad.vec4.transformMat4(Fe,Fe,this.pixelMatrixInverse),F.ad.vec4.scale(Oe,Oe,1/Oe[3]),F.ad.vec4.scale(Fe,Fe,1/Fe[3]),Oe[2]=F.bH(Oe[2],this._center.lat)*this.worldSize,Fe[2]=F.bH(Fe[2],this._center.lat)*this.worldSize,F.ad.vec4.scale(Oe,Oe,1/this.worldSize),F.ad.vec4.scale(Fe,Fe,1/this.worldSize),new F.as([Oe[0],Oe[1],Oe[2]],F.ad.vec3.normalize([],F.ad.vec3.sub([],Fe,Oe)))}rayIntersectionCoordinate(Le){const{p0:Oe,p1:Fe,t:je}=Le,qe=F.bH(Oe[2],this._center.lat),He=F.bH(Fe[2],this._center.lat);return new F.ac(F.ah(Oe[0],Fe[0],je)/this.worldSize,F.ah(Oe[1],Fe[1],je)/this.worldSize,F.ah(qe,He,je))}pointCoordinate(F,Le=this._centerAltitude){return this.projection.pointCoordinate(this,F.x,F.y,Le)}pointCoordinate3D(Le,Oe){if(!this.elevation)return this.pointCoordinate(Le,Oe);let Fe=this.projection.pointCoordinate3D(this,Le.x,Le.y);if(Fe)return new F.ac(Fe[0],Fe[1],Fe[2]);let je=0,qe=this.horizonLineFromTop();if(Le.y>qe)return this.pointCoordinate(Le,Oe);const He=.02*qe,xt=Le.clone();for(let Le=0;Le<10&&qe-je>He;Le++){xt.y=F.ah(je,qe,.66);const Le=this.projection.pointCoordinate3D(this,xt.x,xt.y);Le?(qe=xt.y,Fe=Le):je=xt.y}return Fe?new F.ac(Fe[0],Fe[1],Fe[2]):this.pointCoordinate(Le)}isPointAboveHorizon(F){return this.projection.isPointAboveHorizon(this,F)}isPointOnSurface(Le){if(Le.y<0||Le.y>this.height||Le.x<0||Le.x>this.width)return!1;if(this.elevation||this.zoom>=F.bY)return!this.isPointAboveHorizon(Le);const Oe=this.pointCoordinate(Le);return Oe.y>=0&&Oe.y<=1}_coordinatePoint(Le,Oe){const Fe=Oe&&this.elevation?this.elevation.getAtPointOrZero(Le,this._centerAltitude):this._centerAltitude,je=[Le.x*this.worldSize,Le.y*this.worldSize,Fe+Le.toAltitude(),1];return F.ad.vec4.transformMat4(je,je,this.pixelMatrix),je[3]>0?new F.P(je[0]/je[3],je[1]/je[3]):new F.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:Le,left:Oe}=this._edgeInsets,Fe=this.height-this._edgeInsets.bottom,je=this.width-this._edgeInsets.right,qe=this.pointLocation3D(new F.P(Oe,Le)),He=this.pointLocation3D(new F.P(je,Le)),xt=this.pointLocation3D(new F.P(je,Fe)),jt=this.pointLocation3D(new F.P(Oe,Fe));let Gt=Math.min(qe.lng,He.lng,xt.lng,jt.lng),bi=Math.max(qe.lng,He.lng,xt.lng,jt.lng),wi=Math.min(qe.lat,He.lat,xt.lat,jt.lat),qr=Math.max(qe.lat,He.lat,xt.lat,jt.lat);const Xn=Math.pow(2,-this.zoom)/16*270,Yn="globe"===this.projection.name?1:4,f=(Le,Oe,Fe,je,qe)=>{const He=(Le+Fe)/2,xt=(Oe+je)/2,jt=new F.P(He,xt),{lng:yo,lat:bo}=this.pointLocation3D(jt),Do=Math.max(0,Gt-yo,wi-bo,yo-bi,bo-qr);Gt=Math.min(Gt,yo),bi=Math.max(bi,yo),wi=Math.min(wi,bo),qr=Math.max(qr,bo),(qe<Yn||Do>Xn)&&(f(Le,Oe,He,xt,qe+1),f(He,xt,Fe,je,qe+1))};if(f(Oe,Le,je,Le,1),f(je,Le,je,Fe,1),f(je,Fe,Oe,Fe,1),f(Oe,Fe,Oe,Le,1),"globe"===this.projection.name){const[Le,Oe]=F.bZ(this);Le?(qr=90,bi=180,Gt=-180):Oe&&(wi=-90,bi=180,Gt=-180)}return new F.aB(new F.bO(Gt,wi),new F.bO(bi,qr))}_getBoundsRectangular(Le,Oe){const{top:Fe,left:je}=this._edgeInsets,qe=this.height-this._edgeInsets.bottom,He=this.width-this._edgeInsets.right,xt=new F.P(je,Fe),jt=new F.P(He,Fe),Gt=new F.P(He,qe),bi=new F.P(je,qe);let wi=this.pointCoordinate(xt,Le),qr=this.pointCoordinate(jt,Le);const Xn=this.pointCoordinate(Gt,Oe),Yn=this.pointCoordinate(bi,Oe),f=(F,Le)=>(Le.y-F.y)/(Le.x-F.x);return wi.y>1&&qr.y>=0?wi=new F.ac((1-Yn.y)/f(Yn,wi)+Yn.x,1):wi.y<0&&qr.y<=1&&(wi=new F.ac(-Yn.y/f(Yn,wi)+Yn.x,0)),qr.y>1&&wi.y>=0?qr=new F.ac((1-Xn.y)/f(Xn,qr)+Xn.x,1):qr.y<0&&wi.y<=1&&(qr=new F.ac(-Xn.y/f(Xn,qr)+Xn.x,0)),(new F.aB).extend(this.coordinateLocation(wi)).extend(this.coordinateLocation(qr)).extend(this.coordinateLocation(Yn)).extend(this.coordinateLocation(Xn))}_getBoundsRectangularTerrain(){const F=this.elevation;if(!F.visibleDemTiles.length||F.isUsingMockSource())return this._getBoundsRectangular(0,0);const Le=F.visibleDemTiles.reduce(((F,Le)=>{if(Le.dem){const Oe=Le.dem.tree;F.min=Math.min(F.min,Oe.minimums[0]),F.max=Math.max(F.max,Oe.maximums[0])}return F}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(Le.min*F.exaggeration(),Le.max*F.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(F=!0){const Le=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,Oe=this.height/2-Le*(1-this._horizonShift);return F?Math.max(0,Oe):Oe}getMaxBounds(){return this.maxBounds}setMaxBounds(Le){this.maxBounds=Le,this.minLat=-F.bX,this.maxLat=F.bX,this.minLng=-180,this.maxLng=180,Le&&(this.minLat=Le.getSouth(),this.maxLat=Le.getNorth(),this.minLng=Le.getWest(),this.maxLng=Le.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=F.av(this.minLng)*this.tileSize,this.worldMaxX=F.av(this.maxLng)*this.tileSize,this.worldMinY=F.aC(this.maxLat)*this.tileSize,this.worldMaxY=F.aC(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(F,Le){return this.projection.createTileMatrix(this,Le,F)}calculateDistanceTileData(Le){const Oe=Le.key,Fe=this._distanceTileDataCache;if(Fe[Oe])return Fe[Oe];const je=Le.canonical,qe=1/this.height,He=this.cameraWorldSize,xt=He/this.zoomScale(je.z),jt=(je.x+Math.pow(2,je.z)*Le.wrap)*xt,Gt=je.y*xt,bi=this.point;bi.x*=He/this.worldSize,bi.y*=He/this.worldSize;const wi=this.angle,qr=Math.sin(-wi),Xn=-Math.cos(-wi);return Fe[Oe]={bearing:[qr,Xn],center:[(bi.x-jt)*qe,(bi.y-Gt)*qe],scale:xt/F.ai*qe},Fe[Oe]}calculateFogTileMatrix(Le){const Oe=Le.key,Fe=this._fogTileMatrixCache;if(Fe[Oe])return Fe[Oe];const je=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,Le);return F.ad.mat4.multiply(je,this.worldToFogMatrix,je),Fe[Oe]=new Float32Array(je),Fe[Oe]}calculateProjMatrix(Le,Oe=!1,Fe=!1){const je=Le.key;let qe;if(qe=Fe?this._expandedProjMatrixCache:Oe?this._alignedProjMatrixCache:this._projMatrixCache,qe[je])return qe[je];const He=this.calculatePosMatrix(Le,this.worldSize);let xt;return xt=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:Fe?this.expandedFarZProjMatrix:Oe?this.alignedProjMatrix:this.projMatrix,F.ad.mat4.multiply(He,xt,He),qe[je]=new Float32Array(He),qe[je]}calculatePixelsToTileUnitsMatrix(Le){const Oe=Le.tileID.key,Fe=this._pixelsToTileUnitsCache;if(Fe[Oe])return Fe[Oe];const je=F.b_(Le,this);return Fe[Oe]=je,Fe[Oe]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const Le=1/this.worldSize,Oe=F.ad.mat4.fromScaling([],[Le,Le,Le]);return F.ad.mat4.multiply(Oe,Oe,this.globeMatrix),Oe}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const Le=this._elevation;this._updateCameraState();const Oe=F.bH(1,this._center.lat)*this.worldSize,Fe=this._computeCameraPosition(Oe),je=this._camera.forward(),qe=F.bH(1,this._center.lat);Fe[2]/=qe,je[2]/=qe,F.ad.vec3.normalize(je,je);const He=Le.raycast(Fe,je,Le.exaggeration());if(He){const Le=F.ad.vec3.scaleAndAdd([],Fe,je,He),Oe=new F.ac(Le[0],Le[1],F.bH(Le[2],F.aT(Le[1]))),xt=(Oe.z+F.ad.vec3.length([Oe.x-Fe[0],Oe.y-Fe[1],Oe.z-Fe[2]*qe]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(xt),this._centerAltitude=Oe.toAltitude(),this._center=this.coordinateLocation(Oe),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(Le=!1){if(!this._elevation)return;const Oe=this._elevation,Fe=F.bH(1,this._center.lat)*this.worldSize,je=this._computeCameraPosition(Fe),qe=Oe.getAtPointOrZero(new F.ac(...je)),He=this.pixelsPerMeter/this.worldSize*qe,xt=this._minimumHeightOverTerrain(),jt=je[2]-He;if(jt<=xt)if(jt<0||Le){const Le=this.locationCoordinate(this._center,this._centerAltitude),Oe=[je[0],je[1],Le.z-je[2]],Fe=F.ad.vec3.length(Oe);Oe[2]-=(xt-jt)/this._pixelsPerMercatorPixel;const qe=F.ad.vec3.length(Oe);if(0===qe)return;F.ad.vec3.scale(Oe,Oe,Fe/qe*this._pixelsPerMercatorPixel),this._camera.position=[je[0],je[1],Le.z*this._pixelsPerMercatorPixel-Oe[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const Le="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||Le){const Oe=this.center;return Oe.lat=F.ay(Oe.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!Le)&&(Oe.lng=F.ay(Oe.lng,this.minLng,this.maxLng)),this.center=Oe,void(this._constraining=!1)}const Oe=this._unmodified,{x:Fe,y:je}=this.point;let qe=0,He=Fe,xt=je;const jt=this.width/2,Gt=this.height/2,bi=this.worldMinY*this.scale,wi=this.worldMaxY*this.scale;if(je-Gt<bi&&(xt=bi+Gt),je+Gt>wi&&(xt=wi-Gt),wi-bi<this.height&&(qe=Math.max(qe,this.height/(wi-bi)),xt=(wi+bi)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const F=this.worldMinX*this.scale,Le=this.worldMaxX*this.scale,Oe=this.worldSize/2-(F+Le)/2;He=(Fe+Oe+this.worldSize)%this.worldSize-Oe,He-jt<F&&(He=F+jt),He+jt>Le&&(He=Le-jt),Le-F<this.width&&(qe=Math.max(qe,this.width/(Le-F)),He=(Le+F)/2)}He===Fe&&xt===je||this._allowWorldUnderZoom||(this.center=this.unproject(new F.P(He,xt))),qe&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(qe)),this._constrainCamera(),this._unmodified=Oe,this._constraining=!1}_minZoomForBounds(){let F=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(F=Math.max(F,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),F}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const Le=this.centerOffset,Oe="globe"===this.projection.name,Fe=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=F.bH(1,this.center.lat)/F.bH(1,F.c8));const je=F.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,je),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const qe="meters"===this.projection.zAxisUnit?Fe:1,He=this._camera.getWorldToCamera(this.worldSize,qe);let xt;const jt=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(jt[8]=2*-Le.x/this.width,jt[9]=2*Le.y/this.height,this.isOrthographic){let Oe=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Fe=Oe*this.aspect,je=-Fe,qe=-Oe;Fe-=Le.x,je-=Le.x,Oe+=Le.y,qe+=Le.y,xt=this._camera.getCameraToClipOrthographic(je,Fe,qe,Oe,this._nearZ,this._farZ),((Le,Oe,Fe,je)=>{for(let qe=0;qe<16;qe++)Le[qe]=F.ah(Oe[qe],Fe[qe],je)})(xt,xt,jt,F.c9(this.pitch>=Qh?1:this.pitch/Qh))}else xt=jt;const Gt=F.ad.mat4.mul([],jt,He);let bi=F.ad.mat4.mul([],xt,He);if(this.projection.isReprojectedInTileSpace){const Le=this.locationCoordinate(this.center),Oe=F.ad.mat4.identity([]);F.ad.mat4.translate(Oe,Oe,[Le.x*this.worldSize,Le.y*this.worldSize,0]),F.ad.mat4.multiply(Oe,Oe,F.c0(this)),F.ad.mat4.translate(Oe,Oe,[-Le.x*this.worldSize,-Le.y*this.worldSize,0]),F.ad.mat4.multiply(bi,bi,Oe),F.ad.mat4.multiply(Gt,Gt,Oe),this.inverseAdjustmentMatrix=F.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=F.ad.mat4.scale([],bi,[this.worldSize,this.worldSize,this.worldSize/qe,1]),this.projMatrix=bi,this.invProjMatrix=F.ad.mat4.invert(new Float64Array(16),this.projMatrix),Oe){const Oe=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);Oe[8]=2*-Le.x/this.width,Oe[9]=2*Le.y/this.height,this.expandedFarZProjMatrix=F.ad.mat4.mul([],Oe,He)}else this.expandedFarZProjMatrix=this.projMatrix;const wi=F.ad.mat4.invert([],xt);this.frustumCorners=F.c2.fromInvProjectionMatrix(wi,this.horizonLineFromTop(),this.height),this.cameraFrustum=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!Oe);const qr=new Float32Array(16);F.ad.mat4.identity(qr),F.ad.mat4.scale(qr,qr,[1,-1,1]),F.ad.mat4.rotateX(qr,qr,this._pitch),F.ad.mat4.rotateZ(qr,qr,this.angle);const Xn=F.ad.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=F.ad.mat4.clone(Xn);const Yn=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;Xn[8]=2*-Le.x/this.width,Xn[9]=2*(Le.y+Yn)/this.height,this.skyboxMatrix=F.ad.mat4.multiply(qr,Xn,qr);const yo=this.point,bo=yo.x,Do=yo.y,Ro=this.width%2/2,zs=this.height%2/2,Zs=Math.cos(this.angle),na=Math.sin(this.angle),el=bo-Math.round(bo)+Zs*Ro+na*zs,nl=Do-Math.round(Do)+Zs*zs+na*Ro,hl=new Float64Array(bi);if(F.ad.mat4.translate(hl,hl,[el>.5?el-1:el,nl>.5?nl-1:nl,0]),this.alignedProjMatrix=hl,bi=F.ad.mat4.create(),F.ad.mat4.scale(bi,bi,[this.width/2,-this.height/2,1]),F.ad.mat4.translate(bi,bi,[1,-1,0]),this.labelPlaneMatrix=bi,bi=F.ad.mat4.create(),F.ad.mat4.scale(bi,bi,[1,-1,1]),F.ad.mat4.translate(bi,bi,[-1,-1,0]),F.ad.mat4.scale(bi,bi,[2/this.width,2/this.height,1]),this.glCoordMatrix=bi,this.pixelMatrix=F.ad.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,Gt),this._calcFogMatrices(),this._distanceTileDataCache={},bi=F.ad.mat4.invert(new Float64Array(16),this.pixelMatrix),!bi)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=bi,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=F.c3(this);const Le=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=F.ad.vec3.transformMat4(Le,Le,He),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=bi;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const Le=this.cameraWorldSizeForFog,Oe=this.cameraPixelsPerMeter,Fe=this._camera.position,je=1/this.height/this._pixelsPerMercatorPixel,qe=[Le,Le,Oe];F.ad.vec3.scale(qe,qe,je),F.ad.vec3.scale(Fe,Fe,-1),F.ad.vec3.multiply(Fe,Fe,qe);const He=F.ad.mat4.create();F.ad.mat4.translate(He,He,Fe),F.ad.mat4.scale(He,He,qe),this.mercatorFogMatrix=He,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(Le,Oe,je)}_computeCameraPosition(F){const Le=(F=F||this.pixelsPerMeter)/this.pixelsPerMeter,Oe=this._camera.forward(),Fe=this.point,je=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*Le-F/this.worldSize*this._centerAltitude;return[Fe.x/this.worldSize-Oe[0]*je,Fe.y/this.worldSize-Oe[1]*je,F/this.worldSize*this._centerAltitude-Oe[2]*je]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(Le){const Oe=this._maxCameraBoundsDistance()*Math.cos(this._pitch),Fe=this._camera.position[2],je=Le[2];let qe=1;this.projection.wrap&&(this.center=this.center.wrap()),je>0&&(qe=Math.min((Oe-Fe)/je,1)),this._camera.position=F.ad.vec3.scaleAndAdd([],this._camera.position,Le,qe),this._updateStateFromCamera()}_updateStateFromCamera(){const Le=this._camera.position,Oe=this._camera.forward(),{pitch:Fe,bearing:je}=this._camera.getPitchBearing(),qe=F.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,He=this._mercatorZfromZoom(this._maxZoom)*Math.cos(F.ak(this._maxPitch)),xt=Math.max((Le[2]-qe)/Math.cos(Fe),He),jt=this._zoomFromMercatorZ(xt);F.ad.vec3.scaleAndAdd(Le,Le,Oe,xt),this._pitch=F.ay(Fe,F.ak(this.minPitch),F.ak(this.maxPitch)),this.angle=F.bF(je,-Math.PI,Math.PI),this._setZoom(F.ay(jt,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new F.ac(Le[0],Le[1],Le[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(F){return Math.pow(2,F)*this.tileSize}_mercatorZfromZoom(F){return this.cameraToCenterDistance/this._worldSizeFromZoom(F)}_minimumHeightOverTerrain(){const F=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(F)}_zoomFromMercatorZ(F){return this.scaleZoom(this.cameraToCenterDistance/(F*this.tileSize))}zoomFromMercatorZAdjusted(Le){let Oe=0,Fe=F.bY,je=0,qe=1/0;for(;Fe-Oe>1e-6&&Fe>Oe;){const F=Oe+.5*(Fe-Oe),He=this.tileSize*Math.pow(2,F),xt=this.getCameraToCenterDistance(this.projection,F,He),jt=this.scaleZoom(xt/(Le*this.tileSize)),Gt=Math.abs(F-jt);Gt<qe&&(qe=Gt,je=F),F<jt?Oe=F:Fe=F}return je}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(F.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(Le,Oe){const Fe=Math.min(Le.x,Oe.x),je=Math.max(Le.x,Oe.x),qe=Math.min(Le.y,Oe.y),He=Math.max(Le.y,Oe.y);if(qe<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const xt=[new F.P(Fe,qe),new F.P(je,He),new F.P(Fe,He),new F.P(je,qe)],jt=this.renderWorldCopies?-3:0,Gt=this.renderWorldCopies?4:1;for(const F of xt){const Le=this.pointRayIntersection(F);if(Le.t<0)return!0;const Oe=this.rayIntersectionCoordinate(Le);if(Oe.x<jt||Oe.y<0||Oe.x>Gt||Oe.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+F.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new F.P(0,0),new F.P(this.width,this.height))}zoomDeltaToMovement(Le,Oe){const Fe=F.ad.vec3.length(F.ad.vec3.sub([],this._camera.position,Le)),je=this._zoomFromMercatorZ(Fe)+Oe;return Fe-this._mercatorZfromZoom(je)}getCameraPoint(){if("globe"===this.projection.name){const Le=function([Le,Oe,Fe],je){const qe=[Le,Oe,Fe,1];F.ad.vec4.transformMat4(qe,qe,je);const He=qe[3]=Math.max(qe[3],1e-6);return qe[0]/=He,qe[1]/=He,qe[2]/=He,qe}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new F.P(Le[0],Le[1])}{const Le=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new F.P(0,Le))}}getCameraToCenterDistance(Le,Oe=this.zoom,Fe=this.worldSize){const je=F.b$(Le,Oe,this.width,this.height,1024),qe=Le.pixelSpaceConversion(this.center.lat,Fe,je);let He=.5/Math.tan(.5*this._fov)*this.height*qe;return this.isOrthographic&&(He=F.ah(1,He,F.c9(this.pitch>=Qh?1:this.pitch/Qh))),He}getWorldToCameraMatrix(){const Le=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&F.ad.mat4.multiply(Le,Le,this.globeMatrix),Le}getFrustum(Le){return F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,Le,"meters"===this.projection.zAxisUnit)}}const Qi=(Le,Oe)=>{if(Oe>0&&Le.terrain&&F.w("Cutoff is currently disabled on terrain"),Oe<=0||Le.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const Fe=Le.transform,je=Math.max(Math.abs(Fe._zoom-(Le.minCutoffZoom-1)),1),qe=Fe.isLODDisabled(!1)?F.ae(60,45,Fe.pitch):F.ae(30,15,Fe.pitch),He=Fe._farZ-Fe._nearZ,xt=Oe*Fe.height,jt=((1-(Gt=qe))*Fe.cameraToCenterDistance+Gt*(Fe._farZ+xt))*je;var Gt;return{shouldRenderCutoff:qe<1,uniformValues:{u_cutoff_params:[Fe._nearZ,Fe._farZ,(jt-Fe._nearZ)/He,(jt-xt-Fe._nearZ)/He]}}},iu={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class to{constructor(F,Le){this.aabb=F,this.lastCascade=Le}}class io{add(F,Le){const Oe=this.receivers[F.key];void 0!==Oe?(Oe.aabb.min[0]=Math.min(Oe.aabb.min[0],Le.min[0]),Oe.aabb.min[1]=Math.min(Oe.aabb.min[1],Le.min[1]),Oe.aabb.min[2]=Math.min(Oe.aabb.min[2],Le.min[2]),Oe.aabb.max[0]=Math.max(Oe.aabb.max[0],Le.max[0]),Oe.aabb.max[1]=Math.max(Oe.aabb.max[1],Le.max[1]),Oe.aabb.max[2]=Math.max(Oe.aabb.max[2],Le.max[2])):this.receivers[F.key]=new to(Le,null)}clear(){this.receivers={}}get(F){return this.receivers[F.key]}computeRequiredCascades(Le,Oe,Fe){const je=F.ce.fromPoints(Le.points);let qe=0;for(const Le in this.receivers){const He=this.receivers[Le];if(!He)continue;if(!je.intersectsAabb(He.aabb))continue;He.aabb.min=je.closestPoint(He.aabb.min),He.aabb.max=je.closestPoint(He.aabb.max);const xt=He.aabb.getCorners();for(let Le=0;Le<Fe.length;Le++){let je=!0;for(const qe of xt){const He=[qe[0]*Oe,qe[1]*Oe,qe[2]];if(F.ad.vec3.transformMat4(He,He,Fe[Le].matrix),He[0]<-1||He[0]>1||He[1]<-1||He[1]>1){je=!1;break}}if(He.lastCascade=Le,qe=Math.max(qe,Le),je)break}}return qe+1}}class oo{constructor(F){this.painter=F,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new io,this._depthMode=new Bi(F.context.gl.LEQUAL,Bi.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,F.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),F.tp.registerParameter(iu,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),F.tp.registerParameter(iu,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),F.tp.registerParameter(iu,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),F.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const F of this._cascades)F.texture.destroy(),F.framebuffer.destroy();this._cascades=[]}updateShadowParameters(Le,Oe){const Fe=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!Oe||!Oe.properties)return;const je=Oe.properties.get("shadow-intensity");if(!Oe.shadowsEnabled()||je<=0)return;if(this._shadowLayerCount=Fe.style.order.reduce(((F,Oe)=>{const je=Fe.style._mergedLayers[Oe];return F+(je.hasShadowPass()&&!je.isHidden(Le.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled)return;const qe=Fe.context,He=iu.shadowMapResolution,xt=iu.shadowMapResolution;if(0===this._cascades.length||iu.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let Le=0;Le<iu.cascadeCount;++Le){const Le=Fe._shadowMapDebug,Oe=qe.gl,je=qe.createFramebuffer(He,xt,Le,"texture"),jt=new F.T(qe,{width:He,height:xt,data:null},Oe.DEPTH_COMPONENT16);if(je.depthAttachment.set(jt.texture),Le){const Le=new F.T(qe,{width:He,height:xt,data:null},Oe.RGBA8);je.colorAttachment.set(Le.texture)}this._cascades.push({framebuffer:je,texture:jt,matrix:[],far:0,boundingSphereRadius:0,frustum:new F.bR,scale:0})}}this.shadowDirection=ro(Oe);let jt=0;if(Le.elevation){const F=Le.elevation,Oe=[1e4,-1e4];F.visibleDemTiles.filter((F=>F.dem)).forEach((F=>{const Le=F.dem.tree;Oe[0]=Math.min(Oe[0],Le.minimums[0]),Oe[1]=Math.max(Oe[1],Le.maximums[0])})),1e4!==Oe[0]&&(jt=(Oe[1]-Oe[0])*F.exaggeration())}const Gt=1.5*Le.cameraToCenterDistance,bi=3*Gt,wi=new Float64Array(16);for(let Oe=0;Oe<this._cascades.length;++Oe){const Fe=this._cascades[Oe];let je=Le.height/50,qe=1;1===iu.cascadeCount?qe=bi:0===Oe?qe=Gt:(je=Gt,qe=bi);const[He,xt]=ao(Le,this.shadowDirection,je,qe,iu.shadowMapResolution,jt);Fe.scale=Le.scale,Fe.matrix=He,Fe.boundingSphereRadius=xt,F.ad.mat4.invert(wi,Fe.matrix),Fe.frustum=F.bR.fromInvProjectionMatrix(wi,1,0,!0),Fe.far=qe}const qr=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[qr].far,this._cascades[qr].far],this._uniformValues.u_shadow_intensity=je,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/iu.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=iu.shadowMapResolution,this._uniformValues.u_shadowmap_0=Uh.ShadowMap0,this._uniformValues.u_shadowmap_1=Uh.ShadowMap0+1,this._groundShadowTiles=Fe.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const Xn=Fe.transform.elevation;for(const F of this._groundShadowTiles){let Le={min:0,max:0};if(Xn){const Oe=Xn.getMinMaxForTile(F);Oe&&(Le=Oe)}this.addShadowReceiver(F.toUnwrapped(),Le.min,Le.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(F){this._enabled=F}drawShadowPass(Le,Oe){if(!this.enabled)return;const Fe=this.painter,je=Fe.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(Fe.transform.getFrustum(0),Fe.transform.worldSize,this._cascades),je.viewport.set([0,0,iu.shadowMapResolution,iu.shadowMapResolution]);for(let qe=0;qe<this._numCascadesToRender;++qe){Fe.currentShadowCascade=qe,je.bindFramebuffer.set(this._cascades[qe].framebuffer.framebuffer),je.clear({color:F.al.white,depth:1});for(const F of Le.order){const je=Le._mergedLayers[F];if(!je.hasShadowPass()||je.isHidden(Fe.transform.zoom))continue;const qe=Le.getLayerSourceCache(je),He=qe?Oe[qe.id]:void 0;("model"===je.type||He&&He.length)&&Fe.renderLayer(Fe,qe,je,He)}}Fe.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const F=this.painter,Le=F.style,Oe=F.context,Fe=Le.directionalLight,je=Le.ambientLight;if(!Fe||!je)return;const qe=[],He=Qi(F,F.longestCutoffRange);He.shouldRenderCutoff&&qe.push("RENDER_CUTOFF"),qe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&qe.push("NORMAL_OFFSET");const xt=no(Le,Fe,je),jt=new Bi(Oe.gl.LEQUAL,Bi.ReadOnly,F.depthRangeFor3D);for(const Le of this._groundShadowTiles){const Fe=Le.toUnwrapped(),je=F.isTileAffectedByFog(Le),Gt=F.getOrCreateProgram("groundShadow",{defines:qe,overrideFog:je});this.setupShadows(Fe,Gt),F.uploadCommonUniforms(Oe,Gt,Fe,null,He);const bi={u_matrix:F.transform.calculateProjMatrix(Fe),u_ground_shadow_factor:xt};Gt.draw(F,Oe.gl.TRIANGLES,jt,Ui.disabled,ki.multiply,ji.disabled,bi,"ground_shadow",F.tileExtentBuffer,F.quadTriangleIndexBuffer,F.tileExtentSegments,null,F.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ki.unblended:ki.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(Le){const Oe=this.painter.transform,Fe=Oe.calculatePosMatrix(Le,Oe.worldSize);return F.ad.mat4.multiply(Fe,this._cascades[this.painter.currentShadowCascade].matrix,Fe),Float32Array.from(Fe)}calculateShadowPassMatrixFromMatrix(Le){return F.ad.mat4.multiply(Le,this._cascades[this.painter.currentShadowCascade].matrix,Le),Float32Array.from(Le)}setupShadows(Le,Oe,Fe,je=0){if(!this.enabled)return;const qe=this.painter.transform,He=this.painter.context,xt=He.gl,jt=this._uniformValues,Gt=new Float64Array(16),bi=qe.calculatePosMatrix(Le,qe.worldSize);for(let Le=0;Le<this._cascades.length;Le++)F.ad.mat4.multiply(Gt,this._cascades[Le].matrix,bi),jt[0===Le?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(Gt),He.activeTexture.set(xt.TEXTURE0+Uh.ShadowMap0+Le),this._cascades[Le].texture.bind(xt.NEAREST,xt.CLAMP_TO_EDGE);if(this.useNormalOffset=!!Fe,this.useNormalOffset){const Oe=F.cd(Le.canonical),He=2/qe.tileSize*F.ai/iu.shadowMapResolution,xt=He*this._cascades[0].boundingSphereRadius,Gt=He*this._cascades[this._cascades.length-1].boundingSphereRadius,bi=("vector-tile"===Fe?1:3)/Math.pow(2,je-Le.canonical.z-(1-qe.zoom+Math.floor(qe.zoom)));jt.u_shadow_normal_offset=[Oe,xt*bi,Gt*bi],jt.u_shadow_bias=[6e-5,.0012,.012]}else jt.u_shadow_bias=[36e-5,.0012,.012];Oe.setShadowUniformValues(He,jt)}setupShadowsFromMatrix(Le,Oe,Fe=!1){if(!this.enabled)return;const je=this.painter.context,qe=je.gl,He=this._uniformValues,xt=new Float64Array(16);for(let Oe=0;Oe<iu.cascadeCount;Oe++)F.ad.mat4.multiply(xt,this._cascades[Oe].matrix,Le),He[0===Oe?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(xt),je.activeTexture.set(qe.TEXTURE0+Uh.ShadowMap0+Oe),this._cascades[Oe].texture.bind(qe.NEAREST,qe.CLAMP_TO_EDGE);if(this.useNormalOffset=Fe,Fe){const F=iu.normalOffset;He.u_shadow_normal_offset=[1,F,F],He.u_shadow_bias=[6e-5,.0012,.012]}else He.u_shadow_bias=[36e-5,.0012,.012];Oe.setShadowUniformValues(je,He)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(Le,Oe,Fe,je){if(je[2]>=0)return{};const qe=function(Le,Oe,Fe){const je=Fe/(1<<Le.canonical.z);return new F.ce([Le.canonical.x*je+Le.wrap*Fe,Le.canonical.y*je+Le.wrap*Fe,0],[(Le.canonical.x+1)*je+Le.wrap*Fe,(Le.canonical.y+1)*je+Le.wrap*Fe,Oe])}(Le,Oe,Fe).getCorners(),He=Oe/-je[2];je[0]<0?(F.ad.vec3.add(qe[0],qe[0],[je[0]*He,0,0]),F.ad.vec3.add(qe[3],qe[3],[je[0]*He,0,0])):je[0]>0&&(F.ad.vec3.add(qe[1],qe[1],[je[0]*He,0,0]),F.ad.vec3.add(qe[2],qe[2],[je[0]*He,0,0])),je[1]<0?(F.ad.vec3.add(qe[0],qe[0],[0,je[1]*He,0]),F.ad.vec3.add(qe[1],qe[1],[0,je[1]*He,0])):je[1]>0&&(F.ad.vec3.add(qe[2],qe[2],[0,je[1]*He,0]),F.ad.vec3.add(qe[3],qe[3],[0,je[1]*He,0]));const xt={};return xt.vertices=qe,xt.planes=[so(qe[1],qe[0],qe[4]),so(qe[2],qe[1],qe[5]),so(qe[3],qe[2],qe[6]),so(qe[0],qe[3],qe[7])],xt}addShadowReceiver(Le,Oe,Fe){this._receivers.add(Le,F.ce.fromTileIdAndHeight(Le,Oe,Fe))}getMaxCascadeForTile(F){const Le=this._receivers.get(F);return Le&&Le.lastCascade?Le.lastCascade:0}}function so(Le,Oe,Fe){const je=F.ad.vec3.sub([],Fe,Oe),qe=F.ad.vec3.sub([],Le,Oe),He=F.ad.vec3.cross([],je,qe),xt=F.ad.vec3.length(He);return 0===xt?[0,0,1,0]:(F.ad.vec3.scale(He,He,1/xt),[He[0],He[1],He[2],-F.ad.vec3.dot(He,Oe)])}function ro(Le){const Oe=Le.properties.get("direction"),Fe=F.cc(Oe.x,Oe.y,Oe.z);Fe[2]=F.ay(Fe[2],0,75);const je=F.cf([Fe[0],Fe[1],Fe[2]]);return F.ad.vec3.fromValues(je.x,je.y,je.z)}function no(Le,Oe,Fe){const je="none"===Oe.properties.get("color-use-theme"),qe=Oe.properties.get("color"),He=Oe.properties.get("intensity"),xt=Oe.properties.get("direction"),jt=[xt.x,xt.y,xt.z],Gt="none"===Fe.properties.get("color-use-theme"),bi=Fe.properties.get("color"),wi=Fe.properties.get("intensity"),qr=Math.max(F.ad.vec3.dot([0,0,1],jt),0),Xn=[0,0,0];F.ad.vec3.scale(Xn,bi.toRenderColor(Gt?null:Le.getLut(Oe.scope)).toArray01Linear().slice(0,3),wi);const Yn=[0,0,0];return F.ad.vec3.scale(Yn,qe.toRenderColor(je?null:Le.getLut(Fe.scope)).toArray01Linear().slice(0,3),qr*He),F.cg([Xn[0]>0?Xn[0]/(Xn[0]+Yn[0]):0,Xn[1]>0?Xn[1]/(Xn[1]+Yn[1]):0,Xn[2]>0?Xn[2]/(Xn[2]+Yn[2]):0])}function ao(Le,Oe,Fe,je,qe,He){const xt=Le.zoom,jt=Le.scale,Gt=Le.worldSize,bi=1/Gt,wi=Le.aspect,qr=Math.sqrt(1+wi*wi)*Math.tan(.5*Le.fovX),Xn=qr*qr,Yn=je-Fe,yo=je+Fe;let bo,Do;Xn>Yn/yo?(bo=je,Do=je*qr):(bo=.5*yo*(1+Xn),Do=.5*Math.sqrt(Yn*Yn+2*(je*je+Fe*Fe)*Xn+yo*yo*Xn*Xn));const Ro=Le.projection.pixelsPerMeter(Le.center.lat,Gt),zs=Le._camera.getCameraToWorldMercator(),Zs=[0,0,-bo*bi];F.ad.vec3.transformMat4(Zs,Zs,zs);let na=Do*bi;const el=Le._edgeInsets;if(!(0===el.left&&0===el.top&&0===el.right&&0===el.bottom||el.left===el.right&&el.top===el.bottom)){const Oe=Le._camera.getWorldToCamera(Le.worldSize,"meters"===Le.projection.zAxisUnit?Ro:1),qe=Le._camera.getCameraToClipPerspective(Le._fov,Le.width/Le.height,Fe,je);qe[8]=2*-Le.centerOffset.x/Le.width,qe[9]=2*Le.centerOffset.y/Le.height;const He=new Float64Array(16);F.ad.mat4.mul(He,qe,Oe);const bi=new Float64Array(16);F.ad.mat4.invert(bi,He);const wi=F.bR.fromInvProjectionMatrix(bi,Gt,xt,!0);for(const Oe of wi.points){const Fe=((nl=Oe)[0]/=jt,nl[1]/=jt,nl[2]=F.bH(nl[2],Le._center.lat),nl);na=Math.max(na,F.ad.vec3.len(F.ad.vec3.subtract([],Zs,Fe)))}}var nl;na*=qe/(qe-1);const hl=Math.acos(Oe[2]),pl=Math.atan2(-Oe[0],-Oe[1]),bl=new $i;bl.position=Zs,bl.setPitchBearing(hl,pl);const Tl=bl.getWorldToCamera(Gt,Ro),kl=na*Gt,ec=Math.min(Le._mercatorZfromZoom(17)*Gt*-2,-2*kl),tc=bl.getCameraToClipOrthographic(-kl,kl,-kl,kl,ec,(kl+He*Ro)/Oe[2]),ic=new Float64Array(16);F.ad.mat4.multiply(ic,tc,Tl);const oc=F.ad.vec3.fromValues(Math.floor(1e6*Zs[0])/1e6*Gt,Math.floor(1e6*Zs[1])/1e6*Gt,0),sc=.5*qe,ac=[0,0,0];F.ad.vec3.transformMat4(ac,oc,ic),F.ad.vec3.scale(ac,ac,sc);const mc=[Math.floor(ac[0]),Math.floor(ac[1]),Math.floor(ac[2])],gc=[0,0,0];F.ad.vec3.sub(gc,ac,mc),F.ad.vec3.scale(gc,gc,-1/sc);const yc=new Float64Array(16);return F.ad.mat4.identity(yc),F.ad.mat4.translate(yc,yc,gc),F.ad.mat4.multiply(ic,yc,ic),[ic,kl]}class lo extends F.E{constructor(F){super(),this.requestManager=F,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(Le,Oe){return F.aN(this.requestManager.transformRequest(Oe,F.R.Model).url).then((Oe=>{if(!Oe)return;const Fe=F.aO(Oe),je=new F.aP(Le,void 0,void 0,Fe);return je.computeBoundsAndApplyParent(),je})).catch((Fe=>{if(Fe&&404===Fe.status)return null;this.fire(new F.z(new Error(`Could not load model ${Le} from ${Oe}: ${Fe.message}`)))}))}load(Le,Oe,Fe={keepNumReferences:!1}){this.models[Oe]||(this.models[Oe]={});const je=Object.keys(Le);this.numModelsLoading[Oe]=(this.numModelsLoading[Oe]||0)+je.length;const qe=[];for(const F of je)qe.push(this.loadModel(F,Le[F]));Promise.allSettled(qe).then((Le=>{for(let F=0;F<Le.length;F++){const{status:qe,value:He}=Le[F];if("fulfilled"===qe&&He){const Le=this.models[Oe][je[F]];this.models[Oe][je[F]]={model:He,numReferences:Fe.keepNumReferences&&Le?Le.numReferences:1}}}this.numModelsLoading[Oe]-=je.length,this.fire(new F.A("data",{dataType:"style"}))})).catch((Le=>{this.fire(new F.z(new Error(`Could not load models: ${Le.message}`)))}))}isLoaded(){for(const F in this.numModelsLoading)if(this.numModelsLoading[F]>0)return!1;return!0}hasModel(F,Le){return!!this.getModel(F,Le)}getModel(F,Le){return this.models[Le]||(this.models[Le]={}),this.models[Le][F]?this.models[Le][F].model:void 0}addModel(F,Le,Oe){this.models[Oe]||(this.models[Oe]={}),this.modelUris[Oe]||(this.modelUris[Oe]={}),this.hasModel(F,Oe)&&this.models[Oe][F].numReferences++,this.modelUris[Oe][F]=this.requestManager.normalizeModelURL(Le),this.load({[F]:this.modelUris[Oe][F]},Oe)}addModels(F,Le){this.models[Le]||(this.models[Le]={}),this.modelUris[Le]||(this.modelUris[Le]={});const Oe=this.modelUris[Le];for(const Fe in F)this.models[Le][Fe]={},Oe[Fe]=this.requestManager.normalizeModelURL(F[Fe]);this.load(Oe,Le,{keepNumReferences:!0})}reloadModels(F){this.load(this.modelUris[F],F)}addModelsFromBucket(F,Le){this.models[Le]||(this.models[Le]={}),this.modelUris[Le]||(this.modelUris[Le]={});const Oe={};for(const Fe of F)this.hasModel(Fe,Le)?this.models[Le][Fe].numReferences++:(this.modelUris[Le][Fe]=this.requestManager.normalizeModelURL(Fe),Oe[Fe]=this.modelUris[Le][Fe]);this.load(Oe,Le)}removeModel(F,Le){if(this.models[Le]&&this.models[Le][F]&&(this.models[Le][F].numReferences--,0===this.models[Le][F].numReferences)){const Oe=this.models[Le][F].model;delete this.models[Le][F],delete this.modelUris[Le][F],Oe.destroy()}}listModels(F){return this.models[F]||(this.models[F]={}),Object.keys(this.models[F])}upload(F,Le){this.models[Le]||(this.models[Le]={});for(const Oe in this.models[Le])this.models[Le][Oe].model&&this.models[Le][Oe].model.upload(F.context)}}const ru=new F.a7({data:new F.a8(F.a5.colorTheme.data)}),nu={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function uo(F){return F=F||{},Object.assign(F,nu)}class _o extends F.E{constructor(Le){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},F.aQ(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=Le,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle((Le=>{Le.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new F.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=Le.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=Le.stylesheet.indoor.buildingFeaturesetId,this._scope=Le.scope))})),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:F=>(F.feature&&F.feature.properties.floorplan&&this.selectFloorplan(F.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(Le){if(!this._queryFeatureSetId)return;if(!this._map.isStyleLoaded())return;if(this._map.transform.zoom<13)return;this._indoorData&&!function(F,Le){const[Oe,Fe]=F,{center:je,radius:qe}=Le,[He,xt]=je,jt=Math.abs(Oe-He);return Math.sqrt((jt>180?360-jt:jt)**2+(Fe-xt)**2)<=qe}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new F.A("floorplangone")));const Oe={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Fe=new F.P(this._map.transform.width/2,this._map.transform.height/2),je=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],qe=this._map.queryRenderedFeatures(Le?je:Fe,Oe);qe.length>0&&(this._selectedFloorplan&&qe[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=qe[0],this._floorplanSelected(!1)))}_floorplanSelected(Le){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(F){const[[Le,Oe],[Fe,je]]=F,qe=(Fe-Le+360)%360,He=qe>180?360-qe:qe;return{center:[(Le+He/2+360)%360,(Oe+je)/2],radius:Math.sqrt(He**2+(je-Oe)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const Oe=this._floorplanStates[this._indoorData.id].selectedBuilding,Fe=this._floorplanStates[this._indoorData.id].selectedLevel;let je;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const F of this._indoorData.levels)F.id===this._selectedLevel.id&&(je=F.id);if(this.fire(new F.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:je})),Oe){const F=this._indoorData.buildings.find((F=>F.id===Oe));this._buildingSelected(F,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(Fe){const F=this._indoorData.levels.find((F=>F.id===Fe));this._updateLevels(F,Le)}else Le&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(Le,Oe){Oe&&Le&&Le.extent&&this._map.fitBounds(Le.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=Le?Le.id:void 0;const Fe=this._indoorData.levels.filter((F=>Le.levels.includes(F.id)));this.fire(new F.A("buildingselected",{buildingId:Le.id,levels:Fe}))}_levelSelected(Le){if("overview"===Le)this._updateLevels(void 0,!0);else{const F=this._indoorData.levels.find((F=>F.id===Le));this._updateLevels(F,!0)}this.fire(new F.A("levelselected",{levelId:"overview"===Le?void 0:Le}))}_updateLevels(F,Le){if(!F)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(Le&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function i(F){const Le=F.indexOf("/floor/");if(-1===Le)return F;const Oe=Le+7,Fe=F.indexOf("/",Oe);return-1===Fe?F.slice(Oe):F.slice(Oe,Fe)}this._selectedLevel=F,this._floorplanStates[this._indoorData.id].selectedLevel=F?F.id:void 0;const Oe=[],Fe={},je={},qe={},He={};for(const Le of this._indoorData.levels)if(Oe.push(Le.id),Fe[Le.id]=Le.height,je[Le.id]=Le.base,F){if(this.mergeFloors){const Oe=i(F.id),Fe=i(Le.id);qe[Le.id]=Fe===Oe?"true":"false"}else qe[Le.id]=Le.id===F.id?"true":"false";He[Le.id]=Le.base<F.base?"true":"false"}else He[Le.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",Oe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",Fe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",je]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",qe]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",He]),F&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!F.isUnderground),Le&&F.extent)){const Le=this._map.cameraForBounds(F.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),Oe=this._map.getZoom(),Fe=Le.zoom?Math.abs(Oe-Le.zoom):0;this._map.fitBounds(F.extent,Fe>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:Oe})}}selectFloorplan(Le){const Oe={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},Fe=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],je=this._map.queryRenderedFeatures(Fe,Oe);if(je.length>0)for(const F of je)if(JSON.parse(F.properties["indoor-data"]).floorplanIDs.includes(Le)){this._selectedFloorplan=F,this._floorplanSelected(!0);break}}selectBuilding(F){const Le=this._indoorData.buildings.find((Le=>Le.id===F));this._buildingSelected(Le,!0)}selectLevel(F){this._levelSelected(F)}}function po(Le){if(!Le.metadata||!Le.metadata.content_area)return;const Oe=F.q.devicePixelRatio,{left:Fe,top:je,width:qe,height:He}=Le.metadata.content_area,xt=Fe*Oe,jt=je*Oe;return[xt,jt,xt+qe*Oe,jt+He*Oe]}function fo(Le){if(Le)return Le.map((([Le,Oe])=>[Le*F.q.devicePixelRatio,Oe*F.q.devicePixelRatio]))}class mo{constructor(F,Le){this.id=F,this.style=Le}addIcons(Le){const Oe=new Map;for(const[Fe,je]of Le.entries()){const Le=F.I.from({name:Fe,iconsetId:this.id});Oe.set(Le,je)}this.style.addImages(Oe)}}const go=(F,Le)=>Ae(F,Le&&Le.filter((F=>"source.canvas"!==F.identifier))),su=F.aA(rh,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),au=F.aA(rh,["setCenter","setZoom","setBearing","setPitch"]),hu=new Set(["background","sky","slot","custom"]),du={version:8,layers:[],sources:{}},pu={duration:300,delay:0};class To extends F.E{constructor(Le,Oe={}){super(),this.map=Le,this.scope=Oe.scope||"",this.globalId=null,this.fragments=[],this.importDepth=Oe.importDepth||0,this.importsCache=Oe.importsCache||new Map,this.resolvedImports=Oe.resolvedImports||new Set,this.transition=F.l({},pu),this._buildingIndex=new Dt(this),this.crossTileSymbolIndex=new Oi,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=Oe.styleChanges||new G,this.dispatcher=Oe.dispatcher?Oe.dispatcher:new F.D(F.cj(),this),Oe.imageManager?this.imageManager=Oe.imageManager:(this.imageManager=new q(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=Oe.glyphManager?Oe.glyphManager:new F.ck(Le._requestManager,Oe.localFontFamily?F.cl.all:Oe.localIdeographFontFamily?F.cl.ideographs:F.cl.none,Oe.localFontFamily||Oe.localIdeographFontFamily),Oe.modelManager?this.modelManager=Oe.modelManager:(this.modelManager=new lo(Le._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=Oe.configOptions?Oe.configOptions:new Map,this._configDependentLayers=Oe.configDependentLayers?Oe.configDependentLayers:new Set,this._config=Oe.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:Oe.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=Oe.initialConfig,this.dispatcher.broadcast("setReferrer",F.cm());const Fe=this;this._rtlTextPluginCallback=To.registerForPluginStateChange((Le=>{Fe.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:Le.pluginStatus,pluginURL:Le.pluginURL},((Le,Oe)=>{if(F.cn(Le),Oe&&Oe.every((F=>F)))for(const F in Fe._sourceCaches){const Le=Fe._sourceCaches[F],Oe=Le.getSource().type;"vector"!==Oe&&"geojson"!==Oe||Le.reload()}}))})),this.on("data",(F=>{if("source"!==F.dataType||"metadata"!==F.sourceDataType)return;const Le=this.getOwnSource(F.sourceId);if(Le&&Le.vectorLayerIds)for(const F in this._layers){const Oe=this._layers[F];Oe.source===Le.id&&this._validateLayer(Oe)}}))}load(F){return F?("string"==typeof F?this.loadURL(F):this.loadJSON(F),this):this}_getGlobalId(Le){if(!Le)return null;if("string"==typeof Le){if(F.f(Le))return Le;const Oe=F.co(Le);if(!Oe.startsWith("http"))try{return new URL(Oe,location.href).toString()}catch(F){return Oe}return Oe}return`json://${F.cp(JSON.stringify(Le))}`}_diffStyle(Le,Oe,Fe){this.globalId=this._getGlobalId(Le);const s=(F,Le)=>{try{Le(null,this.setState(F,Fe))}catch(F){Le(F,!1)}};if("string"==typeof Le){const Fe=this.map._requestManager.normalizeStyleURL(Le),je=this.map._requestManager.transformRequest(Fe,F.R.Style);F.n(je,((Le,Fe)=>{Le?this.fire(new F.z(Le)):Fe&&s(Fe,Oe)}))}else"object"==typeof Le&&s(Le,Oe)}loadURL(Le,Oe={}){this.fire(new F.A("dataloading",{dataType:"style"}));const Fe="boolean"==typeof Oe.validate?Oe.validate:!F.f(Le);this.globalId=this._getGlobalId(Le),Le=this.map._requestManager.normalizeStyleURL(Le,Oe.accessToken),this.resolvedImports.add(Le);const je=this.importsCache.get(Le);if(je)return this._load(je,Fe);const qe=this.map._requestManager.transformRequest(Le,F.R.Style);this._request=F.n(qe,((Oe,je)=>{if(this._request=null,Oe)this.fire(new F.z(Oe));else if(je)return this.importsCache.set(Le,je),this._load(je,Fe)}))}loadJSON(Le,Oe={}){this.fire(new F.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(Le),this._request=F.q.frame((()=>{this._request=null,this._load(Le,!1!==Oe.validate)}))}loadEmpty(){this.fire(new F.A("dataloading",{dataType:"style"})),this._load(du,!1)}_loadImports(Le,Oe,Fe){if(this.importDepth>=4)return F.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const je=[];for(const F of Le){const Le=this._createFragmentStyle(F),qe=new Promise((F=>{Le.once("style.import.load",F),Le.once("error",F)})).then((()=>this.mergeAll()));if(je.push(qe),this.resolvedImports.has(F.url)){Le.loadEmpty();continue}const He=F.data||this.importsCache.get(F.url);He?(Le.loadJSON(He,{validate:Oe}),this._isInternalStyle(He)&&(Le.globalId=null)):F.url?Le.loadURL(F.url,{validate:Oe}):Le.loadEmpty();const xt={style:Le,id:F.id,config:F.config};if(Fe){const F=this.fragments.findIndex((({id:F})=>F===Fe));this.fragments=this.fragments.slice(0,F).concat(xt).concat(this.fragments.slice(F))}else this.fragments.push(xt)}return Promise.allSettled(je)}getImportGlobalIds(F=this,Le=new Set){for(const Oe of F.fragments)Oe.style.globalId&&Le.add(Oe.style.globalId),this.getImportGlobalIds(Oe.style,Le);return[...Le.values()]}_createFragmentStyle(Le){const Oe=this.scope?F.C(Le.id,this.scope):Le.id;let Fe;const je=this._initialConfig&&this._initialConfig[Oe];(Le.config||je)&&(Fe=F.l({},Le.config,je));const qe=new To(this.map,{scope:Oe,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:Fe,configOptions:this.options,colorThemeOverride:Le["color-theme"],configDependentLayers:this._configDependentLayers});return qe.setEventedParent(this.map,{style:qe}),qe}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(F){return this.isRootStyle()&&(F.fragment||!!F.schema&&!1!==F.fragment)}_load(Le,Oe){const Fe=Le.indoor?uo(Le.schema):Le.schema;if(this._isInternalStyle(Le)){const Fe=F.l({},du,{imports:[{id:"basemap",data:Le,url:""}]});return void this._load(Fe,Oe)}if(this.updateConfig(this._config,Fe),Oe&&go(this,me(Le)))return;this._loaded=!0,this.stylesheet=F.cq(Le);const s=()=>{for(const F in Le.sources)this.addSource(F,Le.sources[F],{validate:!1,isInitialLoad:!0});if(Le.iconsets)for(const F in Le.iconsets)this.addIconset(F,Le.iconsets[F]);Le.sprite?this._loadIconset(Le.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(Le.glyphs);const Fe=Lt(this.stylesheet.layers);if(this._order=Fe.map((F=>F.id)),this.stylesheet.light&&F.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const F=this.stylesheet.lights[0];this.light=new Me(F.properties,F.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Me(this.stylesheet.light)),this._layers={};for(const Le of Fe){const Oe=F.cv(Le,this.scope,this._styleColorTheme.lut,this.options);0!==Oe.configDependencies.size&&this._configDependentLayers.add(Oe.fqid),Oe.setEventedParent(this,{layer:{id:Oe.id}}),this._layers[Oe.id]=Oe;const Fe=this.getOwnLayerSourceCache(Oe),je=!!this.directionalLight&&this.directionalLight.shadowsEnabled();Fe&&Oe.canCastShadows()&&je&&(Fe.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const je=this.stylesheet.terrain;je&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(je,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new F.A("data",{dataType:"style"}));const qe=this.isRootStyle();Le.imports?this._loadImports(Le.imports,Oe).then((()=>{this._reloadImports(),this.fire(new F.A(qe?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new F.A(qe?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const je=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(je){const Le=this._evaluateColorThemeData(je);this._loadColorTheme(Le).then((()=>{s()})).catch((Le=>{F.w(`Couldn't load color theme from the stylesheet: ${Le}`),s()}))}else this._styleColorTheme.lut=null,s()}isRootStyle(){return 0===this.importDepth}mergeAll(){let Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi;const wi={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((F=>{if(F.stylesheet){if(null!=F.light&&(Le=F.light),F.stylesheet.lights)for(const Le of F.stylesheet.lights)"ambient"===Le.type&&null!=F.ambientLight&&(Oe=F.ambientLight),"directional"===Le.type&&null!=F.directionalLight&&(Fe=F.directionalLight);je=this._prioritizeTerrain(je,F.terrain,F.stylesheet.terrain),F.stylesheet.fog&&null!=F.fog&&(qe=F.fog),F.stylesheet.snow&&null!=F.snow&&(He=F.snow),F.stylesheet.rain&&null!=F.rain&&(xt=F.rain),null!=F.stylesheet.camera&&(bi=F.stylesheet.camera),null!=F.stylesheet.projection&&(jt=F.stylesheet.projection),null!=F.stylesheet.transition&&(Gt=F.stylesheet.transition),wi[F.scope]=F._styleColorTheme}})),this.light=Le,this.ambientLight=Oe,this.directionalLight=Fe,this.fog=qe,this.snow=He,this.rain=xt,this._styleColorThemeForScope=wi,null===je?delete this.terrain:this.terrain=je,this.camera=bi||{"camera-projection":"perspective"},this.projection=jt||{name:"mercator"},this.transition=F.l({},pu,Gt),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(F){const t=Le=>{for(const F of Le.fragments)t(F.style);F(Le)};t(this)}_prioritizeTerrain(F,Le,Oe){const Fe=F&&0===F.drapeRenderMode;return null===Oe?Le&&0===Le.drapeRenderMode?Le:Fe?F:null:null!=Le&&(!F||Fe||Le&&1===Le.drapeRenderMode)?Le:F}mergeTerrain(){let F;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((Le=>{F=this._prioritizeTerrain(F,Le.terrain,Le.stylesheet.terrain)})),null===F?delete this.terrain:this.terrain=F}mergeProjection(){let F;this.forEachFragmentStyle((Le=>{null!=Le.stylesheet.projection&&(F=Le.stylesheet.projection)})),this.projection=F||{name:"mercator"}}mergeSources(){const Le={},Oe={},Fe={};this.forEachFragmentStyle((je=>{for(const Oe in je._sourceCaches){const Fe=F.C(Oe,je.scope);Le[Fe]=je._sourceCaches[Oe]}for(const Le in je._otherSourceCaches){const Fe=F.C(Le,je.scope);Oe[Fe]=je._otherSourceCaches[Le]}for(const Le in je._symbolSourceCaches){const Oe=F.C(Le,je.scope);Fe[Oe]=je._symbolSourceCaches[Le]}})),this._mergedSourceCaches=Le,this._mergedOtherSourceCaches=Oe,this._mergedSymbolSourceCaches=Fe}mergeLayers(){const Le={},Oe=[],Fe={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((Fe=>{for(const je of Fe._order){const qe=Fe._layers[je];if("slot"===qe.type){const Oe=F.cr(je);if(Le[Oe])continue;Le[Oe]=[]}qe.slot&&Le[qe.slot]?Le[qe.slot].push(qe):Oe.push(qe)}})),this._mergedOrder=[];const s=(Oe=[])=>{for(const je of Oe)if("slot"===je.type){const Oe=F.cr(je.id);Le[Oe]&&s(Le[Oe]),this._mergedSlots.push(Oe)}else{const Le=F.C(je.id,je.scope);this._mergedOrder.push(Le),Fe[Le]=je,je.is3D(!!this.terrain)&&(this._has3DLayers=!0),"circle"===je.type&&(this._hasCircleLayers=!0),"symbol"===je.type&&(this._hasSymbolLayers=!0),"clip"===je.type&&(this._clipLayerPresent=!0)}};s(Oe),this._mergedOrder.sort(((F,Le)=>{const Oe=Fe[F],je=Fe[Le];return Oe.hasInitialOcclusionOpacityProperties?je.is3D(!!this.terrain)?1:0:Oe.is3D(!!this.terrain)&&je.hasInitialOcclusionOpacityProperties?-1:0})),this._mergedLayers=Fe,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(Le){return this.stylesheet.camera=F.l({},this.stylesheet.camera,Le),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(Le){return Le.data?function(Le,Oe,Fe){const je=F.l({},Oe);for(const Le of Object.keys(F.a5.colorTheme))void 0===je[Le]&&(je[Le]=F.a5.colorTheme[Le].default);const qe=new F.a6(ru,Le,new Map(Fe));return qe.setTransitionOrValue(je,Fe),qe.untransitioned().possiblyEvaluate(new F.aa(0))}(this.scope,Le,this.options).get("data"):null}_loadColorTheme(Le){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const Oe=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((Fe,je)=>{const qe="data:image/png;base64,";if(!Le||0===Le.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void Fe();let He=Le;He.startsWith(qe)||(He=qe+He);const xt=F.I.from("mapbox-reserved-lut"),jt=new Image;jt.src=He,jt.onerror=()=>{this._styleColorTheme.lutLoading=!1,je(new Error("Failed to load image data"))},jt.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==Oe)return void Fe();this._styleColorTheme.lutLoading=!1;const{width:qe,height:He,data:Gt}=F.q.getImageData(jt);if(He>32)return void je(new Error("The height of the image must be less than or equal to 32 pixels."));if(qe!==He*He)return void je(new Error("The width of the image must be equal to the height squared."));this.getImage(xt)&&this.removeImage(xt),this.addImage(xt,{data:new F.r({width:qe,height:He},Gt),pixelRatio:1,sdf:!1,usvg:!1,version:0});const bi=this.imageManager.getImage(xt,this.scope);bi?(this._styleColorTheme.lut={image:bi.data,data:Le},Fe()):je(new Error("Missing LUT image."))}}))}getLut(F){const Le=this._styleColorThemeForScope[F];return Le?Le.lut:null}setProjection(F){F?this.stylesheet.projection=F:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(Le){this._spriteRequest=function(Le,Oe,Fe){let je,qe,He;const xt=F.q.devicePixelRatio>1?"@2x":"";let jt=F.n(Oe.transformRequest(Oe.normalizeSpriteURL(Le,xt,".json"),F.R.SpriteJSON),((F,Le)=>{jt=null,He||(He=F,je=Le,h())})),Gt=F.o(Oe.transformRequest(Oe.normalizeSpriteURL(Le,xt,".png"),F.R.SpriteImage),((F,Le)=>{Gt=null,He||(He=F,qe=Le,h())}));function h(){if(He)Fe(He);else if(je&&qe){const Le=F.q.getImageData(qe),Oe={};for(const Fe in je){const{width:qe,height:He,x:xt,y:jt,sdf:Gt,pixelRatio:bi,stretchX:wi,stretchY:qr,content:Xn}=je[Fe],Yn=new F.r({width:qe,height:He});F.r.copy(Le,Yn,{x:xt,y:jt},{x:0,y:0},{width:qe,height:He},null),Oe[Fe]={data:Yn,pixelRatio:bi,sdf:Gt,stretchX:wi,stretchY:qr,content:Xn,usvg:!1}}Fe(null,Oe)}}return{cancel(){jt&&(jt.cancel(),jt=null),Gt&&(Gt.cancel(),Gt=null)}}}(Le,this.map._requestManager,((Le,Oe)=>{if(this._spriteRequest=null,Le)this.fire(new F.z(Le));else if(Oe){const Le=new Map;for(const Fe in Oe)Le.set(F.I.from(Fe),Oe[Fe]);this.addImages(Le)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.A("data",{dataType:"style"}))}))}addIconset(Le,Oe){if("sprite"===Oe.type)return void this._loadSprite(Oe.url);const Fe=this.getOwnSource(Oe.source);if(!Fe)return void this.fire(new F.z(new Error(`Source "${Oe.source}" as specified by iconset "${Le}" does not exist and cannot be used as an iconset source`)));if("raster-array"!==Fe.type)return void this.fire(new F.z(new Error(`Source "${Oe.source}" as specified by iconset "${Le}" is not a "raster-array" source and cannot be used as an iconset source`)));this.imageManager.createIconset(this.scope,Le);const je=new mo(Le,this);Fe.addIconset(Le,je)}_loadIconset(Le){if(!F.f(Le)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(Le);const Oe="auto"===this.map._spriteFormat;var Fe,je;this._spriteRequest=(je=(Fe,je)=>{if(this._spriteRequest=null,Fe)Oe?this._loadSprite(Le):this.fire(new F.z(Fe));else if(je){const Le=new Map;for(const Oe in je)Le.set(F.I.from(Oe),je[Oe]);this.addImages(Le)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.A("data",{dataType:"style"}))},F.bj((Fe=this.map._requestManager).transformRequest(Fe.normalizeIconsetURL(Le),F.R.Iconset),((Le,Oe)=>{if(Le)return void je(Le);const Fe={},qe=F.ch(new F.bi(Oe));for(const Le of qe.icons){const Oe={version:1,pixelRatio:F.q.devicePixelRatio,content:po(Le),stretchX:Le.metadata?fo(Le.metadata.stretch_x_areas):void 0,stretchY:Le.metadata?fo(Le.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:Le};Fe[Le.name]=Oe}je(null,Fe)})))}_validateLayer(Le){const Oe=this.getOwnSource(Le.source);if(!Oe)return;const Fe=Le.sourceLayer;Fe&&("geojson"===Oe.type||Oe.vectorLayerIds&&-1===Oe.vectorLayerIds.indexOf(Fe))&&this.fire(new F.z(new Error(`Source layer "${Fe}" does not exist on source "${Oe.id}" as specified by style layer "${Le.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const F in this._sourceCaches)if(!this._sourceCaches[F].loaded())return!1;if(!this.imageManager.isLoaded())return!1;if(this.imageManager.hasPatternsInFlight())return!1;if(!this.modelManager.isLoaded())return!1;if(this._styleColorTheme.lutLoading)return!1;for(const{style:F}of this.fragments)if(!F.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((F,Le)=>{const Oe=this.fragments[Le];return Oe&&Oe.style&&(F.data=Oe.style.serialize()),F}))}_serializeSources(){const F={};for(const Le in this._sourceCaches){const Oe=this._sourceCaches[Le].getSource();F[Oe.id]||(F[Oe.id]=Oe.serialize())}return F}_serializeLayers(F){const Le=[];for(const Oe of F){const F=this._layers[Oe];F&&"custom"!==F.type&&Le.push(F.serialize())}return Le}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions())return!0;if(this.hasFogTransition())return!0;if(this.hasSnowTransition())return!0;if(this.hasRainTransition())return!0;for(const F in this._sourceCaches)if(this._sourceCaches[F].hasTransition())return!0;for(const F in this._layers)if(this._layers[F].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(F){return F?this.order:this._mergedOrder}isLayerDraped(F){return!!this.terrain&&F.isDraped(this.getLayerSourceCache(F))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(Le){const Oe=this.getOwnLayer(Le);if(Oe)return Oe;this.fire(new F.z(new Error(`The layer '${Le}' does not exist in the map's style.`)))}_checkSource(Le){const Oe=this.getOwnSource(Le);if(Oe)return Oe;this.fire(new F.z(new Error(`The source '${Le}' does not exist in the map's style.`)))}precompilePrograms(F,Le){const Oe=this.map.painter;if(Oe)for(let Fe=F.minzoom||0;Fe<(F.maxzoom||25.5);Fe++){const Fe=F.getProgramIds();if(Fe)for(const je of Fe){const Fe=F.getDefaultProgramParams(je,Le.zoom,this._styleColorTheme.lut);Fe&&(Oe.style=this,this.fog&&(Oe._fogVisible=!0,Fe.overrideFog=!0,Oe.getOrCreateProgram(je,Fe)),Oe._fogVisible=!1,Fe.overrideFog=!1,Oe.getOrCreateProgram(je,Fe),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(Fe.overrideRtt=!0,Oe.getOrCreateProgram(je,Fe)))}}}update(Le){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(Le),this.directionalLight&&this.directionalLight.recalculate(Le);const Oe=this.calculateLightsBrightness();Le.brightness=Oe||0,Oe!==this._brightness&&(this._brightness=Oe,this.dispatcher.broadcast("setBrightness",Oe));const Fe=this._changes.isDirty();let je=!1;if(this._changes.isDirty()){const F=this._changes.getLayerUpdatesByScope();for(const Le in F){const{updatedIds:Oe,removedIds:Fe}=F[Le];(Oe||Fe)&&(this._updateWorkerLayers(Le,Oe,Fe),je=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(Le),this.light&&this.light.updateTransitions(Le),this.ambientLight&&this.ambientLight.updateTransitions(Le),this.directionalLight&&this.directionalLight.updateTransitions(Le),this.fog&&this.fog.updateTransitions(Le),this.snow&&this.snow.updateTransitions(Le),this.rain&&this.rain.updateTransitions(Le),this._changes.reset()}const qe={};for(const F in this._mergedSourceCaches){const Le=this._mergedSourceCaches[F];qe[F]=Le.used,Le.used=!1,Le.tileCoverLift=0}for(const F of this._mergedOrder){const Oe=this._mergedLayers[F];if(Oe.recalculate(Le,this._availableImages),!Oe.isHidden(Le.zoom)){const F=this.getLayerSourceCache(Oe);F&&(F.used=!0,F.tileCoverLift=Math.max(F.tileCoverLift,Oe.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(Oe,Le)})):this.precompilePrograms(Oe,Le))}for(const F in this._mergedSourceCaches){const Le=this._mergedSourceCaches[F];if(!Le)continue;const Oe=Le._source;"raster-array"===Oe.type&&Oe.iconsets&&(Le.used=!0)}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&je&&this.mergeLayers();for(const Le in qe){const Oe=this._mergedSourceCaches[Le];qe[Le]!==Oe.used&&Oe.getSource().fire(new F.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:Oe.getSource().id}))}this.light&&this.light.recalculate(Le),this.terrain&&this.terrain.recalculate(Le),this.fog&&this.fog.recalculate(Le),this.snow&&this.snow.recalculate(Le),this.rain&&this.rain.recalculate(Le),this.z=Le.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),Fe&&this.fire(new F.A("data",{dataType:"style"}))}_updateTilesForChangedImages(){const F=this._changes.getUpdatedImages();if(F.length){for(const Le in this._mergedSourceCaches)this._mergedSourceCaches[Le].reloadTilesForDependencies(["icons","patterns"],F);this._changes.resetUpdatedImages()}}_updateWorkerLayers(F,Le,Oe){const Fe=this.getFragmentStyle(F);Fe&&this.dispatcher.broadcast("updateLayers",{layers:Le?Fe._serializeLayers(Le):[],scope:F,removedIds:Oe||[],options:Fe.options})}setState(Le,Oe){if(this._checkLoaded(),go(this,me(Le)))return!1;(Le=F.cq(Le)).layers=Lt(Le.layers);const Fe=function(Le,Oe){if(!Le)return[{command:rh.setStyle,args:[Oe]}];let Fe=[];try{if(!F.bn(Le.version,Oe.version))return[{command:rh.setStyle,args:[Oe]}];if(F.bn(Le.center,Oe.center)||Fe.push({command:rh.setCenter,args:[Oe.center]}),F.bn(Le.zoom,Oe.zoom)||Fe.push({command:rh.setZoom,args:[Oe.zoom]}),F.bn(Le.bearing,Oe.bearing)||Fe.push({command:rh.setBearing,args:[Oe.bearing]}),F.bn(Le.pitch,Oe.pitch)||Fe.push({command:rh.setPitch,args:[Oe.pitch]}),F.bn(Le.sprite,Oe.sprite)||Fe.push({command:rh.setSprite,args:[Oe.sprite]}),F.bn(Le.glyphs,Oe.glyphs)||Fe.push({command:rh.setGlyphs,args:[Oe.glyphs]}),F.bn(Le.imports,Oe.imports)||function(Le=[],Oe=[],Fe){Oe=Oe||[];const je=(Le=Le||[]).map(Bt),qe=Oe.map(Bt),He=Le.reduce(Nt,{}),xt=Oe.reduce(Nt,{}),jt=je.slice();let Gt,bi,wi,qr;for(Gt=0,bi=0;Gt<je.length;Gt++)wi=je[Gt],xt.hasOwnProperty(wi)?bi++:(Fe.push({command:rh.removeImport,args:[wi]}),jt.splice(jt.indexOf(wi,bi),1));for(Gt=0,bi=0;Gt<qe.length;Gt++)wi=qe[qe.length-1-Gt],jt[jt.length-1-Gt]!==wi&&(He.hasOwnProperty(wi)?(Fe.push({command:rh.removeImport,args:[wi]}),jt.splice(jt.lastIndexOf(wi,jt.length-bi),1)):bi++,qr=jt[jt.length-Gt],Fe.push({command:rh.addImport,args:[xt[wi],qr]}),jt.splice(jt.length-Gt,0,wi));for(const Le of Oe){const Oe=He[Le.id];Oe&&!F.bn(Oe,Le)&&Fe.push({command:rh.updateImport,args:[Le.id,Le]})}}(Le.imports,Oe.imports,Fe),F.bn(Le.transition,Oe.transition)||Fe.push({command:rh.setTransition,args:[Oe.transition]}),F.bn(Le.light,Oe.light)||Fe.push({command:rh.setLight,args:[Oe.light]}),F.bn(Le.fog,Oe.fog)||Fe.push({command:rh.setFog,args:[Oe.fog]}),F.bn(Le.snow,Oe.snow)||Fe.push({command:rh.setSnow,args:[Oe.snow]}),F.bn(Le.rain,Oe.rain)||Fe.push({command:rh.setRain,args:[Oe.rain]}),F.bn(Le.projection,Oe.projection)||Fe.push({command:rh.setProjection,args:[Oe.projection]}),F.bn(Le.lights,Oe.lights)||Fe.push({command:rh.setLights,args:[Oe.lights]}),F.bn(Le.camera,Oe.camera)||Fe.push({command:rh.setCamera,args:[Oe.camera]}),!F.bn(Le["color-theme"],Oe["color-theme"]))return[{command:rh.setStyle,args:[Oe]}];const je={},qe=[];!function(Le,Oe,Fe,je){let qe;for(qe in Oe=Oe||{},Le=Le||{})Le.hasOwnProperty(qe)&&(Oe.hasOwnProperty(qe)||zt(qe,Fe,je));for(qe in Oe){if(!Oe.hasOwnProperty(qe))continue;const He=Oe[qe];Le.hasOwnProperty(qe)?F.bn(Le[qe],He)||("geojson"===Le[qe].type&&"geojson"===He.type&&Ft(Le,Oe,qe)?Fe.push({command:rh.setGeoJSONSourceData,args:[qe,He.data]}):Ot(qe,Oe,Fe,je)):Pt(qe,Oe,Fe)}}(Le.sources,Oe.sources,qe,je);const He=[];Le.layers&&Le.layers.forEach((F=>{F.source&&je[F.source]?Fe.push({command:rh.removeLayer,args:[F.id]}):He.push(F)}));let xt=Le.terrain;xt&&je[xt.source]&&(Fe.push({command:rh.setTerrain,args:[void 0]}),xt=void 0),Fe=Fe.concat(qe),F.bn(xt,Oe.terrain)||Fe.push({command:rh.setTerrain,args:[Oe.terrain]}),function(Le,Oe,Fe){Oe=Oe||[];const je=(Le=Le||[]).map(Bt),qe=Oe.map(Bt),He=Le.reduce(Nt,{}),xt=Oe.reduce(Nt,{}),jt=je.slice(),Gt=Object.create(null);let bi,wi,qr,Xn,Yn,yo,bo;for(bi=0,wi=0;bi<je.length;bi++)qr=je[bi],xt.hasOwnProperty(qr)?wi++:(Fe.push({command:rh.removeLayer,args:[qr]}),jt.splice(jt.indexOf(qr,wi),1));for(bi=0,wi=0;bi<qe.length;bi++)qr=qe[qe.length-1-bi],jt[jt.length-1-bi]!==qr&&(He.hasOwnProperty(qr)?(Fe.push({command:rh.removeLayer,args:[qr]}),jt.splice(jt.lastIndexOf(qr,jt.length-wi),1)):wi++,yo=jt[jt.length-bi],Fe.push({command:rh.addLayer,args:[xt[qr],yo]}),jt.splice(jt.length-bi,0,qr),Gt[qr]=!0);for(bi=0;bi<qe.length;bi++)if(qr=qe[bi],Xn=He[qr],Yn=xt[qr],!Gt[qr]&&!F.bn(Xn,Yn))if(F.bn(Xn.source,Yn.source)&&F.bn(Xn["source-layer"],Yn["source-layer"])&&F.bn(Xn.type,Yn.type)){for(bo in kt(Xn.layout,Yn.layout,Fe,qr,null,rh.setLayoutProperty),kt(Xn.paint,Yn.paint,Fe,qr,null,rh.setPaintProperty),F.bn(Xn.slot,Yn.slot)||Fe.push({command:rh.setSlot,args:[qr,Yn.slot]}),F.bn(Xn.filter,Yn.filter)||Fe.push({command:rh.setFilter,args:[qr,Yn.filter]}),F.bn(Xn.minzoom,Yn.minzoom)&&F.bn(Xn.maxzoom,Yn.maxzoom)||Fe.push({command:rh.setLayerZoomRange,args:[qr,Yn.minzoom,Yn.maxzoom]}),Xn)Xn.hasOwnProperty(bo)&&"layout"!==bo&&"paint"!==bo&&"filter"!==bo&&"metadata"!==bo&&"minzoom"!==bo&&"maxzoom"!==bo&&"slot"!==bo&&(0===bo.indexOf("paint.")?kt(Xn[bo],Yn[bo],Fe,qr,bo.slice(6),rh.setPaintProperty):F.bn(Xn[bo],Yn[bo])||Fe.push({command:rh.setLayerProperty,args:[qr,bo,Yn[bo]]}));for(bo in Yn)Yn.hasOwnProperty(bo)&&!Xn.hasOwnProperty(bo)&&"layout"!==bo&&"paint"!==bo&&"filter"!==bo&&"metadata"!==bo&&"minzoom"!==bo&&"maxzoom"!==bo&&"slot"!==bo&&(0===bo.indexOf("paint.")?kt(Xn[bo],Yn[bo],Fe,qr,bo.slice(6),rh.setPaintProperty):F.bn(Xn[bo],Yn[bo])||Fe.push({command:rh.setLayerProperty,args:[qr,bo,Yn[bo]]}))}else Fe.push({command:rh.removeLayer,args:[qr]}),yo=jt[jt.lastIndexOf(qr)+1],Fe.push({command:rh.addLayer,args:[Yn,yo]})}(He,Oe.layers,Fe)}catch(F){console.warn("Unable to compute style diff:",F),Fe=[{command:rh.setStyle,args:[Oe]}]}return Fe}(this.serialize(),Le).filter((F=>!(F.command in au)));if(0===Fe.length)return!1;const je=Fe.filter((F=>!(F.command in su)));if(je.length>0)throw new Error(`Unimplemented: ${je.map((F=>F.command)).join(", ")}.`);const qe=[];return Fe.forEach((F=>{qe.push(this[F.command].apply(this,F.args))})),Oe&&Promise.all(qe).then(Oe),this.stylesheet=Le,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}addImages(Le){for(const[Oe,Fe]of Le.entries()){if(this.getImage(Oe)&&!Oe.iconsetId)return this.fire(new F.z(new Error(`An image with the name "${Oe.name}" already exists.`)));this.imageManager.addImage(Oe,this.scope,Fe),this._changes.updateImage(Oe)}return this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})),this}addImage(Le,Oe){return this.getImage(Le)&&!Le.iconsetId?this.fire(new F.z(new Error(`An image with the name "${Le.name}" already exists.`))):(this.imageManager.addImage(Le,this.scope,Oe),this._changes.updateImage(Le),this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})),this)}updateImage(Le,Oe,Fe=!1){this.imageManager.updateImage(Le,this.scope,Oe),Fe&&(this._changes.updateImage(Le),this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})))}getImage(F){return this.imageManager.getImage(F,this.scope)}removeImage(Le){return this.getImage(Le)?(this.imageManager.removeImage(Le,this.scope),this._changes.updateImage(Le),this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})),this):this.fire(new F.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(F,Le,Oe={}){return this._checkLoaded(),this._validate(Re,`models.${F}`,Le,null,Oe)||(this.modelManager.addModel(F,Le,this.scope),this._changes.setDirty()),this}hasModel(F){return this.modelManager.hasModel(F,this.scope)}removeModel(Le){return this.hasModel(Le)?(this.modelManager.removeModel(Le,this.scope),this):this.fire(new F.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(Le,Oe,Fe={}){if(this._checkLoaded(),void 0!==this.getOwnSource(Le))throw new Error(`There is already a source with ID "${Le}".`);if(!Oe.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(Oe).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(Oe.type)>=0&&this._validate(ge,`sources.${Le}`,Oe,null,Fe))return;this.map&&this.map._collectResourceTiming&&(Oe.collectResourceTiming=!0);const je=rt(Le,Oe,this.dispatcher,this);je.scope=this.scope,je.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(je.id),source:je.serialize(),sourceId:je.id})));const r=Le=>{const Oe=(Le?"symbol:":"other:")+je.id,Fe=F.C(Oe,this.scope),qe=this._sourceCaches[Oe]=new St(Fe,je,Le);(Le?this._symbolSourceCaches:this._otherSourceCaches)[je.id]=qe,qe.onAdd(this.map)};r(!1),"vector"!==Oe.type&&"geojson"!==Oe.type||r(!0),je.onAdd&&je.onAdd(this.map),Fe.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(Le){this._checkLoaded();const Oe=this.getOwnSource(Le);if(!Oe)throw new Error("There is no source with this ID");for(const Oe in this._layers)if(this._layers[Oe].source===Le)return this.fire(new F.z(new Error(`Source "${Le}" cannot be removed while layer "${Oe}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===Le)return this.fire(new F.z(new Error(`Source "${Le}" cannot be removed while terrain is using it.`)));const Fe=this.getOwnSourceCaches(Le);for(const Le of Fe){const Oe=F.cr(Le.id);delete this._sourceCaches[Oe],this._changes.discardSourceCacheUpdate(Le.id),Le.fire(new F.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:Le.getSource().id})),Le.setEventedParent(null),Le.clearTiles()}return delete this._otherSourceCaches[Le],delete this._symbolSourceCaches[Le],this.mergeSources(),Oe.setEventedParent(null),Oe.onRemove&&Oe.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(F,Le){this._checkLoaded(),this.getOwnSource(F).setData(Le),this._changes.setDirty()}getOwnSource(F){const Le=this.getOwnSourceCache(F);return Le&&Le.getSource()}getOwnSources(){const F=[];for(const Le in this._otherSourceCaches){const Oe=this.getOwnSourceCache(Le);Oe&&F.push(Oe.getSource())}return F}areTilesLoaded(){const F=this._mergedSourceCaches;for(const Le in F){const Oe=F[Le]._tiles;for(const F in Oe){const Le=Oe[F];if("loaded"!==Le.state&&"errored"!==Le.state)return!1}}return!0}setLights(Le){if(this._checkLoaded(),!Le)return delete this.ambientLight,void delete this.directionalLight;const Oe=this._getTransitionParameters();for(const Fe of Le){if(this._validate(ye,"lights",Fe))return;switch(Fe.type){case"ambient":if(this.ambientLight){const F=this.ambientLight;F.set(Fe),F.updateTransitions(Oe)}else this.ambientLight=new $e(Fe,ac||(ac=new F.a7({color:new F.a8(F.a5.properties_light_ambient.color),"color-use-theme":new F.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a8(F.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const F=this.directionalLight;F.set(Fe),F.updateTransitions(Oe)}else this.directionalLight=new $e(Fe,mc||(mc=new F.a7({direction:new F.am(F.a5.properties_light_directional.direction),color:new F.a8(F.a5.properties_light_directional.color),"color-use-theme":new F.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a8(F.a5.properties_light_directional.intensity),"cast-shadows":new F.a8(F.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new F.a8(F.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new F.a8(F.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const Fe=new F.aa(this.z||0,Oe);this.ambientLight&&this.ambientLight.recalculate(Fe),this.directionalLight&&this.directionalLight.recalculate(Fe),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const Le=this.directionalLight,Oe=this.ambientLight;if(!Le||!Oe)return;const o=F=>.2126*(F[0]<=.03928?F[0]/12.92:Math.pow((F[0]+.055)/1.055,2.4))+.7152*(F[1]<=.03928?F[1]/12.92:Math.pow((F[1]+.055)/1.055,2.4))+.0722*(F[2]<=.03928?F[2]/12.92:Math.pow((F[2]+.055)/1.055,2.4)),Fe=Le.properties.get("color").toRenderColor(null).toArray01(),je=Le.properties.get("intensity"),qe=Le.properties.get("direction"),He=1-F.cc(qe.x,qe.y,qe.z)[2]/90,xt=o(Fe)*je*He,jt=Oe.properties.get("color").toRenderColor(null).toArray01(),Gt=Oe.properties.get("intensity"),bi=o(jt)*Gt;return Number(((xt+bi)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const F=[];return this.directionalLight&&F.push(this.directionalLight.get()),this.ambientLight&&F.push(this.ambientLight.get()),F}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(Le){if(!Le)return this;if(F.cs(Le)){const Oe=F.ct(Le),Fe=this.fragments.find((({id:F})=>F===Oe));if(!Fe)throw new Error(`Style import '${Le}' not found`);const je=F.cr(Le);return Fe.style.getFragmentStyle(je)}{const F=this.fragments.find((({id:F})=>F===Le));return F?F.style:void 0}}setFeaturesetSelectors(Le){if(!Le)return;const Oe={},o=(F,Le="")=>`${F}::${Le}`;this._featuresetSelectors={};for(const Fe in Le){const je=this._featuresetSelectors[Fe]=[];for(const qe of Le[Fe].selectors){if(qe.featureNamespace){const Le=this.getOwnLayer(qe.layer);if(!Le){F.w(`Layer is undefined for selector: ${qe.layer}`);continue}const je=o(Le.source,Le.sourceLayer);if(je in Oe&&Oe[je]!==qe.featureNamespace){F.w(`"featureNamespace ${qe.featureNamespace} of featureset ${Fe}'s selector is not associated to the same source, skip this selector`);continue}Oe[je]=qe.featureNamespace}let Le;if(qe.properties)for(const Oe in qe.properties){const Fe=F.X(qe.properties[Oe]);"success"===Fe.result&&(Le=Le||{},Le[Oe]=Fe.value)}je.push({layerId:qe.layer,namespace:qe.featureNamespace,properties:Le,uniqueFeatureID:qe._uniqueFeatureID})}}}getFeaturesetDescriptors(F){const Le=this.getFragmentStyle(F);if(!Le||!Le.stylesheet.featuresets)return[];const Oe=[];for(const F in Le.stylesheet.featuresets)Oe.push({featuresetId:F,importId:Le.scope?Le.scope:void 0});return Oe}getFeaturesetLayers(Le,Oe){const Fe=this.getFragmentStyle(Oe),je=Fe.stylesheet.featuresets;if(!je||!je[Le])return this.fire(new F.z(new Error(`The featureset '${Le}' does not exist in the map's style and cannot be queried.`))),[];const qe=[];for(const F of je[Le].selectors){const Le=Fe.getOwnLayer(F.layer);Le&&qe.push(Le)}return qe}getConfigProperty(Le,Oe){const Fe=this.getFragmentStyle(Le);if(!Fe)return null;const je=F.C(Oe,Fe.scope),qe=Fe.options.get(je),He=qe?qe.value||qe.default:null;return He?He.serialize():null}setConfigProperty(Le,Oe,Fe){const je=this.getFragmentStyle(Le);if(!je)return;const qe=je.stylesheet.indoor?uo(je.stylesheet.schema):je.stylesheet.schema;if(!qe||!qe[Oe])return;const He=F.X(Fe);if("success"!==He.result)return void go(this,He.value);const xt=He.value.expression,jt=F.C(Oe,je.scope),Gt=je.options.get(jt);if(!Gt)return;let bi;const{minValue:wi,maxValue:qr,stepValue:Xn,type:Yn,values:yo}=qe[Oe],bo=F.X(qe[Oe].default);"success"===bo.result&&(bi=bo.value.expression),bi?(this.options.set(jt,Object.assign({},Gt,{value:xt,default:bi,minValue:wi,maxValue:qr,stepValue:Xn,type:Yn,values:yo})),this.updateConfigDependencies(Oe)):this.fire(new F.z(new Error(`No schema defined for the config option "${Oe}" in the "${Le}" fragment.`)))}getConfig(Le){const Oe=this.getFragmentStyle(Le);if(!Oe)return null;const Fe=Oe.stylesheet.schema;if(!Fe)return null;const je={};for(const Le in Fe){const Fe=F.C(Le,Oe.scope),qe=Oe.options.get(Fe),He=qe?qe.value||qe.default:null;je[Le]=He?He.serialize():null}return je}setConfig(F,Le){const Oe=this.getFragmentStyle(F);Oe&&(Oe.updateConfig(Le,Oe.stylesheet.schema),this.updateConfigDependencies())}getSchema(F){const Le=this.getFragmentStyle(F);return Le?Le.stylesheet.schema:null}setSchema(F,Le){const Oe=this.getFragmentStyle(F);Oe&&(Oe.stylesheet.schema=Le,Oe.updateConfig(Oe._config,Le),this.updateConfigDependencies())}updateConfig(Le,Oe){if(this._config=Le,Le||Oe)if(Oe)for(const Fe in Oe){let je,qe;const He=F.X(Oe[Fe].default);if("success"===He.result&&(je=He.value.expression),Le&&void 0!==Le[Fe]){const Oe=F.X(Le[Fe]);"success"===Oe.result&&(qe=Oe.value.expression)}const{minValue:xt,maxValue:jt,stepValue:Gt,type:bi,values:wi}=Oe[Fe];if(je){const Le=F.C(Fe,this.scope);this.options.set(Le,{default:je,value:qe,minValue:xt,maxValue:jt,stepValue:Gt,type:bi,values:wi})}else this.fire(new F.z(new Error(`No schema defined for config option "${Fe}".`)))}else this.fire(new F.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(F){for(const Le of this._configDependentLayers){const Oe=this.getLayer(Le);if(Oe){if(F&&!Oe.configDependencies.has(F))continue;Oe.possiblyEvaluateVisibility(),this._updateLayer(Oe)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((F=>{const Le=F._styleColorTheme.colorThemeOverride?F._styleColorTheme.colorThemeOverride:F._styleColorTheme.colorTheme;if(Le){const Oe=F._evaluateColorThemeData(Le);(!F._styleColorTheme.lut&&""!==Oe||F._styleColorTheme.lut&&Oe!==F._styleColorTheme.lut.data)&&F.setColorTheme(Le)}})),this._changes.setDirty()}addLayer(Le,Oe,Fe={}){this._checkLoaded();const je=Le.id;if(this._layers[je])return void this.fire(new F.z(new Error(`Layer with id "${je}" already exists on this map`)));let qe;if("custom"===Le.type){if(go(this,F.cu(Le)))return;qe=F.cv(Le,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof Le.source&&(this.addSource(je,Le.source),Le=F.cq(Le),Le=F.l(Le,{source:je})),this._validate(Ee,`layers.${je}`,Le,{arrayIndex:-1},Fe))return;qe=F.cv(Le,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(qe),qe.setEventedParent(this,{layer:{id:je}})}0!==qe.configDependencies.size&&this._configDependentLayers.add(qe.fqid);let He=this._order.length;if(Oe){const Le=this._order.indexOf(Oe);if(-1===Le)return void this.fire(new F.z(new Error(`Layer with id "${Oe}" does not exist on this map.`)));qe.slot===this._layers[Oe].slot?He=Le:F.w(`Layer with id "${Oe}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(He,0,je),this._layerOrderChanged=!0,this._layers[je]=qe;const xt=this.getOwnLayerSourceCache(qe),jt=!!this.directionalLight&&this.directionalLight.shadowsEnabled();xt&&qe.canCastShadows()&&jt&&(xt.castsShadows=!0);const Gt=this._changes.getRemovedLayer(qe);if(Gt&&qe.source&&xt&&"custom"!==qe.type){this._changes.discardLayerRemoval(qe);const Le=F.C(qe.source,qe.scope);Gt.type!==qe.type?this._changes.updateSourceCache(Le,"clear"):(this._changes.updateSourceCache(Le,"reload"),xt.pause())}this._updateLayer(qe),qe.onAdd&&qe.onAdd(this.map),qe.scope=this.scope,this.mergeLayers()}moveLayer(Le,Oe){this._checkLoaded();const Fe=this._checkLayer(Le);if(!Fe)return;if(Le===Oe)return;const je=this._order.indexOf(Le);this._order.splice(je,1);let qe=this._order.length;if(Oe){const Le=this._order.indexOf(Oe);if(-1===Le)return void this.fire(new F.z(new Error(`Layer with id "${Oe}" does not exist on this map.`)));Fe.slot===this._layers[Oe].slot?qe=Le:F.w(`Layer with id "${Oe}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(qe,0,Le),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(F){this._checkLoaded();const Le=this._checkLayer(F);if(!Le)return;Le.setEventedParent(null);const Oe=this._order.indexOf(F);this._order.splice(Oe,1),delete this._layers[F],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(Le.fqid),this._changes.removeLayer(Le);const Fe=this.getOwnLayerSourceCache(Le);if(Fe&&Fe.castsShadows){let F=!1;for(const Oe in this._layers)if(this._layers[Oe].source===Le.source&&this._layers[Oe].canCastShadows()){F=!0;break}Fe.castsShadows=F}Le.onRemove&&Le.onRemove(this.map),this.mergeLayers()}getOwnLayer(F){return this._layers[F]}hasLayer(F){return F in this._mergedLayers}hasLayerType(F){for(const Le in this._layers)if(this._layers[Le].type===F)return!0;return!1}setLayerZoomRange(F,Le,Oe){this._checkLoaded();const Fe=this._checkLayer(F);Fe&&(Fe.minzoom===Le&&Fe.maxzoom===Oe||(null!=Le&&(Fe.minzoom=Le),null!=Oe&&(Fe.maxzoom=Oe),this._updateLayer(Fe)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(F,Le){this._checkLoaded();const Oe=this._checkLayer(F);Oe&&Oe.slot!==Le&&(Oe.slot=Le,this._updateLayer(Oe))}setFilter(Le,Oe,Fe={}){this._checkLoaded();const je=this._checkLayer(Le);if(je&&!F.bn(je.filter,Oe))return null==Oe?(je.filter=void 0,void this._updateLayer(je)):void(this._validate(Se,`layers.${je.id}.filter`,Oe,{layerType:je.type},Fe)||(je.filter=F.cq(Oe),this._updateLayer(je)))}getFilter(Le){const Oe=this._checkLayer(Le);if(Oe)return F.cq(Oe.filter)}setLayoutProperty(Le,Oe,Fe,je={}){this._checkLoaded();const qe=this._checkLayer(Le);if(qe&&!F.bn(qe.getLayoutProperty(Oe),Fe)){if(null!=Fe&&(!je||!1!==je.validate)&&go(qe,Ie.call(me,{key:`layers.${Le}.layout.${Oe}`,layerType:qe.type,objectKey:Oe,value:Fe,styleSpec:F.a5,style:{glyphs:!0,sprite:!0}})))return;qe.setLayoutProperty(Oe,Fe),0!==qe.configDependencies.size&&this._configDependentLayers.add(qe.fqid),this._updateLayer(qe)}}getLayoutProperty(F,Le){const Oe=this._checkLayer(F);if(Oe)return Oe.getLayoutProperty(Le)}setPaintProperty(Le,Oe,Fe,je={}){this._checkLoaded();const qe=this._checkLayer(Le);if(!qe)return;if(F.bn(qe.getPaintProperty(Oe),Fe))return;if(null!=Fe&&(!je||!1!==je.validate)&&go(qe,Ce.call(me,{key:`layers.${Le}.paint.${Oe}`,layerType:qe.type,objectKey:Oe,value:Fe,styleSpec:F.a5})))return;const He=qe.setPaintProperty(Oe,Fe);0!==qe.configDependencies.size&&this._configDependentLayers.add(qe.fqid),He&&this._updateLayer(qe),this._changes.updatePaintProperties(qe)}getPaintProperty(F,Le){const Oe=this._checkLayer(F);if(Oe)return Oe.getPaintProperty(Le)}setFeatureState(Le,Oe){if(this._checkLoaded(),"target"in Le){if("featuresetId"in Le.target){const{featuresetId:F,importId:Fe}=Le.target,je=this.getFragmentStyle(Fe),qe=je.getFeaturesetLayers(F);for(const{source:F,sourceLayer:Fe}of qe)je.setFeatureState({id:Le.id,source:F,sourceLayer:Fe},Oe)}else if("layerId"in Le.target){const{layerId:F}=Le.target,Fe=this.getLayer(F);this.setFeatureState({id:Le.id,source:Fe.source,sourceLayer:Fe.sourceLayer},Oe)}return}const Fe=Le.source,je=Le.sourceLayer,qe=this._checkSource(Fe);if(!qe)return;const He=qe.type;if("geojson"===He&&je)return void this.fire(new F.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===He&&!je)return void this.fire(new F.z(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===Le.id&&this.fire(new F.z(new Error("The feature id parameter must be provided.")));const xt=this.getOwnSourceCaches(Fe);for(const F of xt)F.setFeatureState(je,Le.id,Oe)}removeFeatureState(Le,Oe){if(this._checkLoaded(),"target"in Le){if("featuresetId"in Le.target){const{featuresetId:F,importId:Fe}=Le.target,je=this.getFragmentStyle(Fe),qe=je.getFeaturesetLayers(F);for(const{source:F,sourceLayer:Fe}of qe)je.removeFeatureState({id:Le.id,source:F,sourceLayer:Fe},Oe)}else if("layerId"in Le.target){const{layerId:F}=Le.target,Fe=this.getLayer(F);this.removeFeatureState({id:Le.id,source:Fe.source,sourceLayer:Fe.sourceLayer},Oe)}return}const Fe=Le.source,je=this._checkSource(Fe);if(!je)return;const qe=je.type,He="vector"===qe?Le.sourceLayer:void 0;if("vector"===qe&&!He)return void this.fire(new F.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(Oe&&"string"!=typeof Le.id&&"number"!=typeof Le.id)return void this.fire(new F.z(new Error("A feature id is required to remove its specific state property.")));const xt=this.getOwnSourceCaches(Fe);for(const F of xt)F.removeFeatureState(He,Le.id,Oe)}getFeatureState(Le){if(this._checkLoaded(),"target"in Le){let Oe;if("featuresetId"in Le.target){const{featuresetId:Fe,importId:je}=Le.target,qe=this.getFragmentStyle(je),He=qe.getFeaturesetLayers(Fe);for(const{source:Fe,sourceLayer:je}of He){const He=qe.getFeatureState({id:Le.id,source:Fe,sourceLayer:je});if(He&&!Oe)Oe=He;else if(!F.bn(Oe,He))return void this.fire(new F.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in Le.target){const{layerId:F}=Le.target,Fe=this.getLayer(F);Oe=this.getFeatureState({id:Le.id,source:Fe.source,sourceLayer:Fe.sourceLayer})}return Oe}const Oe=Le.source,Fe=Le.sourceLayer,je=this._checkSource(Oe);if(je){if("vector"!==je.type||Fe)return void 0===Le.id&&this.fire(new F.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(Oe)[0].getFeatureState(Fe,Le.id);this.fire(new F.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(Le){return this.stylesheet.transition=F.l({},this.stylesheet.transition,Le),this.transition=this.stylesheet.transition,this}getTransition(){return F.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const Le=this.getTerrain(),Oe=Le&&this.terrain&&this.terrain.scope===this.scope?Le:this.stylesheet.terrain;return F.cw({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:Oe,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(F=>void 0!==F))}_updateFilteredLayers(F){for(const Le of Object.values(this._mergedLayers))F(Le)&&this._updateLayer(Le)}_updateLayer(Le){this._changes.updateLayer(Le);const Oe=this.getLayerSourceCache(Le),Fe=F.C(Le.source,Le.scope),je=this._changes.getUpdatedSourceCaches();Le.source&&!je[Fe]&&Oe&&"raster"!==Oe.getSource().type&&(this._changes.updateSourceCache(Fe,"reload"),Oe.pause()),Le.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(F){const t=F=>this._mergedLayers[F].is3D(!!this.terrain),Le=this.order,Oe={},Fe=[];for(let je=Le.length-1;je>=0;je--){const qe=Le[je];if(t(qe)){Oe[qe]=je;for(const Le of F){const F=Le[qe];if(F)for(const Le of F)Fe.push(Le)}}}Fe.sort(((F,Le)=>Le.intersectionZ-F.intersectionZ));const je=[];for(let qe=Le.length-1;qe>=0;qe--){const He=Le[qe];if(t(He))for(let F=Fe.length-1;F>=0;F--){const Le=Fe[F].feature;if(Le.layer&&Oe[Le.layer.id]<qe)break;je.push(Le),Fe.pop()}else for(const Le of F){const F=Le[He];if(F)for(const Le of F)je.push(Le.feature)}}return je}queryRenderedFeatures(Le,Oe,Fe){let je;Oe&&!Array.isArray(Oe)&&Oe.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Oe.filter,null,Oe),je=F.a_(Oe.filter));const qe={},n=F=>{if(hu.has(F.type))return;const Le=this.getOwnLayerSourceCache(F),Oe=qe[Le.id]=qe[Le.id]||{sourceCache:Le,layers:{},has3DLayers:!1};F.is3D(!!this.terrain)&&(Oe.has3DLayers=!0),Oe.layers[F.fqid]=Oe.layers[F.fqid]||{styleLayer:F,targets:[]},Oe.layers[F.fqid].targets.push({filter:je})};if(Oe&&Oe.layers){if(!Array.isArray(Oe.layers))return this.fire(new F.z(new Error("parameters.layers must be an Array."))),[];for(const Le of Oe.layers){const Oe=this._layers[Le];if(!Oe)return this.fire(new F.z(new Error(`The layer '${Le}' does not exist in the map's style and cannot be queried for features.`))),[];n(Oe)}}else for(const F in this._layers)n(this._layers[F]);const He=this._queryRenderedFeatures(Le,qe,Fe),xt=this._flattenAndSortRenderedFeatures(He),jt=[];for(const Le of xt)F.ct(Le.layer.id)===this.scope&&jt.push(Le);return jt}queryRenderedFeatureset(Le,Oe,Fe){let je;Oe&&!Array.isArray(Oe)&&Oe.filter&&(this._validate(Se,"queryRenderedFeatures.filter",Oe.filter,null,Oe),je=F.a_(Oe.filter));const qe="mock",He=[];if(Oe&&Oe.target)He.push(Object.assign({},Oe,{targetId:qe,filter:je}));else{const F=this.getFeaturesetDescriptors();for(const Le of F)He.push({targetId:qe,filter:je,target:Le});for(const{style:F}of this.fragments){const Le=F.getFeaturesetDescriptors();for(const F of Le)He.push({targetId:qe,filter:je,target:F})}}const xt=this.queryRenderedTargets(Le,He,Fe),jt=[],Gt=new Set;for(const Le of xt)for(const Oe of Le.variants[qe])at(Oe,Le,Gt)||jt.push(new F.cx(Le,Oe));return jt}queryRenderedTargets(Le,Oe,Fe){const je={},r=(F,Le,Oe,Fe)=>{const qe=je[Le.id]=je[Le.id]||{sourceCache:Le,layers:{},has3DLayers:!1};if(qe.layers[F.fqid]=qe.layers[F.fqid]||{styleLayer:F,targets:[]},F.is3D(!!this.terrain)&&(qe.has3DLayers=!0),!Fe)return Oe.uniqueFeatureID=!1,void qe.layers[F.fqid].targets.push(Oe);qe.layers[F.fqid].targets.push(Object.assign({},Oe,{namespace:Fe.namespace,properties:Fe.properties,uniqueFeatureID:Fe.uniqueFeatureID}))};for(const Le of Oe)if("featuresetId"in Le.target){const{featuresetId:Oe,importId:Fe}=Le.target,je=this.getFragmentStyle(Fe);if(!je||!je._featuresetSelectors)continue;const qe=je._featuresetSelectors[Oe];if(!qe){this.fire(new F.z(new Error(`The featureset '${Oe}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const F of qe){const Oe=je.getOwnLayer(F.layerId);Oe&&!hu.has(Oe.type)&&r(Oe,je.getOwnLayerSourceCache(Oe),Le,F)}}else if("layerId"in Le.target){const{layerId:F}=Le.target,Oe=this.getLayer(F);if(!Oe||hu.has(Oe.type))continue;r(Oe,this.getLayerSourceCache(Oe),Le)}const qe=this._queryRenderedFeatures(Le,je,Fe);return this._flattenAndSortRenderedFeatures(qe)}_queryRenderedFeatures(F,Le,Oe){const Fe=[],je=!!this.map._showQueryGeometry,qe=Xe.createFromScreenPoints(F,Oe);for(const F in Le){const He=lt(qe,Le[F],this._availableImages,Oe,je);Object.keys(He).length&&Fe.push(He)}if(this.placement)for(const F in Le){if(!Le[F].sourceCache._onlySymbols)continue;const Oe=ct(qe.screenGeometry,Le[F],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(Oe).length&&Fe.push(Oe)}return Fe}querySourceFeatures(F,Le){const Oe=Le&&Le.filter;Oe&&this._validate(Se,"querySourceFeatures.filter",Oe,null,Le);let Fe=[];const je=this.getOwnSourceCaches(F);for(const F of je)Fe=Fe.concat(ht(F,Le));return Fe}addSourceType(F,Le,Oe){return To.getSourceType(F)?Oe(new Error(`A source type called "${F}" already exists.`)):(To.setSourceType(F,Le),Le.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:F,url:Le.workerSourceURL},Oe):Oe(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(Le,Oe,Fe={}){this._checkLoaded();const je=this.light.getLight();let qe=!1;for(const Oe in Le)if(!F.bn(Le[Oe],je[Oe])){qe=!0;break}if(!qe)return;const He=this._getTransitionParameters();this.light.setLight(Le,Oe,Fe),this.light.updateTransitions(He)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=F.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&F.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(Le,Oe=1){if(this._checkLoaded(),!Le)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===Oe&&delete this.terrain,null===Le?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let Fe=Le;const je=null==Le.source;if(1===Oe){if(this.disableElevatedTerrain)return;if("object"==typeof Fe.source){const Le="terrain-dem-src";this.addSource(Le,Fe.source),Fe=F.cq(Fe),Fe=F.l(Fe,{source:Le})}const Le=F.l({},Fe),Oe={};if(this.terrain&&je){Le.source=this.terrain.get().source;const F=this.terrain?this.getFragmentStyle(this.terrain.scope):null;F&&(Oe.style=F.serialize())}if(this._validate(xe,"terrain",Le,Oe))return}if(!this.terrain||this.terrain.scope!==this.scope&&!je||this.terrain&&Oe!==this.terrain.drapeRenderMode){if(!Fe)return;this._createTerrain(Fe,Oe),this.fire(new F.A("data",{dataType:"style"}))}else{const Oe=this.terrain,je=Oe.get();for(const Le of Object.keys(F.a5.terrain))!Fe.hasOwnProperty(Le)&&F.a5.terrain[Le].default&&(Fe[Le]=F.a5.terrain[Le].default);for(const Fe in Le)if(!F.bn(Le[Fe],je[Fe])){Oe.set(Le,this.options),this.stylesheet.terrain=Le;const Fe=this._getTransitionParameters({duration:0});Oe.updateTransitions(Fe),this.fire(new F.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(F){const Le=this.fog=new Ve(F,this.map.transform,this.scope,this.options);this.stylesheet.fog=Le.get();const Oe=this._getTransitionParameters({duration:0});Le.updateTransitions(Oe)}_createSnow(F){const Le=this.snow=new gc(F,this.map.transform,this.scope,this.options);this.stylesheet.snow=Le.get();const Oe=this._getTransitionParameters({duration:0});Le.updateTransitions(Oe)}_createRain(F){const Le=this.rain=new yc(F,this.map.transform,this.scope,this.options);this.stylesheet.rain=Le.get();const Oe=this._getTransitionParameters({duration:0});Le.updateTransitions(Oe)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const F of this.map._markers)F._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(Le){if(this._checkLoaded(),!Le)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const Oe=this.fog;if(!F.bn(Oe.get(),Le)){Oe.set(Le,this.options),this.stylesheet.fog=Oe.get();const F=this._getTransitionParameters({duration:0});Oe.updateTransitions(F)}}else this._createFog(Le);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(Le){if(this._checkLoaded(),!Le)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const Oe=this.snow;if(!F.bn(Oe.get(),Le)){Oe.set(Le,this.options),this.stylesheet.snow=Oe.get();const F=this._getTransitionParameters({duration:0});Oe.updateTransitions(F)}}else this._createSnow(Le);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(Le){if(this._checkLoaded(),!Le)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const Oe=this.rain;if(!F.bn(Oe.get(),Le)){Oe.set(Le,this.options),this.stylesheet.rain=Oe.get();const F=this._getTransitionParameters({duration:0});Oe.updateTransitions(F)}}else this._createRain(Le);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const F in this._layers)this._layers[F].lut=this._styleColorTheme.lut;for(const F in this._sourceCaches)this._sourceCaches[F].clearTiles()},Le=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!Le)return this._styleColorTheme.lut=null,void t();const Oe=this._evaluateColorThemeData(Le);this._loadColorTheme(Oe).then((()=>{this.fire(new F.A("colorthemeset")),t()})).catch((Le=>{F.w(`Couldn't set color theme: ${Le}`)}))}setColorTheme(Le){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&F.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=Le,this._reloadColorTheme()}setImportColorTheme(F,Le){const Oe=this.getFragmentStyle(F);Oe&&(Oe._styleColorTheme.colorThemeOverride=Le,Oe._reloadColorTheme())}_getTransitionParameters(Le){return{now:F.q.now(),transition:F.l(this.transition,Le)}}updateDrapeFirstLayers(){if(!this.terrain)return;const F=[],Le=[];for(const Oe of this._mergedOrder)this.isLayerDraped(this._mergedLayers[Oe])?F.push(Oe):Le.push(Oe);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...F),this._drapedFirstOrder.push(...Le)}_createTerrain(F,Le){const Oe=this.terrain=new kl(F,Le,this.scope,this.options);1===Le&&(this.stylesheet.terrain=F),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const Fe=this._getTransitionParameters({duration:0});Oe.updateTransitions(Fe)}_force3DLayerUpdate(){for(const F in this._layers){const Le=this._layers[F];"fill-extrusion"===Le.type&&this._updateLayer(Le)}}_forceSymbolLayerUpdate(){for(const F in this._layers){const Le=this._layers[F];"symbol"===Le.type&&this._updateLayer(Le)}}_validate(Le,Oe,Fe,je,qe={}){if(qe&&!1===qe.validate)return!1;const He=F.l({},this.serialize());return go(this,Le.call(me,F.l({key:Oe,style:He,value:Fe,styleSpec:F.a5},je)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),F.cy.off("pluginStateChange",this._rtlTextPluginCallback);for(const F in this._mergedLayers)this._mergedLayers[F].setEventedParent(null);for(const F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles(),this._mergedSourceCaches[F].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(F){const Le=this.getSourceCaches(F);for(const F of Le)F.clearTiles()}clearSources(){for(const F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles()}reloadSource(F){const Le=this.getSourceCaches(F);for(const F of Le)F.resume(),F.reload()}reloadSources(){for(const F of this.getSources())F.reload&&F.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((F=>{F.modelManager.reloadModels(F.scope)}))}updateSources(F){let Le;this.directionalLight&&(Le=ro(this.directionalLight));for(const Oe in this._mergedSourceCaches)this._mergedSourceCaches[Oe].update(F,void 0,void 0,Le)}_generateCollisionBoxes(){for(const F in this._sourceCaches){const Le=this._sourceCaches[F];Le.resume(),Le.reload()}}_updatePlacement(Le,Oe,Fe,je,qe,He,xt=!1){let jt=!1,Gt=!1;const bi={},wi={};for(const Le of this._mergedOrder){const Fe=this._mergedLayers[Le];if("symbol"!==Fe.type)continue;const je=F.C(Fe.source,Fe.scope);let qe=bi[je];if(!qe){const F=this.getLayerSourceCache(Fe);if(!F)continue;const Le=F.getRenderableIds(!0).map((Le=>F.getTileByID(Le)));wi[je]=Le.slice(),qe=bi[je]=Le.sort(((F,Le)=>Le.tileID.overscaledZ-F.tileID.overscaledZ||(F.tileID.isLessThan(Le.tileID)?-1:1)))}const He=this.crossTileSymbolIndex.addLayer(Fe,qe,Oe.center.lng,Oe.projection);jt=jt||He}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),xt=xt||this._layerOrderChanged||0===je,this._layerOrderChanged&&this.fire(new F.A("neworder")),(xt||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(F.q.now(),Oe.zoom))&&(this.pauseablePlacement=new Ai(Oe,this._mergedOrder,xt,Fe,je,qe,this.placement,this.fog&&Oe.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,bi,wi,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(F.q.now()),Gt=!0),jt&&this.pauseablePlacement.placement.setStale()),Gt||jt){this._buildingIndex.onNewFrame(Oe.zoom);for(let Le=0;Le<this._mergedOrder.length;Le++){const Oe=this._mergedLayers[this._mergedOrder[Le]];if("symbol"!==Oe.type)continue;const Fe=this.isLayerClipped(Oe);this.placement.updateLayerOpacities(Oe,bi[F.C(Oe.source,Oe.scope)],Le,Fe?He:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(F.q.now())}}_releaseSymbolFadeTiles(){for(const F in this._sourceCaches)this._sourceCaches[F].releaseSymbolFadeTiles()}addImport(Le,Oe){this._checkLoaded();const Fe=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==Fe.findIndex((({id:F})=>F===Le.id)))return void this.fire(new F.z(new Error(`Import with id '${Le.id}' already exists in the map's style.`)));if(!Oe)return Fe.push(Le),this._loadImports([Le],!0);const je=Fe.findIndex((({id:F})=>F===Oe));return-1===je&&this.fire(new F.z(new Error(`Import with id "${Oe}" does not exist on this map.`))),this.stylesheet.imports=Fe.slice(0,je).concat(Le).concat(Fe.slice(je)),this._loadImports([Le],!0,Oe)}updateImport(Le,Oe){this._checkLoaded();const Fe=this.stylesheet.imports||[],je=this.getImportIndex(Le);return-1===je?this:"string"==typeof Oe?(this.setImportUrl(Le,Oe),this):(Oe.url&&Oe.url!==Fe[je].url&&this.setImportUrl(Le,Oe.url),F.bn(Oe.config,Fe[je].config)||this.setImportConfig(Le,Oe.config,Oe.data.schema),F.bn(Oe.data,Fe[je].data)||this.setImportData(Le,Oe.data),this)}moveImport(F,Le){this._checkLoaded();let Oe=this.stylesheet.imports||[];const Fe=this.getImportIndex(F);if(-1===Fe)return this;const je=this.getImportIndex(Le);if(-1===je)return this;const qe=Oe[Fe],He=this.fragments[Fe];return Oe=Oe.filter((({id:Le})=>Le!==F)),this.fragments=this.fragments.filter((({id:Le})=>Le!==F)),this.stylesheet.imports=Oe.slice(0,je).concat(qe).concat(Oe.slice(je)),this.fragments=this.fragments.slice(0,je).concat(He).concat(this.fragments.slice(je)),this.mergeLayers(),this}setImportUrl(F,Le){this._checkLoaded();const Oe=this.stylesheet.imports||[],Fe=this.getImportIndex(F);if(-1===Fe)return this;Oe[Fe].url=Le;const je=this.fragments[Fe];return je.style=this._createFragmentStyle(Oe[Fe]),je.style.on("style.import.load",(()=>this.mergeAll())),je.style.loadURL(Le),this}setImportData(F,Le){this._checkLoaded();const Oe=this.getImportIndex(F),Fe=this.stylesheet.imports||[];return-1===Oe?this:Le?(this.fragments[Oe].style.setState(Le),this._reloadImports(),this):(delete Fe[Oe].data,this.setImportUrl(F,Fe[Oe].url))}setImportConfig(F,Le,Oe){this._checkLoaded();const Fe=this.getImportIndex(F),je=this.stylesheet.imports||[];if(-1===Fe)return this;Le?je[Fe].config=Le:delete je[Fe].config;const qe=this.fragments[Fe];Oe&&qe.style.stylesheet&&(qe.style.stylesheet.schema=Oe);const He=qe.style.stylesheet&&qe.style.stylesheet.schema;return qe.config=Le,qe.style.updateConfig(Le,He),this.updateConfigDependencies(),this}removeImport(F){this._checkLoaded();const Le=this.stylesheet.imports||[],Oe=this.getImportIndex(F);-1!==Oe&&(Le.splice(Oe,1),this.fragments[Oe].style._remove(),this.fragments.splice(Oe,1),this._reloadImports())}getImportIndex(Le){const Oe=(this.stylesheet.imports||[]).findIndex((F=>F.id===Le));return-1===Oe&&this.fire(new F.z(new Error(`Import '${Le}' does not exist in the map's style and cannot be updated.`))),Oe}getLayer(F){return this._mergedLayers[F]}getSources(){const F=[];for(const Le in this._mergedOtherSourceCaches){const Oe=this._mergedOtherSourceCaches[Le];Oe&&F.push(Oe.getSource())}return F}getSource(F,Le){const Oe=this.getSourceCache(F,Le);return Oe&&Oe.getSource()}getLayerSource(F){const Le=this.getLayerSourceCache(F);return Le&&Le.getSource()}getSourceCache(Le,Oe){const Fe=F.C(Le,Oe);return this._mergedOtherSourceCaches[Fe]}getLayerSourceCache(Le){const Oe=F.C(Le.source,Le.scope);return"symbol"===Le.type?this._mergedSymbolSourceCaches[Oe]:this._mergedOtherSourceCaches[Oe]}getSourceCaches(F){if(null==F)return Object.values(this._mergedSourceCaches);const Le=[];return this._mergedOtherSourceCaches[F]&&Le.push(this._mergedOtherSourceCaches[F]),this._mergedSymbolSourceCaches[F]&&Le.push(this._mergedSymbolSourceCaches[F]),Le}updateSourceCaches(){const F=this._changes.getUpdatedSourceCaches();for(const Le in F){const Oe=F[Le];"reload"===Oe?this.reloadSource(Le):"clear"===Oe&&this.clearSource(Le)}}updateLayers(F){const Le=this._changes.getUpdatedPaintProperties();for(const Oe of Le){const Le=this.getLayer(Oe);Le&&Le.updateTransitions(F)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(F){this.stylesheet.glyphs=F,this.glyphManager.setURL(F,this.scope)}getImages(Le,Oe,Fe){this.imageManager.getImages(Oe.images,Oe.scope,Fe),this._updateTilesForChangedImages();const s=Le=>{if(Le){const Fe=Oe.images.map((Le=>F.I.toString(Le)));Le.setDependencies(Oe.tileID.key,Oe.type,Fe)}},je=F.C(Oe.source,Oe.scope);s(this._mergedOtherSourceCaches[je]),s(this._mergedSymbolSourceCaches[je])}rasterizeImages(F,Le,Oe){this.imageManager.rasterizeImages(Le,Oe)}getGlyphs(F,Le,Oe){this.glyphManager.getGlyphs(Le.stacks,Le.scope,Oe)}getResource(Le,Oe,Fe){return F.cz(Oe,Fe)}getOwnSourceCache(F){return this._otherSourceCaches[F]}getOwnLayerSourceCache(F){return"symbol"===F.type?this._symbolSourceCaches[F.source]:this._otherSourceCaches[F.source]}getOwnSourceCaches(F){const Le=[];return this._otherSourceCaches[F]&&Le.push(this._otherSourceCaches[F]),this._symbolSourceCaches[F]&&Le.push(this._symbolSourceCaches[F]),Le}_isSourceCacheLoaded(Le){const Oe=this.getOwnSourceCaches(Le);return 0===Oe.length?(this.fire(new F.z(new Error(`There is no source with ID '${Le}'`))),!1):Oe.every((F=>F.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(F,Le){if(!this._clipLayerPresent&&"fill-extrusion"!==F.type)return!1;const Oe="fill-extrusion"===F.type&&"building"===F.sourceLayer;if(F.is3D(!!this.terrain)){if(Oe||Le&&"batched-model"===Le.type)return!0;if("model"===F.type)return!0}else if("symbol"===F.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((F=>{F.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}To.getSourceType=function(F){return xc[F]},To.setSourceType=function(F,Le){xc[F]=Le},To.registerForPluginStateChange=F.ci;var fu="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",mu="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",Su="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",Fu="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Hu="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",Zu="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",Wu="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",Xu="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",hd="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",md="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",_d="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return clamp(mix(lerpx.x,lerpx.y,f.y),0.0,1.0);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const xd=[];Vo(fu,xd),Vo(Su,xd),Vo(mu,xd);const vd={"_prelude_fog.vertex.glsl":Zu,"_prelude_terrain.vertex.glsl":Hu,"_prelude_shadow.vertex.glsl":md,"_prelude_fog.fragment.glsl":Wu,"_prelude_shadow.fragment.glsl":_d,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":Xu,"_prelude_raster_particle.glsl":hd},Bd={};Go("",Hu),Go(Wu,Zu),Go(_d,md),Go(Xu,""),Go(hd,"");const Vd=Go(mu,Su),qd=fu;var $d={background:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:Go("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Go('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:Go("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Go("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:Go("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Go("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:Go("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Go("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvoid main() {vec3 color=vec3(241.0/255.0,236.0/255.0,225.0/255.0);\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,normal);\n#endif\nif (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(v_normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:Go('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:Go("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:Go("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),0.001);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:Go("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:Go("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Go('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Go('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#else\nz+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#endif\n}'),terrainRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:Go("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:Go('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Fu),skyboxGradient:Go('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Fu),skyboxCapture:Go("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:Go('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:Go("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:Go("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:Go("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:Go("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Go("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Vo(F,Le){const Oe=F.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let F of Oe)if(F=F.trim(),"#"===F[0]&&F.includes("if")&&!F.includes("endif")){F=F.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const Oe=F.split(" ");for(const F of Oe)Le.includes(F)||Le.push(F)}}function Go(F,Le){const Oe=/#include\s+"([^"]+)"/g,Fe=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let je=Le.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);je&&(je=je.map((F=>{const Le=F.split(" ");return Le[Le.length-1]})),je=[...new Set(je)]);const qe={},He=[],xt=[];if(F=F.replace(Oe,((F,Le)=>(xt.push(Le),""))),(Le=Le.replace(Oe,((F,Le)=>(He.push(Le),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let jt=[...xd];Vo(F,jt),Vo(Le,jt);for(const F of[...He,...xt])vd[F]||console.error(`Undefined include: ${F}`),Bd[F]||(Bd[F]=[],Vo(vd[F],Bd[F])),jt=[...jt,...Bd[F]];return{fragmentSource:F=F.replace(Fe,((F,Le,Oe,Fe,je)=>(qe[je]=!0,"define"===Le?`\n#ifndef HAS_UNIFORM_u_${je}\nin ${Oe} ${Fe} ${je};\n#else\nuniform ${Oe} ${Fe} u_${je};\n#endif\n`:"initialize"===Le?`\n#ifdef HAS_UNIFORM_u_${je}\n    ${Oe} ${Fe} ${je} = u_${je};\n#endif\n`:"define-attribute"===Le?`\n#ifdef HAS_ATTRIBUTE_a_${je}\n    in ${Oe} ${Fe} ${je};\n#endif\n`:"initialize-attribute"===Le?"":void 0))),vertexSource:Le=Le.replace(Fe,((F,Le,Oe,Fe,je)=>{const He="float"===Fe?"vec2":Fe,xt=je.match(/color/)?"color":He;return"define-attribute-vertex-shader-only"===Le?`\n#ifdef HAS_ATTRIBUTE_a_${je}\nin ${Oe} ${Fe} a_${je};\n#endif\n`:qe[je]?"define"===Le?`\n#ifndef HAS_UNIFORM_u_${je}\nuniform lowp float u_${je}_t;\nin ${Oe} ${He} a_${je};\nout ${Oe} ${Fe} ${je};\n#else\nuniform ${Oe} ${Fe} u_${je};\n#endif\n`:"initialize"===Le?"vec4"===xt?`\n#ifndef HAS_UNIFORM_u_${je}\n    ${je} = a_${je};\n#else\n    ${Oe} ${Fe} ${je} = u_${je};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${je}\n    ${je} = unpack_mix_${xt}(a_${je}, u_${je}_t);\n#else\n    ${Oe} ${Fe} ${je} = u_${je};\n#endif\n`:"define-attribute"===Le?`\n#ifdef HAS_ATTRIBUTE_a_${je}\n    in ${Oe} ${Fe} a_${je};\n    out ${Oe} ${Fe} ${je};\n#endif\n`:"initialize-attribute"===Le?`\n#ifdef HAS_ATTRIBUTE_a_${je}\n    ${je} = a_${je};\n#endif\n`:void 0:"define"===Le?`\n#ifndef HAS_UNIFORM_u_${je}\nuniform lowp float u_${je}_t;\nin ${Oe} ${He} a_${je};\n#else\nuniform ${Oe} ${Fe} u_${je};\n#endif\n`:"define-instanced"===Le?"mat4"===xt?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${je}0;\nin vec4 a_${je}1;\nin vec4 a_${je}2;\nin vec4 a_${je}3;\n#else\nuniform ${Oe} ${Fe} u_${je};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${Oe} ${He} a_${je};\n#else\nuniform ${Oe} ${Fe} u_${je};\n#endif\n`:"initialize-attribute-custom"===Le?`\n#ifdef HAS_ATTRIBUTE_a_${je}\n    ${Oe} ${Fe} ${je} = a_${je};\n#endif\n`:"vec4"===xt?`\n#ifndef HAS_UNIFORM_u_${je}\n    ${Oe} ${Fe} ${je} = a_${je};\n#else\n    ${Oe} ${Fe} ${je} = u_${je};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${je}\n    ${Oe} ${Fe} ${je} = unpack_mix_${xt}(a_${je}, u_${je}_t);\n#else\n    ${Oe} ${Fe} ${je} = u_${je};\n#endif\n`})),staticAttributes:je,usedDefines:jt,vertexIncludes:He,fragmentIncludes:xt}}class jo{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(F,Le,Oe,Fe,je,qe,He,xt){this.context=F;let jt=this.boundPaintVertexBuffers.length!==Fe.length;for(let F=0;!jt&&F<Fe.length;F++)this.boundPaintVertexBuffers[F]!==Fe[F]&&(jt=!0);let Gt=this.boundDynamicVertexBuffers.length!==He.length;for(let F=0;!Gt&&F<He.length;F++)this.boundDynamicVertexBuffers[F]!==He[F]&&(Gt=!0);if(!this.vao||this.boundProgram!==Le||this.boundLayoutVertexBuffer!==Oe||jt||Gt||this.boundIndexBuffer!==je||this.boundVertexOffset!==qe)this.freshBind(Le,Oe,Fe,je,qe,He,xt);else{F.bindVertexArrayOES.set(this.vao);for(const Oe of He)Oe&&(Oe.bind(),xt&&Oe.instanceCount&&Oe.setVertexAttribDivisor(F.gl,Le,xt));je&&je.dynamicDraw&&je.bind()}}freshBind(F,Le,Oe,Fe,je,qe,He){const xt=F.numAttributes,jt=this.context,Gt=jt.gl;this.vao&&this.destroy(),this.vao=jt.gl.createVertexArray(),jt.bindVertexArrayOES.set(this.vao),this.boundProgram=F,this.boundLayoutVertexBuffer=Le,this.boundPaintVertexBuffers=Oe,this.boundIndexBuffer=Fe,this.boundVertexOffset=je,this.boundDynamicVertexBuffers=qe,Le.enableAttributes(Gt,F),Le.bind(),Le.setVertexAttribPointers(Gt,F,je);for(const Le of Oe)Le.enableAttributes(Gt,F),Le.bind(),Le.setVertexAttribPointers(Gt,F,je);for(const Le of qe)Le&&(Le.enableAttributes(Gt,F),Le.bind(),Le.setVertexAttribPointers(Gt,F,je),He&&Le.instanceCount&&Le.setVertexAttribDivisor(Gt,F,He));Fe&&Fe.bind(),jt.currentNumAttributes=xt}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function qo(Le,Oe){const Fe=Math.pow(2,Oe.canonical.z),je=Oe.canonical.y;return[new F.ac(0,je/Fe).toLngLat().lat,new F.ac(0,(je+1)/Fe).toLngLat().lat]}function Ho(Le,Oe,Fe,je,qe,He,xt){const jt=Le.context,Gt=jt.gl,bi=Fe.hillshadeFBO;if(!bi)return;Le.prepareDrawTile();const wi=Le.isTileAffectedByFog(Oe),qr=Le.getOrCreateProgram("hillshade",{overrideFog:wi});jt.activeTexture.set(Gt.TEXTURE0),Gt.bindTexture(Gt.TEXTURE_2D,bi.colorAttachment.get());const Xn=((Le,Oe,Fe,je)=>{const qe=Fe.paint.get("hillshade-shadow-color"),He="none"===Fe.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),xt=Fe.paint.get("hillshade-highlight-color"),jt="none"===Fe.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),Gt=Fe.paint.get("hillshade-accent-color"),bi="none"===Fe.paint.get("hillshade-accent-color-use-theme").constantOr("default"),wi=Fe.paint.get("hillshade-emissive-strength");let qr=F.ak(Fe.paint.get("hillshade-illumination-direction"));if("viewport"===Fe.paint.get("hillshade-illumination-anchor"))qr-=Le.transform.angle;else if(Le.style&&Le.style.enable3dLights()&&Le.style.directionalLight){const Oe=Le.style.directionalLight.properties.get("direction"),Fe=F.cc(Oe.x,Oe.y,Oe.z);qr=F.ak(Fe[1])}const Xn=!Le.options.moving;return{u_matrix:je||Le.transform.calculateProjMatrix(Oe.tileID.toUnwrapped(),Xn),u_image:0,u_latrange:qo(0,Oe.tileID),u_light:[Fe.paint.get("hillshade-exaggeration"),qr],u_shadow:qe.toRenderColor(He?null:Fe.lut),u_highlight:xt.toRenderColor(jt?null:Fe.lut),u_emissive_strength:wi,u_accent:Gt.toRenderColor(bi?null:Fe.lut)}})(Le,Fe,je,Le.terrain?Oe.projMatrix:null);Le.uploadCommonUniforms(jt,qr,Oe.toUnwrapped());const{tileBoundsBuffer:Yn,tileBoundsIndexBuffer:yo,tileBoundsSegments:bo}=Le.getTileBoundsBuffers(Fe);qr.draw(Le,Gt.TRIANGLES,qe,He,xt,ji.disabled,Xn,je.id,Yn,yo,bo)}function Zo(Le,Oe,Fe){if(!Oe.needsDEMTextureUpload)return;const je=Le.context,qe=je.gl;je.pixelStoreUnpackPremultiplyAlpha.set(!1),Oe.demTexture=Oe.demTexture||Le.getTileTexture(Fe.stride);const He=Fe.getPixels();Oe.demTexture?Oe.demTexture.update(He,{premultiply:!1}):Oe.demTexture=new F.T(je,He,qe.R32F,{premultiply:!1}),Oe.needsDEMTextureUpload=!1}function Wo(Le,Oe,Fe){const je=Le.context,qe=je.gl;if(!Oe.dem)return;const He=Oe.dem;if(je.activeTexture.set(qe.TEXTURE1),Zo(Le,Oe,He),!Oe.demTexture)return;Oe.demTexture.bind(qe.NEAREST,qe.CLAMP_TO_EDGE);const xt=He.dim;je.activeTexture.set(qe.TEXTURE0);let jt=Oe.hillshadeFBO;if(!jt){const Le=new F.T(je,{width:xt,height:xt,data:null},qe.RGBA8);Le.bind(qe.LINEAR,qe.CLAMP_TO_EDGE),jt=Oe.hillshadeFBO=je.createFramebuffer(xt,xt,!0,"renderbuffer"),jt.colorAttachment.set(Le.texture)}je.bindFramebuffer.set(jt.framebuffer),je.viewport.set([0,0,xt,xt]);const{tileBoundsBuffer:Gt,tileBoundsIndexBuffer:bi,tileBoundsSegments:wi}=Le.getMercatorTileBoundsBuffers(),qr=[];Le.linearFloatFilteringSupported()&&qr.push("TERRAIN_DEM_FLOAT_FORMAT"),Le.getOrCreateProgram("hillshadePrepare",{defines:qr}).draw(Le,qe.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.disabled,((Le,Oe)=>{const Fe=Oe.stride,je=F.ad.mat4.create();return F.ad.mat4.ortho(je,0,F.ai,-F.ai,0,0,1),F.ad.mat4.translate(je,je,[0,-F.ai,0]),{u_matrix:je,u_image:1,u_dimension:[Fe,Fe],u_zoom:Le.overscaledZ}})(Oe.tileID,He),Fe.id,Gt,bi,wi),Oe.needsHillshadePrepare=!1}class $o{constructor(F){this.gl=F.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(F){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Xo extends $o{getDefault(){return F.al.transparent}set(F){const Le=this.current;(F.r!==Le.r||F.g!==Le.g||F.b!==Le.b||F.a!==Le.a||this.dirty)&&(this.gl.clearColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}}class Ko extends $o{getDefault(){return 1}set(F){(F!==this.current||this.dirty)&&(this.gl.clearDepth(F),this.current=F,this.dirty=!1)}}class Yo extends $o{getDefault(){return 0}set(F){(F!==this.current||this.dirty)&&(this.gl.clearStencil(F),this.current=F,this.dirty=!1)}}class Jo extends $o{getDefault(){return[!0,!0,!0,!0]}set(F){const Le=this.current;(F[0]!==Le[0]||F[1]!==Le[1]||F[2]!==Le[2]||F[3]!==Le[3]||this.dirty)&&(this.gl.colorMask(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class Qo extends $o{getDefault(){return!0}set(F){(F!==this.current||this.dirty)&&(this.gl.depthMask(F),this.current=F,this.dirty=!1)}}class es extends $o{getDefault(){return 255}set(F){(F!==this.current||this.dirty)&&(this.gl.stencilMask(F),this.current=F,this.dirty=!1)}}class ts extends $o{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(F){const Le=this.current;(F.func!==Le.func||F.ref!==Le.ref||F.mask!==Le.mask||this.dirty)&&(this.gl.stencilFunc(F.func,F.ref,F.mask),this.current=F,this.dirty=!1)}}class is extends $o{getDefault(){const F=this.gl;return[F.KEEP,F.KEEP,F.KEEP]}set(F){const Le=this.current;(F[0]!==Le[0]||F[1]!==Le[1]||F[2]!==Le[2]||this.dirty)&&(this.gl.stencilOp(F[0],F[1],F[2]),this.current=F,this.dirty=!1)}}class os extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;F?Le.enable(Le.STENCIL_TEST):Le.disable(Le.STENCIL_TEST),this.current=F,this.dirty=!1}}class ss extends $o{getDefault(){return[0,1]}set(F){const Le=this.current;(F[0]!==Le[0]||F[1]!==Le[1]||this.dirty)&&(this.gl.depthRange(F[0],F[1]),this.current=F,this.dirty=!1)}}class rs extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;F?Le.enable(Le.DEPTH_TEST):Le.disable(Le.DEPTH_TEST),this.current=F,this.dirty=!1}}class ns extends $o{getDefault(){return this.gl.LESS}set(F){(F!==this.current||this.dirty)&&(this.gl.depthFunc(F),this.current=F,this.dirty=!1)}}class as extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;F?Le.enable(Le.BLEND):Le.disable(Le.BLEND),this.current=F,this.dirty=!1}}class ls extends $o{getDefault(){const F=this.gl;return[F.ONE,F.ZERO,F.ONE,F.ZERO]}set(F){const Le=this.current;(F[0]!==Le[0]||F[1]!==Le[1]||F[2]!==Le[2]||F[3]!==Le[3]||this.dirty)&&(this.gl.blendFuncSeparate(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class cs extends $o{getDefault(){return F.al.transparent}set(F){const Le=this.current;(F.r!==Le.r||F.g!==Le.g||F.b!==Le.b||F.a!==Le.a||this.dirty)&&(this.gl.blendColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}}class hs extends $o{getDefault(){return this.gl.FUNC_ADD}set(F){(F!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(F,F),this.current=F,this.dirty=!1)}}class ds extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;F?Le.enable(Le.CULL_FACE):Le.disable(Le.CULL_FACE),this.current=F,this.dirty=!1}}class us extends $o{getDefault(){return this.gl.BACK}set(F){(F!==this.current||this.dirty)&&(this.gl.cullFace(F),this.current=F,this.dirty=!1)}}class _s extends $o{getDefault(){return this.gl.CCW}set(F){(F!==this.current||this.dirty)&&(this.gl.frontFace(F),this.current=F,this.dirty=!1)}}let Qd=class extends $o{getDefault(){return null}set(F){(F!==this.current||this.dirty)&&(this.gl.useProgram(F),this.current=F,this.dirty=!1)}};class fs extends $o{getDefault(){return this.gl.TEXTURE0}set(F){(F!==this.current||this.dirty)&&(this.gl.activeTexture(F),this.current=F,this.dirty=!1)}}class ms extends $o{getDefault(){const F=this.gl;return[0,0,F.drawingBufferWidth,F.drawingBufferHeight]}set(F){const Le=this.current;(F[0]!==Le[0]||F[1]!==Le[1]||F[2]!==Le[2]||F[3]!==Le[3]||this.dirty)&&(this.gl.viewport(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}}class gs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;Le.bindFramebuffer(Le.FRAMEBUFFER,F),this.current=F,this.dirty=!1}}class vs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;Le.bindRenderbuffer(Le.RENDERBUFFER,F),this.current=F,this.dirty=!1}}class ys extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;Le.bindTexture(Le.TEXTURE_2D,F),this.current=F,this.dirty=!1}}class xs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;Le.bindBuffer(Le.ARRAY_BUFFER,F),this.current=F,this.dirty=!1}}class bs extends $o{getDefault(){return null}set(F){const Le=this.gl;Le.bindBuffer(Le.ELEMENT_ARRAY_BUFFER,F),this.current=F,this.dirty=!1}}class ws extends $o{getDefault(){return null}set(F){this.gl&&(F!==this.current||this.dirty)&&(this.gl.bindVertexArray(F),this.current=F,this.dirty=!1)}}class Ts extends $o{getDefault(){return 4}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;Le.pixelStorei(Le.UNPACK_ALIGNMENT,F),this.current=F,this.dirty=!1}}class Es extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;Le.pixelStorei(Le.UNPACK_PREMULTIPLY_ALPHA_WEBGL,F),this.current=F,this.dirty=!1}}class Ss extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;const Le=this.gl;Le.pixelStorei(Le.UNPACK_FLIP_Y_WEBGL,F),this.current=F,this.dirty=!1}}class Cs extends $o{constructor(F,Le){super(F),this.context=F,this.parent=Le}getDefault(){return null}}class Is extends Cs{setDirty(){this.dirty=!0}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Le=this.gl;Le.framebufferTexture2D(Le.FRAMEBUFFER,Le.COLOR_ATTACHMENT0,Le.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}}class Rs extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Le=this.gl;Le.framebufferRenderbuffer(Le.FRAMEBUFFER,this.attachment(),Le.RENDERBUFFER,F),this.current=F,this.dirty=!1}}class Ds extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const Le=this.gl;Le.framebufferTexture2D(Le.FRAMEBUFFER,this.attachment(),Le.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}}class As extends Rs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Ls=(F,Le,Oe)=>({u_matrix:F,u_image0:0,u_skirt_height:Le,u_ground_shadow_factor:Oe}),Ms=(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo)=>({u_proj_matrix:Float32Array.from(F),u_globe_matrix:Le,u_normalize_matrix:Float32Array.from(Fe),u_merc_matrix:Oe,u_zoom_transition:je,u_merc_center:qe,u_image0:0,u_frustum_tl:He,u_frustum_tr:xt,u_frustum_br:jt,u_frustum_bl:Gt,u_globe_pos:bi,u_globe_radius:wi,u_viewport:qr,u_grid_matrix:yo?Float32Array.from(yo):new Float32Array(9),u_skirt_height:Xn,u_far_z_cutoff:Yn});function Ps(F,Le){return null!=F&&null!=Le&&!(!F.hasData()||!Le.hasData())&&null!=F.demTexture&&null!=Le.demTexture&&F.tileID.key!==Le.tileID.key}const ep=new class{constructor(){this.operations={}}newMorphing(F,Le,Oe,Fe,je){if(F in this.operations){const Le=this.operations[F];Le.to.tileID.key!==Oe.tileID.key&&(Le.queued=Oe)}else this.operations[F]={startTime:Fe,phase:0,duration:je,from:Le,to:Oe,queued:null}}getMorphValuesForProxy(F){if(!(F in this.operations))return null;const Le=this.operations[F];return{from:Le.from,to:Le.to,phase:Le.phase}}update(F){for(const Le in this.operations){const Oe=this.operations[Le];for(Oe.phase=(F-Oe.startTime)/Oe.duration;Oe.phase>=1||!this._validOp(Oe);)if(!this._nextOp(Oe,F)){delete this.operations[Le];break}}}_nextOp(F,Le){return!!F.queued&&(F.from=F.to,F.to=F.queued,F.queued=null,F.phase=0,F.startTime=Le,!0)}_validOp(F){return F.from.hasData()&&F.to.hasData()}},ip={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Fs(F,Le,Oe){if(0===Le)return 0;const Fe=Le<1&&514===Oe?.25/Le:1;return 6*Math.pow(1.5,22-F)*Math.max(Le,1)*Fe}function ks(F,Le){const Oe=1<<F.z;return!Le&&(0===F.x||F.x===Oe-1)||0===F.y||F.y===Oe-1}const Bs=F=>({u_matrix:F});function Ns(Le,Oe,Fe,je,qe){if(qe>0){const He=F.q.now(),xt=(He-Le.timeAdded)/qe,jt=Oe?(He-Oe.timeAdded)/qe:-1,Gt=Fe.getSource(),bi=je.coveringZoomLevel({tileSize:Gt.tileSize,roundZoom:Gt.roundZoom}),wi=!Oe||Math.abs(Oe.tileID.overscaledZ-bi)>Math.abs(Le.tileID.overscaledZ-bi),qr=wi&&Le.refreshedUponExpiration?1:F.ay(wi?xt:1-jt,0,1);return Le.refreshedUponExpiration&&xt>=1&&(Le.refreshedUponExpiration=!1),Oe?{opacity:1,mix:1-qr}:{opacity:qr,mix:0}}return{opacity:1,mix:0}}class Us extends St{constructor(Le){const Oe={type:"raster-dem",maxzoom:Le.transform.maxZoom},Fe=new F.D(F.cj(),null),je=rt("mock-dem",Oe,Fe,Le.style);super("mock-dem",je,!1),je.setEventedParent(this),this._sourceLoaded=!0}_loadTile(F,Le){F.state="loaded",Le(null)}}class Vs extends St{constructor(Le){const Oe=rt("proxy",{type:"geojson",maxzoom:Le.transform.maxZoom},new F.D(F.cj(),null),Le.style);super("proxy",Oe,!1),Oe.setEventedParent(this),this.map=this.getSource().map=Le,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(F,Le,Oe){if(F.freezeTileCoverage)return;this.transform=F;const Fe=F.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((Le,Oe)=>{if(Le[Oe.key]="",!this._tiles[Oe.key]){const Le=new bt(Oe,this._source.tileSize*Oe.overscaleFactor(),F.tileZoom);Le.state="loaded",this._tiles[Oe.key]=Le}return Le}),{});for(const F in this._tiles)F in Fe||(this.freeFBO(F),this._tiles[F].unloadVectorData(),delete this._tiles[F])}freeFBO(F){const Le=this.proxyCachedFBO[F];if(void 0!==Le){const Oe=Object.values(Le);this.renderCachePool.push(...Oe),delete this.proxyCachedFBO[F]}}deallocRenderCache(){this.renderCache.forEach((F=>F.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Gs extends F.aH{constructor(F,Le,Oe){super(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y),this.proxyTileKey=Le,this.projMatrix=Oe}}class js extends F.cK{constructor(Le,Oe){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},Le.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),Le.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),Le.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=Le,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[Fe,je,qe]=function(){const Le=new F.b5,Oe=new F.aV,Fe=131;Le.reserve(17161),Oe.reserve(33800);const je=F.ai/128,qe=F.ai+je/2,He=qe+je;for(let Oe=-je;Oe<He;Oe+=je)for(let Fe=-je;Fe<He;Fe+=je){const je=Fe<0||Fe>qe||Oe<0||Oe>qe?24575:0,He=F.ay(Math.round(Fe),0,F.ai),xt=F.ay(Math.round(Oe),0,F.ai);Le.emplaceBack(He+je,xt)}const l=(F,Le)=>{const je=Le*Fe+F;Oe.emplaceBack(je+1,je,je+Fe),Oe.emplaceBack(je+Fe,je+Fe+1,je+1)};for(let F=1;F<129;F++)for(let Le=1;Le<129;Le++)l(Le,F);return[0,129].forEach((F=>{for(let Le=0;Le<130;Le++)l(Le,F),l(F,Le)})),[Le,Oe,32768]}(),He=Le.context;this.gridBuffer=He.createVertexBuffer(Fe,F.b7.members),this.gridIndexBuffer=He.createIndexBuffer(je),this.gridSegments=F.b8.simpleSegment(0,0,Fe.length,je.length),this.gridNoSkirtSegments=F.b8.simpleSegment(0,0,Fe.length,qe),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Vs(Oe.map),this.orthoMatrix=F.ad.mat4.create(),F.ad.mat4.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,F.ai,0,F.ai,0,1);const xt=He.gl;this._overlapStencilMode=new Ui({func:xt.GEQUAL,mask:255},0,255,xt.KEEP,xt.KEEP,xt.REPLACE),this._previousZoom=Le.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=Oe,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Us(Oe.map),this._pendingGroundEffectLayers=[]}set style(F){F.on("data",this._onStyleDataEvent.bind(this)),this._style=F,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(Le,Oe,Fe){if(Le&&Le.terrain){this._style!==Le&&(this.style=Le,this._evaluationZoom=void 0);const je=Le.terrain.properties,qe=0===Le.terrain.drapeRenderMode,He=Le.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=F.q.now();const xt=Le.terrain&&Le.terrain.scope,jt=je.get("source"),Gt=qe?this._mockSourceCache:Le.getSourceCache(jt,xt);if(!Gt)return void F.w(`Couldn't find terrain source "${jt}".`);if(this.sourceCache=Gt,this._attenuationRange=Le.terrain.getAttenuationRange(),this._exaggeration=He?this.calculateExaggeration(Oe):je.get("exaggeration"),!Oe.projection.requiresDraping&&He&&0===this._exaggeration)return void this._disable();this.enabled=!0;const h=()=>{this.sourceCache.used&&F.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const Le=this.getScaledDemTileSize();this.sourceCache.update(Oe,Le,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),Oe.updateElevation(!0,Fe),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(Oe),this._emptyDEMTextureDirty=!0,this._previousZoom=Oe.zoom}else this._disable()}calculateExaggeration(Le){if(this._attenuationRange&&Le.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(Le.zoom);const Oe=this._previousCameraAltitude,Fe=Le.getFreeCameraOptions().position.z/Le.pixelsPerMeter*Le.worldSize;this._previousCameraAltitude=Fe;const je=null!=Oe?Fe-Oe:Number.MAX_VALUE;if(Math.abs(je)<2)return this._exaggeration;const qe=Le.zoom,He=this._style.terrain;if(!this._previousUpdateTimestamp)return He.getExaggeration(qe);let xt=qe-this._previousZoom;const jt=this._previousUpdateTimestamp;let Gt=qe;null!=this._evaluationZoom&&(Gt=this._evaluationZoom,Math.abs(qe-Gt)>.5&&(xt=.5*(qe-Gt+xt)),xt*je<0&&(Gt+=xt)),this._evaluationZoom=Gt;const bi=He.getExaggeration(Gt),wi=bi===He.getExaggeration(Math.max(0,Gt-.1));if(wi&&Math.abs(bi-this._exaggeration)<.01)return bi;let qr=Math.min(.1,.00375*(this._updateTimestamp-jt));return(wi||bi<.1||Math.abs(xt)<1e-4)&&(qr=Math.min(.2,4*qr)),F.ah(this._exaggeration,bi,qr)}resetTileLookupCache(F){this._findCoveringTileCache[F]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(F){F.coord&&"source"===F.dataType?this._clearRenderCacheForTile(F.sourceCacheId,F.coord):"style"===F.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const F in this._style._mergedSourceCaches)this._style._mergedSourceCaches[F].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((F=>F.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const F=2*this.proxySourceCache.getSource().tileSize;return[F,F]}set useVertexMorphing(F){this._useVertexMorphing=F}updateTileBinding(Le){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const Oe=this.proxySourceCache,Fe=this.painter.transform;this._initializing&&(this._initializing=0===Fe._centerAltitude&&-1===this.getAtPointOrZero(F.ac.fromLngLat(Fe.center),-1),this._emptyDEMTextureDirty=!this._initializing);const je=this.proxyCoords=Oe.getIds().map((F=>{const Le=Oe.getTileByID(F).tileID;return Le.projMatrix=Fe.calculateProjMatrix(Le.toUnwrapped()),Le}));!function(Le,Oe){const Fe=Oe.transform.pointCoordinate(Oe.transform.getCameraPoint()),je=new F.P(Fe.x,Fe.y);Le.sort(((Le,Oe)=>{if(Oe.overscaledZ-Le.overscaledZ)return Oe.overscaledZ-Le.overscaledZ;const Fe=new F.P(Le.canonical.x+(1<<Le.canonical.z)*Le.wrap,Le.canonical.y),qe=new F.P(Oe.canonical.x+(1<<Oe.canonical.z)*Oe.wrap,Oe.canonical.y),He=je.mult(1<<Le.canonical.z);return He.x-=.5,He.y-=.5,He.distSqr(Fe)-He.distSqr(qe)}))}(je,this.painter);const qe=this.proxyToSource||{};this.proxyToSource={},je.forEach((F=>{this.proxyToSource[F.key]={}})),this.terrainTileForTile={};const He=this._style._mergedSourceCaches;for(const F in He){const Oe=He[F];if(!Oe.used)continue;if(Oe!==this.sourceCache&&this.resetTileLookupCache(Oe.id),this._setupProxiedCoordsForOrtho(Oe,Le[F],qe),Oe.usedForTerrain)continue;const Fe=Le[F];Oe.getSource().reparseOverscaled&&this._assignTerrainTiles(Fe)}this.proxiedCoords[Oe.id]=je.map((F=>new Gs(F,F.key,this.orthoMatrix))),this._assignTerrainTiles(je),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(qe),this.renderingToTexture=!1;const xt={};this._visibleDemTiles=[];for(const F of this.proxyCoords){const Le=this.terrainTileForTile[F.key];if(!Le)continue;const Oe=Le.tileID.key;Oe in xt||(this._visibleDemTiles.push(Le),xt[Oe]=Oe)}}_assignTerrainTiles(F){this._initializing||F.forEach((F=>{if(this.terrainTileForTile[F.key])return;const Le=this._findTileCoveringTileID(F,this.sourceCache);Le&&(this.terrainTileForTile[F.key]=Le)}))}_prepareDEMTextures(){const F=this.painter.context,Le=F.gl;for(const Oe in this.terrainTileForTile){const Fe=this.terrainTileForTile[Oe],je=Fe.dem;!je||Fe.demTexture&&!Fe.needsDEMTextureUpload||(F.activeTexture.set(Le.TEXTURE1),Zo(this.painter,Fe,je))}}_prepareDemTileUniforms(F,Le,Oe,Fe){if(!Le||null==Le.demTexture)return!1;const je=F.tileID.canonical,qe=Math.pow(2,Le.tileID.canonical.z-je.z),He=Fe||"";return Oe[`u_dem_tl${He}`]=[je.x*qe%1,je.y*qe%1],Oe[`u_dem_scale${He}`]=qe,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let F=0;const Le=this._visibleDemTiles.reduce(((Le,Oe)=>{if(!Oe.dem)return Le;const Fe=Oe.dem.tree.minimums[0];return Fe>0&&F++,Le+Fe}),0);return F?Le/F:0}_updateEmptyDEMTexture(){const Le=this.painter.context,Oe=Le.gl;Le.activeTexture.set(Oe.TEXTURE2);const Fe=this._getLoadedAreaMinimum(),je=new F.cL({width:1,height:1},new Float32Array([Fe]));this._emptyDEMTextureDirty=!1;let qe=this._emptyDEMTexture;return qe?qe.update(je,{premultiply:!1}):qe=this._emptyDEMTexture=new F.T(Le,je,Oe.R32F,{premultiply:!1}),qe}setupElevationDraw(Le,Oe,Fe){const je=this.painter.context,qe=je.gl,He={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};He.u_exaggeration=this.exaggeration();let xt=null,jt=null,Gt=1;if(Fe&&Fe.morphing&&this._useVertexMorphing){const F=Fe.morphing.srcDemTile,Oe=Fe.morphing.dstDemTile;Gt=Fe.morphing.phase,F&&Oe&&(this._prepareDemTileUniforms(Le,F,He,"_prev")&&(jt=F),this._prepareDemTileUniforms(Le,Oe,He)&&(xt=Oe))}const h=F=>F&&F.demTexture&&this.painter.linearFloatFilteringSupported()?qe.LINEAR:qe.NEAREST;let bi=null;var wi;if(this.enabled?jt&&xt?(bi=xt.demTexture,je.activeTexture.set(qe.TEXTURE4),jt.demTexture.bind(h(jt),qe.CLAMP_TO_EDGE),He.u_dem_lerp=Gt):(xt=this.terrainTileForTile[Le.tileID.key],bi=this._prepareDemTileUniforms(Le,xt,He)?xt.demTexture:this.emptyDEMTexture):bi=this.emptyDEMTexture,je.activeTexture.set(qe.TEXTURE2),bi&&(He.u_dem_size=1===(wi=bi).size[0]?1:wi.size[0]-2,bi.bind(h(xt),qe.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(Fe&&Fe.useDepthForOcclusion,Oe,He),Fe&&Fe.useMeterToDem&&xt){const Le=(1<<xt.tileID.canonical.z)*F.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;He.u_meter_to_dem=Le}if(Fe&&Fe.labelPlaneMatrixInv&&(He.u_label_plane_matrix_inv=Fe.labelPlaneMatrixInv),Oe.setTerrainUniformValues(je,He),"globe"===this.painter.transform.projection.name){const F=this.globeUniformValues(this.painter.transform,Le.tileID.canonical,Fe&&Fe.useDenormalizedUpVectorScale);Oe.setGlobeUniformValues(je,F)}}globeUniformValues(Le,Oe,Fe){const je=Le.projection;return{u_tile_tl_up:je.upVector(Oe,0,0),u_tile_tr_up:je.upVector(Oe,F.ai,0),u_tile_br_up:je.upVector(Oe,F.ai,F.ai),u_tile_bl_up:je.upVector(Oe,0,F.ai),u_tile_up_scale:Fe?F.cM(1):je.upVectorScale(Oe,Le.center.lat,Le.worldSize).metersToTile}}renderToBackBuffer(Le){const Oe=this.painter,Fe=this.painter.context;0!==Le.length&&(Fe.bindFramebuffer.set(null),Fe.viewport.set([0,0,Oe.width,Oe.height]),Oe.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(Le,Oe,Fe,je,qe){if("globe"===Le.transform.projection.name)!function(Le,Oe,Fe,je,qe){const He=Le.context,xt=He.gl;let jt,Gt;const bi=Le.transform,wi=F.cD(Le,He,bi),u=(F,Oe)=>{if(Gt===Oe)return;const Fe=[ip[Oe],"PROJECTION_GLOBE_VIEW"];wi&&Fe.push("CUSTOM_ANTIALIASING");const je=Le.isTileAffectedByFog(F);jt=Le.getOrCreateProgram("globeRaster",{defines:Fe,overrideFog:je}),Gt=Oe},qr=Le.colorModeForRenderPass(),Xn=new Bi(xt.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D);ep.update(qe);const Yn=F.cE(bi),yo=[F.av(bi.center.lng),F.aC(bi.center.lat)],bo=Le.globeSharedBuffers,Do=[bi.width*F.q.devicePixelRatio,bi.height*F.q.devicePixelRatio],Ro=Float32Array.from(bi.globeMatrix),zs={useDenormalizedUpVectorScale:!0};{const bi=Le.transform,wi=Fs(bi.zoom,Oe.exaggeration(),Oe.sourceCache._source.tileSize);Gt=-1;const Zs=xt.TRIANGLES;for(const Gt of je){const je=Fe.getTile(Gt),na=Ui.disabled,el=Oe.prevTerrainTileForTile[Gt.key],nl=Oe.terrainTileForTile[Gt.key];Ps(el,nl)&&ep.newMorphing(Gt.key,el,nl,qe,250),He.activeTexture.set(xt.TEXTURE0),je.texture&&je.texture.bind(xt.LINEAR,xt.CLAMP_TO_EDGE);const hl=ep.getMorphValuesForProxy(Gt.key),pl=hl?1:0;hl&&F.L(zs,{morphing:{srcDemTile:hl.from,dstDemTile:hl.to,phase:F.cC(hl.phase)}});const bl=F.cF(Gt.canonical),Tl=F.cG(bl.getCenter().lat),kl=F.cH(Gt.canonical,bl,Tl,bi.worldSize/bi._pixelsPerMercatorPixel),ec=F.bc(F.cI(Gt.canonical)),tc=Ms(bi.expandedFarZProjMatrix,Ro,Yn,ec,F.ag(bi.zoom),yo,bi.frustumCorners.TL,bi.frustumCorners.TR,bi.frustumCorners.BR,bi.frustumCorners.BL,bi.globeCenterInViewSpace,bi.globeRadius,Do,wi,bi._farZ,kl);if(u(Gt,pl),jt&&(Oe.setupElevationDraw(je,jt,zs),Le.uploadCommonUniforms(He,jt,Gt.toUnwrapped()),bo)){const[F,Oe,Fe]=bo.getGridBuffers(Tl,0!==wi);jt.draw(Le,Zs,Xn,na,qr,ji.backCCW,tc,"globe_raster",F,Oe,Fe)}}}if(bo&&(Le.renderDefaultNorthPole||Le.renderDefaultSouthPole)){const qe=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];wi&&qe.push("CUSTOM_ANTIALIASING"),jt=Le.getOrCreateProgram("globeRaster",{defines:qe});for(const qe of je){const{x:je,y:Gt,z:wi}=qe.canonical,Yn=0===Gt,Ro=Gt===(1<<wi)-1,[Zs,na,el,nl]=bo.getPoleBuffers(wi,!1);if(nl&&(Yn||Ro)){const Gt=Fe.getTile(qe);He.activeTexture.set(xt.TEXTURE0),Gt.texture&&Gt.texture.bind(xt.LINEAR,xt.CLAMP_TO_EDGE);let bo=F.cJ(wi,je,bi);const hl=F.bc(F.cI(qe.canonical)),S=(F,Oe)=>F.draw(Le,xt.TRIANGLES,Xn,Ui.disabled,qr,ji.disabled,Ms(bi.expandedFarZProjMatrix,bo,bo,hl,0,yo,bi.frustumCorners.TL,bi.frustumCorners.TR,bi.frustumCorners.BR,bi.frustumCorners.BL,bi.globeCenterInViewSpace,bi.globeRadius,Do,0,bi._farZ),"globe_pole_raster",Oe,el,nl);Oe.setupElevationDraw(Gt,jt,zs),Le.uploadCommonUniforms(He,jt,qe.toUnwrapped()),Yn&&Le.renderDefaultNorthPole&&S(jt,Zs),Ro&&Le.renderDefaultSouthPole&&(bo=F.ad.mat4.scale(F.ad.mat4.create(),bo,[1,-1,1]),S(jt,na))}}}}(Le,Oe,Fe,je,qe);else{const He=Le.context,xt=He.gl;let jt,Gt;const bi=Le.shadowRenderer,wi=Qi(Le,Le.longestCutoffRange),u=F=>{if(Gt===F)return;const Oe=[];Oe.push(ip[F]),wi.shouldRenderCutoff&&Oe.push("RENDER_CUTOFF"),bi&&(Oe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),bi.useNormalOffset&&Oe.push("NORMAL_OFFSET")),jt=Le.getOrCreateProgram("terrainRaster",{defines:Oe}),Gt=F},qr=Le.colorModeForRenderPass(),Xn=new Bi(xt.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D);ep.update(qe);const Yn=Le.transform,yo=Fs(Yn.zoom,Oe.exaggeration(),Oe.sourceCache._source.tileSize);let bo=[0,0,0];if(bi){const F=Le.style.directionalLight,Oe=Le.style.ambientLight;F&&Oe&&(bo=no(Le.style,F,Oe))}{Gt=-1;const Do=xt.TRIANGLES,[Ro,zs]=[Oe.gridIndexBuffer,Oe.gridSegments];for(const Gt of je){const je=Fe.getTile(Gt),Zs=Ui.disabled,na=Oe.prevTerrainTileForTile[Gt.key],el=Oe.terrainTileForTile[Gt.key];Ps(na,el)&&ep.newMorphing(Gt.key,na,el,qe,250),He.activeTexture.set(xt.TEXTURE0),je.texture&&je.texture.bind(xt.LINEAR,xt.CLAMP_TO_EDGE);const nl=ep.getMorphValuesForProxy(Gt.key),hl=nl?1:0;let pl;nl&&(pl={morphing:{srcDemTile:nl.from,dstDemTile:nl.to,phase:F.cC(nl.phase)}});const bl=Ls(Gt.projMatrix,ks(Gt.canonical,Yn.renderWorldCopies)?yo/10:yo,bo);if(u(hl),!jt)continue;Oe.setupElevationDraw(je,jt,pl);const Tl=Gt.toUnwrapped();bi&&bi.setupShadows(Tl,jt),Le.uploadCommonUniforms(He,jt,Tl,null,wi),jt.draw(Le,Do,Xn,Zs,qr,ji.backCCW,bl,"terrain_raster",Oe.gridBuffer,Ro,zs)}}}}(Oe,this,this.proxySourceCache,Le,this._updateTimestamp),this.renderingToTexture=!0,Oe.gpuTimingDeferredRenderEnd(),Le.splice(0,Le.length))}renderBatch(Le){if(0===this._drapedRenderBatches.length)return Le+1;this.renderingToTexture=!0;const Oe=this.painter,Fe=this.painter.context,je=this.proxySourceCache,qe=this.proxiedCoords[je.id],He=this._drapedRenderBatches.shift(),xt=Oe.style.order,jt=[];let Gt=0;for(const bi of qe){const qe=je.getTileByID(bi.proxyTileKey),wi=je.proxyCachedFBO[bi.key]?je.proxyCachedFBO[bi.key][Le]:void 0,qr=void 0!==wi?je.renderCache[wi]:this.pool[Gt++],Xn=void 0!==wi;if(qe.texture=qr.tex,Xn&&!qr.dirty){jt.push(qe.tileID);continue}let Yn;Fe.bindFramebuffer.set(qr.fb.framebuffer),this.renderedToTile=!1,qr.dirty&&(Fe.clear({color:F.al.transparent,stencil:0}),qr.dirty=!1);for(let F=He.start;F<=He.end;++F){const Le=Oe.style._mergedLayers[xt[F]];if(Le.isHidden(Oe.transform.zoom))continue;const je=Oe.style.getLayerSourceCache(Le),qe=je?this.proxyToSource[bi.key][je.id]:[bi];if(!qe)continue;const He=qe;Fe.viewport.set([0,0,qr.fb.width,qr.fb.height]),Yn!==(je?je.id:null)&&(this._setupStencil(qr,qe,Le,je),Yn=je?je.id:null),Oe.renderLayer(Oe,je,Le,He)}if(0===this._drapedRenderBatches.length)for(const F of this._pendingGroundEffectLayers){const Le=Oe.style._mergedLayers[xt[F]];if(Le.isHidden(Oe.transform.zoom))continue;const je=Oe.style.getLayerSourceCache(Le),qe=je?this.proxyToSource[bi.key][je.id]:[bi];if(!qe)continue;const He=qe;Fe.viewport.set([0,0,qr.fb.width,qr.fb.height]),Yn!==(je?je.id:null)&&(this._setupStencil(qr,qe,Le,je),Yn=je?je.id:null),Oe.renderLayer(Oe,je,Le,He)}this.renderedToTile?(qr.dirty=!0,jt.push(qe.tileID)):Xn||--Gt,5===Gt&&(Gt=0,this.renderToBackBuffer(jt))}return this.renderToBackBuffer(jt),this.renderingToTexture=!1,Fe.bindFramebuffer.set(null),Fe.viewport.set([0,0,Oe.width,Oe.height]),He.end+1}postRender(){}isLayerOrderingCorrect(F){const Le=F.order.length;let Oe=-1,Fe=Le;for(let je=0;je<Le;++je)this._style.isLayerDraped(F._mergedLayers[F.order[je]])?Oe=Math.max(Oe,je):Fe=Math.min(Fe,je);return Fe>Oe}getMinElevationBelowMSL(){let F=0;return this._visibleDemTiles.filter((F=>F.dem)).forEach((Le=>{F=Math.min(F,Le.dem.tree.minimums[0])})),0===F?F:(F-30)*this._exaggeration}raycast(F,Le,Oe){if(!this._visibleDemTiles)return null;const Fe=this._visibleDemTiles.filter((F=>F.dem)).map((Fe=>{const je=Fe.tileID,qe=1<<je.overscaledZ,{x:He,y:xt}=je.canonical,jt=He/qe,Gt=(He+1)/qe,bi=xt/qe,wi=(xt+1)/qe;return{minx:jt,miny:bi,maxx:Gt,maxy:wi,t:Fe.dem.tree.raycastRoot(jt,bi,Gt,wi,F,Le,Oe),tile:Fe}}));Fe.sort(((F,Le)=>(null!==F.t?F.t:Number.MAX_VALUE)-(null!==Le.t?Le.t:Number.MAX_VALUE)));for(const je of Fe){if(null==je.t)return null;const Fe=je.tile.dem.tree.raycast(je.minx,je.miny,je.maxx,je.maxy,F,Le,Oe);if(null!=Fe)return Fe}return null}_createFBO(){const Le=this.painter.context,Oe=Le.gl,Fe=this.drapeBufferSize;Le.activeTexture.set(Oe.TEXTURE0);const je=new F.T(Le,{width:Fe[0],height:Fe[1],data:null},Oe.RGBA8);je.bind(Oe.LINEAR,Oe.CLAMP_TO_EDGE);const qe=Le.createFramebuffer(Fe[0],Fe[1],!0,null);return qe.colorAttachment.set(je.texture),qe.depthAttachment=new As(Le,qe.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=Le.createRenderbuffer(Le.gl.DEPTH_STENCIL,Fe[0],Fe[1]),this._stencilRef=0,qe.depthAttachment.set(this._sharedDepthStencil),Le.clear({stencil:0})):qe.depthAttachment.set(this._sharedDepthStencil),Le.extTextureFilterAnisotropic&&Oe.texParameterf(Oe.TEXTURE_2D,Le.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Le.extTextureFilterAnisotropicMax),{fb:qe,tex:je,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache)return!0;if(this._style.hasLightTransitions())return!0;for(const F in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[F].hasTransition())return!0;return this._style.order.some((F=>{const Le=this._style._mergedLayers[F],Oe=Le.isHidden(this.painter.transform.zoom);return"hillshade"===Le.type||"custom"===Le.type?!Oe&&Le.shouldRedrape():!Oe&&Le.hasTransition()}))}_clearLineLayersFromRenderCache(){let Le=!1;for(const F of this._style.getSources())if(F instanceof tt){Le=!0;break}if(!Le)return;const Oe={};for(let Le=0;Le<this._style.order.length;++Le){const Fe=this._style._mergedLayers[this._style.order[Le]],je=this._style.getLayerSourceCache(Fe);if(je&&!Oe[je.id]&&!Fe.isHidden(this.painter.transform.zoom)&&"line"===Fe.type&&Fe.widthExpression()instanceof F.ab){Oe[je.id]=!0;for(const F of this.proxyCoords){const Le=this.proxyToSource[F.key][je.id];if(Le)for(const F of Le)this._clearRenderCacheForTile(je.id,F)}}}}_clearRasterLayersFromRenderCache(){let F=!1;for(const Le in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[Le]._source instanceof it){F=!0;break}if(!F)return;const Le={};for(let F=0;F<this._style.order.length;++F){const Oe=this._style._mergedLayers[this._style.order[F]],Fe=this._style.getLayerSourceCache(Oe);if(!Fe||Le[Fe.id])continue;if(Oe.isHidden(this.painter.transform.zoom)||"raster"!==Oe.type)continue;const je=Oe.paint.get("raster-fade-duration");for(const F of this.proxyCoords){const Le=this.proxyToSource[F.key][Fe.id];if(Le)for(const F of Le){const Le=Ns(Fe.getTile(F),Fe.findLoadedParent(F,0),Fe,this.painter.transform,je);(1!==Le.opacity||0!==Le.mix)&&this._clearRenderCacheForTile(Fe.id,F)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const Le=this._style.order,Oe=Le.length;if(0===Oe)return;const Fe=[];this._pendingGroundEffectLayers=[];let je,qe=0,He=this._style._mergedLayers[Le[qe]];for(;!this._style.isLayerDraped(He)&&He.isHidden(this.painter.transform.zoom)&&++qe<Oe;)He=this._style._mergedLayers[Le[qe]];for(;qe<Oe;++qe){const F=this._style._mergedLayers[Le[qe]];F.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(F)?void 0===je&&(je=qe):("fill-extrusion"===F.type&&this._pendingGroundEffectLayers.push(qe),void 0!==je&&(Fe.push({start:je,end:qe-1}),je=void 0)))}if(void 0!==je&&Fe.push({start:je,end:qe-1}),0!==Fe.length){const Le=Fe[Fe.length-1];this._pendingGroundEffectLayers.every((F=>F>Le.end))||F.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=Fe}_setupRenderCache(F){const Le=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,Le.renderCache.length>Le.renderCachePool.length){const F=Object.values(Le.proxyCachedFBO);Le.proxyCachedFBO={};for(let Oe=0;Oe<F.length;++Oe){const Fe=Object.values(F[Oe]);Le.renderCachePool.push(...Fe)}}return}this._clearRasterLayersFromRenderCache();const Oe=this.proxyCoords,Fe=this._tilesDirty;for(let je=Oe.length-1;je>=0;je--){const qe=Oe[je];if(Le.getTileByID(qe.key),void 0!==Le.proxyCachedFBO[qe.key]){const Oe=F[qe.key],je=this.proxyToSource[qe.key];let He=0;for(const F in je){const Le=je[F],qe=Oe[F];if(!qe||qe.length!==Le.length||Le.some(((Le,Oe)=>Le!==qe[Oe]||Fe[F]&&Fe[F].hasOwnProperty(Le.key)))){He=-1;break}++He}for(const F in Le.proxyCachedFBO[qe.key])Le.renderCache[Le.proxyCachedFBO[qe.key][F]].dirty=He<0||He!==Object.values(Oe).length}}const je=[...this._drapedRenderBatches];je.sort(((F,Le)=>Le.end-Le.start-(F.end-F.start)));for(const F of je)for(const Fe of Oe){if(Le.proxyCachedFBO[Fe.key])continue;let Oe=Le.renderCachePool.pop();void 0===Oe&&Le.renderCache.length<50&&(Oe=Le.renderCache.length,Le.renderCache.push(this._createFBO())),void 0!==Oe&&(Le.proxyCachedFBO[Fe.key]={},Le.proxyCachedFBO[Fe.key][F.start]=Oe,Le.renderCache[Oe].dirty=!0)}this._tilesDirty={}}_setupStencil(F,Le,Oe,Fe){if(!Fe||!this._sourceTilesOverlap[Fe.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const je=this.painter.context,qe=je.gl;if(Le.length<=1)return void(this._overlapStencilType=!1);let He;if(Oe.isTileClipped())He=Le.length,this._overlapStencilMode.test={func:qe.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(Le[0].overscaledZ>Le[Le.length-1].overscaledZ))return void(this._overlapStencilType=!1);He=1,this._overlapStencilMode.test={func:qe.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+He>255&&(je.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=He,this._overlapStencilMode.ref=this._stencilRef,Oe.isTileClipped()&&this._renderTileClippingMasks(Le,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(F){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[F.key]),this._overlapStencilMode):Ui.disabled}_renderTileClippingMasks(F,Le){const Oe=this.painter,Fe=this.painter.context,je=Fe.gl;Oe._tileClippingMaskIDs={},Fe.setColorMode(ki.disabled),Fe.setDepthMode(Bi.disabled);const qe=Oe.getOrCreateProgram("clippingMask");for(const Fe of F){const F=Oe._tileClippingMaskIDs[Fe.key]=--Le;qe.draw(Oe,je.TRIANGLES,Bi.disabled,new Ui({func:je.ALWAYS,mask:0},F,255,je.KEEP,je.KEEP,je.REPLACE),ki.disabled,ji.disabled,Bs(Fe.projMatrix),"$clipping",Oe.tileExtentBuffer,Oe.quadTriangleIndexBuffer,Oe.tileExtentSegments)}}pointCoordinate(Le){const Oe=this.painter.transform;if(Le.x<0||Le.x>Oe.width||Le.y<0||Le.y>Oe.height)return null;const Fe=[Le.x,Le.y,1,1];F.ad.vec4.transformMat4(Fe,Fe,Oe.pixelMatrixInverse),F.ad.vec4.scale(Fe,Fe,1/Fe[3]),Fe[0]/=Oe.worldSize,Fe[1]/=Oe.worldSize;const je=Oe._camera.position,qe=F.bH(1,Oe.center.lat),He=[je[0],je[1],je[2]/qe,0],xt=F.ad.vec3.subtract([],Fe.slice(0,3),He);F.ad.vec3.normalize(xt,xt);const jt=this.raycast(He,xt,this._exaggeration);return null!==jt&&jt?(F.ad.vec3.scaleAndAdd(He,He,xt,jt),He[3]=He[2],He[2]*=qe,He):null}_setupProxiedCoordsForOrtho(Le,Oe,Fe){if(Le.getSource()instanceof F.aK)return this._setupProxiedCoordsForImageSource(Le,Oe,Fe);this._findCoveringTileCache[Le.id]=this._findCoveringTileCache[Le.id]||{};const je=this.proxiedCoords[Le.id]=[],qe=this.proxyCoords;for(let F=0;F<qe.length;F++){const Oe=qe[F],He=this._findTileCoveringTileID(Oe,Le);if(He){const F=this._createProxiedId(Oe,He,Fe[Oe.key]&&Fe[Oe.key][Le.id]);je.push(F),this.proxyToSource[Oe.key][Le.id]=[F]}}let He=!1;const xt=new Set;for(let F=0;F<Oe.length;F++){const qe=Le.getTile(Oe[F]);if(!qe||!qe.hasData())continue;const jt=this._findTileCoveringTileID(qe.tileID,this.proxySourceCache);if(jt&&jt.tileID.canonical.z!==qe.tileID.canonical.z){const F=this.proxyToSource[jt.tileID.key][Le.id],Oe=this._createProxiedId(jt.tileID,qe,Fe[jt.tileID.key]&&Fe[jt.tileID.key][Le.id]);F?F.splice(F.length-1,0,Oe):this.proxyToSource[jt.tileID.key][Le.id]=[Oe];const Gt=this.proxyToSource[jt.tileID.key][Le.id];xt.has(Gt)||xt.add(Gt),je.push(Oe),He=!0}}if(this._sourceTilesOverlap[Le.id]=He,He&&this._debugParams.sortTilesHiZFirst)for(const F of xt)F.sort(((F,Le)=>Le.overscaledZ-F.overscaledZ))}_setupProxiedCoordsForImageSource(Le,Oe,Fe){if(!Le.getSource().loaded())return;const je=this.proxiedCoords[Le.id]=[],qe=this.proxyCoords,He=Le.getSource(),xt=He.tileID;if(!xt)return;const jt=new F.P(xt.x,xt.y)._div(1<<xt.z),Gt=He.coordinates.map(F.ac.fromLngLat).reduce(((F,Le)=>(F.min.x=Math.min(F.min.x,Le.x-jt.x),F.min.y=Math.min(F.min.y,Le.y-jt.y),F.max.x=Math.max(F.max.x,Le.x-jt.x),F.max.y=Math.max(F.max.y,Le.y-jt.y),F)),{min:new F.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new F.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(Le,Oe)=>{const Fe=Le.wrap+Le.canonical.x/(1<<Le.canonical.z),je=Le.canonical.y/(1<<Le.canonical.z),qe=F.ai/(1<<Le.canonical.z),He=Oe.wrap+Oe.canonical.x/(1<<Oe.canonical.z),xt=Oe.canonical.y/(1<<Oe.canonical.z);return Fe+qe<He+Gt.min.x||Fe>He+Gt.max.x||je+qe<xt+Gt.min.y||je>xt+Gt.max.y};for(let F=0;F<qe.length;F++){const He=qe[F];for(let F=0;F<Oe.length;F++){const qe=Le.getTile(Oe[F]);if(!qe||!qe.hasData())continue;if(h(He,qe.tileID))continue;const xt=this._createProxiedId(He,qe,Fe[He.key]&&Fe[He.key][Le.id]),jt=this.proxyToSource[He.key][Le.id];jt?jt.push(xt):this.proxyToSource[He.key][Le.id]=[xt],je.push(xt)}}}_createProxiedId(Le,Oe,Fe){let je=this.orthoMatrix;if(Fe){const F=Fe.find((F=>F.key===Oe.tileID.key));if(F)return F}if(Oe.tileID.key!==Le.key){const Fe=Le.canonical.z-Oe.tileID.canonical.z;let qe,He,xt;je=F.ad.mat4.create();const jt=Oe.tileID.wrap-Le.wrap<<Le.overscaledZ;Fe>0?(qe=F.ai>>Fe,He=qe*((Oe.tileID.canonical.x<<Fe)-Le.canonical.x+jt),xt=qe*((Oe.tileID.canonical.y<<Fe)-Le.canonical.y)):(qe=F.ai<<-Fe,He=F.ai*(Oe.tileID.canonical.x-(Le.canonical.x+jt<<-Fe)),xt=F.ai*(Oe.tileID.canonical.y-(Le.canonical.y<<-Fe))),F.ad.mat4.ortho(je,0,qe,0,qe,0,1),F.ad.mat4.translate(je,je,[He,xt,0])}return new Gs(Oe.tileID,Le.key,je)}_findTileCoveringTileID(Le,Oe){let Fe=Oe.getTile(Le);if(Fe&&Fe.hasData())return Fe;const je=this._findCoveringTileCache[Oe.id],qe=je[Le.key];if(Fe=qe?Oe.getTileByID(qe):null,Fe&&Fe.hasData()||null===qe)return Fe;let He=Fe?Fe.tileID:Le,xt=He.overscaledZ;const jt=Oe.getSource().minzoom,Gt=[];if(!qe){const je=Oe.getSource().maxzoom;if(Le.canonical.z>=je){const Fe=Le.canonical.z-je;Oe.getSource().reparseOverscaled?(xt=Math.max(Le.canonical.z+2,Oe.transform.tileZoom),He=new F.aH(xt,Le.wrap,je,Le.canonical.x>>Fe,Le.canonical.y>>Fe)):0!==Fe&&(xt=je,He=new F.aH(xt,Le.wrap,je,Le.canonical.x>>Fe,Le.canonical.y>>Fe))}He.key!==Le.key&&(Gt.push(He.key),Fe=Oe.getTile(He))}const h=F=>{Gt.forEach((Le=>{je[Le]=F})),Gt.length=0};for(xt-=1;xt>=jt&&(!Fe||!Fe.hasData());xt--){Fe&&h(Fe.tileID.key);const F=He.calculateScaledKey(xt);if(Fe=Oe.getTileByID(F),Fe&&Fe.hasData())break;const Le=je[F];if(null===Le)break;void 0===Le?Gt.push(F):Fe=Oe.getTileByID(Le)}return h(Fe?Fe.tileID.key:null),Fe&&Fe.hasData()?Fe:null}findDEMTileFor(F){return this.enabled?this._findTileCoveringTileID(F,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(F,Le){let Oe=this._tilesDirty[F];Oe||(Oe=this._tilesDirty[F]={}),Oe[Le.key]=!0}}function qs(Le,Oe,Fe){const je=function(Le,Oe,Fe){const je=F.ad.vec3.dot(Oe,Le),qe=F.ad.vec3.dot(Fe,[.2126,.7152,.0722]),n=(F,Le,Oe)=>(1-Oe)*F+Oe*Le,He=n(1-.3*Math.min(qe,1),1,Math.min(je+1,1));return n(.92,1,Math.asin(F.ay(Oe[2],-1,1))/Math.PI+.5)*He}(Le,[0,0,1],Oe),qe=[0,0,0];F.ad.vec3.scale(qe,Fe.slice(0,3),je);const He=[0,0,0];F.ad.vec3.scale(He,Oe.slice(0,3),Le[2]);const xt=[0,0,0];return F.ad.vec3.add(xt,qe,He),F.cg(xt)}const rp=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],np=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Ws{static cacheKey(F,Le,Oe,Fe){let je=`${Le}${Fe?Fe.cacheKey:""}`;for(const Le of Oe)F.usedDefines.includes(Le)&&(je+=`/${Le}`);return je}constructor(Le,Oe,Fe,je,qe,He){const xt=Le.gl;this.program=xt.createProgram(),this.configuration=je,this.name=Oe,this.fixedDefines=[...He];const jt=je?je.getBinderAttributes():[],Gt=(Fe.staticAttributes||[]).concat(jt);let bi=je?je.defines():[];bi=bi.concat(He.map((F=>`#define ${F}`)));const wi="#version 300 es\n";let qr=wi+bi.concat("precision mediump float;",qd,Vd.fragmentSource).join("\n");for(const F of Fe.fragmentIncludes)qr+=`\n${vd[F]}`;qr+=`\n${Fe.fragmentSource}`;let Xn=wi+bi.concat("precision highp float;",qd,Vd.vertexSource).join("\n");for(const F of Fe.vertexIncludes)Xn+=`\n${vd[F]}`;this.forceManualRenderingForInstanceIDShaders=Le.forceManualRenderingForInstanceIDShaders&&-1!==Fe.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(Xn+="\nuniform int u_instanceID;\n"),Xn+=`\n${Fe.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(Xn=Xn.replaceAll("gl_InstanceID","u_instanceID"));const Yn=xt.createShader(xt.FRAGMENT_SHADER);if(xt.isContextLost())return void(this.failedToCreate=!0);xt.shaderSource(Yn,qr),xt.compileShader(Yn),xt.attachShader(this.program,Yn);const yo=xt.createShader(xt.VERTEX_SHADER);if(xt.isContextLost())this.failedToCreate=!0;else{xt.shaderSource(yo,Xn),xt.compileShader(yo),xt.attachShader(this.program,yo),this.attributes={},this.numAttributes=Gt.length;for(let F=0;F<this.numAttributes;F++)if(Gt[F]){const Le=Gt[F].startsWith("a_")?Gt[F]:`a_${Gt[F]}`;xt.bindAttribLocation(this.program,F,Le),this.attributes[Le]=F}xt.linkProgram(this.program),xt.deleteShader(yo),xt.deleteShader(Yn),this.fixedUniforms=qe(Le),this.binderUniforms=je?je.getUniforms(Le):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(Le=>({u_instanceID:new F.bN(Le)}))(Le)),(He.includes("TERRAIN")||-1!==Oe.indexOf("symbol")||-1!==Oe.indexOf("circle"))&&(this.terrainUniforms=(Le=>({u_dem:new F.bN(Le),u_dem_prev:new F.bN(Le),u_dem_tl:new F.bK(Le),u_dem_scale:new F.bM(Le),u_dem_tl_prev:new F.bK(Le),u_dem_scale_prev:new F.bM(Le),u_dem_size:new F.bM(Le),u_dem_lerp:new F.bM(Le),u_exaggeration:new F.bM(Le),u_depth:new F.bN(Le),u_depth_size_inv:new F.bK(Le),u_depth_range_unpack:new F.bK(Le),u_occluder_half_size:new F.bM(Le),u_occlusion_depth_offset:new F.bM(Le),u_meter_to_dem:new F.bM(Le),u_label_plane_matrix_inv:new F.bJ(Le)}))(Le)),He.includes("GLOBE")&&(this.globeUniforms=(Le=>({u_tile_tl_up:new F.bL(Le),u_tile_tr_up:new F.bL(Le),u_tile_br_up:new F.bL(Le),u_tile_bl_up:new F.bL(Le),u_tile_up_scale:new F.bM(Le)}))(Le)),He.includes("FOG")&&(this.fogUniforms=(Le=>({u_fog_matrix:new F.bJ(Le),u_fog_range:new F.bK(Le),u_fog_color:new F.cb(Le),u_fog_horizon_blend:new F.bM(Le),u_fog_vertical_limit:new F.bK(Le),u_fog_temporal_offset:new F.bM(Le),u_frustum_tl:new F.bL(Le),u_frustum_tr:new F.bL(Le),u_frustum_br:new F.bL(Le),u_frustum_bl:new F.bL(Le),u_globe_pos:new F.bL(Le),u_globe_radius:new F.bM(Le),u_globe_transition:new F.bM(Le),u_is_globe:new F.bN(Le),u_viewport:new F.bK(Le)}))(Le)),He.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(Le=>({u_cutoff_params:new F.cb(Le)}))(Le)),He.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(Le=>({u_lighting_ambient_color:new F.bL(Le),u_lighting_directional_dir:new F.bL(Le),u_lighting_directional_color:new F.bL(Le),u_ground_radiance:new F.bL(Le)}))(Le)),He.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(Le=>({u_light_matrix_0:new F.bJ(Le),u_light_matrix_1:new F.bJ(Le),u_fade_range:new F.bK(Le),u_shadow_normal_offset:new F.bL(Le),u_shadow_intensity:new F.bM(Le),u_shadow_texel_size:new F.bM(Le),u_shadow_map_resolution:new F.bM(Le),u_shadow_direction:new F.bL(Le),u_shadow_bias:new F.bL(Le),u_shadowmap_0:new F.bN(Le),u_shadowmap_1:new F.bN(Le)}))(Le))}}setTerrainUniformValues(F,Le){if(!this.terrainUniforms)return;const Oe=this.terrainUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Le)Oe[F]&&Oe[F].set(this.program,F,Le[F])}}setGlobeUniformValues(F,Le){if(!this.globeUniforms)return;const Oe=this.globeUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Le)Oe[F]&&Oe[F].set(this.program,F,Le[F])}}setFogUniformValues(F,Le){if(!this.fogUniforms)return;const Oe=this.fogUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Le)Oe[F].set(this.program,F,Le[F])}}setCutoffUniformValues(F,Le){if(!this.cutoffUniforms)return;const Oe=this.cutoffUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Le)Oe[F].set(this.program,F,Le[F])}}setLightsUniformValues(F,Le){if(!this.lightsUniforms)return;const Oe=this.lightsUniforms;if(!this.failedToCreate){F.program.set(this.program);for(const F in Le)Oe[F].set(this.program,F,Le[F])}}setShadowUniformValues(F,Le){if(this.failedToCreate||!this.shadowUniforms)return;const Oe=this.shadowUniforms;F.program.set(this.program);for(const F in Le)Oe[F].set(this.program,F,Le[F])}_drawDebugWireframe(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi){const wi=Le.options.wireframe;if(!1===wi.terrain&&!1===wi.layers2D&&!1===wi.layers3D)return;const qr=Le.context;if(!(()=>!(!wi.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!wi.layers2D||Le._terrain&&Le._terrain.renderingToTexture||!rp.includes(this.name))||!(!wi.layers3D||!np.includes(this.name)))())return;const Xn=qr.gl,Yn=Le.wireframeDebugCache.getLinesFromTrianglesBuffer(Le.frameCounter,qe,qr);if(!Yn)return;const yo=[...this.fixedDefines];yo.push("DEBUG_WIREFRAME");const bo=Le.getOrCreateProgram(this.name,{config:this.configuration,defines:yo});qr.program.set(bo.program);const g=(F,Le,Oe)=>{if(Le[F]&&Oe[F])for(const Fe in Le[F])Oe[F][Fe]&&Oe[F][Fe].set(Oe.program,Fe,Le[F][Fe].current)};Gt&&Gt.setUniforms(bo.program,qr,bo.binderUniforms,xt,{zoom:jt}),g("fixedUniforms",this,bo),g("terrainUniforms",this,bo),g("globeUniforms",this,bo),g("fogUniforms",this,bo),g("lightsUniforms",this,bo),g("shadowUniforms",this,bo),Yn.bind(),qr.setColorMode(new ki([Xn.ONE,Xn.ONE_MINUS_SRC_ALPHA,Xn.ZERO,Xn.ONE],F.al.transparent,[!0,!0,!0,!1])),qr.setDepthMode(new Bi(Oe.func===Xn.LESS?Xn.LEQUAL:Oe.func,Bi.ReadOnly,Oe.range)),qr.setStencilMode(Ui.disabled);const Do=3*He.primitiveLength*2,Ro=3*He.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const F=bi||1;for(let Le=0;Le<F;++Le)bo.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Le),Xn.drawElements(Xn.LINES,Do,Xn.UNSIGNED_SHORT,Ro)}else bi&&bi>1?Xn.drawElementsInstanced(Xn.LINES,Do,Xn.UNSIGNED_SHORT,Ro,bi):Xn.drawElements(Xn.LINES,Do,Xn.UNSIGNED_SHORT,Ro);qe.bind(),qr.program.set(this.program),qr.setDepthMode(Oe),qr.setStencilMode(Fe),qr.setColorMode(je)}checkUniforms(F,Le,Oe){if(this.fixedDefines.includes(Le))for(const Fe of Object.keys(Oe))if(!Oe[Fe].initialized)throw new Error(`Program '${this.name}', from draw '${F}': uniform ${Fe} not set but required by ${Le} being defined`)}draw(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo){const bo=F.context,Do=bo.gl;if(this.failedToCreate)return;bo.program.set(this.program),bo.setDepthMode(Oe),bo.setStencilMode(Fe),bo.setColorMode(je),bo.setCullFace(qe);for(const F of Object.keys(this.fixedUniforms))this.fixedUniforms[F].set(this.program,F,He[F]);Xn&&Xn.setUniforms(this.program,bo,this.binderUniforms,wi,{zoom:qr});const Ro={[Do.POINTS]:1,[Do.LINES]:2,[Do.TRIANGLES]:3,[Do.LINE_STRIP]:1}[Le];this.checkUniforms(xt,"RENDER_SHADOWS",this.shadowUniforms);const zs=yo&&yo>0?1:void 0;for(const qe of bi.get()){const He=qe.vaos||(qe.vaos={});if((He[xt]||(He[xt]=new jo)).bind(bo,this,jt,Xn?Xn.getPaintVertexBuffers():[],Gt,qe.vertexOffset,Yn||[],zs),this.forceManualRenderingForInstanceIDShaders){const F=yo||1;for(let Oe=0;Oe<F;++Oe)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",Oe),Gt?Do.drawElements(Le,qe.primitiveLength*Ro,Do.UNSIGNED_SHORT,qe.primitiveOffset*Ro*2):Do.drawArrays(Le,qe.vertexOffset,qe.vertexLength)}else yo&&yo>1?Do.drawElementsInstanced(Le,qe.primitiveLength*Ro,Do.UNSIGNED_SHORT,qe.primitiveOffset*Ro*2,yo):Gt?Do.drawElements(Le,qe.primitiveLength*Ro,Do.UNSIGNED_SHORT,qe.primitiveOffset*Ro*2):Do.drawArrays(Le,qe.vertexOffset,qe.vertexLength);Le===Do.TRIANGLES&&Gt&&this._drawDebugWireframe(F,Oe,Fe,je,Gt,qe,wi,qr,Xn,yo)}}}function $s(Le,Oe){const Fe=Math.pow(2,Oe.tileID.overscaledZ),je=Oe.tileSize*Math.pow(2,Le.transform.tileZoom)/Fe,qe=je*(Oe.tileID.canonical.x+Oe.tileID.wrap*Fe),He=je*Oe.tileID.canonical.y;return{u_image:0,u_texsize:Oe.imageAtlasTexture?Oe.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/F.at(Oe,1,Le.transform.tileZoom),u_pixel_coord_upper:[qe>>16,He>>16],u_pixel_coord_lower:[65535&qe,65535&He]}}const op={terrain:0,flat:1},sp=F.ad.mat4.create(),Ys=(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro)=>{const zs=Oe.style.light,Zs=zs.properties.get("position"),na=[Zs.x,Zs.y,Zs.z],el=F.ad.mat3.create();"viewport"===zs.properties.get("anchor")&&(F.ad.mat3.fromRotation(el,-Oe.transform.angle),F.ad.vec3.transformMat3(na,na,el));const nl=zs.properties.get("color"),hl=Oe.transform,pl={u_matrix:Le,u_lightpos:na,u_lightintensity:zs.properties.get("intensity"),u_lightcolor:[nl.r,nl.g,nl.b],u_vertical_gradient:+Fe,u_opacity:je,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:sp,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:op[bi],u_base_type:op[wi],u_ao:qe,u_edge_radius:He,u_width_scale:xt,u_flood_light_color:yo,u_vertical_scale:bo,u_flood_light_intensity:Do,u_ground_shadow_factor:Ro};return"globe"===hl.projection.name&&(pl.u_tile_id=[jt.canonical.x,jt.canonical.y,1<<jt.canonical.z],pl.u_zoom_transition=qr,pl.u_inv_rot_matrix=Yn,pl.u_merc_center=Xn,pl.u_up_dir=hl.projection.upVector(new F.bT(0,0,0),Xn[0]*F.ai,Xn[1]*F.ai),pl.u_height_lift=Gt),pl},Js=(F,Le,Oe,Fe,je,qe)=>({u_matrix:F,u_edge_radius:Le,u_width_scale:Oe,u_vertical_scale:Fe,u_height_type:op[je],u_base_type:op[qe]}),Qs=(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do)=>{const Ro=Ys(Le,Oe,Fe,je,qe,He,xt,jt,bi,wi,qr,Xn,Yn,yo,bo,Do,1,[0,0,0]),zs={u_height_factor:-Math.pow(2,jt.overscaledZ)/Gt.tileSize/8};return F.l(Ro,$s(Oe,Gt),zs)},er=(F,Le)=>({u_matrix:F,u_emissive_strength:Le}),tr=(Le,Oe,Fe,je)=>F.l(er(Le,Oe),$s(Fe,je)),ir=(F,Le,Oe)=>({u_matrix:F,u_world:Oe,u_emissive_strength:Le}),or=(Le,Oe,Fe,je,qe)=>F.l(tr(Le,Oe,Fe,je),{u_world:qe}),sr=(F,Le,Oe,Fe,je)=>({u_matrix:F,u_camera_pos:[Le[0],Le[1],Le[2]],u_depth_bias:Oe,u_height_scale:Fe,u_reset_depth:je}),rr=(Le,Oe,Fe,je)=>{const qe=F.ai/Fe.tileSize;return{u_matrix:Le,u_camera_to_center_distance:Oe.getCameraToCenterDistance(je),u_extrude_scale:[Oe.pixelsToGLUnits[0]/qe,Oe.pixelsToGLUnits[1]/qe]}},nr=(F,Le,Oe=1)=>({u_matrix:F,u_color:Le.toRenderColor(null),u_overlay:0,u_overlay_scale:Oe}),ap=F.ad.mat4.create(),lr=(Le,Oe,Fe,je,qe,He,xt)=>{const jt=Le.transform,Gt="globe"===jt.projection.name,bi=Gt?F.cO(jt.zoom,Oe.canonical)*jt._pixelsPerMercatorPixel:F.at(Fe,1,He),wi={u_matrix:Oe.projMatrix,u_extrude_scale:bi,u_intensity:xt,u_inv_rot_matrix:ap,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(Gt){wi.u_inv_rot_matrix=je,wi.u_merc_center=qe,wi.u_tile_id=[Oe.canonical.x,Oe.canonical.y,1<<Oe.canonical.z],wi.u_zoom_transition=F.ag(jt.zoom);const Le=qe[0]*F.ai,Fe=qe[1]*F.ai;wi.u_up_dir=jt.projection.upVector(new F.bT(0,0,0),Le,Fe)}return wi};function cr(F,[Le,Oe,Fe,je],[qe,He]){if(qe===He)return[0,0,0,0];const xt=255*(F-1)/(F*(He-qe));return[Le*xt,Oe*xt,Fe*xt,je*xt]}function hr(F,Le,[Oe,Fe]){return Oe===Fe?0:.5/F+(Le-Oe)*(F-1)/(F*(Fe-Oe))}const dr=(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na)=>({u_matrix:Le,u_normalize_matrix:Oe,u_globe_matrix:Fe,u_merc_matrix:je,u_grid_matrix:qe,u_tl_parent:He,u_scale_parent:bi,u_fade_t:wi.mix,u_opacity:wi.opacity*qr.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:qr.paint.get("raster-brightness-min"),u_brightness_high:qr.paint.get("raster-brightness-max"),u_saturation_factor:F.cP(qr.paint.get("raster-saturation")),u_contrast_factor:F.cQ(qr.paint.get("raster-contrast")),u_spin_weights:ur(qr.paint.get("raster-hue-rotate")),u_perspective_transform:Xn,u_raster_elevation:Yn,u_zoom_transition:xt,u_merc_center:jt,u_cutoff_params:Gt,u_colorization_mix:cr(F.cR,bo,Ro),u_colorization_offset:hr(F.cR,Do,Ro),u_color_ramp:yo,u_texture_offset:[Zs/(zs+2*Zs),zs/(zs+2*Zs)],u_texture_res:[zs+2*Zs,zs+2*Zs],u_emissive_strength:na});function ur(F){F*=Math.PI/180;const Le=Math.sin(F),Oe=Math.cos(F);return[(2*Oe+1)/3,(-Math.sqrt(3)*Le-Oe+1)/3,(Math.sqrt(3)*Le-Oe+1)/3]}const yp=.05,pr=(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi)=>({u_matrix:F,u_normalize_matrix:Le,u_globe_matrix:Oe,u_merc_matrix:Fe,u_grid_matrix:je,u_tl_parent:qe,u_scale_parent:Gt,u_fade_t:bi.mix,u_opacity:bi.opacity,u_image0:0,u_image1:1,u_raster_elevation:wi,u_zoom_transition:He,u_merc_center:xt,u_cutoff_params:jt}),fr=(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt)=>({u_particle_texture:F,u_particle_texture_side_len:Le,u_tile_offset:Oe,u_velocity:Fe,u_color_ramp:qe,u_velocity_res:je,u_max_speed:He,u_uv_offset:xt,u_data_scale:[255*jt[0],255*jt[1]],u_data_offset:Gt,u_particle_pos_scale:1.1,u_particle_pos_offset:[yp,yp]}),mr=(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt)=>({u_particle_texture:F,u_particle_texture_side_len:Le,u_velocity:Oe,u_velocity_res:Fe,u_max_speed:je,u_speed_factor:qe,u_reset_rate:He,u_rand_seed:Math.random(),u_uv_offset:xt,u_data_scale:[255*jt[0],255*jt[1]],u_data_offset:Gt,u_particle_pos_scale:1.1,u_particle_pos_offset:[yp,yp]}),Tp=F.ad.mat4.create(),vr=(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs,Zs,na,el)=>{const nl=qe.transform,hl={u_is_size_zoom_constant:+("constant"===Le||"source"===Le),u_is_size_feature_constant:+("constant"===Le||"camera"===Le),u_size_t:Oe?Oe.uSizeT:0,u_size:Oe?Oe.uSize:0,u_camera_to_center_distance:nl.getCameraToCenterDistance(zs),u_rotate_symbol:+Fe,u_aspect_ratio:nl.width/nl.height,u_fade_change:qe.options.fadeDuration?qe.symbolFadeChange:1,u_matrix:He,u_label_plane_matrix:xt,u_coord_matrix:jt,u_is_text:+bi,u_elevation_from_sea:Gt?1:0,u_pitch_with_map:+je,u_texsize:wi,u_texsize_icon:qr,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Tp,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Tp,u_up_vector:[0,-1,0],u_color_adj_mat:Zs,u_icon_transition:na||0,u_gamma_scale:je?qe.transform.getCameraToCenterDistance(zs)*Math.cos(qe.terrain?0:qe.transform._pitch):1,u_device_pixel_ratio:F.q.devicePixelRatio,u_is_halo:+Xn,u_scale_factor:el||1};return"globe"===zs.name&&(hl.u_tile_id=[Yn.canonical.x,Yn.canonical.y,1<<Yn.canonical.z],hl.u_zoom_transition=yo,hl.u_inv_rot_matrix=Do,hl.u_merc_center=bo,hl.u_camera_forward=nl._camera.forward(),hl.u_ecef_origin=F.cS(nl.globeMatrix,Yn.toUnwrapped()),hl.u_tile_matrix=Float32Array.from(nl.globeMatrix),hl.u_up_vector=Ro),hl},yr=(F,Le,Oe,Fe)=>({u_matrix:F,u_emissive_strength:Le,u_opacity:Oe,u_color:Fe}),xr=(Le,Oe,Fe,je,qe,He,xt,jt,Gt)=>F.l(function(Le,Oe,Fe,je,qe,He){const{width:xt,height:jt}=je.imageManager.getPixelSize(Oe),Gt=Math.pow(2,He.tileID.overscaledZ),bi=He.tileSize*Math.pow(2,je.transform.tileZoom)/Gt,wi=bi*(He.tileID.canonical.x+He.tileID.wrap*Gt),qr=bi*He.tileID.canonical.y;return{u_image:0,u_pattern_tl:Fe.tl,u_pattern_br:Fe.br,u_texsize:[xt,jt],u_pattern_size:Fe.displaySize,u_pattern_units_to_pixels:qe?[je.transform.width,-1*je.transform.height]:[1/F.at(He,1,je.transform.tileZoom),1/F.at(He,1,je.transform.tileZoom)],u_pixel_coord_upper:[wi>>16,qr>>16],u_pixel_coord_lower:[65535&wi,65535&qr]}}(0,He,xt,je,jt,Gt),{u_matrix:Le,u_emissive_strength:Oe,u_opacity:Fe}),Dp=new Float32Array(F.ad.mat4.identity([])),wr=(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn=[0,0,0],yo)=>{const bo=qe.style.light,Do=bo.properties.get("position"),Ro=[-Do.x,-Do.y,Do.z],zs=F.ad.mat3.create();"viewport"===bo.properties.get("anchor")&&(F.ad.mat3.fromRotation(zs,-qe.transform.angle),F.ad.vec3.transformMat3(Ro,Ro,zs));const Zs="MASK"===wi.alphaMode,na=bo.properties.get("color").toRenderColor(null),el=Xn.paint.get("model-ambient-occlusion-intensity"),nl=Xn.paint.get("model-color").constantOr(F.al.white).toRenderColor(null),hl=Xn.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:Le,u_lighting_matrix:Oe,u_normal_matrix:Fe,u_node_matrix:je||Dp,u_lightpos:Ro,u_lightintensity:bo.properties.get("intensity"),u_lightcolor:[na.r,na.g,na.b],u_camera_pos:Yn,u_opacity:He,u_baseTextureIsAlpha:0,u_alphaMask:+Zs,u_alphaCutoff:wi.alphaCutoff,u_baseColorFactor:[xt.r,xt.g,xt.b,xt.a],u_emissiveFactor:[jt[0],jt[1],jt[2],1],u_metallicFactor:Gt,u_roughnessFactor:bi,u_baseColorTexture:Uh.BaseColor,u_metallicRoughnessTexture:Uh.MetallicRoughness,u_normalTexture:Uh.Normal,u_occlusionTexture:Uh.Occlusion,u_emissionTexture:Uh.Emission,u_lutTexture:Uh.LUT,u_color_mix:[nl.r,nl.g,nl.b,hl],u_aoIntensity:el,u_emissive_strength:qr,u_occlusionTextureTransform:yo||[0,0,0,0]}},Tr=(F,Le=Dp,Oe=Dp)=>({u_matrix:F,u_instance:Le,u_node_matrix:Oe}),Rp={fillExtrusion:Le=>({u_matrix:new F.bJ(Le),u_lightpos:new F.bL(Le),u_lightintensity:new F.bM(Le),u_lightcolor:new F.bL(Le),u_vertical_gradient:new F.bM(Le),u_opacity:new F.bM(Le),u_edge_radius:new F.bM(Le),u_width_scale:new F.bM(Le),u_ao:new F.bK(Le),u_height_type:new F.bN(Le),u_base_type:new F.bN(Le),u_tile_id:new F.bL(Le),u_zoom_transition:new F.bM(Le),u_inv_rot_matrix:new F.bJ(Le),u_merc_center:new F.bK(Le),u_up_dir:new F.bL(Le),u_height_lift:new F.bM(Le),u_flood_light_color:new F.bL(Le),u_vertical_scale:new F.bM(Le),u_flood_light_intensity:new F.bM(Le),u_ground_shadow_factor:new F.bL(Le)}),fillExtrusionDepth:Le=>({u_matrix:new F.bJ(Le),u_edge_radius:new F.bM(Le),u_width_scale:new F.bM(Le),u_vertical_scale:new F.bM(Le),u_height_type:new F.bN(Le),u_base_type:new F.bN(Le)}),fillExtrusionPattern:Le=>({u_matrix:new F.bJ(Le),u_lightpos:new F.bL(Le),u_lightintensity:new F.bM(Le),u_lightcolor:new F.bL(Le),u_vertical_gradient:new F.bM(Le),u_height_factor:new F.bM(Le),u_edge_radius:new F.bM(Le),u_width_scale:new F.bM(Le),u_ao:new F.bK(Le),u_height_type:new F.bN(Le),u_base_type:new F.bN(Le),u_tile_id:new F.bL(Le),u_zoom_transition:new F.bM(Le),u_inv_rot_matrix:new F.bJ(Le),u_merc_center:new F.bK(Le),u_up_dir:new F.bL(Le),u_height_lift:new F.bM(Le),u_image:new F.bN(Le),u_texsize:new F.bK(Le),u_pixel_coord_upper:new F.bK(Le),u_pixel_coord_lower:new F.bK(Le),u_tile_units_to_pixels:new F.bM(Le),u_opacity:new F.bM(Le)}),fillExtrusionGroundEffect:Le=>({u_matrix:new F.bJ(Le),u_opacity:new F.bM(Le),u_ao_pass:new F.bM(Le),u_meter_to_tile:new F.bM(Le),u_ao:new F.bK(Le),u_flood_light_intensity:new F.bM(Le),u_flood_light_color:new F.bL(Le),u_attenuation:new F.bM(Le),u_edge_radius:new F.bM(Le),u_fb:new F.bN(Le),u_fb_size:new F.bM(Le),u_dynamic_offset:new F.bM(Le)}),fill:Le=>({u_matrix:new F.bJ(Le),u_emissive_strength:new F.bM(Le)}),fillPattern:Le=>({u_matrix:new F.bJ(Le),u_emissive_strength:new F.bM(Le),u_image:new F.bN(Le),u_texsize:new F.bK(Le),u_pixel_coord_upper:new F.bK(Le),u_pixel_coord_lower:new F.bK(Le),u_tile_units_to_pixels:new F.bM(Le)}),fillOutline:Le=>({u_matrix:new F.bJ(Le),u_emissive_strength:new F.bM(Le),u_world:new F.bK(Le)}),fillOutlinePattern:Le=>({u_matrix:new F.bJ(Le),u_emissive_strength:new F.bM(Le),u_world:new F.bK(Le),u_image:new F.bN(Le),u_texsize:new F.bK(Le),u_pixel_coord_upper:new F.bK(Le),u_pixel_coord_lower:new F.bK(Le),u_tile_units_to_pixels:new F.bM(Le)}),elevatedStructures:Le=>({u_matrix:new F.bJ(Le)}),elevatedStructuresDepthReconstruct:Le=>({u_matrix:new F.bJ(Le),u_camera_pos:new F.bL(Le),u_depth_bias:new F.bM(Le),u_height_scale:new F.bM(Le),u_reset_depth:new F.bM(Le)}),circle:F.cT,collisionBox:Le=>({u_matrix:new F.bJ(Le),u_camera_to_center_distance:new F.bM(Le),u_extrude_scale:new F.bK(Le)}),collisionCircle:Le=>({u_matrix:new F.bJ(Le),u_inv_matrix:new F.bJ(Le),u_camera_to_center_distance:new F.bM(Le),u_viewport_size:new F.bK(Le)}),debug:Le=>({u_color:new F.cA(Le),u_matrix:new F.bJ(Le),u_overlay:new F.bN(Le),u_overlay_scale:new F.bM(Le)}),clippingMask:Le=>({u_matrix:new F.bJ(Le)}),heatmap:Le=>({u_extrude_scale:new F.bM(Le),u_intensity:new F.bM(Le),u_matrix:new F.bJ(Le),u_inv_rot_matrix:new F.bJ(Le),u_merc_center:new F.bK(Le),u_tile_id:new F.bL(Le),u_zoom_transition:new F.bM(Le),u_up_dir:new F.bL(Le)}),heatmapTexture:Le=>({u_image:new F.bN(Le),u_color_ramp:new F.bN(Le),u_opacity:new F.bM(Le)}),hillshade:Le=>({u_matrix:new F.bJ(Le),u_image:new F.bN(Le),u_latrange:new F.bK(Le),u_light:new F.bK(Le),u_shadow:new F.cA(Le),u_highlight:new F.cA(Le),u_emissive_strength:new F.bM(Le),u_accent:new F.cA(Le)}),hillshadePrepare:Le=>({u_matrix:new F.bJ(Le),u_image:new F.bN(Le),u_dimension:new F.bK(Le),u_zoom:new F.bM(Le)}),line:F.cU,linePattern:F.cV,raster:Le=>({u_matrix:new F.bJ(Le),u_normalize_matrix:new F.bJ(Le),u_globe_matrix:new F.bJ(Le),u_merc_matrix:new F.bJ(Le),u_grid_matrix:new F.cB(Le),u_tl_parent:new F.bK(Le),u_scale_parent:new F.bM(Le),u_fade_t:new F.bM(Le),u_opacity:new F.bM(Le),u_image0:new F.bN(Le),u_image1:new F.bN(Le),u_brightness_low:new F.bM(Le),u_brightness_high:new F.bM(Le),u_saturation_factor:new F.bM(Le),u_contrast_factor:new F.bM(Le),u_spin_weights:new F.bL(Le),u_perspective_transform:new F.bK(Le),u_raster_elevation:new F.bM(Le),u_zoom_transition:new F.bM(Le),u_merc_center:new F.bK(Le),u_cutoff_params:new F.cb(Le),u_colorization_mix:new F.cb(Le),u_colorization_offset:new F.bM(Le),u_color_ramp:new F.bN(Le),u_texture_offset:new F.bK(Le),u_texture_res:new F.bK(Le),u_emissive_strength:new F.bM(Le)}),rasterParticle:Le=>({u_matrix:new F.bJ(Le),u_normalize_matrix:new F.bJ(Le),u_globe_matrix:new F.bJ(Le),u_merc_matrix:new F.bJ(Le),u_grid_matrix:new F.cB(Le),u_tl_parent:new F.bK(Le),u_scale_parent:new F.bM(Le),u_fade_t:new F.bM(Le),u_opacity:new F.bM(Le),u_image0:new F.bN(Le),u_image1:new F.bN(Le),u_raster_elevation:new F.bM(Le),u_zoom_transition:new F.bM(Le),u_merc_center:new F.bK(Le),u_cutoff_params:new F.cb(Le)}),rasterParticleTexture:Le=>({u_texture:new F.bN(Le),u_opacity:new F.bM(Le)}),rasterParticleDraw:Le=>({u_particle_texture:new F.bN(Le),u_particle_texture_side_len:new F.bM(Le),u_tile_offset:new F.bK(Le),u_velocity:new F.bN(Le),u_color_ramp:new F.bN(Le),u_velocity_res:new F.bK(Le),u_max_speed:new F.bM(Le),u_uv_offset:new F.bK(Le),u_data_scale:new F.bK(Le),u_data_offset:new F.bM(Le),u_particle_pos_scale:new F.bM(Le),u_particle_pos_offset:new F.bK(Le)}),rasterParticleUpdate:Le=>({u_particle_texture:new F.bN(Le),u_particle_texture_side_len:new F.bM(Le),u_velocity:new F.bN(Le),u_velocity_res:new F.bK(Le),u_max_speed:new F.bM(Le),u_speed_factor:new F.bM(Le),u_reset_rate:new F.bM(Le),u_rand_seed:new F.bM(Le),u_uv_offset:new F.bK(Le),u_data_scale:new F.bK(Le),u_data_offset:new F.bM(Le),u_particle_pos_scale:new F.bM(Le),u_particle_pos_offset:new F.bK(Le)}),symbol:Le=>({u_is_size_zoom_constant:new F.bN(Le),u_is_size_feature_constant:new F.bN(Le),u_size_t:new F.bM(Le),u_size:new F.bM(Le),u_camera_to_center_distance:new F.bM(Le),u_rotate_symbol:new F.bN(Le),u_aspect_ratio:new F.bM(Le),u_fade_change:new F.bM(Le),u_matrix:new F.bJ(Le),u_label_plane_matrix:new F.bJ(Le),u_coord_matrix:new F.bJ(Le),u_is_text:new F.bN(Le),u_elevation_from_sea:new F.bN(Le),u_pitch_with_map:new F.bN(Le),u_texsize:new F.bK(Le),u_texsize_icon:new F.bK(Le),u_texture:new F.bN(Le),u_texture_icon:new F.bN(Le),u_gamma_scale:new F.bM(Le),u_device_pixel_ratio:new F.bM(Le),u_tile_id:new F.bL(Le),u_zoom_transition:new F.bM(Le),u_inv_rot_matrix:new F.bJ(Le),u_merc_center:new F.bK(Le),u_camera_forward:new F.bL(Le),u_tile_matrix:new F.bJ(Le),u_up_vector:new F.bL(Le),u_ecef_origin:new F.bL(Le),u_is_halo:new F.bN(Le),u_icon_transition:new F.bM(Le),u_color_adj_mat:new F.bJ(Le),u_scale_factor:new F.bM(Le)}),background:Le=>({u_matrix:new F.bJ(Le),u_emissive_strength:new F.bM(Le),u_opacity:new F.bM(Le),u_color:new F.cA(Le)}),backgroundPattern:Le=>({u_matrix:new F.bJ(Le),u_emissive_strength:new F.bM(Le),u_opacity:new F.bM(Le),u_image:new F.bN(Le),u_pattern_tl:new F.bK(Le),u_pattern_br:new F.bK(Le),u_texsize:new F.bK(Le),u_pattern_size:new F.bK(Le),u_pixel_coord_upper:new F.bK(Le),u_pixel_coord_lower:new F.bK(Le),u_pattern_units_to_pixels:new F.bK(Le)}),terrainRaster:Le=>({u_matrix:new F.bJ(Le),u_image0:new F.bN(Le),u_skirt_height:new F.bM(Le),u_ground_shadow_factor:new F.bL(Le)}),skybox:Le=>({u_matrix:new F.bJ(Le),u_sun_direction:new F.bL(Le),u_cubemap:new F.bN(Le),u_opacity:new F.bM(Le),u_temporal_offset:new F.bM(Le)}),skyboxGradient:Le=>({u_matrix:new F.bJ(Le),u_color_ramp:new F.bN(Le),u_center_direction:new F.bL(Le),u_radius:new F.bM(Le),u_opacity:new F.bM(Le),u_temporal_offset:new F.bM(Le)}),skyboxCapture:Le=>({u_matrix_3f:new F.cB(Le),u_sun_direction:new F.bL(Le),u_sun_intensity:new F.bM(Le),u_color_tint_r:new F.cb(Le),u_color_tint_m:new F.cb(Le),u_luminance:new F.bM(Le)}),globeRaster:Le=>({u_proj_matrix:new F.bJ(Le),u_globe_matrix:new F.bJ(Le),u_normalize_matrix:new F.bJ(Le),u_merc_matrix:new F.bJ(Le),u_zoom_transition:new F.bM(Le),u_merc_center:new F.bK(Le),u_image0:new F.bN(Le),u_grid_matrix:new F.cB(Le),u_skirt_height:new F.bM(Le),u_far_z_cutoff:new F.bM(Le),u_frustum_tl:new F.bL(Le),u_frustum_tr:new F.bL(Le),u_frustum_br:new F.bL(Le),u_frustum_bl:new F.bL(Le),u_globe_pos:new F.bL(Le),u_globe_radius:new F.bM(Le),u_viewport:new F.bK(Le)}),globeAtmosphere:Le=>({u_frustum_tl:new F.bL(Le),u_frustum_tr:new F.bL(Le),u_frustum_br:new F.bL(Le),u_frustum_bl:new F.bL(Le),u_horizon:new F.bM(Le),u_transition:new F.bM(Le),u_fadeout_range:new F.bM(Le),u_color:new F.cb(Le),u_high_color:new F.cb(Le),u_space_color:new F.cb(Le),u_temporal_offset:new F.bM(Le),u_horizon_angle:new F.bM(Le)}),model:Le=>({u_matrix:new F.bJ(Le),u_lighting_matrix:new F.bJ(Le),u_normal_matrix:new F.bJ(Le),u_node_matrix:new F.bJ(Le),u_lightpos:new F.bL(Le),u_lightintensity:new F.bM(Le),u_lightcolor:new F.bL(Le),u_camera_pos:new F.bL(Le),u_opacity:new F.bM(Le),u_baseColorFactor:new F.cb(Le),u_emissiveFactor:new F.cb(Le),u_metallicFactor:new F.bM(Le),u_roughnessFactor:new F.bM(Le),u_baseTextureIsAlpha:new F.bN(Le),u_alphaMask:new F.bN(Le),u_alphaCutoff:new F.bM(Le),u_baseColorTexture:new F.bN(Le),u_metallicRoughnessTexture:new F.bN(Le),u_normalTexture:new F.bN(Le),u_occlusionTexture:new F.bN(Le),u_emissionTexture:new F.bN(Le),u_lutTexture:new F.bN(Le),u_color_mix:new F.cb(Le),u_aoIntensity:new F.bM(Le),u_emissive_strength:new F.bM(Le),u_occlusionTextureTransform:new F.cb(Le)}),modelDepth:Le=>({u_matrix:new F.bJ(Le),u_instance:new F.bJ(Le),u_node_matrix:new F.bJ(Le)}),groundShadow:Le=>({u_matrix:new F.bJ(Le),u_ground_shadow_factor:new F.bL(Le)}),stars:Le=>({u_matrix:new F.bJ(Le),u_up:new F.bL(Le),u_right:new F.bL(Le),u_intensity_multiplier:new F.bM(Le)}),snowParticle:Le=>({u_modelview:new F.bJ(Le),u_projection:new F.bJ(Le),u_time:new F.bM(Le),u_cam_pos:new F.bL(Le),u_velocityConeAperture:new F.bM(Le),u_velocity:new F.bM(Le),u_horizontalOscillationRadius:new F.bM(Le),u_horizontalOscillationRate:new F.bM(Le),u_boxSize:new F.bM(Le),u_billboardSize:new F.bM(Le),u_simpleShapeParameters:new F.bK(Le),u_screenSize:new F.bK(Le),u_thinningCenterPos:new F.bK(Le),u_thinningShape:new F.bL(Le),u_thinningAffectedRatio:new F.bM(Le),u_thinningParticleOffset:new F.bM(Le),u_particleColor:new F.cb(Le),u_direction:new F.bL(Le)}),rainParticle:Le=>({u_modelview:new F.bJ(Le),u_projection:new F.bJ(Le),u_time:new F.bM(Le),u_cam_pos:new F.bL(Le),u_texScreen:new F.bN(Le),u_velocityConeAperture:new F.bM(Le),u_velocity:new F.bM(Le),u_boxSize:new F.bM(Le),u_rainDropletSize:new F.bK(Le),u_distortionStrength:new F.bM(Le),u_rainDirection:new F.bL(Le),u_color:new F.cb(Le),u_screenSize:new F.bK(Le),u_thinningCenterPos:new F.bK(Le),u_thinningShape:new F.bL(Le),u_thinningAffectedRatio:new F.bM(Le),u_thinningParticleOffset:new F.bM(Le),u_shapeDirectionalPower:new F.bM(Le),u_shapeNormalPower:new F.bM(Le),u_mode:new F.bM(Le)}),vignette:Le=>({u_vignetteShape:new F.bL(Le),u_vignetteColor:new F.cb(Le)}),occlusion:Le=>({u_matrix:new F.bJ(Le),u_anchorPos:new F.bL(Le),u_screenSizePx:new F.bK(Le),u_occluderSizePx:new F.bK(Le),u_color:new F.cb(Le)})};class Sr{constructor(F,Le,Oe,Fe){this.id=Sr.uniqueIdxCounter,Sr.uniqueIdxCounter++,this.context=F;const je=F.gl;this.buffer=je.createBuffer(),this.dynamicDraw=Boolean(Oe),this.context.unbindVAO(),F.bindElementBuffer.set(this.buffer),je.bufferData(je.ELEMENT_ARRAY_BUFFER,Le.arrayBuffer,this.dynamicDraw?je.DYNAMIC_DRAW:je.STATIC_DRAW),this.dynamicDraw||Fe||Le.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(F){this.id=Sr.uniqueIdxCounter,Sr.uniqueIdxCounter++;const Le=this.context.gl;this.context.unbindVAO(),this.bind(),Le.bufferSubData(Le.ELEMENT_ARRAY_BUFFER,0,F.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}Sr.uniqueIdxCounter=0;const Lp={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ir{constructor(F,Le,Oe,Fe,je,qe){this.length=Le.length,this.attributes=Oe,this.itemSize=Le.bytesPerElement,this.dynamicDraw=Fe,this.instanceCount=qe,this.context=F;const He=F.gl;this.buffer=He.createBuffer(),F.bindVertexBuffer.set(this.buffer),He.bufferData(He.ARRAY_BUFFER,Le.arrayBuffer,this.dynamicDraw?He.DYNAMIC_DRAW:He.STATIC_DRAW),this.dynamicDraw||je||Le.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(F){const Le=this.context.gl;this.bind(),Le.bufferSubData(Le.ARRAY_BUFFER,0,F.arrayBuffer)}enableAttributes(F,Le){for(let Oe=0;Oe<this.attributes.length;Oe++){const Fe=Le.attributes[this.attributes[Oe].name];void 0!==Fe&&F.enableVertexAttribArray(Fe)}}setVertexAttribPointers(F,Le,Oe){for(let Fe=0;Fe<this.attributes.length;Fe++){const je=this.attributes[Fe],qe=Le.attributes[je.name];void 0!==qe&&F.vertexAttribPointer(qe,je.components,F[Lp[je.type]],!1,this.itemSize,je.offset+this.itemSize*(Oe||0))}}setVertexAttribDivisor(F,Le,Oe){for(let Fe=0;Fe<this.attributes.length;Fe++){const je=Le.attributes[this.attributes[Fe].name];void 0!==je&&this.instanceCount&&this.instanceCount>0&&F.vertexAttribDivisor(je,Oe)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Rr{constructor(F,Le,Oe,Fe,je){this.context=F,this.width=Le,this.height=Oe;const qe=this.framebuffer=F.gl.createFramebuffer();Fe&&(this.colorAttachment=new Is(F,qe)),je&&(this.depthAttachmentType=je,this.depthAttachment="renderbuffer"===je?new Rs(F,qe):new Ds(F,qe))}destroy(){const F=this.context.gl;if(this.colorAttachment){const Le=this.colorAttachment.get();Le&&F.deleteTexture(Le)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const Le=this.depthAttachment.get();Le&&F.deleteRenderbuffer(Le)}else{const Le=this.depthAttachment.get();Le&&F.deleteTexture(Le)}F.deleteFramebuffer(this.framebuffer)}}class Dr{constructor(F,Le){this.gl=F,this.clearColor=new Xo(this),this.clearDepth=new Ko(this),this.clearStencil=new Yo(this),this.colorMask=new Jo(this),this.depthMask=new Qo(this),this.stencilMask=new es(this),this.stencilFunc=new ts(this),this.stencilOp=new is(this),this.stencilTest=new os(this),this.depthRange=new ss(this),this.depthTest=new rs(this),this.depthFunc=new ns(this),this.blend=new as(this),this.blendFunc=new ls(this),this.blendColor=new cs(this),this.blendEquation=new hs(this),this.cullFace=new ds(this),this.cullFaceSide=new us(this),this.frontFace=new _s(this),this.program=new Qd(this),this.activeTexture=new fs(this),this.viewport=new ms(this),this.bindFramebuffer=new gs(this),this.bindRenderbuffer=new vs(this),this.bindTexture=new ys(this),this.bindVertexBuffer=new xs(this),this.bindElementBuffer=new bs(this),this.bindVertexArrayOES=new ws(this),this.pixelStoreUnpack=new Ts(this),this.pixelStoreUnpackPremultiplyAlpha=new Es(this),this.pixelStoreUnpackFlipY=new Ss(this),this.options=Le?Object.assign({},Le):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=F.getExtension("EXT_texture_filter_anisotropic")||F.getExtension("MOZ_EXT_texture_filter_anisotropic")||F.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=F.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=F.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=F.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=F.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=Le&&!!Le.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=F.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=F.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=F.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=F.getParameter(F.MAX_TEXTURE_SIZE),this.maxPointSize=F.getParameter(F.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(F,Le,Oe){return new Sr(this,F,Le,Oe)}createVertexBuffer(F,Le,Oe,Fe,je){return new Ir(this,F,Le,Oe,Fe,je)}createRenderbuffer(F,Le,Oe){const Fe=this.gl,je=Fe.createRenderbuffer();return this.bindRenderbuffer.set(je),Fe.renderbufferStorage(Fe.RENDERBUFFER,F,Le,Oe),this.bindRenderbuffer.set(null),je}createFramebuffer(F,Le,Oe,Fe){return new Rr(this,F,Le,Oe,Fe)}clear({color:F,depth:Le,stencil:Oe,colorMask:Fe}){const je=this.gl;let qe=0;F&&(qe|=je.COLOR_BUFFER_BIT,this.clearColor.set(F),this.colorMask.set(Fe||[!0,!0,!0,!0])),void 0!==Le&&(qe|=je.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(Le),this.depthMask.set(!0)),void 0!==Oe&&(qe|=je.STENCIL_BUFFER_BIT,this.clearStencil.set(Oe),this.stencilMask.set(255)),je.clear(qe)}setCullFace(F){!1===F.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(F.mode),this.frontFace.set(F.frontFace))}setDepthMode(F){F.func!==this.gl.ALWAYS||F.mask?(this.depthTest.set(!0),this.depthFunc.set(F.func),this.depthMask.set(F.mask),this.depthRange.set(F.range)):this.depthTest.set(!1)}setStencilMode(F){F.test.func!==this.gl.ALWAYS||F.mask?(this.stencilTest.set(!0),this.stencilMask.set(F.mask),this.stencilOp.set([F.fail,F.depthFail,F.pass]),this.stencilFunc.set({func:F.test.func,ref:F.ref,mask:F.test.mask})):this.stencilTest.set(!1)}setColorMode(Le){F.bn(Le.blendFunction,ki.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(Le.blendFunction),this.blendColor.set(Le.blendColor),Le.blendEquation?this.blendEquation.set(Le.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(Le.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Op;function Lr(Le,Oe,Fe,je,qe,He,xt){const jt=Le.context,Gt=jt.gl,bi=Le.transform,wi=Le.getOrCreateProgram("collisionBox"),qr=[];let Xn=0,Yn=0;for(let jt=0;jt<je.length;jt++){const yo=je[jt],bo=Oe.getTile(yo),Do=bo.getBucket(Fe);if(!Do)continue;const Ro=li(yo,Do,bi);let zs=Ro;0===qe[0]&&0===qe[1]||(zs=Le.translatePosMatrix(Ro,bo,qe,He));const Zs=xt?Do.textCollisionBox:Do.iconCollisionBox,na=Do.collisionCircleArray;if(na.length>0){const Le=F.ad.mat4.create(),Oe=zs;F.ad.mat4.mul(Le,Do.placementInvProjMatrix,bi.glCoordMatrix),F.ad.mat4.mul(Le,Le,Do.placementViewportMatrix),qr.push({circleArray:na,circleOffset:Yn,transform:Oe,invTransform:Le,projection:Do.getProjection()}),Xn+=na.length/4,Yn=Xn}Zs&&(Le.terrain&&Le.terrain.setupElevationDraw(bo,wi),wi.draw(Le,Gt.LINES,Bi.disabled,Ui.disabled,Le.colorModeForRenderPass(),ji.disabled,rr(zs,bi,bo,Do.getProjection()),Fe.id,Zs.layoutVertexBuffer,Zs.indexBuffer,Zs.segments,null,bi.zoom,null,[Zs.collisionVertexBuffer,Zs.collisionVertexBufferExt]))}if(!xt||!qr.length)return;const yo=Le.getOrCreateProgram("collisionCircle"),bo=new F.cW;bo.resize(4*Xn),bo._trim();let Do=0;for(const F of qr)for(let Le=0;Le<F.circleArray.length/4;Le++){const Oe=4*Le,Fe=F.circleArray[Oe+0],je=F.circleArray[Oe+1],qe=F.circleArray[Oe+2],He=F.circleArray[Oe+3];bo.emplace(Do++,Fe,je,qe,He,0),bo.emplace(Do++,Fe,je,qe,He,1),bo.emplace(Do++,Fe,je,qe,He,2),bo.emplace(Do++,Fe,je,qe,He,3)}(!Op||Op.length<2*Xn)&&(Op=function(Le){const Oe=2*Le,Fe=new F.aV;Fe.resize(Oe),Fe._trim();for(let F=0;F<Oe;F++){const Le=6*F;Fe.uint16[Le+0]=4*F+0,Fe.uint16[Le+1]=4*F+1,Fe.uint16[Le+2]=4*F+2,Fe.uint16[Le+3]=4*F+2,Fe.uint16[Le+4]=4*F+3,Fe.uint16[Le+5]=4*F+0}return Fe}(Xn));const Ro=jt.createIndexBuffer(Op,!0),zs=jt.createVertexBuffer(bo,F.cX.members,!0);for(const Oe of qr){const je={u_matrix:Oe.transform,u_inv_matrix:Oe.invTransform,u_camera_to_center_distance:(Zs=bi).getCameraToCenterDistance(Oe.projection),u_viewport_size:[Zs.width,Zs.height]};yo.draw(Le,Gt.TRIANGLES,Bi.disabled,Ui.disabled,Le.colorModeForRenderPass(),ji.disabled,je,Fe.id,zs,Ro,F.b8.simpleSegment(0,2*Oe.circleOffset,Oe.circleArray.length,Oe.circleArray.length/2),null,bi.zoom)}var Zs;zs.destroy(),Ro.destroy()}const kp=F.ad.mat4.create();function Pr(Le){const Oe=Le._camera.getWorldToCamera(Le.worldSize,1),Fe=F.ad.mat4.multiply([],Oe,Le.globeMatrix);F.ad.mat4.invert(Fe,Fe);const je=[0,0,0],qe=[0,1,0,0];return F.ad.vec4.transformMat4(qe,qe,Fe),je[0]=qe[0],je[1]=qe[1],je[2]=qe[2],F.ad.vec3.normalize(je,je),je}function zr({width:Le,height:Oe,anchor:Fe,textOffset:je,textScale:qe},He){const{horizontalAlign:xt,verticalAlign:jt}=F.bD(Fe),Gt=-(xt-.5)*Le,bi=-(jt-.5)*Oe,wi=F.bC(Fe,je);return new F.P((Gt/qe+wi[0])*He,(bi/qe+wi[1])*He)}function Or(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi){const qr=Le.text.placedSymbolArray,Xn=Le.text.dynamicLayoutVertexArray,Yn=Le.icon.dynamicLayoutVertexArray,yo={},bo=Le.getProjection(),Do=ci(jt,bo,He),Ro=He.elevation,zs=bo.upVectorScale(jt.canonical,He.center.lat,He.worldSize).metersToTile;Xn.clear();for(let Yn=0;Yn<qr.length;Yn++){const Zs=qr.get(Yn),{tileAnchorX:na,tileAnchorY:el,numGlyphs:nl}=Zs,hl=Zs.hidden||!Zs.crossTileID||Le.allowVerticalPlacement&&!Zs.placedOrientation?null:je[Zs.crossTileID];if(hl){let je=0,qr=0,Yn=0;if(Ro){const F=Ro?Ro.getAtTileOffset(jt,na,el):0,[Le,Oe,Fe]=bo.upVector(jt.canonical,na,el);je=F*Le*zs,qr=F*Oe*zs,Yn=F*Fe*zs}let[pl,bl,Tl,kl]=Wt(Zs.projectedAnchorX+je,Zs.projectedAnchorY+qr,Zs.projectedAnchorZ+Yn,Fe?Do:xt);const ec=$t(He.getCameraToCenterDistance(bo),kl);let tc=qe.evaluateSizeForFeature(Le.textSizeData,bi,Zs)*ec/F.bw;Fe&&(tc*=Le.tilePixelRatio/Gt);const ic=zr(hl,tc);Fe?(({x:pl,y:bl,z:Tl}=bo.projectTilePoint(na+ic.x,el+ic.y,jt.canonical)),[pl,bl,Tl]=Wt(pl+je,bl+qr,Tl+Yn,xt)):(Oe&&ic._rotate(-He.angle),pl+=ic.x,bl+=ic.y,Tl=0);const oc=Le.allowVerticalPlacement&&Zs.placedOrientation===F.bq.vertical?Math.PI/2:0;for(let Le=0;Le<nl;Le++)F.bt(Xn,pl,bl,Tl,oc);wi&&Zs.associatedIconIndex>=0&&(yo[Zs.associatedIconIndex]={x:pl,y:bl,z:Tl,angle:oc})}else oi(nl,Xn)}if(wi){Yn.clear();const Oe=Le.icon.placedSymbolArray;for(let Le=0;Le<Oe.length;Le++){const Fe=Oe.get(Le),{numGlyphs:je}=Fe,qe=yo[Le];if(Fe.hidden||!qe)oi(je,Yn);else{const{x:Le,y:Oe,z:Fe,angle:He}=qe;for(let qe=0;qe<je;qe++)F.bt(Yn,Le,Oe,Fe,He)}}Le.icon.dynamicLayoutVertexBuffer.updateData(Yn)}Le.text.dynamicLayoutVertexBuffer.updateData(Xn)}function Fr(Le,Oe,Fe,je,qe,He,xt={}){const jt=Fe.paint.get("icon-translate"),Gt=Fe.paint.get("text-translate"),bi=Fe.paint.get("icon-translate-anchor"),wi=Fe.paint.get("text-translate-anchor"),qr=Fe.layout.get("icon-rotation-alignment"),Xn=Fe.layout.get("text-rotation-alignment"),Yn=Fe.layout.get("icon-pitch-alignment"),yo=Fe.layout.get("text-pitch-alignment"),bo=Fe.layout.get("icon-keep-upright"),Do=Fe.layout.get("text-keep-upright"),Ro=Fe.paint.get("icon-color-saturation"),zs=Fe.paint.get("icon-color-contrast"),Zs=Fe.paint.get("icon-color-brightness-min"),na=Fe.paint.get("icon-color-brightness-max"),el="sea"===Fe.layout.get("symbol-elevation-reference"),nl=Le.context,hl=nl.gl,pl=Le.transform,bl="map"===qr,Tl="map"===Xn,kl="map"===Yn,ec="map"===yo,tc=void 0!==Fe.layout.get("symbol-sort-key").constantOr(1);let ic=!1;const oc=Le.depthModeForSublayer(0,Bi.ReadOnly),sc=[F.av(pl.center.lng),F.aC(pl.center.lat)],ac=Fe.layout.get("text-variable-anchor"),mc="globe"===pl.projection.name,gc=[],yc=[0,-1,0];for(const qe of je){const je=Oe.getTile(qe),He=je.getBucket(Fe);if(!He)continue;if("mercator"===He.projection.name&&mc)continue;if(He.fullyClipped)continue;const qr="globe"===He.projection.name,Xn=qr?F.ag(pl.zoom):0,Yn=ci(qe,He.getProjection(),pl),yo=pl.calculatePixelsToTileUnitsMatrix(je),nl=ac&&He.hasTextData(),oc=He.hasIconTextFit()&&nl&&He.hasIconData(),xc=He.getProjection().createInversionMatrix(pl,qe.canonical),N=F=>{pl.depthOcclusionForSymbolsAndCircles&&(Fe.hasInitialOcclusionOpacityProperties||Le.terrain)&&(F.push("DEPTH_D24"),F.push("DEPTH_OCCLUSION"))},U=()=>{const Oe=bl&&"point"!==Fe.layout.get("symbol-placement"),xt=[];N(xt);const Gt=Oe||oc,wi=Fe.paint.get("icon-image-cross-fade").constantOr(0);Le.terrainRenderModeElevated()&&kl&&xt.push("PITCH_WITH_MAP_TERRAIN"),qr&&(xt.push("PROJECTION_GLOBE_VIEW"),Gt&&xt.push("PROJECTED_POS_ON_VIEWPORT")),wi>0&&xt.push("ICON_TRANSITION"),He.icon.zOffsetVertexBuffer&&xt.push("Z_OFFSET"),0===Ro&&0===zs&&0===Zs&&1===na||xt.push("COLOR_ADJUSTMENT"),He.sdfIcons&&xt.push("RENDER_SDF");const Do=He.icon.programConfigurations.get(Fe.id),nl=Le.getOrCreateProgram("symbol",{config:Do,defines:xt}),Tl=je.imageAtlasTexture?je.imageAtlasTexture.size:[0,0],ec=He.iconSizeData,tc=F.bp(ec,pl.zoom),ic=kl||0!==pl.pitch,ac=qt(Yn,je.tileID.canonical,kl,bl,pl,He.getProjection(),yo),gc=Zt(Yn,je.tileID.canonical,kl,bl,pl,He.getProjection(),yo),Zc=Le.translatePosMatrix(gc,je,jt,bi,!0),Wc=Le.translatePosMatrix(Yn,je,jt,bi),Kc=Gt?kp:ac,Jc=bl&&!kl&&!Oe;let Qc=yc;!mc&&!pl.mercatorFromTransition||bl||(Qc=Pr(pl));const eh=qr?Qc:yc,th=Fe.getColorAdjustmentMatrix(Ro,zs,Zs,na),rh=vr(ec.kind,tc,Jc,kl,Le,Wc,Kc,Zc,el,!1,Tl,[0,0],!0,qe,Xn,sc,xc,eh,He.getProjection(),th,wi),oh=je.imageAtlasTexture?je.imageAtlasTexture:null,ah=1!==Fe.layout.get("icon-size").constantOr(0)||He.iconsNeedLinear,lh=He.sdfIcons||Le.options.rotating||Le.options.zooming||ah||ic?hl.LINEAR:hl.NEAREST,hh=He.sdfIcons&&0!==Fe.paint.get("icon-halo-width").constantOr(1),ph=Le.terrain&&kl&&Oe?F.ad.mat4.invert(F.ad.mat4.create(),ac):kp;if(Oe&&He.icon){const F=pl.elevation,Oe=F?F.getAtTileOffsetFunc(qe,pl.center.lat,pl.worldSize,He.getProjection()):null,Fe=Ht(Yn,je.tileID.canonical,kl,bl,pl,He.getProjection(),yo);Kt(He,Yn,Le,!1,Fe,gc,kl,bo,Oe,qe)}return{program:nl,buffers:He.icon,uniformValues:rh,atlasTexture:oh,atlasTextureIcon:null,atlasInterpolation:lh,atlasInterpolationIcon:null,isSDF:He.sdfIcons,hasHalo:hh,tile:je,labelPlaneMatrixInv:ph}},V=()=>{const Oe=Tl&&"point"!==Fe.layout.get("symbol-placement"),xt=[],jt=Oe||ac||oc;Le.terrainRenderModeElevated()&&ec&&xt.push("PITCH_WITH_MAP_TERRAIN"),qr&&(xt.push("PROJECTION_GLOBE_VIEW"),jt&&xt.push("PROJECTED_POS_ON_VIEWPORT")),He.text.zOffsetVertexBuffer&&xt.push("Z_OFFSET"),He.iconsInText&&xt.push("RENDER_TEXT_AND_SYMBOL"),xt.push("RENDER_SDF"),N(xt);const bi=He.text.programConfigurations.get(Fe.id),bo=Le.getOrCreateProgram("symbol",{config:bi,defines:xt});let Ro,zs=[0,0],Zs=null;const na=He.textSizeData;He.iconsInText&&(zs=je.imageAtlasTexture?je.imageAtlasTexture.size:[0,0],Zs=je.imageAtlasTexture?je.imageAtlasTexture:null,Ro=ec||0!==pl.pitch||Le.options.rotating||Le.options.zooming||"composite"===na.kind||"camera"===na.kind?hl.LINEAR:hl.NEAREST);const nl=je.glyphAtlasTexture?je.glyphAtlasTexture.size:[0,0],bl=Fe.layout.get("text-size-scale-range"),kl=F.ay(Le.scaleFactor,bl[0],bl[1]),tc=F.bp(na,pl.zoom,kl),ic=qt(Yn,je.tileID.canonical,ec,Tl,pl,He.getProjection(),yo),gc=Zt(Yn,je.tileID.canonical,ec,Tl,pl,He.getProjection(),yo),Zc=Le.translatePosMatrix(gc,je,Gt,wi,!0),Wc=Le.translatePosMatrix(Yn,je,Gt,wi),Kc=jt?kp:ic,Jc=Tl&&!ec&&!Oe;let Qc=yc;!mc&&!pl.mercatorFromTransition||Tl||(Qc=Pr(pl));const eh=vr(na.kind,tc,Jc,ec,Le,Wc,Kc,Zc,el,!0,nl,zs,!0,qe,Xn,sc,xc,qr?Qc:yc,He.getProjection(),null,null,kl),th=je.glyphAtlasTexture?je.glyphAtlasTexture:null,rh=hl.LINEAR,oh=0!==Fe.paint.get("text-halo-width").constantOr(1),ah=Le.terrain&&ec&&Oe?F.ad.mat4.invert(F.ad.mat4.create(),ic):kp;if(Oe&&He.text){const F=pl.elevation,Oe=F?F.getAtTileOffsetFunc(qe,pl.center.lat,pl.worldSize,He.getProjection()):null,Fe=Ht(Yn,je.tileID.canonical,ec,Tl,pl,He.getProjection(),yo);Kt(He,Yn,Le,!0,Fe,gc,ec,Do,Oe,qe)}return{program:bo,buffers:He.text,uniformValues:eh,atlasTexture:th,atlasTextureIcon:Zs,atlasInterpolation:rh,atlasInterpolationIcon:Ro,isSDF:!0,hasHalo:oh,tile:je,labelPlaneMatrixInv:ah}},Zc=He.icon.segments.get().length,Wc=He.text.segments.get().length,Kc=Zc&&!xt.onlyText?U():null,Jc=Wc&&!xt.onlyIcons?V():null,Qc=Fe.paint.get("icon-opacity").constantOr(1),eh=Fe.paint.get("text-opacity").constantOr(1);if(tc&&He.canOverlap){ic=!0;const Le=Qc&&!xt.onlyText?He.icon.segments.get():[],Oe=eh&&!xt.onlyIcons?He.text.segments.get():[];for(const Oe of Le)gc.push({segments:new F.b8([Oe]),sortKey:Oe.sortKey,state:Kc});for(const Le of Oe)gc.push({segments:new F.b8([Le]),sortKey:Le.sortKey,state:Jc})}else xt.onlyText||gc.push({segments:Qc?He.icon.segments:new F.b8([]),sortKey:0,state:Kc}),xt.onlyIcons||gc.push({segments:eh?He.text.segments:new F.b8([]),sortKey:0,state:Jc})}ic&&gc.sort(((F,Le)=>F.sortKey-Le.sortKey));for(const F of gc){const Oe=F.state;if(Oe)if(Le.terrain?Le.terrain.setupElevationDraw(Oe.tile,Oe.program,{useDepthForOcclusion:pl.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:Oe.labelPlaneMatrixInv}):Le.setupDepthForOcclusion(pl.depthOcclusionForSymbolsAndCircles,Oe.program),nl.activeTexture.set(hl.TEXTURE0),Oe.atlasTexture&&Oe.atlasTexture.bind(Oe.atlasInterpolation,hl.CLAMP_TO_EDGE,!0),Oe.atlasTextureIcon&&(nl.activeTexture.set(hl.TEXTURE1),Oe.atlasTextureIcon&&Oe.atlasTextureIcon.bind(Oe.atlasInterpolationIcon,hl.CLAMP_TO_EDGE,!0)),Le.uploadCommonLightUniforms(Le.context,Oe.program),Oe.hasHalo){const je=Oe.uniformValues;je.u_is_halo=1,kr(Oe.buffers,F.segments,Fe,Le,Oe.program,oc,qe,He,je,2),je.u_is_halo=0}else{if(Oe.isSDF){const je=Oe.uniformValues;Oe.hasHalo&&(je.u_is_halo=1,kr(Oe.buffers,F.segments,Fe,Le,Oe.program,oc,qe,He,je,1)),je.u_is_halo=0}kr(Oe.buffers,F.segments,Fe,Le,Oe.program,oc,qe,He,Oe.uniformValues,1)}}}function kr(F,Le,Oe,Fe,je,qe,He,xt,jt,Gt){const bi=[F.dynamicLayoutVertexBuffer,F.opacityVertexBuffer,F.iconTransitioningVertexBuffer,F.globeExtVertexBuffer,F.zOffsetVertexBuffer];je.draw(Fe,Fe.context.gl.TRIANGLES,qe,He,xt,ji.disabled,jt,Oe.id,F.layoutVertexBuffer,F.indexBuffer,Le,Oe.paint,Fe.transform.zoom,F.programConfigurations.get(Oe.id),bi,Gt)}function Br(Le,Oe){const Fe=1<<Le.canonical.z,je=(Oe.x*Fe-Le.canonical.x-Le.wrap*Fe)*F.ai,qe=(Oe.y*Fe-Le.canonical.y)*F.ai,He=F.d5(Oe.z,Oe.y);return F.ad.vec3.fromValues(je,qe,He)}function Nr(Le,Oe,Fe,je,qe){if(!Fe.layout||"none"===Fe.layout.get("fill-elevation-reference"))return;const He=Le.context.gl,xt=new Bi(Le.context.gl.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D),jt=new Bi(Le.context.gl.GREATER,Bi.ReadWrite,Le.depthRangeFor3D),Gt=function(Le){const Oe=F.c4(Le.pitch);let Fe=.01;return Le.isOrthographic&&(Fe=F.ah(1e-4,Fe,F.c9(Oe>=Qh?1:Oe/Qh))),2*Fe}(Le.transform),bi=Le.transform.getFreeCameraOptions().position,wi="elevatedStructuresDepthReconstruct",qr=Le.getOrCreateProgram(wi,{defines:["DEPTH_RECONSTRUCTION"]}),Xn=Le.getOrCreateProgram(wi);for(const F of je){const je=Oe.getTile(F),wi=je.getBucket(Fe);if(!wi)continue;const Yn=wi.elevatedStructures;if(!Yn)continue;const yo=wi.elevationBufferData.heightRange,bo=Br(F.toUnwrapped(),bi),Do=Le.translatePosMatrix(F.projMatrix,je,Fe.paint.get("fill-translate"),Fe.paint.get("fill-translate-anchor"));let Ro,zs,Zs,na;if("initialize"===qe){if(!yo||yo.min>=1||0===Yn.depthSegments.segments[0].primitiveLength)continue;Ro=sr(Do,bo,Gt,1,0),zs=xt,Zs=Yn.depthSegments,na=qr}else if("reset"===qe){if(!yo||yo.min>=0||0===Yn.maskSegments.segments[0].primitiveLength)continue;Ro=sr(Do,bo,0,0,1),zs=jt,Zs=Yn.maskSegments,na=qr}else if("geometry"===qe){if(0===Yn.depthSegments.segments[0].primitiveLength)continue;Ro=sr(Do,bo,Gt,1,0),zs=xt,Zs=Yn.depthSegments,na=Xn}na.draw(Le,He.TRIANGLES,zs,Ui.disabled,ki.disabled,ji.disabled,Ro,Fe.id,Yn.vertexBuffer,Yn.indexBuffer,Zs,Fe.paint,Le.transform.zoom)}}function Ur(Le,Oe,Fe){const{painter:je,sourceCache:qe,layer:He,coords:xt,colorMode:jt,elevationType:Gt,terrainEnabled:bi,pass:wi}=Le,qr=je.context.gl,Xn=He.paint.get("fill-pattern");let Yn=Gt;"road"!==Gt||Oe&&!bi||(Yn="none");const yo="road"===Yn,bo=new Bi(je.context.gl.LEQUAL,Bi.ReadWrite,je.depthRangeFor3D),Do=Xn&&Xn.constantOr(1),v=(Le,Gt)=>{let bi,wi,Ro,zs,Zs;Gt?(wi=Do&&!He.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",bi=qr.LINES):(wi=Do?"fillPattern":"fill",bi=qr.TRIANGLES);for(const na of xt){const xt=qe.getTile(na);if(Do&&!xt.patternsLoaded())continue;const el=xt.getBucket(He);if(!el)continue;const nl=Oe?el.elevationBufferData:el.bufferData;if(nl.isEmpty())continue;je.prepareDrawTile();const hl=nl.programConfigurations.get(He.id),pl=je.isTileAffectedByFog(na),bl=[],Tl=[];yo&&(bl.push("ELEVATED_ROADS"),Tl.push(nl.elevatedLayoutVertexBuffer));const kl=je.getOrCreateProgram(wi,{config:hl,overrideFog:pl,defines:bl});Do&&(je.context.activeTexture.set(qr.TEXTURE0),xt.imageAtlasTexture&&xt.imageAtlasTexture.bind(qr.LINEAR,qr.CLAMP_TO_EDGE),hl.updatePaintBuffers());const ec=Xn.constantOr(null);if(ec&&xt.imageAtlas){const Le=xt.imageAtlas,Oe=F.d0.from(ec).getPrimary().scaleSelf(F.q.devicePixelRatio).toString(),Fe=Le.patternPositions.get(Oe);Fe&&hl.setConstantPatternPositions(Fe)}const tc=je.translatePosMatrix(na.projMatrix,xt,He.paint.get("fill-translate"),He.paint.get("fill-translate-anchor")),ic=He.paint.get("fill-emissive-strength");if(Gt){zs=nl.lineIndexBuffer,Zs=nl.lineSegments;const F=je.terrain&&je.terrain.renderingToTexture?je.terrain.drapeBufferSize:[qr.drawingBufferWidth,qr.drawingBufferHeight];Ro="fillOutlinePattern"===wi&&Do?or(tc,ic,je,xt,F):ir(tc,ic,F)}else zs=nl.indexBuffer,Zs=nl.triangleSegments,Ro=Do?tr(tc,ic,je,xt):er(tc,ic);je.uploadCommonUniforms(je.context,kl,na.toUnwrapped()),kl.draw(je,bi,"none"!==Yn?bo:Le,Fe||je.stencilModeForClipping(na),jt,ji.disabled,Ro,He.id,nl.layoutVertexBuffer,zs,Zs,He.paint,je.transform.zoom,hl,Tl)}};je.renderPass===wi&&v(je.depthModeForSublayer(1,"opaque"===je.renderPass?Bi.ReadWrite:Bi.ReadOnly),!1),"none"===Yn&&"translucent"===je.renderPass&&He.paint.get("fill-antialias")&&v(je.depthModeForSublayer(He.getPaintProperty("fill-outline-color")?2:0,Bi.ReadOnly),!0)}function Vr(Le,Oe,Fe,je,qe,He,xt,jt){Fe.resetLayerRenderingStats(Le);const Gt=Le.context,bi=Gt.gl,wi=Le.transform,qr=Fe.paint.get("fill-extrusion-pattern"),Xn=qr.constantOr(1),Yn=Fe.paint.get("fill-extrusion-opacity"),yo=Le.style.enable3dLights(),bo=Fe.paint.get(yo&&!Xn?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Do=[Fe.paint.get("fill-extrusion-ambient-occlusion-intensity"),bo],Ro=Fe.layout.get("fill-extrusion-edge-radius"),zs=Ro>0&&!Fe.paint.get("fill-extrusion-rounded-roof"),Zs=zs?0:Ro,na="globe"===wi.projection.name?F.d6():0,el="globe"===wi.projection.name,nl=el?F.ag(wi.zoom):0,hl=[F.av(wi.center.lng),F.aC(wi.center.lat)],pl="none"===Fe.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),bl=Fe.paint.get("fill-extrusion-flood-light-color").toRenderColor(pl?null:Fe.lut).toArray01().slice(0,3),Tl=Fe.paint.get("fill-extrusion-flood-light-intensity"),kl=Fe.paint.get("fill-extrusion-vertical-scale"),ec=0!==Fe.paint.get("fill-extrusion-line-width").constantOr(1),tc=Fe.paint.get("fill-extrusion-height-alignment"),ic=Fe.paint.get("fill-extrusion-base-alignment"),oc=Qi(Le,Fe.paint.get("fill-extrusion-cutoff-fade-range")),sc=[];let ac;el&&sc.push("PROJECTION_GLOBE_VIEW"),Do[0]>0&&sc.push("FAUX_AO"),zs&&sc.push("ZERO_ROOF_RADIUS"),jt&&sc.push("HAS_CENTROID"),Tl>0&&sc.push("FLOOD_LIGHT"),oc.shouldRenderCutoff&&sc.push("RENDER_CUTOFF"),ec&&sc.push("RENDER_WALL_MODE");const mc="shadow"===Le.renderPass,gc=Le.shadowRenderer,yc=mc&&!!gc;Le.shadowRenderer&&(Le.shadowRenderer.useNormalOffset=!0);let xc=[0,0,0];if(gc){const F=Le.style.directionalLight,Oe=Le.style.ambientLight;F&&Oe&&(xc=no(Le.style,F,Oe)),mc||(sc.push("RENDER_SHADOWS","DEPTH_TEXTURE"),gc.useNormalOffset&&sc.push("NORMAL_OFFSET")),ac=sc.concat(["SHADOWS_SINGLE_CASCADE"])}const Zc=yc?"fillExtrusionDepth":Xn?"fillExtrusionPattern":"fillExtrusion",Wc=Fe.getLayerRenderingStats();for(const yo of je){const je=Oe.getTile(yo),bo=je.getBucket(Fe);if(!bo||bo.projection.name!==wi.projection.name)continue;let Ro=!1;gc&&(Ro=0===gc.getMaxCascadeForTile(yo.toUnwrapped()));const zs=Le.isTileAffectedByFog(yo),pl=bo.programConfigurations.get(Fe.id),yc=Le.getOrCreateProgram(Zc,{config:pl,defines:Ro?ac:sc,overrideFog:zs});if(Le.terrain&&Le.terrain.setupElevationDraw(je,yc,{useMeterToDem:!0}),!bo.centroidVertexBuffer){const F=yc.attributes.a_centroid_pos;void 0!==F&&bi.vertexAttrib2f(F,0,0)}!mc&&gc&&gc.setupShadows(je.tileID.toUnwrapped(),yc,"vector-tile",je.tileID.overscaledZ),Xn&&(Le.context.activeTexture.set(bi.TEXTURE0),je.imageAtlasTexture&&je.imageAtlasTexture.bind(bi.LINEAR,bi.CLAMP_TO_EDGE),pl.updatePaintBuffers());const Kc=qr.constantOr(null);if(Kc&&je.imageAtlas){const Le=je.imageAtlas,Oe=F.d0.from(Kc).getPrimary().scaleSelf(F.q.devicePixelRatio),Fe=Le.patternPositions.get(Oe.toString());Fe&&pl.setConstantPatternPositions(Fe)}const Jc=Fe.paint.get("fill-extrusion-vertical-gradient"),Qc=1/bo.tileToMeter;let eh;if(mc&&gc){if(Wr(je.tileID,bo,Le))continue;const F=gc.calculateShadowPassMatrixFromTile(je.tileID.toUnwrapped());eh=Js(F,Zs,Qc,kl,tc,ic)}else{const F=Le.translatePosMatrix(yo.expandedProjMatrix,je,Fe.paint.get("fill-extrusion-translate"),Fe.paint.get("fill-extrusion-translate-anchor")),Oe=wi.projection.createInversionMatrix(wi,yo.canonical);eh=Xn?Qs(F,Le,Jc,Yn,Do,Zs,Qc,yo,je,na,tc,ic,nl,hl,Oe,bl,kl):Ys(F,Le,Jc,Yn,Do,Zs,Qc,yo,na,tc,ic,nl,hl,Oe,bl,kl,Tl,xc)}Le.uploadCommonUniforms(Gt,yc,yo.toUnwrapped(),null,oc);let th=bo.segments;if("mercator"===wi.projection.name&&!mc&&(th=bo.getVisibleSegments(je.tileID,Le.terrain,Le.transform.getFrustum(0)),!th.get().length))continue;if(Wc)if(mc)for(const F of th.get())Wc.numRenderedVerticesInShadowPass+=F.primitiveLength;else for(const F of th.get())Wc.numRenderedVerticesInTransparentPass+=F.primitiveLength;const rh=[];(Le.terrain||jt)&&rh.push(bo.centroidVertexBuffer),el&&rh.push(bo.layoutVertexExtBuffer),ec&&rh.push(bo.wallVertexBuffer),yc.draw(Le,Gt.gl.TRIANGLES,qe,He,xt,ji.backCCW,eh,Fe.id,bo.layoutVertexBuffer,bo.indexBuffer,th,Fe.paint,Le.transform.zoom,pl,rh)}Le.shadowRenderer&&(Le.shadowRenderer.useNormalOffset=!1)}function Gr(Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr,Xn,Yn,yo,bo,Do,Ro,zs){const Zs=Le.context,na=Zs.gl,el=Le.transform,nl=Le.transform.zoom,hl=[],pl=Qi(Le,Fe.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===bi?(hl.push("CLEAR_SUBPASS"),zs&&(hl.push("CLEAR_FROM_TEXTURE"),Zs.activeTexture.set(na.TEXTURE0),zs.bind(na.LINEAR,na.CLAMP_TO_EDGE))):"sdf"===bi&&hl.push("SDF_SUBPASS"),Do&&hl.push("HAS_CENTROID"),pl.shouldRenderCutoff&&hl.push("RENDER_CUTOFF");const bl=Fe.layout.get("fill-extrusion-edge-radius"),I=(F,Oe,je,bi,Ro)=>{const na=Oe.programConfigurations.get(Fe.id),el=Le.isTileAffectedByFog(F),Tl=Le.getOrCreateProgram("fillExtrusionGroundEffect",{config:na,defines:hl,overrideFog:el}),kl=((F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi)=>({u_matrix:Le,u_opacity:Oe,u_ao_pass:Fe?1:0,u_meter_to_tile:je,u_ao:qe,u_flood_light_intensity:He,u_flood_light_color:xt,u_attenuation:jt,u_edge_radius:Gt,u_fb:0,u_fb_size:bi,u_dynamic_offset:1}))(0,bi,wi,Gt,Ro,[qr,Xn*Ro],Yn,yo,bo,nl>=17?0:bl*Ro,zs?zs.size[0]:0),ec=[];Do&&ec.push(Oe.hiddenByLandmarkVertexBuffer),Le.uploadCommonUniforms(Zs,Tl,F.toUnwrapped(),null,pl),Tl.draw(Le,Zs.gl.TRIANGLES,qe,He,xt,jt,kl,Fe.id,Oe.vertexBuffer,Oe.indexBuffer,je,Fe.paint,nl,na,ec)};for(const qe of je){const je=Oe.getTile(qe),He=je.getBucket(Fe);if(!He||He.projection.name!==el.projection.name||!He.groundEffect||He.groundEffect&&!He.groundEffect.hasData())continue;const xt=He.groundEffect,jt=1/He.tileToMeter;{const F=Le.translatePosMatrix(qe.projMatrix,je,Fe.paint.get("fill-extrusion-translate"),Fe.paint.get("fill-extrusion-translate-anchor")),Oe=xt.getDefaultSegment();I(qe,xt,Oe,F,jt)}if(Ro)for(let He=0;He<4;He++){const xt=F.d7[He](qe),Gt=Oe.getTile(xt);if(!Gt)continue;const bi=Gt.getBucket(Fe);if(!bi||bi.projection.name!==el.projection.name||!bi.groundEffect||bi.groundEffect&&!bi.groundEffect.hasData())continue;const wi=bi.groundEffect;let qr,Xn;0===He?(qr=[-F.ai,0,0],Xn=1):1===He?(qr=[F.ai,0,0],Xn=0):2===He?(qr=[0,-F.ai,0],Xn=3):(qr=[0,F.ai,0],Xn=2);const Yn=wi.regionSegments[Xn];if(!Yn)continue;const yo=new Float32Array(16);F.ad.mat4.translate(yo,qe.projMatrix,qr),I(qe,wi,Yn,Le.translatePosMatrix(yo,je,Fe.paint.get("fill-extrusion-translate"),Fe.paint.get("fill-extrusion-translate-anchor")),jt)}}}function jr(Le,Oe,Fe,je,qe,He,xt){0===je.centroidVertexArray.length&&je.createCentroidsBuffer();const jt=He?He.findDEMTileFor(Fe):null;if(!(jt&&jt.dem||xt))return;He&&jt&&jt.dem&&je.selfDEMTileTimestamp!==jt.dem._timestamp&&(je.borderDoneWithNeighborZ=[-1,-1,-1,-1],je.selfDEMTileTimestamp=jt.dem._timestamp);const c=Le=>new F.P(Math.ceil((Le+F.da)*F.db),0),h=F=>{const Le=Oe.getSource().minzoom,o=F=>{const Le=Oe.getTileByID(F);if(Le&&Le.hasData())return Le.getBucket(qe)},Fe=[0,-1,1];for(const Oe of Fe){if(F.overscaledZ+Oe<Le)continue;const Fe=o(F.calculateScaledKey(F.overscaledZ+Oe));if(Fe)return Fe}},Gt=[0,0,0],u=(Le,Oe)=>(Gt[0]=Math.min(Le.min.y,Oe.min.y),Gt[1]=Math.max(Le.max.y,Oe.max.y),Gt[2]=F.ai-Oe.min.x>Le.max.x?Oe.min.x-F.ai:Le.max.x,Gt),_=(Le,Oe)=>(Gt[0]=Math.min(Le.min.x,Oe.min.x),Gt[1]=Math.max(Le.max.x,Oe.max.x),Gt[2]=F.ai-Oe.min.y>Le.max.y?Oe.min.y-F.ai:Le.max.y,Gt),bi=[(F,Le)=>u(F,Le),(F,Le)=>u(Le,F),(F,Le)=>_(F,Le),(F,Le)=>_(Le,F)],f=(Le,Oe,je,qe,xt,Gt,bi)=>{if(!He)return 0;const wi=[[Gt?je:Le,Gt?Le:je,0],[Gt?je:Oe,Gt?Oe:je,0]],qr=bi<0?F.ai+bi:bi,Xn=[Gt?qr:(Le+Oe)/2,Gt?(Le+Oe)/2:qr,0];return 0===je&&bi<0||0!==je&&bi>0?He.getForTilePoints(xt,[Xn],!0,qe):wi.push(Xn),He.getForTilePoints(Fe,wi,!0,jt),Math.max(wi[0][2],wi[1][2],Xn[2])/He.exaggeration()};for(let Le=0;Le<4;Le++){const Oe=je.borderFeatureIndices[Le];if(0===Oe.length)continue;const qe=F.d7[Le](Fe),jt=h(qe);if(!(jt&&jt instanceof F.d8))continue;const Gt=He?He.findDEMTileFor(qe):null;if(!(Gt&&Gt.dem||xt))continue;if(He&&Gt&&Gt.dem&&je.borderDEMTileTimestamp[Le]!==Gt.dem._timestamp&&(je.borderDoneWithNeighborZ[Le]=-1,je.borderDEMTileTimestamp[Le]=Gt.dem._timestamp),je.borderDoneWithNeighborZ[Le]===jt.canonical.z)continue;0===jt.centroidVertexArray.length&&jt.createCentroidsBuffer();const Xn=(Le<2?1:5)-Le,Yn=jt.borderDoneWithNeighborZ[Xn]!==je.canonical.z,yo=jt.borderFeatureIndices[Xn];let bo=0;if(je.canonical.z!==jt.canonical.z){for(const F of Oe)je.showCentroid(je.featuresOnBorder[F]);if(Yn)for(const F of yo)jt.showCentroid(jt.featuresOnBorder[F]);je.borderDoneWithNeighborZ[Le]=jt.canonical.z,jt.borderDoneWithNeighborZ[Xn]=je.canonical.z}for(const Fe of Oe){const Oe=je.featuresOnBorder[Fe],He=je.centroidData[Oe.centroidDataIndex],Yn=Oe.borders[Le];let Do;for(;bo<yo.length;){Do=jt.featuresOnBorder[yo[bo]];const F=Do.borders[Xn];if(F[1]>Yn[0]+3||F[0]>Yn[0]-3)break;jt.showCentroid(Do),bo++}if(Do&&bo<yo.length){const Fe=bo;let Ro=0;for(;!(Do.borders[Xn][0]>Yn[1]-3)&&(Ro++,++bo!==yo.length);)Do=jt.featuresOnBorder[yo[bo]];Do=jt.featuresOnBorder[yo[Fe]];let zs=!1;if(Ro>=1){const F=Do.borders[Xn];Math.abs(Yn[0]-F[0])<3&&Math.abs(Yn[1]-F[1])<3&&(Ro=1,zs=!0,bo=Fe+1)}else if(0===Ro){je.showCentroid(Oe);continue}const Zs=jt.centroidData[Do.centroidDataIndex];xt&&zs&&(((wi=He).flags|(qr=Zs).flags)&F.d9?(wi.flags|=F.d9,qr.flags|=F.d9):(wi.flags&=~F.d9,qr.flags&=~F.d9));const na=Oe.intersectsCount()>1||Do.intersectsCount()>1;if(Ro>1)bo=Fe,He.centroidXY=Zs.centroidXY=new F.P(0,0);else if(Gt&&Gt.dem&&!na){const Oe=bi[Le](He,Zs),Fe=Le%2?F.ai-1:0,je=f(Oe[0],Math.min(F.ai-1,Oe[1]),Fe,Gt,qe,Le<2,Oe[2]);He.centroidXY=Zs.centroidXY=c(je)}else na?He.centroidXY=Zs.centroidXY=new F.P(0,0):(He.centroidXY=je.encodeBorderCentroid(Oe),Zs.centroidXY=jt.encodeBorderCentroid(Do));je.writeCentroidToBuffer(He),jt.writeCentroidToBuffer(Zs)}else je.showCentroid(Oe)}je.borderDoneWithNeighborZ[Le]=jt.canonical.z,jt.borderDoneWithNeighborZ[Xn]=je.canonical.z}var wi,qr;(je.needsCentroidUpdate||!je.centroidVertexBuffer&&0!==je.centroidVertexArray.length)&&je.uploadCentroid(Le)}const Fp=[1,0,0],Np=[0,1,0],Up=[0,0,1];function Wr(Le,Oe,Fe){const je=Fe.transform,qe=Fe.shadowRenderer;if(!qe)return!0;const He=Le.toUnwrapped(),xt=je.tileSize*qe._cascades[Fe.currentShadowCascade].scale;let jt=Oe.maxHeight;if(je.elevation){const F=je.elevation.getMinMaxForTile(Le);F&&(jt+=F.max)}const Gt=[...qe.shadowDirection];Gt[2]=-Gt[2];const bi=qe.computeSimplifiedTileShadowVolume(He,jt,xt,Gt);if(!bi)return!1;const wi=[Fp,Np,Up,Gt,[Gt[0],0,Gt[2]],[0,Gt[1],Gt[2]]],qr="globe"===je.projection.name,Xn=je.scaleZoom(xt),Yn=F.bR.fromInvProjectionMatrix(je.invProjMatrix,je.worldSize,Xn,!qr),yo=qe.getCurrentCascadeFrustum();return 0===Yn.intersectsPrecise(bi.vertices,bi.planes,wi)||0===yo.intersectsPrecise(bi.vertices,bi.planes,wi)}function $r(Le){return[Le[0]*F.dc,Le[1]*F.dc,Le[2]*F.dc,0]}function Xr(Le,Oe,Fe,je,qe,He,xt,jt,Gt){const bi=je.getSource(),wi=Fe.globeSharedBuffers;if(!wi)return;let qr,Xn,Yn;if(Oe&&(qr=je.getTile(Oe)),bi instanceof F.aK?(Xn=bi.texture,Yn=F.cJ(0,0,Fe.transform)):qr&&Oe&&(Xn=qr.texture,Yn=F.cJ(Oe.canonical.z,Oe.canonical.x,Fe.transform)),!Xn||!Yn)return;Le||(Yn=F.ad.mat4.scale(F.ad.mat4.create(),Yn,[1,-1,1]));const yo=Fe.context,bo=yo.gl,Do="nearest"===qe.paint.get("raster-resampling")?bo.NEAREST:bo.LINEAR,Ro=Fe.colorModeForDrapableLayerRenderPass(He),zs=xt.defines;zs.push("GLOBE_POLES");const Zs=new Bi(bo.LEQUAL,Bi.ReadWrite,Fe.depthRangeFor3D),na=Float32Array.from(Fe.transform.expandedFarZProjMatrix),el=Float32Array.from(F.bc(F.cI(new F.bT(0,0,0))));Fe.terrain&&Fe.terrain.prepareDrawTile(),yo.activeTexture.set(bo.TEXTURE0),Xn.bind(Do,bo.CLAMP_TO_EDGE),yo.activeTexture.set(bo.TEXTURE1),Xn.bind(Do,bo.CLAMP_TO_EDGE),"useMipmap"in Xn&&yo.extTextureFilterAnisotropic&&Fe.transform.pitch>20&&bo.texParameterf(bo.TEXTURE_2D,yo.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,yo.extTextureFilterAnisotropicMax);const[nl,hl,pl,bl]=Oe?wi.getPoleBuffers(Oe.canonical.z,!1):wi.getPoleBuffers(0,!0),Tl=qe.paint.get("raster-elevation");let kl;Le?(kl=nl,Fe.renderDefaultNorthPole=0!==Tl):(kl=hl,Fe.renderDefaultSouthPole=0!==Tl);const ec=$r(xt.mix),tc=((F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr)=>dr(F,Le,Oe,new Float32Array(16),new Float32Array(9),[0,0],Fe,[0,0],[0,0,0,0],1,{opacity:1,mix:0},qe,[0,0]||[0,0],xt,2,Gt,bi,wi,1,0,qr))(na,el,Yn,F.ag(Fe.transform.zoom),0,qe,0,Tl,0,ec,xt.offset,xt.range,He),ic=Fe.getOrCreateProgram("raster",{defines:zs});Fe.uploadCommonUniforms(yo,ic,null),ic.draw(Fe,bo.TRIANGLES,Zs,Gt,Ro,jt,tc,qe.id,kl,pl,bl)}function Kr(F){const Le=F._nearZ,Oe=F.projection.farthestPixelDistance(F),Fe=Oe-Le,je=.2*F.height,qe=Le+je;return[Le,Oe,(qe-je-Le)/Fe,(qe-Le)/Fe]}function Yr(F,Le,Oe,Fe){if(F)return Le instanceof ot&&F instanceof wt?Le.getTextureDescriptor(F,Oe,!0):{texture:F.texture,mix:$r(Fe.mix),offset:Fe.offset,buffer:0,tileSize:1}}var Gp=F.dd([{name:"a_index",type:"Int16",components:1}]);class Qr{constructor(Le,Oe,Fe,je){const qe={width:Fe[0],height:Fe[1],data:null},He=Le.gl;this.targetColorTexture=new F.T(Le,qe,He.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new F.T(Le,qe,He.RGBA8,{useMipmap:!1}),this.context=Le,this.updateParticleTexture(Oe,je),this.lastInvalidatedAt=0}updateParticleTexture(Le,Oe){if(this.particleTextureDimension===Oe.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const Fe=this.context.gl,je=Oe.width*Oe.height;this.particleTexture0=new F.T(this.context,Oe,Fe.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new F.T(this.context,Oe,Fe.RGBA8,{premultiply:!1,useMipmap:!1});const qe=new F.de;qe.reserve(je);for(let F=0;F<je;F++)qe.emplaceBack(F);this.particleIndexBuffer=this.context.createVertexBuffer(qe,Gp.members,!0),this.particleSegment=F.b8.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=Oe.width}update(Le){return!(this.lastInvalidatedAt<Le&&(this.lastInvalidatedAt=F.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function en(Le,Oe,Fe){if(!Le)return null;const je=Oe.getTextureDescriptor(Le,Fe,!0);if(!je)return null;let{texture:qe,mix:He,offset:xt,tileSize:jt,buffer:Gt,format:bi}=je;if(!qe||!bi)return null;let wi=!1;return"uint32"===bi&&(wi=!0,He[3]=0,He=cr(F.df,He,[0,Fe.paint.get("raster-particle-max-speed")]),xt=hr(F.df,xt,[0,Fe.paint.get("raster-particle-max-speed")])),{texture:qe,textureOffset:[Gt/(jt+2*Gt),jt/(jt+2*Gt)],tileSize:jt,scalarData:wi,scale:He,offset:xt,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[bi]]}}function tn(F){const Le=F._nearZ,Oe=F.projection.farthestPixelDistance(F),Fe=Oe-Le,je=.2*F.height,qe=Le+je;return[Le,Oe,(qe-je-Le)/Fe,(qe-Le)/Fe]}const qp=new F.al(1,0,0,1),$p=new F.al(0,1,0,1),Zp=new F.al(0,0,1,1),Xp=new F.al(1,0,1,1),rf=new F.al(0,1,1,1);function ln(Le,Oe,Fe,je,qe,He,xt){const jt=Le.context,Gt=Le.transform,bi=jt.gl,wi="globe"===Gt.projection.name,qr=wi?["PROJECTION_GLOBE_VIEW"]:[];let Xn=F.ad.mat4.clone(Fe.projMatrix);if(wi&&F.ag(Gt.zoom)>0){const Le=F.bb(Fe.canonical,Gt),Oe=F.dg(Le);Xn=F.ad.mat4.multiply(new Float32Array(16),Gt.globeMatrix,Oe),F.ad.mat4.multiply(Xn,Gt.projMatrix,Xn)}const Yn=F.ad.mat4.create();Yn[12]+=2*qe/(F.q.devicePixelRatio*Gt.width),Yn[13]+=2*He/(F.q.devicePixelRatio*Gt.height),F.ad.mat4.multiply(Xn,Yn,Xn);const yo=Le.getOrCreateProgram("debug",{defines:qr}),bo=Oe.getTileByID(Fe.key);Le.terrain&&Le.terrain.setupElevationDraw(bo,yo);const Do=Bi.disabled,Ro=Ui.disabled,zs=Le.colorModeForRenderPass(),Zs="$debug";jt.activeTexture.set(bi.TEXTURE0),Le.emptyTexture.bind(bi.LINEAR,bi.CLAMP_TO_EDGE),wi?bo._makeGlobeTileDebugBuffers(Le.context,Gt):bo._makeDebugTileBoundsBuffers(Le.context,Gt.projection);const na=bo._tileDebugBuffer||Le.debugBuffer,el=bo._tileDebugIndexBuffer||Le.debugIndexBuffer,nl=bo._tileDebugSegments||Le.debugSegments;if(yo.draw(Le,bi.LINE_STRIP,Do,Ro,zs,ji.disabled,nr(Xn,je),Zs,na,el,nl,null,null,null,[bo._globeTileDebugBorderBuffer]),xt){const F=bo.latestRawTileData,Oe=Math.floor((F&&F.byteLength||0)/1024);let je=Fe.canonical.toString();Fe.overscaledZ!==Fe.canonical.z&&(je+=` => ${Fe.overscaledZ}`),je+=` ${bo.state}`,je+=` ${Oe}kb`,function(F,Le){F.initDebugOverlayCanvas();const Oe=F.debugOverlayCanvas,Fe=F.context.gl,je=F.debugOverlayCanvas.getContext("2d");je.clearRect(0,0,Oe.width,Oe.height),je.shadowColor="white",je.shadowBlur=2,je.lineWidth=1.5,je.strokeStyle="white",je.textBaseline="top",je.font="bold 36px Open Sans, sans-serif",je.fillText(Le,5,5),je.strokeText(Le,5,5),F.debugOverlayTexture.update(Oe),F.debugOverlayTexture.bind(Fe.LINEAR,Fe.CLAMP_TO_EDGE)}(Le,je)}const hl=Oe.getTile(Fe).tileSize,pl=512/Math.min(hl,512)*(Fe.overscaledZ/Gt.zoom)*.5,bl=bo._tileDebugTextBuffer||Le.debugBuffer,Tl=bo._tileDebugTextIndexBuffer||Le.quadTriangleIndexBuffer,kl=bo._tileDebugTextSegments||Le.debugSegments;yo.draw(Le,bi.TRIANGLES,Do,Ro,ki.alphaBlended,ji.disabled,nr(Xn,F.al.transparent,pl),Zs,bl,Tl,kl,null,null,null,[bo._globeTileDebugTextBuffer])}function cn(F,Le,Oe,Fe){dn(F,0,Le+Oe/2,F.transform.width,Oe,Fe)}function hn(F,Le,Oe,Fe){dn(F,Le-Oe/2,0,Oe,F.transform.height,Fe)}function dn(Le,Oe,Fe,je,qe,He){const xt=Le.context,jt=xt.gl;jt.enable(jt.SCISSOR_TEST),jt.scissor(Oe*F.q.devicePixelRatio,Fe*F.q.devicePixelRatio,je*F.q.devicePixelRatio,qe*F.q.devicePixelRatio),xt.clear({color:He}),jt.disable(jt.SCISSOR_TEST)}const af=F.dd([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:lf}=af;function pn(F,Le,Oe,Fe){F.emplaceBack(Le,Oe,Fe)}class fn{constructor(Le){this.vertexArray=new F.dh,this.indices=new F.aV,pn(this.vertexArray,-1,-1,1),pn(this.vertexArray,1,-1,1),pn(this.vertexArray,-1,1,1),pn(this.vertexArray,1,1,1),pn(this.vertexArray,-1,-1,-1),pn(this.vertexArray,1,-1,-1),pn(this.vertexArray,-1,1,-1),pn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=Le.createVertexBuffer(this.vertexArray,lf),this.indexBuffer=Le.createIndexBuffer(this.indices),this.segment=F.b8.simpleSegment(0,0,36,12)}}function mn(Le,Oe,Fe,je,qe,He){const xt=Le.context.gl,jt=Oe.paint.get("sky-atmosphere-color"),Gt=Oe.paint.get("sky-atmosphere-halo-color"),bi=Oe.paint.get("sky-atmosphere-sun-intensity"),wi=((F,Le,Oe,Fe,je)=>({u_matrix_3f:F,u_sun_direction:Le,u_sun_intensity:Oe,u_color_tint_r:[Fe.r,Fe.g,Fe.b,Fe.a],u_color_tint_m:[je.r,je.g,je.b,je.a],u_luminance:5e-5}))(F.ad.mat3.fromMat4(F.ad.mat3.create(),je),qe,bi,jt,Gt);xt.framebufferTexture2D(xt.FRAMEBUFFER,xt.COLOR_ATTACHMENT0,xt.TEXTURE_CUBE_MAP_POSITIVE_X+He,Oe.skyboxTexture,0),Fe.draw(Le,xt.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.frontCW,wi,"skyboxCapture",Oe.skyboxGeometry.vertexBuffer,Oe.skyboxGeometry.indexBuffer,Oe.skyboxGeometry.segment)}const cf=F.dd([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class vn{constructor(Le){const Oe=new F.di;Oe.emplaceBack(-1,1,1,0,0),Oe.emplaceBack(1,1,1,1,0),Oe.emplaceBack(1,-1,1,1,1),Oe.emplaceBack(-1,-1,1,0,1);const Fe=new F.aV;Fe.emplaceBack(0,1,2),Fe.emplaceBack(2,3,0),this.vertexBuffer=Le.createVertexBuffer(Oe,cf.members),this.indexBuffer=Le.createIndexBuffer(Fe),this.segments=F.b8.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const hf=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class xn{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class bn{constructor(Le){this.colorModeAlphaBlendedWriteRGB=new ki([1,Dh,1,Dh],F.al.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ki([1,0,1,0],F.al.transparent,[!1,!1,!1,!0]),this.params=new xn,this.updateNeeded=!0,Le.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),Le.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),Le.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),Le.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(Le){const Oe=Le.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new vn(Oe);const Le=this.params.sizeRange,Fe=this.params.intensityRange,je=function(Le){const Oe=F.dl(30),Fe=[];for(let je=0;je<Le;++je){const Le=2*Math.PI*Oe(),je=Math.acos(1-2*Oe())-.5*Math.PI;Fe.push(F.ad.vec3.fromValues(Math.cos(je)*Math.cos(Le),Math.cos(je)*Math.sin(Le),Math.sin(je)))}return Fe}(this.params.starsCount),qe=F.dl(300),He=new F.dj,xt=new F.aV;let jt=0;for(let Oe=0;Oe<je.length;++Oe){const Gt=F.ad.vec3.scale([],je[Oe],200),bi=Math.max(0,1+.01*Le*(1*qe()-.5)),wi=Math.max(0,1+.01*Fe*(1*qe()-.5));He.emplaceBack(Gt[0],Gt[1],Gt[2],-1,-1,bi,wi),He.emplaceBack(Gt[0],Gt[1],Gt[2],1,-1,bi,wi),He.emplaceBack(Gt[0],Gt[1],Gt[2],1,1,bi,wi),He.emplaceBack(Gt[0],Gt[1],Gt[2],-1,1,bi,wi),xt.emplaceBack(jt+0,jt+1,jt+2),xt.emplaceBack(jt+0,jt+2,jt+3),jt+=4}this.starsVx=Oe.createVertexBuffer(He,hf.members),this.starsIdx=Oe.createIndexBuffer(xt),this.starsSegments=F.b8.simpleSegment(0,0,He.length,xt.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(Le,Oe){const Fe=Le.context,je=Fe.gl,qe=Le.transform,He=new Bi(je.LEQUAL,Bi.ReadOnly,[0,1]),xt=F.ag(qe.zoom),jt=Le.style.getLut(Oe.scope),Gt="none"===Oe.properties.get("color-use-theme"),bi=Oe.properties.get("color").toRenderColor(Gt?null:jt).toArray01(),wi="none"===Oe.properties.get("high-color-use-theme"),qr=Oe.properties.get("high-color").toRenderColor(wi?null:jt).toArray01(),Xn="none"===Oe.properties.get("space-color-use-theme"),Yn=Oe.properties.get("space-color").toRenderColor(Xn?null:jt).toArray01PremultipliedAlpha(),yo=5e-4,bo=F.dk(Oe.properties.get("horizon-blend"),0,1,yo,.25),Do=F.cD(Le,Fe,qe)&&bo===yo?qe.worldSize/(2*Math.PI*1.025)-1:qe.globeRadius,Ro=Le.frameCounter/1e3%1,zs=F.ad.vec3.length(qe.globeCenterInViewSpace),Zs=Math.sqrt(Math.pow(zs,2)-Math.pow(Do,2)),na=Math.acos(Zs/zs),w=F=>{const Oe="globe"===qe.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];F&&Oe.push("ALPHA_PASS");const jt=Le.getOrCreateProgram("globeAtmosphere",{defines:Oe}),Gt=((F,Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi)=>({u_frustum_tl:F,u_frustum_tr:Le,u_frustum_br:Oe,u_frustum_bl:Fe,u_horizon:je,u_transition:qe,u_fadeout_range:He,u_color:xt,u_high_color:jt,u_space_color:Gt,u_temporal_offset:bi,u_horizon_angle:wi}))(qe.frustumCorners.TL,qe.frustumCorners.TR,qe.frustumCorners.BR,qe.frustumCorners.BL,qe.frustumCorners.horizon,xt,bo,bi,qr,Yn,Ro,na);Le.uploadCommonUniforms(Fe,jt);const wi=this.atmosphereBuffer;wi&&jt.draw(Le,je.TRIANGLES,He,Ui.disabled,F?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ji.backCW,Gt,F?"atmosphere_glow_alpha":"atmosphere_glow",wi.vertexBuffer,wi.indexBuffer,wi.segments)};w(!1),w(!0)}drawStars(Le,Oe){const Fe=F.ay(Oe.properties.get("star-intensity"),0,1);if(0===Fe)return;const je=Le.context,qe=je.gl,He=Le.transform,xt=Le.getOrCreateProgram("stars"),jt=F.ad.quat.identity([]);F.ad.quat.rotateX(jt,jt,-He._pitch),F.ad.quat.rotateZ(jt,jt,-He.angle),F.ad.quat.rotateX(jt,jt,F.ak(He._center.lat)),F.ad.quat.rotateY(jt,jt,-F.ak(He._center.lng));const Gt=F.ad.mat4.fromQuat(new Float32Array(16),jt),bi=F.ad.mat4.multiply([],He.starsProjMatrix,Gt),wi=F.ad.mat3.fromMat4([],Gt),qr=F.ad.mat3.invert([],wi),Xn=[0,1,0];F.ad.vec3.transformMat3(Xn,Xn,qr),F.ad.vec3.scale(Xn,Xn,this.params.sizeMultiplier);const Yn=[1,0,0];F.ad.vec3.transformMat3(Yn,Yn,qr),F.ad.vec3.scale(Yn,Yn,this.params.sizeMultiplier);const yo=(bo=Xn,Do=Yn,Ro=Fe,{u_matrix:Float32Array.from(bi),u_up:bo,u_right:Do,u_intensity_multiplier:Ro});var bo,Do,Ro;Le.uploadCommonUniforms(je,xt),this.starsVx&&this.starsIdx&&xt.draw(Le,qe.TRIANGLES,Bi.disabled,Ui.disabled,this.colorModeAlphaBlendedWriteRGB,ji.disabled,yo,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function wn(Le,Oe){const Fe=[...Le],je=Oe.cameraWorldSizeForFog/Oe.worldSize,qe=F.ad.mat4.identity([]);return F.ad.mat4.scale(qe,qe,[je,je,1]),F.ad.mat4.multiply(Fe,qe,Fe),F.ad.mat4.multiply(Fe,Oe.worldToFogMatrix,Fe),Fe}function Tn(Le,Oe,Fe,je,qe){const He=Fe.material,xt=je.context,{baseColorTexture:jt,metallicRoughnessTexture:Gt}=He.pbrMetallicRoughness,{normalTexture:bi,occlusionTexture:wi,emissionTexture:qr}=He;function _(F,Oe,Fe){if(F&&(Le.push(Oe),xt.activeTexture.set(xt.gl.TEXTURE0+Fe),F.gfxTexture)){const{minFilter:Le,magFilter:Oe,wrapS:Fe,wrapT:je}=F.sampler;F.gfxTexture.bindExtraParam(Le,Oe,Fe,je)}}_(jt,"HAS_TEXTURE_u_baseColorTexture",Uh.BaseColor),_(Gt,"HAS_TEXTURE_u_metallicRoughnessTexture",Uh.MetallicRoughness),_(bi,"HAS_TEXTURE_u_normalTexture",Uh.Normal),_(wi,"HAS_TEXTURE_u_occlusionTexture",Uh.Occlusion),_(qr,"HAS_TEXTURE_u_emissionTexture",Uh.Emission),qe&&(qe.texture||(qe.texture=new F.dn(je.context,qe.image,[qe.image.height,qe.image.height,qe.image.height],xt.gl.RGBA8)),xt.activeTexture.set(xt.gl.TEXTURE0+Uh.LUT),qe.texture&&qe.texture.bind(xt.gl.LINEAR,xt.gl.CLAMP_TO_EDGE),Le.push("APPLY_LUT_ON_GPU")),Fe.texcoordBuffer&&(Le.push("HAS_ATTRIBUTE_a_uv_2f"),Oe.push(Fe.texcoordBuffer)),Fe.colorBuffer&&(Le.push(12===Fe.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),Oe.push(Fe.colorBuffer)),Fe.normalBuffer&&(Le.push("HAS_ATTRIBUTE_a_normal_3f"),Oe.push(Fe.normalBuffer)),Fe.pbrBuffer&&(Le.push("HAS_ATTRIBUTE_a_pbr"),Le.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),Oe.push(Fe.pbrBuffer)),"OPAQUE"!==He.alphaMode&&"MASK"!==He.alphaMode||Le.push("UNPREMULT_TEXTURE_IN_SHADER"),He.defined||Le.push("DIFFUSE_SHADED");const Xn=je.shadowRenderer;Xn&&(Le.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Xn.useNormalOffset&&Le.push("NORMAL_OFFSET"))}function En(Le,Oe,Fe,je,qe,He){const xt=Fe.paint.get("model-opacity").constantOr(1),jt=Oe.context,Gt=new Bi(Oe.context.gl.LEQUAL,Bi.ReadWrite,Oe.depthRangeFor3D),bi=Oe.transform,wi=Le.mesh,qr=wi.material,Xn=qr.pbrMetallicRoughness,Yn=Oe.style.fog;let yo;yo="pixels"===Oe.transform.projection.zAxisUnit?[...Le.nodeModelMatrix]:F.ad.mat4.multiply([],je.zScaleMatrix,Le.nodeModelMatrix),F.ad.mat4.multiply(yo,je.negCameraPosMatrix,yo);const bo=F.ad.mat4.invert([],yo);F.ad.mat4.transpose(bo,bo);const Do="none"===Fe.paint.get("model-color-use-theme").constantOr("default"),Ro=Fe.paint.get("model-emissive-strength").constantOr(0),zs=wr(new Float32Array(Le.worldViewProjection),new Float32Array(yo),new Float32Array(bo),null,Oe,xt,Xn.baseColorFactor.toRenderColor(null),qr.emissiveFactor,Xn.metallicFactor,Xn.roughnessFactor,qr,Ro,Fe),Zs={defines:[]},na=[],el=Oe.shadowRenderer;el&&(el.useNormalOffset=!1),Tn(Zs.defines,na,wi,Oe,Do?null:Fe.lut);let nl=null;if(Yn){const F=wn(Le.nodeModelMatrix,Oe.transform);if(nl=new Float32Array(F),"globe"!==bi.projection.name){const Le=wi.aabb.min,Oe=wi.aabb.max,[Fe,je]=Yn.getOpacityForBounds(F,Le[0],Le[1],Oe[0],Oe[1]);Zs.overrideFog=Fe>=ic||je>=ic}}const hl=Qi(Oe,Fe.paint.get("model-cutoff-fade-range"));hl.shouldRenderCutoff&&Zs.defines.push("RENDER_CUTOFF");const pl=Oe.getOrCreateProgram("model",Zs);Oe.uploadCommonUniforms(jt,pl,null,nl,hl),"shadow"!==Oe.renderPass&&el&&el.setupShadowsFromMatrix(Le.nodeModelMatrix,pl),pl.draw(Oe,jt.gl.TRIANGLES,Gt,qe,He,wi.material.doubleSided?ji.disabled:ji.backCCW,zs,Fe.id,wi.vertexBuffer,wi.indexBuffer,wi.segments,Fe.paint,Oe.transform.zoom,void 0,na)}function Sn(Le,Oe,Fe,je,qe,He,xt){let jt;jt="globe"===Le.projection.name?F.dp(Fe,Le):[...Fe],F.ad.mat4.multiply(jt,jt,Oe.matrix);const Gt=F.ad.mat4.multiply([],je,jt);if(Oe.meshes)for(const Fe of Oe.meshes){if("BLEND"!==Fe.material.alphaMode){xt.push({mesh:Fe,depth:0,modelIndex:qe,worldViewProjection:Gt,nodeModelMatrix:jt});continue}const Oe=F.ad.vec3.transformMat4([],Fe.centroid,Gt);!Le.isOrthographic&&Oe[2]<=0||He.push({mesh:Fe,depth:Oe[2],modelIndex:qe,worldViewProjection:Gt,nodeModelMatrix:jt})}if(Oe.children)for(const F of Oe.children)Sn(Le,F,Fe,je,qe,He,xt)}function Cn(F,Le,Oe,Fe){const je=Oe.shadowRenderer;if(!je)return;const qe=je.getShadowPassDepthMode(),He=je.getShadowPassColorMode(),xt=je.calculateShadowPassMatrixFromMatrix(Le),jt=Tr(xt);Oe.getOrCreateProgram("modelDepth",{defines:Oe._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(Oe,Oe.context.gl.TRIANGLES,qe,Ui.disabled,He,ji.backCCW,jt,Fe.id,F.vertexBuffer,F.indexBuffer,F.segments,Fe.paint,Oe.transform.zoom,void 0,void 0)}function In(Le,Oe,Fe){const je=Oe.updateZoomBasedPaintProperties(),qe=function(Le,Oe,Fe){let je,qe,He,xt=Le.terrain?Le.terrain.exaggeration():0;if(Le.terrain&&xt>0){const Oe=Le.terrain,qe=Oe.findDEMTileFor(Fe);qe&&qe.dem?je=F.dr.create(Oe,Fe,qe):xt=0}if(0===xt&&(Oe.terrainElevationMin=0,Oe.terrainElevationMax=0),xt===Oe.validForExaggeration&&(0===xt||je&&je._demTile&&je._demTile.tileID===Oe.validForDEMTile.id&&je._dem._timestamp===Oe.validForDEMTile.timestamp))return!1;for(const F in Oe.instancesPerModel){const Le=Oe.instancesPerModel[F];for(let F=0;F<Le.instancedDataArray.length;++F){const Fe=(je?xt*je.getElevationAt(0|Le.instancedDataArray.float32[16*F],0|Le.instancedDataArray.float32[16*F+1],!0,!0):0)+Le.instancesEvaluatedElevation[F];Le.instancedDataArray.float32[16*F+6]=Fe,qe=qe?Math.min(Oe.terrainElevationMin,Fe):Fe,He=He?Math.max(Oe.terrainElevationMax,Fe):Fe}}return Oe.terrainElevationMin=qe||0,Oe.terrainElevationMax=He||0,Oe.validForExaggeration=xt,Oe.validForDEMTile=je&&je._demTile?{id:je._demTile.tileID,timestamp:je._dem._timestamp}:{id:void 0,timestamp:0},!0}(Le,Oe,Fe);(je||qe)&&(Oe.uploaded=!1,Oe.upload(Le.context))}const uf={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new F.ce([0,0,0],[F.ai,F.ai,0])};function Dn(Le,Oe){const Fe=1<<Le.canonical.z,je=Oe.getFreeCameraOptions().position,qe=Oe.elevation,He=Le.canonical.x/Fe,xt=(Le.canonical.x+1)/Fe,jt=Le.canonical.y/Fe,Gt=(Le.canonical.y+1)/Fe;let bi=Oe._centerAltitude;if(qe){const F=qe.getMinMaxForTile(Le);F&&F.max>bi&&(bi=F.max)}const wi=F.ay(je.x,He,xt)-je.x,qr=F.ay(je.y,jt,Gt)-je.y,Xn=F.bH(bi,Oe.center.lat)-je.z;return Oe._zoomFromMercatorZ(Math.sqrt(wi*wi+qr*qr+Xn*Xn))}function An(F,Le,Oe,Fe,je,qe,He){const xt=F.context,jt="shadow"===F.renderPass,Gt=F.shadowRenderer,bi=jt&&Gt?Gt.getShadowPassDepthMode():new Bi(xt.gl.LEQUAL,Bi.ReadWrite,F.depthRangeFor3D),wi=F.isTileAffectedByFog(qe);if(Oe.meshes)for(const qr of Oe.meshes){const Xn=["MODEL_POSITION_ON_GPU"],Yn=[];let yo,bo,Do;Fe.instancedDataArray.length>20&&Xn.push("INSTANCED_ARRAYS");const Ro=Qi(F,Le.paint.get("model-cutoff-fade-range"));if(Ro.shouldRenderCutoff&&Xn.push("RENDER_CUTOFF"),jt&&Gt)yo=F.getOrCreateProgram("modelDepth",{defines:Xn}),bo=Tr(He.shadowTileMatrix,He.shadowTileMatrix,Float32Array.from(Oe.matrix)),Do=Gt.getShadowPassColorMode();else{Tn(Xn,Yn,qr,F,"none"===Le.paint.get("model-color-use-theme").constantOr("default")?null:Le.lut),yo=F.getOrCreateProgram("model",{defines:Xn,overrideFog:wi});const Fe=qr.material,jt=Fe.pbrMetallicRoughness,bi=Le.paint.get("model-opacity").constantOr(1),zs=Le.paint.get("model-emissive-strength").constantOr(0);bo=wr(qe.expandedProjMatrix,Float32Array.from(Oe.matrix),new Float32Array(16),null,F,bi,jt.baseColorFactor.toRenderColor(null),Fe.emissiveFactor,jt.metallicFactor,jt.roughnessFactor,Fe,zs,Le,je),Gt&&(He.shadowUniformsInitialized?yo.setShadowUniformValues(xt,Gt.getShadowUniformValues()):(Gt.setupShadows(qe.toUnwrapped(),yo,"model-tile",qe.overscaledZ),He.shadowUniformsInitialized=!0)),Do=Ro.shouldRenderCutoff||bi<1||"OPAQUE"!==Fe.alphaMode?ki.alphaBlended:ki.unblended}F.uploadCommonUniforms(xt,yo,qe.toUnwrapped(),null,Ro);const zs=qr.material.doubleSided?ji.disabled:ji.backCCW;if(Fe.instancedDataArray.length>20)Yn.push(Fe.instancedDataBuffer),yo.draw(F,xt.gl.TRIANGLES,bi,Ui.disabled,Do,zs,bo,Le.id,qr.vertexBuffer,qr.indexBuffer,qr.segments,Le.paint,F.transform.zoom,void 0,Yn,Fe.instancedDataArray.length);else{const Oe=jt?"u_instance":"u_normal_matrix";for(let je=0;je<Fe.instancedDataArray.length;++je)bo[Oe]=new Float32Array(Fe.instancedDataArray.arrayBuffer,64*je,16),yo.draw(F,xt.gl.TRIANGLES,bi,Ui.disabled,Do,zs,bo,Le.id,qr.vertexBuffer,qr.indexBuffer,qr.segments,Le.paint,F.transform.zoom,void 0,Yn)}}if(Oe.children)for(const xt of Oe.children)An(F,Le,xt,Fe,je,qe,He)}const df=[1,-1,1];function Mn(Le,Oe,Fe,je){if(!Fe.modelManager)return!0;const qe=Fe.modelManager;if(!Fe.shadowRenderer)return!0;const He=Fe.shadowRenderer,xt=Oe.aabb;let jt=!0,Gt=Le.maxHeight;if(0===Gt){let F=0;for(const Oe in Le.instancesPerModel){const Le=qe.getModel(Oe,je);Le?F=Math.max(F,Math.max(Math.max(Le.aabb.max[0],Le.aabb.max[1]),Le.aabb.max[2])):jt=!1}Gt=Le.maxScale*F*1.41+Le.maxVerticalOffset,jt&&(Le.maxHeight=Gt)}xt.max[2]=Gt,xt.min[2]+=Le.terrainElevationMin,xt.max[2]+=Le.terrainElevationMax,F.ad.vec3.transformMat4(xt.min,xt.min,Oe.tileMatrix),F.ad.vec3.transformMat4(xt.max,xt.max,Oe.tileMatrix);const bi=xt.intersects(He.getCurrentCascadeFrustum());return 0===Fe.currentShadowCascade&&(Le.isInsideFirstShadowMapFrustum=2===bi),0===bi}function Pn(Le,Oe){const Fe=Le.uniformValues.u_cutoff_params[0],je=Le.uniformValues.u_cutoff_params[1],qe=Le.uniformValues.u_cutoff_params[2],He=Le.uniformValues.u_cutoff_params[3];return je===Fe||He===qe?1:F.ay(((Oe-Fe)/(je-Fe)-qe)/(He-qe),0,1)}function zn(Le,Oe,Fe,je){if(Oe.pitch<20)return 1;const qe=Oe.getWorldToCameraMatrix();F.ad.mat4.multiply(qe,qe,Le);const He=F.ad.vec4.fromValues(Fe.min[0],Fe.min[1],Fe.min[2],1);let xt=F.ad.vec4.transformMat4(F.ad.vec4.create(),He,qe),jt=xt,Gt=xt;He[1]=Fe.max[1],xt=F.ad.vec4.transformMat4(F.ad.vec4.create(),He,qe),jt=xt[1]<jt[1]?xt:jt,Gt=xt[1]>Gt[1]?xt:Gt,He[0]=Fe.max[0],xt=F.ad.vec4.transformMat4(F.ad.vec4.create(),He,qe),jt=xt[1]<jt[1]?xt:jt,Gt=xt[1]>Gt[1]?xt:Gt,He[1]=Fe.min[1],xt=F.ad.vec4.transformMat4(F.ad.vec4.create(),He,qe),jt=xt[1]<jt[1]?xt:jt,Gt=xt[1]>Gt[1]?xt:Gt;const bi=F.ay(je[0],0,1),wi=100*Oe.pixelsPerMeter*F.ay(je[1],0,1),qr=F.ay(je[2],0,1),Xn=F.ad.vec4.lerp(F.ad.vec4.create(),jt,Gt,bi),Yn=Math.tan(.5*Oe.fovX),yo=-Xn[2]*Yn;if(0===wi)return Xn[1]<-Math.abs(yo)?qr:1;const bo=(-Math.abs(yo)-Xn[1])/wi,g=(F,Le,Oe)=>(1-Oe)*F+Oe*Le,Do=F.ay(g(1,qr,bo),qr,1);return g(1,Do,F.ay((Oe.pitch-20)/20,0,1))}class On{}class Fn{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(Le,Oe,Fe){{const F=this._storage.get(Oe.id);if(F)return F.lastUsedFrameIdx=Le,F.buf}const je=Fe.gl,qe=je.getBufferParameter(je.ELEMENT_ARRAY_BUFFER,je.BUFFER_SIZE),He=new ArrayBuffer(qe),xt=new Int16Array(He);je.getBufferSubData(je.ELEMENT_ARRAY_BUFFER,0,new Int16Array(He));const jt=new F.dt;for(let F=0;F<qe/2;F+=3){const Le=xt[F],Oe=xt[F+1],Fe=xt[F+2];jt.emplaceBack(Le,Oe),jt.emplaceBack(Oe,Fe),jt.emplaceBack(Fe,Le)}const Gt=Fe.bindVertexArrayOES.current,bi=new On;return bi.buf=new Sr(Fe,jt),bi.lastUsedFrameIdx=Le,this._storage.set(Oe.id,bi),Fe.bindVertexArrayOES.set(Gt),bi.buf}update(F){for(const[Le,Oe]of this._storage)F-Oe.lastUsedFrameIdx>30&&(Oe.buf.destroy(),this._storage.delete(Le))}destroy(){for(const[F,Le]of this._storage)Le.buf.destroy(),this._storage.delete(F)}}class kn{constructor(F){this.occluderSize=30,this.depthOffset=-1e-4,F.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),F.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const pf=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Nn{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Un{constructor(F,Le){this.revealStart=11,this.revealRange=2,F.registerParameter(this,[...Le,"Reveal"],"revealStart",{min:0,max:17,step:.05}),F.registerParameter(this,[...Le,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const ff=F.dd([{type:"Float32",name:"a_pos_2f",components:2}]);class Gn{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(Le,Oe){const Fe=Le.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const Oe=new F.du,Fe=new F.aV;Oe.emplaceBack(-1,-1),Oe.emplaceBack(1,-1),Oe.emplaceBack(1,1),Oe.emplaceBack(-1,1),Fe.emplaceBack(0,1,2),Fe.emplaceBack(0,2,3),this.vignetteVx=Le.context.createVertexBuffer(Oe,ff.members),this.vignetteIdx=Le.context.createIndexBuffer(Fe)}const je=F.b8.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){Le.uploadCommonUniforms(Le.context,Fe);const F={u_vignetteShape:(qe={vignetteShape:[Oe.start,Oe.range,Math.pow(10,Oe.fadePower)],vignetteColor:[Oe.color.r,Oe.color.g,Oe.color.b,Oe.color.a*Oe.strength]}).vignetteShape,u_vignetteColor:qe.vignetteColor};Fe.draw(Le,Le.context.gl.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,F,"vignette",this.vignetteVx,this.vignetteIdx,je)}var qe}}class jn{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(Le,Oe){const Fe=Le.getFreeCameraOptions().position,je=Fe.toAltitude(),qe=Fe.toLngLat(),He=F.ak(qe.lng),xt=F.ak(qe.lat),jt=Le.pixelsPerMeter/Oe,Gt=He*F.dv,bi=F.dv*Math.log(Math.tan(Math.PI/4+xt/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const F=-this._offsetYPrev+bi,Le=-this._elevationPrev+je;this._accumulatedOffsetX+=(-this._offsetXPrev+Gt)*jt,this._accumulatedOffsetY+=F*jt,this._accumulatedElevation+=Le*jt,this._offsetXPrev=Gt,this._offsetYPrev=bi,this._elevationPrev=je}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function qn(F,Le){return[-(F[0]-Math.floor(F[0]/Le)*Le),-(F[1]-Math.floor(F[1]/Le)*Le),-(F[2]-Math.floor(F[2]/Le)*Le)]}function Hn(Le){const Oe=F.dl(1323123451230),Fe=[];for(let je=0;je<Le;++je){const Le=2*Oe()-1,je=2*Oe()-1,qe=2*Oe()-1;Fe.push(F.ad.vec3.fromValues(Le,je,qe))}return Fe}function Zn(Le,Oe,Fe,je,qe){const He=F.ay((qe-Fe)/(je-Fe),0,1);return(1-He)*Le+He*Oe}class Wn{constructor(F){this._movement=new jn,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Gn,this._ppmScaleFactor=F}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(Le,Oe){const Fe=Le.transform;this._movement.update(Fe,this._ppmScaleFactor);const je=Fe.starsProjMatrix,qe=F.ad.quat.identity([]);F.ad.quat.rotateX(qe,qe,F.ak(90)-Fe._pitch),F.ad.quat.rotateZ(qe,qe,-Fe.angle);const He=F.ad.mat4.fromQuat(new Float32Array(16),qe),xt=F.ad.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),jt=F.ad.mat4.transpose([],xt),Gt=F.ad.mat4.multiply([],jt,He),bi=Date.now()/1e3;return this._accumulatedTimeFromStart+=(bi-this._prevTime)*Oe,this._prevTime=bi,{projectionMatrix:je,modelviewMatrix:Gt}}}class $n extends Wn{constructor(F){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Un(F.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(Le){const Oe=Le.context;if(!this.particlesVx){const Le=Hn(this.particlesCount),Fe=new F.dw,je=new F.aV;let qe=0;const He=F.dl(1323123451230);for(let F=0;F<Le.length;++F){const Oe=Le[F],xt=[2*He()-1,He(),He(),He()];Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,-1,...xt),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,-1,...xt),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,1,...xt),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,1,...xt),je.emplaceBack(qe+0,qe+1,qe+2),je.emplaceBack(qe+0,qe+2,qe+3),qe+=4}this.particlesVx=Oe.createVertexBuffer(Fe,pf.members),this.particlesIdx=Oe.createIndexBuffer(je)}}draw(Le){if(!this._params.overrideStyleParameters&&!Le.style.rain)return;const Oe=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},Fe=Le.transform.zoom;if(Oe.revealStart>Fe)return;const je=Zn(0,1,Oe.revealStart,Oe.revealStart+Oe.revealRange,Fe);if(!this.particlesVx||!this.particlesIdx)return;const qe=structuredClone(this._params);let He=[-qe.direction.x,qe.direction.y,-100];F.ad.vec3.normalize(He,He);const xt=structuredClone(this._vignetteParams);xt.strength*=je,qe.overrideStyleParameters||(qe.intensity=Le.style.rain.state.density,qe.timeFactor=Le.style.rain.state.intensity,qe.color=structuredClone(Le.style.rain.state.color),He=structuredClone(Le.style.rain.state.direction),qe.screenThinning.intensity=Le.style.rain.state.centerThinning,qe.dropletSizeX=Le.style.rain.state.dropletSize[0],qe.dropletSizeYScale=Le.style.rain.state.dropletSize[1]/Le.style.rain.state.dropletSize[0],qe.distortionStrength=100*Le.style.rain.state.distortionStrength,xt.strength=1,xt.color=structuredClone(Le.style.rain.state.vignetteColor));const jt=this.updateOnRender(Le,qe.timeFactor),Gt=Le.context,bi=Gt.gl,wi=Le.transform;this.screenTexture&&this.screenTexture.size[0]===Le.width&&this.screenTexture.size[1]===Le.height||(this.screenTexture=new F.T(Gt,{width:Le.width,height:Le.height,data:null},bi.RGBA8)),qe.distortionStrength>0&&(Gt.activeTexture.set(bi.TEXTURE0),this.screenTexture.bind(bi.LINEAR,bi.CLAMP_TO_EDGE),bi.copyTexSubImage2D(bi.TEXTURE_2D,0,0,0,0,0,Le.width,Le.height));const qr=Le.getOrCreateProgram("rainParticle");Le.uploadCommonUniforms(Gt,qr),Gt.activeTexture.set(bi.TEXTURE0),this.screenTexture.bind(bi.LINEAR,bi.CLAMP_TO_EDGE);const Xn=[qe.color.r,qe.color.g,qe.color.b,qe.color.a],p=(Oe,Fe)=>{const je=qn(this._movement.getPosition(),Oe),xt=qe.dropletSizeX,Gt=qe.dropletSizeX*qe.dropletSizeYScale,Yn=Le.width/2,yo=Le.height/2,bo=Zn(0,qe.screenThinning.start,0,1,qe.screenThinning.intensity),Do=Zn(.001,qe.screenThinning.range,0,1,qe.screenThinning.intensity),Ro=Zn(0,qe.screenThinning.particleOffset,0,1,qe.screenThinning.intensity),zs=(Zs={modelview:jt.modelviewMatrix,projection:jt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:je,velocityConeAperture:qe.velocityConeAperture,velocity:qe.velocity,boxSize:Oe,rainDropletSize:[xt,Gt],distortionStrength:qe.distortionStrength,rainDirection:He,color:Xn,screenSize:[wi.width,wi.height],thinningCenterPos:[Yn,yo],thinningShape:[bo,Do,Math.pow(10,qe.screenThinning.fadePower)],thinningAffectedRatio:qe.screenThinning.affectedRatio,thinningParticleOffset:Ro,shapeDirectionalPower:qe.shapeDirPower,shapeNormalPower:qe.shapeNormalPower,mode:Fe?0:1},{u_modelview:Float32Array.from(Zs.modelview),u_projection:Float32Array.from(Zs.projection),u_time:Zs.time,u_cam_pos:Zs.camPos,u_texScreen:0,u_velocityConeAperture:Zs.velocityConeAperture,u_velocity:Zs.velocity,u_boxSize:Zs.boxSize,u_rainDropletSize:Zs.rainDropletSize,u_distortionStrength:Zs.distortionStrength,u_rainDirection:Zs.rainDirection,u_color:Zs.color,u_screenSize:Zs.screenSize,u_thinningCenterPos:Zs.thinningCenterPos,u_thinningShape:Zs.thinningShape,u_thinningAffectedRatio:Zs.thinningAffectedRatio,u_thinningParticleOffset:Zs.thinningParticleOffset,u_shapeDirectionalPower:Zs.shapeDirectionalPower,u_shapeNormalPower:Zs.shapeNormalPower,u_mode:Zs.mode});var Zs;const na=Math.round(qe.intensity*this.particlesCount),el=F.b8.simpleSegment(0,0,4*na,2*na);qr.draw(Le,bi.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,zs,"rain_particles",this.particlesVx,this.particlesIdx,el)};qe.distortionStrength>0&&p(qe.boxSize,!0),p(qe.boxSize,!1),this._vignette.draw(Le,xt)}}const mf=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class Kn extends Wn{constructor(F){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Un(F.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(Le){const Oe=Le.context;if(!this.particlesVx){const Le=Hn(this.particlesCount),Fe=new F.dx,je=new F.aV;let qe=0;const He=F.dl(1323123451230);for(let F=0;F<Le.length;++F){const Oe=Le[F],xt=He(),jt=He(),Gt=He(),bi=[F/Le.length,xt,jt,Gt],wi=[He(),He()];Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,-1,...bi,...wi),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,-1,...bi,...wi),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],1,1,...bi,...wi),Fe.emplaceBack(Oe[0],Oe[1],Oe[2],-1,1,...bi,...wi),je.emplaceBack(qe+0,qe+1,qe+2),je.emplaceBack(qe+0,qe+2,qe+3),qe+=4}this.particlesVx=Oe.createVertexBuffer(Fe,mf.members),this.particlesIdx=Oe.createIndexBuffer(je)}}draw(Le){if(!this._params.overrideStyleParameters&&!Le.style.snow)return;const Oe=structuredClone(this._params);let Fe=[-Oe.direction.x,Oe.direction.y,-100];F.ad.vec3.normalize(Fe,Fe);const je=structuredClone(this._vignetteParams),qe=Oe.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},He=Le.transform.zoom;if(qe.revealStart>He)return;const xt=Zn(0,1,qe.revealStart,qe.revealStart+qe.revealRange,He);je.strength*=xt,Oe.overrideStyleParameters||(Oe.intensity=Le.style.snow.state.density,Oe.timeFactor=Le.style.snow.state.intensity,Oe.color=structuredClone(Le.style.snow.state.color),Fe=structuredClone(Le.style.snow.state.direction),Oe.screenThinning.intensity=Le.style.snow.state.centerThinning,Oe.billboardSize=2.79*Le.style.snow.state.flakeSize,je.strength=1,je.color=structuredClone(Le.style.snow.state.vignetteColor));const jt=this.updateOnRender(Le,Oe.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const Gt=Le.context,bi=Gt.gl,wi=Le.transform,qr=Le.getOrCreateProgram("snowParticle");Le.uploadCommonUniforms(Gt,qr),((Oe,je,qe)=>{const He=qn(this._movement.getPosition(),Oe),xt=wi.width/2,Gt=wi.height/2,Xn=Zn(0,qe.screenThinning.start,0,1,qe.screenThinning.intensity),Yn=Zn(.001,qe.screenThinning.range,0,1,qe.screenThinning.intensity),yo=Zn(0,qe.screenThinning.particleOffset,0,1,qe.screenThinning.intensity),bo=(Do={modelview:jt.modelviewMatrix,projection:jt.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:He,velocityConeAperture:qe.velocityConeAperture,velocity:qe.velocity,horizontalOscillationRadius:qe.horizontalOscillationRadius,horizontalOscillationRate:qe.horizontalOscillationRate,boxSize:Oe,billboardSize:1*qe.billboardSize,simpleShapeParameters:[qe.shapeFadeStart,qe.shapeFadePower],screenSize:[wi.width,wi.height],thinningCenterPos:[xt,Gt],thinningShape:[Xn,Yn,Math.pow(10,qe.screenThinning.fadePower)],thinningAffectedRatio:qe.screenThinning.affectedRatio,thinningParticleOffset:yo,color:[qe.color.r,qe.color.g,qe.color.b,qe.color.a],direction:Fe},{u_modelview:Float32Array.from(Do.modelview),u_projection:Float32Array.from(Do.projection),u_time:Do.time,u_cam_pos:Do.camPos,u_velocityConeAperture:Do.velocityConeAperture,u_velocity:Do.velocity,u_horizontalOscillationRadius:Do.horizontalOscillationRadius,u_horizontalOscillationRate:Do.horizontalOscillationRate,u_boxSize:Do.boxSize,u_billboardSize:Do.billboardSize,u_simpleShapeParameters:Do.simpleShapeParameters,u_screenSize:Do.screenSize,u_thinningCenterPos:Do.thinningCenterPos,u_thinningShape:Do.thinningShape,u_thinningAffectedRatio:Do.thinningAffectedRatio,u_thinningParticleOffset:Do.thinningParticleOffset,u_particleColor:Do.color,u_direction:Do.direction});var Do;const Ro=Math.round(qe.intensity*this.particlesCount),zs=F.b8.simpleSegment(0,0,4*Ro,2*Ro);this.particlesVx&&this.particlesIdx&&qr.draw(Le,bi.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,bo,"snow_particles",this.particlesVx,this.particlesIdx,zs)})(Oe.boxSize,0,Oe),this._vignette.draw(Le,je)}}const gf={symbol:function(Le,Oe,Fe,je,qe){if("translucent"!==Le.renderPass)return;const He=Ui.disabled,xt=Le.colorModeForRenderPass(),jt=Fe.layout.get("text-variable-anchor"),Gt=Fe.layout.get("text-size-scale-range"),bi=F.ay(Le.scaleFactor,Gt[0],Gt[1]);jt&&function(Le,Oe,Fe,je,qe,He,xt,jt){const Gt=Oe.transform,bi="map"===qe,wi="map"===He;for(const Oe of Le){const Le=je.getTile(Oe),qe=Le.getBucket(Fe);if(!qe||!qe.text||!qe.text.segments.get().length)continue;const He=F.bp(qe.textSizeData,Gt.zoom,jt),qr=ci(Oe,qe.getProjection(),Gt),Xn=Gt.calculatePixelsToTileUnitsMatrix(Le),Yn=qt(qr,Le.tileID.canonical,wi,bi,Gt,qe.getProjection(),Xn),yo=qe.hasIconTextFit()&&qe.hasIconData();if(He){const Fe=Math.pow(2,Gt.zoom-Le.tileID.overscaledZ);Or(qe,bi,wi,xt,F.cY,Gt,Yn,Oe,Fe,He,yo)}}}(je,Le,Fe,Oe,Fe.layout.get("text-rotation-alignment"),Fe.layout.get("text-pitch-alignment"),qe,bi);const wi=0!==Fe.paint.get("icon-opacity").constantOr(1),qr=0!==Fe.paint.get("text-opacity").constantOr(1);void 0!==Fe.layout.get("symbol-sort-key").constantOr(1)&&(wi||qr)?Fr(Le,Oe,Fe,je,He,xt):(wi&&Fr(Le,Oe,Fe,je,He,xt,{onlyIcons:!0}),qr&&Fr(Le,Oe,Fe,je,He,xt,{onlyText:!0})),Oe.map.showCollisionBoxes&&(Lr(Le,Oe,Fe,je,Fe.paint.get("text-translate"),Fe.paint.get("text-translate-anchor"),!0),Lr(Le,Oe,Fe,je,Fe.paint.get("icon-translate"),Fe.paint.get("icon-translate-anchor"),!1))},circle:function(Le,Oe,Fe,je){if("translucent"!==Le.renderPass)return;const qe=Fe.paint.get("circle-opacity"),He=Fe.paint.get("circle-stroke-width"),xt=Fe.paint.get("circle-stroke-opacity"),jt=void 0!==Fe.layout.get("circle-sort-key").constantOr(1),Gt=Fe.paint.get("circle-emissive-strength");if(0===qe.constantOr(1)&&(0===He.constantOr(1)||0===xt.constantOr(1)))return;const bi=Le.context,wi=bi.gl,qr=Le.transform,Xn=Le.depthModeForSublayer(0,Bi.ReadOnly),Yn=Ui.disabled,yo=Le.colorModeForDrapableLayerRenderPass(Gt),bo="globe"===qr.projection.name,Do=[F.av(qr.center.lng),F.aC(qr.center.lat)],Ro=[];for(let qe=0;qe<je.length;qe++){const He=je[qe],xt=Oe.getTile(He),Gt=xt.getBucket(Fe);if(!Gt||Gt.projection.name!==qr.projection.name)continue;const bi=Gt.programConfigurations.get(Fe.id),wi=F.cZ(Fe),Xn=Le.isTileAffectedByFog(He);bo&&wi.push("PROJECTION_GLOBE_VIEW"),wi.push("DEPTH_D24"),Le.terrain&&qr.depthOcclusionForSymbolsAndCircles&&wi.push("DEPTH_OCCLUSION");const Yn=Le.getOrCreateProgram("circle",{config:bi,defines:wi,overrideFog:Xn}),yo=Gt.layoutVertexBuffer,zs=Gt.globeExtVertexBuffer,Zs=Gt.indexBuffer,na=qr.projection.createInversionMatrix(qr,He.canonical),el={programConfiguration:bi,program:Yn,layoutVertexBuffer:yo,globeExtVertexBuffer:zs,indexBuffer:Zs,uniformValues:F.c_(Le,He,xt,na,Do,Fe),tile:xt};if(jt){const Le=Gt.segments.get();for(const Oe of Le)Ro.push({segments:new F.b8([Oe]),sortKey:Oe.sortKey,state:el})}else Ro.push({segments:Gt.segments,sortKey:0,state:el})}jt&&Ro.sort(((F,Le)=>F.sortKey-Le.sortKey));const zs={useDepthForOcclusion:qr.depthOcclusionForSymbolsAndCircles};for(const F of Ro){const{programConfiguration:Oe,program:je,layoutVertexBuffer:qe,globeExtVertexBuffer:He,indexBuffer:xt,uniformValues:jt,tile:Gt}=F.state,bo=F.segments;Le.terrain&&Le.terrain.setupElevationDraw(Gt,je,zs),Le.uploadCommonUniforms(bi,je,Gt.tileID.toUnwrapped()),je.draw(Le,wi.TRIANGLES,Xn,Yn,yo,ji.disabled,jt,Fe.id,qe,xt,bo,Fe.paint,qr.zoom,Oe,[He])}},heatmap:function(Le,Oe,Fe,je){if(0!==Fe.paint.get("heatmap-opacity"))if("offscreen"===Le.renderPass){const qe=Le.context,He=qe.gl,xt=Ui.disabled,jt=new ki([He.ONE,He.ONE,He.ONE,He.ONE],F.al.transparent,[!0,!0,!0,!0]);!function(F,Le,Oe,Fe){const je=F.gl,qe=Le.width*Fe,He=Le.height*Fe;F.activeTexture.set(je.TEXTURE1),F.viewport.set([0,0,qe,He]);let xt=Oe.heatmapFbo;if(!xt||xt&&(xt.width!==qe||xt.height!==He)){xt&&xt.destroy();const Le=je.createTexture();je.bindTexture(je.TEXTURE_2D,Le),je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_S,je.CLAMP_TO_EDGE),je.texParameteri(je.TEXTURE_2D,je.TEXTURE_WRAP_T,je.CLAMP_TO_EDGE),je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MIN_FILTER,je.LINEAR),je.texParameteri(je.TEXTURE_2D,je.TEXTURE_MAG_FILTER,je.LINEAR),xt=Oe.heatmapFbo=F.createFramebuffer(qe,He,!0,null),function(F,Le,Oe,Fe,je,qe){const He=F.gl;He.texImage2D(He.TEXTURE_2D,0,F.extRenderToTextureHalfFloat?He.RGBA16F:He.RGBA,je,qe,0,He.RGBA,F.extRenderToTextureHalfFloat?He.HALF_FLOAT:He.UNSIGNED_BYTE,null),Fe.colorAttachment.set(Oe)}(F,0,Le,xt,qe,He)}else je.bindTexture(je.TEXTURE_2D,xt.colorAttachment.get()),F.bindFramebuffer.set(xt.framebuffer)}(qe,Le,Fe,"globe"===Le.transform.projection.name?.5:.25),qe.clear({color:F.al.transparent});const Gt=Le.transform,bi="globe"===Gt.projection.name,wi=bi?["PROJECTION_GLOBE_VIEW"]:[],qr=bi?ji.frontCCW:ji.disabled,Xn=[F.av(Gt.center.lng),F.aC(Gt.center.lat)];for(let F=0;F<je.length;F++){const Yn=je[F];if(Oe.hasRenderableParent(Yn))continue;const yo=Oe.getTile(Yn),bo=yo.getBucket(Fe);if(!bo||bo.projection.name!==Gt.projection.name)continue;const Do=Le.isTileAffectedByFog(Yn),Ro=bo.programConfigurations.get(Fe.id),zs=Le.getOrCreateProgram("heatmap",{config:Ro,defines:wi,overrideFog:Do}),{zoom:Zs}=Le.transform;Le.terrain&&Le.terrain.setupElevationDraw(yo,zs),Le.uploadCommonUniforms(qe,zs,Yn.toUnwrapped());const na=Gt.projection.createInversionMatrix(Gt,Yn.canonical);zs.draw(Le,He.TRIANGLES,Bi.disabled,xt,jt,qr,lr(Le,Yn,yo,na,Xn,Zs,Fe.paint.get("heatmap-intensity")),Fe.id,bo.layoutVertexBuffer,bo.indexBuffer,bo.segments,Fe.paint,Le.transform.zoom,Ro,bi?[bo.globeExtVertexBuffer]:null)}qe.viewport.set([0,0,Le.width,Le.height])}else"translucent"===Le.renderPass&&(Le.context.setColorMode(Le.colorModeForRenderPass()),function(Le,Oe){const Fe=Le.context,je=Fe.gl,qe=Oe.heatmapFbo;if(!qe)return;Fe.activeTexture.set(je.TEXTURE0),je.bindTexture(je.TEXTURE_2D,qe.colorAttachment.get()),Fe.activeTexture.set(je.TEXTURE1);let He=Oe.colorRampTexture;He||(He=Oe.colorRampTexture=new F.T(Fe,Oe.colorRamp,je.RGBA8)),He.bind(je.LINEAR,je.CLAMP_TO_EDGE),Le.getOrCreateProgram("heatmapTexture").draw(Le,je.TRIANGLES,Bi.disabled,Ui.disabled,Le.colorModeForRenderPass(),ji.disabled,((F,Le)=>({u_image:0,u_color_ramp:1,u_opacity:Le.paint.get("heatmap-opacity")}))(0,Oe),Oe.id,Le.viewportBuffer,Le.quadTriangleIndexBuffer,Le.viewportSegments,Oe.paint,Le.transform.zoom)}(Le,Fe))},line:function(Le,Oe,Fe,je){if("translucent"!==Le.renderPass)return;const qe=Fe.paint.get("line-opacity"),He=Fe.paint.get("line-width");if(0===qe.constantOr(1)||0===He.constantOr(1))return;const xt=Fe.paint.get("line-emissive-strength"),jt=Fe.paint.get("line-occlusion-opacity"),Gt=Fe.layout.get("line-elevation-reference"),bi="meters"===Fe.layout.get("line-width-unit"),wi="sea"===Gt,qr=Le.context,Xn=qr.gl;if(Fe.hasElevatedBuckets&&"globe"===Le.transform.projection.name)return;const Yn=Fe.layout.get("line-cross-slope"),yo=void 0!==Yn,bo=Yn<1,Do=Le.colorModeForDrapableLayerRenderPass(xt),Ro=Le.terrain&&Le.terrain.renderingToTexture,zs=Ro?1:F.q.devicePixelRatio,Zs=Fe.paint.get("line-dasharray"),na=Zs.constantOr(1),el=Fe.layout.get("line-cap"),nl=Zs.constantOr(null),hl=el.constantOr(null),pl=Fe.paint.get("line-pattern"),bl=pl.constantOr(1),Tl=pl.constantOr(null),kl=Fe.paint.get("line-opacity").constantOr(1);let ec=!bl&&1!==kl||Le.depthOcclusion&&jt>0&&jt<1;const tc=Fe.paint.get("line-gradient"),ic=bl?"linePattern":"line",oc=F.c$(Fe);let sc;if(Ro&&Le.terrain&&Le.terrain.clipOrMaskOverlapStencilType()&&(ec=!1),0!==jt&&Le.depthOcclusion){const Le=Fe.paint._values["line-opacity"];Le&&Le.value&&"constant"===Le.value.kind?sc=Le.value:F.w(`Occlusion opacity for layer ${Fe.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==He.value.kind&&!1===He.value.isLineProgressConstant&&oc.push("VARIABLE_LINE_WIDTH");const z=(je,qe,He,xt,Gt,Yn)=>{for(const yo of je){const je=Oe.getTile(yo);if(bl&&!je.patternsLoaded())continue;const bo=je.getBucket(Fe);if(!bo)continue;if(bo.hasZOffset&&!Gt||!bo.hasZOffset&&Gt)continue;Le.prepareDrawTile();const Zs=bo.programConfigurations.get(Fe.id),el=Le.isTileAffectedByFog(yo),pl=Le.getOrCreateProgram(ic,{config:Zs,defines:qe,overrideFog:el,overrideRtt:!Gt&&void 0});if(Tl&&je.imageAtlas){const Le=F.d0.from(Tl).getPrimary().scaleSelf(zs).toString(),Oe=je.imageAtlas.patternPositions.get(Le);Oe&&Zs.setConstantPatternPositions(Oe)}if(!bl&&nl&&hl&&je.lineAtlas){const F=je.lineAtlas.getDash(nl,hl);F&&Zs.setConstantPatternPositions(F)}let[oc,ac]=Fe.paint.get("line-trim-offset");if("round"===hl||"square"===hl){const F=1;oc!==ac&&(0===oc&&(oc-=F),1===ac&&(ac+=F))}const mc=Ro?yo.projMatrix:null,gc=bi?1/bo.tileToMeter/F.at(je,1,Le.transform.zoom):1,yc=bi?1/bo.tileToMeter/F.at(je,1,Math.floor(Le.transform.zoom)):1,xc=bl?F.d1(Le,je,Fe,mc,zs,gc,yc,[oc,ac]):F.d2(Le,je,Fe,mc,bo.lineClipsArray.length,zs,gc,yc,[oc,ac]);if(tc){const je=bo.gradients[Fe.id];let qe=je.texture;if(Fe.gradientVersion!==je.version){let He=256;if(Fe.stepInterpolant){const Fe=Oe.getSource().maxzoom,je=yo.canonical.z===Fe?Math.ceil(1<<Le.transform.maxZoom-yo.canonical.z):1;He=F.ay(F.d3(bo.maxLineLength/F.ai*1024*je),256,qr.maxTextureSize)}je.gradient=F.d4({expression:Fe.gradientExpression(),evaluationKey:"lineProgress",resolution:He,image:je.gradient||void 0,clips:bo.lineClipsArray}),je.texture?je.texture.update(je.gradient):je.texture=new F.T(qr,je.gradient,Xn.RGBA8),je.version=Fe.gradientVersion,qe=je.texture}qr.activeTexture.set(Xn.TEXTURE1),qe.bind(Fe.stepInterpolant?Xn.NEAREST:Xn.LINEAR,Xn.CLAMP_TO_EDGE)}na&&(qr.activeTexture.set(Xn.TEXTURE0),je.lineAtlasTexture&&je.lineAtlasTexture.bind(Xn.LINEAR,Xn.REPEAT),Zs.updatePaintBuffers()),bl&&(qr.activeTexture.set(Xn.TEXTURE0),je.imageAtlasTexture&&je.imageAtlasTexture.bind(Xn.LINEAR,Xn.CLAMP_TO_EDGE),Zs.updatePaintBuffers()),Gt&&!wi&&Le.terrain.setupElevationDraw(je,pl),Le.uploadCommonUniforms(qr,pl,yo.toUnwrapped());const N=F=>{null!=sc&&(sc.value=kl*jt),pl.draw(Le,Xn.TRIANGLES,He,F,Do,ji.disabled,xc,Fe.id,bo.layoutVertexBuffer,bo.indexBuffer,bo.segments,Fe.paint,Le.transform.zoom,Zs,[bo.layoutVertexBuffer2,bo.patternVertexBuffer,bo.zOffsetVertexBuffer]),null!=sc&&(sc.value=kl)};if(ec&&!Gt){const F=Le.stencilModeForClipping(yo).ref;0===F&&Ro&&qr.clear({stencil:0});const Oe={func:Xn.EQUAL,mask:255};xc.u_alpha_discard_threshold=.8,N(new Ui(Oe,F,255,Xn.KEEP,Xn.KEEP,Xn.INVERT)),xc.u_alpha_discard_threshold=0,N(new Ui(Oe,F,255,Xn.KEEP,Xn.KEEP,Xn.KEEP))}else xc.u_alpha_discard_threshold=ec&&Gt&&Yn?.8:0,N(Gt?xt:Le.stencilModeForClipping(yo))}};if(Fe.hasNonElevatedBuckets){const Oe=!Ro&&Le.terrain;0!==jt&&Oe?F.w(`Occlusion opacity for layer ${Fe.id} is supported on terrain only if the layer has line-z-offset enabled.`):Oe?F.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${Fe.id}.`):z(je,oc,Le.depthModeForSublayer(0,Bi.ReadOnly),Ui.disabled,!1,!0)}if(Fe.hasElevatedBuckets){oc.push("ELEVATED"),yo&&oc.push(bo?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),wi&&oc.push("ELEVATION_REFERENCE_SEA");const F=ec?Le.stencilModeFor3D():Ui.disabled,Oe=new Bi(Le.depthOcclusion?Xn.GREATER:Xn.LEQUAL,Bi.ReadOnly,Le.depthRangeFor3D);Le.forceTerrainMode=!0,z(je,oc,Oe,F,!0,!0),ec&&z(je,oc,Oe,F,!0,!1),Le.forceTerrainMode=!1}ec&&(Le.resetStencilClippingMasks(),Ro&&qr.clear({stencil:0})),0===jt||Le.depthOcclusion||Ro||Le.layersWithOcclusionOpacity.push(Le.currentLayer)},fill:function(Le,Oe,Fe,je){const qe=Fe.paint.get("fill-color"),He=Fe.paint.get("fill-opacity");if(0===He.constantOr(1))return;const xt=Fe.paint.get("fill-emissive-strength"),jt=Le.colorModeForDrapableLayerRenderPass(xt),Gt=Fe.paint.get("fill-pattern"),bi=Le.opaquePassEnabledForLayer()&&!Gt.constantOr(1)&&1===qe.constantOr(F.al.transparent).a&&1===He.constantOr(0)?"opaque":"translucent";let wi="none";"none"!==Fe.layout.get("fill-elevation-reference")?wi="road":0!==Fe.paint.get("fill-z-offset").constantOr(1)&&(wi="offset");const qr=!(!Le.terrain||!Le.terrain.enabled),Xn={painter:Le,sourceCache:Oe,layer:Fe,coords:je,colorMode:jt,elevationType:wi,terrainEnabled:qr,pass:bi};if("offset"!==wi){if(Ur(Xn,!1),"road"===wi){const F=!qr&&"translucent"===Le.renderPass;F&&Nr(Le,Oe,Fe,je,"geometry"),Ur(Xn,!0,Ui.disabled),F&&function(F){const{painter:Le,sourceCache:Oe,layer:Fe,coords:je,colorMode:qe}=F,He=Le.context.gl,xt=new Bi(Le.context.gl.LEQUAL,Bi.ReadOnly,Le.depthRangeFor3D);for(const F of je){const je=Oe.getTile(F),jt=je.getBucket(Fe);if(!jt)continue;const Gt=jt.elevatedStructures;if(!Gt||!Gt.renderableSegments||0===Gt.renderableSegments.segments[0].primitiveLength)continue;Le.prepareDrawTile();const bi=jt.bufferData.programConfigurations.get(Fe.id),wi=Le.isTileAffectedByFog(F),qr=Le.getOrCreateProgram("elevatedStructures",{config:bi,overrideFog:wi,defines:["NORMAL_OFFSET"]}),Xn={u_matrix:Le.translatePosMatrix(F.projMatrix,je,Fe.paint.get("fill-translate"),Fe.paint.get("fill-translate-anchor"))};Le.uploadCommonUniforms(Le.context,qr,F.toUnwrapped()),qr.draw(Le,He.TRIANGLES,xt,Ui.disabled,qe,ji.backCCW,Xn,Fe.id,Gt.vertexBuffer,Gt.indexBuffer,Gt.renderableSegments,Fe.paint,Le.transform.zoom,bi,[Gt.vertexBufferNormal])}}(Xn)}}else Ur(Xn,!1,Le.stencilModeFor3D())},"fill-extrusion":function(Le,Oe,Fe,je){const qe=Fe.paint.get("fill-extrusion-opacity"),He=Le.context,xt=He.gl,jt=Le.terrain,Gt=jt&&jt.renderingToTexture;if(0===qe)return;const bi=Le.conflationActive&&Le.style.isLayerClipped(Fe,Oe.getSource()),wi=Le.style.order.indexOf(Fe.fqid);if(bi&&function(F,Le,Oe,Fe,je){for(const qe of Fe){const Fe=Le.getTile(qe).getBucket(Oe);Fe&&(Fe.updateReplacement(qe,F.replacementSource,je),Fe.uploadCentroid(F.context))}}(Le,Oe,Fe,je,wi),jt||bi)for(const F of je){const je=Oe.getTile(F).getBucket(Fe);je&&jr(Le.context,Oe,F,je,Fe,jt,bi)}if("shadow"===Le.renderPass&&Le.shadowRenderer){const He=Le.shadowRenderer;if(jt&&qe<.65&&Fe._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof F.ab)return;const xt=He.getShadowPassDepthMode(),Gt=He.getShadowPassColorMode();Vr(Le,Oe,Fe,je,xt,Ui.disabled,Gt,bi)}else if("translucent"===Le.renderPass){const wi=!Fe.paint.get("fill-extrusion-pattern").constantOr(1),qr=Fe.paint.get("fill-extrusion-color").constantOr(F.al.white);if(!Gt&&0!==qr.a){const F=new Bi(Le.context.gl.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D);1===qe&&wi?Vr(Le,Oe,Fe,je,F,Ui.disabled,ki.unblended,bi):(Vr(Le,Oe,Fe,je,F,Ui.disabled,ki.disabled,bi),Vr(Le,Oe,Fe,je,F,Le.stencilModeFor3D(),Le.colorModeForRenderPass(),bi),Le.resetStencilClippingMasks())}if(Le.style.enable3dLights()&&wi&&(!jt&&"globe"!==Le.transform.projection.name||Gt)){const qe=Fe.paint.get("fill-extrusion-opacity"),wi=Fe.paint.get("fill-extrusion-ambient-occlusion-intensity"),qr=Fe.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),Xn=Fe.paint.get("fill-extrusion-flood-light-intensity"),Yn="none"===Fe.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),yo=Fe.paint.get("fill-extrusion-flood-light-color").toRenderColor(Yn?null:Fe.lut).toArray01().slice(0,3),bo=wi>0&&qr>0,Do=Xn>0,v=(F,Le,Oe)=>(1-Oe)*F+Oe*Le,y=He=>{const jt=Le.depthModeForSublayer(1,Bi.ReadOnly,xt.LEQUAL,!0),Gt=Fe.paint.get(He?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Yn=v(.1,3,Gt),bo=Le._showOverdrawInspector;if(!bo){const Gt=new Ui({func:xt.ALWAYS,mask:255},255,255,xt.KEEP,xt.KEEP,xt.REPLACE),bo=new ki([xt.ONE,xt.ONE,xt.ONE,xt.ONE],F.al.transparent,[!1,!1,!1,!0],xt.MIN);Gr(Le,Oe,Fe,je,jt,Gt,bo,ji.disabled,He,"sdf",qe,wi,qr,Xn,yo,Yn,bi,!1)}{const Gt=bo?Ui.disabled:new Ui({func:xt.EQUAL,mask:255},255,255,xt.KEEP,xt.DECR,xt.DECR),Do=bo?Le.colorModeForRenderPass():new ki([xt.ONE_MINUS_DST_ALPHA,xt.DST_ALPHA,xt.ONE,xt.ONE],F.al.transparent,[!0,!0,!0,!0]);Gr(Le,Oe,Fe,je,jt,Gt,Do,ji.disabled,He,"color",qe,wi,qr,Xn,yo,Yn,bi,!1)}};if(Gt){const c=(He,jt,Gt)=>{const Yn=Le.depthModeForSublayer(1,Bi.ReadOnly,xt.LEQUAL,!1),bo=Fe.paint.get(He?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Do=v(.1,3,bo);{const Gt=new ki([xt.ONE,xt.ONE,xt.ONE,xt.ONE],F.al.transparent,[!1,!1,!1,!0]);Gr(Le,Oe,Fe,je,Yn,Ui.disabled,Gt,ji.disabled,He,"clear",qe,wi,qr,Xn,yo,Do,bi,jt)}{const Gt=new Ui({func:xt.ALWAYS,mask:255},255,255,xt.KEEP,xt.KEEP,xt.REPLACE),bo=new ki([xt.ONE,xt.ONE,xt.ONE,xt.ONE],F.al.transparent,[!1,!1,!1,!0],xt.MIN);Gr(Le,Oe,Fe,je,Yn,Gt,bo,ji.disabled,He,"sdf",qe,wi,qr,Xn,yo,Do,bi,jt)}{const Gt=He?xt.ZERO:xt.ONE_MINUS_DST_ALPHA,bo=new Ui({func:xt.EQUAL,mask:255},255,255,xt.KEEP,xt.DECR,xt.DECR),Ro=new ki([Gt,xt.DST_ALPHA,xt.ONE_MINUS_DST_ALPHA,xt.ZERO],F.al.transparent,[!0,!0,!0,!0]);Gr(Le,Oe,Fe,je,Yn,bo,Ro,ji.disabled,He,"color",qe,wi,qr,Xn,yo,Do,bi,jt)}{const bo=new ki([xt.ONE,xt.ONE,xt.ONE,He?xt.ZERO:xt.ONE],F.al.transparent,[!1,!1,!1,!0],He?xt.FUNC_ADD:xt.MAX);Gr(Le,Oe,Fe,je,Yn,Ui.disabled,bo,ji.disabled,He,"clear",qe,wi,qr,Xn,yo,Do,bi,jt,Gt)}};if(bo||Do){let Oe;if(Le.prepareDrawTile(),jt){const Le=jt.drapeBufferSize[0],Fe=jt.drapeBufferSize[1];Oe=jt.framebufferCopyTexture,Oe&&(!Oe||Oe.size[0]===Le&&Oe.size[1]===Fe)||(Oe&&Oe.destroy(),Oe=jt.framebufferCopyTexture=new F.T(He,new F.r({width:Le,height:Fe}),xt.RGBA8)),Oe.bind(xt.LINEAR,xt.CLAMP_TO_EDGE),xt.copyTexSubImage2D(xt.TEXTURE_2D,0,0,0,0,0,Le,Fe)}bo&&c(!0,!1,Oe),Do&&c(!1,!0,Oe)}}else bo&&y(!0),Do&&y(!1),(bo||Do)&&Le.resetStencilClippingMasks()}}},hillshade:function(F,Le,Oe,Fe){if("offscreen"!==F.renderPass&&"translucent"!==F.renderPass)return;if(F.style.disableElevatedTerrain)return;const je=F.context,qe=F.terrain&&F.terrain.renderingToTexture,[He,xt]="translucent"!==F.renderPass||qe?[{},Fe]:F.stencilConfigForOverlap(Fe);for(const Fe of xt){const je=Le.getTile(Fe);if(je.needsHillshadePrepare&&"offscreen"===F.renderPass)Wo(F,je,Oe);else if("translucent"===F.renderPass){const Le=F.depthModeForSublayer(0,Bi.ReadOnly),xt=Oe.paint.get("hillshade-emissive-strength"),jt=F.colorModeForDrapableLayerRenderPass(xt),Gt=qe&&F.terrain?F.terrain.stencilModeForRTTOverlap(Fe):He[Fe.overscaledZ];Ho(F,Fe,je,Oe,Le,Gt,jt)}}je.viewport.set([0,0,F.width,F.height]),F.resetStencilClippingMasks()},raster:function(Le,Oe,Fe,je,qe,He){if("translucent"!==Le.renderPass)return;if(0===Fe.paint.get("raster-opacity"))return;const xt="globe"===Le.transform.projection.name,jt=0!==Fe.paint.get("raster-elevation"),Gt=jt&&xt;if(Le.renderElevatedRasterBackface&&!Gt)return;const bi=Le.context,wi=bi.gl,qr=Oe.getSource(),Xn=function(Le,Oe,Fe,je){const qe=Oe.paint.get("raster-color"),He="raster-array"===Le.type,xt=[],jt=Oe.paint.get("raster-resampling"),Gt=Oe.paint.get("raster-color-mix");let bi=Oe.paint.get("raster-color-range");const wi=[Gt[0],Gt[1],Gt[2],0],qr=Gt[3];let Xn="nearest"===jt?je.NEAREST:je.LINEAR;if(He&&(xt.push("RASTER_ARRAY"),qe||xt.push("RASTER_COLOR"),"linear"===jt&&xt.push("RASTER_ARRAY_LINEAR"),Xn=je.NEAREST,!bi&&Le.rasterLayers)){const F=Le.rasterLayers.find((({id:F})=>F===Oe.sourceLayer));F&&F.fields&&F.fields.range&&(bi=F.fields.range)}if(bi=bi||[0,1],qe){xt.push("RASTER_COLOR"),Fe.activeTexture.set(je.TEXTURE2),Oe.updateColorRamp(bi);let Le=Oe.colorRampTexture;Le||(Le=Oe.colorRampTexture=new F.T(Fe,Oe.colorRamp,je.RGBA8)),Le.bind(je.LINEAR,je.CLAMP_TO_EDGE)}return{mix:wi,range:bi,offset:qr,defines:xt,resampling:Xn}}(qr,Fe,bi,wi);if(qr instanceof F.aK&&!je.length&&!xt)return;const Yn=Fe.paint.get("raster-emissive-strength"),yo=Le.colorModeForDrapableLayerRenderPass(Yn),bo=Le.terrain&&Le.terrain.renderingToTexture,Do=!Le.options.moving,Ro="nearest"===Fe.paint.get("raster-resampling")?wi.NEAREST:wi.LINEAR;if(qr instanceof F.aK&&!je.length&&(qr.onNorthPole||qr.onSouthPole)){const F=jt?Le.stencilModeFor3D():Ui.disabled;return void Xr(!!qr.onNorthPole,null,Le,Oe,Fe,Yn,Xn,ji.disabled,F)}if(!je.length)return;const[zs,Zs]=qr instanceof F.aK||bo?[{},je]:Le.stencilConfigForOverlap(je),na=Zs[Zs.length-1].overscaledZ;Gt&&Xn.defines.push("PROJECTION_GLOBE_VIEW"),jt&&Xn.defines.push("RENDER_CUTOFF");const w=(je,qe,Zs)=>{for(const el of je){const je=el.toUnwrapped(),nl=Oe.getTile(el);if(bo&&(!nl||!nl.hasData()))continue;bi.activeTexture.set(wi.TEXTURE0);const hl=Yr(nl,qr,Fe,Xn);if(!hl||!hl.texture)continue;const{texture:pl,mix:bl,offset:Tl,tileSize:kl,buffer:ec}=hl;let tc,ic;bo?(tc=Bi.disabled,ic=el.projMatrix):jt?(tc=new Bi(wi.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D),ic=xt?Float32Array.from(Le.transform.expandedFarZProjMatrix):Le.transform.calculateProjMatrix(je,Do)):(tc=Le.depthModeForSublayer(el.overscaledZ-na,1===Fe.paint.get("raster-opacity")?Bi.ReadWrite:Bi.ReadOnly,wi.LESS),ic=Le.transform.calculateProjMatrix(je,Do));const oc=Le.terrain&&bo?Le.terrain.stencilModeForRTTOverlap(el):zs[el.overscaledZ],sc=He?0:Fe.paint.get("raster-fade-duration");nl.registerFadeDuration(sc);const ac=Oe.findLoadedParent(el,0),mc=Ns(nl,ac,Oe,Le.transform,sc);let gc,yc;Le.terrain&&Le.terrain.prepareDrawTile(),bi.activeTexture.set(wi.TEXTURE0),pl.bind(Ro,wi.CLAMP_TO_EDGE),bi.activeTexture.set(wi.TEXTURE1),ac?(ac.texture&&ac.texture.bind(Ro,wi.CLAMP_TO_EDGE),gc=Math.pow(2,ac.tileID.overscaledZ-nl.tileID.overscaledZ),yc=[nl.tileID.canonical.x*gc%1,nl.tileID.canonical.y*gc%1]):pl.bind(Ro,wi.CLAMP_TO_EDGE),"useMipmap"in pl&&bi.extTextureFilterAnisotropic&&Le.transform.pitch>20&&wi.texParameterf(wi.TEXTURE_2D,bi.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,bi.extTextureFilterAnisotropicMax);const xc=Le.transform;let Zc;const Wc=jt?Kr(xc):[0,0,0,0];let Kc,Jc,Qc,eh,th,rh=0;if(Gt&&qr instanceof F.aK&&qr.coordinates.length>3)Kc=Float32Array.from(F.bc(F.cI(new F.bT(0,0,0)))),Jc=Float32Array.from(xc.globeMatrix),Qc=Float32Array.from(F.cE(xc)),eh=[F.av(xc.center.lng),F.aC(xc.center.lat)],Zc=qr.elevatedGlobePerspectiveTransform,th=qr.elevatedGlobeGridMatrix||new Float32Array(9);else if(Gt){const Le=F.cF(el.canonical);rh=F.cG(Le.getCenter().lat),Kc=Float32Array.from(F.bc(F.cI(el.canonical))),Jc=Float32Array.from(xc.globeMatrix),Qc=Float32Array.from(F.cE(xc)),eh=[F.av(xc.center.lng),F.aC(xc.center.lat)],Zc=[0,0],th=Float32Array.from(F.cH(el.canonical,Le,rh,xc.worldSize/xc._pixelsPerMercatorPixel))}else Zc=qr instanceof F.aK?qr.perspectiveTransform:[0,0],Kc=new Float32Array(16),Jc=new Float32Array(9),Qc=new Float32Array(16),eh=[0,0],th=new Float32Array(9);const oh=dr(ic,Kc,Jc,Qc,th,yc||[0,0],F.ag(Le.transform.zoom),eh,Wc,gc||1,mc,Fe,Zc,jt?Fe.paint.get("raster-elevation"):0,2,bl,Tl,Xn.range,kl,ec,Yn),ah=Le.isTileAffectedByFog(el),lh=Le.getOrCreateProgram("raster",{defines:Xn.defines,overrideFog:ah});if(Le.uploadCommonUniforms(bi,lh,je),qr instanceof F.aK){const Oe=qr.elevatedGlobeVertexBuffer,je=qr.elevatedGlobeIndexBuffer;if(bo||!xt)qr.boundsBuffer&&qr.boundsSegments&&lh.draw(Le,wi.TRIANGLES,tc,Ui.disabled,yo,ji.disabled,oh,Fe.id,qr.boundsBuffer,Le.quadTriangleIndexBuffer,qr.boundsSegments);else if(Oe&&je){const He=xc.zoom<=F.c6?qr.elevatedGlobeSegments:qr.getSegmentsForLongitude(xc.center.lng);He&&lh.draw(Le,wi.TRIANGLES,tc,Ui.disabled,yo,qe,oh,Fe.id,Oe,je,He)}}else if(Gt){tc=new Bi(wi.LEQUAL,Bi.ReadOnly,Le.depthRangeFor3D);const F=Le.globeSharedBuffers;if(F){const[Oe,je,He]=F.getGridBuffers(rh,!1);lh.draw(Le,wi.TRIANGLES,tc,Zs||oc,Le.colorModeForRenderPass(),qe,oh,Fe.id,Oe,je,He)}}else{const{tileBoundsBuffer:F,tileBoundsIndexBuffer:Oe,tileBoundsSegments:je}=Le.getTileBoundsBuffers(nl);lh.draw(Le,wi.TRIANGLES,tc,oc,yo,ji.disabled,oh,Fe.id,F,Oe,je)}}if(!(qr instanceof F.aK)&&Gt)for(const F of je){const je=F.canonical.y===(1<<F.canonical.z)-1;0===F.canonical.y&&Xr(!0,F,Le,Oe,Fe,Yn,Xn,qe,Zs||Ui.disabled),je&&Xr(!1,F,Le,Oe,Fe,Yn,Xn,qe===ji.frontCW?ji.backCW:ji.frontCW,Zs||Ui.disabled)}};Gt?w(Zs,Le.renderElevatedRasterBackface?ji.backCW:ji.frontCW,Le.stencilModeFor3D()):w(Zs,ji.disabled,void 0),Le.resetStencilClippingMasks()},"raster-particle":function(Le,Oe,Fe,je,qe,He){"offscreen"===Le.renderPass&&function(Le,Oe,Fe,je){if(!je.length)return;const qe=Le.context,He=qe.gl,xt=Oe.getSource();if(!(xt instanceof ot))return;const jt=Math.ceil(Math.sqrt(Fe.paint.get("raster-particle-count")));let Gt=Fe.particlePositionRGBAImage;if(!Gt||Gt.width!==jt){const Le=function(F){const Le=F*F,Oe=new Uint8Array(4*Le),o=function(F){return F|=0,F=Math.imul(2747636419^F,2654435769),F=Math.imul(F^F>>>16,2654435769),((F=Math.imul(F^F>>>16,2654435769))>>>0)/4294967296},Fe=1/1.1;for(let F=0;F<Le;F++){const Le=Fe*(o(2*F+0)+yp),je=Fe*(o(2*F+1)+yp),qe=255*Le%1,He=255*je%1,xt=qe,jt=je-He/255,Gt=He;Oe[4*F+0]=255*(Le-qe/255),Oe[4*F+1]=255*xt,Oe[4*F+2]=255*jt,Oe[4*F+3]=255*Gt}return Oe}(jt);Gt=Fe.particlePositionRGBAImage=new F.r({width:jt,height:jt},Le)}let bi=Fe.particleFramebuffer;bi?bi.width!==jt&&(bi.destroy(),bi=Fe.particleFramebuffer=qe.createFramebuffer(jt,jt,!0,null)):bi=Fe.particleFramebuffer=qe.createFramebuffer(jt,jt,!0,null);const wi=[];for(const F of je){const Le=Oe.getTile(F);if(!(Le instanceof wt))continue;const je=en(Le,xt,Fe);if(!je)continue;const He=[Le.tileSize,Le.tileSize];let bi=Fe.tileFramebuffer;bi||(bi=Fe.tileFramebuffer=qe.createFramebuffer(He[0],He[1],!0,null));let qr=Le.rasterParticleState;qr||(qr=Le.rasterParticleState=new Qr(qe,F,He,Gt));const Xn=qr.update(Fe.lastInvalidatedAt);qr.particleTextureDimension!==jt&&qr.updateParticleTexture(F,Gt);const Yn=qr.targetColorTexture;qr.targetColorTexture=qr.backgroundColorTexture,qr.backgroundColorTexture=Yn;const yo=qr.particleTexture0;qr.particleTexture0=qr.particleTexture1,qr.particleTexture1=yo,wi.push([F,je,qr,Xn])}if(0===wi.length)return;const qr=F.q.now(),Xn=Fe.previousDrawTimestamp?.001*(qr-Fe.previousDrawTimestamp):.0167;if(Fe.previousDrawTimestamp=qr,Fe.hasColorMap()){qe.activeTexture.set(He.TEXTURE0+2);let Le=Fe.colorRampTexture;Le||(Le=Fe.colorRampTexture=new F.T(qe,Fe.colorRamp,He.RGBA8)),Le.bind(He.LINEAR,He.CLAMP_TO_EDGE)}qe.bindFramebuffer.set(Fe.tileFramebuffer.framebuffer),function(Le,Oe,Fe){const je=Le.context,qe=je.gl,He=Oe.tileFramebuffer;je.activeTexture.set(qe.TEXTURE0);const xt={u_texture:0,u_opacity:1.05*(Gt=Oe.paint.get("raster-particle-fade-opacity-factor"))/(Gt+.05)},jt=Le.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Gt;for(const Gt of Fe){const[,,Fe,bi]=Gt;He.colorAttachment.set(Fe.targetColorTexture.texture),je.viewport.set([0,0,He.width,He.height]),je.clear({color:F.al.transparent}),bi&&(Fe.backgroundColorTexture.bind(qe.NEAREST,qe.CLAMP_TO_EDGE),jt.draw(Le,qe.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,xt,Oe.id,Le.viewportBuffer,Le.quadTriangleIndexBuffer,Le.viewportSegments))}}(Le,Fe,wi),function(Le,Oe,Fe,je){const qe=Le.context,He=qe.gl,xt=Fe.tileFramebuffer,jt="globe"===Le.transform.projection.name,Gt=Fe.paint.get("raster-particle-max-speed");for(const bi of je){const[je,wi,qr]=bi;qe.activeTexture.set(He.TEXTURE0+0),wi.texture.bind(He.LINEAR,He.CLAMP_TO_EDGE),xt.colorAttachment.set(qr.targetColorTexture.texture);const Xn=Le.getOrCreateProgram("rasterParticleDraw",{defines:wi.defines,overrideFog:!1});qe.activeTexture.set(He.TEXTURE0+1);const Yn=wi.scalarData?[]:[0,1,2,3].map((Le=>F.d7[Le](je)));Yn.push(je);const yo=je.canonical.x,bo=je.canonical.y;for(const F of Yn){const qe=Oe.getTile(jt?F.wrapped():F);if(!qe)continue;const xt=qe.rasterParticleState;if(!xt)continue;const bi=F.canonical.x+(1<<F.canonical.z)*(F.wrap-je.wrap),qr=F.canonical.y;xt.particleTexture0.bind(He.NEAREST,He.CLAMP_TO_EDGE);const Yn=fr(1,xt.particleTexture0.size[0],[bi-yo,qr-bo],0,wi.texture.size,2,Gt,wi.textureOffset,wi.scale,wi.offset);Xn.draw(Le,He.POINTS,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,Yn,Fe.id,xt.particleIndexBuffer,void 0,xt.particleSegment)}}}(Le,Oe,Fe,wi),qe.bindFramebuffer.set(Fe.particleFramebuffer.framebuffer),function(Le,Oe,Fe,je){const qe=Le.context,He=qe.gl,xt=Oe.paint.get("raster-particle-max-speed"),jt=je*Oe.paint.get("raster-particle-speed-factor")*.15,Gt=function(F){return Math.pow(F,6)}(.01+1*Oe.paint.get("raster-particle-reset-rate-factor")),bi=Oe.particleFramebuffer;qe.viewport.set([0,0,bi.width,bi.height]);for(const je of Fe){const[,Fe,wi]=je;qe.activeTexture.set(He.TEXTURE0+0),Fe.texture.bind(He.LINEAR,He.CLAMP_TO_EDGE),qe.activeTexture.set(He.TEXTURE0+1);const qr=wi.particleTexture0;qr.bind(He.NEAREST,He.CLAMP_TO_EDGE);const Xn=mr(1,qr.size[0],0,Fe.texture.size,xt,jt,Gt,Fe.textureOffset,Fe.scale,Fe.offset);bi.colorAttachment.set(wi.particleTexture1.texture),qe.clear({color:F.al.transparent}),Le.getOrCreateProgram("rasterParticleUpdate",{defines:Fe.defines}).draw(Le,He.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.disabled,Xn,Oe.id,Le.viewportBuffer,Le.quadTriangleIndexBuffer,Le.viewportSegments)}}(Le,Fe,wi,Xn)}(Le,Oe,Fe,je),"translucent"===Le.renderPass&&(function(Le,Oe,Fe,je){const qe=Le.context,He=qe.gl,xt=Oe.getSource().tileSize,jt=5*(1-F.ae(F.bY,F.bY+1,Le.transform.zoom))*xt+Fe.paint.get("raster-particle-elevation"),Gt=!Le.options.moving,bi="globe"===Le.transform.projection.name;if(!je.length)return;const[wi,qr]=Le.stencilConfigForOverlap(je),Xn=[];bi&&Xn.push("PROJECTION_GLOBE_VIEW");const Yn=Le.stencilModeFor3D();for(const je of qr){const xt=je.toUnwrapped(),qr=Oe.getTile(je);if(!qr.rasterParticleState)continue;const yo=qr.rasterParticleState,bo=100;qr.registerFadeDuration(bo);const Do=Oe.findLoadedParent(je,0),Ro=Ns(qr,Do,Oe,Le.transform,bo);let zs,Zs;Le.terrain&&Le.terrain.prepareDrawTile(),qe.activeTexture.set(He.TEXTURE0),yo.targetColorTexture.bind(He.LINEAR,He.CLAMP_TO_EDGE),qe.activeTexture.set(He.TEXTURE1),Do&&Do.rasterParticleState?(Do.rasterParticleState.targetColorTexture.bind(He.LINEAR,He.CLAMP_TO_EDGE),zs=Math.pow(2,Do.tileID.overscaledZ-qr.tileID.overscaledZ),Zs=[qr.tileID.canonical.x*zs%1,qr.tileID.canonical.y*zs%1]):yo.targetColorTexture.bind(He.LINEAR,He.CLAMP_TO_EDGE);const na=bi?Float32Array.from(Le.transform.expandedFarZProjMatrix):Le.transform.calculateProjMatrix(xt,Gt),el=Le.transform,nl=tn(el),hl=F.cF(je.canonical),pl=F.cG(hl.getCenter().lat);let bl,Tl,kl,ec,tc;bi?(bl=Float32Array.from(F.bc(F.cI(je.canonical))),Tl=Float32Array.from(el.globeMatrix),kl=Float32Array.from(F.cE(el)),ec=[F.av(el.center.lng),F.aC(el.center.lat)],tc=Float32Array.from(F.cH(je.canonical,hl,pl,el.worldSize/el._pixelsPerMercatorPixel))):(bl=new Float32Array(16),Tl=new Float32Array(9),kl=new Float32Array(16),ec=[0,0],tc=new Float32Array(9));const ic=pr(na,bl,Tl,kl,tc,Zs||[0,0],F.ag(Le.transform.zoom),ec,nl,zs||1,Ro,jt),oc=Le.isTileAffectedByFog(je),sc=Le.getOrCreateProgram("rasterParticle",{defines:Xn,overrideFog:oc});if(Le.uploadCommonUniforms(qe,sc,xt),bi){const F=new Bi(He.LEQUAL,Bi.ReadOnly,Le.depthRangeFor3D),Oe=0,je=Le.globeSharedBuffers;if(je){const[qe,xt,jt]=je.getGridBuffers(pl,0!==Oe);sc.draw(Le,He.TRIANGLES,F,Yn,ki.alphaBlended,Le.renderElevatedRasterBackface?ji.frontCCW:ji.backCCW,ic,Fe.id,qe,xt,jt)}}else{const F=Le.depthModeForSublayer(0,Bi.ReadOnly),Oe=wi[je.overscaledZ],{tileBoundsBuffer:qe,tileBoundsIndexBuffer:xt,tileBoundsSegments:jt}=Le.getTileBoundsBuffers(qr);sc.draw(Le,He.TRIANGLES,F,Oe,ki.alphaBlended,ji.disabled,ic,Fe.id,qe,xt,jt)}}Le.resetStencilClippingMasks()}(Le,Oe,Fe,je),Le.style.map.triggerRepaint())},background:function(Le,Oe,Fe,je){const qe=Fe.paint.get("background-color"),He="none"===Fe.paint.get("background-color-use-theme").constantOr("default"),xt=Fe.paint.get("background-opacity"),jt=Fe.paint.get("background-emissive-strength"),Gt="viewport"===Fe.paint.get("background-pitch-alignment");if(0===xt)return;const bi=Le.context,wi=bi.gl,qr=Le.transform,Xn=qr.tileSize,Yn=Fe.paint.get("background-pattern");let yo;if(void 0!==Yn){if(null===Yn)return;if(yo=Le.imageManager.getPattern(F.I.from(Yn.toString()),Fe.scope,Le.style.getLut(Fe.scope)),!yo)return}const bo=!Yn&&1===qe.a&&1===xt&&Le.opaquePassEnabledForLayer()?"opaque":"translucent";if(Le.renderPass!==bo)return;const Do=Ui.disabled,Ro=Le.depthModeForSublayer(0,"opaque"===bo?Bi.ReadWrite:Bi.ReadOnly),zs=Le.colorModeForDrapableLayerRenderPass(jt),Zs=Yn?"backgroundPattern":"background";let na,el=je;if(el||(na=Le.getBackgroundTiles(),el=Object.values(na).map((F=>F.tileID))),Yn&&(bi.activeTexture.set(wi.TEXTURE0),Le.imageManager.bind(Le.context,Fe.scope)),Gt){const Oe=Le.getOrCreateProgram(Zs,{overrideFog:!1,overrideRtt:!0}),je=new Float32Array(F.ad.mat4.identity([])),bi=new F.aH(0,0,0,0,0),qr=Yn?xr(je,jt,xt,Le,0,Fe.scope,yo,Gt,{tileID:bi,tileSize:Xn}):yr(je,jt,xt,qe.toRenderColor(He?null:Fe.lut));Oe.draw(Le,wi.TRIANGLES,Ro,Do,zs,ji.disabled,qr,Fe.id,Le.viewportBuffer,Le.quadTriangleIndexBuffer,Le.viewportSegments)}else for(const F of el){const bo=Le.isTileAffectedByFog(F),el=Le.getOrCreateProgram(Zs,{overrideFog:bo}),nl=F.toUnwrapped(),hl=je?F.projMatrix:Le.transform.calculateProjMatrix(nl);Le.prepareDrawTile();const pl=Oe?Oe.getTile(F):na?na[F.key]:new bt(F,Xn,qr.zoom,Le),bl=Yn?xr(hl,jt,xt,Le,0,Fe.scope,yo,Gt,{tileID:F,tileSize:Xn}):yr(hl,jt,xt,qe.toRenderColor(He?null:Fe.lut));Le.uploadCommonUniforms(bi,el,nl);const{tileBoundsBuffer:Tl,tileBoundsIndexBuffer:kl,tileBoundsSegments:ec}=Le.getTileBoundsBuffers(pl);el.draw(Le,wi.TRIANGLES,Ro,Do,zs,ji.disabled,bl,Fe.id,Tl,kl,ec)}},sky:function(Le,Oe,Fe){const je=Le._atmosphere?F.ag(Le.transform.zoom):1,qe=Fe.paint.get("sky-opacity")*je;if(0===qe)return;const He=Le.context,xt=Fe.paint.get("sky-type"),jt=new Bi(He.gl.LEQUAL,Bi.ReadOnly,[0,1]),Gt=Le.frameCounter/1e3%1;"atmosphere"===xt?"offscreen"===Le.renderPass?Fe.needsSkyboxCapture(Le)&&(function(Le,Oe){const Fe=Le.context,je=Fe.gl;let qe=Oe.skyboxFbo;if(!qe){qe=Oe.skyboxFbo=Fe.createFramebuffer(32,32,!0,null),Oe.skyboxGeometry=new fn(Fe),Oe.skyboxTexture=Fe.gl.createTexture(),je.bindTexture(je.TEXTURE_CUBE_MAP,Oe.skyboxTexture),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_WRAP_S,je.CLAMP_TO_EDGE),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_WRAP_T,je.CLAMP_TO_EDGE),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_MIN_FILTER,je.LINEAR),je.texParameteri(je.TEXTURE_CUBE_MAP,je.TEXTURE_MAG_FILTER,je.LINEAR);for(let F=0;F<6;++F)je.texImage2D(je.TEXTURE_CUBE_MAP_POSITIVE_X+F,0,je.RGBA,32,32,0,je.RGBA,je.UNSIGNED_BYTE,null)}Fe.bindFramebuffer.set(qe.framebuffer),Fe.viewport.set([0,0,32,32]);const He=Oe.getCenter(Le,!0),xt=Le.getOrCreateProgram("skyboxCapture"),jt=new Float64Array(16);F.ad.mat4.identity(jt),F.ad.mat4.rotateY(jt,jt,.5*-Math.PI),mn(Le,Oe,xt,jt,He,0),F.ad.mat4.identity(jt),F.ad.mat4.rotateY(jt,jt,.5*Math.PI),mn(Le,Oe,xt,jt,He,1),F.ad.mat4.identity(jt),F.ad.mat4.rotateX(jt,jt,.5*-Math.PI),mn(Le,Oe,xt,jt,He,2),F.ad.mat4.identity(jt),F.ad.mat4.rotateX(jt,jt,.5*Math.PI),mn(Le,Oe,xt,jt,He,3),F.ad.mat4.identity(jt),mn(Le,Oe,xt,jt,He,4),F.ad.mat4.identity(jt),F.ad.mat4.rotateY(jt,jt,Math.PI),mn(Le,Oe,xt,jt,He,5),Fe.viewport.set([0,0,Le.width,Le.height])}(Le,Fe),Fe.markSkyboxValid(Le)):"sky"===Le.renderPass&&function(F,Le,Oe,Fe,je){const qe=F.context,He=qe.gl,xt=F.transform,jt=F.getOrCreateProgram("skybox");qe.activeTexture.set(He.TEXTURE0),He.bindTexture(He.TEXTURE_CUBE_MAP,Le.skyboxTexture);const Gt=((F,Le,Oe,Fe,je)=>({u_matrix:F,u_sun_direction:Le,u_cubemap:0,u_opacity:Fe,u_temporal_offset:je}))(xt.skyboxMatrix,Le.getCenter(F,!1),0,Fe,je);F.uploadCommonUniforms(qe,jt),jt.draw(F,He.TRIANGLES,Oe,Ui.disabled,F.colorModeForRenderPass(),ji.backCW,Gt,"skybox",Le.skyboxGeometry.vertexBuffer,Le.skyboxGeometry.indexBuffer,Le.skyboxGeometry.segment)}(Le,Fe,jt,qe,Gt):"gradient"===xt&&"sky"===Le.renderPass&&function(Le,Oe,Fe,je,qe){const He=Le.context,xt=He.gl,jt=Le.transform,Gt=Le.getOrCreateProgram("skyboxGradient");Oe.skyboxGeometry||(Oe.skyboxGeometry=new fn(He)),He.activeTexture.set(xt.TEXTURE0);let bi=Oe.colorRampTexture;bi||(bi=Oe.colorRampTexture=new F.T(He,Oe.colorRamp,xt.RGBA8)),bi.bind(xt.LINEAR,xt.CLAMP_TO_EDGE);const wi=((Le,Oe,Fe,je,qe)=>({u_matrix:Le,u_color_ramp:0,u_center_direction:Oe,u_radius:F.ak(Fe),u_opacity:je,u_temporal_offset:qe}))(jt.skyboxMatrix,Oe.getCenter(Le,!1),Oe.paint.get("sky-gradient-radius"),je,qe);Le.uploadCommonUniforms(He,Gt),Gt.draw(Le,xt.TRIANGLES,Fe,Ui.disabled,Le.colorModeForRenderPass(),ji.backCW,wi,"skyboxGradient",Oe.skyboxGeometry.vertexBuffer,Oe.skyboxGeometry.indexBuffer,Oe.skyboxGeometry.segment)}(Le,Fe,jt,qe,Gt)},debug:function(Le,Oe,Fe,je,qe,He){for(let xt=0;xt<Fe.length;xt++)if(qe){const qe=1,jt=.8,Gt=new F.al(je.r*jt,je.g*jt,je.b*jt,1);ln(Le,Oe,Fe[xt],je,-qe,-qe,He),ln(Le,Oe,Fe[xt],je,-qe,qe,He),ln(Le,Oe,Fe[xt],je,qe,qe,He),ln(Le,Oe,Fe[xt],je,qe,-qe,He),ln(Le,Oe,Fe[xt],Gt,0,0,He)}else ln(Le,Oe,Fe[xt],je,0,0,He)},custom:function(Le,Oe,Fe,je){const qe=Le.context,He=Fe.implementation;if(!Le.transform.projection.unsupportedLayers||!Le.transform.projection.unsupportedLayers.includes("custom")||Le.terrain&&(Le.terrain.renderingToTexture||"offscreen"===Le.renderPass)&&Fe.isDraped(Oe)){if("offscreen"===Le.renderPass){const Oe=He.prerender;if(Oe){if(Le.setCustomLayerDefaults(),qe.setColorMode(Le.colorModeForRenderPass()),"globe"===Le.transform.projection.name){const Fe=Le.transform.pointMerc;Oe.call(He,qe.gl,Le.transform.customLayerMatrix(),Le.transform.getProjection(),Le.transform.globeToMercatorMatrix(),F.ag(Le.transform.zoom),[Fe.x,Fe.y],Le.transform.pixelsPerMeterRatio)}else Oe.call(He,qe.gl,Le.transform.customLayerMatrix());qe.setDirty(),Le.setBaseState()}}else if("translucent"===Le.renderPass){if(Le.terrain&&Le.terrain.renderingToTexture){const Oe=He.renderToTile;if(Oe){const Fe=je[0].canonical,xt=new F.ac(Fe.x+je[0].wrap*(1<<Fe.z),Fe.y,Fe.z);qe.setDepthMode(Bi.disabled),qe.setStencilMode(Ui.disabled),qe.setColorMode(Le.colorModeForRenderPass()),Le.setCustomLayerDefaults(),Oe.call(He,qe.gl,xt),qe.setDirty(),Le.setBaseState()}return}Le.setCustomLayerDefaults(),qe.setColorMode(Le.colorModeForRenderPass()),qe.setStencilMode(Ui.disabled);const Oe="3d"===He.renderingMode?new Bi(Le.context.gl.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D):Le.depthModeForSublayer(0,Bi.ReadOnly);if(qe.setDepthMode(Oe),"globe"===Le.transform.projection.name){const Oe=Le.transform.pointMerc;He.render(qe.gl,Le.transform.customLayerMatrix(),Le.transform.getProjection(),Le.transform.globeToMercatorMatrix(),F.ag(Le.transform.zoom),[Oe.x,Oe.y],Le.transform.pixelsPerMeterRatio)}else He.render(qe.gl,Le.transform.customLayerMatrix());qe.setDirty(),Le.setBaseState(),qe.bindFramebuffer.set(null)}}else F.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(Le,Oe,Fe,je){if("opaque"===Le.renderPass)return;const qe=Fe.paint.get("model-opacity").constantOr(1);if(0===qe)return;const He=Fe.paint.get("model-cast-shadows");if("shadow"===Le.renderPass){if(!He)return;if(Le.terrain&&qe<.65&&Fe._transitionablePaint._values["model-opacity"].value.expression instanceof F.ab)return}const xt=Le.shadowRenderer,jt=Fe.paint.get("model-receive-shadows");xt&&(xt.useNormalOffset=!0,jt||(xt.enabled=!1));const c=()=>{xt&&(xt.useNormalOffset=!0,jt||(xt.enabled=!0))},Gt=Oe.getSource();if("light-beam"===Le.renderPass&&"batched-model"!==Gt.type)return;if("vector"===Gt.type||"geojson"===Gt.type)return function(Le,Oe,Fe,je,qe){const He=Le.transform;if("mercator"!==He.projection.name)return void F.w(`Drawing 3D models for ${He.projection.name} projection is not yet implemented`);const xt=He.getFreeCameraOptions().position;if(!Le.modelManager)return;const jt=Le.modelManager;Fe.modelManager=jt;const Gt=Le.shadowRenderer;if(!Fe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const bi=Fe._unevaluatedLayout._values["model-id"],wi=Object.assign({},Fe.layout.get("model-id").parameters),qr=Le.style.order.indexOf(Fe.fqid);for(const Xn of je){const je=Oe.getTile(Xn).getBucket(Fe);if(!je||je.projection.name!==He.projection.name)continue;const Yn=je.getModelUris();Yn&&!je.modelsRequested&&(jt.addModelsFromBucket(Yn,qe),je.modelsRequested=!0);const yo=Dn(Xn,He);wi.zoom=yo;const bo=bi.possiblyEvaluate(wi);if(In(Le,je,Xn),uf.shadowUniformsInitialized=!1,uf.useSingleShadowCascade=!!Gt&&0===Gt.getMaxCascadeForTile(Xn.toUnwrapped()),"shadow"===Le.renderPass&&Gt){if(1===Le.currentShadowCascade&&je.isInsideFirstShadowMapFrustum)continue;const Oe=He.calculatePosMatrix(Xn.toUnwrapped(),He.worldSize);if(uf.tileMatrix.set(Oe),uf.shadowTileMatrix=Float32Array.from(Gt.calculateShadowPassMatrixFromMatrix(Oe)),uf.aabb.min.fill(0),uf.aabb.max[0]=uf.aabb.max[1]=F.ai,uf.aabb.max[2]=0,Mn(je,uf,Le,Fe.scope))continue}const Do=1<<Xn.canonical.z,Ro=[((xt.x-Xn.wrap)*Do-Xn.canonical.x)*F.ai,(xt.y*Do-Xn.canonical.y)*F.ai,xt.z*Do*F.ai];Le.conflationActive&&Object.keys(je.instancesPerModel).length>0&&Le.style.isLayerClipped(Fe,Oe.getSource())&&je.updateReplacement(Xn,Le.replacementSource,qr,qe)&&(je.uploaded=!1,je.upload(Le.context));for(let F in je.instancesPerModel){const Oe=je.instancesPerModel[F];Oe.features.length>0&&(F=bo.evaluate(Oe.features[0].feature,{}));const He=jt.getModel(F,qe);if(He&&He.uploaded)for(const F of He.nodes)An(Le,Fe,F,Oe,Ro,Xn,uf)}}}(Le,Oe,Fe,je,"vector"===Gt.type?Fe.scope:""),void c();if(!Gt.loaded())return;if("batched-model"===Gt.type)return function(Le,Oe,Fe,je){Fe.resetLayerRenderingStats(Le);const qe=Le.context,He=Le.transform,xt=Le.style.fog,jt=Le.shadowRenderer;if("mercator"!==He.projection.name)return void F.w(`Drawing 3D landmark models for ${He.projection.name} projection is not yet implemented`);const Gt=Le.transform.getFreeCameraOptions().position,bi=F.ad.vec3.scale([],[Gt.x,Gt.y,Gt.z],Le.transform.worldSize),wi=F.ad.vec3.negate([],bi),qr=F.ad.mat4.identity([]),Xn=F.dm(He.center.lat,He.zoom),Yn=F.ad.mat4.fromScaling([],[1,1,1/Xn]);F.ad.mat4.translate(qr,qr,wi);const yo=Fe.paint.get("model-opacity").constantOr(1),bo=new Bi(qe.gl.LEQUAL,Bi.ReadWrite,Le.depthRangeFor3D),Do=new Bi(qe.gl.LEQUAL,Bi.ReadOnly,Le.depthRangeFor3D),Ro=new F.ce([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),zs="shadow"===Le.renderPass,Zs=zs&&jt?jt.getCurrentCascadeFrustum():He.getFrustum(He.scaleZoom(He.worldSize)),na=Fe.paint.get("model-front-cutoff"),el=na[2]<1,nl=Qi(Le,Fe.paint.get("model-cutoff-fade-range")),hl=Fe.getLayerRenderingStats();(function(F,Le,Oe,Fe){const je=F.terrain?F.terrain.exaggeration():0,qe=F.transform.zoom;for(const He of Fe){const Fe=Le.getTile(He).getBucket(Oe);Fe&&(Fe.setFilter(Oe.filter),F.conflationActive&&Fe.updateReplacement(He,F.replacementSource),Fe.evaluateScale(F,Oe),F.terrain&&je>0&&Fe.elevationUpdate(F.terrain,je,He,Oe.source),Fe.needsReEvaluation(F,qe,Oe)&&Fe.evaluate(Oe))}})(Le,Oe,Fe,je),function(){let Gt,wi,pl;el?(Gt=je.length-1,wi=-1,pl=-1):(Gt=0,wi=je.length,pl=1);const bl=new Float64Array(16),Tl=F.ad.vec3.create(),kl=new F.P(0,0);for(let ec=Gt;ec!==wi;ec+=pl){const Gt=je[ec],wi=Oe.getTile(Gt).getBucket(Fe);if(!wi||!wi.uploaded)continue;let pl=!1;jt&&(pl=0===jt.getMaxCascadeForTile(Gt.toUnwrapped()));const tc=He.calculatePosMatrix(Gt.toUnwrapped(),He.worldSize),oc=wi.modelTraits;!zs&&el&&(F.ad.mat4.invert(bl,tc),F.ad.vec3.transformMat4(Tl,bi,bl),kl.x=Tl[0],kl.y=Tl[1]);const sc=[];wi.setFilter(Fe.filter);for(const Oe of wi.getNodesInfo()){if(Oe.hiddenByReplacement)continue;if(!Oe.node.meshes)continue;const Fe=Oe.node;let je=0;Le.terrain&&Fe.elevation&&(je=Fe.elevation*Le.terrain.exaggeration());const qe=(()=>{const Le=Oe.aabb;return Ro.min=[...Le.min],Ro.max=[...Le.max],Ro.min[2]+=je,Ro.max[2]+=je,F.ad.vec3.transformMat4(Ro.min,Ro.min,tc),F.ad.vec3.transformMat4(Ro.max,Ro.max,tc),Ro})(),xt=Oe.evaluatedScale;if(xt[0]<=1&&xt[1]<=1&&xt[2]<=1&&0===qe.intersects(Zs))continue;if(!zs&&el){const Le=1/6;Oe.cameraCollisionOpacity=bi[0]>qe.min[0]&&bi[0]<qe.max[0]&&bi[1]>qe.min[1]&&bi[1]<qe.max[1]&&bi[2]*Xn<qe.max[2]&&Fe.footprint&&F.bA(kl,Fe.footprint)?Math.max(Oe.cameraCollisionOpacity-Le,0):Math.min(1,Oe.cameraCollisionOpacity+Le)}const jt=[...tc],Gt=Fe.anchor?Fe.anchor[0]:0,wi=Fe.anchor?Fe.anchor[1]:0;F.ad.mat4.translate(jt,jt,[Gt*(xt[0]-1),wi*(xt[1]-1),je]),F.ad.vec3.exactEquals(xt,F.dq)||F.ad.mat4.scale(jt,jt,xt);const qr=F.ad.mat4.multiply([],jt,Fe.matrix),Yn=F.ad.mat4.multiply([],He.expandedFarZProjMatrix,qr),bo=F.ad.mat4.multiply([],He.expandedFarZProjMatrix,jt),Do=F.ad.vec4.transformMat4([],[Gt,wi,je,1],Yn)[2];Fe.hidden=!1;let hl=yo;zs||(el&&(hl*=Oe.cameraCollisionOpacity,hl*=zn(jt,He,Oe.aabb,na)),hl*=Pn(nl,Do)),0!==hl?sc.push({nodeInfo:Oe,depth:Do,opacity:hl,wvpForNode:Yn,wvpForTile:bo,nodeModelMatrix:qr,tileModelMatrix:jt}):Fe.hidden=!0}zs||sc.sort(((F,Le)=>!el||1===F.opacity&&1===Le.opacity?F.depth<Le.depth?-1:1:1===F.opacity?-1:1===Le.opacity?1:F.depth>Le.depth?-1:1));for(const Oe of sc){const je=Oe.nodeInfo,Gt=je.node;let bi=F.ad.mat4.multiply([],Yn,Oe.tileModelMatrix);F.ad.mat4.multiply(bi,qr,bi);const wi=F.ad.mat4.invert([],bi);F.ad.mat4.transpose(wi,wi),F.ad.mat4.scale(wi,wi,df),bi=F.ad.mat4.multiply(bi,bi,Gt.matrix);const Xn="light-beam"===Le.renderPass,yo="none"===Fe.paint.get("model-color-use-theme").constantOr("default"),Ro=oc&F.ds.HasMapboxMeshFeatures,Zs=Ro?0:je.evaluatedRMEA[0][2];for(let F=0;F<Gt.meshes.length;++F){const qr=Gt.meshes[F],Yn=F===Gt.lightMeshIndex;let na=Oe.wvpForNode;if(Yn){if(!Xn&&!Le.terrain&&Le.shadowRenderer){Le.currentLayer<Le.firstLightBeamLayer&&(Le.firstLightBeamLayer=Le.currentLayer);continue}na=Oe.wvpForTile}else if(Xn)continue;const el={defines:[]},nl=[];if(!zs&&jt&&(jt.useNormalOffset=!!qr.normalBuffer),Tn(el.defines,nl,qr,Le,yo?null:Fe.lut),Ro||el.defines.push("DIFFUSE_SHADED"),pl&&el.defines.push("SHADOWS_SINGLE_CASCADE"),hl&&(zs?hl.numRenderedVerticesInShadowPass+=qr.vertexArray.length:hl.numRenderedVerticesInTransparentPass+=qr.vertexArray.length),zs){Cn(qr,Oe.nodeModelMatrix,Le,Fe);continue}let bl=null;if(xt){const F=wn(Oe.nodeModelMatrix,Le.transform);if(bl=new Float32Array(F),"globe"!==He.projection.name){const Le=qr.aabb.min,Oe=qr.aabb.max,[Fe,je]=xt.getOpacityForBounds(F,Le[0],Le[1],Oe[0],Oe[1]);el.overrideFog=Fe>=ic||je>=ic}}const Tl=qr.material;let kl;Tl.occlusionTexture&&Tl.occlusionTexture.offsetScale&&(kl=Tl.occlusionTexture.offsetScale,el.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const ec=Le.getOrCreateProgram("model",el);!zs&&jt&&jt.setupShadowsFromMatrix(Oe.tileModelMatrix,ec,jt.useNormalOffset),Le.uploadCommonUniforms(qe,ec,null,bl);const tc=Tl.pbrMetallicRoughness;tc.metallicFactor=.9,tc.roughnessFactor=.5;const oc=wr(new Float32Array(na),new Float32Array(bi),new Float32Array(wi),new Float32Array(Gt.matrix),Le,Oe.opacity,tc.baseColorFactor.toRenderColor(null),Tl.emissiveFactor,tc.metallicFactor,tc.roughnessFactor,Tl,Zs,Fe,[0,0,0],kl);!Yn&&(je.hasTranslucentParts||Oe.opacity<1)&&ec.draw(Le,qe.gl.TRIANGLES,bo,Ui.disabled,ki.disabled,ji.backCCW,oc,Fe.id,qr.vertexBuffer,qr.indexBuffer,qr.segments,Fe.paint,Le.transform.zoom,void 0,nl),ec.draw(Le,qe.gl.TRIANGLES,Yn?Do:bo,Ui.disabled,Yn||Oe.opacity<1||je.hasTranslucentParts?ki.alphaBlended:ki.unblended,ji.backCCW,oc,Fe.id,qr.vertexBuffer,qr.indexBuffer,qr.segments,Fe.paint,Le.transform.zoom,void 0,nl)}}}}()}(Le,Oe,Fe,je),void c();if("model"!==Gt.type)return;const bi=Gt.getModels(),wi=[],qr=Le.transform.getFreeCameraOptions().position,Xn=F.ad.vec3.scale([],[qr.x,qr.y,qr.z],Le.transform.worldSize);F.ad.vec3.negate(Xn,Xn);const Yn=[],yo=[];let bo=0;for(const Oe of bi){const je=Fe.paint.get("model-rotation").constantOr(null),qe=Fe.paint.get("model-scale").constantOr(null),He=Fe.paint.get("model-translation").constantOr(null);Oe.computeModelMatrix(Le,je,qe,He,!0,!0,!1);const xt=F.ad.mat4.identity([]),jt=F.dm(Oe.position.lat,Le.transform.zoom),Gt=F.ad.mat4.fromScaling([],[1,1,1/jt]);F.ad.mat4.translate(xt,xt,Xn),wi.push({zScaleMatrix:Gt,negCameraPosMatrix:xt});for(const F of Oe.nodes)Sn(Le.transform,F,Oe.matrix,Le.transform.expandedFarZProjMatrix,bo,Yn,yo);bo++}if(Yn.sort(((F,Le)=>Le.depth-F.depth)),"shadow"!==Le.renderPass){if(1===qe)for(const F of yo)En(F,Le,Fe,wi[F.modelIndex],Ui.disabled,Le.colorModeForRenderPass());else{for(const F of yo)En(F,Le,Fe,wi[F.modelIndex],Ui.disabled,ki.disabled);for(const F of yo)En(F,Le,Fe,wi[F.modelIndex],Le.stencilModeFor3D(),Le.colorModeForRenderPass());Le.resetStencilClippingMasks()}for(const F of Yn)En(F,Le,Fe,wi[F.modelIndex],Ui.disabled,Le.colorModeForRenderPass());c()}else{for(const F of yo)Cn(F.mesh,F.nodeModelMatrix,Le,Fe);for(const F of Yn)Cn(F.mesh,F.nodeModelMatrix,Le,Fe);c()}}},yf={line:function(F,Le,Oe){if(F.hasElevatedBuckets=!1,F.hasNonElevatedBuckets=!1,void 0!==F._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==F._unevaluatedLayout.getValue("line-z-offset")){if(Le){const Oe=Le.getVisibleCoordinates();for(const Fe of Oe){const Oe=Le.getTile(Fe).getBucket(F);if(Oe&&(Oe.hasZOffset?F.hasElevatedBuckets=!0:F.hasNonElevatedBuckets=!0,F.hasElevatedBuckets&&F.hasNonElevatedBuckets))break}}}else F.hasNonElevatedBuckets=!0},model:function(F,Le,Oe){const Fe=Le.getSource();if(!Fe.loaded())return;if("vector"===Fe.type||"geojson"===Fe.type)return void(Oe.modelManager&&Oe.modelManager.upload(Oe,"vector"===Fe.type?F.scope:""));if("batched-model"===Fe.type)return;if("model"!==Fe.type)return;const je=Fe.getModels();for(const F of je)F.upload(Oe.context)},raster:function(F,Le,Oe){const Fe=Le.getSource();if(!(Fe instanceof ot&&Fe.loaded()))return;const je=F.sourceLayer||Fe.rasterLayerIds&&Fe.rasterLayerIds[0];if(!je)return;const qe=F.paint.get("raster-array-band")||Fe.getInitialBand(je);if(null==qe)return;const He=Le.getIds().map((F=>Le.getTileByID(F)));for(const F of He)F.updateNeeded(je,qe)&&Fe.prepareTile(F,je,qe)},"raster-particle":function(F,Le,Oe){const Fe=Le.getSource();if(!(Fe instanceof ot&&Fe.loaded()))return;const je=F.sourceLayer||Fe.rasterLayerIds&&Fe.rasterLayerIds[0];if(!je)return;const qe=F.paint.get("raster-particle-array-band")||Fe.getInitialBand(je);if(null==qe)return;const He=Le.getIds().map((F=>Le.getTileByID(F)));for(const F of He)F.updateNeeded(je,qe)&&Fe.prepareTile(F,je,qe)}},xf={fill:Nr};class ea{constructor(Le,Oe,Fe,je,qe){this.context=new Dr(Le,Oe),this.transform=Fe,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=qe,this._timeStamp=F.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const He=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const F of He)this._debugParams.enabledLayers[F]=!0;qe.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),qe.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),qe.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),qe.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),qe.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),qe.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const F of He)qe.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],F);this.occlusionParams=new kn(qe),this.setup(),this.numSublayers=St.maxUnderzooming+St.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new F.dy,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new oo(this),this._wireframeDebugCache=new Fn,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const xt=new F.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new F.T(this.context,xt,Le.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=je}updateTerrain(F,Le){const Oe=!!F&&!!F.terrain&&this.transform.projection.supportsTerrain;if(!(Oe||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new js(this,F));const Fe=this._terrain;this.transform.elevation=Oe?Fe:null,Fe.update(F,this.transform,Le),this.transform.elevation&&!Fe.enabled&&(this.transform.elevation=null)}_updateFog(F){const Le=F.fog;if(!Le||"globe"===this.transform.projection.name||Le.getOpacity(this.transform.pitch)<1||Le.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[Oe,Fe]=Le.getFovAdjustedRange(this.transform._fov);if(Oe>Fe)return void(this.transform.fogCullDistSq=null);const je=Oe+.78*(Fe-Oe);this.transform.fogCullDistSq=je*je}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(F){F&&!this._terrain&&(this._terrain=new js(this,this.style)),this._forceTerrainMode=F}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(Le,Oe){if(this.width=Le*F.q.devicePixelRatio,this.height=Oe*F.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const F of this.style.order)this.style._mergedLayers[F].resize()}setup(){const Le=this.context,Oe=new F.b5;Oe.emplaceBack(0,0),Oe.emplaceBack(F.ai,0),Oe.emplaceBack(0,F.ai),Oe.emplaceBack(F.ai,F.ai),this.tileExtentBuffer=Le.createVertexBuffer(Oe,F.b7.members),this.tileExtentSegments=F.b8.simpleSegment(0,0,4,2);const Fe=new F.b5;Fe.emplaceBack(0,0),Fe.emplaceBack(F.ai,0),Fe.emplaceBack(0,F.ai),Fe.emplaceBack(F.ai,F.ai),this.debugBuffer=Le.createVertexBuffer(Fe,F.b7.members),this.debugSegments=F.b8.simpleSegment(0,0,4,5);const je=new F.b5;je.emplaceBack(-1,-1),je.emplaceBack(1,-1),je.emplaceBack(-1,1),je.emplaceBack(1,1),this.viewportBuffer=Le.createVertexBuffer(je,F.b7.members),this.viewportSegments=F.b8.simpleSegment(0,0,4,2);const qe=new F.aU;qe.emplaceBack(0,0,0,0),qe.emplaceBack(F.ai,0,F.ai,0),qe.emplaceBack(0,F.ai,0,F.ai),qe.emplaceBack(F.ai,F.ai,F.ai,F.ai),this.mercatorBoundsBuffer=Le.createVertexBuffer(qe,F.ba.members),this.mercatorBoundsSegments=F.b8.simpleSegment(0,0,4,2);const He=new F.aV;He.emplaceBack(0,1,2),He.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=Le.createIndexBuffer(He);const xt=new F.b6;for(const F of[0,1,3,2,0])xt.emplaceBack(F);this.debugIndexBuffer=Le.createIndexBuffer(xt),this.emptyTexture=new F.T(Le,new F.r({width:1,height:1},Uint8Array.of(0,0,0,0)),Le.gl.RGBA8),this.identityMat=F.ad.mat4.create();const jt=this.context.gl;this.stencilClearMode=new Ui({func:jt.ALWAYS,mask:0},0,255,jt.ZERO,jt.ZERO,jt.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(F){return F._makeTileBoundsBuffers(this.context,this.transform.projection),F._tileBoundsBuffer?{tileBoundsBuffer:F._tileBoundsBuffer,tileBoundsIndexBuffer:F._tileBoundsIndexBuffer,tileBoundsSegments:F._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const F=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,F.TRIANGLES,Bi.disabled,this.stencilClearMode,ki.disabled,ji.disabled,Bs(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(F,Le,Oe){if(!Le||this.currentStencilSource===Le.id||!F.isTileClipped()||!Oe||0===Oe.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let F=!1;for(const Le of Oe)if(void 0===this._tileClippingMaskIDs[Le.key]){F=!0;break}if(!F)return}this.currentStencilSource=Le.id;const Fe=this.context,je=Fe.gl;this.nextStencilID+Oe.length>256&&this.clearStencil(),Fe.setColorMode(ki.disabled),Fe.setDepthMode(Bi.disabled);const qe=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const F of Oe){const Oe=Le.getTile(F),Fe=this._tileClippingMaskIDs[F.key]=this.nextStencilID++,{tileBoundsBuffer:He,tileBoundsIndexBuffer:xt,tileBoundsSegments:jt}=this.getTileBoundsBuffers(Oe);qe.draw(this,je.TRIANGLES,Bi.disabled,new Ui({func:je.ALWAYS,mask:0},Fe,255,je.KEEP,je.KEEP,je.REPLACE),ki.disabled,ji.disabled,Bs(F.projMatrix),"$clipping",He,xt,jt)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const F=this.nextStencilID++,Le=this.context.gl;return new Ui({func:Le.NOTEQUAL,mask:255},F,255,Le.KEEP,Le.KEEP,Le.REPLACE)}stencilModeForClipping(F){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(F);const Le=this.context.gl;return new Ui({func:Le.EQUAL,mask:255},this._tileClippingMaskIDs[F.key],0,Le.KEEP,Le.KEEP,Le.REPLACE)}stencilConfigForOverlap(F){const Le=this.context.gl,Oe=F.sort(((F,Le)=>Le.overscaledZ-F.overscaledZ)),Fe=Oe[Oe.length-1].overscaledZ,je=Oe[0].overscaledZ-Fe+1;if(je>1){this.currentStencilSource=void 0,this.nextStencilID+je>256&&this.clearStencil();const F={};for(let Oe=0;Oe<je;Oe++)F[Oe+Fe]=new Ui({func:Le.GEQUAL,mask:255},Oe+this.nextStencilID,255,Le.KEEP,Le.KEEP,Le.REPLACE);return this.nextStencilID+=je,[F,Oe]}return[{[Fe]:Ui.disabled},Oe]}colorModeForRenderPass(){const Le=this.context.gl;if(this._showOverdrawInspector){const Oe=1/8;return new ki([Le.CONSTANT_COLOR,Le.ONE,Le.CONSTANT_COLOR,Le.ONE],new F.al(Oe,Oe,Oe,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?ki.unblended:ki.alphaBlended}colorModeForDrapableLayerRenderPass(Le){const Oe=this.context.gl;return(()=>this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture)()&&"translucent"===this.renderPass?new ki([Oe.ONE,Oe.ONE_MINUS_SRC_ALPHA,Oe.CONSTANT_ALPHA,Oe.ONE_MINUS_SRC_ALPHA],new F.al(0,0,0,void 0===Le?0:Le),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(F,Le,Oe,Fe=!1){if(this.depthOcclusion)return new Bi(this.context.gl.GREATER,Bi.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!Fe)return Bi.disabled;const je=1-((1+this.currentLayer)*this.numSublayers+F)*this.depthEpsilon;return new Bi(Oe||this.context.gl.LEQUAL,Le,[je,je])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const Le=this.context.gl,Oe=Math.ceil(this.width),Fe=Math.ceil(this.height),je=this.context.bindFramebuffer.get(),qe=Le.getParameter(Le.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===Oe&&this.depthFBO.height===Fe||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==Oe&&0!==Fe&&(this.depthFBO=new Rr(this.context,Oe,Fe,!1,"texture"),this.depthTexture=new F.T(this.context,{width:Oe,height:Fe,data:null},Le.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(je),Le.bindTexture(Le.TEXTURE_2D,qe),this.depthFBO&&(Le.bindFramebuffer(Le.READ_FRAMEBUFFER,null),Le.bindFramebuffer(Le.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),Le.blitFramebuffer(0,0,Oe,Fe,0,0,Oe,Fe,Le.DEPTH_BUFFER_BIT,Le.NEAREST),Le.bindFramebuffer(Le.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((F,Le)=>F+Le/this._fpsHistory.length),0))}render(Le,Oe){const Fe=F.q.now();this._dt=Fe-this._timeStamp,this._timeStamp=Fe,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=Le.map.repaint,this.style=Le,this.options=Oe;const je=this.style._mergedLayers,qe=!(!this.terrain||!this.terrain.enabled),n=()=>this.style._getOrder(qe).filter((F=>{const Le=je[F];return!(Le.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Le.type]}));let He=n(),xt=!1,jt=!1;for(const F of He){const Le=je[F];"circle"===Le.type&&(xt=!0),"symbol"===Le.type&&(Le.hasInitialOcclusionOpacityProperties?jt=!0:xt=!0)}let Gt=He.map((F=>je[F]));const bi=this.style._mergedSourceCaches;this.imageManager=Le.imageManager,this.modelManager=Le.modelManager,this.symbolFadeChange=Le.placement.symbolFadeChange(F.q.now()),this.imageManager.beginFrame();let wi=0,qr=!1;for(const F in bi){const Le=bi[F];Le.used&&(Le.prepare(this.context),Le.getSource().usedInConflation&&++wi)}let Xn=!1;for(const F of Gt)F.isHidden(this.transform.zoom)||("clip"===F.type&&(Xn=!0),this.prepareLayer(F));const Yn={},yo={},bo={},Do={},Ro={};for(const F in bi){const Le=bi[F];Yn[F]=Le.getVisibleCoordinates(),yo[F]=Yn[F].slice().reverse(),bo[F]=Le.getVisibleCoordinates(!0).reverse(),Do[F]=Le.getShadowCasterCoordinates(),Ro[F]=Le.sortCoordinatesByDistance(Yn[F])}const x=F=>{const Le=this.style.getLayerSourceCache(F);return Le&&Le.used?Le.getSource():null};if(wi||Xn||this._clippingActiveLastFrame){const Le=[],Oe=[];let Fe=0;for(const F of Gt)this.isSourceForClippingOrConflation(F,x(F))&&(Le.push(F),Oe.push(Fe)),Fe++;if(Le&&(Xn||Le.length>1)||this._clippingActiveLastFrame){Xn=!1;const Fe=[];for(let je=0;je<Le.length;je++){const qe=Le[je],He=Oe[je],xt=this.style.getLayerSourceCache(qe);if(!xt||!xt.used||!xt.getSource().usedInConflation&&"clip"!==qe.type)continue;let jt=F.dA,Gt=F.by.None;const bi=[];let wi=!0;if("clip"===qe.type){jt=He;for(const Le of qe.layout.get("clip-layer-types"))Gt|="model"===Le?F.by.Model:"symbol"===Le?F.by.Symbol:F.by.FillExtrusion;for(const F of qe.layout.get("clip-layer-scope"))bi.push(F);qe.isHidden(this.transform.zoom)?wi=!1:Xn=!0}wi&&Fe.push({layer:qe.fqid,cache:xt,order:jt,clipMask:Gt,clipScope:bi})}this.replacementSource.setSources(Fe),qr=!0}}this._clippingActiveLastFrame=Xn,qr||this.replacementSource.clear(),this.conflationActive=qr,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let F=0;F<Gt.length;F++){const Le=Gt[F],Oe=Le.cutoffRange();if(this.longestCutoffRange=Math.max(Oe,this.longestCutoffRange),Oe>0){const F=x(Le);F&&(this.minCutoffZoom=Math.max(F.minzoom,this.minCutoffZoom)),Le.minzoom&&(this.minCutoffZoom=Math.max(Le.minzoom,this.minCutoffZoom))}Le.is3D(qe)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=F),this._lastOcclusionLayer=F)}const zs=this.style&&this.style.fog;zs?(this._fogVisible=0!==zs.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=zs.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(bo),this.opaquePassCutoff=0,He=n(),Gt=He.map((F=>je[F])));const Zs=this._shadowRenderer;if(Zs){Zs.updateShadowParameters(this.transform,this.style.directionalLight);for(const F in bi)for(const Le of Yn[F]){let F={min:0,max:0};this.terrain&&(F=this.terrain.getMinMaxForTile(Le)||F),Zs.addShadowReceiver(Le.toUnwrapped(),F.min,F.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new F.dz(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new bn(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const na=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),el=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(na&&!this._snow&&(this._snow=new Kn(this)),!na&&this._snow&&(this._snow.destroy(),delete this._snow),el&&!this._rain&&(this._rain=new $n(this)),!el&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!hl.has(this.context.gl))return;this.renderPass="offscreen";for(const F of Gt){const Oe=Le.getLayerSourceCache(F);if(!F.hasOffscreenPass()||F.isHidden(this.transform.zoom))continue;const Fe=Oe?yo[Oe.id]:void 0;("custom"===F.type||"raster"===F.type||"raster-particle"===F.type||F.isSky()||Fe&&Fe.length)&&this.renderLayer(this,Oe,F,Fe)}this.depthRangeFor3D=[0,1-(Gt.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,Do)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const nl="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),pl=(()=>{if(Oe.showOverdrawInspector)return F.al.black;const Le=this.style.fog;if(Le&&this.transform.projection.supportsFog){const Oe=this.style.getLut(Le.scope);if(!nl){const Fe="none"===Le.properties.get("color-use-theme"),je=Le.properties.get("color").toRenderColor(Fe?null:Oe).toArray01();return new F.al(...je)}if(nl){const Fe="none"===Le.properties.get("space-color-use-theme"),je=Le.properties.get("space-color").toRenderColor(Fe?null:Oe).toArray01();return new F.al(...je)}}return F.al.transparent})();if(this.context.clear({color:pl,depth:1}),this.clearStencil(),this._showOverdrawInspector=Oe.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&nl&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=He.length-1;this.currentLayer>=0;this.currentLayer--){const F=Gt[this.currentLayer],Oe=Le.getLayerSourceCache(F);if(F.isSky())continue;const Fe=Oe?(F.is3D(qe)?Ro:yo)[Oe.id]:void 0;this._renderTileClippingMasks(F,Oe,Fe),this.renderLayer(this,Oe,F,Fe)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&nl&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||F.ag(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<He.length;this.currentLayer++){const F=Gt[this.currentLayer],Oe=Le.getLayerSourceCache(F);F.isSky()&&this.renderLayer(this,Oe,F,Oe?yo[Oe.id]:void 0)}function I(F,Le){let Oe;return Le&&(Oe=("symbol"===F.type?bo:F.is3D(qe)?Ro:yo)[Le.id]),Oe}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<He.length;){const F=Gt[this.currentLayer];if("raster"===F.type||"raster-particle"===F.type){const Oe=Le.getLayerSourceCache(F);this.renderLayer(this,Oe,F,I(F,Oe))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let bl=0;Zs&&(bl=Zs.getShadowCastingLayerCount());let Tl=!1,kl=-1;for(let F=0;F<He.length;++F){const Le=Gt[F];Le.isHidden(this.transform.zoom)||Le.is3D(qe)&&(kl=F)}jt&&-1===kl&&(xt=!0);let ec=!1;for(;this.currentLayer<He.length;){const F=Gt[this.currentLayer],Oe=Le.getLayerSourceCache(F);if(F.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(F)){if(F.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!ec&&F.is3D(qe)&&!qe){const F=this.currentLayer,t=F=>{for(this.currentLayer=0;this.currentLayer<Gt.length;this.currentLayer++){const Le=Gt[this.currentLayer];if(xf[Le.type]){const Oe=this.style.getLayerSourceCache(Le);xf[Le.type](this,Oe,Le,I(Le,Oe),F)}}};t("initialize"),t("reset"),this.currentLayer=F,ec=!0}if(xt&&!Tl&&this.terrain&&!this.transform.isOrthographic&&(Tl=!0,this.blitDepth()),jt&&-1!==kl&&this.currentLayer===kl+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(F,Oe,Oe?Yn[Oe.id]:void 0),this.renderLayer(this,Oe,F,I(F,Oe)),!this.terrain&&Zs&&bl>0&&F.hasShadowPass()&&0==--bl&&(Zs.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const F=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=F;this.currentLayer++){const F=Gt[this.currentLayer];if(!F.hasLightBeamPass())continue;const Oe=Le.getLayerSourceCache(F);this.renderLayer(this,Oe,F,Oe?yo[Oe.id]:void 0)}this.currentLayer=F,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const F=this.currentLayer;this.depthOcclusion=!0;for(const F of this.layersWithOcclusionOpacity){this.currentLayer=F;const Oe=Gt[this.currentLayer],Fe=Le.getLayerSourceCache(Oe),je=Fe?yo[Fe.id]:void 0;this.terrain||this._renderTileClippingMasks(Oe,Fe,Fe?Yn[Fe.id]:void 0),this.renderLayer(this,Fe,Oe,je)}this.depthOcclusion=!1,this.currentLayer=F,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Oe=null;Gt.forEach((F=>{const Fe=Le.getLayerSourceCache(F);Fe&&!F.isHidden(this.transform.zoom)&&Fe.getVisibleCoordinates().length&&(!Oe||Oe.getSource().maxzoom<Fe.getSource().maxzoom)&&(Oe=Fe)})),Oe&&this.options.showTileBoundaries&&gf.debug(this,Oe,Oe.getVisibleCoordinates(),F.al.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&gf.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new F.al(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(F){const Le=F.transform.padding;cn(F,F.transform.height-(Le.top||0),3,qp),cn(F,Le.bottom||0,3,$p),hn(F,Le.left||0,3,Zp),hn(F,F.transform.width-(Le.right||0),3,Xp);const Oe=F.transform.centerPoint;!function(F,Le,Oe,Fe){dn(F,Le-1,Oe-10,2,20,Fe),dn(F,Le-10,Oe-1,20,2,Fe)}(F,Oe.x,F.transform.height-Oe.y,rf)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),qr||(this.conflationActive=!1)}prepareLayer(F){this.gpuTimingStart(F);const{unsupportedLayers:Le}=this.transform.projection,Oe=!Le||!Le.includes(F.type);if(yf[F.type]&&(Oe||this.terrain&&"custom"===F.type)){const Le=this.style.getLayerSourceCache(F);yf[F.type](F,Le,this)}this.gpuTimingEnd()}renderLayer(F,Le,Oe,Fe){Oe.isHidden(this.transform.zoom)||("background"===Oe.type||"sky"===Oe.type||"custom"===Oe.type||"model"===Oe.type||"raster"===Oe.type||"raster-particle"===Oe.type||Fe&&Fe.length)&&(this.id=Oe.id,this.gpuTimingStart(Oe),F.transform.projection.unsupportedLayers&&F.transform.projection.unsupportedLayers.includes(Oe.type)&&(!F.terrain||"custom"!==Oe.type)||"clip"===Oe.type||gf[Oe.type](F,Le,Oe,Fe,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(F){if(!this.options.gpuTiming)return;const Le=this.context.extTimerQuery,Oe=this.context.gl;let Fe=this.gpuTimers[F.id];Fe||(Fe=this.gpuTimers[F.id]={calls:0,cpuTime:0,query:Oe.createQuery()}),Fe.calls++,Oe.beginQuery(Le.TIME_ELAPSED_EXT,Fe.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const F=this.context.extTimerQuery,Le=this.context.gl,Oe=Le.createQuery();this.deferredRenderGpuTimeQueries.push(Oe),Le.beginQuery(F.TIME_ELAPSED_EXT,Oe)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const F=this.gpuTimers;return this.gpuTimers={},F}collectDeferredRenderGpuQueries(){const F=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],F}queryGpuTimers(F){const Le={};for(const Oe in F){const Fe=F[Oe],je=this.context.extTimerQuery,qe=je.getQueryParameter(Fe.query,this.context.gl.QUERY_RESULT)/1e6;je.deleteQueryEXT(Fe.query),Le[Oe]=qe}return Le}queryGpuTimeDeferredRender(F){if(!this.options.gpuTimingDeferredRender)return 0;const Le=this.context.gl;let Oe=0;for(const Fe of F)Oe+=Le.getQueryParameter(Fe,Le.QUERY_RESULT)/1e6,Le.deleteQuery(Fe);return Oe}translatePosMatrix(Le,Oe,Fe,je,qe){if(!Fe[0]&&!Fe[1])return Le;const He=qe?"map"===je?this.transform.angle:0:"viewport"===je?-this.transform.angle:0;if(He){const F=Math.sin(He),Le=Math.cos(He);Fe=[Fe[0]*Le-Fe[1]*F,Fe[0]*F+Fe[1]*Le]}const xt=[qe?Fe[0]:F.at(Oe,Fe[0],this.transform.zoom),qe?Fe[1]:F.at(Oe,Fe[1],this.transform.zoom),0],jt=new Float32Array(16);return F.ad.mat4.translate(jt,Le,xt),jt}saveTileTexture(F){const Le=F.size[0],Oe=this._tileTextures[Le];Oe?Oe.push(F):this._tileTextures[Le]=[F]}getTileTexture(F){const Le=this._tileTextures[F];return Le&&Le.length>0?Le.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(F,Le,Oe){const Fe=void 0===Oe?this.terrain&&this.terrain.renderingToTexture:Oe,je=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===F||"terrainRaster"===F?(je.push("LIGHTING_3D_MODE"),je.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):Fe||je.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||je.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(je.push("TERRAIN"),this.linearFloatFilteringSupported()&&je.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&je.push("GLOBE"),!this._fogVisible||Fe||void 0!==Le&&!Le||je.push("FOG","FOG_DITHERING"),Fe&&je.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&je.push("OVERDRAW_INSPECTOR"),je}getOrCreateProgram(F,Le){this.cache=this.cache||{};const Oe=Le&&Le.defines||[],Fe=Le&&Le.config,je=this.currentGlobalDefines(F,Le&&Le.overrideFog,Le&&Le.overrideRtt).concat(Oe),qe=Ws.cacheKey($d[F],F,je,Fe);return this.cache[qe]||(this.cache[qe]=new Ws(this.context,F,$d[F],Fe,Rp[F],je)),this.cache[qe]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const F=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(F.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new F.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(Le,Oe){if(this.style.enable3dLights()){const Fe=this.style.directionalLight,je=this.style.ambientLight;if(Fe&&je){const qe=((Le,Oe,Fe)=>{const je=Le.properties.get("direction"),qe="none"===Le.properties.get("color-use-theme"),He=Le.properties.get("color").toRenderColor(qe?null:Fe.getLut(Le.scope)).toArray01(),xt=Le.properties.get("intensity"),jt="none"===Oe.properties.get("color-use-theme"),Gt=Oe.properties.get("color").toRenderColor(jt?null:Fe.getLut(Oe.scope)).toArray01(),bi=Oe.properties.get("intensity"),wi=[je.x,je.y,je.z],qr=F.cN(Gt,bi),Xn=F.cN(He,xt);return{u_lighting_ambient_color:qr,u_lighting_directional_dir:wi,u_lighting_directional_color:Xn,u_ground_radiance:qs(wi,Xn,qr)}})(Fe,je,this.style);Oe.setLightsUniformValues(Le,qe)}}}uploadCommonUniforms(Le,Oe,Fe,je,qe){if(this.uploadCommonLightUniforms(Le,Oe),this.terrain&&this.terrain.renderingToTexture)return;const He=this.style.fog;if(He){const qe=He.getOpacity(this.transform.pitch),xt=((Le,Oe,Fe,je,qe,He,xt,jt,Gt,bi,wi,qr)=>{const Xn=Le.transform,Yn="none"===Oe.properties.get("color-use-theme"),yo=Oe.properties.get("color").toRenderColor(Yn?null:Le.style.getLut(Oe.scope)).toArray01();yo[3]=je;const bo=Le.frameCounter/1e3%1,[Do,Ro]=Oe.properties.get("vertical-range");return{u_fog_matrix:Fe?Xn.calculateFogTileMatrix(Fe):qr||Le.identityMat,u_fog_range:Oe.getFovAdjustedRange(Xn._fov),u_fog_color:yo,u_fog_horizon_blend:Oe.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(Do,Ro),Ro],u_fog_temporal_offset:bo,u_frustum_tl:qe,u_frustum_tr:He,u_frustum_br:xt,u_frustum_bl:jt,u_globe_pos:Gt,u_globe_radius:bi,u_viewport:wi,u_globe_transition:F.ag(Xn.zoom),u_is_globe:+("globe"===Xn.projection.name)}})(this,He,Fe,qe,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*F.q.devicePixelRatio,this.transform.height*F.q.devicePixelRatio],je);Oe.setFogUniformValues(Le,xt)}qe&&Oe.setCutoffUniformValues(Le,qe.uniformValues)}setTileLoadedFlag(F){this.tileLoaded=F}saveCanvasCopy(){const F=this.canvasCopy();F&&(this.frameCopies.push(F),this.tileLoaded=!1)}canvasCopy(){const F=this.context.gl,Le=F.createTexture();return F.bindTexture(F.TEXTURE_2D,Le),F.copyTexImage2D(F.TEXTURE_2D,0,F.RGBA,0,0,F.drawingBufferWidth,F.drawingBufferHeight,0),Le}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const F=this.style&&this.style.fog;return!!F&&0!==F.getOpacity(this.transform.pitch)}getBackgroundTiles(){const F=this._backgroundTiles,Le=this._backgroundTiles={},Oe=this.transform.coveringTiles({tileSize:512});for(const Fe of Oe)Le[Fe.key]=F[Fe.key]||new bt(Fe,512,this.transform.tileZoom,this);return Le}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(F,Le){return!(!F.is3D(!(!this.terrain||!this.terrain.enabled))||"clip"!==F.type&&(F.minzoom&&F.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==F.sourceLayer)&&(!Le||"batched-model"!==Le.type)))}isTileAffectedByFog(F){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let Le=this._cachedTileFogOpacities[F.key];return Le||(this._cachedTileFogOpacities[F.key]=Le=this.style.fog.getOpacityForTile(F)),Le[0]>=ic||Le[1]>=ic}setupDepthForOcclusion(F,Le,Oe){const Fe=this.context,je=Fe.gl,qe=!!Oe;var He;Oe||(Oe={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),Fe.activeTexture.set(je.TEXTURE3),F&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(je.NEAREST,je.CLAMP_TO_EDGE),Oe.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],Oe.u_depth_range_unpack=[2/((He=this.depthRangeFor3D)[1]-He[0]),-1-2*He[0]/(He[1]-He[0])],Oe.u_occluder_half_size=.5*this.occlusionParams.occluderSize,Oe.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(je.NEAREST,je.CLAMP_TO_EDGE),Fe.activeTexture.set(je.TEXTURE0),qe||Le.setTerrainUniformValues(Fe,Oe)}}function ta(F,Le){let Oe=!1,Fe=null;const s=()=>{Fe=null,Oe&&(F(),Fe=setTimeout(s,Le),Oe=!1)};return()=>(Oe=!0,Fe||s(),Fe)}class ia{constructor(Le){this._hashName=Le&&encodeURIComponent(Le),F.aQ(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=ta(this._updateHashUnthrottled.bind(this),300)}addTo(F){return this._map=F,window.addEventListener("hashchange",this._onHashChange,!1),F.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const F=this._map;if(!F)return"";const Le=oa(F);if(this._hashName){const F=this._hashName;let Oe=!1;const Fe=location.hash.slice(1).split("&").map((Fe=>{const je=Fe.split("=")[0];return je===F?(Oe=!0,`${je}=${Le}`):Fe})).filter((F=>F));return Oe||Fe.push(`${F}=${Le}`),`#${Fe.join("&")}`}return`#${Le}`}_getCurrentHash(){const F=location.hash.replace("#","");if(this._hashName){let Le;return F.split("&").map((F=>F.split("="))).forEach((F=>{F[0]===this._hashName&&(Le=F)})),(Le&&Le[1]||"").split("/")}return F.split("/")}_onHashChange(){const F=this._map;if(!F)return!1;const Le=this._getCurrentHash();if(Le.length>=3&&!Le.some((F=>isNaN(F)))){const Oe=F.dragRotate.isEnabled()&&F.touchZoomRotate.isEnabled()?+(Le[3]||0):F.getBearing();return F.jumpTo({center:[+Le[2],+Le[1]],zoom:+Le[0],bearing:Oe,pitch:+(Le[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function oa(F,Le){const Oe=F.getCenter(),Fe=Math.round(100*F.getZoom())/100,je=Math.ceil((Fe*Math.LN2+Math.log(512/360/.5))/Math.LN10),qe=Math.pow(10,je),He=Math.round(Oe.lng*qe)/qe,xt=Math.round(Oe.lat*qe)/qe,jt=F.getBearing(),Gt=F.getPitch();let bi=Le?`/${He}/${xt}/${Fe}`:`${Fe}/${xt}/${He}`;return(jt||Gt)&&(bi+="/"+Math.round(10*jt)/10),Gt&&(bi+=`/${Math.round(Gt)}`),bi}const Tf={linearity:.3,easing:F.dB(0,0,.3,1)},Ef=F.l({deceleration:2500,maxSpeed:1400},Tf),Mf=F.l({deceleration:20,maxSpeed:1400},Tf),If=F.l({deceleration:1e3,maxSpeed:360},Tf),Cf=F.l({deceleration:1e3,maxSpeed:90},Tf);class ca{constructor(F){this._map=F,this.clear()}clear(){this._inertiaBuffer=[]}record(Le){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:F.q.now(),settings:Le})}_drainInertiaBuffer(){const Le=this._inertiaBuffer,Oe=F.q.now();for(;Le.length>0&&Oe-Le[0].time>160;)Le.shift()}_onMoveEnd(Le){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const Oe={zoom:0,bearing:0,pitch:0,pan:new F.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:F}of this._inertiaBuffer)Oe.zoom+=F.zoomDelta||0,Oe.bearing+=F.bearingDelta||0,Oe.pitch+=F.pitchDelta||0,F.panDelta&&Oe.pan._add(F.panDelta),F.around&&(Oe.around=F.around),F.pinchAround&&(Oe.pinchAround=F.pinchAround);const Fe=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,je={};if(Oe.pan.mag()){const qe=da(Oe.pan.mag(),Fe,F.l({},Ef,Le||{}));je.offset=Oe.pan.mult(qe.amount/Oe.pan.mag()),je.center=this._map.transform.center,ha(je,qe)}if(Oe.zoom){const F=da(Oe.zoom,Fe,Mf);je.zoom=this._map.transform.zoom+F.amount,ha(je,F)}if(Oe.bearing){const Le=da(Oe.bearing,Fe,If);je.bearing=this._map.transform.bearing+F.ay(Le.amount,-179,179),ha(je,Le)}if(Oe.pitch){const F=da(Oe.pitch,Fe,Cf);je.pitch=this._map.transform.pitch+F.amount,ha(je,F)}if(je.zoom||je.bearing){const F=void 0===Oe.pinchAround?Oe.around:Oe.pinchAround;je.around=F?this._map.unproject(F):this._map.getCenter()}return this.clear(),je.noMoveStart=!0,je}}function ha(F,Le){(!F.duration||F.duration<Le.duration)&&(F.duration=Le.duration,F.easing=Le.easing)}function da(Le,Oe,Fe){const{maxSpeed:je,linearity:qe,deceleration:He}=Fe,xt=F.ay(Le*qe/(Oe/1e3),-je,je),jt=Math.abs(xt)/(He*qe);return{easing:Fe.easing,duration:1e3*jt,amount:xt*(jt/2)}}class ua extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(Le,Oe,Fe,je={}){const qe=g(Oe.getCanvasContainer(),Fe),He=Oe.unproject(qe);super(Le,F.l({point:qe,lngLat:He,originalEvent:Fe},je)),this._defaultPrevented=!1,this.target=Oe}}class _a extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(Le,Oe,Fe){const je="touchend"===Le?Fe.changedTouches:Fe.touches,qe=v(Oe.getCanvasContainer(),je),He=qe.map((F=>Oe.unproject(F))),xt=qe.reduce(((F,Le,Oe,Fe)=>F.add(Le.div(Fe.length))),new F.P(0,0));super(Le,{points:qe,point:xt,lngLats:He,lngLat:Oe.unproject(xt),originalEvent:Fe}),this._defaultPrevented=!1}}class pa extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(F,Le){super("wheel",{originalEvent:Le}),this._defaultPrevented=!1}}class fa{constructor(F,Le){this._map=F,this._clickTolerance=Le.clickTolerance}reset(){this._mousedownPos=void 0}wheel(F){return this._firePreventable(new pa(this._map,F))}mousedown(F,Le){return this._mousedownPos=Le,this._firePreventable(new ua(F.type,this._map,F))}mouseup(F){this._map.fire(new ua(F.type,this._map,F))}preclick(Le){const Oe=F.l({},Le);Oe.type="preclick",this._map.fire(new ua(Oe.type,this._map,Oe))}click(F,Le){this._mousedownPos&&this._mousedownPos.dist(Le)>=this._clickTolerance||(this.preclick(F),this._map.fire(new ua(F.type,this._map,F)))}dblclick(F){return this._firePreventable(new ua(F.type,this._map,F))}mouseover(F){this._map.fire(new ua(F.type,this._map,F))}mouseout(F){this._map.fire(new ua(F.type,this._map,F))}touchstart(F){return this._firePreventable(new _a(F.type,this._map,F))}touchmove(F){this._map.fire(new _a(F.type,this._map,F))}touchend(F){this._map.fire(new _a(F.type,this._map,F))}touchcancel(F){this._map.fire(new _a(F.type,this._map,F))}_firePreventable(F){if(this._map.fire(F),F.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ma{constructor(F){this._map=F}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(F){this._map.fire(new ua(F.type,this._map,F))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ua("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(F){this._delayContextMenu?this._contextMenuEvent=F:this._map.fire(new ua(F.type,this._map,F)),this._map.listens("contextmenu")&&F.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ga{constructor(F,Le){this._map=F,this._el=F.getCanvasContainer(),this._container=F.getContainer(),this._clickTolerance=Le.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(F,Le){this.isEnabled()&&F.shiftKey&&0===F.button&&(_(),this._startPos=this._lastPos=Le,this._active=!0)}mousemoveWindow(F,Le){if(!this._active)return;const Oe=Le,Fe=this._startPos,je=this._lastPos;if(!Fe||!je||je.equals(Oe)||!this._box&&Oe.dist(Fe)<this._clickTolerance)return;this._lastPos=Oe,this._box||(this._box=l("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",F));const qe=Math.min(Fe.x,Oe.x),He=Math.max(Fe.x,Oe.x),xt=Math.min(Fe.y,Oe.y),jt=Math.max(Fe.y,Oe.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${qe}px,${xt}px)`,this._box.style.width=He-qe+"px",this._box.style.height=jt-xt+"px")}))}mouseupWindow(Le,Oe){if(!this._active)return;const Fe=this._startPos,je=Oe;if(Fe&&0===Le.button){if(this.reset(),m(),Fe.x!==je.x||Fe.y!==je.y)return this._map.fire(new F.A("boxzoomend",{originalEvent:Le})),{cameraAnimation:F=>F.fitScreenCoordinates(Fe,je,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",Le)}}keydown(F){this._active&&27===F.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",F))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),p(),delete this._startPos,delete this._lastPos}_fireEvent(Le,Oe){return this._map.fire(new F.A(Le,{originalEvent:Oe}))}}function va(F,Le){const Oe={};for(let Fe=0;Fe<F.length;Fe++)Oe[F[Fe].identifier]=Le[Fe];return Oe}class ya{constructor(F){this.reset(),this.numTouches=F.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(Le,Oe,Fe){(this.centroid||Fe.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=Le.timeStamp),Fe.length===this.numTouches&&(this.centroid=function(Le){const Oe=new F.P(0,0);for(const F of Le)Oe._add(F);return Oe.div(Le.length)}(Oe),this.touches=va(Fe,Oe)))}touchmove(F,Le,Oe){if(this.aborted||!this.centroid)return;const Fe=va(Oe,Le);for(const F in this.touches){const Le=Fe[F];(!Le||Le.dist(this.touches[F])>30)&&(this.aborted=!0)}}touchend(F,Le,Oe){if((!this.centroid||F.timeStamp-this.startTime>500)&&(this.aborted=!0),0===Oe.length){const F=!this.aborted&&this.centroid;if(this.reset(),F)return F}}}class xa{constructor(F){this.singleTap=new ya(F),this.numTaps=F.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(F,Le,Oe){this.singleTap.touchstart(F,Le,Oe)}touchmove(F,Le,Oe){this.singleTap.touchmove(F,Le,Oe)}touchend(F,Le,Oe){const Fe=this.singleTap.touchend(F,Le,Oe);if(Fe){const Le=F.timeStamp-this.lastTime<500,Oe=!this.lastTap||this.lastTap.dist(Fe)<30;if(Le&&Oe||this.reset(),this.count++,this.lastTime=F.timeStamp,this.lastTap=Fe,this.count===this.numTaps)return this.reset(),Fe}}}class ba{constructor(){this._zoomIn=new xa({numTouches:1,numTaps:2}),this._zoomOut=new xa({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(F,Le,Oe){this._zoomIn.touchstart(F,Le,Oe),this._zoomOut.touchstart(F,Le,Oe)}touchmove(F,Le,Oe){this._zoomIn.touchmove(F,Le,Oe),this._zoomOut.touchmove(F,Le,Oe)}touchend(F,Le,Oe){const Fe=this._zoomIn.touchend(F,Le,Oe),je=this._zoomOut.touchend(F,Le,Oe);return Fe?(this._active=!0,F.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:Le=>Le.easeTo({duration:300,zoom:Le.getZoom()+1,around:Le.unproject(Fe)},{originalEvent:F})}):je?(this._active=!0,F.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:Le=>Le.easeTo({duration:300,zoom:Le.getZoom()-1,around:Le.unproject(je)},{originalEvent:F})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const zf={0:1,2:2},Df={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class Ea{constructor(F){this.reset(),this._clickTolerance=F.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(F,Le){return!1}_move(F,Le){return{}}mousedown(F,Le){if(this._lastPoint)return;const Oe=y(F);this._correctButton(F,Oe)&&(this._lastPoint=Le,this._eventButton=Oe)}mousemoveWindow(F,Le){const Oe=this._lastPoint;if(Oe)if(F.preventDefault(),null!=this._eventButton&&function(F,Le){const Oe=zf[Le];return void 0===F.buttons||(F.buttons&Oe)!==Oe}(F,this._eventButton))this.reset();else if(this._moved||!(Le.dist(Oe)<this._clickTolerance))return this._moved=!0,this._lastPoint=Le,this._move(Oe,Le)}mouseupWindow(F){this._lastPoint&&y(F)===this._eventButton&&(this._moved&&m(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Sa extends Ea{mousedown(F,Le){super.mousedown(F,Le),this._lastPoint&&(this._active=!0)}_correctButton(F,Le){return 0===Le&&!F.ctrlKey}_move(F,Le){return{around:Le,panDelta:Le.sub(F)}}}class Ca extends Ea{constructor(F){super(F),this._pitchRotateKey=F.pitchRotateKey?Df[F.pitchRotateKey]:void 0}_correctButton(F,Le){return this._pitchRotateKey?0===Le&&F[this._pitchRotateKey]:0===Le&&F.ctrlKey||2===Le}_move(F,Le){const Oe=.8*(Le.x-F.x);if(Oe)return this._active=!0,{bearingDelta:Oe}}contextmenu(F){this._pitchRotateKey||F.preventDefault()}}class Ia extends Ea{constructor(F){super(F),this._pitchRotateKey=F.pitchRotateKey?Df[F.pitchRotateKey]:void 0}_correctButton(F,Le){return this._pitchRotateKey?0===Le&&F[this._pitchRotateKey]:0===Le&&F.ctrlKey||2===Le}_move(F,Le){const Oe=-.5*(Le.y-F.y);if(Oe)return this._active=!0,{pitchDelta:Oe}}contextmenu(F){this._pitchRotateKey||F.preventDefault()}}class Ra{constructor(Le,Oe){this._map=Le,this._el=Le.getCanvasContainer(),this._minTouches=1,this._clickTolerance=Oe.clickTolerance||1,this.reset(),F.aQ(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new F.P(0,0)}touchstart(F,Le,Oe){return this._calculateTransform(F,Le,Oe)}touchmove(Le,Oe,Fe){if(this._active&&!(Fe.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===Fe.length&&!F.dC())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return Le.cancelable&&Le.preventDefault(),this._calculateTransform(Le,Oe,Fe)}}touchend(F,Le,Oe){this._calculateTransform(F,Le,Oe),this._active&&Oe.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(Le,Oe,Fe){Fe.length>0&&(this._active=!0);const je=va(Fe,Oe),qe=new F.P(0,0),He=new F.P(0,0);let xt=0;for(const F in je){const Le=je[F],Oe=this._touches[F];Oe&&(qe._add(Le),He._add(Le.sub(Oe)),xt++,je[F]=Le)}if(this._touches=je,xt<this._minTouches||!He.mag())return;const jt=He.div(xt);return this._sum._add(jt),this._sum.mag()<this._clickTolerance?void 0:{around:qe.div(xt),panDelta:jt}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class Da{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(F){}_move(F,Le,Oe){return{}}touchstart(F,Le,Oe){this._firstTwoTouches||Oe.length<2||(this._firstTwoTouches=[Oe[0].identifier,Oe[1].identifier],this._start([Le[0],Le[1]]))}touchmove(F,Le,Oe){const Fe=this._firstTwoTouches;if(!Fe)return;F.preventDefault();const[je,qe]=Fe,He=Aa(Oe,Le,je),xt=Aa(Oe,Le,qe);if(!He||!xt)return;const jt=this._aroundCenter?null:He.add(xt).div(2);return this._move([He,xt],jt,F)}touchend(F,Le,Oe){if(!this._firstTwoTouches)return;const[Fe,je]=this._firstTwoTouches,qe=Aa(Oe,Le,Fe),He=Aa(Oe,Le,je);qe&&He||(this._active&&m(),this.reset())}touchcancel(){this.reset()}enable(F){this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Aa(F,Le,Oe){for(let Fe=0;Fe<F.length;Fe++)if(F[Fe].identifier===Oe)return Le[Fe]}function La(F,Le){return Math.log(F/Le)/Math.LN2}class Ma extends Da{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(F){this._startDistance=this._distance=F[0].dist(F[1])}_move(F,Le){const Oe=this._distance;if(this._distance=F[0].dist(F[1]),this._active||!(Math.abs(La(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:La(this._distance,Oe),pinchAround:Le}}}function Pa(F,Le){return 180*F.angleWith(Le)/Math.PI}class za extends Da{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(F){this._startVector=this._vector=F[0].sub(F[1]),this._minDiameter=F[0].dist(F[1])}_move(F,Le){const Oe=this._vector;if(this._vector=F[0].sub(F[1]),Oe&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Pa(this._vector,Oe),pinchAround:Le}}_isBelowThreshold(F){this._minDiameter=Math.min(this._minDiameter,F.mag());const Le=25/(Math.PI*this._minDiameter)*360,Oe=this._startVector;if(!Oe)return!1;const Fe=Pa(F,Oe);return Math.abs(Fe)<Le}}function Oa(F){return Math.abs(F.y)>Math.abs(F.x)}class Fa extends Da{constructor(F){super(),this._map=F}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(F){this._lastPoints=F,Oa(F[0].sub(F[1]))&&(this._valid=!1)}_move(Le,Oe,Fe){const je=this._lastPoints;if(!je)return;const qe=Le[0].sub(je[0]),He=Le[1].sub(je[1]);return this._map._cooperativeGestures&&!F.dC()&&Fe.touches.length<3||(this._valid=this.gestureBeginsVertically(qe,He,Fe.timeStamp),!this._valid)?void 0:(this._lastPoints=Le,this._active=!0,{pitchDelta:(qe.y+He.y)/2*-.5})}gestureBeginsVertically(F,Le,Oe){if(void 0!==this._valid)return this._valid;const Fe=F.mag()>=2,je=Le.mag()>=2;if(!Fe&&!je)return;if(!Fe||!je)return null==this._firstMove&&(this._firstMove=Oe),Oe-this._firstMove<100&&void 0;const qe=F.y>0==Le.y>0;return Oa(F)&&Oa(Le)&&qe}}const Of={panStep:100,bearingStep:15,pitchStep:10};class Ba{constructor(){const F=Of;this._panStep=F.panStep,this._bearingStep=F.bearingStep,this._pitchStep=F.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(F){if(F.altKey||F.ctrlKey||F.metaKey)return;let Le=0,Oe=0,Fe=0,je=0,qe=0;switch(F.keyCode){case 61:case 107:case 171:case 187:Le=1;break;case 189:case 109:case 173:Le=-1;break;case 37:F.shiftKey?Oe=-1:(F.preventDefault(),je=-1);break;case 39:F.shiftKey?Oe=1:(F.preventDefault(),je=1);break;case 38:F.shiftKey?Fe=1:(F.preventDefault(),qe=-1);break;case 40:F.shiftKey?Fe=-1:(F.preventDefault(),qe=1);break;default:return}return this._rotationDisabled&&(Oe=0,Fe=0),{cameraAnimation:He=>{const xt=He.getZoom();He.easeTo({duration:300,easeId:"keyboardHandler",easing:Na,zoom:Le?Math.round(xt)+Le*(F.shiftKey?2:1):xt,bearing:He.getBearing()+Oe*this._bearingStep,pitch:He.getPitch()+Fe*this._pitchStep,offset:[-je*this._panStep,-qe*this._panStep],center:He.getCenter()},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Na(F){return F*(2-F)}const kf=4.000244140625,Nf=1/450;class Ga{constructor(Le,Oe){this._map=Le,this._el=Le.getCanvasContainer(),this._handler=Oe,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Nf,F.aQ(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(F){this._defaultZoomRate=F}setWheelZoomRate(F){this._wheelZoomRate=F}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(F){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(Le){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(Le.ctrlKey||Le.metaKey||this.isZooming()||F.dC()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let Oe=Le.deltaMode===WheelEvent.DOM_DELTA_LINE?40*Le.deltaY:Le.deltaY;const Fe=F.q.now(),je=Fe-(this._lastWheelEventTime||0);this._lastWheelEventTime=Fe,0!==Oe&&Oe%kf==0?this._type="wheel":0!==Oe&&Math.abs(Oe)<4?this._type="trackpad":je>400?(this._type=null,this._lastValue=Oe,this._timeout=window.setTimeout(this._onTimeout,40,Le)):this._type||(this._type=Math.abs(je*Oe)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,Oe+=this._lastValue)),Le.shiftKey&&Oe&&(Oe/=4),this._type&&(this._lastWheelEvent=Le,this._delta-=Oe,this._active||this._start(Le)),Le.preventDefault()}_onTimeout(F){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(F)}_start(F){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const Le=g(this._el,F);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:Le,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const Le=this._map.transform;"wheel"===this._type&&Le.projection.wrap&&(Le._center.lng>=180||Le._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>Le._terrainEnabled()&&this._aroundCoord?Le.computeZoomRelativeTo(this._aroundCoord):Le.zoom;if(0!==this._delta){const F="wheel"===this._type&&Math.abs(this._delta)>kf?this._wheelZoomRate:this._defaultZoomRate;let Oe=2/(1+Math.exp(-Math.abs(this._delta*F)));this._delta<0&&0!==Oe&&(Oe=1/Oe);const Fe=i(),je=Math.pow(2,Fe),qe="number"==typeof this._targetZoom?Le.zoomScale(this._targetZoom):je;this._targetZoom=Math.min(Le.maxZoom,Math.max(Le.minZoom,Le.scaleZoom(qe*Oe))),"wheel"===this._type&&(this._startZoom=Fe,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const Oe="number"==typeof this._targetZoom?this._targetZoom:i(),Fe=this._startZoom,je=this._easing;let qe,He=!1;if("wheel"===this._type&&Fe&&je){const Le=Math.min((F.q.now()-this._lastWheelEventTime)/200,1),xt=je(Le);qe=F.ah(Fe,Oe,xt),Le<1?this._frameId||(this._frameId=!0):He=!0}else qe=Oe,He=!0;this._active=!0,He&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let xt=qe-i();return xt*this._lastDelta<0&&(xt=0),{noInertia:!0,needsRenderFrame:!He,zoomDelta:xt,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(Le){let Oe=F.dD;if(this._prevEase){const Le=this._prevEase,Fe=(F.q.now()-Le.start)/Le.duration,je=Le.easing(Fe+.01)-Le.easing(Fe),qe=.27/Math.sqrt(je*je+1e-4)*.01,He=Math.sqrt(.0729-qe*qe);Oe=F.dB(qe,He,.25,1)}return this._prevEase={start:F.q.now(),duration:Le,easing:Oe},Oe}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class ja{constructor(F,Le){this._clickZoom=F,this._tapZoom=Le}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class qa{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(F,Le){return F.preventDefault(),{cameraAnimation:Oe=>{Oe.easeTo({duration:300,zoom:Oe.getZoom()+(F.shiftKey?-1:1),around:Oe.unproject(Le)},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Ha{constructor(){this._tap=new xa({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(F,Le,Oe){this._swipePoint||(this._tapTime&&F.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?Oe.length>0&&(this._swipePoint=Le[0],this._swipeTouch=Oe[0].identifier):this._tap.touchstart(F,Le,Oe))}touchmove(F,Le,Oe){if(this._tapTime){if(this._swipePoint){if(Oe[0].identifier!==this._swipeTouch)return;const Fe=Le[0],je=Fe.y-this._swipePoint.y;return this._swipePoint=Fe,F.preventDefault(),this._active=!0,{zoomDelta:je/128}}}else this._tap.touchmove(F,Le,Oe)}touchend(F,Le,Oe){this._tapTime?this._swipePoint&&0===Oe.length&&this.reset():this._tap.touchend(F,Le,Oe)&&(this._tapTime=F.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Za{constructor(F,Le,Oe){this._el=F,this._mousePan=Le,this._touchPan=Oe}enable(F){this._inertiaOptions=F||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Wa{constructor(F,Le,Oe){this._pitchWithRotate=F.pitchWithRotate,this._mouseRotate=Le,this._mousePitch=Oe}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class $a{constructor(F,Le,Oe,Fe){this._el=F,this._touchZoom=Le,this._touchRotate=Oe,this._tapDragZoom=Fe,this._rotationDisabled=!1,this._enabled=!0}enable(F){this._touchZoom.enable(F),this._rotationDisabled||this._touchRotate.enable(F),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Xa=F=>F.zoom||F.drag||F.pitch||F.rotate;class Ka extends F.A{}class Ya{constructor(){this.constants=[1,1,.01],this.radius=0}setup(Le,Oe){const Fe=F.ad.vec3.sub([],Oe,Le);this.radius=F.ad.vec3.length(Fe[2]<0?F.ad.vec3.div([],Fe,this.constants):[Fe[0],Fe[1],0])}projectRay(Le){F.ad.vec3.div(Le,Le,this.constants),F.ad.vec3.normalize(Le,Le),F.ad.vec3.mul(Le,Le,this.constants);const Oe=F.ad.vec3.scale([],Le,this.radius);if(Oe[2]>0){const Le=F.ad.vec3.scale([],[0,0,1],F.ad.vec3.dot(Oe,[0,0,1])),Fe=F.ad.vec3.scale([],F.ad.vec3.normalize([],[Oe[0],Oe[1],0]),this.radius),je=F.ad.vec3.add([],Oe,F.ad.vec3.scale([],F.ad.vec3.sub([],F.ad.vec3.add([],Fe,Le),Oe),2));Oe[0]=je[0],Oe[1]=je[1]}return Oe}}function Ja(F){return F.panDelta&&F.panDelta.mag()||F.zoomDelta||F.bearingDelta||F.pitchDelta}class Qa{constructor(Le,Oe){this._map=Le,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ca(Le),this._bearingSnap=Oe.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Ya,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(Oe),F.aQ(["handleEvent","handleWindowEvent"],this);const Fe=this._el;this._listeners=[[Fe,"touchstart",{passive:!0}],[Fe,"touchmove",{passive:!1}],[Fe,"touchend",void 0],[Fe,"touchcancel",void 0],[Fe,"mousedown",void 0],[Fe,"mousemove",void 0],[Fe,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[Fe,"mouseover",void 0],[Fe,"mouseout",void 0],[Fe,"dblclick",void 0],[Fe,"click",void 0],[Fe,"keydown",{capture:!1}],[Fe,"keyup",void 0],[Fe,"wheel",{passive:!1}],[Fe,"contextmenu",void 0],[window,"blur",void 0]];for(const[F,Le,Oe]of this._listeners){const Fe=F===document?this.handleWindowEvent:this.handleEvent;F.addEventListener(Le,Fe,Oe)}}destroy(){for(const[F,Le,Oe]of this._listeners){const Fe=F===document?this.handleWindowEvent:this.handleEvent;F.removeEventListener(Le,Fe,Oe)}}_addDefaultHandlers(F){const Le=this._map,Oe=Le.getCanvasContainer();this._add("mapEvent",new fa(Le,F));const Fe=Le.boxZoom=new ga(Le,F);this._add("boxZoom",Fe);const je=new ba,qe=new qa;Le.doubleClickZoom=new ja(qe,je),this._add("tapZoom",je),this._add("clickZoom",qe);const He=new Ha;this._add("tapDragZoom",He);const xt=Le.touchPitch=new Fa(Le);this._add("touchPitch",xt);const jt=new Ca(F),Gt=new Ia(F);Le.dragRotate=new Wa(F,jt,Gt),this._add("mouseRotate",jt,["mousePitch"]),this._add("mousePitch",Gt,["mouseRotate"]);const bi=new Sa(F),wi=new Ra(Le,F);Le.dragPan=new Za(Oe,bi,wi),this._add("mousePan",bi),this._add("touchPan",wi,["touchZoom","touchRotate"]);const qr=new za,Xn=new Ma;Le.touchZoomRotate=new $a(Oe,Xn,qr,He),this._add("touchRotate",qr,["touchPan","touchZoom"]),this._add("touchZoom",Xn,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ma(Le));const Yn=Le.scrollZoom=new Ga(Le,this);this._add("scrollZoom",Yn,["mousePan"]);const yo=Le.keyboard=new Ba;this._add("keyboard",yo);for(const Oe of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])F.interactive&&F[Oe]&&Le[Oe].enable(F[Oe])}_add(F,Le,Oe){this._handlers.push({handlerName:F,handler:Le,allowed:Oe}),this._handlersById[F]=Le}stop(F){if(!this._updatingCamera){for(const{handler:F}of this._handlers)F.reset();this._inertia.clear(),this._fireEvents({},{},F),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:F}of this._handlers)if(F.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Xa(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(F,Le,Oe){for(const Fe in F)if(Fe!==Oe&&(!Le||Le.indexOf(Fe)<0))return!0;return!1}handleWindowEvent(F){this.handleEvent(F,`${F.type}Window`)}_getMapTouches(F){const Le=[];for(const Oe of F)this._el.contains(Oe.target)&&Le.push(Oe);return Le}handleEvent(F,Le){this._updatingCamera=!0;const Oe="renderFrame"===F.type,Fe=Oe?void 0:F,je={needsRenderFrame:!1},qe={},He={},xt=F.touches?this._getMapTouches(F.touches):void 0,jt=xt?v(this._el,xt):Oe?void 0:g(this._el,F);for(const{handlerName:Oe,handler:Gt,allowed:bi}of this._handlers){if(!Gt.isEnabled())continue;let wi;this._blockedByActive(He,bi,Oe)?Gt.reset():Gt[Le||F.type]&&(wi=Gt[Le||F.type](F,jt,xt),this.mergeHandlerResult(je,qe,wi,Oe,Fe),wi&&wi.needsRenderFrame&&this._triggerRenderFrame()),(wi||Gt.isActive())&&(He[Oe]=Gt)}const Gt={};for(const F in this._previousActiveHandlers)He[F]||(Gt[F]=Fe);this._previousActiveHandlers=He,(Object.keys(Gt).length||Ja(je))&&(this._changes.push([je,qe,Gt]),this._triggerRenderFrame()),(Object.keys(He).length||Ja(je))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:bi}=je;bi&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],bi(this._map))}mergeHandlerResult(Le,Oe,Fe,je,qe){if(!Fe)return;F.l(Le,Fe);const He={handlerName:je,originalEvent:Fe.originalEvent||qe};void 0!==Fe.zoomDelta&&(Oe.zoom=He),void 0!==Fe.panDelta&&(Oe.drag=He),void 0!==Fe.pitchDelta&&(Oe.pitch=He),void 0!==Fe.bearingDelta&&(Oe.rotate=He)}_applyChanges(){const Le={},Oe={},Fe={};for(const[je,qe,He]of this._changes)je.panDelta&&(Le.panDelta=(Le.panDelta||new F.P(0,0))._add(je.panDelta)),je.zoomDelta&&(Le.zoomDelta=(Le.zoomDelta||0)+je.zoomDelta),je.bearingDelta&&(Le.bearingDelta=(Le.bearingDelta||0)+je.bearingDelta),je.pitchDelta&&(Le.pitchDelta=(Le.pitchDelta||0)+je.pitchDelta),void 0!==je.around&&(Le.around=je.around),void 0!==je.aroundCoord&&(Le.aroundCoord=je.aroundCoord),void 0!==je.pinchAround&&(Le.pinchAround=je.pinchAround),je.noInertia&&(Le.noInertia=je.noInertia),F.l(Oe,qe),F.l(Fe,He);this._updateMapTransform(Le,Oe,Fe),this._changes=[]}_updateMapTransform(Le,Oe,Fe){const je=this._map,qe=je.transform,n=F=>[F.x,F.y,F.z];if((()=>{const F=this._eventsInProgress.drag;return F&&!this._handlersById[F.handlerName].isActive()})()&&!Ja(Le)){const F=qe.zoom;qe.cameraElevationReference="sea",null!=this._originalZoom&&qe._orthographicProjectionAtLowPitch&&"globe"!==qe.projection.name&&0===qe.pitch?(qe.cameraElevationReference="ground",qe.zoom=this._originalZoom):(qe.recenterOnTerrain(),qe.cameraElevationReference="ground"),F!==qe.zoom&&this._map._update(!0)}if(qe._isCameraConstrained&&je._stop(!0),!Ja(Le))return void this._fireEvents(Oe,Fe,!0);let{panDelta:He,zoomDelta:xt,bearingDelta:jt,pitchDelta:Gt,around:bi,aroundCoord:wi,pinchAround:qr}=Le;qe._isCameraConstrained&&(xt>0&&(xt=0),qe._isCameraConstrained=!1),void 0!==qr&&(bi=qr),(xt||(F=>Oe[F]&&!this._eventsInProgress[F])("drag"))&&bi&&(this._dragOrigin=n(qe.pointCoordinate3D(bi)),this._originalZoom=qe.zoom,this._trackingEllipsoid.setup(qe._camera.position,this._dragOrigin)),qe.cameraElevationReference="sea",je._stop(!0),bi=bi||je.transform.centerPoint,jt&&(qe.bearing+=jt),Gt&&(qe.pitch+=Gt),qe._updateCameraState();const Xn=[0,0,0];if(He)if("mercator"===qe.projection.name){const F=this._trackingEllipsoid.projectRay(qe.screenPointToMercatorRay(bi).dir),Le=this._trackingEllipsoid.projectRay(qe.screenPointToMercatorRay(bi.sub(He)).dir);Xn[0]=Le[0]-F[0],Xn[1]=Le[1]-F[1]}else{const Le=qe.pointCoordinate(bi);if("globe"===qe.projection.name){He=He.rotate(-qe.angle);const Oe=qe._pixelsPerMercatorPixel/qe.worldSize;Xn[0]=-He.x*F.dE(F.aT(Le.y))*Oe,Xn[1]=-He.y*F.dE(qe.center.lat)*Oe}else{const F=qe.pointCoordinate(bi.sub(He));Le&&F&&(Xn[0]=F.x-Le.x,Xn[1]=F.y-Le.y)}}const Yn=qe.zoom,yo=[0,0,0];if(xt){const Le=n(wi||qe.pointCoordinate3D(bi)),Oe={dir:F.ad.vec3.normalize([],F.ad.vec3.sub([],Le,qe._camera.position))};if(Oe.dir[2]<0){const Fe=qe.zoomDeltaToMovement(Le,xt);F.ad.vec3.scale(yo,Oe.dir,Fe)}}const bo=F.ad.vec3.add(Xn,Xn,yo);qe._translateCameraConstrained(bo),xt&&Math.abs(qe.zoom-Yn)>1e-4&&qe.recenterOnTerrain(),qe.cameraElevationReference="ground",this._map._update(),Le.noInertia||this._inertia.record(Le),this._fireEvents(Oe,Fe,!0)}_fireEvents(Le,Oe,Fe){const je=Xa(this._eventsInProgress),qe=Xa(Le),He={};for(const F in Le){const{originalEvent:Oe}=Le[F];this._eventsInProgress[F]||(He[`${F}start`]=Oe),this._eventsInProgress[F]=Le[F]}!je&&qe&&this._fireEvent("movestart",qe.originalEvent);for(const F in He)this._fireEvent(F,He[F]);qe&&this._fireEvent("move",qe.originalEvent);for(const F in Le){const{originalEvent:Oe}=Le[F];this._fireEvent(F,Oe)}const xt={};let jt;for(const F in this._eventsInProgress){const{handlerName:Le,originalEvent:Fe}=this._eventsInProgress[F];this._handlersById[Le].isActive()||(delete this._eventsInProgress[F],jt=Oe[Le]||Fe,xt[`${F}end`]=jt)}for(const F in xt)this._fireEvent(F,xt[F]);const Gt=Xa(this._eventsInProgress);if(Fe&&(je||qe)&&!Gt){this._updatingCamera=!0;const Le=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=F=>0!==F&&-this._bearingSnap<F&&F<this._bearingSnap;Le?(i(Le.bearing||this._map.getBearing())&&(Le.bearing=0),this._map.easeTo(Le,{originalEvent:jt})):(this._map.fire(new F.A("moveend",{originalEvent:jt})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(Le,Oe){this._map.fire(new F.A(Le,Oe?{originalEvent:Oe}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((F=>{this._frameId=void 0,this.handleEvent(new Ka("renderFrame",{timeStamp:F})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Gf="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class tl extends F.E{constructor(Le,Oe){super(),this._moving=!1,this._zooming=!1,this.transform=Le,this._bearingSnap=Oe.bearingSnap,this._respectPrefersReducedMotion=!1!==Oe.respectPrefersReducedMotion,F.aQ(["_renderFrameCallback"],this)}getCenter(){return new F.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(F,Le){return this.jumpTo({center:F},Le)}panBy(Le,Oe,Fe){return Le=F.P.convert(Le).mult(-1),this.panTo(this.transform.center,F.l({offset:Le},Oe),Fe)}panTo(Le,Oe,Fe){return this.easeTo(F.l({center:Le},Oe),Fe)}getZoom(){return this.transform.zoom}setZoom(F,Le){return this.jumpTo({zoom:F},Le),this}zoomTo(Le,Oe,Fe){return this.easeTo(F.l({zoom:Le},Oe),Fe)}zoomIn(F,Le){return this.zoomTo(this.getZoom()+1,F,Le),this}zoomOut(F,Le){return this.zoomTo(this.getZoom()-1,F,Le),this}getBearing(){return this.transform.bearing}setBearing(F,Le){return this.jumpTo({bearing:F},Le),this}getPadding(){return this.transform.padding}setPadding(F,Le){return this.jumpTo({padding:F},Le),this}rotateTo(Le,Oe,Fe){return this.easeTo(F.l({bearing:Le},Oe),Fe)}resetNorth(Le,Oe){return this.rotateTo(0,F.l({duration:1e3},Le),Oe),this}resetNorthPitch(Le,Oe){return this.easeTo(F.l({bearing:0,pitch:0,duration:1e3},Le),Oe),this}snapToNorth(F,Le){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(F,Le):this}getPitch(){return this.transform.pitch}setPitch(F,Le){return this.jumpTo({pitch:F},Le),this}cameraForBounds(Le,Oe){Le=F.aB.convert(Le);const Fe=Oe&&Oe.bearing||0,je=Oe&&Oe.pitch||0,qe=Le.getNorthWest(),He=Le.getSouthEast();return this._cameraForBounds(this.transform,qe,He,Fe,je,Oe)}_extendPadding(Le){const Oe={top:0,right:0,bottom:0,left:0};return null==Le?F.l({},Oe,this.transform.padding):"number"==typeof Le?{top:Le,bottom:Le,right:Le,left:Le}:F.l({},Oe,Le)}_extendCameraOptions(Le){return(Le=F.l({offset:[0,0],maxZoom:this.transform.maxZoom},Le)).padding=this._extendPadding(Le.padding),Le}_minimumAABBFrustumDistance(F,Le){const Oe=Le.max[0]-Le.min[0],Fe=Le.max[1]-Le.min[1];return Oe/Fe>F.aspect?Oe/(2*Math.tan(.5*F.fovX)*F.aspect):Fe/(2*Math.tan(.5*F.fovY)*F.aspect)}_cameraForBoundsOnGlobe(Le,Oe,Fe,je,qe,He){const xt=Le.clone(),jt=this._extendCameraOptions(He);xt.bearing=je,xt.pitch=qe;const Gt=F.bO.convert(Oe),bi=F.bO.convert(Fe),wi=.5*(Gt.lat+bi.lat),qr=.5*(Gt.lng+bi.lng),Xn=F.dF(wi,qr),Yn=F.ad.vec3.normalize([],Xn),yo=F.ad.vec3.normalize([],F.ad.vec3.cross([],Yn,[0,1,0])),bo=F.ad.vec3.cross([],yo,Yn),Do=[yo[0],yo[1],yo[2],0,bo[0],bo[1],bo[2],0,Yn[0],Yn[1],Yn[2],0,0,0,0,1],Ro=[Xn,F.dF(Gt.lat,Gt.lng),F.dF(bi.lat,Gt.lng),F.dF(bi.lat,bi.lng),F.dF(Gt.lat,bi.lng),F.dF(wi,Gt.lng),F.dF(wi,bi.lng),F.dF(Gt.lat,qr),F.dF(bi.lat,qr)];let zs=F.ce.fromPoints(Ro.map((Le=>[F.ad.vec3.dot(yo,Le),F.ad.vec3.dot(bo,Le),F.ad.vec3.dot(Yn,Le)])));const Zs=F.ad.vec3.transformMat4([],zs.center,Do);0===F.ad.vec3.squaredLength(Zs)&&F.ad.vec3.set(Zs,0,0,1),F.ad.vec3.normalize(Zs,Zs),F.ad.vec3.scale(Zs,Zs,F.az),xt.center=F.dG(Zs);const na=xt.getWorldToCameraMatrix(),el=F.ad.mat4.invert(new Float64Array(16),na);zs=F.ce.applyTransform(zs,F.ad.mat4.multiply([],na,Do));const nl=this._extendAABB(zs,xt,jt,je);if(!nl)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");zs=nl,F.ad.vec3.transformMat4(Zs,Zs,na);const hl=.5*(zs.max[2]-zs.min[2]),pl=this._minimumAABBFrustumDistance(xt,zs),bl=F.ad.vec3.scale([],[0,0,1],hl),Tl=F.ad.vec3.add(bl,Zs,bl),kl=pl+(0===xt.pitch?0:F.ad.vec3.distance(Zs,Tl)),ec=xt.globeCenterInViewSpace,tc=F.ad.vec3.sub([],Zs,[ec[0],ec[1],ec[2]]);F.ad.vec3.normalize(tc,tc),F.ad.vec3.scale(tc,tc,kl);const ic=F.ad.vec3.add([],Zs,tc);F.ad.vec3.transformMat4(ic,ic,el);const oc=F.dv/F.az,sc=F.ad.vec3.length(ic),ac=F.bH(Math.max(sc*oc-F.dv,Number.EPSILON),0),mc=Math.min(xt.zoomFromMercatorZAdjusted(ac),jt.maxZoom);return mc>.5*(F.c6+F.bY)?(xt.setProjection({name:"mercator"}),xt.zoom=mc,this._cameraForBounds(xt,Oe,Fe,je,qe,He)):{center:xt.center,zoom:mc,bearing:je,pitch:qe}}_extendAABB(Le,Oe,Fe,je){const qe=.5*((Fe.padding.left||0)+(Fe.padding.right||0)),He=.5*((Fe.padding.top||0)+(Fe.padding.bottom||0)),xt=He,jt=qe,Gt=qe,bi=He,wi=Oe.width-(jt+Gt),qr=Oe.height-(xt+bi),Xn=F.ad.vec3.sub([],Le.max,Le.min),Yn=Math.min(wi/Xn[0],qr/Xn[1]),yo=Math.min(Oe.scaleZoom(Oe.scale*Yn),Fe.maxZoom);if(isNaN(yo))return null;const bo=Oe.scale/Oe.zoomScale(yo),Do=new F.ce([Le.min[0]-jt*bo,Le.min[1]-bi*bo,Le.min[2]],[Le.max[0]+Gt*bo,Le.max[1]+xt*bo,Le.max[2]]),Ro=("number"==typeof Fe.offset.x&&"number"==typeof Fe.offset.y?new F.P(Fe.offset.x,Fe.offset.y):F.P.convert(Fe.offset)).rotate(-F.ak(je));return Do.center[0]-=Ro.x*bo,Do.center[1]+=Ro.y*bo,Do}queryTerrainElevation(Le,Oe){const Fe=this.transform.elevation;return Fe?(Oe=F.l({},{exaggerated:!0},Oe),Fe.getAtPoint(F.ac.fromLngLat(Le),null,Oe.exaggerated)):null}_cameraForBounds(Le,Oe,Fe,je,qe,He){if("globe"===Le.projection.name)return this._cameraForBoundsOnGlobe(Le,Oe,Fe,je,qe,He);const xt=Le.clone(),jt=this._extendCameraOptions(He);xt.bearing=je,xt.pitch=qe;const Gt=F.bO.convert(Oe),bi=F.bO.convert(Fe),wi=new F.bO(Gt.lng,bi.lat),qr=new F.bO(bi.lng,Gt.lat),Xn=xt.project(Gt),Yn=xt.project(bi),yo=this.queryTerrainElevation(Gt),bo=this.queryTerrainElevation(bi),Do=this.queryTerrainElevation(wi),Ro=this.queryTerrainElevation(qr),zs=[[Xn.x,Xn.y,Math.min(yo||0,bo||0,Do||0,Ro||0)],[Yn.x,Yn.y,Math.max(yo||0,bo||0,Do||0,Ro||0)]];let Zs=F.ce.fromPoints(zs);const na=xt.getWorldToCameraMatrix(),el=F.ad.mat4.invert(new Float64Array(16),na);Zs=F.ce.applyTransform(Zs,na);const nl=this._extendAABB(Zs,xt,jt,je);if(!nl)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");Zs=nl;const hl=.5*F.ad.vec3.sub([],Zs.max,Zs.min)[2],pl=this._minimumAABBFrustumDistance(xt,Zs),bl=[0,0,1,0];F.ad.vec4.transformMat4(bl,bl,na),F.ad.vec4.normalize(bl,bl);const Tl=F.ad.vec3.scale([],bl,pl+hl),kl=F.ad.vec3.add([],Zs.center,Tl);F.ad.vec3.transformMat4(Zs.center,Zs.center,el),F.ad.vec3.transformMat4(kl,kl,el);const ec=xt.unproject(new F.P(Zs.center[0],Zs.center[1])),tc=F.dH(xt.projection,ec),ic=Math.pow(2,tc),oc=Math.min(xt._zoomFromMercatorZ(kl[2]*xt.pixelsPerMeter*ic/xt.worldSize),jt.maxZoom);return xt.mercatorFromTransition&&oc<.5*(F.c6+F.bY)?(xt.setProjection({name:"globe"}),xt.zoom=oc,this._cameraForBounds(xt,Oe,Fe,je,qe,He)):{center:ec,zoom:oc,bearing:je,pitch:qe}}fitBounds(F,Le,Oe){const Fe=this.cameraForBounds(F,Le);return this._fitInternal(Fe,Le,Oe)}fitScreenCoordinates(Le,Oe,Fe,je,qe){const He=F.P.convert(Le),xt=F.P.convert(Oe),jt=new F.P(Math.min(He.x,xt.x),Math.min(He.y,xt.y)),Gt=new F.P(Math.max(He.x,xt.x),Math.max(He.y,xt.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(He,xt))return this;const bi=this.transform.pointLocation3D(jt),wi=this.transform.pointLocation3D(Gt),qr=this.transform.pointLocation3D(new F.P(jt.x,Gt.y)),Xn=this.transform.pointLocation3D(new F.P(Gt.x,jt.y)),Yn=[Math.min(bi.lng,wi.lng,qr.lng,Xn.lng),Math.min(bi.lat,wi.lat,qr.lat,Xn.lat)],yo=[Math.max(bi.lng,wi.lng,qr.lng,Xn.lng),Math.max(bi.lat,wi.lat,qr.lat,Xn.lat)],bo=je&&je.pitch?je.pitch:this.getPitch(),Do=this._cameraForBounds(this.transform,Yn,yo,Fe,bo,je);return this._fitInternal(Do,je,qe)}_fitInternal(Le,Oe,Fe){return Le?(Oe=F.l(Le,Oe)).linear?this.easeTo(Oe,Fe):this.flyTo(Oe,Fe):this}jumpTo(Le,Oe){this.stop();const Fe=Le.preloadOnly?this.transform.clone():this.transform;let je=!1,qe=!1,He=!1;"zoom"in Le&&Fe.zoom!==+Le.zoom&&(je=!0,Fe.zoom=+Le.zoom),void 0!==Le.center&&(Fe.center=F.bO.convert(Le.center)),"bearing"in Le&&Fe.bearing!==+Le.bearing&&(qe=!0,Fe.bearing=+Le.bearing),"pitch"in Le&&Fe.pitch!==+Le.pitch&&(He=!0,Fe.pitch=+Le.pitch);const xt="number"==typeof Le.padding?this._extendPadding(Le.padding):Le.padding;if(null!=Le.padding&&!Fe.isPaddingEqual(xt))if(!1===Le.retainPadding){const F=Fe.clone();F.padding=xt,Fe.setLocationAtPoint(Fe.center,F.centerPoint)}else Fe.padding=xt;return Le.preloadOnly?(this._preloadTiles(Fe),this):(this.fire(new F.A("movestart",Oe)).fire(new F.A("move",Oe)),je&&this.fire(new F.A("zoomstart",Oe)).fire(new F.A("zoom",Oe)).fire(new F.A("zoomend",Oe)),qe&&this.fire(new F.A("rotatestart",Oe)).fire(new F.A("rotate",Oe)).fire(new F.A("rotateend",Oe)),He&&this.fire(new F.A("pitchstart",Oe)).fire(new F.A("pitch",Oe)).fire(new F.A("pitchend",Oe)),this.fire(new F.A("moveend",Oe)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||F.w(Gf),this.transform.getFreeCameraOptions()}setFreeCameraOptions(Le,Oe){const Fe=this.transform;if(!Fe.projection.supportsFreeCamera)return F.w(Gf),this;this.stop();const je=Fe.zoom,qe=Fe.pitch,He=Fe.bearing;Fe.setFreeCameraOptions(Le);const xt=je!==Fe.zoom,jt=qe!==Fe.pitch,Gt=He!==Fe.bearing;return this.fire(new F.A("movestart",Oe)).fire(new F.A("move",Oe)),xt&&this.fire(new F.A("zoomstart",Oe)).fire(new F.A("zoom",Oe)).fire(new F.A("zoomend",Oe)),Gt&&this.fire(new F.A("rotatestart",Oe)).fire(new F.A("rotate",Oe)).fire(new F.A("rotateend",Oe)),jt&&this.fire(new F.A("pitchstart",Oe)).fire(new F.A("pitch",Oe)).fire(new F.A("pitchend",Oe)),this.fire(new F.A("moveend",Oe)),this}easeTo(Le,Oe){this._stop(!1,Le.easeId),(!1===(Le=F.l({offset:[0,0],duration:500,easing:F.dD},Le)).animate||this._prefersReducedMotion(Le))&&(Le.duration=0);const Fe=this.transform,je=this.getZoom(),qe=this.getBearing(),He=this.getPitch(),xt=this.getPadding(),jt="zoom"in Le?+Le.zoom:je,Gt="bearing"in Le?this._normalizeBearing(Le.bearing,qe):qe,bi="pitch"in Le?+Le.pitch:He,wi=this._extendPadding(Le.padding),qr=F.P.convert(Le.offset);let Xn,Yn,yo;if("globe"===Fe.projection.name){const Oe=F.ac.fromLngLat(Fe.center),je=qr.rotate(-Fe.angle);Oe.x+=je.x/Fe.worldSize,Oe.y+=je.y/Fe.worldSize;const qe=Oe.toLngLat(),He=F.bO.convert(Le.center||qe);this._normalizeCenter(He),Xn=Fe.centerPoint.add(je),Yn=new F.P(Oe.x,Oe.y).mult(Fe.worldSize),yo=new F.P(F.av(He.lng),F.aC(He.lat)).mult(Fe.worldSize).sub(Yn)}else{Xn=Fe.centerPoint.add(qr);const Oe=Fe.pointLocation(Xn),je=F.bO.convert(Le.center||Oe);this._normalizeCenter(je),Yn=Fe.project(Oe),yo=Fe.project(je).sub(Yn)}const bo=Fe.zoomScale(jt-je);let Do,Ro;Le.around&&(Do=F.bO.convert(Le.around),Ro=Fe.locationPoint(Do));const zs=this._zooming||jt!==je,Zs=this._rotating||qe!==Gt,na=this._pitching||bi!==He,el=!Fe.isPaddingEqual(wi),nl=!1===Le.retainPadding?Fe.clone():Fe,E=Fe=>hl=>{if(zs&&(Fe.zoom=F.ah(je,jt,hl)),Zs&&(Fe.bearing=F.ah(qe,Gt,hl)),na&&(Fe.pitch=F.ah(He,bi,hl)),el&&(nl.interpolatePadding(xt,wi,hl),Xn=nl.centerPoint.add(qr)),Do)Fe.setLocationAtPoint(Do,Ro);else{const F=Fe.zoomScale(Fe.zoom-je),Le=jt>je?Math.min(2,bo):Math.max(.5,bo),Oe=Math.pow(Le,1-hl),qe=Fe.unproject(Yn.add(yo.mult(hl*Oe)).mult(F));Fe.setLocationAtPoint(Fe.renderWorldCopies?qe.wrap():qe,Xn)}return Le.preloadOnly||this._fireMoveEvents(Oe),Fe};if(Le.preloadOnly){const F=this._emulate(E,Le.duration,Fe);return this._preloadTiles(F),this}const hl={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=zs,this._rotating=Zs,this._pitching=na,this._padding=el,this._easeId=Le.easeId,this._prepareEase(Oe,Le.noMoveStart,hl),this._ease(E(Fe),(F=>{"sea"===Fe.cameraElevationReference&&Fe.recenterOnTerrain(),this._afterEase(Oe,F)}),Le),this}_prepareEase(Le,Oe,Fe={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),Oe||Fe.moving||this.fire(new F.A("movestart",Le)),this._zooming&&!Fe.zooming&&this.fire(new F.A("zoomstart",Le)),this._rotating&&!Fe.rotating&&this.fire(new F.A("rotatestart",Le)),this._pitching&&!Fe.pitching&&this.fire(new F.A("pitchstart",Le))}_fireMoveEvents(Le){this.fire(new F.A("move",Le)),this._zooming&&this.fire(new F.A("zoom",Le)),this._rotating&&this.fire(new F.A("rotate",Le)),this._pitching&&this.fire(new F.A("pitch",Le))}_afterEase(Le,Oe){if(this._easeId&&Oe&&this._easeId===Oe)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const Fe=this._zooming,je=this._rotating,qe=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,Fe&&this.fire(new F.A("zoomend",Le)),je&&this.fire(new F.A("rotateend",Le)),qe&&this.fire(new F.A("pitchend",Le)),this.fire(new F.A("moveend",Le))}flyTo(Le,Oe){if(this._prefersReducedMotion(Le)){const Fe=F.aA(Le,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Fe,Oe)}this.stop(),Le=F.l({offset:[0,0],speed:1.2,curve:1.42,easing:F.dD},Le);const Fe=this.transform,je=this.getZoom(),qe=this.getBearing(),He=this.getPitch(),xt=this.getPadding(),jt="zoom"in Le?F.ay(+Le.zoom,Fe.minZoom,Fe.maxZoom):je,Gt="bearing"in Le?this._normalizeBearing(Le.bearing,qe):qe,bi="pitch"in Le?+Le.pitch:He,wi=this._extendPadding(Le.padding),qr=Fe.zoomScale(jt-je),Xn=F.P.convert(Le.offset);let Yn=Fe.centerPoint.add(Xn);const yo=Fe.pointLocation(Yn),bo=F.bO.convert(Le.center||yo);this._normalizeCenter(bo);const Do=Fe.project(yo),Ro=Fe.project(bo).sub(Do);let zs=Le.curve;const Zs=Math.max(Fe.width,Fe.height),na=Zs/qr,el=Ro.mag();if("minZoom"in Le){const Oe=F.ay(Math.min(Le.minZoom,je,jt),Fe.minZoom,Fe.maxZoom),qe=Zs/Fe.zoomScale(Oe-je);zs=Math.sqrt(qe/el*2)}const nl=zs*zs;function E(F){const Le=(na*na-Zs*Zs+(F?-1:1)*nl*nl*el*el)/(2*(F?na:Zs)*nl*el);return Math.log(Math.sqrt(Le*Le+1)-Le)}function S(F){return(Math.exp(F)-Math.exp(-F))/2}function C(F){return(Math.exp(F)+Math.exp(-F))/2}const hl=E(0);let R=function(F){return C(hl)/C(hl+zs*F)},D=function(F){return Zs*((C(hl)*(S(Le=hl+zs*F)/C(Le))-S(hl))/nl)/el;var Le},pl=(E(1)-hl)/zs;if(Math.abs(el)<1e-6||!isFinite(pl)){if(Math.abs(Zs-na)<1e-6)return this.easeTo(Le,Oe);const F=na<Zs?-1:1;pl=Math.abs(Math.log(na/Zs))/zs,D=function(){return 0},R=function(Le){return Math.exp(F*zs*Le)}}Le.duration="duration"in Le?+Le.duration:1e3*pl/("screenSpeed"in Le?+Le.screenSpeed/zs:+Le.speed),Le.maxDuration&&Le.duration>Le.maxDuration&&(Le.duration=0);const bl=qe!==Gt,Tl=bi!==He,kl=!Fe.isPaddingEqual(wi),ec=!1===Le.retainPadding?Fe.clone():Fe,O=Fe=>qr=>{const yo=qr*pl,zs=1/R(yo);Fe.zoom=1===qr?jt:je+Fe.scaleZoom(zs),bl&&(Fe.bearing=F.ah(qe,Gt,qr)),Tl&&(Fe.pitch=F.ah(He,bi,qr)),kl&&(ec.interpolatePadding(xt,wi,qr),Yn=ec.centerPoint.add(Xn));const Zs=1===qr?bo:Fe.unproject(Do.add(Ro.mult(D(yo))).mult(zs));return Fe.setLocationAtPoint(Fe.renderWorldCopies?Zs.wrap():Zs,Yn),Fe._updateCameraOnTerrain(),Le.preloadOnly||this._fireMoveEvents(Oe),Fe};if(Le.preloadOnly){const F=this._emulate(O,Le.duration,Fe);return this._preloadTiles(F),this}return this._zooming=!0,this._rotating=bl,this._pitching=Tl,this._padding=kl,this._prepareEase(Oe,!1),this._ease(O(Fe),(()=>this._afterEase(Oe)),Le),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(F){}_cancelRenderFrame(F){}_stop(F,Le){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const F=this._onEaseEnd;this._onEaseEnd=void 0,F.call(this,Le)}if(!F){const F=this.handlers;F&&F.stop(!1)}return this}_ease(Le,Oe,Fe){!1===Fe.animate||0===Fe.duration?(Le(1),Oe()):(this._easeStart=F.q.now(),this._easeOptions=Fe,this._onEaseFrame=Le,this._onEaseEnd=Oe,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const Le=Math.min((F.q.now()-this._easeStart)/this._easeOptions.duration,1),Oe=this._onEaseFrame;Oe&&Oe(this._easeOptions.easing(Le)),Le<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(Le,Oe){Le=F.bF(Le,-180,180);const Fe=Math.abs(Le-Oe);return Math.abs(Le-360-Oe)<Fe&&(Le-=360),Math.abs(Le+360-Oe)<Fe&&(Le+=360),Le}_normalizeCenter(F){const Le=this.transform;if(Le.maxBounds)return;if("globe"!==Le.projection.name&&!Le.renderWorldCopies)return;const Oe=F.lng-Le.center.lng;F.lng+=Oe>180?-360:Oe<-180?360:0}_prefersReducedMotion(Le){return this._respectPrefersReducedMotion&&F.q.prefersReducedMotion&&!(Le&&Le.essential)}_emulate(F,Le,Oe){const Fe=Math.ceil(15*Le/1e3),je=[],qe=F(Oe.clone());for(let F=0;F<=Fe;F++){const Le=qe(F/Fe);je.push(Le.clone())}return je}_preloadTiles(F,Le){}}class il{constructor(Le={}){this.options=Le,F.aQ(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(F){const Le=this.options&&this.options.compact,Oe=F._getUIString("AttributionControl.ToggleAttribution");this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=l("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",Oe);const Fe=l("span","mapboxgl-ctrl-icon",this._compactButton);return Fe.setAttribute("aria-hidden","true"),Fe.setAttribute("title",Oe),this._innerContainer=l("div","mapboxgl-ctrl-attrib-inner",this._container),Le&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===Le&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let Le=this._editLink;Le||(Le=this._editLink=this._container.querySelector(".mapbox-improve-map"));const Oe=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||F.e.ACCESS_TOKEN}];if(Le){const Fe=Oe.reduce(((F,Le,Fe)=>(Le.value&&(F+=`${Le.key}=${Le.value}${Fe<Oe.length-1?"&":""}`),F)),"?");Le.href=`${F.e.FEEDBACK_URL}/${Fe}#${oa(this._map,!0)}`,Le.rel="noopener nofollow"}}_updateData(F){!F||"metadata"!==F.sourceDataType&&"visibility"!==F.sourceDataType&&"style"!==F.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let F=[];if(this._map.style.stylesheet){const F=this._map.style.stylesheet;this.styleOwner=F.owner,this.styleId=F.id}const Le=this._map.style._mergedSourceCaches;for(const Oe in Le){const Fe=Le[Oe];if(Fe.used){const Le=Fe.getSource();Le.attribution&&F.indexOf(Le.attribution)<0&&F.push(Le.attribution)}}F.sort(((F,Le)=>F.length-Le.length)),F=F.filter(((Le,Oe)=>{for(let Fe=Oe+1;Fe<F.length;Fe++)if(F[Fe].indexOf(Le)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?F=[...this.options.customAttribution,...F]:F.unshift(this.options.customAttribution));const Oe=F.join(" | ");Oe!==this._attribHTML&&(this._attribHTML=Oe,F.length?(this._innerContainer.innerHTML=Oe,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class ol{constructor(){F.aQ(["_updateLogo","_updateCompact"],this)}onAdd(F){this._map=F,this._container=l("div","mapboxgl-ctrl");const Le=l("a","mapboxgl-ctrl-logo");return Le.target="_blank",Le.rel="noopener nofollow",Le.href="https://www.mapbox.com/",Le.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),Le.setAttribute("rel","noopener nofollow"),this._container.appendChild(Le),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(F){F&&"metadata"!==F.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const F=this._map.style._sourceCaches;if(0===Object.entries(F).length)return!0;for(const Le in F){const Oe=F[Le].getSource();if(Oe.hasOwnProperty("mapbox_logo")&&!Oe.mapbox_logo)return!1}return!0}_updateCompact(){const F=this._container.children;if(F.length){const Le=F[0];this._map.getCanvasContainer().offsetWidth<250?Le.classList.add("mapboxgl-compact"):Le.classList.remove("mapboxgl-compact")}}}class sl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(F){const Le=++this._id;return this._queue.push({callback:F,id:Le,cancelled:!1}),Le}remove(F){const Le=this._currentlyRunning,Oe=Le?this._queue.concat(Le):this._queue;for(const Le of Oe)if(Le.id===F)return void(Le.cancelled=!0)}run(F=0){const Le=this._currentlyRunning=this._queue;this._queue=[];for(const Oe of Le)if(!Oe.cancelled&&(Oe.callback(F),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class rl{constructor(F){this.jumpTo(F)}getValue(Le){if(Le<=this._startTime)return this._start;if(Le>=this._endTime)return this._end;const Oe=F.cC((Le-this._startTime)/(this._endTime-this._startTime));return this._start*(1-Oe)+this._end*Oe}isEasing(F){return F>=this._startTime&&F<=this._endTime}jumpTo(F){this._startTime=-1/0,this._endTime=-1/0,this._start=F,this._end=F}easeTo(F,Le,Oe){this._start=this.getValue(Le),this._end=F,this._startTime=Le,this._endTime=Le+Oe}}const $f={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class al extends F.A{constructor(F,Le,Oe,Fe){const{point:je,lngLat:qe,originalEvent:He,target:xt}=F;super(F.type,{point:je,lngLat:qe,originalEvent:He,target:xt}),this.preventDefault=()=>{F.preventDefault()},this.id=Le,this.interaction=Oe,this.feature=Fe}}class ll{constructor(F){this.map=F,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(Le,Oe){if(this.typeById.has(Le))throw new Error(`Interaction id "${Le}" already exists.`);const Fe=Oe.filter;let je=Oe.type;Fe&&this.filters.set(Le,F.a_(Fe)),"mouseover"===je&&(je="mouseenter"),"mouseout"===je&&(je="mouseleave");const qe=this.interactionsByType.get(je)||new Map;"mouseenter"===je||"mouseleave"===je?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(Le,Oe)):0===qe.size&&this.map.on(je,this.handleType),0===qe.size&&this.interactionsByType.set(je,qe),qe.set(Le,Oe),this.typeById.set(Le,je)}get(F){const Le=this.typeById.get(F);if(!Le)return;const Oe=this.interactionsByType.get(Le);return Oe?Oe.get(F):void 0}remove(F){const Le=this.typeById.get(F);if(!Le)return;this.typeById.delete(F),this.filters.delete(F);const Oe=this.interactionsByType.get(Le);Oe&&(Oe.delete(F),"mouseenter"===Le||"mouseleave"===Le?(this.delegatedInteractions.delete(F),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===Oe.size&&this.map.off(Le,this.handleType))}queryTargets(F,Le){const Oe=[];for(const[F,Fe]of Le)Fe.target&&Oe.push({targetId:F,target:Fe.target,filter:this.filters.get(F)});return this.map.style.queryRenderedTargets(F,Oe,this.map.transform)}handleMove(F){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const Le=this.queryTargets(F.point,Array.from(this.delegatedInteractions).reverse());Le.length&&(F.type="mouseenter",this.handleType(F,Le));const Oe=new Map;for(const[F,{feature:Le}]of this.prevHoveredFeatures)this.hoveredFeatures.has(F)||Oe.set(Le.id,Le);Oe.size&&(F.type="mouseleave",this.handleType(F,Array.from(Oe.values())))}handleOut(F){const Le=Array.from(this.hoveredFeatures.values()).map((({feature:F})=>F));Le.length&&(F.type="mouseleave",this.handleType(F,Le)),this.hoveredFeatures.clear()}handleType(Le,Oe){const Fe=Array.from(this.interactionsByType.get(Le.type)).reverse(),je=!!Oe;Oe=Oe||this.queryTargets(Le.point,Fe);const qe="mouseenter"===Le.type;let He=!1;const xt=new Set;for(const jt of Oe){for(const[Oe,Gt]of Fe){if(!Gt.target)continue;const Fe=jt.variants?jt.variants[Oe]:null;if(Fe){for(const bi of Fe){if(at(bi,jt,xt,Oe))continue;const Fe=new F.cx(jt,bi),wi=nt(bi,jt,Oe);je&&(Fe.state=this.map.getFeatureState(Fe));const qr=qe?this.prevHoveredFeatures.get(wi):null,Xn=new al(Le,Oe,Gt,Fe),Yn=qr?qr.stop:Gt.handler(Xn);if(qe&&this.hoveredFeatures.set(wi,{feature:jt,stop:Yn}),!1!==Yn){He=!0;break}}if(He)break}}if(He)break}if(!He)for(const[F,Oe]of Fe){const{handler:Fe,target:je}=Oe;if(!je&&!1!==Fe(new al(Le,F,Oe,null)))break}}}function cl(Le,Oe){if(Array.isArray(Le)&&Array.isArray(Oe)){const F=new Set(Le),Fe=new Set(Oe);return F.size===Fe.size&&Le.every((F=>Fe.has(F)))}return F.bn(Le,Oe)}const im={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},rm={showCompass:!0,showZoom:!0,visualizePitch:!1};class ul{constructor(Le,Oe,Fe=!1){this._clickTolerance=10,this.element=Oe,this.mouseRotate=new Ca({clickTolerance:Le.dragRotate._mouseRotate._clickTolerance}),this.map=Le,Fe&&(this.mousePitch=new Ia({clickTolerance:Le.dragRotate._mousePitch._clickTolerance})),F.aQ(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),Oe.addEventListener("mousedown",this.mousedown),Oe.addEventListener("touchstart",this.touchstart,{passive:!1}),Oe.addEventListener("touchmove",this.touchmove),Oe.addEventListener("touchend",this.touchend),Oe.addEventListener("touchcancel",this.reset)}down(F,Le){this.mouseRotate.mousedown(F,Le),this.mousePitch&&this.mousePitch.mousedown(F,Le),_()}move(F,Le){const Oe=this.map,Fe=this.mouseRotate.mousemoveWindow(F,Le),je=Fe&&Fe.bearingDelta;if(je&&Oe.setBearing(Oe.getBearing()+je),this.mousePitch){const Fe=this.mousePitch.mousemoveWindow(F,Le),je=Fe&&Fe.pitchDelta;je&&Oe.setPitch(Oe.getPitch()+je)}}off(){const F=this.element;F.removeEventListener("mousedown",this.mousedown),F.removeEventListener("touchstart",this.touchstart,{passive:!1}),F.removeEventListener("touchmove",this.touchmove),F.removeEventListener("touchend",this.touchend),F.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){p(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(Le){this.down(F.l({},Le,{ctrlKey:!0,preventDefault:()=>Le.preventDefault()}),g(this.element,Le)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(F){this.move(F,g(this.element,F))}mouseup(F){this.mouseRotate.mouseupWindow(F),this.mousePitch&&this.mousePitch.mouseupWindow(F),this.offTemp()}touchstart(F){1!==F.targetTouches.length?this.reset():(this._startPos=this._lastPos=v(this.element,F.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>F.preventDefault()},this._startPos))}touchmove(F){1!==F.targetTouches.length?this.reset():(this._lastPos=v(this.element,F.targetTouches)[0],this.move({preventDefault:()=>F.preventDefault()},this._lastPos))}touchend(F){0===F.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function _l(Le,Oe,Fe){if(Le=new F.bO(Le.lng,Le.lat),Oe){const je=new F.bO(Le.lng-360,Le.lat),qe=new F.bO(Le.lng+360,Le.lat),He=360*Math.ceil(Math.abs(Le.lng-Fe.center.lng)/360),xt=Fe.locationPoint3D(Le).distSqr(Oe),jt=Oe.x<0||Oe.y<0||Oe.x>Fe.width||Oe.y>Fe.height;Fe.locationPoint3D(je).distSqr(Oe)<xt&&(jt||Math.abs(je.lng-Fe.center.lng)<He)?Le=je:Fe.locationPoint3D(qe).distSqr(Oe)<xt&&(jt||Math.abs(qe.lng-Fe.center.lng)<He)&&(Le=qe)}for(;Math.abs(Le.lng-Fe.center.lng)>180;){const F=Fe.locationPoint3D(Le);if(F.x>=0&&F.y>=0&&F.x<=Fe.width&&F.y<=Fe.height)break;Le.lng>Fe.center.lng?Le.lng-=360:Le.lng+=360}return Le}const nm={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},sm={anchor:"center",color:"#3FB1CE",scale:1,draggable:!1,clickTolerance:0,rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class ml extends F.E{constructor(Le,Oe){super(),(Le instanceof HTMLElement||Oe)&&(Le=F.l({element:Le},Oe)),F.aQ(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),Le=F.l({},sm,Le),this._anchor=Le.anchor,this._color=Le.color,this._scale=Le.scale,this._draggable=Le.draggable,this._clickTolerance=Le.clickTolerance,this._rotation=Le.rotation,this._rotationAlignment=Le.rotationAlignment,this._pitchAlignment=Le.pitchAlignment,this._occludedOpacity=Le.occludedOpacity,this._altitude=Le.altitude,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),Le&&Le.element?(this._element=Le.element,this._offset=F.P.convert(Le&&Le.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=F.P.convert(Le&&Le.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(F=>{F.preventDefault()})),this._element.addEventListener("mousedown",(F=>{F.preventDefault()}));const Fe=this._element.classList;for(const F in nm)Fe.remove(`mapboxgl-marker-anchor-${F}`);Fe.add(`mapboxgl-marker-anchor-${this._anchor}`);const je=Le&&Le.className?Le.className.trim().split(/\s+/):[];Fe.add(...je),this._popup=null}_createDefaultMarker(){const F=l("div"),Le=c("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},F);if(0===this._altitude){const F=c("radialGradient",{id:"shadowGradient"},c("defs",{},Le));c("stop",{offset:"10%","stop-opacity":.4},F),c("stop",{offset:"100%","stop-opacity":.05},F),c("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},Le)}return c("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},Le),c("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},Le),c("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},Le),F}addTo(F){return F===this._map||(this.remove(),this._map=F,F.getCanvasContainer().appendChild(this._element),F.on("move",this._updateMoving),F.on("moveend",this._update),F.on("remove",this._clearFadeTimer),F._addMarker(this),this.setDraggable(this._draggable),this._update(),F.on("click",this._onMapClick)),this}remove(){const F=this._map;return F&&(F.off("click",this._onMapClick),F.off("move",this._updateMoving),F.off("moveend",this._update),F.off("mousedown",this._addDragHandler),F.off("touchstart",this._addDragHandler),F.off("mouseup",this._onUp),F.off("touchend",this._onUp),F.off("mousemove",this._onMove),F.off("touchmove",this._onMove),F.off("remove",this._clearFadeTimer),F._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(Le){return this._lngLat=F.bO.convert(Le),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(F){return F===this._altitude||(this._defaultMarker&&(0===this._altitude&&0!==F||0!==this._altitude&&0===F)&&(this._element=this._createDefaultMarker()),this._altitude=F||sm.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(F){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),F){if(!("offset"in F.options)){const Le=38.1,Oe=13.5,Fe=Math.sqrt(Math.pow(Oe,2)/2);F.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-Le],"bottom-left":[Fe,-1*(Le-Oe+Fe)],"bottom-right":[-Fe,-1*(Le-Oe+Fe)],left:[Oe,-1*(Le-Oe)],right:[-Oe,-1*(Le-Oe)]}:this._offset}this._popup=F,F._marker=this,F._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(F){const Le=F.code,Oe=F.charCode||F.keyCode;"Space"!==Le&&"Enter"!==Le&&32!==Oe&&13!==Oe||this.togglePopup()}_onMapClick(F){const Le=F.originalEvent.target,Oe=this._element;this._popup&&(Le===Oe||Oe.contains(Le))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const F=this._popup;return F?(F.isOpen()?(F.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(F.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const F=this._map,Le=this._pos;if(!F||!Le)return!1;const Oe=F.unproject(Le,this._altitude),Fe=F.getFreeCameraOptions();if(!Fe.position)return!1;const je=Fe.position.toLngLat();return je.distanceTo(Oe)<.9*je.distanceTo(this._lngLat)}_evaluateOpacity(){const Le=this._map;if(!Le)return;const Oe=this._pos;if(!Oe||Oe.x<0||Oe.x>Le.transform.width||Oe.y<0||Oe.y>Le.transform.height)return void this._clearFadeTimer();const Fe=Le.unproject(Oe,this._altitude);let je;Le._showingGlobe()&&F.dK(Le.transform,this._lngLat)?je=0:(je=1-Le._queryFogOpacity(Fe),Le.transform._terrainEnabled()&&Le.getTerrain()&&this._behindTerrain()&&(je*=this._occludedOpacity)),this._element.style.opacity=`${je}`,this._element.style.pointerEvents=je>0?"auto":"none",this._popup&&this._popup._setOpacity(je),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const F=this._pos;if(!F||!this._map)return;const Le=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${F.x}px,${F.y}px)\n            ${nm[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${Le.x}px,${Le.y}px)\n        `}_calculateXYTransform(){const Le=this._pos,Oe=this._map,Fe=this.getPitchAlignment();if(!Oe||!Le||"map"!==Fe)return"";if(!Oe._showingGlobe()){const F=Oe.getPitch();return F?`rotateX(${F}deg)`:""}const je=F.c4(F.dL(Oe.transform,this._lngLat)),qe=Le.sub(F.dM(Oe.transform)),He=Math.abs(qe.x)+Math.abs(qe.y);if(0===He)return"";const xt=je/He;return`rotateX(${-qe.y*xt}deg) rotateY(${qe.x*xt}deg)`}_calculateZTransform(){const Le=this._pos,Oe=this._map;if(!Oe||!Le)return"";let Fe=0;const je=this.getRotationAlignment();if("map"===je)if(Oe._showingGlobe()){const Le=Oe.project(new F.bO(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),je=Oe.project(new F.bO(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(Le);Fe=F.c4(Math.atan2(je.y,je.x))-90}else Fe=-Oe.getBearing();else if("horizon"===je){const je=F.ae(4,6,Oe.getZoom()),qe=F.dM(Oe.transform);qe.y+=je*Oe.transform.height;const He=Le.sub(qe),xt=F.c4(Math.atan2(He.y,He.x));Fe=(xt>90?xt-270:xt+90)*(1-je)}return Fe+=this._rotation,Fe?`rotateZ(${Fe}deg)`:""}_update(F){cancelAnimationFrame(this._updateFrameId);const Le=this._map;Le&&(Le.transform.renderWorldCopies&&(this._lngLat=_l(this._lngLat,this._pos,Le.transform)),this._pos=Le.project(this._lngLat,this._altitude),!0===F?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),Le._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(Le._showingGlobe()||Le.getTerrain()||Le.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(Le){return this._offset=F.P.convert(Le),this._update(),this}addClassName(F){return this._element.classList.add(F),this}removeClassName(F){return this._element.classList.remove(F),this}toggleClassName(F){return this._element.classList.toggle(F)}_onMove(Le){const Oe=this._map;if(!Oe)return;const Fe=this._pointerdownPos,je=this._positionDelta;if(Fe&&je){if(!this._isDragging){const F=this._clickTolerance||Oe._clickTolerance;if(Le.point.dist(Fe)<F)return;this._isDragging=!0}this._pos=Le.point.sub(je),this._lngLat=Oe.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new F.A("dragstart"))),this.fire(new F.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const Le=this._map;Le&&(Le.off("mousemove",this._onMove),Le.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new F.A("dragend")),this._state="inactive"}_addDragHandler(F){const Le=this._map,Oe=this._pos;Le&&Oe&&this._element.contains(F.originalEvent.target)&&(F.preventDefault(),this._positionDelta=F.point.sub(Oe),this._pointerdownPos=F.point,this._state="pending",Le.on("mousemove",this._onMove),Le.on("touchmove",this._onMove),Le.once("mouseup",this._onUp),Le.once("touchend",this._onUp))}setDraggable(F){this._draggable=!!F;const Le=this._map;return Le&&(F?(Le.on("mousedown",this._addDragHandler),Le.on("touchstart",this._addDragHandler)):(Le.off("mousedown",this._addDragHandler),Le.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(F){return this._rotation=F||sm.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(F){return this._rotationAlignment=F||sm.rotationAlignment,this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(F){return this._pitchAlignment=F||sm.pitchAlignment,this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(F){return this._occludedOpacity=F||sm.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const am={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},um={maxWidth:100,unit:"metric"},fm={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},mm={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},_m=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function wl(Le=new F.P(0,0),Oe="bottom"){if("number"==typeof Le){const Fe=Math.round(Math.sqrt(.5*Math.pow(Le,2)));switch(Oe){case"top":return new F.P(0,Le);case"top-left":return new F.P(Fe,Fe);case"top-right":return new F.P(-Fe,Fe);case"bottom":return new F.P(0,-Le);case"bottom-left":return new F.P(Fe,-Fe);case"bottom-right":return new F.P(-Fe,-Fe);case"left":return new F.P(Le,0);case"right":return new F.P(-Le,0)}return new F.P(0,0)}return Le instanceof F.P||Array.isArray(Le)?F.P.convert(Le):F.P.convert(Le[Oe]||[0,0])}const bm={version:Le,supported:He.supported,setRTLTextPlugin:F.dN,getRTLTextPluginStatus:F.dO,Map:class extends tl{constructor(Le){Fe.mark(Oe.create);const je=Le;if(null!=(Le=F.l({},im,Le)).minZoom&&null!=Le.maxZoom&&Le.minZoom>Le.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=Le.minPitch&&null!=Le.maxPitch&&Le.minPitch>Le.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=Le.minPitch&&Le.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=Le.maxPitch&&Le.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(Le.antialias&&F.dI(window)&&(Le.antialias=!1,F.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Ji(Le.minZoom,Le.maxZoom,Le.minPitch,Le.maxPitch,Le.renderWorldCopies,null,null),Le),this._repaint=!!Le.repaint,this._interactive=Le.interactive,this._minTileCacheSize=Le.minTileCacheSize,this._maxTileCacheSize=Le.maxTileCacheSize,this._failIfMajorPerformanceCaveat=Le.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=Le.preserveDrawingBuffer,this._antialias=Le.antialias,this._trackResize=Le.trackResize,this._bearingSnap=Le.bearingSnap,this._refreshExpiredTiles=Le.refreshExpiredTiles,this._fadeDuration=Le.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=Le.crossSourceCollisions,this._collectResourceTiming=Le.collectResourceTiming,this._language=this._parseLanguage(Le.language),this._worldview=Le.worldview,this._renderTaskQueue=new sl,this._domRenderTaskQueue=new sl,this._controls=[],this._markers=[],this._popups=[],this._mapId=F.aW(),this._locale=F.l({},$f,Le.locale),this._clickTolerance=Le.clickTolerance,this._cooperativeGestures=Le.cooperativeGestures,this._performanceMetricsCollection=Le.performanceMetricsCollection,this._tessellationStep=Le.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=Le.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new rl(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=Le.scaleFactor,this._requestManager=new T(Le.transformRequest,Le.accessToken,Le.testMode),this._silenceAuthErrors=!!Le.testMode,this._contextCreateOptions=Le.contextCreateOptions?Object.assign({},Le.contextCreateOptions):{},"string"==typeof Le.container){const F=document.getElementById(Le.container);if(!F)throw new Error(`Container '${Le.container.toString()}' not found.`);this._container=F}else{if(!(Le.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=Le.container}if(this._container.childNodes.length>0&&F.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),Le.maxBounds&&this.setMaxBounds(Le.maxBounds),this._spriteFormat=Le.spriteFormat,F.aQ(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Nn),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Qa(this,Le),this._localFontFamily=Le.localFontFamily,this._localIdeographFontFamily=Le.localIdeographFontFamily,(Le.style||!Le.testMode)&&this.setStyle(Le.style||F.e.DEFAULT_STYLE,{config:Le.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),Le.projection&&this.setProjection(Le.projection),this.indoor=new _o(this),Le.hash&&(this._hash=new ia("string"==typeof Le.hash&&Le.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==je.center&&null==je.zoom||(this.transform._unmodified=!1),this.jumpTo({center:Le.center,zoom:Le.zoom,bearing:Le.bearing,pitch:Le.pitch});const Oe=Le.bounds;Oe&&(this.resize(),this.fitBounds(Oe,F.l({},Le.fitBoundsOptions,{duration:0})))}this.resize(),Le.attributionControl&&this.addControl(new il({customAttribution:Le.customAttribution})),this._logoControl=new ol,this.addControl(this._logoControl,Le.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()})),this.on("data",(Le=>{this._update("style"===Le.dataType),this.fire(new F.A(`${Le.dataType}data`,Le))})),this.on("dataloading",(Le=>{this.fire(new F.A(`${Le.dataType}dataloading`,Le))})),this._interactions=new ll(this)}_getMapId(){return this._mapId}addControl(Le,Oe){if(void 0===Oe&&(Oe=Le.getDefaultPosition?Le.getDefaultPosition():"top-right"),!Le||!Le.onAdd)return this.fire(new F.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const Fe=Le.onAdd(this);this._controls.push(Le);const je=this._controlPositions[Oe];return-1!==Oe.indexOf("bottom")?je.insertBefore(Fe,je.firstChild):je.appendChild(Fe),this}removeControl(Le){if(!Le||!Le.onRemove)return this.fire(new F.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const Oe=this._controls.indexOf(Le);return Oe>-1&&this._controls.splice(Oe,1),Le.onRemove(this),this}hasControl(F){return this._controls.indexOf(F)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(Le){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const Oe=!this._moving;return Oe&&this.fire(new F.A("movestart",Le)).fire(new F.A("move",Le)),this.fire(new F.A("resize",Le)),Oe&&this.fire(new F.A("moveend",Le)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(Le){return this.transform.setMaxBounds(F.aB.convert(Le)),this._update()}setMinZoom(Le){if((Le=Le??-2)>=-2&&Le<=this.transform.maxZoom)return this.transform.minZoom=Le,this._update(),this.getZoom()<Le?this.setZoom(Le):this.fire(new F.A("zoomstart")).fire(new F.A("zoom")).fire(new F.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(Le){if((Le=Le??22)>=this.transform.minZoom)return this.transform.maxZoom=Le,this._update(),this.getZoom()>Le?this.setZoom(Le):this.fire(new F.A("zoomstart")).fire(new F.A("zoom")).fire(new F.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(Le){if((Le=Le??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(Le>=0&&Le<=this.transform.maxPitch)return this.transform.minPitch=Le,this._update(),this.getPitch()<Le?this.setPitch(Le):this.fire(new F.A("pitchstart")).fire(new F.A("pitch")).fire(new F.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(Le){if((Le=Le??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(Le>=this.transform.minPitch)return this.transform.maxPitch=Le,this._update(),this.getPitch()>Le?this.setPitch(Le):this.fire(new F.A("pitchstart")).fire(new F.A("pitch")).fire(new F.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(F){return this._scaleFactor=F,this.painter.scaleFactor=F,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((F=>"symbol"===F.type)),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(F){return this.transform.renderWorldCopies=F,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(F){return"auto"===F?navigator.language:Array.isArray(F)?0===F.length?void 0:F.map((F=>"auto"===F?navigator.language:F)):F}setLanguage(F){const Le=this._parseLanguage(F);if(!this.style||Le===this._language)return this;this._language=Le,this.style.reloadSources();for(const F of this._controls)F._setLanguage&&F._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(F){return this.style&&F!==this._worldview?(this._worldview=F,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(F){return this._lazyInitEmptyStyle(),F?"string"==typeof F&&(F={name:F}):F=null,this._useExplicitProjection=!!F,this._prioritizeAndUpdateProjection(F,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const Le=this.transform,Oe=Le.projection.name;let Fe;"globe"===Oe&&Le.zoom>=F.bY?(Le.setMercatorFromTransition(),Fe=!0):"mercator"===Oe&&Le.zoom<F.bY&&(Le.setProjection({name:"globe"}),Fe=!0),Fe&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(F,Le){return this._updateProjection(F||Le||{name:"mercator"})}_updateProjection(Le){let Oe;return Oe="globe"===Le.name&&this.transform.zoom>=F.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(Le),this.style.applyProjectionUpdate(),Oe&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(Le,Oe){return this.transform.locationPoint3D(F.bO.convert(Le),Oe)}unproject(Le,Oe){return this.transform.pointLocation3D(F.P.convert(Le),Oe)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(F,Le,Oe){const o=F=>{let Oe=[];if(Array.isArray(Le)){const Fe=Le.filter((F=>this.getLayer(F)));Oe=Fe.length?this.queryRenderedFeatures(F,{layers:Fe}):[]}else Oe=this.queryRenderedFeatures(F,{target:Le});return Oe};if("mouseenter"===F||"mouseover"===F){let Fe=!1;const r=Le=>{const je=o(Le.point);je.length?Fe||(Fe=!0,Oe.call(this,new ua(F,this,Le.originalEvent,{features:je}))):Fe=!1};return{listener:Oe,targets:Le,delegates:{mousemove:r,mouseout:()=>{Fe=!1}}}}if("mouseleave"===F||"mouseout"===F){let Fe=!1;const r=Le=>{o(Le.point).length?Fe=!0:Fe&&(Fe=!1,Oe.call(this,new ua(F,this,Le.originalEvent)))},n=Le=>{Fe&&(Fe=!1,Oe.call(this,new ua(F,this,Le.originalEvent)))};return{listener:Oe,targets:Le,delegates:{mousemove:r,mouseout:n}}}{const s=F=>{const Le=o(F.point);Le.length&&(F.features=Le,Oe.call(this,F),delete F.features)};return{listener:Oe,targets:Le,delegates:{[F]:s}}}}on(F,Le,Oe){if("function"==typeof Le||void 0===Oe)return super.on(F,Le);if("string"==typeof Le&&(Le=[Le]),!this._areTargetsValid(Le))return this;const Fe=this._createDelegatedListener(F,Le,Oe);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[F]=this._delegatedListeners[F]||[],this._delegatedListeners[F].push(Fe);for(const F in Fe.delegates)this.on(F,Fe.delegates[F]);return this}once(F,Le,Oe){if("function"==typeof Le||void 0===Oe)return super.once(F,Le);if("string"==typeof Le&&(Le=[Le]),!this._areTargetsValid(Le))return this;const Fe=this._createDelegatedListener(F,Le,Oe);for(const F in Fe.delegates)this.once(F,Fe.delegates[F]);return this}off(F,Le,Oe){if("function"==typeof Le||void 0===Oe)return super.off(F,Le);if("string"==typeof Le&&(Le=[Le]),!this._areTargetsValid(Le))return this;const Fe=this._delegatedListeners?this._delegatedListeners[F]:void 0;return Fe&&(F=>{for(let Fe=0;Fe<F.length;Fe++){const je=F[Fe];if(je.listener===Oe&&cl(je.targets,Le)){for(const F in je.delegates)this.off(F,je.delegates[F]);return F.splice(Fe,1),this}}})(Fe),this}queryRenderedFeatures(Le,Oe){if(!this.style)return[];if(void 0===Le||Le instanceof F.P||Array.isArray(Le)||void 0!==Oe||(Oe=Le,Le=void 0),Le=Le||[[0,0],[this.transform.width,this.transform.height]],!Oe){const F=this.style.queryRenderedFeatures(Le,void 0,this.transform),Oe=this.style.queryRenderedFeatureset(Le,void 0,this.transform);return F.concat(Oe)}let Fe=!0;if(Oe.target&&(Fe=this._isTargetValid(Oe.target),Fe&&!Oe.layers))return this.style.queryRenderedFeatureset(Le,Oe,this.transform);let je=!0;if(Oe.layers&&Array.isArray(Oe.layers)){for(const F of Oe.layers)if(!this._isValidId(F)){je=!1;break}if(je&&!Oe.target)return this.style.queryRenderedFeatures(Le,Oe,this.transform)}let qe=[];return je&&(qe=qe.concat(this.style.queryRenderedFeatures(Le,Oe,this.transform))),Fe&&(qe=qe.concat(this.style.queryRenderedFeatureset(Le,Oe,this.transform))),qe}querySourceFeatures(F,Le){return!F||"string"==typeof F&&!this._isValidId(F)?[]:this.style.querySourceFeatures(F,Le)}isPointOnSurface(Le){const{name:Oe}=this.transform.projection;return"globe"!==Oe&&"mercator"!==Oe&&F.w(`${Oe} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(F.P.convert(Le))}addInteraction(F,Le){return this._interactions.add(F,Le),this}removeInteraction(F){return this._interactions.remove(F),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(F){return this._cooperativeGestures=F,this}setStyle(Le,Oe){return Oe=F.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},Oe),this.style&&Le&&!1!==Oe.diff&&Oe.localFontFamily===this._localFontFamily&&Oe.localIdeographFontFamily===this._localIdeographFontFamily&&!Oe.config?(this.style._diffStyle(Le,((Fe,je)=>{Fe?(F.w(`Unable to perform style diff: ${String(Fe.message||Fe.error||Fe)}. Rebuilding the style from scratch.`),this._updateStyle(Le,Oe)):je&&this._update(!0)}),(()=>{this._postStyleLoadEvent()})),this):(this._localIdeographFontFamily=Oe.localIdeographFontFamily,this._localFontFamily=Oe.localFontFamily,this._updateStyle(Le,Oe))}_getUIString(F){const Le=this._locale[F];if(null==Le)throw new Error(`Missing UI string '${F}'`);return Le}_updateStyle(Le,Oe){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),Le){const Fe=F.l({},Oe);Oe&&Oe.config&&(Fe.initialConfig=Oe.config,delete Fe.config),this.style=new To(this,Fe).load(Le),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new To(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(F.w("There is no style added to the map."),!1)}_isValidId(Le){return null==Le?(this.fire(new F.z(new Error("IDs can't be empty."))),!1):!F.cs(Le)||(this.fire(new F.z(new Error(`IDs can't contain special symbols: "${Le}".`))),!1)}_isTargetValid(F){return"featuresetId"in F?this._isValidId("importId"in F?F.importId:F.featuresetId):"layerId"in F&&this._isValidId(F.layerId)}_areTargetsValid(F){if(Array.isArray(F)){for(const Le of F)if(!this._isValidId(Le))return!1;return!0}return this._isTargetValid(F)}addSource(F,Le){return this._isValidId(F)?(this._lazyInitEmptyStyle(),this.style.addSource(F,Le),this._update(!0)):this}isSourceLoaded(F){return!!this._isValidId(F)&&!!this.style&&this.style._isSourceCacheLoaded(F)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(F,Le,Oe){this._lazyInitEmptyStyle(),this.style.addSourceType(F,Le,Oe)}removeSource(F){return this._isValidId(F)?(this.style.removeSource(F),this._updateTerrain(),this._update(!0)):this}getSource(F){return this._isValidId(F)?this.style.getOwnSource(F):null}addImage(Le,Oe,{pixelRatio:Fe=1,sdf:je=!1,stretchX:qe,stretchY:He,content:xt}={}){this._lazyInitEmptyStyle();const jt=F.I.from(Le);if(Oe instanceof HTMLImageElement||ImageBitmap&&Oe instanceof ImageBitmap){const{width:Le,height:Gt,data:bi}=F.q.getImageData(Oe);this.style.addImage(jt,{data:new F.r({width:Le,height:Gt},bi),pixelRatio:Fe,stretchX:qe,stretchY:He,content:xt,sdf:je,version:0,usvg:!1})}else if(void 0===Oe.width||void 0===Oe.height)this.fire(new F.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:Gt,height:bi}=Oe,wi=Oe;this.style.addImage(jt,{data:new F.r({width:Gt,height:bi},new Uint8Array(wi.data)),pixelRatio:Fe,stretchX:qe,stretchY:He,content:xt,sdf:je,usvg:!1,version:0,userImage:wi}),wi.onAdd&&wi.onAdd(this,Le)}}updateImage(Le,Oe){this._lazyInitEmptyStyle();const Fe=F.I.from(Le),je=this.style.getImage(Fe);if(!je)return void this.fire(new F.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const qe=Oe instanceof HTMLImageElement||ImageBitmap&&Oe instanceof ImageBitmap?F.q.getImageData(Oe):Oe,{width:He,height:xt,data:jt}=qe;if(void 0===He||void 0===xt)return void this.fire(new F.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(He!==(je.usvg?je.icon.usvg_tree.width:je.data.width)||xt!==(je.usvg?je.icon.usvg_tree.height:je.data.height))return void this.fire(new F.z(new Error(`The width and height of the updated image (${He}, ${xt})\n                must be that same as the previous version of the image\n                (${je.data.width}, ${je.data.height})`)));const Gt=!(Oe instanceof HTMLImageElement||ImageBitmap&&Oe instanceof ImageBitmap);let bi=!1;je.usvg?(je.data=new F.r({width:He,height:xt},new Uint8Array(jt)),je.usvg=!1,je.icon=void 0,bi=!0):je.data.replace(jt,Gt),this.style.updateImage(Fe,je,bi)}hasImage(Le){return Le?!!this.style&&!!this.style.getImage(F.I.from(Le)):(this.fire(new F.z(new Error("Missing required image id"))),!1)}removeImage(Le){this.style.removeImage(F.I.from(Le))}loadImage(Le,Oe){F.o(this._requestManager.transformRequest(Le,F.R.Image),((Le,Fe)=>{Oe(Le,Fe instanceof HTMLImageElement?F.q.getImageData(Fe):Fe)}))}listImages(){return this.style.listImages().map((F=>F.name))}addModel(F,Le){this._lazyInitEmptyStyle(),this.style.addModel(F,Le)}hasModel(Le){return Le?this.style.hasModel(Le):(this.fire(new F.z(new Error("Missing required model id"))),!1)}removeModel(F){this.style.removeModel(F)}listModels(){return this.style.listModels()}addLayer(F,Le){return this._isValidId(F.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(F,Le),this._update(!0)):this}getSlot(F){const Le=this.getLayer(F);return Le&&Le.slot||null}setSlot(F,Le){return this.style.setSlot(F,Le),this.style.mergeLayers(),this._update(!0)}addImport(F,Le){return this.style.addImport(F,Le),this}updateImport(F,Le){return"string"!=typeof Le&&Le.id!==F?(this.removeImport(F),this.addImport(Le)):(this.style.updateImport(F,Le),this._update(!0))}removeImport(F){return this.style.removeImport(F),this}moveImport(F,Le){return this.style.moveImport(F,Le),this._update(!0)}moveLayer(F,Le){return this._isValidId(F)?(this.style.moveLayer(F,Le),this._update(!0)):this}removeLayer(F){return this._isValidId(F)?(this.style.removeLayer(F),this._update(!0)):this}getLayer(F){if(!this._isValidId(F))return null;const Le=this.style.getOwnLayer(F);return Le?"custom"===Le.type?Le.implementation:Le.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(F,Le,Oe){return this._isValidId(F)?(this.style.setLayerZoomRange(F,Le,Oe),this._update(!0)):this}setFilter(F,Le,Oe={}){return this._isValidId(F)?(this.style.setFilter(F,Le,Oe),this._update(!0)):this}getFilter(F){return this._isValidId(F)?this.style.getFilter(F):null}setPaintProperty(F,Le,Oe,Fe={}){return this._isValidId(F)?(this.style.setPaintProperty(F,Le,Oe,Fe),this._update(!0)):this}getPaintProperty(F,Le){return this._isValidId(F)?this.style.getPaintProperty(F,Le):null}setLayoutProperty(F,Le,Oe,Fe={}){return this._isValidId(F)?(this.style.setLayoutProperty(F,Le,Oe,Fe),this._update(!0)):this}getLayoutProperty(F,Le){return this._isValidId(F)?this.style.getLayoutProperty(F,Le):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(F){return this.style.setGlyphsUrl(F),this._update(!0)}getSchema(F){return this.style.getSchema(F)}setSchema(F,Le){return this.style.setSchema(F,Le),this._update(!0)}getConfig(F){return this.style.getConfig(F)}setConfig(F,Le){return this.style.setConfig(F,Le),this._update(!0)}getConfigProperty(F,Le){return this.style.getConfigProperty(F,Le)}setConfigProperty(F,Le,Oe){return this.style.setConfigProperty(F,Le,Oe),this._update(!0)}getFeaturesetDescriptors(F){return this.style.getFeaturesetDescriptors(F)}setLights(F){if(this._lazyInitEmptyStyle(),F&&1===F.length&&"flat"===F[0].type){const Le=F[0];Le.properties?this.style.setFlatLight(Le.properties,Le.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(F),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const F=this.style.getLights()||[];return 0===F.length&&F.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),F}setLight(F,Le={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:F}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(F){return this._lazyInitEmptyStyle(),!F&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(F),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(F){return this._lazyInitEmptyStyle(),this.style.setFog(F),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(F){return this._lazyInitEmptyStyle(),this.style.setSnow(F),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(F){return this._lazyInitEmptyStyle(),this.style.setRain(F),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(F){return this._lazyInitEmptyStyle(),this.style.setColorTheme(F),this._update(!0)}setImportColorTheme(F,Le){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(F,Le),this._update(!0)}setCamera(F){return this.style.setCamera(F),this._triggerCameraUpdate(F)}_triggerCameraUpdate(F){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===F["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(Le){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(F.bO.convert(Le),this.transform):0}setFeatureState(F,Le){return F.source&&!this._isValidId(F.source)?this:(this.style.setFeatureState(F,Le),this._update())}removeFeatureState(F,Le){return F.source&&!this._isValidId(F.source)?this:(this.style.removeFeatureState(F,Le),this._update())}getFeatureState(F){return F.source&&!this._isValidId(F.source)?null:this.style.getFeatureState(F)}_updateContainerDimensions(){if(!this._container)return;const F=this._container.getBoundingClientRect().width||400,Le=this._container.getBoundingClientRect().height||300;let Oe,Fe,je,qe=this._container;for(;qe&&(!Fe||!je);){const F=window.getComputedStyle(qe).transform;F&&"none"!==F&&(Oe=F.match(/matrix.*\((.+)\)/)[1].split(", "),Oe[0]&&"0"!==Oe[0]&&"1"!==Oe[0]&&(Fe=Oe[0]),Oe[3]&&"0"!==Oe[3]&&"1"!==Oe[3]&&(je=Oe[3])),qe=qe.parentElement}this._containerWidth=Fe?Math.abs(F/Fe):F,this._containerHeight=je?Math.abs(Le/je):Le}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&F.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const F=this._container;F.classList.add("mapboxgl-map"),(this._missingCSSCanary=l("div","mapboxgl-canary",F)).style.visibility="hidden",this._detectMissingCSS();const Le=this._canvasContainer=l("div","mapboxgl-canvas-container",F);this._canvas=l("canvas","mapboxgl-canvas",Le),this._interactive&&(Le.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const Oe=this._controlContainer=l("div","mapboxgl-control-container",F),Fe=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((F=>{Fe[F]=l("div",`mapboxgl-ctrl-${F}`,Oe)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(Le,Oe){const Fe=F.q.devicePixelRatio||1;this._canvas.width=Fe*Math.ceil(Le),this._canvas.height=Fe*Math.ceil(Oe),this._canvas.style.width=`${Le}px`,this._canvas.style.height=`${Oe}px`}_addMarker(F){this._markers.push(F)}_removeMarker(F){const Le=this._markers.indexOf(F);-1!==Le&&this._markers.splice(Le,1)}_addPopup(F){this._popups.push(F)}_removePopup(F){const Le=this._popups.indexOf(F);-1!==Le&&this._popups.splice(Le,1)}_setupPainter(){const Le=F.l({},He.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),Oe=this._canvas.getContext("webgl2",Le);Oe?(V(Oe,!0),this.painter=new ea(Oe,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",(F=>{"source"===F.dataType&&this.painter.setTileLoadedFlag(!0)})),F.m.testSupport(Oe)):this.fire(new F.z(new Error("Failed to initialize WebGL")))}_contextLost(Le){Le.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new F.A("webglcontextlost",{originalEvent:Le}))}_contextRestored(Le){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new F.A("webglcontextrestored",{originalEvent:Le}))}_onMapScroll(F){if(F.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(F){return this.style?(this._styleDirty=this._styleDirty||F,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(F){return this._update(),this._renderTaskQueue.add(F)}_cancelRenderFrame(F){this._renderTaskQueue.remove(F)}_requestDomTask(F){!this.loaded()||this.loaded()&&!this.isMoving()?F():this._domRenderTaskQueue.add(F)}_render(Le){let je;this.fire(new F.A("renderstart")),++this._frameId;const qe=this.painter.context.extTimerQuery,He=F.q.now(),xt=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(je=xt.createQuery(),xt.beginQuery(qe.TIME_ELAPSED_EXT,je)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(Le),this._domRenderTaskQueue.run(Le),this._removed)return;this._updateProjectionTransition();const jt=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const Le=this.transform.zoom,Oe=this.transform.pitch,Fe=F.q.now(),je=new F.aa(Le,{now:Fe,fadeDuration:jt,pitch:Oe,transition:this.style.transition});this.style.update(je)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let Gt=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),Gt=this._updateAverageElevation(He),this.style.updateSources(this.transform),this.isMoving()||this._forceMarkerAndPopupUpdate()):Gt=this._updateAverageElevation(He);const bi=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,jt,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),bi&&(this._placementDirty=bi.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:jt,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new F.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Fe.mark(Oe.load),this.fire(new F.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),je){const Le=F.q.now()-He;xt.endQuery(qe.TIME_ELAPSED_EXT),setTimeout((()=>{const Oe=xt.getQueryParameter(je,xt.QUERY_RESULT)/1e6;xt.deleteQuery(je),this.fire(new F.A("gpu-timing-frame",{cpuTime:Le,gpuTime:Oe}))}),50)}if(this.listens("gpu-timing-layer")){const Le=this.painter.collectGpuTimers();setTimeout((()=>{const Oe=this.painter.queryGpuTimers(Le);this.fire(new F.A("gpu-timing-layer",{layerTimes:Oe}))}),50)}if(this.listens("gpu-timing-deferred-render")){const Le=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const Oe=this.painter.queryGpuTimeDeferredRender(Le);this.fire(new F.A("gpu-timing-deferred-render",{gpuTime:Oe}))}),50)}const wi=this._sourcesDirty||this._styleDirty||this._placementDirty||Gt;if(wi||this._repaint)this.triggerRepaint();else{const Le=this.idle();if(Le&&(Gt=this._updateAverageElevation(He,!0)),Gt)this.triggerRepaint();else if(this._triggerFrame(!1),Le&&(this.fire(new F.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const Le=this._calculateSpeedIndex();this.fire(new F.A("speedindexcompleted",{speedIndex:Le})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||wi||(this._fullyLoaded=!0,Fe.mark(Oe.fullLoad),this._performanceMetricsCollection&&na(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(F){for(const Le of this._markers)F&&!this.getRenderWorldCopies()&&(Le._lngLat=Le._lngLat.wrap()),Le._update();for(const Le of this._popups)!F||this.getRenderWorldCopies()||Le._trackPointer||(Le._lngLat=Le._lngLat.wrap()),Le._update()}_updateAverageElevation(F,Le=!1){const i=F=>(this.transform.averageElevation=F,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);const Oe=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(Oe||(Le||F-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(F)){const Le=this.transform.averageElevation;let Fe=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(Fe)?Fe=0:this._averageElevationLastSampledAt=F;const je=Math.abs(Le-Fe);if(je>1){if(this._isInitialLoad||Oe)return this._averageElevation.jumpTo(Fe),i(Fe);this._averageElevation.easeTo(Fe,F,300)}else if(je>1e-4)return this._averageElevation.jumpTo(Fe),i(Fe)}return!!this._averageElevation.isEasing(F)&&i(this._averageElevation.getValue(F))}_authenticate(){nl(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(Le=>{if(Le&&(Le.message===wi||401===Le.status)){const Le=this.painter.context.gl;V(Le,!1),this._logoControl instanceof ol&&this._logoControl._updateLogo(),Le&&Le.clear(Le.DEPTH_BUFFER_BIT|Le.COLOR_BUFFER_BIT|Le.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new F.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),Do(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&zs(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const F=this._isDragging();this.painter.updateTerrain(this.style,F)}_calculateSpeedIndex(){const F=this.painter.canvasCopy(),Le=this.painter.getCanvasCopiesAndTimestamps();Le.timeStamps.push(performance.now());const Oe=this.painter.context.gl,Fe=Oe.createFramebuffer();function s(F){Oe.framebufferTexture2D(Oe.FRAMEBUFFER,Oe.COLOR_ATTACHMENT0,Oe.TEXTURE_2D,F,0);const Le=new Uint8Array(Oe.drawingBufferWidth*Oe.drawingBufferHeight*4);return Oe.readPixels(0,0,Oe.drawingBufferWidth,Oe.drawingBufferHeight,Oe.RGBA,Oe.UNSIGNED_BYTE,Le),Le}return Oe.bindFramebuffer(Oe.FRAMEBUFFER,Fe),this._canvasPixelComparison(s(F),Le.canvasCopies.map(s),Le.timeStamps)}_canvasPixelComparison(F,Le,Oe){let Fe=Oe[1]-Oe[0];const je=F.length/4;for(let qe=0;qe<Le.length;qe++){const He=Le[qe];let xt=0;for(let Le=0;Le<He.length;Le+=4)He[Le]===F[Le]&&He[Le+1]===F[Le+1]&&He[Le+2]===F[Le+2]&&He[Le+3]===F[Le+3]&&(xt+=1);Fe+=(Oe[qe+2]-Oe[qe+1])*(1-xt/je)}return Fe}remove(){this._hash&&this._hash.remove();for(const F of this._controls)F.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const Le=this.painter.context.gl.getExtension("WEBGL_lose_context");Le&&Le.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),hl.delete(this.painter.context.gl),el.remove(),bo.remove(),this._removed=!0,this.fire(new F.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(Le){this._renderNextFrame=this._renderNextFrame||Le,this.style&&!this._frame&&(this._frame=F.q.frame((F=>{const Le=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,Le&&this._render(F)})))}_preloadTiles(Le){const Oe=this.style?this.style.getSourceCaches():[];return F.bl(Oe,((F,Oe)=>F._preloadTiles(Le,Oe)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(F){this._trackResize&&this.resize({originalEvent:F})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(F){this._showTileBoundaries!==F&&(this._showTileBoundaries=F,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(F){this._showParseStatus!==F&&(this._showParseStatus=F,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(F){this._showTerrainWireframe!==F&&(this._showTerrainWireframe=F,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(F){this._showLayers2DWireframe!==F&&(this._showLayers2DWireframe=F,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(F){this._showLayers3DWireframe!==F&&(this._showLayers3DWireframe=F,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(F){this._speedIndexTiming!==F&&(this._speedIndexTiming=F,this._update())}get showPadding(){return!!this._showPadding}set showPadding(F){this._showPadding!==F&&(this._showPadding=F,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(F){this._showCollisionBoxes!==F&&(this._showCollisionBoxes=F,this._tp.refreshUI(),F?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(F){this._showOverdrawInspector!==F&&(this._showOverdrawInspector=F,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(F){this._repaint!==F&&(this._repaint=F,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(F){this._vertices=F,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(F){this._showTileAABBs!==F&&(this._showTileAABBs=F,this._tp.refreshUI(),F&&this._update())}_setCacheLimits(Le,Oe){F.dJ(Le,Oe)}get version(){return Le}},NavigationControl:class{constructor(Le={}){this.options=F.l({},rm,Le),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(F=>F.preventDefault())),this.options.showZoom&&(F.aQ(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(F=>{this._map&&this._map.zoomIn({},{originalEvent:F})})),l("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(F=>{this._map&&this._map.zoomOut({},{originalEvent:F})})),l("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(F.aQ(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(F=>{const Le=this._map;Le&&(this.options.visualizePitch?Le.resetNorthPitch({},{originalEvent:F}):Le.resetNorth({},{originalEvent:F}))})),this._compassIcon=l("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const F=this._map;if(!F)return;const Le=F.getZoom(),Oe=Le===F.getMaxZoom(),Fe=Le===F.getMinZoom();this._zoomInButton.disabled=Oe,this._zoomOutButton.disabled=Fe,this._zoomInButton.setAttribute("aria-disabled",Oe.toString()),this._zoomOutButton.setAttribute("aria-disabled",Fe.toString())}_rotateCompassArrow(){const F=this._map;if(!F)return;const Le=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(F.transform.pitch*(Math.PI/180)),.5)}) rotateX(${F.transform.pitch}deg) rotateZ(${F.transform.angle*(180/Math.PI)}deg)`:`rotate(${F.transform.angle*(180/Math.PI)}deg)`;F._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=Le)}))}onAdd(F){return this._map=F,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),F.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&F.on("pitch",this._rotateCompassArrow),F.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new ul(F,this._compass,this.options.visualizePitch)),this._container}onRemove(){const F=this._map;F&&(this._container.remove(),this.options.showZoom&&F.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&F.off("pitch",this._rotateCompassArrow),F.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(F,Le){const Oe=l("button",F,this._container);return Oe.type="button",Oe.addEventListener("click",Le),Oe}_setButtonTitle(F,Le){if(!this._map)return;const Oe=this._map._getUIString(`NavigationControl.${Le}`);F.setAttribute("aria-label",Oe),F.firstElementChild&&F.firstElementChild.setAttribute("title",Oe)}},GeolocateControl:class extends F.E{constructor(Le={}){super();const Oe=navigator.geolocation;this.options=F.l({geolocation:Oe},am,Le),F.aQ(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=ta(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(F){return this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(F){const t=(Le=!!this.options.geolocation)=>{this._supportsGeolocation=Le,F(Le)};void 0!==this._supportsGeolocation?F(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then((F=>t("denied"!==F.state))).catch((()=>t())):t()}_isOutOfMapMaxBounds(F){const Le=this._map.getMaxBounds(),Oe=F.coords;return!!Le&&(Oe.longitude<Le.getWest()||Oe.longitude>Le.getEast()||Oe.latitude<Le.getSouth()||Oe.latitude>Le.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(Le){if(this._map){if(this._isOutOfMapMaxBounds(Le))return this._setErrorState(),this.fire(new F.A("outofmaxbounds",Le)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=Le,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(Le),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(Le),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.A("geolocate",Le)),this._finish()}}_updateCamera(Le){const Oe=new F.bO(Le.coords.longitude,Le.coords.latitude),Fe=Le.coords.accuracy,je=this._map.getBearing(),qe=F.l({bearing:je},this.options.fitBoundsOptions);this._map.fitBounds(Oe.toBounds(Fe),qe,{geolocateSource:!0})}_updateMarker(Le){if(Le){const Oe=new F.bO(Le.coords.longitude,Le.coords.latitude);this._accuracyCircleMarker.setLngLat(Oe).addTo(this._map),this._userLocationDotMarker.setLngLat(Oe).addTo(this._map),this._accuracy=Le.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const Le=this._map.transform,Oe=F.bH(1,Le._center.lat)*Le.worldSize,Fe=Math.ceil(2*this._accuracy*Oe);this._circleElement.style.width=`${Fe}px`,this._circleElement.style.height=`${Fe}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(Le){if(this._map){if(this.options.trackUserLocation)if(1===Le.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const F=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===Le.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.A("error",Le)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(Le){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(F=>F.preventDefault())),this._geolocateButton=l("button","mapboxgl-ctrl-geolocate",this._container),l("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===Le){F.w("Geolocation support is not available so the GeolocateControl will be disabled.");const Le=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",Le),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",Le)}else{const F=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=l("div","mapboxgl-user-location"),this._dotElement.appendChild(l("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(l("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ml({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=l("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ml({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(Le=>{Le.geolocateSource||"ACTIVE_LOCK"!==this._watchState||Le.originalEvent&&"resize"===Le.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new F.A("trackuserlocationend")))}))}}_onDeviceOrientation(F){this._userLocationDotMarker&&(F.webkitCompassHeading?this._heading=F.webkitCompassHeading:!0===F.absolute&&(this._heading=-1*F.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return F.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new F.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new F.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new F.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let F;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(F={maximumAge:6e5,timeout:0},this._noTimeout=!0):(F=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,F),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((F=>{"granted"===F&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:il,ScaleControl:class{constructor(Le={}){this.options=F.l({},um,Le),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(F){return!1}}(),F.aQ(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const F=this.options.maxWidth||100,Le=this._map,Oe=Le._containerHeight/2,Fe=Le._containerWidth/2-F/2,je=Le.unproject([Fe,Oe]),qe=Le.unproject([Fe+F,Oe]),He=je.distanceTo(qe);if("imperial"===this.options.unit){const Le=3.2808*He;Le>5280?this._setScale(F,Le/5280,"mile"):this._setScale(F,Le,"foot")}else"nautical"===this.options.unit?this._setScale(F,He/1852,"nautical-mile"):He>=1e3?this._setScale(F,He/1e3,"kilometer"):this._setScale(F,He,"meter")}_setScale(F,Le,Oe){this._map._requestDomTask((()=>{const Fe=function(F){const Le=Math.pow(10,`${Math.floor(F)}`.length-1);let Oe=F/Le;return Oe=Oe>=10?10:Oe>=5?5:Oe>=3?3:Oe>=2?2:Oe>=1?1:function(F){const Le=Math.pow(10,Math.ceil(-Math.log(F)/Math.LN10));return Math.round(F*Le)/Le}(Oe),Le*Oe}(Le),je=Fe/Le;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==Oe?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:Oe}).format(Fe):`${Fe}&nbsp;${fm[Oe]}`,this._container.style.width=F*je+"px"}))}onAdd(F){return this._map=F,this._language=F.getLanguage(),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-scale",F.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(F){this._language=F,this._update()}setUnit(F){this.options.unit=F,this._update()}},FullscreenControl:class{constructor(Le={}){this._fullscreen=!1,Le&&Le.container&&(Le.container instanceof HTMLElement?this._container=Le.container:F.w("Full screen control 'container' must be a DOM element.")),F.aQ(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(Le){return this._map=Le,this._container||(this._container=this._map.getContainer()),this._controlContainer=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",F.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const F=this._fullscreenButton=l("button","mapboxgl-ctrl-fullscreen",this._controlContainer);l("span","mapboxgl-ctrl-icon",F).setAttribute("aria-hidden","true"),F.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const F=this._getTitle();this._fullscreenButton.setAttribute("aria-label",F),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",F)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends F.E{constructor(Le){super(),this.options=F.l(Object.create(mm),Le),this._altitude=this.options.altitude,F.aQ(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(Le&&Le.className?Le.className.trim().split(/\s+/):[])}addTo(Le){return this._map&&this.remove(),this._map=Le,this.options.closeOnClick&&Le.on("preclick",this._onClose),this.options.closeOnMove&&Le.on("move",this._onClose),Le.on("remove",this.remove),this._update(),Le._addPopup(this),this._focusFirstElement(),this._trackPointer?(Le.on("mousemove",this._onMouseEvent),Le.on("mouseup",this._onMouseEvent),Le._canvasContainer.classList.add("mapboxgl-track-pointer")):Le.on("move",this._update),this.fire(new F.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const Le=this._map;return Le&&(Le.off("move",this._update),Le.off("move",this._onClose),Le.off("preclick",this._onClose),Le.off("click",this._onClose),Le.off("remove",this.remove),Le.off("mousemove",this._onMouseEvent),Le.off("mouseup",this._onMouseEvent),Le.off("drag",this._onMouseEvent),Le._canvasContainer&&Le._canvasContainer.classList.remove("mapboxgl-track-pointer"),Le._removePopup(this),this._map=void 0),this.fire(new F.A("close")),this}getLngLat(){return this._lngLat}setLngLat(Le){this._lngLat=F.bO.convert(Le),this._pos=null,this._trackPointer=!1,this._update();const Oe=this._map;return Oe&&(Oe.on("move",this._update),Oe.off("mousemove",this._onMouseEvent),Oe._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(F){return this._altitude=F,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const F=this._map;return F&&(F.off("move",this._update),F.on("mousemove",this._onMouseEvent),F.on("drag",this._onMouseEvent),F._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(F){return this.setDOMContent(document.createTextNode(F))}setHTML(F){const Le=document.createDocumentFragment(),Oe=document.createElement("body");let Fe;for(Oe.innerHTML=F;Fe=Oe.firstChild,Fe;)Le.appendChild(Fe);return this.setDOMContent(Le)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(F){return this.options.maxWidth=F,this._update(),this}setDOMContent(F){let Le=this._content;if(Le)for(;Le.hasChildNodes();)Le.firstChild&&Le.removeChild(Le.firstChild);else Le=this._content=l("div","mapboxgl-popup-content",this._container||void 0);if(Le.appendChild(F),this.options.closeButton){const F=this._closeButton=l("button","mapboxgl-popup-close-button",Le);F.type="button",F.setAttribute("aria-label","Close popup"),F.innerHTML='<span aria-hidden="true">&#215;</span>',F.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(F){return this._classList.add(F),this._updateClassList(),this}removeClassName(F){return this._classList.delete(F),this._updateClassList(),this}setOffset(F){return this.options.offset=F,this._update(),this}toggleClassName(F){let Le;return this._classList.delete(F)?Le=!1:(this._classList.add(F),Le=!0),this._updateClassList(),Le}_onMouseEvent(F){this._update(F.point)}_getAnchor(F){if(this.options.anchor)return this.options.anchor;const Le=this._map,Oe=this._container,Fe=this._pos;if(!Le||!Oe||!Fe)return"bottom";const je=Oe.offsetWidth,qe=Oe.offsetHeight,He=Fe.x<je/2,xt=Fe.x>Le.transform.width-je/2;if(Fe.y+F<qe)return He?"top-left":xt?"top-right":"top";if(Fe.y>Le.transform.height-qe){if(He)return"bottom-left";if(xt)return"bottom-right"}return He?"left":xt?"right":"bottom"}_updateClassList(){const F=this._container;if(!F)return;const Le=[...this._classList];Le.push("mapboxgl-popup"),this._anchor&&Le.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&Le.push("mapboxgl-popup-track-pointer"),F.className=Le.join(" ")}_update(Le){const Oe=this._map,Fe=this._content;if(!Oe||!this._lngLat&&!this._trackPointer||!Fe)return;let je=this._container;if(je||(je=this._container=l("div","mapboxgl-popup",Oe.getContainer()),this._tip=l("div","mapboxgl-popup-tip",je),je.appendChild(Fe)),this.options.maxWidth&&je.style.maxWidth!==this.options.maxWidth&&(je.style.maxWidth=this.options.maxWidth),Oe.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=_l(this._lngLat,this._pos,Oe.transform)),!this._trackPointer||Le){const Fe=this._pos=this._trackPointer&&Le instanceof F.P?Le:Oe.project(this._lngLat,this._altitude),je=wl(this.options.offset),qe=this._anchor=this._getAnchor(je.y),He=wl(this.options.offset,qe),xt=Fe.add(He).round();Oe._requestDomTask((()=>{this._container&&qe&&(this._container.style.transform=`${nm[qe]} translate(${xt.x}px,${xt.y}px)`)}))}if(!this._marker&&Oe._showingGlobe()){const Le=F.dK(Oe.transform,this._lngLat)?0:1;this._setOpacity(Le)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const F=this._container.querySelector(_m);F&&F.focus()}_onClose(){this.remove()}_setOpacity(F){this._container&&(this._container.style.opacity=`${F}`),this._content&&(this._content.style.pointerEvents=F?"auto":"none")}},Marker:ml,Style:To,LngLat:F.bO,LngLatBounds:F.aB,Point:F.P,MercatorCoordinate:F.ac,FreeCameraOptions:Wi,Evented:F.E,config:F.e,prewarm:F.dP,clearPrewarmedResources:F.dQ,get accessToken(){return F.e.ACCESS_TOKEN},set accessToken(Le){F.e.ACCESS_TOKEN=Le},get baseApiUrl(){return F.e.API_URL},set baseApiUrl(Le){F.e.API_URL=Le},get workerCount(){return F.dR.workerCount},set workerCount(Le){F.dR.workerCount=Le},get maxParallelImageRequests(){return F.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(Le){F.e.MAX_PARALLEL_IMAGE_REQUESTS=Le},clearStorage(Le){F.dS(Le)},get workerUrl(){return F.dT.workerUrl},set workerUrl(Le){F.dT.workerUrl=Le},get workerClass(){return F.dT.workerClass},set workerClass(Le){F.dT.workerClass=Le},get workerParams(){return F.dT.workerParams},set workerParams(Le){F.dT.workerParams=Le},get dracoUrl(){return F.dU()},set dracoUrl(Le){F.dV(Le)},get meshoptUrl(){return F.dW()},set meshoptUrl(Le){F.dX(Le)},setNow:F.q.setNow,restoreNow:F.q.restoreNow};return bm}));var je=Fe;return je}));var Oe=Le;export{Oe as default};

