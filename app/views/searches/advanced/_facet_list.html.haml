- collapse_id = "#{id_prefix}-facet"
- selected_values = Array(params[param_key]).reject(&:blank?).map(&:to_s)
- top_n ||= 6
- open = selected_values.any?
- visible = items.first(top_n)
- hidden  = items.drop(top_n)

%li.list-group-item.bg-light
  / Header row (gray, square, plus icon)
  %button.w-100.border-0.d-flex.align-items-center.justify-content-between.collapsed.bg-light{ 
    "data-bs-toggle" => "collapse",
    "data-bs-target" => "##{collapse_id}",
    "aria-expanded"  => open,
    "aria-controls"  => collapse_id,
    class: (open ? '' : 'collapsed'),
    type: 'button'
  }
    %span.small
      %i.bi.bi-funnel-fill.me-1
      %strong= title
    %span
      %i.bi.bi-plus-lg.collapsed-toggle{ class: (open ? 'd-none' : '') }
      %i.bi.bi-dash-lg.expanded-toggle{ class: (open ? '' : 'd-none') }

  / Body: checkbox list
  .collapse{ id: collapse_id, class: (open ? 'show' : '') }
    .px-3.py-2
      - visible.each_with_index do |it, idx|
        - val = value_of.call(it).to_s
        - lbl = label_of.call(it)
        .form-check.mb-1
          = check_box_tag "#{param_key}[]", val, selected_values.include?(val),
            id: "#{id_prefix}-#{idx}", class: 'form-check-input'
          = label_tag "#{id_prefix}-#{idx}", lbl, class: 'form-check-label small'

      - if hidden.any?
        %div{id: "#{collapse_id}-more", class: 'd-none'}
          - hidden.each_with_index do |it, idx|
            - val = value_of.call(it).to_s
            - lbl = label_of.call(it)
            .form-check.mb-1
              = check_box_tag "#{param_key}[]", val, selected_values.include?(val),
                id: "#{id_prefix}-more-#{idx}", class: 'form-check-input'
              = label_tag "#{id_prefix}-more-#{idx}", lbl, class: 'form-check-label small'

        %button.btn.btn-link.p-0.mt-1.small{ type: 'button',
          onclick: "var n=document.getElementById('#{collapse_id}-more'); n.classList.toggle('d-none'); this.remove();" }
          Show all
