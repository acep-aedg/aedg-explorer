- collapse_id     = "#{id_prefix}-facet"
- selected_values = Array(params[param_key]).reject(&:blank?).map(&:to_s)
- top_n         ||= 6
- open            = selected_values.any?
- visible         = items.first(top_n)
- hidden          = items.drop(top_n)
- selection_count = selected_values.size

-# --- HEADER ROW ---
%button.list-group-item.list-group-item-action.d-flex.align-items-center.justify-content-between.border-0{ 
  "data-bs-toggle" => "collapse",
  "data-bs-target" => "##{collapse_id}",
  "aria-expanded"  => open,
  "aria-controls"  => collapse_id,
  class: (open ? '' : 'collapsed'),
  type: 'button',
  style: "background-color: #fff;"
}
  %span.small.d-flex.align-items-center
    -# Icon and Title are always dark now
    %i.bi.bi-funnel-fill.me-2.text-muted
    %strong.text-dark= title
    
    -# Badge: Shows count if > 0, but in neutral gray (bg-secondary)
    - if selection_count > 0
      %span.badge.bg-secondary.rounded-pill.ms-2.small= selection_count

  %span.text-muted
    %i.bi.bi-plus-lg.collapsed-toggle{ class: (open ? 'd-none' : '') }
    %i.bi.bi-dash-lg.expanded-toggle{ class: (open ? '' : 'd-none') }

-# --- BODY ---
.collapse{ id: collapse_id, class: (open ? 'show' : '') }
  .px-3.py-2.bg-light.bg-opacity-10
    
    -# Render Top Items
    - visible.each_with_index do |it, idx|
      - val = value_of.call(it).to_s
      - lbl = label_of.call(it)
      .form-check.mb-1
        = check_box_tag "#{param_key}[]", val, selected_values.include?(val),
          id: "#{id_prefix}-#{idx}", class: 'form-check-input', style: "cursor: pointer;"
        = label_tag "#{id_prefix}-#{idx}", lbl, class: 'form-check-label small text-secondary', style: "cursor: pointer;"

    -# Render Hidden Items (if any)
    - if hidden.any?
      .collapse{ id: "#{collapse_id}-more" }
        - hidden.each_with_index do |it, idx|
          - val = value_of.call(it).to_s
          - lbl = label_of.call(it)
          .form-check.mb-1
            = check_box_tag "#{param_key}[]", val, selected_values.include?(val),
              id: "#{id_prefix}-more-#{idx}", class: 'form-check-input', style: "cursor: pointer;"
            = label_tag "#{id_prefix}-more-#{idx}", lbl, class: 'form-check-label small text-secondary', style: "cursor: pointer;"

      -# The Toggle Button
      %button.btn.btn-link.btn-sm.text-decoration-none.text-secondary.p-0.mt-2.d-flex.align-items-center.gap-1{ type: 'button',
        "data-bs-toggle" => "collapse", 
        "data-bs-target" => "##{collapse_id}-more",
        "aria-expanded"  => "false" }
        
        %span.small.text-primary View all options
        %i.bi.bi-chevron-down.small