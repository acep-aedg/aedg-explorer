- content_for :title, 'Advanced Search'

.container-fluid
  .row.min-vh-100
    / ==== LEFT: FILTERS PANEL ====
    .col-12.col-lg-3.p-3.bg-dark-subtle
      .card.shadow-sm.bg-body-dark.border.border-300.rounded-3.p-1
        .card-header.bg-body-secondary.text-body-emphasis.py-2.px-3.border-bottom.rounded-0.border.border-300.rounded-3
          %strong.small Filters
        .card-body.p-0.bg-body-secondary.border.border-300.rounded-3
          = form_with url: search_advanced_path, method: :get, local: true do
            - reset_disabled = params.except(:controller, :action).blank?

            / Apply filters and Reset (leave these on the left)
            .d-grid.gap-1.p-2.bg-body-secondary.border.border-300.rounded-3
              %button.btn.btn-warning.text-primary.border-primary.btn-sm.w-100.rounded-1.py-1{ type: 'submit' } Apply filters
              = link_to 'Clear all filters', search_advanced_path,
                class: "btn btn-secondary btn-sm w-100 rounded-1 py-1 #{'disabled' if reset_disabled}",
                aria: { disabled: reset_disabled }

            / Facets
            %ul.list-group.list-group-flush.small.rounded-3
              = render 'searches/advanced/facet_list', title: 'Grids', items: @all_grids, param_key: :grid_ids,
                id_prefix: 'grid', top_n: 6, value_of: ->(g){ g.id }, label_of: ->(g){ g.name }
              = render 'searches/advanced/facet_list', title: 'Boroughs', items: @all_boros, param_key: :borough_fips_codes,
                id_prefix: 'bor', top_n: 6, value_of: ->(b){ b.fips_code }, label_of: ->(b){ b.name }
              = render 'searches/advanced/facet_list', title: 'Native Corporations', items: @all_corps, param_key: :regional_corporation_fips_codes,
                id_prefix: 'corp', top_n: 6, value_of: ->(c){ c.fips_code }, label_of: ->(c){ c.name }
              = render 'searches/advanced/facet_list', title: 'Senate Districts', items: @all_senate, param_key: :senate_district_ids,
                id_prefix: 'sen', top_n: 6, value_of: ->(d){ d.id }, label_of: ->(d){ d.district }
              = render 'searches/advanced/facet_list', title: 'House Districts', items: @all_house, param_key: :house_district_ids,
                id_prefix: 'hou', top_n: 6, value_of: ->(d){ d.id }, label_of: ->(d){ d.district_label }

            .d-grid.gap-1.p-2.border-top.bg-body-secondary.border.border-300.rounded-3
              %button.btn.btn-warning.text-primary.border-primary.btn-sm.w-100.rounded-1.py-1{ type: 'submit' } Apply filters
              = link_to 'Clear all filters', search_advanced_path,
                class: "btn btn-secondary btn-sm w-100 rounded-1 py-1 #{'disabled' if reset_disabled}",
                aria: { disabled: reset_disabled }

    / ==== RIGHT: MAIN RESULTS ====
    .col-12.col-lg-9.d-flex.flex-column.bg-dark-subtle.px-3{ style: "min-height: 100vh;" }
      .bg-body-secondary.rounded-0.p-4.w-100.d-flex.flex-column{ style: "height: 100%; overflow-y: auto;" }
        / --- Search box (top) ---
        %div.text-center.mb-4
          = form_with url: search_advanced_path, method: :get, local: true, html: { id: 'advanced-search-form', class: 'd-flex justify-content-center mb-2' } do
            .input-group.shadow-lg.border.mx-auto{ style: "border-radius: 50px; overflow: hidden; max-width: 900px;" }
              %span.input-group-text.bg-white.border-0.py-0
                %i.bi.bi-search.text-muted
              = text_field_tag :q, params[:q],
                class: "form-control border-0 py-0",
                placeholder: "Search for a community...",
                form: "advanced-search-form"
              %button.btn.btn-white.border-0{ type: "submit" }
                %i.bi.bi-arrow-return-left.text-secondary

        / --- Header and filter badges ---
        .d-flex.flex-wrap.justify-content-between.align-items-center.mb-3
          %h2.h5.mb-0= pluralize(@communities.size, 'Community')

          - selected_grids = selected_labels(@all_grids, :grid_ids) { |g| g.id }
          - selected_boros = selected_labels(@all_boros, :borough_fips_codes) { |b| b.fips_code }
          - selected_corps = selected_labels(@all_corps, :regional_corporation_fips_codes) { |c| c.fips_code }
          - selected_sen   = selected_labels(@all_senate, :senate_district_ids) { |d| d.id }
          - selected_hou   = selected_labels(@all_house, :house_district_ids) { |d| d.id }

          - if selected_grids.any? || selected_boros.any? || selected_corps.any? || selected_sen.any? || selected_hou.any? || params[:q].present?
            .d-flex.flex-wrap.gap-2
              - if params[:q].present?
                %span.badge.bg-primary-subtle.text-primary.border
                  %i.bi.bi-search.me-1.mb-1
                  = params[:q]
              - selected_grids.each do |g|
                %span.badge.bg-light.text-body.border
                  %i.bi.bi-grid-3x3-gap.me-1.mb-1
                  = g.name
              - selected_boros.each do |b|
                %span.badge.bg-secondary.text-light= b.name
              - selected_corps.each do |c|
                %span.badge.bg-success.text-light= c.name
              - selected_sen.each do |d|
                %span.badge.bg-info-subtle.text-dark.border= "Senate #{d.district}"
              - selected_hou.each do |d|
                %span.badge.bg-primary-subtle.text-primary.border= "House #{d.district_label}"
            = link_to 'Clear all filters', search_advanced_path, class: 'small ms-2 text-decoration-none'

        / --- Scrollable results ---
        .flex-grow-1.overflow-auto
          - if @communities.any?
            .vstack.gap-3
              - @communities.each do |community|
                = render 'searches/advanced/community_card', community: community
            .mt-4.text-center
              = raw(pagy_bootstrap_nav(@pagy))
          - else
            .alert.alert-info.text-center.mt-3
              No communities matched those filters. Try broadening your selection.
