- content_for :title, "Community - #{@community.name}"

/ --- Tool Bar
.sticky-top.bg-light.p-1
  .row.align-items-center.gx-0
    .col.d-flex.align-items-center.text-truncate.align-middle.gap-2
      %i.bi.bi-geo-alt-fill.text-primary.fs-4.ms-2
      / Name
      %span.fw-bold.fs-3.text-truncate= @community.name
      / Borough (not census area)
      - if @community.borough.present? && !@community.borough.census_area?
        %span.text-muted.align-middle &bull;
        %span.fw-semibold.text-secondary.text-truncate= @community.borough.name
      / Grid
      - if @community.grid.present?
        %span.text-muted.align-middle &bull;
        = link_to @community.grid.name, grid_path(@community.grid), class: "text-info text-truncate"

    .col-auto
      .d-flex.align-items-center.flex-nowrap
        = render "shared/dropdown", collection: @communities
        = render 'communities/sections/quick_nav', community: @community

/ Wrap BOTH columns with the maps controller so buttons can reach it
.row.gx-0{
  data: mapbox_api_data({
    maps_map_center_value: [@community.longitude, @community.latitude],
    maps_markers_value: [[@community.longitude, @community.latitude]],
    maps_marker_tooltip_title_value: @community.name
  })
}
  / --- LEFT: Map
  .col-md-4.d-none.d-md-block
    .d-flex.flex-column.position-sticky{ style: "top: 50px; height: calc(100vh - 50px);" }
      .flex-grow-1.d-flex.flex-column#mapbox-area
        .d-flex.align-items-center
          / --- Floating controls (top-right, inside map) ---
          .position-absolute.top-0.end-0.bg-white.border.rounded-3.shadow-sm.m-2.p-3{ style: "z-index:5;" }
            .fw-semibold.small.mb-2.text-center.border-bottom.pb-1 Select a Map Layer
            
            / Map Layer: Local Service Area
            - if @community.show_service_area_geoms?
              .form-check.mb-1
                %input.form-check-input#layer-service-area-local{
                  type: "checkbox",
                  data: {
                    action: "change->maps#toggleLayer",
                    url: service_area_geoms_community_maps_path(@community),
                    fit: true
                  }
                }
                %label.form-check-label.small{ for: "layer-service-area-local" }
                  = @community.show_full_service_area? ? "Local Service Area" : "Service Area"
            
            / Map Layer: Full Service Area (if applicable)
            - if @community.show_full_service_area?
              .form-check.mb-1
                %input.form-check-input#layer-service-area-full{
                  type: "checkbox",
                  data: {
                    action: "change->maps#toggleLayer",
                    url: service_areas_community_maps_path(@community),
                    fit: true
                  }
                }
                %label.form-check-label.small{ for: "layer-service-area-full" } Full Service Area
            
            / Map Layer: House Districts
            .form-check.mb-1
              %input.form-check-input#layer-house{
                type: "checkbox",
                data: {
                  action: "change->maps#toggleLayer",
                  url: house_districts_community_maps_path(@community),
                  fit: true
                }
              }
              %label.form-check-label.small{ for: "layer-house" } House Districts
            
            / Map Layer: Senate Districts
            .form-check.mb-1
              %input.form-check-input#layer-senate{
                type: "checkbox",
                data: {
                  action: "change->maps#toggleLayer",
                  url: senate_districts_community_maps_path(@community),
                  fit: true
                }
              }
              %label.form-check-label.small{ for: "layer-senate" } Senate Districts
            
            /#- This is if we ever want a "clear all layers" button
            -# %hr.my-2
            -# .d-flex.justify-content-end.gap-1
            -#   %button.btn.btn-sm.px-1.py-0{ data: { action: "click->maps#clearLayers" }, title: "Clear Layers", style: "line-height:1;" }
            -#     %i.bi.bi-trash.fs-6
            
            / Map Layer: Plants
            - if @community.show_plants?
              .form-check.mb-1
                %input.form-check-input#layer-plants{
                  type: "checkbox",
                  data: {
                    action: "change->maps#toggleLayer",
                    url: plants_community_maps_path(@community),
                    fit: true
                  }
                }
                %label.form-check-label.small{ for: "layer-plants" } Power Plants
            
            / Map Layer: Bulk Fuel Facilities 
            - if @community.show_bulk_fuel_facilities?
              .form-check.mb-1
                %input.form-check-input#layer-bulk-fuel-facilities{
                  type: "checkbox",
                  data: {
                    action: "change->maps#toggleLayer",
                    url: bulk_fuel_facilities_community_maps_path(@community),
                    fit: true
                  }
                }
                %label.form-check-label.small{ for: "layer-bulk-fuel-facilities" } Bulk Fuel Facilities

        / --- Map fills remaining height
        .flex-grow-1.position-relative
          .h-100{ data: { maps_target: "map" } }

  / RIGHT: main content 
  .col-md-8
    - tab_order = []
    - tab_order << 'general'  if @community.show_background_section?
    - tab_order << 'demographics'
    - tab_order << 'income'
    - tab_order << 'electricity_rates_sales'
    - tab_order << 'electricity' if @community.show_electricity_section?
    - tab_order << 'fuel'
    
  
    -# --- Tab Navigation Menu ---
    %ul.nav.nav-tabs.m-4{ role: 'tablist' }
      - tab_order.each_with_index do |tab, index|
        - is_active = index.zero?
        %li.nav-item{ role: 'presentation' }
          %button.nav-link{ |
            class: (is_active ? 'active' : ''), |
            id: "#{tab.parameterize}-tab", |
            data: { bs_toggle: 'tab', bs_target: "##{tab.parameterize}-pane" }, |
            type: 'button', |
            role: 'tab', |
            aria: { controls: "#{tab.parameterize}-pane", selected: is_active } |
          }
            - if tab == 'electricity_rates_sales'
              = 'Electricity Rates & Sales'
            - else
              = tab.titleize
  
    -# --- Tab Content Panels ---
    .tab-content
      - tab_order.each_with_index do |tab, index|
        - is_active = index.zero?
        .tab-pane.fade{ |
          class: (is_active ? 'show active' : ''), |
          id: "#{tab.parameterize}-pane", |
          role: 'tabpanel', |
          aria: { labelledby: "#{tab.parameterize}-tab" } |
        }
          = render "communities/sections/#{tab}", community: @community