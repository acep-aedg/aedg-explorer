- content_for :title, "Community - #{@community.name}"

/ Precompute URLs once so both columns can use them
- if @community.show_service_area_geoms?
  - sa_url      = service_area_geoms_community_maps_path(@community, format: :json)
- if @community.show_full_service_area?
  - full_sa_url = service_areas_community_maps_path(@community, format: :json)
- hd_url = house_districts_community_maps_path(@community, format: :json)
- sd_url = senate_districts_community_maps_path(@community, format: :json)

/ --- Tool Bar
.sticky-top.bg-light.p-1
  .row.align-items-center.gx-0
    .col.d-flex.align-items-center.text-truncate.align-middle.gap-2
      %i.bi.bi-geo-alt-fill.text-primary.fs-4.ms-2
      %span.fw-bold.fs-3.text-truncate= @community.name
      - if @community.borough.present? && !@community.borough.census_area?
        %span.text-muted.align-middle &bull;
        %span.fw-semibold.text-secondary.text-truncate= @community.borough.name
      - if @community.grid.present?
        %span.text-muted.align-middle &bull;
        = link_to @community.grid.name, grid_path(@community.grid), class: "text-info text-truncate"

    .col-auto
      .d-flex.align-items-center.flex-nowrap
        = render "shared/dropdown", collection: @communities
        = render 'communities/sections/quick_nav', community: @community

/ Wrap BOTH columns with the maps controller so buttons can reach it
.row.gx-0{
  data: mapbox_api_data({
    maps_map_center_value: [@community.longitude, @community.latitude],
    maps_markers_value: [[@community.longitude, @community.latitude]],
    maps_marker_tooltip_title_value: @community.name
  })
}
  / --- LEFT: Map
  .col-md-5.d-none.d-md-block
    .d-flex.flex-column{ style: "position: sticky; top: 50px; height: calc(100vh - 50px);" }
      .flex-grow-1.d-flex.flex-column#mapbox-area
        .d-flex.align-items-center
          / --- Floating controls (top-right, inside map) ---
          .position-absolute.top-0.end-0.mt-2.me-2{ style: "z-index:5; pointer-events:none;" }
            .bg-white.border.rounded-3.shadow-sm{ style: "pointer-events:auto; width: 180px;" }
              .p-2
                %div.fw-semibold.small.mb-2 Additional Layers
                / Map Layers (checkboxes)
                - if @community.show_service_area_geoms?
                  .form-check.mb-1
                    %input.form-check-input#layer-service{
                      type: "checkbox",
                      style: "transform:scale(0.85); margin-top:.1rem;",
                      data: {
                        action: "change->maps#toggleLayer",
                        url: sa_url,
                        color: "#E74C3C",
                        "outline-color": "#943126",
                        fit: true
                      }
                    }
                    %label.form-check-label.small{ for: "layer-service" }
                      = @community.show_full_service_area? ? "Local Service Area" : "Service Area"

                - if @community.show_full_service_area?
                  .form-check.mb-1
                    %input.form-check-input#layer-service-full{
                      type: "checkbox",
                      style: "transform:scale(0.85); margin-top:.1rem;",
                      data: {
                        action: "change->maps#toggleLayer",
                        url: full_sa_url,
                        color: "#E74C3C",
                        "outline-color": "#943126",
                        fit: true
                      }
                    }
                    %label.form-check-label.small{ for: "layer-service-full" } Full Service Area

                .form-check.mb-1
                  %input.form-check-input#layer-house{
                    type: "checkbox",
                    style: "transform:scale(0.85); margin-top:.1rem;",
                    data: {
                      action: "change->maps#toggleLayer",
                      url: hd_url,
                      color: "#088",
                      "outline-color": "#05505e",
                      fit: true
                    }
                  }
                  %label.form-check-label.small{ for: "layer-house" } House Districts

                .form-check
                  %input.form-check-input#layer-senate{
                    type: "checkbox",
                    style: "transform:scale(0.85); margin-top:.1rem;",
                    data: {
                      action: "change->maps#toggleLayer",
                      url: sd_url,
                      color: "#e67e22",
                      "outline-color": "#a84300",
                      fit: true
                    }
                  }
                  %label.form-check-label.small{ for: "layer-senate" } Senate Districts
                
                /#- This is if we ever want a "clear all layers" button
                -# %hr.my-2
                -# .d-flex.justify-content-end.gap-1
                -#   %button.btn.btn-sm.px-1.py-0{ data: { action: "click->maps#clearLayers" }, title: "Clear Layers", style: "line-height:1;" }
                -#     %i.bi.bi-trash.fs-6
                - if @community.show_plants?
                  .form-check
                    %input.form-check-input#layer-plants{
                      type: "checkbox",
                      style: "transform:scale(0.85); margin-top:.1rem;",
                      data: {
                        action: "change->maps#toggleLayer",
                        url: plants_community_maps_path(@community, format: :json),
                        fit: true
                      }
                    }
                    %label.form-check-label.small{ for: "layer-plants" } Power Plants
                
                - if @community.show_bulk_fuel_facilities?
                  .form-check
                    %input.form-check-input#layer-bulk-fuel-facilities{
                      type: "checkbox",
                      style: "transform:scale(0.85); margin-top:.1rem;",
                      data: {
                        action: "change->maps#toggleLayer",
                        url: bulk_fuel_facilities_community_maps_path(@community, format: :json),
                        fit: true
                      }
                    }
                    %label.form-check-label.small{ for: "layer-bulk-fuel-facilities" } Bulk Fuel Facilities

        / --- Map fills remaining height
        .flex-grow-1.position-relative
          %div{ data: { maps_target: "map" }, style: "position:absolute; inset:0; width:100%; height:100%;" }

  / RIGHT: main content 
  .col-md-7
    .text-center

    - section_order = []
    - section_order << 'electricity' if @community.show_electricity_section?
    - section_order << 'prices'      if @community.show_prices_section?
    - section_order << 'background'  if @community.show_background_section?
    - section_order.each do |section|
      - section_id = "#{section.parameterize}-section"

      / Anchor offset target (for the quick link buttons to show the header for sections)
      %div{ id: section.parameterize, class: "anchor-offset" }

      %button.collapse-btn{ 
        id: section.parameterize,
        type: 'button', 
        data: { bs_toggle: 'collapse', bs_target: "##{section_id}" }, 
        aria: { expanded: 'true', controls: section_id }
      }
        %i.bi.bi-chevron-down.arrow-icon
        %h3= section.titleize
      .collapse.show{ id: section_id }
        = render "communities/sections/#{section}", community: @community 

%hr.my-0