- base_title = "#{@community.name.titleize} - Energy Generation Profile"
- years          = MonthlyGeneration.available_years_for(@community)
- selected_year  = years.first
- chart_id = "monthly-prod-chart"

/ Wrapper: Now clearly a "Widget"
#monthly-generation-chart-wrapper{
  data: {
    controller: "widget-update",
    widget_update: {
      charts_value: [
        { 
          id: chart_id, 
          url: production_monthly_community_charts_path(@community),
          baseTitle: base_title,
          param: 'year'
        }
      ].to_json
    }
  }
}
  - if years.size > 1
    .d-flex.align-items-center.gap-2.mb-2
      %label.form-label.me-2.mb-0{ for: "monthly-generation-year" } Year:

      / Select: triggers the 'update' action
      %select#monthly-generation-year.form-select.form-select-sm.w-auto{
        data: { action: "change->widget-update#update" }
      }
        - years.each do |y|
          %option{ value: y, selected: y == selected_year }= y

  / Summary Frame: Targeted by the controller
  %turbo-frame#monthly_generation_summary{ data: { widget_update_target: 'frame', param: 'year' }, src: monthly_generation_community_summary_path(@community, year: selected_year)}
    Loading summary ...

  / Chart: Updated by ID
  = column_chart production_monthly_community_charts_path(@community, year: selected_year),
    id: chart_id,
    title: "#{base_title} (#{selected_year})",
    xtitle: 'Month',
    download: {filename: base_title.parameterize},
    colors: [color(:blue), color(:orange)],
    library: { scales: { y: { type: "linear", position: "left", title: { display: true, text: "Generation (MWh)" } }, y1: { type: "linear", position: "right", title: { display: true, text: "Heating Degree Days" } } } }