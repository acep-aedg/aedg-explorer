/ ── Utilities
.d-flex.align-items-center.mb-3
  %i.bi.bi-buildings.me-2.fs-4
  %h4#utilities.mb-0.me-3.py-3.anchor-offset Utilities
  %hr.flex-grow-1.mt-1.mb-0

/ Map
- if @community.show_utility_map_layers?
  .mb-3.d-none.d-md-block
    %h6.text-uppercase.text-muted.mb-2 View on Map
    .btn-group.btn-group-sm{ role: "group", "aria-label": "Map layers" }

      - if @community.show_service_area_geoms?
        - sa_url = service_area_geoms_community_maps_path(@community, format: :json)
        %button.btn.btn-sm.btn-outline-secondary.d-inline-flex.align-items-center.gap-1{
          data: {
            action: "click->maps#showLayer",
            url: sa_url,
            color: "#E74C3C",
            "outline-color": "#943126",
            fit: true,
            checkbox_id: "layer-service"     # toggles the real checkbox in map panel
          }
        }
          %i.bi.bi-bounding-box
          = @community.show_full_service_area? ? "Local Service Area" : "Service Area"

      - if @community.show_full_service_area?
        - full_sa_url = service_areas_community_maps_path(@community, format: :json)
        %button.btn.btn-sm.btn-outline-secondary.d-inline-flex.align-items-center.gap-1{
          data: {
            action: "click->maps#showLayer",
            url: full_sa_url,
            color: "#E74C3C",
            "outline-color": "#943126",
            fit: true,
            checkbox_id: "layer-service-full"  # toggles the real checkbox in map panel
          }
        }
          %i.bi.bi-bounding-box
          Full Service Area

      - if @community.show_plants?
        - plants_url = plants_community_maps_path(@community, format: :json)
        %button.btn.btn-sm.btn-outline-secondary.d-inline-flex.align-items-center.gap-1{
          data: {
            action: "click->maps#showLayer",
            url: plants_url,
            fit: true,
            checkbox_id: "layer-plants"        # ensure a matching checkbox exists in the map panel
          }
        }
          %i.bi.bi-building
          Power Plants

/ === Card Body ===
.bg-body-secondary.p-3.rounded.mb-3
  .row.g-4.w-100
    .col
      - if @community.show_service_areas?
        %p.mb-2
          %i.bi.bi-info-circle-fill.me-2.text-aedg-navy{ data: { controller: 'tooltip', bs_toggle: 'tooltip' }, title: "Utility providers that serve this service area" }
          %strong Utilities for Service Area(s):
          %ul.mb-2
            - @community.service_areas.each do |sa|
              %li.d-flex.align-items-center
                %span= sa.name
                - if sa.certificate_url.present?
                  = link_to sa.certificate_url, target: "_blank", rel: "noopener", class: "btn btn-sm btn-outline-primary ms-2" do
                    %i.bi.bi-box-arrow-up-right.me-1
                    Certificate
      %p.mb-2
        %i.bi.bi-info-circle-fill.me-2.text-aedg-navy{ data: { controller: 'tooltip', bs_toggle: 'tooltip' }, title: "The electrical grid serving this community" }
        %strong Grid:
        - if @community.grid.nil?
          None
        - else
          = link_to @community.grid.name.titleize, grid_path(@community.grid)

      %p.mb-2
        %i.bi.bi-info-circle-fill.me-2.text-aedg-navy{ data: { controller: 'tooltip', bs_toggle: 'tooltip' }, title: "Power Cost Equalization (PCE) Status" }
        %strong PCE Status:
        = @community.pce_eligible ? "Eligible" : "Ineligible"

  .row.gx-5
    / --- LEFT COLUMN ---
    .col-auto
      - if @community.show_plants?
        %p.mb-0
          %i.bi.bi-info-circle-fill.me-2.text-aedg-navy{ data: { controller: 'tooltip', bs_toggle: 'tooltip' }, title: (@community.show_full_service_area? ? "Power plants within the local service area" : "Power plants within the service area")}
          %strong Power Plants (#{@community.plants.size}):
          %ul.mb-2
            - @community.plants.each do |plant|
              %li= plant.name

    / --- RIGHT COLUMN ---
    .col-auto
      - if @community.show_peers_by_service_area_geoms?
        - peers = @community.peers_by_service_area_geoms
        %h6.fw-bold.mb-2
          Other communities within the 
          = @community.show_full_service_area? ? "local service area" : "service area"
          (#{peers.size}):
        .row
          - peers.in_groups(2, false).each do |col|
            .col-6
              %ul.list-unstyled.mb-0
                - col.each do |peer|
                  %li= link_to peer.name, community_path(peer)
